<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/08/11/9864576.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On the nonubiquitousness of Ü</title></head><body>
<h1>On the nonubiquitousness of Ü</h1>
<p><em>by Michael S. Kaplan, published on 2009/08/11 12:29 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2009/08/11/9864576.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>So, in a quick follow-up to <a href="http://archives.miloush.net/michkap/archive/2009/07/20/9840848.html" mce_href="http://archives.miloush.net/michkap/archive/2009/07/20/9840848.html">Garbage in, garbage out -- and this means Ü!</a> from the other day, the investigation into the cause has happened:</p>

<blockquote>
<p><font face="times new roman,times">ok, what happens is that MFC is actually throwing an exception, because _mbsupr_s() does return EILSEQ. The crash is caused by the unhandled exception.<br><br>if you put a try catch around the MakeUpper, you'll see the exception being caught:<br><br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <b><font face="Consolas,Lucida Console,Courier New,Courier,Fixed">try {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; tt.MakeUpper();<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } catch(CException *) {<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; printf("mfc exception\n");<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } </font></b><br><br>_mbsupr_s() is called by Checked::mbsupr_s from StringUppercase:<br><br><b><font face="Consolas,Lucida Console,Courier New,Courier,Fixed">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; static LPSTR __cdecl StringUppercase( _Inout_cap_(size) LPSTR psz, _In_ size_t size ) throw()<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Checked::mbsupr_s(reinterpret_cast&lt; unsigned char* &gt;( psz ), size);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; return psz;<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</font></b><br><br>_mbsupr_s() returns EILSEQ because 0xFC is a lead byte in MBCS Japanese.</font></p>
</blockquote>

<p>Okay, so now blame can be assigned. :-)</p><p>Everyone is clearly doing what they meant to be doing, at some level. Though the question of whether there should be a different way to handle this case is an interesting one (an exception in a <b>MakeUpper</b> method call seems like it may be somewhat unexpected.</p><p>Why do I think that?</p><p>Well, the data itself is invalid on its face -- the meaning of a solitary 0xFC in dats purporting to be Japanese is invalid.</p><p>But is it truly the job of <b>MakeUpper</b> to do data validation?</p><p>At the point where the data is already in a string and one wishes to uppercase it is perhaps not the best time for anyone to start screaming about failing to tag second base.</p><p>And I am not so keen on <b>MakeUpper</b> in the role of umpire, either :-)</p><p>So while I will still say the caller of the code, the who made the invalid code page assumption (about the ubiquity of Ü) that is at fault, it is hard to wonder whether this small amount of over-officiousness is also at least a little bit to blame for the problem, too.</p><p>This is not unlike the things that bother me about over-validation in codepage conversions -- in both cases I'd want options to have the functions I call do less work and be less demanding of their notion of data purity.</p><p>Just a desire to trust the caller unless the caller asks for validation of some kind....<br></p><p>I'll admit that I am till wrapping my head around the problem here, but I thought I'd run it up the flagpole and see what others thought.</p><p>Ideas, anyone? <br></p>
<hr/><p><strong>bg</strong> on 12 Aug 2009 5:51 AM:</p><div style="margin-left: 1em"><p>the exception in makeupper does seem a little extreme. but you kinda want that security layer that the xxx_s stuff gives you as well. you can't really have one and not the other these days.</p>
<p>are there a lot of corner issues stopping the user from validating the string first?</p>
<p>oh and don't u need to call delete on that exception ;)</p>
<p>bg </p></div>
<p><strong>Random832</strong> on 13 Aug 2009 6:54 AM:</p><div style="margin-left: 1em"><p>It's funny, because my reaction is the opposite - when I thought it was walking past the end of the stream I thought its behavior was wrong, whereas with it throwing the exception it's more reasonable. The only arguable &quot;fault&quot; is in throwing an exception rather than leaving it as an error return that can be more easily ignored.</p>
<p>Since it has to do the actual case mapping (I assume) in unicode, the other &quot;reasonable&quot; thing to do would be to silently replace the invalid character with a substitution character. As it turns out, if I try to convert this character, I get U+30FB, which becomes cp932 0x8145 - which would not necessarily _fit_ in the buffer. The obvious answer would be to use 0x3F (or maybe 0xA5, the halfwidth version of this character, though this would require that specific information in the codepage) instead.</p></div>
<p><strong>Mihai</strong> on 27 Aug 2009 2:34 PM:</p><div style="margin-left: 1em"><p>I tend to agree with bg here: exception is ok, especially in a function that promises secure behavior.</p></div>
<p><strong>Michael S. Kaplan</strong> on 27 Aug 2009 8:07 PM:</p><div style="margin-left: 1em"><p>The MakeUpper method does not have a specific, documented secure behavior guaranteed though, AFAIK. What does this do to the opinion?</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2009/08/12/9866743.html" title="Turkish Character in Directory Name Hung Windows NT 3.5, aka small enough to be internationally stupid">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2009/08/10/9862997.html" title="On not getting arrested for rolling under the influence">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-08-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/08/11/9864576.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>