<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/02/04/9394864.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The road to hell is paved with attempts at being compatible</title></head><body>
<h1>The road to hell is paved with attempts at being compatible</h1>
<p><em>by Michael S. Kaplan, published on 2009/02/04 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2009/02/04/9394864.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>In one of the very first blogs I wrote, I pointed out that <b><a href="http://archives.miloush.net/michkap/archive/2004/11/28/271121.html" mce_href="http://archives.miloush.net/michkap/archive/2004/11/28/271121.html">Microsoft does not use the Unicode Collation Algorithm</a></b>. </p>
<p>Believe it or not, at the time some people actually asked me whether I thought I might get in trouble for that blog. Looking at it now I can't even imagine why they would have thought that -- there are so many other blogs that are much more effective at getting me into trouble, after all. I can inspire an almost Pavlovian response with certain topics, which inspire a "<i>this</i> is what I'm talking about" mail to some people.</p>
<p>Anyway....</p>
<p>Microsoft does not use the UCA. In fact, <b><a href="http://archives.miloush.net/michkap/archive/2008/02/10/7579576.html" mce_href="http://archives.miloush.net/michkap/archive/2008/02/10/7579576.html">it still does not use the UCA</a></b>.</p>
<p>There are consequences to this fact - that the collation model whose full time job is to attempt to implement principles in the Unicode Standard as it sorts is not the one that Microsoft does. Consequences that pop up at the most unlikely and unexpected times and can knee a guy right in the groin.<br></p>
<p>Like the other day, when I received from a guy named Ron a mail that was not as shiny and happy as REM imagined in that song of theirs that Michael Stipe hates so much:</p>
<blockquote>
<blockquote>
<p><i><font face="times new roman,times">This isn't a request for support, and I don't expect a response.<br><br>I just wanted to let you know that the hot fix in http://support.microsoft.com/kb/955612 leaves some sort keys broken. I've applied that hot fix and still get broken results for the Uncode code points FE71, FE77, FD79, FE7D, and FE7F.<br><br>For example the sort key for FE71 is<br><br>&nbsp;&nbsp; 00 00 01 00 01 00 dc 01 01 01<br><br>I would not have sent this to you except that there's no way to give any feedback on the hot fix page other than to pay $99.00 to speak to a support person.<br><br>It really looks like MS doesn't want to find out when it's code is broken. Given that I used to work for MS, I find that depressing.<br><br>It would be nice to have this fixed in some future release.</font></i></p>
</blockquote>
</blockquote>
<p>Hmmm. I count <b>seven</b> issues that kind of screamed for a response of some sort.I'm gonna try to cover them all.<br></p>
<p>I'm going to take them out of order, though.</p>
<p><b>FOURTH OF ALL</b>, the bug. If you compare the sort keys of some of these characters across versions (the first sort key is from XP, the second is from Vista, the third is from Server 2008):<br></p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe71" mce_href="http://www.fileformat.info/info/unicode/char/fe71">U+fe71</a> (ARABIC TATWEEL WITH FATHATAN ABOVE)<br>01 01 01 01 80 07 06 a0 00<br>40 03 40 fa 01 01 02 12 01 01 00<br>00 00 01 00 01 00 dc 01 01 01 00<br></p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe77" mce_href="http://www.fileformat.info/info/unicode/char/fe77">U+fe77</a> (ARABIC FATHA MEDIAL FORM)<br>01 01 01 01 80 07 06 a3 00<br>40 f8 01 00 40 dc 01 02 0d 01 02 00 12 01 01 00<br>00 00 01 00 01 00 df 01 01 01 00<br></p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe7d" mce_href="http://www.fileformat.info/info/unicode/char/fe7d">U+fe7d</a> (ARABIC SHADDAH ON TATWEEL)<br>ff ff 01 01 01 01 00<br>40 ea 40 fc 01 01 01 01 00<br>00 00 01 00 01 00 e3 01 01 01 00<br></p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe7f" mce_href="http://www.fileformat.info/info/unicode/char/fe7f">U+fe7f</a> (ARABIC SUKUN MEDIAL FORM)<br>01 01 01 01 80 07 06 a6 00<br>40 f2 40 fc 01 01 01 01 00<br>00 00 01 00 01 00 e2 01 01 01 00<br></p>
<p>The explanation of each is simple enough -- the first was from that point where many of the characters had weird weights just to try to fit them somewhere since they did not exactly fit in with the one weight per character model.</p>
<p>The second was an attempt to at least put them with the other Arabic characters.</p>
<p>The third was an attempt to be more compatible with Unicode, kind of like the UCA tries to do.<br></p>
<p>Oops.</p>
<p>It took the documented decompositions from the Unicode Character Database, and treated them like Expansions, those things I mentioned in <b><a href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html">A&amp;P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</a></b>. And it turned these kind of complicated compatibility characters, the ones I have been railing against in prior blogs like</p>
<ul>
<li><b><a href="http://archives.miloush.net/michkap/archive/2005/10/07/478127.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/07/478127.html">It Does Not Always Pay to be Compatible</a></b></li>
<li><b><a href="http://archives.miloush.net/michkap/archive/2005/12/02/498889.html" mce_href="http://archives.miloush.net/michkap/archive/2005/12/02/498889.html">Getting out of dodge (or at least out of the compatibility range!)</a></b></li>
<li><b><a href="http://archives.miloush.net/michkap/archive/2006/01/14/512985.html" mce_href="http://archives.miloush.net/michkap/archive/2006/01/14/512985.html">Getting out of the compatibility zone, redux</a></b><br></li>
</ul>
<p>and tries to kind of rehabilitate them using these documented equivalencies, such as:</p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe71" mce_href="http://www.fileformat.info/info/unicode/char/fe71">U+fe71</a> --&gt; <a href="http://www.fileformat.info/info/unicode/char/0640" mce_href="http://www.fileformat.info/info/unicode/char/0640">U+0640</a> <a href="http://www.fileformat.info/info/unicode/char/064b" mce_href="http://www.fileformat.info/info/unicode/char/064b">U+064b</a> (ARABIC TATWEEL + ARABIC FATHATAN)</p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe77" mce_href="http://www.fileformat.info/info/unicode/char/fe77">U+fe77</a> --&gt; <a href="http://www.fileformat.info/info/unicode/char/0640" mce_href="http://www.fileformat.info/info/unicode/char/0640">U+0640</a> <a href="http://www.fileformat.info/info/unicode/char/064e" mce_href="http://www.fileformat.info/info/unicode/char/064e">U+064e</a> (ARABIC TATWEEL + ARABIC FATHAH)</p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe7d" mce_href="http://www.fileformat.info/info/unicode/char/fe7d">U+fe7d</a> --&gt; <a href="http://www.fileformat.info/info/unicode/char/0640" mce_href="http://www.fileformat.info/info/unicode/char/0640">U+0640</a> <a href="http://www.fileformat.info/info/unicode/char/0651" mce_href="http://www.fileformat.info/info/unicode/char/0651">U+0651</a> (ARABIC TATWEEL + ARABIC SHADDAH)</p>
<p><a href="http://www.fileformat.info/info/unicode/char/fe7f" mce_href="http://www.fileformat.info/info/unicode/char/fe7f">U+fe7f</a> --&gt; <a href="http://www.fileformat.info/info/unicode/char/0640" mce_href="http://www.fileformat.info/info/unicode/char/0640">U+0640</a> <a href="http://www.fileformat.info/info/unicode/char/0652" mce_href="http://www.fileformat.info/info/unicode/char/0652">U+0652</a> (ARABIC TATWEEL + ARABIC SUKUN)</p>
<p>Now in Microsoft's tables, the TAWEEL is given <b><a href="http://archives.miloush.net/michkap/archive/2005/01/18/355210.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/18/355210.html">no weight</a></b> (ref: <b><a href="http://archives.miloush.net/michkap/archive/2007/01/12/1454496.html" mce_href="http://archives.miloush.net/michkap/archive/2007/01/12/1454496.html">You've got to be kashidding me</a></b>), and the other characters are treated as diacritics. This makes the XP weights just behind the times and the Vista weights really weird, with them being treated as full letters even though they are nominally compatible with things that are either weightless or diacritics.</p>
<p>Thus the first two attempts here sucked (the worst examples of <b><a href="http://archives.miloush.net/michkap/archive/2005/09/12/463483.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/12/463483.html">How does Microsoft assign new collation weights?</a></b>), and the third was a genuine attempt to do the right thing. <br></p>
<p>Unfortunately, there are at least three problems/limitations with our expansions, and this bug is due to two of them.</p>
<p>You see, in expansions all the usual code that does not fill in values for the weightless characters? Doesn't happen. Plus it does not properly handle combining characters (just like it does not handle compression, as I pointed out in <b><a href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html">A&amp;P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</a></b>).And thus&nbsp; between these two problems you have all these NULLs Ron is pointing out. <br></p>
<p>Oops.</p>
<p><font color="#ff0000"><b>This bug repros on Windows 7 by the way. Someone should get on that ASAP. Any NLS testers around? :-)</b></font></p>
<p>Getting back to the remaining six point in the question, now:</p>
<p><b>FIRST OF ALL</b>, this blog is not really intended to be a support venue, so <b>SECOND OF ALL</b> just like no one ever expects the Spanish Inquisition, one should never expect a response.</p>
<p>And <b>THIRD OF ALL</b>, the hotfix mentioned in that KB article was for a specific targeted bug. Being unhappy at a heretofore unreported bug not being fixed in it is like being mad that Apple did not provide a patch.</p>
<p><b>FIFTH OF ALL</b> since this bug has nothing to do with the hotfix, that would be the wrong place to leave the feedback anyway.</p>
<p>And <b>SIXTH OF ALL</b>, when I consider the notion of a former employee who has no idea where to report a bug and finds to be depressing, I myself get depressed. </p>
<p>I know that for the next ten years after I leave this company I would know exactly where to send bugs, even if decided not to send them. :-)</p>
<p>Finally, <b>SEVENTH OF ALL</b>, given that this bug exists in Windows 7, I too think it would be nice if it were fixed in a future version. Hint, hint!</p>
<p>&nbsp;</p>
<p><font color="#ff00ff"><i>This blog brought to you by the many fine characters mentioned above that have been so consistently mistreated by Windows despite their long-standing existence in Unicode</i></font> <br></p>
<hr/><p><strong>Iain Clarke</strong> on 9 Feb 2009 11:08 AM:</p><div style="margin-left: 1em"><p>OK, I'll bite - what was SECOND OF ALL?</p>
<p>Iain.</p></div>
<p><strong>Michael S. Kaplan</strong> on 20 Jul 2010 8:22 AM:</p><div style="margin-left: 1em"><p>On the same line as the FIRST OF ALL. :-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2009/02/16/9424838.html" title="In search of: SiaO&#39;s mythology">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2009/02/02/9388713.html" title="Where&#39;s Waldo^H^H^H^H^HMichael? (aka It probably wasn&#39;t worth the wait and yet you waited!)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-02-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/02/04/9394864.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>