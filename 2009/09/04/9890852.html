<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/09/04/9890852.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When conversions ignore the errors...</title></head><body>
<h1>When conversions ignore the errors...</h1>
<p><em>by Michael S. Kaplan, published on 2009/09/04 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2009/09/04/9890852.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>The other day I was sent mail about a <b>Connect</b> bug. <a href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=392573" mce_href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=392573">This</a> <b>Connect</b> bug, in fact.</p><p>The title alone (<a href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=392573" mce_href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=392573">mbstowcs_s does not return an error when the current code page does not support all the characters in mbstr</a>) might suggest what is going on to some of you</p><p>And the description will give a hint to some of you too:</p><blockquote><blockquote><p><font face="times new roman,times">When mbstr contains characters not supported by the current process code page, mbstowcs_s does not return an error and put garbage characters in wcstr.<br><br>Example:<br><br>setlocale(LC_CTYPE, ".1252"); //set the process to use a locale with English code page<br>&nbsp;&nbsp;&nbsp; //you can also try not setting the locale. The default process LC_CTYPE locale is C<br>&nbsp;&nbsp;&nbsp; //which means 7-bit ASCII.<br>char* mbTestStr = "Test. 真的."; //this is a 9 character string with 2 Chinese characters. <br>size_t charCount;<br>wchar_t wcStr[50];<br>errno_t error = mbstowcs_s(charCount, wcStr, 50, mbStr, -1);<br><br>After the call, no error is returned, charCount becomes 12, and wcStr contains "Test. ÕæµÄ." It seems charCount is the actual byte count in mbStr. The two Chinese characters each takes two bytes in mbStr.<br><br>The function should fail to convert the Chinese characters and return an error because the code page does not support Chinese characters. <br><br>If I set the locale to ".936" (936 is a code page for simplified Chinese). No error is returned, charCount becomes 10, and wcStr contains "Test. 真的.". Everything is correct. <br><br>_mbstowcs_s_l has the same problem if you give it a locale that does not support all the characters in mbstr.</font><br></p></blockquote></blockquote><p>Sound familiar yet? :-) </p><p>When people started digging into the issue, they found that under the covers, MultiByteToWideChar was being called with the MB_ERR_INVALID_CHARS flag. </p><p>Which should really at first glance be able to protect developers from this kind of thing -- if a character is invalid there are times you would like it to be treated as such!</p><p>Unfortunately, like I pointed out back in 2007 in <b><a href="http://archives.miloush.net/michkap/archive/2007/07/25/4037646.html" mce_href="http://archives.miloush.net/michkap/archive/2007/07/25/4037646.html">What's up with MB_ERR_INVALID_CHARS?</a></b>, it doesn't always get to work this way.</p><p>In fact the byte in question (0x8F) is not defined in code page 1252, but not handled by MB_ERR_INVALID_CHARS -- thus you get this "ignore it" behavior, along with being mapped to a control character that comes up as garbage.</p><p>So the backcompat issue rears its ugly head, with the argument being that this behavior has always been there.</p><p>When I think of all the breaks that have been introduced in the last few years in code pages for stated reasons like security hardening and Unicode conformance, I wonder whether it is a good time to question these issues and clean up crap like this.</p><p>Though I may be the only one who feels that way.... <br></p>
<hr/><p><strong>Random832</strong> on 4 Sep 2009 11:32 AM:</p><div style="margin-left: 1em"><p> "Test. 真的."; //this is a 9 character string with 2 Chinese characters. </p>
<p>No, it's a 11-byte string (not including the null terminator) containing the bytes that the compiler put there. Which happen to be 0xD5 0xE6 0xB5 0xC4, all of which are, obviously, defined and valid in codepage 1252.</p>
<p>There is no way for any function taking an ANSI string to distinguish this from a codepage 1252 string that actually is "Test. ÕæµÄ.", so it's not really a "the behavior has always been there" thing.</p></div>
<p><strong>Michael S. Kaplan</strong> on 4 Sep 2009 1:30 PM:</p><div style="margin-left: 1em"><p>Um, if you look at the Connect bug you will see that some of the examples deal with the case I describe (I did not pull that lead byte out of my ear!)....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2009/09/08/9891892.html" title="&quot;What kind of soup?&quot; is not exactly a soup question, is it?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2009/09/03/9890876.html" title="The Funk is no longer facile (aka George Clinton @ ShowBox Sodo)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-09-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/09/04/9890852.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>