<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/09/02/9890204.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How ConvertDefaultLocale sorta broke backward compatibility in Windows 7, and why</title></head><body>
<h1>How ConvertDefaultLocale sorta broke backward compatibility in Windows 7, and why</h1>
<p><em>by Michael S. Kaplan, published on 2009/09/02 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2009/09/02/9890204.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, Aaron asked:</p><blockquote><p><i><font face="times new roman,times">Michael,<br><br>We noticed a problematic breaking change between Windows 7 and previous OS's around ConvertDefaultLocale and the Spanish LCIDs<br><br>&nbsp;&nbsp;&nbsp; LCID lcid1 = ConvertDefaultLocale(PRIMARYLANGID(1034));<br>&nbsp;&nbsp;&nbsp; LCID lcid2 = ConvertDefaultLocale(PRIMARYLANGID(3082));<br><br>On XP and Vista, these both return 1034 as the value. On Windows 7, this returns 3082.<br><br>Same happens if we wrap this call with a MAKELCID/SUBLANG_NEUTRAL call:<br><br>&nbsp;&nbsp;&nbsp; LCID lcid3 = ConvertDefaultLocale(MAKELCID(PRIMARYLANGID(3082), SUBLANG_NEUTRAL));<br>&nbsp;&nbsp;&nbsp; LCID lcid4 = ConvertDefaultLocale(MAKELCID(PRIMARYLANGID(1034), SUBLANG_NEUTRAL));<br><br>This obviously causes bugs when using this function as part of best-guess resource lookups based off of GetUserDefaultLangID() results.<br><br>Do you have any insight into why this changed, and more importantly, what other lcid's have changed?<br><br>Thanks,<br><br>Aaron</font></i> <br></p></blockquote><p>Interesting! </p><p>Now I have talked about ConvertDefaultLocale in the past.</p><p>Like way back in 2005 (in <b><a href="http://archives.miloush.net/michkap/archive/2005/07/05/435885.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/05/435885.html">Change is in the cards for ConvertDefaultLocale....</a></b>) when I pointed out that ConvertDefaultLocale would likely be changed to fix the inconsistency between native NLS and managed globalization classes methods of fallback.</p><p>On in 2006 when I mentioned it again (in <b><a href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html">What the hell is wrong with TranslateCharsetInfo, anyway?</a></b>).</p><p>Then the kicker came a few months later in that same year when I wrote <b><a href="http://archives.miloush.net/michkap/archive/2006/11/07/1011692.html" mce_href="http://archives.miloush.net/michkap/archive/2006/11/07/1011692.html">How ConvertDefaultLocale sorta broke backward compatibility in Vista, and why</a></b>. In it I chronicled some though not all of the minor tweaks that ConvertDefaultLocale was using to try to make the two platforms behave more consistently.</p><p>This is not Aaron's issue, which is about a different change -- one apparently made in Windows 7. </p><p>It looks like they did the work to take on the issue I mentioned we almost fixed in Vista (in <b><a href="http://archives.miloush.net/michkap/archive/2006/09/23/768178.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/23/768178.html">The modern solution to the problem of Traditional Spanish in Vista</a></b>) but then backed out the fix due to backward compatibility problems (in <b><a href="http://archives.miloush.net/michkap/archive/2006/10/03/784459.html" mce_href="http://archives.miloush.net/michkap/archive/2006/10/03/784459.html">They say it happens to everyone, at some point...</a></b>).</p><p>And in that fix it appears they may have broken some assumptions that a developer might have made related to treating 0x040a and 0x0c0a as two different locales rather than as one locale with one alternate sort version of that locale.</p><p>Strictly speaking, the Windows 7 behavior is more correct.</p><p>However, the attempt to fix the similar bug in Vista was more correct, too (for all the good it did me and the others working on it!).</p><p>I've often suspected that the NLS team would "benefit " from having people like Julie and Cathy and me move on to other work since we wouldn't be around to make hairy nuisances of ourselves over the backcompat issues, and this appears to be another good example.</p><p>The behavior is actually better and more sensible from someone paying attention to meaning and context in figuring out behavior, but only time will tell if the ways in which this breaks other usages (like Aaron's) will be serious enough to inspire further tweaking.... <br></p>
<hr/><p><strong>Mihai</strong> on 3 Sep 2009 11:42 AM:</p><div style="margin-left: 1em"><p>From a completely different direction: using GetUserDefaultLangID (used for formatting number, dates/times, sorting, etc.) is the bad one to use for "resource lookups"</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2009/09/03/9890876.html" title="The Funk is no longer facile (aka George Clinton @ ShowBox Sodo)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2009/09/01/9889829.html" title="For language settings, Walmart ain&#39;t all that; 7-Eleven is what gets it done!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2009-09-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2009/09/02/9890204.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>