<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/05/28/609369.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Mirror, mirror... before whom I fuss, does mirroring work well in GDI+?</title></head><body>
<h1>Mirror, mirror... before whom I fuss, does mirroring work well in GDI+?</h1>
<p><em>by Michael S. Kaplan, published on 2006/05/28 20:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/05/28/609369.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Indeed, this is the question I came to ask the mirror, while the wicked queen was napping (or maybe she was off getting a facial?):</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Mirror, mirror... before whom I fuss, <BR>Does mirroring work well in GDI+?</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Of course the mirror cannot lie, so it is forced to answer truthfully:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Thy international features are very powerful, 'tis true; <BR>But GDI+'s mirroring capabilities will simply never do. <BR>Sometimes it reverses one time too many for thee,<BR>Other times it is off by a pixel or three.<BR>Even when it does work, this won't add up to beans;<BR>For Michael you, of all people, know what 'unsupported' means!</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Annoyed, I decide to risk seven years of bad luck and break the freaking mirror. But anticipating that it might eventually come to this, I spoke with an attorney prior to the B&amp;E, and he is convinced he can get the 7 years dropped down to 2⅓, possibly even with suspended sentence....</FONT></P>
<P><FONT face=Tahoma>As I slip out of the wicked queen's chamber, I wonder whether it would have been safer to try to look in MSDN for the answer. :-)</FONT></P>
<P><FONT face=Tahoma size=2><EM>(I don't know whether to be proud of the intro to this post or embarrassed about the fact that it took more time to write than the remaining text!)</EM></FONT></P>
<P><FONT face=Tahoma>I have talked a little about mirroring in <A href="http://archives.miloush.net/michkap/archive/2006/02/20/535260.html"><STRONG>previous</STRONG></A> <A href="http://archives.miloush.net/michkap/archive/2006/01/19/514656.html"><STRONG>posts</STRONG></A>.</FONT></P>
<P><FONT face=Tahoma>But a question I have been asked before and which comes up from time to time on&nbsp;discussion lists is how to make mirroring work properly in GDI+ -- or in the managed world.</FONT></P>
<P><FONT face=Tahoma>The short answer (covered in the GlobalDev article <A href="http://www.microsoft.com/globaldev/getwr/steps/WRG_mirror.mspx">Mirroring Awareness</A>) is that it doesn't:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Windows Forms don't support mirroring directly, as they do the <I>RightToLeft</I> property. Instead, you create your own controls to be displayed as you need. You can develop your own <I>RTLTreeview</I> control, for example, which inherits from the <I>Treeview</I> control and changes its style to be mirrored. </FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>In other words, the suggestion is to create two controls, and hide one of them. :-(</FONT></P>
<P><FONT face=Tahoma>The real truth is, as I said, that GDI+ does not support mirroring properly, and there are at present no plans to change that.</FONT></P>
<P><FONT face=Tahoma>If you do the work to mirror a device context and the DC is clipped, then GDI+ will write to the wrong location (a pixel or two off). A few code workarounds have been suggested to fix the problem, such as using the GDI OffsetRect function to adjust the clipping rectangle:</FONT></P><FONT face="Consolas,Courier New" size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG>RECT rcHDC, rcClip;<BR>::GetClientRect(hwnd, &amp;rcHDC );<BR>::GetClipBox(hdc, &amp;rcClip );<BR>::OffsetRect(rcDestination,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (rcClip.left - rcHDC.left) - (rcHDC.right - rcClip.right), <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0);</STRONG></P></BLOCKQUOTE></FONT><FONT face=Tahoma>
<P><FONT face=Tahoma>Other people actually just move it over one pixel, but doing the calculation feels a bit safer to do (and it doesn't always look like a single pixel to me!).</FONT></P>
<P>Now note that this only solves the 'slight pixel off' problem. The other problem that can occur is that the text can simply not flip at all (presumably due to the strange interactions of the RightToLeft property and the mirroring property for all new&nbsp;windows (set&nbsp;via the&nbsp;<A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/setprocessdefaultlayout.asp">SetProcessDefaultLayout function</A>).</FONT></P>
<P><FONT face=Tahoma>The result? Everything can end up not being mirrored, since the mirror image of a mirror image looks like the original. :-(</FONT></P>
<P><FONT face=Tahoma>Luckily, the fix for this is also reasonably straightforward -- you can simply remove the RTL layout flag if it is in there, so you can let the RightToLeft property do its thing without interference</FONT></P>
<P><FONT face="Consolas,Courier New" size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Disable flipping if necessary,&nbsp;to avoid&nbsp;being 'double-flipped'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwLayout = ::GetLayout(hdc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dwLayout &amp; LAYOUT_RTL) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ::SetLayout(hdc, dwLayout &amp; ~LAYOUT_RTL);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face=Tahoma><EM>(I suppose you can also go the other way around -- keeping the layout LTR in the property and using the mirroring stuff to do the flipping -- the key is to make sure that you do not use both -- though I have not actually tried this method, myself)</EM></FONT></P>
<P><FONT face=Tahoma>Now, for both of these problems, my advice is not to do anything unless you are actually seeing the problems in question (e.g. you may actually be using <A href="http://archives.miloush.net/michkap/archive/2005/10/11/479438.html"><STRONG>GDI rather than GDI+</STRONG></A> without realizing it!). The complaints come up often enough that I am pretty sure you will notice it pretty quickly if you try to mirror a managed application....</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>For direct text writing to a device context, It may be worth considering using the <A href="http://archives.miloush.net/michkap/archive/2005/10/11/479438.html"><STRONG>TextRenderer class</STRONG></A>, which neatly avoids the bulk of these issues.</FONT></P>
<P>There are other controls that have additional issues. </FONT><FONT face=Tahoma>For more information on them, the article <A href="http://msdn2.microsoft.com/en-us/library/7d3337xw(VS.80).aspx">How to: Display Right-to-Left Text in Windows Forms for Globalization</A> can be somewhat useful, but t</FONT><FONT face=Tahoma>he ultimate reference for the whole issue can be found in the document entitled <A href="http://msdn2.microsoft.com/en-us/library/fh376txk.aspx">Bi-Directional Support for Windows Forms Applications</A>. It talks not only about the <A href="http://msdn2.microsoft.com/en-us/library/system.windows.forms.control.righttoleft.aspx">RightToLeft</A> property, but also the (new in 2.0) <A href="http://msdn2.microsoft.com/en-us/library/system.windows.forms.form.righttoleftlayout.aspx">RightToLeftLayout</A> property that helps to overcome some of the 1.0/1.1 limitations. It also contains&nbsp;a handy reference chart for how each control supports things.</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>ק</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/05e7">U+05e7</A>, a.k.a. HEBREW LETTER QOF)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/11/06 <a href="http://archives.miloush.net/michkap/archive/2010/11/06/10085213.html">Please stop using this turd. And if you are an MS employee: stop using this turd. Now.</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/05/29/609737.html" title="When ALT+X seems to be failing...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/05/28/608979.html" title="Does it make sense to have &#39;Case&#39; more accessible?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-05-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/05/28/609369.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>