<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/05/06/591174.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting the real (localized) name of the keyboard</title></head><body>
<h1>Getting the real (localized) name of the keyboard</h1>
<p><em>by Michael S. Kaplan, published on 2006/05/06 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/05/06/591174.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><font face="Tahoma">The other day, someone had asked <a href="http://blogs.msdn.com/drintl/" mce_href="http://blogs.msdn.com/drintl/">Dr. International</a> about how to get the names of all the keyboards, the ones that appear in the Language Bar.</font></p>
<p><font face="Tahoma">Now this is definitely not the easiest thing in the world, so I figured I ought to show the best way to do it....</font></p>
<p><font face="Tahoma">The key is to look under the following registry key:</font></p>
<blockquote dir="ltr" style="margin-right: 0px;">
<p><font face="Courier New"><b>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Keyboard Layouts\</b></font></p></blockquote>
<p><font face="Tahoma">Each subkey represents a KLID (Keyboard Layout Identifer) for a specific keyboard layout.</font></p>
<p><font face="Tahoma">Under each of these keys you will see some of the following values:</font></p>
<ul>
<li><font face="Tahoma"><b>Layout Text</b> - Prior to XP, this is the localized, hard-coded name of the keyboard; for XP and beyond, this is the English name of the keyboard</font> 
</li><li><font face="Tahoma"><b>Layout Display Name</b> - This value only exists in XP and later; it contains a string suitable for interpretation by the <a href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/shloadindirectstring.asp" mce_href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/shloadindirectstring.asp">SHLoadIndirectString</a> function, which can be a pointer to a string in a DLL that contains the localized name of the keyboard layout, based on the current UI language</font> 
</li><li><font face="Tahoma"><b>Layout Id</b> - A hexidecimal number in string form that only exists for LANGID values that have multiple keyboard layouts, to help distinguish between them</font> 
</li><li><font face="Tahoma"><b>Layout File</b> - The name of the keyboard layout DLL&nbsp;</font> 
</li><li><font face="Tahoma"><b>Layout Component ID</b> - A GUID value in string form which&nbsp;only exists on keyboard layouts created and installed by MSKLC; it is used to uniquely identify custom keyboard layouts for install and uninstall</font> 
</li><li><font face="Tahoma"><b>IME file</b> - The name of the supporting data file for the IME, only present for IMEs</font> 
</li><li><font face="Tahoma"><b>System IME File</b> - The path and file to the IME file, only present for some IMEs (for legacy reasons)</font> 
</li><li><font face="Tahoma"><b>Old IME Version</b> - The version of the IME, only present for some IMEs (for legacy reasons)</font> 
</li><li><font face="Tahoma"><b>Old IME CodePage</b> - The code page value for the IME, only present for some IMEs (for legacy reasons); in IMEs that have this value that ship with Windows XP and later, it contains 0x04b0, a.k.a. 1200, meaning Unicode</font></li></ul>
<p><font face="Tahoma">Now obviously for the current question, only the <b>Layout Text</b> and <b>Layout Display Name</b> are relevant (the latter for XP and later, the former for prior versions and to act as a fallback).</font></p>
<p><font face="Tahoma">So the code can be something simple, like the following:</font></p>
<p><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("shlwapi.dll", CharSet=CharSet.Unicode, ExactSpelling=true)]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static extern uint SHLoadIndirectString(string pszSource,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder pszOutBuf,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint cchOutBuf,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr ppvReserved);<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static void KeyboardsOnMachine()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Microsoft.Win32.RegistryKey rk = null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Microsoft.Win32.RegistryKey rkSub = null;<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rk = Microsoft.Win32.Registry.LocalMachine.OpenSubKey("SYSTEM\\CurrentControlSet\\Control\\Keyboard Layouts");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null == rk) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Registry corrupt.");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw(new System.Security.SecurityException());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach(string stSubKey in rk.GetSubKeyNames()) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rkSub = rk.OpenSubKey(stSubKey, false);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null == rkSub) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Registry corrupt.");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw(new System.Security.SecurityException());<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stLayoutName = "";<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stLayoutText = rkSub.GetValue("Layout Text", "").ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stDisplayNameString = rkSub.GetValue("Layout Display Name", "").ToString();<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null != stDisplayNameString &amp;&amp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stDisplayNameString.Length&nbsp; &gt; 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sbName = new StringBuilder(260);<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(0 == SHLoadIndirectString(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stDisplayNameString, sbName, (uint)sbName.Capacity, IntPtr.Zero)) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stLayoutName = sbName.ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(stLayoutName.Length == 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stLayoutName = stLayoutText;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br></font><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(stLayoutName.Length &gt; 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("{0}\t{1}",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stSubKey,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stLayoutName);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rkSub.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch(System.Security.SecurityException) { }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; catch(ArgumentException) { }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; finally {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null != rkSub) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rkSub.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(null != rk) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rk.Close();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br></font><font face="Tahoma"><font size="2" face="Courier New">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }</font></font></p><font face="Tahoma"></font>
<p><font face="Tahoma">This code will build a nice big list of all of the available keyboards on the machine....</font></p>
<p><font face="Tahoma"></font>&nbsp;</p>
<p><font color="#ff1493" face="Tahoma"><i>This post brought to you by</i> "ಎ" <i>(<a href="http://www.fileformat.info/info/unicode/char/0c8e" mce_href="http://www.fileformat.info/info/unicode/char/0c8e">U+0c8e</a>, a.k.a. KANNADA LETTER E)</i></font></p>
<hr/><p><a id="591609" href="#591609">#</a> <strong>Jochen Kalmbach</strong> on 6 May 2006 2:26 PM:</p><div style="margin-left: 1em">An other interesting question (at least for me): How can I set the Keyboard and UI-Language on a MUI system via a program? We need this for an &quot;automatic&quot; post-install of the computer...
<br>I couldn&#180;t find any API to change the UI and keyboard layout permanently (OS default).</div>
<p><a id="591636" href="#591636">#</a> <strong>Michael S. Kaplan</strong> on 6 May 2006 3:48 PM:</p><div style="margin-left: 1em">Hello Jochen --<br><br>The UI language is a user-configurable setting -- why would you want to be changing the user's UI language?</div>
<p><a id="591646" href="#591646">#</a> <strong>Jochen Kalmbach</strong> on 6 May 2006 4:28 PM:</p><div style="margin-left: 1em">Hi Michael!<br>I need to change the UI language (and keyboard) as a &quot;post-install&quot; of our software on WinXP-Embedded due to customer specs.<br>Currently we nned to manually open the Control Panel and change it... isn&#180;t there any simpler way (API), so I can automatically do this?</div>
<p><a id="591658" href="#591658">#</a> <strong>Michael S. Kaplan</strong> on 6 May 2006 5:08 PM:</p><div style="margin-left: 1em">Hi Jochen,<br><br>Well, there is no Win32 API function to support it no. However, both SysPrep and the unattend features of intl.cpl (which I have discussed previously) should allow it to be set.</div>
<p><a id="592273" href="#592273">#</a> <strong>Jochen Kalmbach</strong> on 8 May 2006 7:11 AM:</p><div style="margin-left: 1em">Hi Michael!<br><br>Thank you very much! You directed me to the correct KB-article (<a rel="nofollow" target="_new" href="http://support.microsoft.com/kb/289125/en-us">http://support.microsoft.com/kb/289125/en-us</a>)! It seems that I missed this post...<br><br>Greetings<br> &nbsp;Jochen</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/05/11 <a href="http://archives.miloush.net/michkap/archive/2008/05/11/8488020.html">The vector of this spam is [apparently] indeterminate</a></p><p>2008/04/09 <a href="http://archives.miloush.net/michkap/archive/2008/04/09/8367652.html">Fight the Future? (#11 of ??), aka Microsoft is giving this character nada weight but lotsa importance</a></p><p>2008/03/06 <a href="http://archives.miloush.net/michkap/archive/2008/03/06/8026142.html">Getting the IME name (for someone who speaks Chinese, based on code from an article written in Chinese, when you don't speak Chinese)</a></p><p>2007/10/31 <a href="http://archives.miloush.net/michkap/archive/2007/10/31/5790802.html">Making things better out from under people: the story of MUI</a></p><p>2007/10/19 <a href="http://archives.miloush.net/michkap/archive/2007/10/19/5519516.html">A less intelligent strain of blog spam</a></p><p>2007/01/05 <a href="http://archives.miloush.net/michkap/archive/2007/01/05/1387397.html">How can be changed the keyboard layout name label?</a></p><p>2006/05/06 <a href="http://archives.miloush.net/michkap/archive/2006/05/06/591631.html">Keyboards and time zones have something in common</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/05/06/591631.html" title="Keyboards and time zones have something in common">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/05/05/590504.html" title="UI language of the LocalSystem account (which almost never shows UI)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-05-06">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/05/06/591174.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>