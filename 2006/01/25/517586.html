<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/25/517586.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>'right' does not always equal 'smart' #1</title></head><body>
<h1>'right' does not always equal 'smart' #1</h1>
<p><em>by Michael S. Kaplan, published on 2006/01/25 15:46 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/01/25/517586.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>I can think of&nbsp;one crucial </FONT><FONT face=Tahoma>scenario where the <STRONG>right behavior</STRONG> is not always what is conventionally considered the <STRONG>smart behavior</STRONG> by reasonable people.</FONT></P>
<P><FONT face=Tahoma>That scenario is&nbsp;appcompat/backcompat.</FONT></P>
<P><FONT face=Tahoma>The code may be doing something that is completely wrong and weird, but someone may be relying on it. So we keep in the wrong behavior.</FONT></P>
<P><FONT face=Tahoma>This of course happens often, which is why the title has a #1 there -- I anticipate that I'll be giving more examples in the future. :-)</FONT></P>
<P><FONT face=Tahoma>So, today's example takes us into <a href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html">the new FindNLSString function in Vista</A>, and its ancestors (the managed&nbsp;<A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassisprefixtopic.asp">IsPrefix</A>,&nbsp;<A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassindexoftopic.asp">IndexOf</A>, <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclasslastindexoftopic.asp">LastIndexOf</A>&nbsp;methods and particularly the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassissuffixtopic.asp">IsSuffix</A>&nbsp;method).</FONT></P>
<P><FONT face=Tahoma>You see, somebody decided a long time ago that the empty string is the suffix of every other string. I guess it is hard to argue that the empty string is not in fact a suffix since it is not not visible....</FONT></P>
<P><FONT face=Tahoma>But when you apply that to <A href="http://windowssdk.msdn.microsoft.com/library/en-us/Intl/nls_FindNLSString.asp">FindNLSString</A> with the FIND_ENDSWITH flag (which returns an index), it gets weirder. In order to meet this requirement, it has to return an index value that is one greater than the last character of the string (a length defined in the cchSource parameter).</FONT></P>
<P><FONT face=Tahoma>Now I suppose this is somewhat mitigated by the fact that the pcchFound parameter will indicate that the length of the string that was found was also zero. So that people who are using the function attentively will not be creating their own personal buffer overrun.</FONT></P>
<P><FONT face=Tahoma>Unfortunately, there are apparently managed applications that rely on this functionality (there was a large customer app which reportedly would not boot when the behavior was changed). And <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassissuffixtopic.asp">IsSuffix</A>&nbsp;depends on <A href="http://windowssdk.msdn.microsoft.com/library/en-us/Intl/nls_FindNLSString.asp">FindNLSString</A> with the FIND_ENDSWITH flag when supporting Windows-only cultures in Whidbey running on Vista (it is the real reason why the function was added!). So even though it is not very 'smart', it is in some sense the 'right' thing to do.</FONT></P>
<P><FONT face=Tahoma>But it definitely makes paying attention to that pcchFound parameter worthwhile!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "e" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0065">U+0065</A>, a.k.a. LATIN SMALL LETTER E)</EM></FONT></P>
<hr/><p><a id="517590" href="#517590">#</a> <strong>Michael S. Kaplan</strong> on 25 Jan 2006 3:51 PM:</p><div style="margin-left: 1em">Note that the strstr behavior actually always assumes it is a prefix so the suffix issue never comes up....</div>
<p><a id="517783" href="#517783">#</a> <strong>Gabe</strong> on 26 Jan 2006 3:43 AM:</p><div style="margin-left: 1em">I'm confused. Why would IsSuffix use the FIND_STARTSWITH flag? The docs you link to state the flag &quot;Tests whether lpStringValue is a prefix of lpStringSource&quot;.</div>
<p><a id="517792" href="#517792">#</a> <strong>Michael S. Kaplan</strong> on 26 Jan 2006 4:41 AM:</p><div style="margin-left: 1em">Sorry Gabe -- a mistyped. It is the FIND_ENDSWITH flag that IsSuffix uses....</div>
<p><a id="517842" href="#517842">#</a> <strong>Phylyp</strong> on 26 Jan 2006 9:32 AM:</p><div style="margin-left: 1em">Reasons you're similar to Raymond: <br>1. Your blogs on erroneous APIs being carried forward for backward-compat.  <br>2. Most of what you blog about goes right over my head.  <br>3. What little I understand just exemplifies the fact that I have a long way to go before reaching the professional standards you set.  <br>4. Reading the various gotchas ( <a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/10/15/481314.html">http://blogs.msdn.com/michkap/archive/2005/10/15/481314.aspx</a> ) on your blogs makes me remember my earlier programs that implement the erroneous method described <br><br>~Phylyp</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/01/26/517728.html" title="MSKLC and 64-bit">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/01/24/516693.html" title="A bit about the WM_IME_CHAR message">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/25/517586.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>