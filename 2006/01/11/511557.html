<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/11/511557.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Collation != Case (a.k.a. Collation <> Case)</title></head><body>
<h1>Collation != Case (a.k.a. Collation <> Case)</h1>
<p><em>by Michael S. Kaplan, published on 2006/01/11 09:51 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/01/11/511557.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Ian Young asked the following question recently:</FONT></P><FONT face=Tahoma><FONT size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT face="Times New Roman">There seems to be a discrepancy in SQL Server in the way case is treated between the UPPER(), LOWER() functions and case-sensitive comparisons. <BR></FONT><FONT face="Times New Roman">I would have thought that the following should produce no rows (where Numbers is a suitably large table of integers):</FONT></EM></P>
<P><FONT face="Courier New" size=1>SELECT n, c,<BR>UNICODE(LOWER(c)) AS ln, LOWER(c) AS lc,<BR>UNICODE(UPPER(c)) AS un, UPPER(c) AS uc FROM (<BR>SELECT n, NCHAR(n) COLLATE Latin1_General_CS_AS AS c<BR>FROM Numbers<BR>WHERE n BETWEEN 32 AND 65533<BR>) AS A<BR>WHERE UNICODE(LOWER(c)) &lt;&gt; UNICODE(UPPER(c))<BR>AND LOWER(c) = UPPER(c)</FONT></P>
<P><FONT face="Times New Roman"><EM>That is, we're looking for Unicode characters where conversion to upper- and lowercase yield different characters (according to their Unicode codepoint), but compare as equal with a case-sensitive, accent-sensitive comparison.<BR></EM></FONT><EM><FONT face="Times New Roman">The result is actually (SQL Server 2000, 2005) 176 rows consisting of a bunch of characters (U+04D0 -- U+04F9) from the Cyrillic block and many of the precomposed polytonic Greek characters in the Greek Extended block (U+1F00 -- U+1FFB).<BR></FONT><FONT face="Times New Roman">This result is the same irrespective of whether the accent-sensitive or -insensitive collation is used. It also (only tested on SQL Server 2000) gets the same results for Greek, Cyrillic_General, Ukrainian, and Macedonian collations.</FONT></EM></P>
<P><FONT face="Times New Roman"><EM>Am I missing something here?</EM></FONT></P>
<P><FONT face="Times New Roman"><EM>A suitably large table of integers:</EM></FONT></P>
<P><FONT face="Courier New" size=1>CREATE TABLE Numbers (n int PRIMARY KEY)<BR>INSERT INTO Numbers<BR>SELECT D0.i + D1.i*10 + D2.i*100 + D3.i*1000 + D4.i*10000 FROM<BR>(SELECT 0 AS i UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3<BR>UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6<BR>UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) AS D0,<BR>(SELECT 0 AS i UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3<BR>UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6<BR>UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) AS D1,<BR>(SELECT 0 AS i UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3<BR>UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6<BR>UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) AS D2,<BR>(SELECT 0 AS i UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3<BR>UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6<BR>UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) AS D3,<BR>(SELECT 0 AS i UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3<BR>UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6<BR>UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) AS D4</FONT></FONT></FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>Ian is correct, there are a large number of characters that fall into this category.</FONT></P>
<P><FONT face=Tahoma>The reason for this is that t</FONT><FONT face=Tahoma>here are many differences between the operations involved with converting the case of a function and doing case insensitive comparisons.</FONT></P>
<P><FONT face=Tahoma>For example:</FONT></P>
<UL>
<LI><FONT face=Tahoma>The case weight in collation is used in many languages that do not have case but have some other common tertiary distinction that needs to be represented, for example final forms in Hebrew.</FONT></LI>
<LI><FONT face=Tahoma>Other times, the case weight in collation is used even in languages that have case but also have the need to support other tertiary distinctions, like the Greek final sigma being not exactly the capital simga and not exactly the small one.</FONT></LI>
<LI><FONT face=Tahoma>In Thai and Indic languages, the case weight is also used in some cases to show tertiary distinctions.</FONT></LI>
<LI><FONT face=Tahoma>There are many 'one way' case conversions in Unicode that would not be candidates for&nbsp;an OS casing table (which generally needs data that is round-tripable) but which are just fine in collation.</FONT></LI>
<LI><FONT face=Tahoma>There are also many complex casing operations that cannot be done in the simple casing support of the OS (like the Sharp S, discussed previously).</FONT></LI></UL>
<P><FONT face=Tahoma>So in summary, the difference between the operations that Ian noted is an intentional one for linguistic reasons, though I think he wins an award for the most extensive investigation of the issue. :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>ς</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/03c2">U+03c2</A>, GREEK SMALL LETTER FINAL SIGMA)</EM></FONT></P>
<hr/><p><a id="511651" href="#511651">#</a> <strong>Maurits [MSFT]</strong> on 11 Jan 2006 12:39 PM:</p><div style="margin-left: 1em">This is based on binary operations rather than having to convert to decimal...<br><br>create table #nybble (n int)<br>create table #byte (b int)<br>create table #word (w int)<br><br>insert into #nybble values (0)<br>insert into #nybble select n + 1 from #nybble<br>insert into #nybble select n + 2 from #nybble<br>insert into #nybble select n + 4 from #nybble<br>insert into #nybble select n + 8 from #nybble<br><br>insert into #byte select (n1.n * 16) | n2.n from #nybble n1, #nybble n2<br>insert into #word select (b1.b * 256) | b2.b from #byte b1, #byte b2<br><br>--select * from #word order by w<br><br>drop table #nybble<br>drop table #byte<br>drop table #word</div>
<p><a id="511902" href="#511902">#</a> <strong>Abhinaba Basu [MSFT]</strong> on 12 Jan 2006 1:04 AM:</p><div style="margin-left: 1em">We've been bitten by this badly in the development of Visual Studio team system.<br><br>The issue is that source control needs files/folders stored in a Yukon server to be case insensitive because ultimately they are paths on Windows file system which is not case sensitive. The problem is that on Yukon you cannot say something like OrdinalIgnoreCase and we need to use case-insensitive collation sequence which depends on server locale. So the problem is on Turkish locale on my client I can have folders i and İ. However when this gets checked into a Yukon server running Turkish windows it fails as in the server collation both are same!! </div>
<p><a id="511906" href="#511906">#</a> <strong>Michael S. Kaplan</strong> on 12 Jan 2006 1:17 AM:</p><div style="margin-left: 1em">Yes, this is a good example of an implementation that is not doing things 100%correctly -- definitely a topic I will be talking more about on another day....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/09/26 <a href="http://archives.miloush.net/michkap/archive/2010/09/26/10067840.html">If case conversion were harder, people would do it less</a></p><p>2008/02/24 <a href="http://archives.miloush.net/michkap/archive/2008/02/24/7864631.html">The idea has to do more than just make sense to me (aka How S-Sharp are *you* feeling today?)</a></p><p>2007/10/25 <a href="http://archives.miloush.net/michkap/archive/2007/10/25/5664770.html">Jokes that aren't really all that funny in the end (aka At least SQL Server isn't on our case)</a></p><p>2007/08/24 <a href="http://archives.miloush.net/michkap/archive/2007/08/24/4536979.html">Every character has a story #28: U+1e9e (CAPITAL SHARP S)</a></p><p>2007/07/31 <a href="http://archives.miloush.net/michkap/archive/2007/07/31/4155336.html">If this post really describes a bug, would I actually put it in the WYNN column?</a></p><p>2007/04/10 <a href="http://archives.miloush.net/michkap/archive/2007/04/10/2071471.html">When methods use collation to 'disturb the peace' we charge them with being 'out of sorts'</a></p><p>2006/12/07 <a href="http://archives.miloush.net/michkap/archive/2006/12/07/1232220.html">SQL and the CLR: Part 1 (the things we can make work well)</a></p><p>2006/08/08 <a href="http://archives.miloush.net/michkap/archive/2006/08/08/692390.html">Collation != case, still</a></p><p>2006/06/02 <a href="http://archives.miloush.net/michkap/archive/2006/06/02/615571.html">What the @!#$% is the TERTIARY_WEIGHTS() function for?</a></p><p>2006/03/15 <a href="http://archives.miloush.net/michkap/archive/2006/03/15/551773.html">Casing and IgnoreCase are still not the same thing....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/01/11/511580.html" title="It doesn&#39;t sound like Yoghurt">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/01/10/511428.html" title="SIAO -- where lies become truth!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/11/511557.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>