<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/12/511884.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The creation of sort keys does not always make sense</title></head><body>
<h1>The creation of sort keys does not always make sense</h1>
<p><em>by Michael S. Kaplan, published on 2006/01/12 03:03 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/01/12/511884.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>I have talked a lot about sort keys in the past, like in <a href="http://archives.miloush.net/michkap/archive/2005/02/05/367666.html"><STRONG>this post</STRONG></A> and <a href="http://archives.miloush.net/michkap/archive/2004/12/30/344389.html"><STRONG>this one</STRONG></A>.</FONT></P>
<P><FONT face=Tahoma>They are pretty cool from a conceptual standpoint, but they do have one flaw that I was just reminded of the other day.</FONT></P>
<P><FONT face=Tahoma size=6><STRONG>They can actually take up a hell of a lot of space.</STRONG></FONT></P>
<P><FONT face=Tahoma>As I pointed out in <STRONG><a href="http://archives.miloush.net/michkap/archive/2005/05/19/419981.html">The String is Freaking Empty!</A></STRONG>, the minimally sized weight for a string that has no <a href="http://archives.miloush.net/michkap/archive/2005/02/02/365251.html"><STRONG>meaningful</STRONG></A> content is</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=4><STRONG>01 01 01 01 00</STRONG></FONT></P></BLOCKQUOTE></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>So there is a minimum five byte overhead, plus&nbsp;a minimum of two bytes per sort element and a maximum per sort element that is much higher once you add case and diacritic and width and special differences, you have one basic guarantee about a sort key -- that is will&nbsp;often be larger than the string.</FONT></P>
<P><FONT face=Tahoma>It kind of makes the signature&nbsp;for <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A> look a little bit silly, right? Attend me for a moment....</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>int LCMapString(<BR>&nbsp; LCID</STRONG><I> <A class=synParam onclick=showTip(this) href="#">Locale</A></I><B>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B>// locale identifier<BR><B>&nbsp; DWORD</B><I> <A class=synParam onclick=showTip(this) href="#">dwMapFlags</A></I><B>,&nbsp; </B>// mapping transformation type<BR><B>&nbsp; LPCTSTR</B><I> <A class=synParam onclick=showTip(this) href="#">lpSrcStr</A></I><B>,&nbsp; </B>// source string<BR><B>&nbsp; int</B><I> <A class=synParam onclick=showTip(this) href="#">cchSrc</A></I><B>,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </B>// number of characters in source string<BR><B>&nbsp; LPTSTR</B><I> <A class=synParam onclick=showTip(this) href="#">lpDestStr</A></I><B>,&nbsp; </B>// destination buffer<BR><B>&nbsp; int</B><I> <A class=synParam onclick=showTip(this) href="#">cchDest</A></I>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // size of destination buffer<BR><B>);</B></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>And then of course there is that very important note about cchDest:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma size=2><EM>If the function is being used to generate a sort key, the size is a byte count. This byte count must include space for the sort key 0x00 terminator.</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>That one guarantee you have, that the sort key will&nbsp;often be larger than the original string, makes a cch for the source and a cb for the dest look silly, when the source takes up two bytes per character. A string that is even one gigabyte in size is likely to need more than a 2 gigabyte buffer, and unless the string is entirely lowercase text with no diacritics in it, it&nbsp;may need 3 gigabytes or even more.</FONT></P>
<P><FONT face=Tahoma>Kind of makes you wonder why we bothered to confuse everyone and make cchDest mean a byte count for sort keys when we decided to confuse everyone in the <STRONG><a href="http://archives.miloush.net/michkap/archive/2005/10/22/483573.html">opposite</A> <a href="http://archives.miloush.net/michkap/archive/2005/10/21/483526.html">direction</A></STRONG> in <A href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A>/<A href="http://msdn.microsoft.com/library/en-us/intl/nls_7w1b.asp">SetLocaleInfo</A> when you pass in larger INT and FONTSIGNATURE values. So why not be confusing in the same way when we could get some benefit out&nbsp;of it?</FONT></P>
<P><FONT face=Tahoma>Of course, it is mildly immaterial since the notion of any kind of database that has rows that are over a gigabyte in size with index values that are 1.5-3 gigabytes or more per row in size is fairly unlikely.</FONT></P>
<P><FONT face=Tahoma>But if you are looking at limits, the ones laid out for the function that creates sort keys are fairly absurd, since a sort key that is anywhere near that size is absurd. There will come a point where the overhead of creating, updating, and deleting such key values will be much greater than any performance gain you get over using binary values rather than <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A> calls.</FONT></P>
<P><FONT face=Tahoma>Where is that point, exactly? Well, the strings would have to be very large.</FONT></P>
<P><FONT face=Tahoma>For a hint,&nbsp;think about limitations in databases on indexes on TEXT columns, which have&nbsp;this very tradeoff in mind. There are many such times that sort keys are completely absurd to use, not including <STRONG><a href="http://archives.miloush.net/michkap/archive/2005/07/31/445835.html">what's wrong with the Sortkey class</A></STRONG> in the .NET Framework.</FONT></P>
<P><FONT face=Tahoma>I will talk more about that tradeoff and how different implementations handle it another day. In the meantime, keep in mind that it does not make sense in all scenarios to use sort keys.</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT face="Code2000,Arial Unicode MS" size=6>ï¬ƒ</FONT>" <EM>(U+fb03, a.k.a. LATIN SMALL LIGATURE FFI)<BR><FONT size=1>(A character that is thinking if only more letters followed its example, sort keys could fit&nbsp; three times as many characters!)</FONT></EM></FONT></P>
<hr/><p><a id="512090" href="#512090">#</a> <strong>Mihai</strong> on 12 Jan 2006 12:46 PM:</p><div style="margin-left: 1em">Hi MisKa<br><br>Is there a chance to document the sort key?<br>At least a little bit?<br>Not in the official documentation, and not complete, because having ppl. start using/messing with it is a problem.<br>But at least enought for the readers of your blog to understand what you are talking about.<br><br>Yes, one might spend some hours with LCMapString and &quot;reverse engineer&quot; at least parts of the key (which I did a while ago), but why?<br></div>
<p><a id="512101" href="#512101">#</a> <strong>Michael S. Kaplan</strong> on 12 Jan 2006 1:05 PM:</p><div style="margin-left: 1em">Sounds like something for the suggestion box if ever there was something. :-)</div>
<p><a id="512252" href="#512252">#</a> <strong>Michael S. Kaplan</strong> on 12 Jan 2006 6:02 PM:</p><div style="margin-left: 1em">Also, who is the 'mishka' chap everyone keeps talking about? :-)</div>
<p><a id="563112" href="#563112">#</a> <strong>Maurits [MSFT]</strong> on 28 Mar 2006 12:00 PM:</p><div style="margin-left: 1em">Mischka is the Russian equivalent of &quot;Mike&quot; (Mischa + dimunitive ka)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/01/12/511920.html" title="What is the name of that character?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/01/11/511580.html" title="It doesn&#39;t sound like Yoghurt">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01-12">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/12/511884.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>