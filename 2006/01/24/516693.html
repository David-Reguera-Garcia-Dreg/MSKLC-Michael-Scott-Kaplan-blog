<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/24/516693.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A bit about the WM_IME_CHAR message</title></head><body>
<h1>A bit about the WM_IME_CHAR message</h1>
<p><em>by Michael S. Kaplan, published on 2006/01/24 10:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/01/24/516693.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Ben Bryant asked in the microsoft.public.win32.programmer.international newsgroup:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT face=times size=2>I am getting mixed messages about what code page is given to a WM_IME_CHAR handler in an ANSI build. I would like to assume its the default system locale code page (GetACP), but is there a keyboard input code page setting since you can change your keyboard input language without rebooting? </FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The <A href="http://msdn.microsoft.com/library/en-us/intl/ime_1diq.asp">WM_IME_CHAR</A> message is (unlike the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_unichar.asp">WM_UNICHAR</A> message) not always going to be Unicode. Unfortunately, t</FONT><FONT face=Tahoma>he code page is the default ANSI code page of the system, which is returned by the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_21bk.asp">GetACP</A> function. And the only real workaround for this is to use the Unicode messages or at least the Unicode IMM functions when using the IME.</FONT></P>
<P><FONT face=Tahoma>Note that the functions support Unicode even on Win9x, as per the topic <A href="http://msdn.microsoft.com/library/en-us/intl/ime_371h.asp">The Input Method Editor and Unicode</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><B>Windows 98/Me, Windows NT/2000/XP:</B> Windows supports a Unicode interface for the IME, in addition to the ANSI interface originally supported. Windows 98/Me supports all the Unicode functions except </FONT><B><FONT size=2>ImmIsUIMessage</FONT></B><FONT size=2>. Also, all the messages in Windows 98/Me are ANSI based. Since Windows 98/Me does not support Unicode messages, applications can use </FONT><B><FONT size=2>ImmGetCompositionString</FONT></B><FONT size=2> to receive Unicode characters from a Unicode-based IME on Windows 98/Me. </FONT></P>
<P><FONT size=2>There are two issues involved with Unicode handling and the IME. One is that the Unicode versions of IME routines return the size of a buffer in bytes rather than 16-bit Unicode characters, and the other is the IME normally returns Unicode characters (rather than DBCS) in the </FONT><B><FONT size=2>WM_CHAR</FONT></B><FONT size=2> and </FONT><B><FONT size=2>WM_IME_CHAR</FONT></B><FONT size=2> messages. </FONT></P>
<P><FONT size=2>Use </FONT><B><FONT size=2>RegisterClassW</FONT></B><FONT size=2> to cause the <B>WM_CHAR</B> and <B>WM_IME_CHAR</B> messages to return Unicode characters in the <I>wParam</I> parameter rather than DBCS characters. This is only available under Windows NT; it is stubbed out in Windows 95/98/Me.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Of course, running on the NT-based platforms, even if you deal with the mess of the non-Unicode version of <A href="http://msdn.microsoft.com/library/en-us/intl/ime_1diq.asp">WM_IME_CHAR</A>, it is still better than the packed double message that <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_char.asp">WM_CHAR</A> handling would receive -- that is a true nightmare.</FONT></P>
<P><FONT face=Tahoma>But if you have a Unicode application, you will be <EM>much</EM> better off. Or even a non-Unicode application that ignores the content of <A href="http://msdn.microsoft.com/library/en-us/intl/ime_1diq.asp">WM_IME_CHAR</A> and just uses it as a trigger to call <A href="http://msdn.microsoft.com/library/en-us/intl/ime_9753.asp">ImmGetComposiionString</A>....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "U" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0055">U+0055</A>, a.k.a. LATIN CAPITAL LETTER U)</EM></FONT></P>
<hr/><p><a id="517143" href="#517143">#</a> <strong>Ben Bryant</strong> on 24 Jan 2006 6:26 PM:</p><div style="margin-left: 1em">Thanks, ur da man! I was just noticing how WM_UNICHAR gives a handy UTF-32 code point. I suppose you probably said this somewhere but does the wide WM_CHAR support supplimentary code points?</div>
<p><a id="517229" href="#517229">#</a> <strong>Michael S. Kaplan</strong> on 24 Jan 2006 9:39 PM:</p><div style="margin-left: 1em">No, it would come in as two separate UTF-16 WM_CHAR messages....</div>
<p><a id="518708" href="#518708">#</a> <strong>Ben Bryant</strong> on 28 Jan 2006 11:12 AM:</p><div style="margin-left: 1em">Still having trouble believing it is the default ANSI code page of the system (ACP). I would expect the characters to be nulled out if they did not exist in the ACP but I am getting garble, so I am still guessing it is actually the WM_INPUTLANGCHANGE code page. Using an input language not supported by the ACP would suggest that in a non-Unicode program I need to handle WM_IME_COMPOSITION and call ImmGetComposiionStringW (N.B. the W on the end of that).</div>
<p><a id="518727" href="#518727">#</a> <strong>Michael S. Kaplan</strong> on 28 Jan 2006 12:58 PM:</p><div style="margin-left: 1em">There is actually a great deal of overlap in lead bytes and some glyph appearing in the various code pages -- and thus you can easily just garbled text in that case. It is the ACP that is used.<br><br>But I would definitely recommend calling the Unicode IME functions -- in fact I did recommend exactly that! :-)</div>
<p><a id="518754" href="#518754">#</a> <strong>Ben Bryant</strong> on 28 Jan 2006 2:19 PM:</p><div style="margin-left: 1em">Thanks agaain for responding. Well, there is not much overlap in Arabic and Latin-1 outside of ASCII, but my customer is typing on an Arabic on screen keyboard and getting European accented characters on US English Windows. If the IME service was doing a Unicode to ANSI conversion behind the scenes to supply WM_IME_CHAR I wouldn't get &quot;overlap,&quot; I'd expect to get replacement chars (question marks) or nothing. At any rate, I do not see any reason to ever see garbled text even if there was overlap, so I do not see your point. In fact, the garble that I am seeing is the reason I think it is not the ACP, it is Arabic encoding which I am treating as the Windows-1252 ACP.</div>
<p><a id="518769" href="#518769">#</a> <strong>Michael S. Kaplan</strong> on 28 Jan 2006 4:18 PM:</p><div style="margin-left: 1em">Unfortunately, two things happen:<br><br>1) In some cases, other characters fit on the other code page for those same bytes, and<br><br>2) In other cases, esp. on other EA code pages, you will get other ideographs as lot of the time....<br><br>As usual, keeping it all Unicode is the best way to go. :-)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/01/25/517586.html" title="&#39;right&#39; does not always equal &#39;smart&#39; #1">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/01/24/516670.html" title="Novantrone doesn&#39;t work for everyone">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/24/516693.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>