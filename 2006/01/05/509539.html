<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/05/509539.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Keyboards over Terminal Server</title></head><body>
<h1>Keyboards over Terminal Server</h1>
<p><em>by Michael S. Kaplan, published on 2006/01/05 10:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/01/05/509539.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Ilya Constantinov asked in the Suggestion Box:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>Remote Desktop seems to have an undocumented behavior of passing on your current keyboard layout (at time of connection) to be installed on the server you're connecting to. This sort-of makes sense, especially cause it's installed only for the duration of the session, but why don't all my local keyboard layouts get installed on the server side? Was there special reasoning for that? </EM></FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>And not too long ago a related question&nbsp;came up from an email from Holger Luebsen:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT size=2>When I connect to a US English Terminal Server and my local default language is say French, then the logon prompt on the Terminal Server shows FR and I can toggle to EN. So far so good.&nbsp; </FONT></EM></P>
<P><EM><FONT size=2>The problem comes, when my local default language is English and I select a temporary French keyboard/language locally and connect to the Terminal Server. The logon prompt will show EN, but type FR. I can then toggle the language. It still displays EN, but now types English. Toggle back and it is French again.</FONT></EM></P>
<P><EM><FONT size=2>Now when I cancel the logon, but do not close the rdp client, switch the keyboard to German and connect again, the language indicator correctly shows DE. If I now cancel again without closing the rdp client and switch back to French and connect it correctly displays FR. </FONT></EM></P>
<P><EM><FONT size=2>If I cancel and close the rdp client, open a new client and connect I will see EN again instead of FR.</FONT></EM></P>
<P><EM><FONT size=2>That looks like a bug to me. Is this known and has someone a fix for this? Anybody else experienced this?</FONT></EM></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>Hmmm.... lots of information in there, isn't there? Let's try combining it all&nbsp;with the feature in the <a href="http://archives.miloush.net/michkap/archive/2005/01/07/348944.html"><STRONG>Updating the keyboard list in the logon dialog</STRONG></A> post.</FONT></P>
<P><FONT face=Tahoma>I have&nbsp;a Windows Vista&nbsp;machine that has the English and&nbsp;Greek keyboard layouts installed using the logon dialog trick above, and on my machine I have installed English, Russian, Greek,&nbsp;and Thai keyboards. From the very beginning in the Login dialog you can see the language list is available:</FONT></P>
<P><FONT face=Tahoma><IMG height=507 src="http://trigeminal.fmsinc.com/images/LogonKeyboard1.jpg" width=648></FONT></P>
<P><FONT face=Tahoma>Now note that in this case the English keyboard is my process default. Let's try changing the latter, using the same thing but with a Greek process default.</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/LogonKeyboard2.jpg"></FONT></P>
<P><FONT face=Tahoma>Ok, so now we know that the Terminal Services is smart enough to negotiate when the same keyboard you are trying to use before the login is available on both client and server.</FONT></P>
<P><FONT face=Tahoma>Unfortunately, it does go downhill from here....</FONT></P>
<P><FONT face=Tahoma>Let's try switching to one of those other keyboard layouts on the client (either by setting the process default or switching to the keyboard prior to hitting the Connect button). What do we get in the dialog?</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/LogonKeyboard3.jpg"></FONT></P>
<P><FONT face=Tahoma>Wow, it picked up the Russian! And if you Left Alt+Shift toggle through layouts it does not hit that other keyboard (the Thai one). And as I move between the layouts (so I can type in my password!) the language bar icon updates:</FONT></P>
<P><IMG src="http://trigeminal.fmsinc.com/images/LogonKeyboard4.jpg"></P>
<P><FONT face=Tahoma>Once I have logged in, that Russian layout is the one that is selected in the Language List and it is the process default....</FONT></P>
<P><IMG src="http://trigeminal.fmsinc.com/images/LogonKeyboard5.jpg"></P>
<P><FONT face=Tahoma>But the weird part is that it is not on the Text Services and Input Language dialog as being the process default or even on the list at all!</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/LogonKeyboard6.jpg"></FONT></P>
<P><FONT face=Tahoma>This is definitely a temporary keyboard, isn't it? :-)</FONT></P>
<P><FONT face=Tahoma>I ran several experiments (inspied by Holger's posting) and found that I was able to confuse it sometimes (though not as often as the bug report I mentioned earlier!), but it seemed remarkably robust in light of all the odd changes being thrown at it.&nbsp;And when I was done <FONT color=#808080><STRIKE>playing around</STRIKE></FONT>researching, all traces of the extra 'temporary' keyboards were gone.</FONT></P>
<P><FONT face=Tahoma>So when I consider the real world scenarios involving users who explicitly change their keyboard layouts, I think they are most likely to get what they expect (if they switch to a keyboard layout, that keyboard is used). It seems fragile enough for a tester to find oodles of minor inconsistencies, but robust enough that it recovers gracefully.</FONT></P>
<P><FONT face=Tahoma>And it does seem to be getting better in Vista (this very post might cause it to be a little better if&nbsp;any bug reports are inspired by it!).</FONT></P>
<P><FONT face=Tahoma>I definitely don't envy the folks who had to do the work to build the logic for the huge matrix of possibilities between all of the possible server and client settings. It might be the hour I am typing this but I honestly get a headache just thinking about it....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>Î¨</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/03a8">U+03a8</A>, a.k.a. GREEK CAPITAL LETTER PSI)</EM></FONT></P>
<hr/><p><a id="509716" href="#509716">#</a> <strong>Marc Brooks</strong> on 5 Jan 2006 12:30 PM:</p><div style="margin-left: 1em">First, I know I should just try it, but I'm busy...<br><br>Would this automatic installation of keyboard handling open the door to extending system-level deviousness into the RDP server? Could my carefully constructed custom keyboard be infected, injected, and then applied to the RDP server to do my bidding?<br><br>Should I worry?</div>
<p><a id="509765" href="#509765">#</a> <strong>Michael S. Kaplan</strong> on 5 Jan 2006 2:14 PM:</p><div style="margin-left: 1em">Hi Marc,<br><br>Good question, but you don't have to worry. TS does not copy the keyboard layouts -- it is using layouts that exist on both machines.</div>
<p><a id="509865" href="#509865">#</a> <strong>Ilya Konstantinov</strong> on 5 Jan 2006 6:39 PM:</p><div style="margin-left: 1em">Michael, thanks for the answer. &quot;It's by design&quot; is pretty much what I expected to hear, but still wanted to get that issue to your attention.<br><br>Simply enough, the RDP protocol seems to have a single place for an LCID so you've gotta pick one. Why do I know this? I've been working on this very thing in rdesktop, the open source RDP client.</div>
<p><a id="509874" href="#509874">#</a> <strong>Michael S. Kaplan</strong> on 5 Jan 2006 6:51 PM:</p><div style="margin-left: 1em">Ah, but the thing that will really bake a person's noodle is wondering what SystemParametersInfo with the SPI_GETDEFAULTINPUTLANG would do in this case of the &quot;temp default keyboard&quot; (and then whether that is the right thing!). :-)</div>
<p><a id="510312" href="#510312">#</a> <strong>Ben Cooke</strong> on 6 Jan 2006 8:12 PM:</p><div style="margin-left: 1em">I've often paused to wonder why the remote desktop protocol doesn't just send over the Unicode characters generated by my local keymap, rather than sending over the scancodes (presumably) and interpreting it remotely.<br><br>This way I'd be able to change my keyboard layout using the language bar *on the client* just as I do for any other application. Even aside from that particular benefit, it seems obvious to use the client keyboard layout since it's the client that's got the user's keyboard plugged into it!</div>
<p><a id="510333" href="#510333">#</a> <strong>Michael S. Kaplan</strong> on 6 Jan 2006 10:55 PM:</p><div style="margin-left: 1em">Hi Ben,<br><br>It is actually a slippery slope to start moving more and more functionality down to the client, but in this case it is not possible -- the keyboard sends keyboard messages to the app and if processed appropriately with the thread's input language then a keyboard msg is sent. There is no way to move all of that processing down to the client....</div>
<p><a id="541323" href="#541323">#</a> <strong>Ilya Konstantinov</strong> on 1 Mar 2006 11:09 AM:</p><div style="margin-left: 1em">Of course we still need to send AT scancodes so things like WM_KEYDOWN will keep behaving as usual, but couldn't TranslateMessage be hacked so that (just in the case of RDP session) it'll emit a WM_UNICHAR message with a value received from network rather than attempt to translate the WM_KEYDOWN?<br><br>Furthermore, switching windows will have to message the client, asking it to change its keyboard language to the remote thread's language.<br><br>Oh, and when a remote thread will query for installed keyboard languages, it'll get the client's list.<br><br>Yup, lots of hacks needed here, some can potentially make input flaky over high-latency connections. For example, what if you switch a window and start typing ahead of time, before the message telling your RDP client to switch its language to the active window's language has arrived?<br><br>The &quot;AT scancodes&quot; requirement complicates things quite a bit on platforms where its hard to get the underlying AT scancode (and pray your keyboard is even an AT one!) but don't let this trouble your Wintel head :/</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/11/29 <a href="http://archives.miloush.net/michkap/archive/2007/11/29/6594984.html">The UK Extended keyboard -- over-extended? Or weirdly extended?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/01/06/509772.html" title="When not to use MLang">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/01/05/509100.html" title="A script, by any other name">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-01-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/01/05/509539.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>