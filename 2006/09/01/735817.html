<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/01/735817.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Cue the smarter version of GetDateFormat... ok, it's a wrap!</title></head><body>
<h1>Cue the smarter version of GetDateFormat... ok, it's a wrap!</h1>
<p><em>by Michael S. Kaplan, published on 2006/09/01 16:41 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/09/01/735817.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>I've mentioned Tarek Mahmoud Sayed from the GIFT development team <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/09/14/464780.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/14/464780.html">in the past</A></STRONG>. The other day, in helping out some folks who were dealing with the issues I pointed out in <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html">How To [NOT] detect that a locale is bidi</A></STRONG> and <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/02/08/527375.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/08/527375.html">They make 'em smarter than GetDateFormat</A></STRONG>, and&nbsp;at the end of the conversation had produced a nice wrapper around GetDateFormat that takes away the bulk of the need for developers calling <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp">GetDateFormat</A> to figure out what flags to pass if they are not sure.</P>
<P><STRONG><FONT color=#ff0000>UPDATE 06 Oct 2006: Small addition to the code to handle an interesting case that the NLS&nbsp;function supports. It is marked in RED in the code. -- michkap</FONT></STRONG>&nbsp;</P>
<P>I thought maybe I would post the code here so others could benefit! :-)</P>
<P>Anyway, here is the wrapper:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><B><FONT face="Consolas,Courier New,Courier" size=2>
<P>int GetDateFormatWrapper(<BR>&nbsp;&nbsp;&nbsp; LCID Locale, <BR>&nbsp;&nbsp;&nbsp; DWORD dwFlags, <BR>&nbsp;&nbsp;&nbsp; CONST SYSTEMTIME* lpDate, <BR>&nbsp;&nbsp;&nbsp; LPCTSTR lpFormat, <BR>&nbsp;&nbsp;&nbsp; LPTSTR lpDateStr, <BR>&nbsp;&nbsp;&nbsp; int cchDate <BR>)<BR>{<BR>&nbsp;&nbsp;&nbsp; DWORD dwBidiFlags = 0;</P>
<P>&nbsp;&nbsp;&nbsp; if ((dwFlags &amp; (DATE_LTRREADING | DATE_RTLREADING)) == 0)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WCHAR FontSignature[16];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CALID CalId;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#ff0000>Locale = ConvertDefaultLocale(Locale);<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwBidiFlags = DATE_LTRREADING;</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (GetLocaleInfo(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Locale, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOCALE_FONTSIGNATURE, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (LPWSTR) FontSignature, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sizeof(FontSignature)/sizeof(FontSignature[0])) <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FontSignature[7] &amp; 0x0800<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetLocaleInfo(Locale, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LOCALE_ICALENDARTYPE | LOCALE_RETURN_NUMBER, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (LPWSTR) &amp;CalId, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sizeof(CalId)/sizeof(WCHAR))) {<BR><BR><FONT color=#ff0000><FONT color=#006400>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // A&nbsp;small&nbsp;addition&nbsp;(in red)&nbsp;to&nbsp;help with the <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // myriad&nbsp;of ways&nbsp;GetDateFormat can be called<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (((dwFlags &amp; (DATE_YEARMONTH | DATE_SHORTDATE | DATE_LONGDATE) == 0))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(lpFormat == NULL)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dwFlags |= DATE_SHORTDATE;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#006400>// Bidi Locale</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (PRIMARYLANGID(LANGIDFROMLCID(Locale)) == LANG_HEBREW) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((dwFlags &amp; DATE_SHORTDATE) == 0 || CalId == CAL_HEBREW) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwBidiFlags = DATE_RTLREADING;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if ( CalId == CAL_GREGORIAN || <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CalId == CAL_HIJRI || <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CalId == 23 || <FONT color=#006400>// CAL_UMALQURA</FONT> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CalId == CAL_GREGORIAN_ARABIC || <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CalId == CAL_GREGORIAN_XLIT_ENGLISH || <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CalId == CAL_GREGORIAN_XLIT_FRENCH) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwBidiFlags = DATE_RTLREADING;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }</P>
<P>&nbsp;&nbsp;&nbsp; return GetDateFormat(Locale, dwFlags | dwBidiFlags, lpDate, lpFormat, lpDateStr, cchDate);<BR>}</P></FONT></B></BLOCKQUOTE>
<P>This function has some very compelling features to it, such as the fact that it integrates the IsBidi sort of code I talked about previously and that the signature of the&nbsp;wrapper is identical, but what I like best about it is that if this functionality were added to <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp">GetDateFormat</A>&nbsp;in a future version of Windows that&nbsp;then none of the code calling the wrapper would be broken. :-)</P>
<P>Enjoy!</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by <A href="http://www.fileformat.info/info/unicode/char/200f" mce_href="http://www.fileformat.info/info/unicode/char/200f"><EM>U+200f</A>, RIGHT-TO-LEFT MARKER</EM></FONT></P></FONT></EM>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/16 <a href="http://archives.miloush.net/michkap/archive/2012/01/16/10256752.html">I'm reasonably certain that those who disagree with me here are wrong!</a></p><p>2008/09/24 <a href="http://archives.miloush.net/michkap/archive/2008/09/24/8963238.html">It used to be right, dammit!</a></p><p>2008/02/20 <a href="http://archives.miloush.net/michkap/archive/2008/02/20/7810085.html">Officially unofficial? Or Unofficially official?</a></p><p>2007/11/02 <a href="http://archives.miloush.net/michkap/archive/2007/11/02/5808539.html">Predictably (in retrospect), aka Where Wild^H^H^Hindows-Only Things Are, aka SHORT [on ]TIME for a LONG TIME</a></p><p>2006/12/11 <a href="http://archives.miloush.net/michkap/archive/2006/12/11/1262690.html">IsComplexEnoughForYou?</a></p><p>2006/12/09 <a href="http://archives.miloush.net/michkap/archive/2006/12/09/1246712.html">On being consistently consistent, while still managing to be dead wrong</a></p><p>2006/10/15 <a href="http://archives.miloush.net/michkap/archive/2006/10/15/827944.html">Not everything you might want out of a GetDateFormatEx, but think of it as a fixer-upper</a></p><p>2006/10/06 <a href="http://archives.miloush.net/michkap/archive/2006/10/06/795575.html">What do those marks do again?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/09/01/735860.html" title="What is this &#39;ass-key&#39; of which you speak?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/09/01/735817.html" title="Cue the smarter version of GetDateFormat... ok, it&#39;s a wrap!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09-01">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/01/735817.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>