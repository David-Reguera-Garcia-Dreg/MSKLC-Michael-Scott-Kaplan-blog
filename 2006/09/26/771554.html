<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/26/771554.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>In case you have a yen to extend your keyboard (or at least want a yen?)</title></head><body>
<h1>In case you have a yen to extend your keyboard (or at least want a yen?)</h1>
<p><em>by Michael S. Kaplan, published on 2006/09/26 09:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/09/26/771554.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>It was last week in the post <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/09/20/763157.html">Variation on that theme of wanting more keys covered by MSKLC</A></STRONG> that I talked about Olivier's non-specific question about adding additional keys to the keyboard with MSKLC. </P>
<P>And then yesterday, Olivier gave the specifics in a <A href="http://archives.miloush.net/michkap/archive/2006/09/20/763157.html#770862">comment</A>: </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>In my specific case, I was talking about an Apple Japanese keyboard that has 3 keys not present in default layout: <BR><BR>- Yen key (left to delete key) <BR>- &nbsp;2 keys, one to left and one to right of space bar (used to switch input method) <BR><BR>Under Windows, these keys currrently don't work. <BR><BR>Hope this helps. <BR><BR>Olivier </P></FONT></BLOCKQUOTE>
<P>So now that he gave some specifics, I thought I would dig in a bit. :-)</P>
<P>For this post, I am going to focus on that Yen key that Olivier mentioned (the same key he refers to on the Japanese Apple keyboard exists on the Windows 106 key Japanese keyboard). Here is a picture of the one I have, just so we know what we are talking about:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/japanese_keyboard.png"></P>
<P>Now you can compare this to the keyboard you find up on <A href="http://www.microsoft.com/globaldev/reference/keyboards.mspx">GlobalDev</A>:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd1.png"><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd2.png"><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd3.png"><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd4.png"><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd5.png"><IMG src="http://trigeminal.fmsinc.com/images/jpnkbd6.png">&nbsp;&nbsp;&nbsp;</P>
<P>Hmmm.... that key does not really seem to be very well represented, does it? It definitely isn't that other key under the backspace, either. </P>
<P>And even though <A href="http://www.microsoft.com/globaldev/tools/msklc.mspx">MSKLC</A> has a Japanese keyboard on the list of existing keyboards, that one doesn't have this key either. Which is why <A href="http://www.microsoft.com/globaldev/tools/msklc.mspx">MSKLC</A> doesn't have this key, by the way -- because no existing keyboard ever maps the scan code. EVER.</P>
<P>So let's see if we can do something here about this, okay? :-)</P>
<P>We'll take that little app I wrote in <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/12/15/504092.html">Handling [Unicode] input in the console</A></STRONG> and use it with that Japanese keyboard to see what this key outputs:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New"><STRONG>E:\test\READ\Debug&gt;read<BR>ReadConsoleInput test<BR>Ctrl-D to quit.<BR><BR>#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UC&nbsp;&nbsp;&nbsp; u/d&nbsp; VK&nbsp;&nbsp; SC&nbsp; State<BR><BR>&nbsp; 0: U+0000 down 00ff 007d 0000<BR>&nbsp; 1: U+0000&nbsp; up&nbsp; 00ff 007d 0000</STRONG></FONT></P></BLOCKQUOTE>
<P>Ok, the scan code is 0x7d. Now let's see what that 0xFF scan code is in winuser.h:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Consolas,Courier New" size=2><STRONG>
<P>#define VK_ATTN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xF6<BR>#define VK_CRSEL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xF7<BR>#define VK_EXSEL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xF8<BR>#define VK_EREOF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xF9<BR>#define VK_PLAY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xFA<BR>#define VK_ZOOM&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xFB<BR>#define VK_NONAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xFC<BR>#define VK_PA1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xFD<BR>#define VK_OEM_CLEAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0xFE<BR><BR>/*<BR>&nbsp;* 0xFF : reserved<BR>&nbsp;*/<BR><BR><BR>#endif /* !NOVIRTUALKEYCODES */</P></STRONG></FONT></BLOCKQUOTE>
<P>It looks like this is simply not a VK value, which explains why the code did not find a character!</P>
<P>Of course it is the keyboard layout DLLs that are created by MSKLC that have the job of mapping scan codes to virtual keys. So, now we know what to do, right? We just have to add the right entry to this table!</P>
<P>If you go into MSKLC and choose to save the US layout as a .KLC file (uscustom.klc), you can look at that file in Notepad. </P>
<P>Now just look at the end of a bunch of entries in the LAYOUT table, which look like this:</P>
<P><FONT face="Consolas,Courier New" size=2>35&nbsp;OEM_2&nbsp;&nbsp;&nbsp; 0 &nbsp;002f &nbsp;003f &nbsp;-1&nbsp;&nbsp;&nbsp; // SOLIDUS, QUESTION MARK, &lt;none&gt;<BR>39&nbsp;SPACE &nbsp; &nbsp;0&nbsp; 0020 &nbsp;0020 &nbsp;0020&nbsp;&nbsp;// SPACE, SPACE, SPACE<BR>56&nbsp;OEM_102&nbsp; 0 &nbsp;005c&nbsp; 007c &nbsp;-1&nbsp;&nbsp;&nbsp; // REVERSE SOLIDUS, VERTICAL LINE, &lt;none&gt;<BR>53&nbsp;DECIMAL &nbsp;0&nbsp; 002e &nbsp;002e &nbsp;-1&nbsp;&nbsp; // FULL STOP, FULL STOP, <BR></FONT></P>
<P>The first column is the scan code, the second is the virtual key minus the VK_, the third is the impact of the caps lock key, and the columns after that are the characters that show up.</P>
<P>So let's add one column just before the "53&nbsp; DECIMAL" entry (which must be the last entry in the table). Since I am doing this with the US keyboard, I will use VK_OEM_8, a VK value that is not yet used (you can't duplicate scan codes or virtual keys):</P>
<P><FONT face=Consolas size=2>7d&nbsp;OEM_8&nbsp;&nbsp;&nbsp; 0 &nbsp;00a5&nbsp;&nbsp;00a6&nbsp;&nbsp;-1&nbsp;&nbsp;&nbsp; // YEN SIGN, BROKEN BAR, &lt;none&gt;</FONT></P>
<P>and now we'll compile this keyboard file (change the directory if you installed MSKLC anywhere special):</P>
<P><FONT face="Consolas,Courier New" size=1><STRONG>"C:\Program Files\Microsoft Keyboard Layout Creator\bin\i386\kbdutool.exe" -u -v -w -x uscustom.klc</STRONG></FONT></P>
<P>It will create a uscustom.dll file which you can substitute in for the one MSKLC creates and puts in the uscustom\i386 directory. And you now have a keyboard that will make use of that key on the Japanese 106-key keyboard....</P>
<P>If you play around with the .KLC file later in MSKLC, the entry should remain intact; the only real limitation here is that&nbsp;you can't see the entry in the UI since there is no key there. Which is only the case because not even the Japanese keyboard handles it (this particular key's use is only mediated by the Japanese IME, currently!). Though I at one point suggested adding it to the US and other keyboards, I didn't get much support for it (sometimes I think I wouldn't have been able to get the VK_OEM_102 key added without a ton of proof that it was defined everywhere!).</P>
<P>Now things are a bit more complicated with keys that do not directly involve input, which is why I focused on this particular keyboard (and key). So try not to think of this post as opening up everything, okay?</P>
<P>In fact, there are many special issues involved with the numeric keypad and the cursor keys (and the additional shift state keys) that are involved here which make this more complicated (so I will talk about them another day, probably).</P>
<P>But you can think of yourself as being on the road now for pimping your keyboard beyond what MSKLC does....</P>
<P>Enjoy!</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>Â¥</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/00a5">U+00a5</A>, a.k.a. YEN SIGN)</EM></FONT></P></FONT>
<hr/><p><strong>Mihai</strong> on 26 Sep 2006 2:35 PM:</p><div style="margin-left: 1em">&lt;&lt;Yen key (left to delete key) &gt;&gt;<br><br>&quot;Yen key (left to backspace key)&quot;</div>
<p><strong>Michael S. Kaplan</strong> on 26 Sep 2006 3:59 PM:</p><div style="margin-left: 1em">Well I wasn't going to change his text I was quoting! :-)</div>
<p><strong>Olivier</strong> on 27 Sep 2006 12:13 PM:</p><div style="margin-left: 1em">On the Apple Japanese keyboard, the key next to the Yen key is named &quot;delete&quot;, different than a Windows keyoard.<br><br>This link has an image of the JIIS keyboard: <a rel="nofollow" target="_new" href="http://developer.apple.com/technotes/tn/tn1152.html">http://developer.apple.com/technotes/tn/tn1152.html</a><br></div>
<p><strong>Michael S. Kaplan</strong> on 27 Sep 2006 1:07 PM:</p><div style="margin-left: 1em">The trick should work here anyway (if not then the key of that keyboard must be generating a different scan code, and you have to find out what scan code it generates).</div>
<p><strong>Emerson</strong> on 30 Sep 2006 3:03 PM:</p><div style="margin-left: 1em">Hey, it seems that has much to do with <A href="http://archives.miloush.net/michkap/archive/2006/08/30/726087.html"><STRONG>my problem</STRONG></A>. <BR>Basically, I want to add two scan codes to my layout: 73 (REVERSE SOLIDUS, LOW LINE) and 7d (YEN SIGN, VERTICAL LINE). I added 73 with VK_OEM_8 and it worked wonderfully. Now I need to add 7d with another VK, would you suggest one? <BR>Thanks in advance. <BR></div>
<p><strong>Michael S. Kaplan</strong> on 30 Sep 2006 3:50 PM:</p><div style="margin-left: 1em">Well, you can actually just look at the .KLC file created by MSKLC and then at winuser.h where the VKs are defined.... &nbsp;like maybe VK_OEM_AX or something similar? <br><br>Like I said, the key is just to make sure it is not already on the keyboard (either explicitly in the layout file or implicitly like the numpad keys).</div>
<p><strong>Emerson</strong> on 30 Sep 2006 8:22 PM:</p><div style="margin-left: 1em">Yeah, I got it, but I could not make it work the way I want.<br><br>Unfortunately I tried a lot of VKs (VK_OEM_AX, VK_JUNJA, VK_FINAL, VK_ACCEPT, VK_MODECHANGE, VK_NEXT, VK_F13, etc.) and none of them has worked.<br><br>It gives me an error with the following messages: <br><br>kbdname.c<br>kbdname.C(80) : error C2121: '#' : invalid character : possibly the result of a macro expansion<br>kbdname.C(80) : error C2121: '#' : invalid character : possibly the result of a macro expansion<br>kbdname.C(80) : error C2065: 'ERROR' : undeclared identifier<br>kbdname.C(80) : error C2099: initializer is not a constant<br>kbdname.C(275) : error C2014: preprocessor command must start as first nonwhite space<br>kbdname.C(275) : error C2078: too many initializers<br>kbdname.C(278) : error C2059: syntax error : ';'<br><br>CL.EXE returned 2<br><br>LINK : warning LNK4224: /DEBUG:FULL is no longer supported; ignored<br>LINK : warning LNK4224: /DEBUG:FULL is no longer supported; ignored<br>LINK : fatal error LNK1181: cannot open input file 'kbdname.obj'<br><br>LINK.EXE returned 1181<br><br><br>It's like VK_OEM_8 is the only one accepted. Or I am doing something wrong...<br><br>Actually, if I add only 73 with VK_OEM_8, 7d works even without being listed in the .KLC file:<br><br>39	SPACE		0	0020	0020	0020	-1	-1		// SPACE, SPACE, SPACE, &lt;none&gt;, &lt;none&gt;<br>73	OEM_8	0	005c	005f	-1	-1	-1		// REVERSE SOLIDUS, LOW LINE, &lt;none&gt;, &lt;none&gt;, &lt;none&gt;<br>53	DECIMAL	0	002c	002e	-1	-1	-1		// COMMA, FULL STOP, , , <br><br>But it prints \ instead of &#165;.<br><br>Anyway, I'm kind of satisfied with that... VK_OEM_8 made my day.<br><br>Thanks a lot.</div>
<p><strong>Emerson</strong> on 30 Sep 2006 8:44 PM:</p><div style="margin-left: 1em">Ooops... One correction: adding only 73 does not enable 7d.<br><br>I thought it did because just after I installed the layout with only 73, the yen key worked (printing a &quot;\&quot;), but I also noticed the dead keys were not working.<br><br>So I rebooted and the dead keys work now, but not the yen key. In other words, the layout works exactly the way it's supposed to: with 73 enabled (VK_OEM_8), but not 7d.<br><br>It seems it's impossible to find another &quot;free-to-use&quot; VK_ :(<br><br>Now I am sad again, heh. </div>
<p><strong>Emerson</strong> on 30 Sep 2006 9:06 PM:</p><div style="margin-left: 1em">Damn! Sorry for &quot;flooding&quot; your blog, Michael! (You can edit my comments to make them more &quot;pleasant&quot; to eyes.)<br><br>Forget what I said about the yen key working because I did not reboot. I had simply selected the wrong layout.<br><br>Other than that, things keep going the way I described (I need other &quot;free-to-use&quot; VKs).<br><br>That's it.<br><br>Many thanks.</div>
<p><strong>Michael S. Kaplan</strong> on 30 Sep 2006 11:20 PM:</p><div style="margin-left: 1em">Well, three posts do not make a flood, but it is getting closer.... :-)<br><br>I think I said you really can't grab VK values that have alternate functionality attached to them, like a lot of the ones you have tried. You need to try one (like OEM_AX?) that is not attached to other special behavior....</div>
<p><strong>Michael S. Kaplan</strong> on 1 Oct 2006 12:40 AM:</p><div style="margin-left: 1em">A couple of &quot;extra&quot; ones you could try are ABNT_C1 and ABNT_C2 (from kbd.h, where you can see VK_ABNT_C1 and VK_ABNT_C2 defined)....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/11/04 <a href="http://archives.miloush.net/michkap/archive/2011/11/04/10233999.html">The evolving Story of Locale Support, part 4 (working beyond one's bugs, and the case for an MSKLC update)</a></p><p>2010/06/08 <a href="http://archives.miloush.net/michkap/archive/2010/06/08/10017386.html">Hunting for VK_HANGUL, aka If you press a key that your code can't process, did you really press it?</a></p><p>2008/10/27 <a href="http://archives.miloush.net/michkap/archive/2008/10/27/9018025.html">Not only going BACK, but changing how to do it</a></p><p>2008/06/27 <a href="http://archives.miloush.net/michkap/archive/2008/06/27/8660309.html">Adding keys to your layout when you don't know what they are (aka Life with a 108-key keyboard layout)</a></p><p>2008/05/16 <a href="http://archives.miloush.net/michkap/archive/2008/05/16/8511203.html">My Spidey senses blame the rogue text editor</a></p><p>2007/07/04 <a href="http://archives.miloush.net/michkap/archive/2007/07/04/3690200.html">Pimping the numeric keypad</a></p><p>2006/10/07 <a href="http://archives.miloush.net/michkap/archive/2006/10/07/799605.html">Pimping your Brazilian keyboard</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/09/26/771713.html" title="Someone forgot the LCID? :-)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/09/25/771330.html" title="And then came Inuktitut (áááááá¦)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/26/771554.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>