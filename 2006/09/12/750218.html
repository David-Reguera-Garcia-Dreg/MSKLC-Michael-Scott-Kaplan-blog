<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/12/750218.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Converting, but not all at once?</title></head><body>
<h1>Converting, but not all at once?</h1>
<p><em>by Michael S. Kaplan, published on 2006/09/12 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/09/12/750218.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>So a few weeks ago Doug Cook asked: </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>I've been banging my head aganst this for a while now. Maybe you'll have a clue. <BR><BR>I have some text processing utilities that need to be able to read, parse, manipulate, and write text. Right now, they treat everything as ASCII. &nbsp;Strangely, that actually works ok for a large number of cases. We only run into trouble when the second byte of a multi-byte character is a byte that the parser recognizes, such as 0x0D, 0x0A, or (this one seems to be the most troublesome) 0x22. <BR><BR>In any case, I need to fix things. Most of this is (more or less) straightforward, but there is one thing I can't figure out. <BR><BR>Is there any Windows API that allows me to safely convert from one encoding to another without processing the entire file in one shot? <BR><BR>Some of these files can be fairly big. &nbsp;It would be great to be able to read them in small chunks. I want to read 4k of the file, convert that much input into UTF-16, process it, then repeat, preserving leftover state (lead bytes, combining characters) between calls. <BR><BR>In .NET, this just works. &nbsp;You don't have to worry about it at all. &nbsp;You just say "open a file in encoding X, then give me a line of UTF-16 text", and you get it. <BR><BR>In UNIX, you use iconv. &nbsp;It gets a bit more complicated because you have to manage your own buffers, but it works. &nbsp;iconv stops when either the source or the target buffer fills up, tells you how much of both source and target buffers it used or filled, and saves state between calls. <BR><BR>In Win32, I can't figure out any simple way to do this. &nbsp;The only applicable tools seem to be IsDBCSLeadByteEx, MultiByteToWideChar, and WideCharToMultiByte. Using these plus some hand-rolled UTF-8 support, I guess I could come close (make sure I only pass in complete characters to MultiByteToWideChar, and make sure I don't end on an incomplete surrogate pair in WideCharToMultiByte), but I would still potentially be screwing up things like combining characters and other random stuff that I probably don't understand very well. <BR><BR>Is there any way to use the Windows APIs to do this? (Preferably in a way that works on Win2k.) </P></FONT></BLOCKQUOTE>
<P>The truth is that Doug is right -- <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_17si.asp">MultiByteToWideChar</A> is particularly ill-suited to this type of scenario where the input might be streaming or somesuch. </P>
<P>Kind of a shame that the encoding functions are <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/03/06/386194.html">willing to use the target buffer</A></STRONG> even on error,&nbsp;yet it will not report how much was copied to the destination buffer or how much was copied&nbsp;from the source buffer, arguably two important things to know about when&nbsp;one does a partial conversion.</P>
<P>So it is smart enough to do the job, but not smart enough to tell you how far it got if it fails. :-(</P>
<P>Luckily, all hope is not lost. You can look to <A href="http://msdn.microsoft.com/workshop/misc/mlang/mlang.asp">MLang</A>, the MultiLanguage object, and&nbsp;in particular its <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangconvertcharset/doconversiontounicode.asp">IMLangConvertCharset::DoConversionToUnicode</A> method, which basically just calls the <A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/ifaces/imlangconvertcharset/doconversion.asp">IMLangConvertCharset::DoConversion</A> method. Its pcSrcSize will, on the return of the function, will contain the number of bytes that were converted in the source string, and its pcDstSize will contain the number&nbsp;of UTF-16 code points. Everything that one needs to get this job done! :-)</P>
<P>If you don't want to create COM objects, you can even use its exports that it provides (<A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/functions/convertinetmultibytetounicode.asp">ConvertINetMultiByteToUnicode</A>&nbsp;and &nbsp;<A href="http://msdn.microsoft.com/workshop/misc/mlang/reference/functions/convertinetunicodetomultibyte.asp">ConvertINetUnicodeToMultiByte</A>) to get the&nbsp;same sort of thing done....</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>ዬ</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/12ec">U+12ec</A>, a.k.a. ETHOPIC SYLLABLE YEE)</EM></FONT></P></FONT>
<hr/><p><strong>Richard Smith</strong> on 12 Sep 2006 7:12 AM:</p><div style="margin-left: 1em">... or you could use iconv. It works under Win32...</div>
<p><strong>Nick Lamb</strong> on 12 Sep 2006 10:24 AM:</p><div style="margin-left: 1em">Judging from the documentation, or lack of it, for these MLang functions I wouldn't trust them as far as I could throw them.<br><br>Converting between encodings is hard, anyone who has thought about it enough to get it right would have a lot more to say than this†. If the input or output buffers are too short to make progress, what happens? Is that considered an error? What happens to invalid characters or non-roundtrip transformations ? Are such characters replaced (with what) ? Do they report an error? What is in the size variables when an error occurs? &nbsp;Can we rescue our conversion in this scenario ? If the encoding I want to use isn't included, how do I add it?<br><br>The GNU iconv documentation answers all these questions, the documentation for ConvertINetMultiByteToUnicode was written by someone who hasn't considered those questions and maybe that means the people who implemented these functions didn't either, in which case your data is not in safe hands. Run in the opposite direction as fast as you can.<br><br>Also this function is part of Internet Explorer, and we know from previous articles that Internet Explorer gives incorrect results when transcoding, up until at least IE 7. Unless bug compatibility with old versions of IE is important you don't want that.<br><br>† On the other hand MultiByteToWideChar is proof that you can say a lot on this subject and still not be getting it right.<br><br>Oh, and those would be UTF-16 code _units_ Michael, not code points.</div>
<p><strong>James Holderness</strong> on 13 Sep 2006 2:57 AM:</p><div style="margin-left: 1em">I've had the pleasure of using the ConvertINetXxxToXxx functions in a streaming situation and I can confirm that they don't work well at all. If the destination buffer isn't big enough, they will return an error and set the destination count to zero (which isn't at all useful). The only solution I could see was to keep repeating the function call with a smaller source length (my destination buffer was a fixed size) until it returned a success.<br><br>And that wasn't the only problem - there were other weird quirks too. Unless you're writing code that has to deal with dozens of different charsets you're probably better off avoiding the OS provided functions and writing your own.</div>
<p><strong>nik</strong> on 14 Nov 2006 12:15 PM:</p><div style="margin-left: 1em"><p>0x0D, 0x0A as the second byte in a code page?</p>
<p>Is int not so that all the C0 characters do not occurr in any trail byte?</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/12/10 <a href="http://archives.miloush.net/michkap/archive/2006/12/10/1252776.html">Don't want to convert all at once? Well, maybe you could just nibble?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/09/13/752086.html" title="MSKLC and Vista? MSKLC and 64-bit? Darn, we&#39;re 0 for 2....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/09/12/750155.html" title="They speak English in other places, too">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09-12">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/12/750218.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>