<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/10/748742.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Further proof that VkKeyScanEx sucks</title></head><body>
<h1>Further proof that VkKeyScanEx sucks</h1>
<p><em>by Michael S. Kaplan, published on 2006/09/10 13:00 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/09/10/748742.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>The question that made its way to me through a bunch of others went something like this (product names removed for obvious reasons): </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>In ######, we use VkKeyScanEx() windows function which can take a Unicode character and return the keystrokes necessary to input that character (eg ctrl, alt, or shift) One of the options it returns is Hankaku key. In ###### we need to simulate all of the keystrokes, but the problem is that we currently ignore Hankaku key, which is the reason for a bug. I was wondering whether you know what is this Hankaku key and more specifically what is Hankaku’s vk keycode. <BR><BR>Thanx in advance,</P></FONT></BLOCKQUOTE>
<P>Regular readers here might recall both <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/07/18/439870.html">Use of VkKeyScanEx</A></STRONG> and <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/03/26/560595.html">What the %$#!* is wrong with VkKeyScan[Ex]?</A></STRONG>, and thus they may already know the general problem here, which is that both <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscan.asp">VkKeyScan</A> and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscanex.asp">VkKeyScanEx</A> suck. Hugely. </P>
<P>As the other posts have pointed out, they do not handle dead keys. Or ligatures. Or SCGAPS. Or additional shift states, either. These&nbsp;many facts make the functions useless for the majority of the keyboards that ship in the Windows box, all things told.</P>
<P>Beyond that, the details of this particular question are interesting because although IMEs (Input Method Editors) make use of keyboards, the methods by which they use them tend to make all of the various <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput.asp">keyboard input functions</A> less useful since both IMM and TSF based IMEs tend to interfere with the usual input flow from keyboards in ways that make all of the functions less useful overall when trying to get information, unless you work out exactly what is and is not going to work.</P>
<P>I inquired further about what was the character that they were passing to <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscanex.asp">VkKeyScanEx</A>, what was being returned, and the reply back was that they were passing <STRONG>ｶ</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/ff76">U+ff76</A>, a.k.a. HALFWIDTH KATAKANA LETTER KA) and (HKL)0x0411 for the HKL (the latter is technically not a valid HKL, but I will talk more about why this can be a problem another time).</P>
<P>The call was returning 0x0854 -- where the <STRONG>0x08</STRONG> portion would refer to the shift state (per the docs that would be the Hankaku state), and the <STRONG>0x54</STRONG> portion would refer to the virtual key (VK) value -- in this case VK_T.</P>
<P>Now if you look at the <A href="http://www.microsoft.com/globaldev/reference/keyboards.mspx">Japanese Keyboard Layout</A>, by default it shows <STRONG>か</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/304b">U+304b</A>, a.k.a.&nbsp;HIRAGANA LETTER KA) on that key:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/kbdJapan1.png"></P>
<P>So, since we wanted Katakana, we had better shift over to it with that key next to the space bar:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/kbdJapan1.5.png"></P>
<P>and then look again:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/kbdJapan2.png"></P>
<P>Hmmmm.... now we have <STRONG>カ</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/30ab">U+30ab</A>, a.k.a. KATAKANA LETTER KA). I guess we need&nbsp;to shift that too, with the character between the Kana key and the right Ctrl key:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/kbdJapan2.5.png"></P>
<P>and look one more time:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/kbdJapan3.png"></P>
<P>Ah, there it is! Good old&nbsp; <STRONG>ｶ</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/ff76">U+ff76</A>, a.k.a. HALFWIDTH KATAKANA LETTER KA).</P>
<P>Now we see the problem -- it actually requires two different keystroke changes in state, both of which act as toggle keys like CAPS LOCK rather than shifting keys like SHIFT/CTRL/ALT. And there is no specific way that either <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscan.asp">VkKeyScan</A> and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscanex.asp">VkKeyScanEx</A>&nbsp;has of handling both of them (though note the incorrect try based on putting the other shift state in to capture the two toggle states that kind of confuses the matter. Especially since like several other of the additional keys on the Japanese keyboard (like that extra one in the top row that has a <STRONG>¥</STRONG> in it) have no VK (virtual key) values defined and documented.</P>
<P>Which is the final nail on the coffin for using <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/vkkeyscanex.asp">VkKeyScanEx</A>&nbsp;to try get the right answer here....</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>ｶ</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/ff76">U+ff76</A>, a.k.a. HALFWIDTH KATAKANA LETTER KA)</EM></FONT></P></FONT>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/03 <a href="http://archives.miloush.net/michkap/archive/2008/09/03/8921419.html">Need to know the VK for A, ay?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/09/10/748775.html" title="Sometimes you *want* to interfere with the keyboard&#39;s state buffer">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/09/10/748699.html" title="How are the file names encoded?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/10/748742.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>