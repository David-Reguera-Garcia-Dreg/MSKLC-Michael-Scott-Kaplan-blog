<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/10/748775.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Sometimes you *want* to interfere with the keyboard's state buffer</title></head><body>
<h1>Sometimes you *want* to interfere with the keyboard's state buffer</h1>
<p><em>by Michael S. Kaplan, published on 2006/09/10 15:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/09/10/748775.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Sebastian asked me via the Contact link: </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>Hi Michael,<BR><BR>I have come across your (very intersting) blog while searching for information on the WM_DEADCHAR message.&nbsp; I am working on a relatively big/old application which receives deadkey messages but should really be treated as normal chars.&nbsp; The input context can sometimes be viewed as a single-key input model.&nbsp; In other words, the application catches all key strokes; sometimes the keys are hotkeys (e.g. when the user presses a key to start a command -- the key is associated to the command through a keybord map), sometimes keys come from edit text controls (e.g. when the user enters a string).&nbsp; When using an international keyboard (w/ dead keys), the user might press a diacritic key ('[' for instance, which would be the grave accent key), thinking it is a hotkey, but in fact, Windows is merely sending a WM_DEADCHAR message and sets the state so that the next WM_CHAR message will most likely be modified or the WM_CHAR message will be sent out twice if the user presses the '[' key again.<BR><BR>I would like to know if we can cancel the current deadkey state once we receive the WM_DEADCHAR message.&nbsp; I can always catch the deadchar message and treat it as a WM_CHAR message -- and ideally, I would like to receive the next (possibly a WM_CHAR) message as if no deadkey was pressed before, but Windows keeps an internal state which will still modify the next WM_CHAR I receive.<BR><BR>Is there anything I can do about this situation?&nbsp; Doing the work when I receive WM_KEYDOWN messages is probably my solution but I can't modify the mechanism currently in place, the application code is huge and fragile.<BR><BR>Thank you!</P></FONT></BLOCKQUOTE>
<P>Sebastian is correct that a buffer is kept when a dead key is entered that can impact the next keystroke. And he is also correct that the best place to handle this is in the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN notification</A> is sent.</P>
<P>But the problem is that there is a huge difference between that one and both the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_char.asp">WM_CHAR notification</A> and the <A href="https://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_deadchar.asp">WM_DEADCHAR notification</A>. Let's look at some of the subtle distinctions in the documentation of the various messages (we will focus on just four of them and stay away from the syschar type messages for the sake of simplicity):</P>
<P><STRONG><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN</A></STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>The WM_KEYDOWN message is posted to the window with the keyboard focus when a nonsystem key is pressed. A nonsystem key is a key that is pressed when the ALT key is not pressed.<BR><BR>Windows 2000/XP: Applications must pass wParam to TranslateMessage without altering it at all.</P></FONT></BLOCKQUOTE>
<P><STRONG><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keyup.asp">WM_KEYUP</A></STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>The WM_KEYUP message is posted to the window with the keyboard focus when a nonsystem key is released. A nonsystem key is a key that is pressed when the ALT key is not pressed, or a keyboard key that is pressed when a window has the keyboard focus. <BR><BR>Windows 2000/XP: Applications must pass wParam to TranslateMessage without altering it at all.</P></FONT></BLOCKQUOTE>
<P><STRONG><A href="https://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_char.asp">WM_CHAR</A></STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>The WM_CHAR message is posted to the window with the keyboard focus when a WM_KEYDOWN message is translated by the TranslateMessage function. The WM_CHAR message contains the character code of the key that was pressed.<BR><BR>Because there is not necessarily a one-to-one correspondence between keys pressed and character messages generated, the information in the high-order word of the lParam parameter is generally not useful to applications. The information in the high-order word applies only to the most recent WM_KEYDOWN message that precedes the posting of the WM_CHAR message.</P></FONT></BLOCKQUOTE>
<P><STRONG><A href="https://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_deadchar.asp">WM_DEADCHAR</A></STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>The WM_DEADCHAR message is posted to the window with the keyboard focus when a WM_KEYUP message is translated by the TranslateMessage function. WM_DEADCHAR specifies a character code generated by a dead key. A dead key is a key that generates a character, such as the umlaut (double-dot), that is combined with another character to form a composite character. For example, the umlaut-O character (Ã–) is generated by typing the dead key for the umlaut character, and then typing the O key.<BR><BR>The WM_DEADCHAR message typically is used by applications to give the user feedback about each key pressed. For example, an application can display the accent in the current character position without moving the caret.<BR><BR>Because there is not necessarily a one-to-one correspondence between keys pressed and character messages generated, the information in the high-order word of the lParam parameter is generally not useful to applications. The information in the high-order word applies only to the most recent WM_KEYDOWN message that precedes the posting of the WM_DEADCHAR message. </P></FONT></BLOCKQUOTE>
<P>By the time you get the WM_*CHAR message, there is not much that is documented that you can do with the current buffer related to the dead key; it is basically contaminated. You really do need to be looking at the messages from which <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/messagesandmessagequeues/messagesandmessagequeuesreference/messagesandmessagequeuesfunctions/translatemessage.asp">TranslateMessage</A> is called, not the ones that are generated by <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/messagesandmessagequeues/messagesandmessagequeuesreference/messagesandmessagequeuesfunctions/translatemessage.asp">TranslateMessage</A> itself.</P>
<P>Of course that can also be hard -- look at how the need to check both <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN</A> and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keyup.asp">WM_KEYUP</A> would exist (ignore the weird mention of <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN</A> in the <A href="https://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_deadchar.asp">WM_DEADCHAR</A> docs; that looks like a bit of a copy/paste error).</P>
<P>So truly, an easier way to clear out that buffered information would be better, and not just for the application architecture concerns that Sebastian expressed. Truly!</P>
<P>Luckily, there is a way.</P>
<P>If you look in the blog archives back to January of 2005 and the post <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/01/19/355870.html">He's dead [keys], Jim</A></STRONG>, you'll see how Naushad was reporting an application bug where a WH_GETMESSAGE hook proc that used the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode function</A>&nbsp;was causing dead keys to stop working. </P>
<P>I explained how <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode</A>&nbsp;and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicodeex.asp">ToUnicodeEx</A> can clear that buffer, the one Naushad did not want to clear.</P>
<P>Well, it turns out that Sebastian <STRONG>wants</STRONG> to clear that buffer, doesn't he? :-)</P>
<P>In this particular case, a return value from <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode</A>&nbsp;of any positive value is all you need here (it does not matter whether it is 1 or 2, since you are throwing out the results anyway). The only thing to look out for is if the return value is -1 (which can happen in the case of chained dead keys, <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/04/22/581107.html">discussed previously</A></STRONG>). The key here is to keep trying to pass stuff to <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode</A> until -1 is not returned.</P>
<P>And then one&nbsp;reader's bug becomes another reader's feature! :-)</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>à´›</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0d1b">U+0d1b</A>, a.k.a. MALAYALAM LETTER CHA)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/04/16 <a href="http://archives.miloush.net/michkap/archive/2011/04/16/10154700.html">Chain Chain Chain, Chain of Dead Keys</a></p><p>2008/04/22 <a href="http://archives.miloush.net/michkap/archive/2008/04/22/8415843.html">Premature keystroke processing? Don't worry, it happens to everyone....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/09/10/748785.html" title="I want the lines to BREAK, dammit!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/09/10/748742.html" title="Further proof that VkKeyScanEx sucks">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-09-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/09/10/748775.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>