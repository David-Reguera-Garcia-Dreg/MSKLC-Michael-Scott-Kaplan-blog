<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/13/1275292.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Sometimes what a person really wants is a LACK of size</title></head><body>
<h1>Sometimes what a person really wants is a LACK of size</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/13 04:46 -08:00, original URI: http://blogs.msdn.com/michkap/archive/2006/12/13/1275292.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P>Over the time I have had this blog, I have often had occasion to <A class="" href="http://archives.miloush.net/michkap/search.aspx?q=%22shell+team%22&amp;p=1" mce_href="../../../../search.aspx?q=%22shell+team%22&amp;p=1"><STRONG>say nice things</STRONG></A> about work that the <A class="" href="http://shellrevealed.com/" mce_href="http://shellrevealed.com/">Shell team</A> does. One of the main reasons for this is a particular characteristic that its members tend to have,&nbsp; one where if there is not an easy way to do something, they don't just complain about the lack. They write the code to get the job done.</P>
<P>Now sometimes this doesn't work out as well, like in the tons of shlwapi functions that do string comparison, which just leads to confusion as to <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/15/439395.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/15/439395.html"><STRONG>which function to use</STRONG></A>. But that's not what am I going to talk about today; this is a "glass half full" post. :-)</P>
<P>For many years, the MAX_PATH constant of 260 characters has been getting to be&nbsp;progressively more annoying. As hard drives get bigger and therefore can contain more and more files, it has become easier and easier to run into real problems where you can create files in adirectory that can no longer be easily accessed due to&nbsp;a path that is to put it simply too freaking long (where <EM>too freaking long</EM> is defined as 260 characters!).</P>
<P>This is a problem that can get bad faster in international environments due to path names being even longer in languages that tend to have longer words. But in truth no one is immune to the problem.</P>
<P>Historically, no one has been willing to do anything about it since obviously solving the problem in one component can simply expose it in another, and in the end no one actually gets a fix to the problem. The sheer scope of it keeps people away.</P>
<P>Anyway, in Vista the Shell team decided to try to do something about it.</P>
<P>Now first they have some obvious fixes, like using shorter special directory names. I mean <STRONG>\Documents and Settings</STRONG> becoming <STRONG>\Users</STRONG> and getting rid of the zillion <STRONG>My</STRONG> prefixes snd so on was a positive step. A small one, but how many times has the problem been trying to access paths starting with <STRONG>\Documents and Settings\All Users\Application Data\Microsoft</STRONG> when <STRONG>\Users\All Users\Microsoft</STRONG> would have done?</P>
<P>Ok, that is nice but really that is just them trying to fix&nbsp;a problem that they did most of the work in initially causing. So kudos for the reversal, but why was I claiming this was going to be a "glass half full" post?</P>
<P>Well, it is actually one of the efforts that took place in Vista, a feature whose official name I am not entirely sure about but which can be best described as "auto path shrinking."</P>
<P>The idea is simple enough -- when a path turns out to be too long, start shrinking individual elements in the path one by one until it is short enough to fix within MAX_PATH. </P>
<P>Now this is obviously cooler and much more usable than a call to <A class="" href="http://msdn2.microsoft.com/en-gb/library/aa364989.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/aa364989.aspx">GetShortPathName</A>, which will just shrink the whole thing and make the filename less usable. By keeping as much of the path long as they can (especially the file name) that big problem with nested paths with too many long directories is easily solved (it does not take too many subdirectories with GUID names to hit a MAX_PATH problem!).</P>
<P>I have never seen anyone else suggest this as a possible mitigation for the whole class of MAX_PATH problems that it helps to solve, and it is work that they put into the bulk of the Shell functions dealing with paths. While obviously not solving every instance of the problem, it at&nbsp;least proves that there are ways to try to make things work.</P>
<P>Anyway, just thought I'd take a moment to say kudos to the <A class="" href="http://shellrevealed.com/" mce_href="http://shellrevealed.com/">Shell team</A> for being a group to actually take the first positive steps I have heard about in a long time to try to help out with the MAX_PATH problem. Thanks!</P>
<P>To take advantage of auto path shrinking, you do need to not turn off short name generation. So start spreading the word that <A class="" href="http://technet2.microsoft.com/WindowsServer/en/Library/61cd1970-5254-47c2-96d4-a66c780446381033.mspx" mce_href="http://technet2.microsoft.com/WindowsServer/en/Library/61cd1970-5254-47c2-96d4-a66c780446381033.mspx">NtfsDisable8dot3NameCreation</A> may not always be in the best interests of people, no matter what <A class="" href="http://www.microsoft.com/technet/security/topics/serversecurity/tcg/tcgch10n.mspx" mce_href="http://www.microsoft.com/technet/security/topics/serversecurity/tcg/tcgch10n.mspx">you</A> <A class="" href="http://blogs.msdn.com/oldnewthing/archive/2006/09/29/776926.aspx#779893" mce_href="http://blogs.msdn.com/oldnewthing/archive/2006/09/29/776926.aspx#779893">may</A> <A class="" href="http://blogs.msdn.com/adioltean/archive/2005/01/27/362105.aspx" mce_href="http://blogs.msdn.com/adioltean/archive/2005/01/27/362105.aspx">hear</A> <A class="" href="http://weblogs.asp.net/savanness/archive/2003/06/09/8445.aspx" mce_href="http://weblogs.asp.net/savanness/archive/2003/06/09/8445.aspx">elsewhere</A>. Just something to consider....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>à²­</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0cad" mce_href="http://www.fileformat.info/info/unicode/char/0cad">U+0cad</A>, a.k.a. KANNADA LETTER BHA)</EM></FONT></P>
<hr/><p><a id="1276542" href="#1276542">#</a> <strong>Erzengel</strong> on Wednesday, December 13, 2006 12:36 PM:</p><div style="margin-left: 1em"><p>I'm curious, why can't they just make the Windows API not assume the length of the (w)char buffer? Doesn't the string have to be null terminated anyway? What am I missing here that makes MAX_PATH remain?</p></div>
<p><a id="1278219" href="#1278219">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, December 13, 2006 5:29 PM:</p><div style="margin-left: 1em"><p>There are many applications (both from MS and from third parties) that can and in some cases will break if the limit were arbitrarily raised, duet o the longstanding asumption. It is not simply updating a constant; it is updating a piece of the industry....</p></div>
<p><a id="1278910" href="#1278910">#</a> <strong>Erzengel</strong> on Wednesday, December 13, 2006 7:29 PM:</p><div style="margin-left: 1em"><p>Sorry I wasn't clear, I understand why giving a filename to an application, like via WIN32_FIND_DATA, would need to still be MAX_PATH (unless you go through all the fuss of making a new structure and function calls for &quot;long&quot; filenames--is this what FINDEX_INFO_LEVELS is supposed to be for? (I only show one possible value)).</p>
<p>I was talking about when you pass a string to windows. The Docs for CreateFile, for example, state that the A version can have no more than MAX_PATH, and the W version can have up to 37 thousand if it starts with &quot;\\?\&quot;. Why does the API care?</p></div>
<p><a id="1280131" href="#1280131">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, December 13, 2006 9:19 PM:</p><div style="margin-left: 1em"><p>Well, in the case of CreateFileA, there is a static buffer of the size in question -- thus a MAX_PATH limitation. This is a common pattern in many functions in the Win32 API.</p></div>
<p><a id="1281657" href="#1281657">#</a> <strong>Erzengel</strong> on Thursday, December 14, 2006 1:13 AM:</p><div style="margin-left: 1em"><p>Then the question I have is: Why can't they make it dynamic? How would this impact applications? Isn't the static buffer on the DLL side, where it theoretically should be inaccessible by applications? Is it just because the A version is no longer &quot;supported&quot;?</p></div>
<p><a id="1282303" href="#1282303">#</a> <strong>Michael S. Kaplan</strong> on Thursday, December 14, 2006 2:47 AM:</p><div style="margin-left: 1em"><p>It is because we are talking about thousands of functions and an implied chain of behavior stretching over a decade, behavior that there is a dependency on.</p>
<p>And external code often has the same kind of dependency created as well.</p>
<p>Now this is just the tip of the iceberg, but there is no way that is has ever been considered to be a simple issue -- a global change along the lines you are thinking of here would take man years of effort and would essentially break a ton of applications and code, not to mention leading to countless security holes with people overrunning buffers that are suddenly made too small in every shipping version of Windows....</p></div>
<p><a id="1283348" href="#1283348">#</a> <strong>Q</strong> on Thursday, December 14, 2006 7:05 AM:</p><div style="margin-left: 1em"><p>Why 260? What a strange constant... You'd think 256 or 255 or 256+3=259 (&quot;C:\&quot;) or something like that would make more sense.</p></div>
<p><a id="1283537" href="#1283537">#</a> <strong>Michael S. Kaplan</strong> on Thursday, December 14, 2006 7:41 AM:</p><div style="margin-left: 1em"><p>You have to leave one for the NULL maybe? :-)</p>
<p>No idea why they chose 260, actually....</p></div>
<p><a id="1286372" href="#1286372">#</a> <strong>Mike Dimmick</strong> on Thursday, December 14, 2006 10:50 AM:</p><div style="margin-left: 1em"><p>I'm fairly sure there's a part of MSDN Library which mentions that it's 3 for the drive specification (e.g. &quot;C:\&quot;), 256 for the path, and 1 for the terminating NULL = 260 total.</p>
<p>A slight difference with the \\?\ syntax is that these can only be absolute paths, not relative ones. Regular paths (not starting with \\?\) are relative on desktop Windows; coming from Windows CE I'm used to a lack of support for relative paths (all paths are absolute on CE, so if you say CreateFile( L&quot;Blah.txt&quot; ) your file ends up in the root - there is no SetCurrentDirectory API).</p>
<p>Really \\?\ is just an escape to the Win32 API to tell it to pass the path unchanged to the underlying NT native API (e.g. NtCreateFile), rather than prepend the supplied path with the current directory (the native API only works with absolute paths, the current directory is a Win32 concept).</p>
<p>Clearly the absolute path to a file can already exceed MAX_PATH characters, because of these two features (you can pass a MAX_PATH relative filename to CreateFile when the current directory is not a root path). The question is how to work around the problem. It was done in the move from Win16 to Win32, but of course people had to recompile their programs for that, and the backcompat scheme of generating the 8.3 name was retained.</p></div>
<p><a id="1289947" href="#1289947">#</a> <strong>Rosyna</strong> on Thursday, December 14, 2006 8:16 PM:</p><div style="margin-left: 1em"><p>i've probably said this so many times that it's becoming old. Paths are evil and should be banished by law. If there were no paths, imagine how much simpler everything would be.</p></div>
<p><a id="1290135" href="#1290135">#</a> <strong>Michael S. Kaplan</strong> on Thursday, December 14, 2006 8:41 PM:</p><div style="margin-left: 1em"><p>Hmmm.... a little late for that? :-)</p></div>
<p><a id="1395817" href="#1395817">#</a> <strong>Jon</strong> on Monday, January 01, 2007 9:07 PM:</p><div style="margin-left: 1em"><p>I say break all those apps (how do we know it'll break a lot of apps, isn't that an assumption in itself?). Seriously. I'm so tired of this limitation, it's breaking stuff RIGHT NOW. It's really inexcusable. Plenty of other OSes do not have problems with this. Make a break for it!</p>
<p>Or at the very least introduce an undocumented option for experts!</p>
<p>Will we be sitting here in 5 years' time still agonizing about the 260 char path limit? 10 years? 20 years?</p>
<p>Gah.</p></div>
<p><a id="1396178" href="#1396178">#</a> <strong>Michael S. Kaplan</strong> on Monday, January 01, 2007 9:22 PM:</p><div style="margin-left: 1em"><p>Microsoft has AppCompat labs containing many thousands of apps written by Microsoft and other companies, so we do not ever have to guess that things might break in situation -- we know when they might do so.</p>
<p>If a new version &quot;fixed&quot; the limitation and those apps would fail or introduce security holes by overrunning buffers, it is pretty certain that Microsoft would be blamed for boith the breaks and the security holes. </p>
<p>Working and safe is a more palatable option for all concerned....</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/05/29 <a href="http://archives.miloush.net/michkap/archive/2008/05/29/8560847.html">Ask a simple question, and then duck!</a></p><p>2007/02/13 <a href="http://archives.miloush.net/michkap/archive/2007/02/13/1671523.html">An opportunity to start down the right [long ]path</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/14/1281344.html" title="In the new MSDN Magazine -- Unicode and Microsoft, and Vista">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/13/1274163.html" title="Converting doubles to Unicode strings">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-13">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/13/1275292.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>