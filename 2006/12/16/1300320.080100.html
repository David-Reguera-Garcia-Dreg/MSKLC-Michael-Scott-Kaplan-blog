<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/16/1300320.080100.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Thinking about MUI is making me bipolar</title></head><body>
<h1>Thinking about MUI is making me bipolar</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/16 08:01 +00:00, original URI: http://blogs.msdn.com/michkap/archive/2006/12/16/1300320.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostGoogleFeed -->
<p>Speaking of <a href="http://archives.miloush.net/michkap/archive/2006/12/12/1266500.html"><strong>Open it all up, get out of the way, and then what happens?</strong></a>.... </p>
<p>There are times while I am at work where I occasionally think about how my emotional state keeps going up and down like crazy. Like first I am really pleassed about something and the next moment I am filled with despair, And then back again. And again.</p>
<p>I wonder whether I might be bipolar.</p>
<p>And then I realize it is just that I am thinking about MUI (<a href="http://msdn2.microsoft.com/library/ms776201.aspx">Multilingual User Interface</a>), pronounced either EM-YOU-EYE or MOO-EE depending on a constellation of factors worthy of their own blog post!</p>
<p>I'll tell you about what I mean, about the bipolar thing (the pronunciation can be for another day).</p>
<p>As an example, just the other day:</p>
<p>I got depressed that MUI is LCID based rather than name based.</p>
<p>But then I got excited when I was pointed at all the new MUI API functions that are name based.</p>
<p>But then I got depressed when I thought about how <a href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureinfo.currentuiculture.aspx">CurrentUICulture</a> is thread based in .NET yet session-based in Windows.</p>
<p>But then I got excited when others suggested that although the defaults are session based that there are a whole bunch of thread-specific functions that are now a part of the MUI API.</p>
<p>But then I got depressed when I thought about how the list of available UI languages in Vista is limited to the ones that are installed on the machine.</p>
<p>But then I got excited when Mike (over in MUI test) explained to me that the thread-based functions do not have this limitation -- it only applies to the default for OS resource loading.</p>
<p>But then I got depressed when I realized that custom locales are probably not supported.</p>
<p>But then I got excited when Erik (the MUI dev manager) explained to me that one of the biggest reasons that the push to using names happened in the resource loader was to allow support for custom locales. So that this scenario should work.</p>
<p>So at this point I stoped and then I decided it was time to either </p>
<ul>
<li>get a Prozac prescription, or 
<li>stop alternating between discussing the issue and thinking about it, and just write some freaking code to try it out. </li></li></ul>
<p>Since I doubt mt neurologist would write the Rx, I opted for the second choice. :-)</p>
<p>There is way too much confusion both in the documents and among the various experts here. So let's see once and for all what works in Vista.</p>
<p>Off to the code....</p>
<p>First a moment about <a href="http://msdn2.microsoft.com/library/ms776237.aspx">SetThreadPreferredUILanguages</a>.</p>
<p>Now <a href="http://msdn2.microsoft.com/library/ms776237.aspx">SetThreadPreferredUILanguages</a> is a fascinating function. It wants a NULL delimited list of locale names, a list which can be of somewhat arbitrary length. It will basically scroll through the list and set a maximum of ten of them, based on the first ten valid ones it can find in the list. It will return TRUE if at least one was set, and it will give you no indication of what may have failed along the way (you have to call <a href="http://msdn2.microsoft.com/library/ms776211.aspx">GetThreadPreferredUILanguages</a> to find out what was actually set).</p>
<p>Is it just me or should <a href="http://msdn2.microsoft.com/library/ms776237.aspx">SetThreadPreferredUILanguages</a> have been named <strong>TryToSetThreadPreferredUILanguages</strong> or <strong>AttemptToSetThreadPreferredUILanguages</strong>? :-)</p>
<p>Oh well, at least I know the semantic going in.</p>
<p>That word <strong>valid</strong> sets off some alarm bells so I decide to make sure my sample uses the new in Vista <a href="http://msdn2.microsoft.com/en-us/library/ms776379.aspx">IsValidLocaleName</a> function so I can make sure I am using the NLS understanding of &quot;valid&quot; locales.</p>
<p>So I start writing some code that will use <a href="http://msdn2.microsoft.com/library/ms776211.aspx">GetThreadPreferredUILanguages</a> and <a href="http://msdn2.microsoft.com/library/ms776237.aspx">SetThreadPreferredUILanguages</a>. I decide to write it as managed code so I can be easily registering and unregistering custom cultures (which are also custom locales). That whole NULL delimited list will be a little weird but I'll work it out in the sample.</p>
<p>Here is the code I write, designed for the RTM version of Vista:</p>
<blockquote><b><font face="Consolas,Lucida Console,Courier New,Courier" size="1">
<p>using System;<br>using System.Text;<br>using System.Globalization;<br>using System.Runtime.InteropServices; <br><br>namespace Testing {<br><br>    class TestMUI {<br><font color="#00ff00">        // Some functions from winnls.h in the Vista Platform SDK<br></font>        [DllImport(&quot;kernel32.dll&quot;, CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall, SetLastError=true)]<br>        static extern bool IsValidLocaleName(string lpLocaleName); <br><br>        [DllImport(&quot;kernel32.dll&quot;, CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall, SetLastError=true)]<br>        static extern bool GetThreadPreferredUILanguages(<br>          uint dwFlags, ref int pulNumLanguages, [MarshalAs(UnmanagedType.LPWStr)] string pwszLanguagesBuffer, ref int pcchLanguagesBuffer); <br><br>        [DllImport(&quot;kernel32.dll&quot;, CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall, SetLastError=true)]<br>        static extern bool SetThreadPreferredUILanguages(uint dwFlags, string pwszLanguagesBuffer, ref int pulNumLanguages); <br><br><font color="#00ff00">        // Some constants and functions from winnls.h in the Vista Platform SDK<br></font>        private const uint MUI_LANGUAGE_ID = 0x4; // Use traditional language ID convention<br>        private const uint MUI_LANGUAGE_NAME = 0x8; // Use ISO language (culture) name convention<br>        private const uint MUI_MERGE_SYSTEM_FALLBACK = 0x10; // GetThreadPreferredUILanguages merges in parent and base languages<br>        private const uint MUI_MERGE_USER_FALLBACK = 0x20; // GetThreadPreferredUILanguages merges in user preferred languages<br>        private const uint MUI_THREAD_LANGUAGES = 0x40; // GetThreadPreferredUILanguages merges in thread preferred languages<br>        private const uint MUI_CONSOLE_FILTER = 0x100; // SetThreadPreferredUILanguages takes on console specific behavior<br>        private const uint MUI_COMPLEX_SCRIPT_FILTER = 0x200; // SetThreadPreferredUILanguages takes on complex script specific behavior<br>        private const uint MUI_RESET_FILTERS = 0x001; // Reset MUI_CONSOLE_FILTER and MUI_COMPLEX_SCRIPT_FILTER <br><br>        [STAThread] <br>        static void Main(string[] args) {<br>            CultureInfo ci = CultureInfo.CurrentCulture;<br><br>            <font color="#00ff00">// A name that will be sure to not conflict!</font> <br>            string stCulture = &quot;random-piece-of-crap-locale&quot;;<br><br>            <font color="#00ff00">// Create the replacement and fill it</font><br>            CultureAndRegionInfoBuilder carib = new CultureAndRegionInfoBuilder(stCulture, CultureAndRegionModifiers.None);<br>            carib.LoadDataFromCultureInfo(ci);<br>            carib.LoadDataFromRegionInfo(new RegionInfo(ci.Name)); <br><br>            <font color="#00ff00">// Make sure it is not valid, register it, then make sure it has become valid</font><br>            Console.WriteLine(&quot;Before register, is &#39;{0}&#39; valid? {1}\r\n&quot;, stCulture, IsValidLocaleName(stCulture)); <br>            carib.Register(); <br>            Console.WriteLine(&quot;After register, is &#39;{0}&#39; valid? {1}\r\n&quot;, stCulture, IsValidLocaleName(stCulture)); <br><br>            <font color="#00ff00">// Try to set a big weird list of langs and then see what was set</font><br>            SetLangs(stCulture); <br>            GetLangs(); <br><br>            <font color="#00ff00">// Unregister -- cleanup is important in samples</font><br>            CultureAndRegionInfoBuilder.Unregister(stCulture);<br>        } <br><br>        static void SetLangs(string stCulture) {<br>            int ulNumLanguages = 0; <br>            string[] rgst = new string[10];<br><br>            <font color="#00ff00">// Create a weird list full of valid culture names and invalid ones, with our special custom<br></font>            <font color="#00ff00">// locale in the middke between two that are definitely valid.<br></font>            rgst[0] = &quot;de-DE-crap\u0000&quot;<br>            rgst[1] = &quot;en-US-junk\u0000&quot;<br>            rgst[2] = &quot;fr-CA\u0000&quot;<br>            rgst[3] = stCulture + &#39;\u0000&#39;;<br>            rgst[4] = &quot;en-AU\u0000&quot;<br>            rgst[5] = &quot;this-is-an-arbitrary\u0000&quot;<br>            rgst[6] = &quot;strings-that-are\u0000&quot;<br>            rgst[7] = &quot;obviously-not-locales\u0000&quot;<br>            rgst[8] = &quot;randomly-interspersed\u0000&quot;<br>            rgst[9] = &quot;with-two-that-are\u0000&quot;<br>            ulNumLanguages = rgst.Length;<br>            Console.WriteLine(string.Concat(rgst) + &quot;\r\n&quot;);<br>            Console.WriteLine(&quot;Did setting up our big list work? {0}, {1} entries.\r\n&quot;, <br>              SetThreadPreferredUILanguages(MUI_LANGUAGE_NAME, string.Concat(rgst), ref ulNumLanguages), <br>              ulNumLanguages);<br>        }<br><br>        static void GetLangs() {<br>            int ulNumLanguages = 0;<br>            int cchLanguagesBuffer = 0; </p>
<p>            <font color="#00ff00">// First call with a NULL target to get the size of the list</font><br>            if(GetThreadPreferredUILanguages(MUI_LANGUAGE_NAME | MUI_THREAD_LANGUAGES, ref ulNumLanguages, null, ref cchLanguagesBuffer)) {<br>                if(ulNumLanguages == 0) {<br><font face="Consolas,Lucida Console,Courier New,Courier" size="1"></font>                    Console.WriteLine(&quot;No thread preferred UI languages.&quot;);<br>                } else {<br>                    <font color="#00ff00">// Success! Allocate a buffer filled with NULLs and have the MUI function fill it in</font><br>                    string st = new string(&#39;\u0000&#39;, cchLanguagesBuffer);<br>                    if(GetThreadPreferredUILanguages(MUI_LANGUAGE_NAME | MUI_THREAD_LANGUAGES, ref ulNumLanguages, st, ref cchLanguagesBuffer)) {<br>                        <font color="#00ff00">// Success again! Replace the embedded NULLs with CRLF and dump out the list.</font><br>                        st = st.Replace(&quot;\u0000&quot;, &quot;\u000d\u000a&quot;);<br>                        Console.WriteLine(st);<br>                    }<br>                }<br>            } <br>        } <br>    }<br>}</p></font></b></blockquote>
<p> Ok, looks like the code is all set.</p>
<p>The results, when this code is run, are quite depressing, though. :-(</p>
<p>It turns out that not only are all locales that are not valid according to <a href="http://msdn2.microsoft.com/en-us/library/ms776379.aspx">IsValidLocaleName</a> are also invalid to MUI; I kind of expected that, and it is not the most unreasonable restriction.</p>
<p>But it also turns out that the custom locale entitled &quot;random-piece-of-crap-locale&quot; that I created is also not valid. Because it turns out that in some low-level internal function, MUI is pivoting the potential locale name through an LCID value, and since most custom locales don&#39;t have unique LCID values, this small extra check is invalidating the custom locale for MUI.</p>
<p>This means of course that if one sets the user default locale to be a custom locale that you can use that locale for the UI language too; however, the notion of an application whose success or failure entirely depends on a specific user locale is a really, really bad idea. Like Unicode lame list bad.</p>
<p>It means that at least in Vista RTM, one cannot use custom locales in MUI for your unmanaged applications (it works just fine in the unmanaged world, even pre-Vista).</p>
<p>Now I have reported this to the folks on the MUI team and I am optimistic that this awful behavior will be addressed as soon as they can address it. This bug, which breaks not only NLS/MUI parity but also managed/unmanaged parity and the whole intent of a new set of functions in the MUI API.</p>
<p>You should feel free to weigh in with your opinion about this bug if you have an opinion; having the customer point of view never hurts in as triage meeting....</p>
<p>If they can get this one fixed, then MUI won't make me bipolar anymore! :-)</p>
<p> </p>
<p><font color="#ff00ff"><em>This post brought to you by</em> <font size="6">⌣</font> <em>(U+2323, a.k.a. SMILE)</em></font></p>
<hr/><div style="margin-left: 1em"><em>comments not archived</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/04/29 <a href="http://archives.miloush.net/michkap/archive/2010/04/29/10003565.html">New for Windows 7: The PROCESS to keep MUI from being THREADbare....</a></p><p>2010/02/09 <a href="http://archives.miloush.net/michkap/archive/2010/02/09/9959464.html">Doing your own LIPs is not as easy for Windows as for a lady</a></p><p>2010/01/16 <a href="http://archives.miloush.net/michkap/archive/2010/01/16/9949421.html">Culture: don't have none, won't be none!</a></p><p>2007/08/25 <a href="http://archives.miloush.net/michkap/archive/2007/08/25/4564548.html">MSKLC keyboard layout names in your own language</a></p><p>2007/08/14 <a href="http://archives.miloush.net/michkap/archive/2007/08/14/4384041.html">Do what Icon, not what I say, aka MUI is still making me bipolar</a></p><p>2007/06/23 <a href="http://archives.miloush.net/michkap/archive/2007/06/23/3474350.html">Marshaling your resistance</a></p><p>2007/03/13 <a href="http://archives.miloush.net/michkap/archive/2007/03/13/1850613.html">Track change (a.k.a. A new job that has a few things in common with the old one)</a></p><p>2007/01/31 <a href="http://archives.miloush.net/michkap/archive/2007/01/31/1566096.html">Info needed from developers and architects about what they are (or want to be) doing with MUI</a></p><p>2007/01/26 <a href="http://archives.miloush.net/michkap/archive/2007/01/26/1534613.html">If I were Australian I might say that Steve Jobs and the Klingon emporer were mates?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/16/1300320.html" title="Thinking about MUI is making me bipolar">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/15/1299969.html" title="Technical Lead&#39;s Personal Log: Stardate unknown">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/16/1300320.080100.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>