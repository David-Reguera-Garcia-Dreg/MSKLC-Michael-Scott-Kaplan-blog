<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/28/1372747.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Converting a project to Unicode: Part 1 (Business before pleasure)</title></head><body>
<h1>Converting a project to Unicode: Part 1 (Business before pleasure)</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/28 06:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/28/1372747.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous posts in this series (including today's!):</P>
<UL>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html">Part 0 (The introduction)</A></LI>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html">Part 1 (Business before pleasure)</A></LI></UL>
<P>Before we get to jump in and work on code, there are a few items to take care of.</P>
<P>Any time the idea of&nbsp;converting an existing project to Unicode comes up, one really has to stop and consider both the benefits and the drawbacks and decide whether it makes sense to do it.</P>
<P>In this case (with MSKLC), the current behavior of the product (in version 1.3) has you double click on an MSI and it will just install. Thus the&nbsp;new requirement that we add a bootstrap setup.exe actually leads to a regression in functionality since clicking on setup.exe if there is a character off of the default system code page in the path will lead to the reported error occurring:</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/cptu01.png"></P>
<P>Given our team's firm public stance on the importance of supporting Unicode, there are clear strategic&nbsp;disadvantages to not fixing the problem, which is the main reason that trying to look at whether there are specific mitigations like using short file names (which won't work on some systems anyway) may not be the best workaround.</P>
<P>But obviously not every software development team will have those same pressures so obviously considering mitigations to the problem (or just documenting the problem as a limitation) is always important to consider as an&nbsp;option. </P>
<P>In some cases, another team can have the same&nbsp;set (or at&nbsp;least a similar set) of pressures if they are trying to support a particular market which they&nbsp;would have to admit they cannot in specific cases support the language of that market.</P>
<P>As a tool that has both UI and engine elements, we will be dealing with many interesting scenarios here with setup.exe.</P>
<P>Now one obvious strategic reason to not support Unicode (or to not only support Unicode) would be if Win9x support is also important. </P>
<P>I'll talk more about the Win9x issues later in the series (as even now before I have started,&nbsp;<A class="" href="http://codeka.com/blogs/" mce_href="http://codeka.com/blogs/">Dean Harding</A> has <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html#1372028" mce_href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html#1372028">suggested</A> talking about MSLU integration).</P>
<P>But for now I'll stick to our current project (MSKLC 1.4), which creates keyboard keyboard layouts that can only be installed on NT-based platforms, thus meaning the only thing that Win9x support in SETUP.EXE gives as person is seeing the nice friendly error message telling the person who tried to install anyway to go get bent. So the preliminary triage assumption is that telling people who create a keyboard&nbsp;layout that&nbsp;allows&nbsp;users to type in&nbsp;a particular language that in some cases no character in the path can contain letters in that language is MUCH worse than not being able to tell people who can't follow directions (in&nbsp; friendly way)&nbsp;to go home until they learn how to follow them.</P>
<P>Each triage will be an individual thing, of course. In this case there are also other non-fatal but still glaring problems, such as dialogs put up by SETUP.EXE showing question marks in non-blocking ways such ass displaying the layout description.</P>
<P><EM>In fact, on a tangentially related note, is is actually support of Unicode strings in keyboard layout descriptions, company names, and copyright strings that led me to originally convert kdbtool.exe to kbdutool.exe on a morning several years ago in a the Unicode Technical&nbsp;Committee meeting where a discussion centering on WG-20 issues that&nbsp;was otherwise threatening to put me to sleep led me to wonder how long such a conversion might take (in fact, it took just over 90 minutes).</EM></P>
<P>I'll talk more about triage issues in later posts after the actual work has been done.</P>
<P>For now, I'll explain the basic decisions planned for the conversion itself. Starting off, I have&nbsp;six of them:</P>
<UL>
<LI><STRONG>First</STRONG> and foremost, I will not be turning an "A" binary into a "W" binary; the plan is to turn it into a "T" binary a-la TCHAR.H and so on. When I am done I want something that I could compile either way without requiring further code change, if for no other reason than if it did prove to be too difficult and the idea got postponed, I wouldn't have to throw away my changes. :-)</LI>
<LI><STRONG>Second</STRONG>, I am not going to try to add any other new features&nbsp;while I am in there&nbsp;-- that will be a separate effort done at another time, so I can be sure to isolate any bug I might introduce from bugs that a feature might introduce.</LI>
<LI><STRONG>Third</STRONG>, I am going to keep it compiling the same way it does now (running NMAKE in an SDK or VS command line), and not require anyone to build special project files (for the actual setup.ex that ships I will violate this principle to integrate it with the regular build process, but for the project I am working on for the series I will be doing no such thing).</LI>
<LI><STRONG>Fourth</STRONG>, I am not going to be afraid of errors, even if I am seeing hundreds or even thousands&nbsp;of them. Because I know in the end there will be none and&nbsp; the nature of this project is such that changes to a single commonly called function could add many on its own.</LI>
<LI><STRONG>Fifth</STRONG>, for most of the time I will be working on resolving those errors in reverse order, so that I can compile, work on the errors at the bottom of the list, and then compile again. </LI>
<LI><STRONG>Sixth</STRONG>, I'll be using an editor like VS that will let me load all files and more importantly do find/replace operations on all files while still letting me look at each one in case anything special has to be done.</LI></UL>
<P>Now, where to get the source from?</P>
<P>I got it from the <A class="" href="http://www.microsoft.com/downloads/details.aspx?familyid=484269E2-3B89-47E3-8EB7-1F2BE6D7123A&amp;displaylang=en" mce_href="http://www.microsoft.com/downloads/details.aspx?familyid=484269E2-3B89-47E3-8EB7-1F2BE6D7123A&amp;displaylang=en">Windows® Server 2003 R2 Platform SDK Full Download</A>, which I already had installed, and I found the source in the </P>
<P>C:\Program Files\Microsoft Platform SDK for Windows Server 2003 R2\<STRONG><FONT color=#ff0000>Samples\SysMgmt\Msi\setup.exe\</FONT></STRONG></P>
<P>directory. </P>
<P>I believe the part of the directory in&nbsp;<FONT color=#ff0000><STRONG>red</STRONG></FONT> should be in any Platform SDK download.</P>
<P>My current plan&nbsp;is to&nbsp;post the code (14 files including the readme) at the beginning of each post before I go to&nbsp;work on it, so that people following along can treat it like a crossword puzzle and check their answers the next day with a simple tool like WinDiff. The project will not successfully compile as a Unicode binary for most of these posts (I'll warn ahead of time&nbsp;whenever that is the case and tell you how many errors I am getting), so you can consider the fact that I am&nbsp;posting the code to be a good way to follow along without doing any actual work. :-)</P>
<P>Ok, enough blather, let's get to the fun part -- starting tomorrow we're going to be jumping in and handling the code....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>ଖ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0b16" mce_href="http://www.fileformat.info/info/unicode/char/0b16">U+0b16</A>, a.k.a. ORIYA LETTER KHA)</EM></FONT></P>
<hr/><p><a id="1375480" href="#1375480">#</a> <strong>Mike</strong> on 28 Dec 2006 1:11 PM:</p><div style="margin-left: 1em"><p>I used to make 'T' binaries also. &nbsp;But eventually came to the conclusion that all the extra macros just made the code ugly to no real purpose. &nbsp;It just doesn't make sense to have two versions of your app, one of which is crippled. &nbsp;Inevitably the Unicode version becomes dominant and all the special case hacks you end up having to convert back &amp; forth or not depending on what UNICODE is defined as break because they're not tested properly.</p>
<p>There are exceptions of course. &nbsp;If you're making a library intended for third-party use the effort might be worth it. &nbsp;Or if you need a single codebase that will compile on both Windows and Linux or something.</p></div>
<p><a id="1375776" href="#1375776">#</a> <strong>Michael S. Kaplan</strong> on 28 Dec 2006 2:41 PM:</p><div style="margin-left: 1em"><p>In this case I think it will work satisfactorily, and not be too cumbersome. But this issue will be discussed as we go along, since as you point out there are trade-offs here to consider....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/12/24 <a href="http://archives.miloush.net/michkap/archive/2007/12/24/6843995.html">VS just got served!, aka The ??? Shift, aka 'Converting a project to Unicode???' No, it's 'Converting a project??? ToUnicode!!!'</a></p><p>2007/01/05 <a href="http://archives.miloush.net/michkap/archive/2007/01/05/1413001.html">Converting a project to Unicode: Part 9 (The project's postpartum postmortem)</a></p><p>2007/01/04 <a href="http://archives.miloush.net/michkap/archive/2007/01/04/1409380.html">Converting a project to Unicode: Part 8 (Fitting MSLU into the mix)</a></p><p>2007/01/03 <a href="http://archives.miloush.net/michkap/archive/2007/01/03/1395788.html">Converting a Project to Unicode: Part 7 (What does it mean to fit things to a 'T', anyway?)</a></p><p>2007/01/02 <a href="http://archives.miloush.net/michkap/archive/2007/01/02/1395703.html">Converting a Project to Unicode: Part 6 (Upon the road not traveled)</a></p><p>2007/01/01 <a href="http://archives.miloush.net/michkap/archive/2007/01/01/1391798.html">Converting a Project to Unicode: Part 5 (Are we there yet? Well, not *just* yet)</a></p><p>2006/12/31 <a href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html">Converting a Project to Unicode: Part 4 (It's /Delightful, it's /Delicious, it's /DUnicode!)</a></p><p>2006/12/30 <a href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html">Converting a project to Unicode: Part 3 (Can I quote you on that?)</a></p><p>2006/12/29 <a href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html">Converting a project to Unicode: Part 2 ('Sorry, you're not my type.' 'Um, maybe I could change that?')</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html" title="Converting a project to Unicode: Part 2 (&#39;Sorry, you&#39;re not my type.&#39; &#39;Um, maybe I could change that?&#39;)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/28/1371979.html" title="Changing MUI settings from MUISETUP command line?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/28/1372747.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>