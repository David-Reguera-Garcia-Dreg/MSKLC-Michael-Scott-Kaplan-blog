<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/09/1246712.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On being consistently consistent, while still managing to be dead wrong</title></head><body>
<h1>On being consistently consistent, while still managing to be dead wrong</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/09, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/09/1246712.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNewMonth -->
<P><EM>(Apologies to Hughes Mearns for the poetic excerpt that is a revision to his work!)</EM></P>
<P>When I thought about the problem several years ago, at the point where I first became involved in the .NET Framework's <A href="http://msdn2.microsoft.com/en-us/library/system.globalization.compareinfo.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.globalization.compareinfo.aspx">System.Globalization.CompareInfo</A> class, the poem immediately came to mind. </P>
<P>And then when the problem came up again as Brian's intern Scott ran across some interesting asserts while testing various pieces of the .NET Framework, it came to mind again. It depends on assuming that <EM>char</EM> rhymes with <EM>bear</EM>, not <EM>bar</EM> or <EM>care</EM>,&nbsp;in its pronunciation:</P>
<BLOCKQUOTE>
<DD>Last night I saw upon the char 
<DD>A zero length string that wasn't there 
<DD>He wasn't there again, per IndexOf 
<DD>Oh, how I'd like to give him a great big shove...</DD></BLOCKQUOTE>
<P>So much for poetry. On to the actual work. :-)</P>
<P>The problem, simply stated, is that since the beginning of the .NET Framework, a decision was made that prepending every string is a string of zero length, so that if one calls <FONT face="Consolas,Lucida Console,Courier New,Courier"><STRONG>"Hello".IndexOf("")</STRONG></FONT> one would have a <STRONG>0</STRONG> returned rather than a <STRONG>-1</STRONG> (the latter would indicate the substring was not found).</P>
<P>This of course causes problems even here since actually using that index would not return a string of zero length, it would return an uppercase letter <STRONG>H</STRONG> but that is a minor problem compared to the one that was really baking my noodle (to borrow a Matrixism) -- the fact that this design principle was extended to a particularly obnoxious case -- <FONT face="Consolas,Lucida Console,Courier New,Courier"><STRONG>"".IndexOf("")</STRONG></FONT> was also usually returning <STRONG>0</STRONG>. Even though <FONT face="Consolas,Lucida Console,Courier New,Courier"><STRONG>""[0]</STRONG></FONT> would obviously throw an exception so the result could not actually be used!</P>
<P>Now I say usually because in truth the 1.0 and 1.1 versions of the .NET Framework had a few inconsistencies where it would behave one way in some of these corner cases and a different way in some others. One of the goals that Yung-Shin (my manager) and I were working through for 2.0 was some consistency, especially as I was trying to port the <A href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.indexof.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.indexof.aspx">IndexOf</A>/<A href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.lastindexof.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.lastindexof.aspx">LastIndexOf</A>/<A href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.isprefix.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.isprefix.aspx">IsPrefix</A>/<A href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.issuffix.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/system.globalization.compareinfo.issuffix.aspx">IsSuffix</A> functionality to Vista's unmanaged <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A> function (first mentioned <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html"><STRONG>here</STRONG></A>), which we wanted to behave consistently with .NET since it was being added for the sake of .NET anyway.</P>
<P>So we divided the work up; while I was porting, Yung-Shin was fixing up all the inconsistencies and adding a ton of test cases to verify that things were finally behaving consistently (I ended up porting his tests, too). His initial intuition led him to the same conclusion that I reached above -- that <FONT face="Consolas,Lucida Console,Courier New,Courier"><STRONG>("".IndexOf("") == 0)</STRONG></FONT> doesn't make sense so it shouldn't be the way things are.</P>
<P>However, it soon became clear in a series of bugs, asserts, emails, and complaints that there was lots of existing code that depended on this weird logic that claimed that every string was assumed to be prepended by a string of zero length, even if the string in which one was searching was also of zero length. So the initial implementation in 2.0 had to be revised to consistently apply this (in my opinion, twisted) logic.</P>
<P>We both agreed that it made no sense, but given the importance of backcompat in the .NET Framework, the <A class="" href="http://archives.miloush.net/michkap/archive/2005/03/25/402444.html" mce_href="http://archives.miloush.net/michkap/archive/2005/03/25/402444.html"><STRONG>consistency vs. correctness battle</STRONG></A> was in this case finally arbitrated in favor of consistency with prior versions. In other words, breaking apps is worse than defying common sense....</P>
<P>So he and <A href="http://blogs.msdn.com/shawnste" mce_href="http://blogs.msdn.com/shawnste">Shawn</A> worked to make things consistent with the prior version logic, more consistently.</P>
<P>Now in my mind the consistency argument made no sense and I still thought it was incorrect, since it required the caller to do extra strange checks to avoid the weird corner case and possible exceptions being thrown. It would have made more sense to me to just fix the callers relying on the weird results. I hated the idea of polluting <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A> with such logic, even though I knew no doing so would really be against the reasons for having the function in the first place.....</P>
<P>But I consoled myself with the fact that in the case of <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A> there was a <FONT face="Consolas,Lucida Console,Courier New,Courier"><STRONG>pcchFound</STRONG></FONT> parameter that would let the caller know that what was found was <EM>also</EM> of zero length so that a sensible and consistent check on that return of <STRONG>0</STRONG> would keep one from an AV. With the bonus that being that the check made sense in the non-corner cases, too. And not just for the sake of consistency but for the sake of returning correct results.</P>
<P>Looking back to managed code, .NET doesn't have this feature, and there is in fact no easy way to emulate it in linguistically appropriate string comparisons; this was the reason that <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A> was added to Vista in the first place!</P>
<P>In fact, it was in the initial design planning for <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A>, back when we were calling it plain old FindString, that Tarek (another dev on our team who I have mentioned <A href="http://archives.miloush.net/michkap/archive/2006/09/01/735817.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/01/735817.html"><STRONG>before</STRONG></A>) pointed out that without the functionality that the pcchFound parameter provided, there was no good way to add replace logic via <A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx">FindNLSString</A>.</P>
<P><EM>(I find Tarek's cool contribution to </EM><A href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776359.aspx"><EM>FindNLSString</EM></A><EM> to be quite ironic given that he owns a lot of the .NET Framework side of things, and the .NET Framework does not yet have this functionality. It causes lots of weirdness that keeps the </EM><A href="http://msdn2.microsoft.com/en-us/library/system.string.replace.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.replace.aspx"><EM>System.String.Replace</EM></A><EM> method from working consistently with </EM><A href="http://msdn2.microsoft.com/en-us/library/system.string.compare.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.compare.aspx"><EM>System.String.Compare</EM></A><EM> in many cases!)</EM></P>
<P>But then again there are always future versions to do a more complete job here.... :-)</P>
<P>Ok, that's a long story about how easy it is to be consistently consistent and wrong at the same time, but there you have it. I'm wordy. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff0080><EM>This post brought to you by</EM> <FONT size=6>áŸ˜</FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/17d8" mce_href="http://www.fileformat.info/info/unicode/char/17d8">U+17d8</A>, a.k.a. KHMER SIGN BEYYAL)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>comments not archived</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/04/12 <a href="http://archives.miloush.net/michkap/archive/2007/04/12/2098486.html">Can you really say international support is irreplaceable?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/10/1252776.html" title="Don&#39;t want to convert all at once? Well, maybe you could just nibble?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/09/1245128.html" title="Update on the update to the update for Romanian and Bulgarian">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-09">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/09/1246712.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>