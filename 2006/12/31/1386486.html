<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/31/1386486.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Converting a Project to Unicode: Part 4 (It's /Delightful, it's /Delicious, it's /DUnicode!)</title></head><body>
<h1>Converting a Project to Unicode: Part 4 (It's /Delightful, it's /Delicious, it's /DUnicode!)</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/31 06:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/31/1386486.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous posts in this series (including today's!): 
<UL>
<LI><A href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html">Part 0 (The introduction)</A> 
<LI><A href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html">Part 1 (Business before pleasure)</A> 
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html">Part 2 ('Sorry, you're not my type.' 'Um,&nbsp;maybe&nbsp;I could change that?)</A> 
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html">Part 3 (Can I quote you on that?)</A></LI>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html">Part 4 (/Delightful, /Delicious, /DUnicode!)</A></LI></UL>
<P>(If you are&nbsp;just tuning&nbsp;in and want to start&nbsp;now you can grab the current source from <A class="" href="http://www.trigeminal.com/samples/SETUP_SOURCE/part04.zip" mce_href="http://www.trigeminal.com/samples/SETUP_SOURCE/part04.zip">here</A>.)&nbsp;</P>
<P>Ok, let's take the gloves off.</P>
<P>This project was not really build to be compiled&nbsp;as Unicode, so we have to do it the hard way.</P>
<P>Just&nbsp;clean up&nbsp;with the following line (if you have compiled already):</P>
<BLOCKQUOTE>
<P>nmake clean</P></BLOCKQUOTE>
<P>And then to do the Unicode compile, you can try:</P>
<BLOCKQUOTE>
<P mce_keep="true">nmake cflags="$(cflags) /DUNICODE /D_UNICODE"</P></BLOCKQUOTE>
<P mce_keep="true">(We&nbsp;won't keep doing this, for a whole bunch of reasons!)&nbsp;</P>
<P mce_keep="true">Now it&nbsp;is going to fail -- we still have some work to do, after all. The first error is easy enough:</P>
<P mce_keep="true"><IMG height=451 src="http://trigeminal.fmsinc.com/images/cptu06.png" width=1068></P>
<P mce_keep="true">Aha,&nbsp;let's look up strtoul and look for the TCHAR-version <A class="" href="http://msdn2.microsoft.com/library/5k9xb7x1(VS.80).aspx" mce_href="http://msdn2.microsoft.com/library/5k9xb7x1(VS.80).aspx">here</A>. Scroll down a bit, and Aha! We need that to be <A class="" href="http://msdn2.microsoft.com/library/5k9xb7x1(VS.80).aspx" mce_href="http://msdn2.microsoft.com/library/5k9xb7x1(VS.80).aspx">_tcstoul</A>, instead.</P>
<P mce_keep="true">And to make this&nbsp;all easier let's add&nbsp;this line&nbsp;to the makefile:</P>
<BLOCKQUOTE>
<P>cflags = $(cflags) /DUNICODE /D_UNICODE</P></BLOCKQUOTE>
<P mce_keep="true">rather than passing it on the command line (note that this is the usuasl way that Unicode versions of makefiles are done in MSDN samples, in sepasrate files entitled makefile.uni that include the old makefile!). Here goes:&nbsp;</P>
<P mce_keep="true"><IMG src="http://trigeminal.fmsinc.com/images/cptu07.png"></P>
<P mce_keep="true">Now you may have already fixed this yesterday when you noticed yourself fixing string constants that&nbsp; were being used with CharNextA. Well, we are not going to follow the advice here because using a reinterpret_cast, a C-style cast, and a function-style cast would all be inappropriate. Let's just change them all to <A class="" href="http://msdn2.microsoft.com/library/ms647469.aspx" mce_href="http://msdn2.microsoft.com/library/ms647469.aspx">CharNext</A> rather than CharNextW,&nbsp; so that we can compile either with Unicode or not and keep working.... then we'll run nmake again:</P>
<P mce_keep="true"><IMG src="http://trigeminal.fmsinc.com/images/cptu08.png"></P>
<P mce_keep="true">&nbsp;Ok, the first problem is easy, just turn CharPrevA into <A class="" href="http://msdn2.microsoft.com/library/ms647471.aspx" mce_href="http://msdn2.microsoft.com/library/ms647471.aspx">CharPrev</A>.</P>
<P mce_keep="true">The second problem requires a bi more thought, though. The code is&nbsp; in the LoadResourceString function in util.cpp, and the code loads up the resource as Unicode already (this is one of those spots in <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html">Part 1</A> that I suggested we think about later).</P>
<P mce_keep="true">In this case, we need to add some #ifdef UNICODE specific code, to make sure that under Unicode we copy the loaded string to the caller-supplied buffer under Unicode, and that we leave the code as it otherwise.&nbsp;The new function will be something&nbsp;like this (new code marked&nbsp;in red):</P>
<BLOCKQUOTE>
<P mce_keep="true">/////////////////////////////////////////////////////////////////////////////<BR>// LoadResourceString<BR>//<BR>UINT LoadResourceString(HINSTANCE hInst, LPCTSTR lpType, LPCTSTR lpName, LPTSTR lpBuf, DWORD *pdwBufSize)<BR>{<BR>&nbsp;&nbsp;&nbsp; HRSRC&nbsp;&nbsp; hRsrc&nbsp;&nbsp; = 0;<BR>&nbsp;&nbsp;&nbsp; HGLOBAL hGlobal = 0;<BR>&nbsp;&nbsp;&nbsp; WCHAR&nbsp;&nbsp; *pch&nbsp;&nbsp;&nbsp; = 0;<BR><BR>&nbsp;&nbsp;&nbsp; if ((hRsrc = WIN::FindResource(hInst, lpName, lpType)) != 0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;&amp; (hGlobal = WIN::LoadResource(hInst, hRsrc)) != 0)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // resource exists<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((pch = (WCHAR*)LockResource(hGlobal)) != 0)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned int cch<FONT color=#ff0000>;<BR>#ifdef UNICODE<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cch = lstrlen(pch);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(FAILED(StringCchCopy(lpBuf, *pdwBufSize, pch)))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pdwBufSize = cch;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ERROR_FUNCTION_FAILED;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>#else<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cch = WideCharToMultiByte(CP_ACP, 0, pch, -1, NULL, 0, NULL, NULL);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cch &gt; *pdwBufSize)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pdwBufSize = cch;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ERROR_MORE_DATA;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (0 == WideCharToMultiByte(CP_ACP, 0, pch, -1, lpBuf, *pdwBufSize, NULL, NULL))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ERROR_FUNCTION_FAILED;<BR><FONT color=#ff0000>#endif // UNICODE</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pdwBufSize = cch;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (1 &gt; *pdwBufSize)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pdwBufSize = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ERROR_MORE_DATA;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *pdwBufSize = 1;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *lpBuf = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DebugMsg(TEXT("[Resource] lpName = %s, lpBuf = %s\n"), lpName, lpBuf);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return ERROR_SUCCESS;<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp; // resource does not exist<BR>&nbsp;&nbsp;&nbsp; DebugMsg(TEXT("[Resource] lpName = %s NOT FOUND\n"), lpName);<BR><BR>&nbsp;&nbsp;&nbsp; return ERROR_RESOURCE_NAME_NOT_FOUND;<BR>}</P></BLOCKQUOTE>
<P mce_keep="true">Ok, let's try compiling again&nbsp;with this error fixed too. We'll try a clean compile and just see how far we get:</P>
<P mce_keep="true"><IMG height=547 src="http://trigeminal.fmsinc.com/images/cptu09.png" width=1068></P>
<P mce_keep="true">Ah, here is another such problem (these vertrust.cpp cases are the ones where there are WCHAR variables defined). In this case, there are two pairs of calls in vertrust.cpp,&nbsp;both in the&nbsp;IsPackageTrusted function. The function basically&nbsp; converts the szPackage and the szSetupExe to Unicode and then calls the IsFileTrusted function on each one.</P>
<P mce_keep="true">Of course the biggest problem is that (in my opinion)&nbsp;we really do not have the same situation as with the previous resource loading situation -- we should ideally just pass through the string as is and not allocate or copy anything. The minimal change function I came up with, you can take a look at tomorrow (or you can try out writing your own if you like!). I mainly tried to avoid the extra allocates and copies.</P>
<P mce_keep="true">Once this function is fixed up:</P>
<P mce_keep="true"><IMG height=499 src="http://trigeminal.fmsinc.com/images/cptu10.png" width=1068></P>
<P mce_keep="true">Success!</P>
<P mce_keep="true">Hey, does that mean we're done?</P>
<P mce_keep="true">Well, not quite. Anyone want to guess at what else we need to do before we can get into all the advanced stuff like MSLU integration and so on?</P>
<P mce_keep="true">Or does anyone want to try to figure out the best way to write that IsPackageTrusted?</P>
<P mce_keep="true">:-)</P>
<P mce_keep="true">These last&nbsp;two issues were mercifully few, and they point to the two types of issues that require special handling -- the times when Unicode was involved before the conversion, and what to do with them.</P>
<P mce_keep="true">(Coming up -- tomorrow will center on answering the "what's next" question a little bit, but&nbsp;mostly it will be about&nbsp;a&nbsp;discussion about the different experience you will have if you don't (didn't?)&nbsp;do the things I suggested in&nbsp;Parts <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html">2</A> and <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html">3</A> and instead skipped right to Part&nbsp;<A class="" href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html">4</A> -- because it leads to a very different conversion experience!)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>ఙ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0c19" mce_href="http://www.fileformat.info/info/unicode/char/0c19">U+0c19</A>, a.k.a. TELUGU LETTER NGA)</EM></FONT></P>
<hr/><p><a id="1389515" href="#1389515">#</a> <strong>Ben Bryant</strong> on 31 Dec 2006 9:51 AM:</p><div style="margin-left: 1em"><p>I was in the habit of only defining _UNICODE with the underscore in the project defines until I recently discovered that I needed to define UNICODE without the underscore for a project that included a file without MFC. Somewhere in one of the MFC Afx headers it defines UNICODE for you if you haven't already.</p></div>
<p><a id="1389854" href="#1389854">#</a> <strong>Michael S. Kaplan</strong> on 31 Dec 2006 12:15 PM:</p><div style="margin-left: 1em"><p>I didn't know that, though it makes sense -- MFC has to call the Win32 API in many cases, and the Unicode version expects to call the Unicode Win32 API....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/12/24 <a href="http://archives.miloush.net/michkap/archive/2007/12/24/6843995.html">VS just got served!, aka The ??? Shift, aka 'Converting a project to Unicode???' No, it's 'Converting a project??? ToUnicode!!!'</a></p><p>2007/01/05 <a href="http://archives.miloush.net/michkap/archive/2007/01/05/1413001.html">Converting a project to Unicode: Part 9 (The project's postpartum postmortem)</a></p><p>2007/01/04 <a href="http://archives.miloush.net/michkap/archive/2007/01/04/1409380.html">Converting a project to Unicode: Part 8 (Fitting MSLU into the mix)</a></p><p>2007/01/03 <a href="http://archives.miloush.net/michkap/archive/2007/01/03/1395788.html">Converting a Project to Unicode: Part 7 (What does it mean to fit things to a 'T', anyway?)</a></p><p>2007/01/02 <a href="http://archives.miloush.net/michkap/archive/2007/01/02/1395703.html">Converting a Project to Unicode: Part 6 (Upon the road not traveled)</a></p><p>2007/01/01 <a href="http://archives.miloush.net/michkap/archive/2007/01/01/1391798.html">Converting a Project to Unicode: Part 5 (Are we there yet? Well, not *just* yet)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/01/01/1388357.html" title="Report of an IME that splits and separates more Hangul by 9 am than most IMEs do all day">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/31/1383831.html" title="More on our non-Unicode heritage">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-31">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/31/1386486.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>