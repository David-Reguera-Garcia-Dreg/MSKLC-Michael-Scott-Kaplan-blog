<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/18/1314233.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Don't get into the zone too soon....</title></head><body>
<h1>Don't get into the zone too soon....</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/18 13:13 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/18/1314233.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Yesterday when I finally got a chance to look at mail I found the following in my inbox:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=1>
<P>Michael,<BR><BR>The following is from a post in the microsoft.public.vc.language managed newsgroup; I wasn't sure where else to put it. A person by the name of Jochen Kalmbach suggested I contact you.</P>
<BLOCKQUOTE>
<P>Just a few comments with regard to the new Microsoft design of how DST info is stored (for certain time zones), after applying the update KB928388 (<A href="http://www.microsoft.com/downloads/details.aspx?familyid=2D0ECBBC-FE8F-4BFC-8667-C1D46662B5B7&amp;displaylang=en">http://www.microsoft.com/downloads/details.aspx?familyid=2D0ECBBC-FE8F-4BFC-8667-C1D46662B5B7&amp;displaylang=en</A>).<BR><BR>For those who are not familiar with what the update KB928388 does, here is some info:<BR><A href="http://support.microsoft.com/default.aspx/kb/928388">http://support.microsoft.com/default.aspx/kb/928388</A>.<BR>http://www.microsoft.com/windows/timezone/dst2007.mspx<BR><BR>After applying the update the HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Time Zones registry info is updated but a new way of storing the DST (Daylight Saving Time) information has been implemented for time zones where the DST may change from one year to another (e.g. the DST is changing dramatically for 2007 in the US and all US timezones where DST is observed are affected). The new design is interesting. However, after applying the update GetTimeZoneInformation is now returning the DST values for 2007, even though the year is 2006 (tested Windows XP SP2). This affects UTC dates that fall within the four week period (represented by the change in DST between 2006 and 2007) for dates that are converted from that period from UTC to local time (or visa versa). Essentially, these dates are one hour off when converted using the TIME_ZONE_INFORMATION returned via the GetTimeZoneInformation API.<BR><BR>Questions:</P>
<OL>
<LI>I understand that Windows Vista has a new API named GetDynamicTimeZoneInformation, that is designed to return the new DST info implemented in KB928388. Will Windows Vista return the DST info for the actual current year using this API?</LI>
<LI>If we have to convert a UTC to local time for a year other than the current year (not considering the 2006/2007 bug after applying KB928388), it now makes sense that we should have at least two new APIs that allow you to pass in the "year" that we want the TIME_ZONE_INFORMATION (or DYNAMIC_TIME_ZONE_INFORMATION ) for. Example:<BR><BR>DWORD GetTimeZoneInformationEx(<BR>&nbsp; WORD wYear,<BR>&nbsp; LPTIME_ZONE_INFORMATION lpTimeZoneInformation );<BR><BR>DWORD WINAPI GetDynamicTimeZoneInformationEx(<BR>&nbsp; WORD wYear,<BR>&nbsp; PDYNAMIC_TIME_ZONE_INFORMATION pTimeZoneInformation );</LI></OL></BLOCKQUOTE>
<P>Thanks.</P></FONT></BLOCKQUOTE>
<P>Well, to start with this is just the kind of scenario that dynamic time zones in Vista are there to help out with!</P>
<P>The fact that there is no historical information stored in prior versions is just the way Windows was designed, so the reported problem&nbsp;(especially in prior versions like XP)&nbsp;is by design since attempting to get historical time zone information once the time zone information has changed is simply not possible.</P>
<P>But the design of dynamic time zones is such that the&nbsp;Vista versions of the&nbsp;existing&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms724421.aspx" mce_href="http://msdn2.microsoft.com/library/ms724421.aspx">GetTimeZoneInformation</A>/<A class="" href="http://msdn2.microsoft.com/library/ms724944.aspx" mce_href="http://msdn2.microsoft.com/library/ms724944.aspx">SetTimeZoneInformation</A> functions will continue to work as is, even though the results that <A class="" href="http://msdn2.microsoft.com/library/ms724421.aspx" mce_href="http://msdn2.microsoft.com/library/ms724421.aspx">GetTimeZoneInformation</A>&nbsp;will return can in fact change from year to year (and the registry will contain the changing information as described in the <A class="" href="http://msdn2.microsoft.com/library/ms724253.aspx" mce_href="http://msdn2.microsoft.com/library/ms724253.aspx">DYNAMIC_TIME_ZONE_INFORMATION</A> topic (the new struct is used by the <A class="" href="http://msdn2.microsoft.com/library/ms724318.aspx" mce_href="http://msdn2.microsoft.com/library/ms724318.aspx">GetDynamicTimeZoneInformation</A> and <A class="" href="http://msdn2.microsoft.com/library/ms724932.aspx" mce_href="http://msdn2.microsoft.com/library/ms724932.aspx">SetDynamicTimeZoneInformation</A> topics).</P>
<P>One could argue (as Michael has, above) that new functions are needed to get and perhaps even set the values for another year beyond the current one. Though I have trouble seeing the actual need, since in the current design we are instructed that the wYear member of both the StandardDate and DaylightDate <A class="" href="http://msdn2.microsoft.com/library/ms724950.aspx" mce_href="http://msdn2.microsoft.com/library/ms724950.aspx">SYSTEMTIME</A> stucts must always be 0. So why not make a future&nbsp;extension to the existing function(s) that allows one to set the wYear member appropriately if one wants the results of as specific year in&nbsp;a dynamic time zone?</P>
<P>This is not what happens here in Vista now but the updated semantic could be simple -- the whole structure has to be zeroed out, and if it is then the struct becomes an inout struct and the wYear member will then represent the year (according to the semantics of the <A class="" href="http://msdn2.microsoft.com/library/ms724950.aspx" mce_href="http://msdn2.microsoft.com/library/ms724950.aspx">SYSTEMTIME</A> struct, of course).</P>
<P>More importantly,&nbsp;perhaps in the future&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms725485.aspx" mce_href="http://msdn2.microsoft.com/library/ms725485.aspx">TzSpecificLocalTimeToSystemTime</A> and <A class="" href="http://msdn2.microsoft.com/library/ms724949.aspx" mce_href="http://msdn2.microsoft.com/library/ms724949.aspx">SystemTimeToTzSpecificLocalTime</A> could do something special here in the face of an actual date with a year in it, when running on Vista in a dynamic time zone?</P>
<P>And of course absent such functionality either in Vista or in an update one could still look in the registry, where this information has now been officially documented for the first time ever (not that people were scared off by the lack of documentation here in the past!). So even if none of the above works then one still has the tools in Vista to get the right answer.</P>
<P>The argument one could make in the meantime is that <STRONG>the update described in KB928388 should not be installed until one is ready and willing for the change to happen</STRONG>.</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>á§ </FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/19e0" mce_href="http://www.fileformat.info/info/unicode/char/19e0">U+19e0</A>, a.k.a. KHMER SYMBOL PATHAMASAT)</EM></FONT></P>
<hr/><p><a id="1318105" href="#1318105">#</a> <strong>Maurits [MSFT]</strong> on 18 Dec 2006 2:51 PM:</p><div style="margin-left: 1em"><p>The &quot;tz database&quot; has a list of historical time zone changes. &nbsp;Some of them are quite perverse...</p>
<p><a rel="nofollow" target="_new" href="http://www.twinsun.com/tz/tz-link.htm">http://www.twinsun.com/tz/tz-link.htm</a></p>
<p><a rel="nofollow" target="_new" href="http://webexhibits.org/daylightsaving/e.html">http://webexhibits.org/daylightsaving/e.html</a></p>
<p>Political leader: What time is it?</p>
<p>Scientist: What time do you want it to be?</p>
</div>
<p><a id="1318840" href="#1318840">#</a> <strong>Dean Harding</strong> on 18 Dec 2006 5:31 PM:</p><div style="margin-left: 1em"><p>Yeah, I use the tz database myself. It's quite a useful resource, but you've got to make sure you update the database every couple of months, because there are several updates a year (due to all the changes!)</p>
<p>I've been meaning to write a .NET wrapper around the tz database, but I've been too lazy :)</p>
</div>
<p><a id="1318931" href="#1318931">#</a> <strong>Kevin Dente</strong> on 18 Dec 2006 6:02 PM:</p><div style="margin-left: 1em"><p>&gt;not that people were scared off by the lack of documentation</p>
<p>&gt;here in the past!</p>
<p>Hmm, yes, it turns out one of our products falls into that category. We have code that reads the time zones from the registry, which breaks on Vista because the &quot;Index&quot; registry entry associated with each time zone no longer exists in Vista. Why the omission? Is there something about the new time zone model that makes the notion of a time zone index invalid?</p></div>
<p><a id="1417323" href="#1417323">#</a> <strong>Michael Cessna</strong> on 5 Jan 2007 1:09 PM:</p><div style="margin-left: 1em"><p>Thanks for the original response and other responses.</p>
<p>[History]</p>
<p>I've worked with UTC and time zone conversion for the last four years and am pretty intimate with the Microsoft APIs (limited though they are) for dealing with UTC as well as the registry time zone data. My education came from having to create a tool that converted local datetime values into UTC for multiple time zones within a database (both MSSQL and Oracle). That is, each table could contain datetime columns that represented local datetime values for multiple time zones...and each datetime value had to be converted to UTC based on the corresponding time zone (where a time zone was associated with a record via the user that created/modified the record). Needless to say, it was a fun (read lost lots of sleep) experience. :o)</p>
<p>[Challenges]</p>
<p>So I understand the challenges in implementing APIs that work correctly, especially the difficulty of being able to support the new Dynamic DST stuff in versions prior to Vista/Longhorn, which is pretty much impossible given the design. However, I would have hoped for much better support in Vista. Already we've seen problems with Microsoft products after applying the patch (Outlook is especially notable). While these problems don't necessarily break anything (other than throwing dates off for certain periods) they have caused plenty of frustration. There are other areas that return potentially invalid data as well, most notable is the CLR native implementation used for TimeZone.ToUniversalTime (see nativeGetDaylightChanges in the CLR). Essentially, anywhere where a Microsoft product enumerates the time zone data or uses the GetTimeZoneInformation API...is going to return incorrect data for certain dates (see Windows Sidebar [Gadget] (System.Time.timeZones), Microsoft.SharePoint.SPTimeZoneCollection, and others).</p>
<p>[Ideas]</p>
<p>Regarding your ideas with regard to StandardDate and DaylightDate (SYSTEMTIME), I don't think it will be found appropriate to use the Year value to pass in the year. Also, the TzSpecificLocalTimeToSystemTime and SystemTimeToTzSpecificLocalTime APIs should be OK...as long as the correct TIME_ZONE_INFORMATION data is passed in.</p>
<p>[Recommendations]</p>
<p>Provide APIs for fully enumerating time zones and converting dates correctly based on the new Dynamic DST values. This would benefit Microsoft products as well as third party applications.</p>
<p>Thanks.</p>
<p>Regards,</p>
<p>Michael Cessna</p></div>
<p><strong>old programmer</strong> on 9 Dec 2008 7:07 PM:</p><div style="margin-left: 1em"><p>I wrote a VBScript script for turning TZinfo files into INF files, one for each zone, but after reading these comments I find that not all the assumptions wheron the program was written are right, and then there is also the supposed problem that this design does not work in southern DST. Is that the reason for Namibian DST: runs from April through October with the DST offset 1h west, not east?</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/06/29 <a href="http://archives.miloush.net/michkap/archive/2008/06/29/8667900.html">Did someone break GetTimeZoneInformation in XP?</a></p><p>2007/01/29 <a href="http://archives.miloush.net/michkap/archive/2007/01/29/1551597.html">Think of Windows as a hedonist</a></p><p>2006/12/22 <a href="http://archives.miloush.net/michkap/archive/2006/12/22/1350684.html">Sometimes when sorting the index is the last thing you want to use</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/18/1314538.html" title="WinForms != WebForms">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/17/1313891.html" title="Technical Lead&#39;s Personal Log: Stardate {what time is it?}">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/18/1314233.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>