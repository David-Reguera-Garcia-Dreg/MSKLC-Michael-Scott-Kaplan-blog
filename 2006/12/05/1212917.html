<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/05/1212917.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Validation of Unicode text is growing up</title></head><body>
<h1>Validation of Unicode text is growing up</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/05 11:17 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/05/1212917.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face="Segoe UI,Tahoma">
<P>The other day, in response to my post <A class="" href="http://archives.miloush.net/michkap/archive/2006/09/10/748699.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/10/748699.html"><STRONG>How are the file names encoded?</STRONG></A>, Matt Selz <A class="" href="http://archives.miloush.net/michkap/archive/2006/09/10/748699.html#1176523" mce_href="http://archives.miloush.net/michkap/archive/2006/09/10/748699.html#1176523">commented</A>:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2><I>
<P>If NTFS allows any unsigned short, would it be more accurate to say that NTFS does not do any encoding? &nbsp;Should one instead say it is the Win32 subsystem which encodes and decodes characters as UTF-16, and then stores them in and reads them from the raw NTFS file name buffer?&nbsp;</P></I></FONT></BLOCKQUOTE>
<P>While this would technically be more accurate not just in this case, but in many others such as the definition of identifiers&nbsp;and&nbsp;the data store in .NET's&nbsp;<A class="" href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp" mce_href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp">System.String</A>, it obviously does not sound very good. So it is unlikely that all of those descriptions would change.</P>
<P>However, there are more and more processes thats work from a higher standard, as I have already <A class="" href="http://archives.miloush.net/michkap/archive/2006/11/12/1064717.html" mce_href="http://archives.miloush.net/michkap/archive/2006/11/12/1064717.html">mentioned</A>.</P>
<P>People sometimes find themselves running into problems with the stricter definitions, like in Michael A.'s case:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P><EM>Hi all <BR><BR>I have a customer who is trying to write data to an XML file by using the Dataset method WriteXml.<BR><BR>This throws an exception :<BR><BR></EM><FONT face="consolas,lucida console,courier new,courier" size=1><STRONG>Invalid high surrogate character (0xDCBA). A high surrogate character must have a value from range (0xD800 - 0xDBFF)<BR>&nbsp;&nbsp; at System.Xml.XmlTextEncoder.Write(String text)<BR>&nbsp;&nbsp; at System.Xml.XmlTextWriter.WriteString(String text)<BR>&nbsp;&nbsp; at System.Data.DataTextWriter.WriteString(String text)<BR>&nbsp;&nbsp; at System.Data.XmlDataTreeWriter.XmlDataRowWriter(DataRow row, String encodedTableName)<BR>&nbsp;&nbsp; at System.Data.XmlDataTreeWriter.Save(XmlWriter xw, Boolean writeSchema)<BR>&nbsp;&nbsp; at System.Data.DataSet.WriteXml(String fileName, XmlWriteMode mode)<BR>&nbsp;&nbsp; at LDAP_udtræk_V2.Logic.Export.ExportMain.exportToXMLFile(String path) in C:\Documents and Settings\...</STRONG></FONT><BR><BR><EM>To me this seems to be the correct behavior since if we translate the hex to decimal we get: <BR><BR></EM><FONT face="consolas,lucida console,courier new,courier"><FONT size=1><STRONG>&nbsp; Invalid high surrogate character ( 56506 ). A high surrogate character must have a value from range ( 55296 - 56319 )</STRONG><BR></FONT></FONT><BR><EM>which indeed shows that the value is out of range.<BR><BR>The data is... ...likely to be encrypted.<BR><BR>So, is there a possibility that the customer could get this error by accident because of the data for some reason contains values that are out of range<BR>because of the encryption or any other reason?<BR><BR>I’m not too good with how Unicode and surrogate pairs work, so that is why I’m here.<BR><BR>Any ideas appreciated.</EM></P></FONT></BLOCKQUOTE>
<P mce_keep="true">(Don't&nbsp;even get me&nbsp;started on the&nbsp;exception text&nbsp;that talks about a "surrogate character", please -- <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/02/06/525486.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/06/525486.html">been there</A></STRONG>, <A class="" href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html"><STRONG>done that</STRONG></A>, <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/07/31/445838.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/31/445838.html">seen the movie</A></STRONG>!)</P>
<P mce_keep="true">Clearly this is a case where some extra validation is going on in System.Xml, which is noticing that the less stringent <A class="" href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp" mce_href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp">System.String</A>&nbsp;which does not validate for "legal" Unicode has passed on something that it considers to be crap. Since it easy to imagine an encryption process creating data that is not a valid Unicode string by these additional rules....</P>
<P mce_keep="true">So while I doubt the old definitions would be dumbed down in the documentation, I expect more and more of the processes that involve issues like international standards will have stricter rules applied to them. Those people relying on the more forgiving implementation pieces like <A class="" href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp" mce_href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclasstopic.asp">System.String</A>&nbsp;should beware!</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT face=Tahoma><FONT color=#ff00ff><EM>This post brought to you by</EM> </FONT></FONT><EM><FONT face=Tahoma><FONT color=#ff00ff><A class="" href="http://www.fileformat.info/info/unicode/char/d8ff" mce_href="http://www.fileformat.info/info/unicode/char/d8ff">U+D8ff</A>, the&nbsp;last high&nbsp;surrogate code point -- <STRONG>not</STRONG> a surrogate character!<BR><FONT size=1>(This code point has come to terms with his lack of character-ness, but has mentioned that the fact that no one else has may put him into therapy)</FONT></FONT></FONT></EM></P></FONT>
<hr/><p><a id="1214223" href="#1214223">#</a> <strong>Adam</strong> on 5 Dec 2006 4:47 PM:</p><div style="margin-left: 1em"><p>&quot;Since it easy to imagine an encryption process creating data that is not a valid Unicode string...&quot;</p>
<p>Well, seeing as encryption algorithms tend to produce binary data, I'd have thought this was pretty obvious. Not only that, but not even all *valid* unicode strings are representable in XML. Any unicode string containing the characters U+0000 - U+0008, U+000b, U+000c or U+000e - U+0001f is not allowed in XML.</p></div>
<p><a id="1216432" href="#1216432">#</a> <strong>Maurits [MSFT]</strong> on 5 Dec 2006 7:02 PM:</p><div style="margin-left: 1em"><p>Base64 is a common way to make such strings fit in XML.</p>
</div>
<p><a id="1220183" href="#1220183">#</a> <strong>Adam</strong> on 6 Dec 2006 4:30 AM:</p><div style="margin-left: 1em"><p>Base-64? In UTF-16? You're only using 6 out of every 16 bits!!! For Moore's sake, *never* store binary data as base64'd utf-16!</p>
<p>At least *try* something along the lines of base32k:</p>
<p><a rel="nofollow" target="_new" href="http://lists.xml.org/archives/xml-dev/200307/msg00505.html">http://lists.xml.org/archives/xml-dev/200307/msg00505.html</a></p>
<p><a rel="nofollow" target="_new" href="http://lists.xml.org/archives/xml-dev/200307/msg00507.html">http://lists.xml.org/archives/xml-dev/200307/msg00507.html</a></p>
<p>It may not be a published standard of any kind, but it shouldn't be that hard to write a robust codec for it and release it under the BSD license (or similar) for whoever needs to interoperate with you.</p></div>
<p><a id="1224467" href="#1224467">#</a> <strong>Maurits [MSFT]</strong> on 6 Dec 2006 11:50 AM:</p><div style="margin-left: 1em"><p>&gt; You're only using 6 out of every 16 bits</p>
<p>It's still better than my other suggestion of</p>
<p>&lt;?xml ...?&gt;</p>
<p>&lt;binary_data&gt;</p>
<p> &nbsp; &nbsp;&lt;bit value=&quot;on&quot; /&gt;</p>
<p> &nbsp; &nbsp;&lt;bit value=&quot;off&quot; /&gt;</p>
<p> &nbsp; &nbsp;&lt;bit value=&quot;on&quot; /&gt;</p>
<p> &nbsp; &nbsp;&lt;bit value=&quot;on&quot; /&gt;</p>
<p>&lt;/binary_data&gt;</p>
<p><a rel="nofollow" target="_new" href="http://channel9.msdn.com/ShowPost.aspx?PostID=105819">http://channel9.msdn.com/ShowPost.aspx?PostID=105819</a></p>
</div>
<p><a id="1224509" href="#1224509">#</a> <strong>Adam</strong> on 6 Dec 2006 12:17 PM:</p><div style="margin-left: 1em"><p>*has heart attack*</p>
<p>ZOMG! That's stunningly beautiful in a mushroom-cloud kind of way! :)</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/04/09 <a href="http://archives.miloush.net/michkap/archive/2008/04/09/8367652.html">Fight the Future? (#11 of ??), aka Microsoft is giving this character nada weight but lotsa importance</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/06/1221890.html" title="What&#39;s wrong with what FxCop does for globalization, Part 0.5 (a segue)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/05/1210407.html" title="What&#39;s wrong with what FxCop does for globalization, Part 0">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/05/1212917.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>