<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/21/1331650.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It's not right when IsRightToLeft is wrong</title></head><body>
<h1>It's not right when IsRightToLeft is wrong</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/21 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/21/1331650.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Yesterday&nbsp;in the post <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/20/1328701.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/20/1328701.html"><STRONG>For the [locale] explorer in you....</STRONG></A>, I mentioned that there was a bug. Francois is actually the person who saw it, and he came and asked me about it....</P>
<P>The bug can be seen in the picture of the Uighur (PRC) culture (ug-CN):</P>
<P><IMG src="http://trigeminal.fmsinc.com/images/cultureexplorer09.png"></P>
<P>Can you see it?</P>
<P>The side effect of the bug is the way that the parentheses are screwed up in the Native Name at the top. But the actual bug is in the purple <STRONG>Text</STRONG> section, where it claims that <STRONG>Bidirectional</STRONG> is False for a fulture for which it shoulc clearly be True.</P>
<P>As you can tell by looking in the source for <A class="" href="http://www.gotdotnet.com/Community/UserSamples/Details.aspx?SampleGuid=B778FF2C-9142-4769-839A-094F51A6F9F4" mce_href="http://www.gotdotnet.com/Community/UserSamples/Details.aspx?SampleGuid=B778FF2C-9142-4769-839A-094F51A6F9F4">Culture Explorer 2.0</A>, Francois is simply using the <A class="" href="http://msdn2.microsoft.com/library/system.globalization.textinfo.isrighttoleft.aspx" mce_href="http://msdn2.microsoft.com/library/system.globalization.textinfo.isrighttoleft.aspx">TextInfo.IsRightToLeft property</A> both to fill in that purple item and to set the TextBox.RightToLeft property of the controls containing native text with lines like:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>NameNative.RightToLeft = ci.TextInfo.IsRightToLeft ?&nbsp;RightToLeft.Yes&nbsp;: RightToLeft.No;</STRONG></FONT></P></BLOCKQUOTE>
<P>So, there is a bug either in the Windows locale data for Uighur, or in the .NET Framework code that synthesizes a Windows Only culture from the Windows data.</P>
<P>My psychic powers suggested to me that the Windows data was correct, because although locale data can have mistakes on occasion,&nbsp;it is more likely that the specific locale data&nbsp;was reviewed&nbsp;than a generic process that may not have been tested across every possible culture since it shipped before Vista was widely available. It could have gone either way, I guess it was just a judgment thing.</P>
<P>To&nbsp;prove the acuity of my psychic powers, I suppose I could just ask you to run the <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html"><STRONG>How To [NOT] detect that a locale is bidi</STRONG></A>&nbsp;or even the <A class="" href="http://archives.miloush.net/michkap/archive/2006/07/12/663013.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/12/663013.html"><STRONG>How To detect that a locale is bidi</STRONG></A>&nbsp;code, or I could make you look at the binary FONTSIGNATURE for the locale, which in WCHAR values returned by <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A> looks like this:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>\x2000\x0000\x0000\x8000\x0008\x0000\x0000\x8800\x0000\x0000\x0000\x0000\x0000\x0000\x0000\x0000</STRONG></FONT>&nbsp;</P></BLOCKQUOTE>
<P>But for those who do not find such a view to be too comfortable and who wanted more than just a rerun of blog posts past, let's take the following managed code instead:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>using System;<BR>using System.Globalization;<BR><BR>namespace Testing {<BR>&nbsp; class LdmlDump {<BR>&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureInfo ci;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stCulture;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // First figure out the name<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(args.Length &gt; 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stCulture = args[0];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stCulture = CultureInfo.CurrentCulture.Name;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create the culture and say what it is<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci = new CultureInfo(stCulture, false);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("\r\nUsing the following culture: '{0}' ({1})\r\n", ci.DisplayName, ci.Name);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Create the replacement and fill it<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureAndRegionInfoBuilder carib = new CultureAndRegionInfoBuilder(stCulture, CultureAndRegionModifiers.Replacement);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.LoadDataFromCultureInfo(ci);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.LoadDataFromRegionInfo(new RegionInfo(stCulture));<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.Save(stCulture + ".ldml");<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR>}</STRONG></FONT></P></BLOCKQUOTE>
<P>Stick it in a file called DumpLdml.cs and compile it with the following from CMD:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>csc DumpLdml.cs /r:sysglobl.dll</STRONG></FONT></P></BLOCKQUOTE>
<P>Now you can run it on any culture on the machine. This code may come in handy in future posts, too. :-)</P>
<P>We'll try both ar-SA and ug-CN, with mn-Mong-CN for luck:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>E:\Users\michkap&gt;DumpLdml.exe ar-SA<BR><BR>Using the following culture: 'Arabic (Saudi Arabia)' (ar-SA)<BR><BR><BR>E:\Users\michkap&gt;DumpLdml.exe ug-CN<BR><BR>Using the following culture: 'Uighur (PRC)' (ug-CN)<BR><BR><BR>E:\Users\michkap&gt;DumpLdml.exe mn-Mong-CN<BR><BR>Using the following culture: 'Mongolian (Traditional Mongolian, PRC)' (mn-Mong-CN)</STRONG></FONT></P></BLOCKQUOTE>
<P>Now looking at the LDML for each, one finds some interesting info. Both ar-SA and ug-CN have the following in them for the font signature:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:fontSignature&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:unicodeRanges&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="13" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="63" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="67" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:layoutProgress type="horizontalRightToLeft" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:unicodeRanges&gt;</STRONG></FONT></P></BLOCKQUOTE>
<P>while mn-Mong-CN has:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:fontSignature&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:unicodeRanges&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="81" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:layoutProgress type="verticalBeforeHorizontal" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:unicodeRanges&gt;</STRONG></FONT></P></BLOCKQUOTE>
<P>The layoutProgress is referring to the bits I talked about previously in <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/03/542963.html"><STRONG>How To [NOT] detect that a locale is bidi</STRONG></A>&nbsp;-- the following bits in the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/unicode_63ub.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/unicode_63ub.asp">Unicode subset bitfields</A>:</P>
<P>
<TABLE class="" border=1>
<TBODY>
<TR vAlign=top>
<TD class=data width="13%" class="data">123</TD>
<TD class=data width="87%" class="data"><B>Windows 2000 or later:</B> Layout progress, horizontal from right to left</TD></TR>
<TR vAlign=top>
<TD class=data width="13%" class="data">124</TD>
<TD class=data width="87%" class="data"><B>Windows 2000 or later:</B> Layout progress, vertical before horizontal</TD></TR>
<TR vAlign=top>
<TD class=data width="13%" class="data">125</TD>
<TD class=data width="87%" class="data"><B>Windows 2000 or later:</B> Layout progress, vertical bottom to top</TD></TR></TBODY></TABLE>&nbsp;</P>
<P>You can kind of tell&nbsp;where&nbsp;the language in the LDML comes from, huh? :-)</P>
<P>Anyway, it is clear that ug-CN has these bits set correctly, so the bug has to be in the .NET Framework code that synthesizes the Windows Only culture not using this information. Perhaps understandable given how obscure it is though -- further proof that we need our own LCTYPE containing the information in a more easily digested form? :-)</P>
<P>By the way Francois, I verified that this bug has already been reported in the .NET Framework, so no need to bug a new bug in. Though you could bump the number of occurrences if you wanted to. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=5>ת</FONT> <EM>(</EM></FONT><A href="http://www.fileformat.info/info/unicode/char/05ea"><EM>U+05ea</EM></A><EM><FONT color=#ff1493>, a.k.a. HEBREW LETTER TAV)</FONT></EM></P>
<hr/><p><a id="1339557" href="#1339557">#</a> <strong>Andrew West</strong> on 21 Dec 2006 5:09 AM:</p><div style="margin-left: 1em"><P>I'm wondering what exactly verticalBeforeHorizontal used in mn-Mong-CN means, as the MSDN documentation at <A href="http://msdn2.microsoft.com/en-us/ms404373.aspx" target=_new rel=nofollow>http://msdn2.microsoft.com/en-us/ms404373.aspx</A> doesn't say anything about it. Chinese written vertically progresses top-to-botttom in columns running right-to-left, but Mongolian progresses top-to-botttom in columns running left-to-right. Which, if either, of these layouts does verticalBeforeHorizontal imply, and is it possible to distinguish the two vertical layouts ?</P></div>
<p><a id="1339618" href="#1339618">#</a> <strong>Michael S. Kaplan</strong> on 21 Dec 2006 5:34 AM:</p><div style="margin-left: 1em"><p>Look at <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/library/intl/unicode_63ub.asp">http://msdn.microsoft.com/library/intl/unicode_63ub.asp</a> for better info -- the text is exactly matching bit 124....</p>
<p>So it looks like it is claiming that the text preferentially flows vertically, in a left to right direction. Which is actually what you just said, right? :-)</p>
</div>
<p><a id="1340590" href="#1340590">#</a> <strong>Andrew West</strong> on 21 Dec 2006 10:07 AM:</p><div style="margin-left: 1em"><p>I still don't think that the documentation is very clear, but having now reread it for the third time my interpretation is that you can combine bits 123, 124 and 125 in order to specify almost any layout, so that for example if bits 123, 124 and 125 are all set then text should be laid out in vertical columns reading bottom-to-top with columns progressing right-to-left across the page (a possible Ogham layout); and with only bit 124 set then text should be laid out in vertical columns reading top-to-bottom with columns progressing left-to-right across the page (as for Mongolian and Phags-pa). Is that right?</p></div>
<p><a id="1340904" href="#1340904">#</a> <strong>Michael S. Kaplan</strong> on 21 Dec 2006 11:10 AM:</p><div style="margin-left: 1em"><p>Yes, that is correct. </p>
<p>Now I never claimed that it was exactly intuitive -- only that the text descriptions came directly from the fontsignature bits related to layout.... :-)</p>
</div>
<p><a id="1341202" href="#1341202">#</a> <strong>Andrew West</strong> on 21 Dec 2006 12:04 PM:</p><div style="margin-left: 1em"><p>OK, thanks. Just one more question. I know that the Unicode range bits are set in the OS/2 table of the font, but what about bits 123-125 -- are these also derived from the UnicodeRange field of the OS/2 table in the font?</p></div>
<p><strong>Tim Chen</strong> on 9 Jul 2008 8:38 PM:</p><div style="margin-left: 1em"><p>this is year 2008, and the problem still there.</p>
<p>and the culture ps-AF is suffering the same problem.</p>
<p>Guess it can be classified as a bug immortal now.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/16 <a href="http://archives.miloush.net/michkap/archive/2012/01/16/10256752.html">I'm reasonably certain that those who disagree with me here are wrong!</a></p><p>2006/12/24 <a href="http://archives.miloush.net/michkap/archive/2006/12/24/1359264.html">Running a bit short on space?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/21/1341248.html" title="It&#39;s not just ordinary script, dude -- it&#39; superscript!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/20/1332470.html" title="The message queue runneth over, and may not be in sync">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/21/1331650.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>