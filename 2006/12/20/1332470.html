<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/20/1332470.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The message queue runneth over, and may not be in sync</title></head><body>
<h1>The message queue runneth over, and may not be in sync</h1>
<p><em>by Michael S. Kaplan, published on 2006/12/20 15:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/12/20/1332470.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>So last night <A class="" href="http://blogs.msdn.com/aaron_margosis/" mce_href="http://blogs.msdn.com/aaron_margosis/">Aaron Margosis</A> (who you may recall I have mentioned before <A class="" href="http://archives.miloush.net/michkap/archive/2005/03/02/383595.html" mce_href="http://archives.miloush.net/michkap/archive/2005/03/02/383595.html"><STRONG>here</STRONG></A>) asked about a question over in <A class="" href="http://blogs.msdn.com/oldnewthing" mce_href="http://blogs.msdn.com/oldnewthing">Raymond Chen</A>'s suggestion box to both Raymond and I,&nbsp;and added a question of his own. Raymond was gracious enough to cede jurisidiction for both of them, and this whole interaction is responsible for the blog post you are now about to read!</P>
<P><EM>(By the way, a casual&nbsp;&nbsp;glance at the suggestion box finds countless questions related to international stuff, Unicode,and even MSLU so I probably ought to try and raid his cupboards again in the future!)</EM></P>
<P>The original question, by James (from almost a week ago) was:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">The following code implements a simple keylogger. It prints out everything that is typed on the system to stdout. However the seemingly useless line 'GetKeyState(0);' is required for it to work. If that is not there the information that GetKeyboardState returns is never updated (and so it loses track of caps lock, etc.). According to the documentation GetKeyboardState is only updated when you remove keyboard messages from your queue. It is supposed to be the same for GetKeyState, so how come calling that function causes the buffer to be updated? Is there some subtlety I have missed or is this an obscure bug?</FONT></EM><BR><BR><FONT face="courier new,courier"><STRONG>#include &lt;windows.h&gt;<BR>#include &lt;cstdio&gt;<BR><BR>LRESULT CALLBACK LowLevelKeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {<BR>&nbsp;&nbsp;&nbsp; if(nCode == HC_ACTION &amp;&amp; wParam == WM_KEYDOWN) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KBDLLHOOKSTRUCT* key = (KBDLLHOOKSTRUCT*)lParam;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetKeyState(0);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BYTE keyState[256];<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetKeyboardState(keyState);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WORD chars;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ToAscii(key-&gt;vkCode, key-&gt;scanCode, keyState, &amp;chars, 0)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if((char)chars == '\r') putchar('\n');<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else putchar(chars);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; return CallNextHookEx(NULL, nCode, wParam, lParam);<BR>}<BR><BR>int main(int argc, char** argv) {<BR>&nbsp;&nbsp;&nbsp; HHOOK hhk = SetWindowsHookEx(WH_KEYBOARD_LL, LowLevelKeyboardProc, GetModuleHandle(NULL), 0);<BR><BR>&nbsp;&nbsp;&nbsp; MSG msg;<BR><BR>&nbsp;&nbsp;&nbsp; while(GetMessage(&amp;msg, NULL, 0, 0) &gt; 0);<BR><BR>&nbsp;&nbsp;&nbsp; UnhookWindowsHookEx(hhk);<BR><BR>&nbsp;&nbsp;&nbsp; return 0;<BR>}</STRONG></FONT></P></BLOCKQUOTE>
<P>To find a more official answer than the results James was seeing, I went into the source and found a comment buried deep under that <A class="" href="http://msdn2.microsoft.com/library/ms646301.aspx" mce_href="http://msdn2.microsoft.com/library/ms646301.aspx">GetKeyState</A> call&nbsp;that I believe may date back to 1991:</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /*<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * If this thread needs a key state event, give one to it. There are<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * cases where any app may be looping looking at GetKeyState(), plus<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * calling PeekMessage(). Key state events don't get created unless<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * new hardware input comes along. If the app isn't receiving hardware<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * input, it won't get the new key state. So ResyncKeyState() will<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * ensure that if the app is looping on GetKeyState(), it'll get the<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; * right key state.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; */</STRONG></FONT></P></BLOCKQUOTE>
<P>Now obviously the code was thinking more along the lines of people making meaningful calls to specific VK values rather than just calling GetKeyState(0),&nbsp;but the code is signaling for updates to the key state to happen more often if <A class="" href="http://msdn2.microsoft.com/library/ms646301.aspx" mce_href="http://msdn2.microsoft.com/library/ms646301.aspx">GetKeyState</A> is being called, under the assumption that the casller may be looping through multiple VK values.</P>
<P>This extra bit of work does not happen when <A class="" href="http://msdn2.microsoft.com/library/ms646299.aspx" mce_href="http://msdn2.microsoft.com/library/ms646299.aspx">GetKeyboardState</A> is called, making that function significantly less useful than 256 individual calls to <A class="" href="http://msdn2.microsoft.com/library/ms646301.aspx" mce_href="http://msdn2.microsoft.com/library/ms646301.aspx">GetKeyState</A>&nbsp;(though just one call will make the subsequent call to <A class="" href="http://msdn2.microsoft.com/library/ms646299.aspx" mce_href="http://msdn2.microsoft.com/library/ms646299.aspx">GetKeyboardState</A>&nbsp;more useful!). So while both functions read from the thread message queue, how up to date the cached key state info is can vary between them....</P>
<P>I should probably talk about <A class="" href="http://msdn2.microsoft.com/library/ms644936.aspx" mce_href="http://msdn2.microsoft.com/library/ms644936.aspx">GetMessage</A> and <A class="" href="http://msdn2.microsoft.com/library/ms644943.aspx" mce_href="http://msdn2.microsoft.com/library/ms644943.aspx">PeekMessage</A> for a moment and how they fit in, especially getting to Aaron's question:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">Bottom line is that GetKeyboardState doesn’t seem to update very well – GetKeyState will force it to update. Documentation doesn’t seem to indicate why, or that it’s needed.&nbsp; Any idea what’s going on?<BR><BR>Also (my question) do either of these functions cause a message queue to come into being if the thread doesn’t already have one?</FONT></EM></P></BLOCKQUOTE>
<P>The answer to that first part is that it is not needed if one is grabbing messages out with <A class="" href="http://msdn2.microsoft.com/library/ms644943.aspx" mce_href="http://msdn2.microsoft.com/library/ms644943.aspx">PeekMessage</A> calls, but you can still fall out of sync&nbsp;depending on&nbsp;how messages are being processed if Windows thinks it casn avoid updatinmg the key state buffer, as it thinks it can in the simple app without the GetKeyState(0) calls.</P>
<P>For the second question, each thread that is receiving input will have a message queue to receive that input. Calling a function won't create such a queue where one didn't exist before (though you can probably imagine weirdness when you deal with out of thread calls marking messages as processed, which is generally why the system won't give you the messages and you need a low level hook to see them anyway!).</P>
<P>Now the&nbsp;original question would have probably felt more at home here if James&nbsp;had been calling <A class="" href="http://msdn2.microsoft.com/library/ms646320.aspx" mce_href="http://msdn2.microsoft.com/library/ms646320.aspx">ToUnicode</A> rather than <A class="" href="http://msdn2.microsoft.com/en-us/library/ms646316.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms646316.aspx">ToAscii</A>, but we won't quibble. It is at least about keyboards. :-)</P>
<P>I suppose if the docs were updated to indicate that calls to <A class="" href="http://msdn2.microsoft.com/library/ms646301.aspx" mce_href="http://msdn2.microsoft.com/library/ms646301.aspx">GetKeyState</A>&nbsp;will keep the&nbsp;key state buffer&nbsp;more up to date and in sync with the inpue message queue, it wouldn't be an entirely bad thing. Though in truth I think this is usually not noticed since the message processing is keeping up to date anyway; the times when it would make a difference are in the minority here....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>Q</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0051" mce_href="http://www.fileformat.info/info/unicode/char/0051">U+0051</A>, a.k.a. LATIN CAPITAL LETTER Q)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/12/21/1331650.html" title="It&#39;s not right when IsRightToLeft is wrong">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/12/20/1328701.html" title="For the [locale] explorer in you....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-12-20">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/12/20/1332470.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>