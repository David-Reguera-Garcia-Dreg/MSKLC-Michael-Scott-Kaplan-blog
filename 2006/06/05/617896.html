<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/05/617896.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Is SQL Server really supporting UTF-16?</title></head><body>
<h1>Is SQL Server really supporting UTF-16?</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/05 09:54 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/06/05/617896.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>DanS12345 asked via 'Suggest a topic' the following question:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>The documentation for SQL Server 2005 says that xml is stored in UTF-16 encoding. In fact the doc's make a point that xml is stored differently than NCHARs, which use UCS-2. This does not seem to be the case. I have done some experiments that seem to indicate that xml with characters that are not in the BMP are not proprerly handled. SQL Server seems to handle xml the same way it handles regular CHARs and NCHARS. Can you clarify what is going on? <BR><BR>Thanks, <BR>Dan <BR><BR>There are some xml tags in the following, I hope they make it through. <BR><BR>Here is an example using &amp;#x20000; a unicode character from plane 2. I've tried this with many different other non-BMP characters and also loading from a file with the character code in it instead of literal text with an entity and the results are the same. This uses XQuery to measure the length of the string inside the A tag. <BR><BR>DECLARE @xml xml <BR>SET @xml = '&lt;A&gt;&amp;#x20000;&lt;/A&gt;' <BR>SELECT @xml.query('string-length(.)') AS RETURNS <BR><BR>-------- <BR>RETURNS <BR>2 <BR><BR>i.e. .query sees &amp;#x20000; as 2 characters, not 1. This is how the SQL Server 2005 documents that NCHAR's, i.e. text stored as UCS-2, will behave in SQL Server. <BR><BR><BR>Just to confirm the treatment of UTF outside of SQL Server I used some other XML tools to see what results they produced. <BR><BR>The XQuery that measures string-length when run through Saxon sees only 1 character, as expected <BR><BR>Likewise if &lt;A&gt;&amp;#x20000;&lt;/A&gt; is run through the XSLT program shown below run by Microsoft MSXML (4 or 6), or Saxon 8 also see only 1 character as expected. <BR><BR>&lt;?xml version='1.0'?&gt; <BR>&lt;xsl:stylesheet version="1.0" <BR>xmlns:xsl="</FONT><A href='http://www.w3.org/1999/XSL/Transform">' target=_new rel=nofollow><FONT size=2>http://www.w3.org/1999/XSL/Transform"&gt;</FONT></A><FONT size=2> <BR>&lt;xsl:template match="http://blogs.msdn.com/A"&gt; <BR>&lt;xsl:value-of select="string-length(.)"/&gt; <BR>&lt;/xsl:template&gt; <BR>&lt;/xsl:stylesheet&gt; <BR><BR>However the same XSLT program run through .NET's System.Xml.Xslt (1.1 or 2.0) sees 2 characters, which seems incorrect. <BR><BR><BR>Here is another XQuery to extract the &amp;#x20000; character. This says that the &amp;#X20000 character is not allowed. <BR><BR>DECLARE @xml xml <BR>SET @xml = N'&lt;A&gt;&amp;#x20000;&lt;/A&gt;' <BR>SELECT @xml.query('&lt;A&gt;{substring(.,1,1)}&lt;/A&gt;') <BR><BR>-------- <BR>Msg 6309, Level 16, State 1, Line 3 <BR>XML well-formedness check: the data for node 'NoName' contains a character (0xD840) which is not allowed in XML. <BR><BR>Here is the same thing with a BMP character, which works as expected. <BR><BR>DECLARE @xml xml <BR>SET @xml = N'&lt;A&gt;A&lt;/A&gt;' <BR>SELECT @xml.query('&lt;A&gt;{substring(.,1,1)}&lt;/A&gt;') <BR><BR>---------- <BR><BR>&lt;A&gt;A&lt;/A&gt; <BR><BR><BR>And one more example doing a comparison. This comparison returns false, which isn't true. <BR><BR>DECLARE @xml xml <BR>SET @xml = N'&lt;A&gt;&amp;#x20000;&lt;/A&gt;' <BR>SELECT @xml.query('substring(.,1,1) eq "&amp;#x20000;"') <BR><BR>------- <BR>false <BR><BR>I can sort of understand this last example; it implies it is treating the parameter of the .query function as an ordinary string rather than xml. But that would not be a correct way to handle this. <BR><BR>So what's going on here, is SQL Server really using UTF-16 for xml or is it just storing xml as a plain ol' NCHAR, or is there some other fine details about managing UTF that is not obvious. </FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>There is a bit of confusion here --&nbsp;though not on Dan's part. It is on the part of a large and complex project (SQL Server) that has some components with full support of UTF-16 and some with no support of UTF-16, and most of them in between those two extremes.</FONT></P>
<P><FONT face=Tahoma>I'll try and separate some of this out now. :-)</FONT></P>
<P><FONT face=Tahoma>A claim of UTF-16 support is not the same thing as a claim of NCR support of supplementary characters.</FONT></P>
<P><FONT face=Tahoma>What it means is that U+20000, if stored in UTF-16 (which means underneath it will be U+d840 U+dc00), can be stored. There is no implied promise that it will parse the string to convert NCRs into characters just because they are being stored (in&nbsp; truth it will sometimes be parsed and sometimes not depending on the component).</FONT></P>
<P><FONT face=Tahoma>The reason NCRs exist in both HTML and XML is to allow either the parsing or the storage of text outside of the encoding being used -- in this case to store UTF-32 inside of text that is not encoded in UTF-32.</FONT></P>
<P><FONT face=Tahoma>On the other hand, look at the error message that came back in one of those cases:</FONT></P>
<P><FONT face="Times New Roman" size=2>Msg 6309, Level 16, State 1, Line 3 <BR>XML well-formedness check: the data for node 'NoName' contains a character (0xD840) which is not allowed in XML. </FONT></P>
<P><FONT face=Tahoma>which of course makes it clear that in some cases it does indeed do the parsing of NCRs.</FONT></P>
<P><FONT face=Tahoma>I believe the trouble here is that often&nbsp;XML in SQL Server is&nbsp;processed&nbsp;as UTF-8 rather than UTF-16, and it is illegal to use surrogate code units inside of UTF-8. However, since you put it in as UTF-16 text (albeit with a UTF-32 NCR) you managed to find a bug -- a point where it converted the NCR to UTF-16 but then converted it all to UTF-8 as is.</FONT></P>
<P><FONT face=Tahoma>I probably would not have made the claim in the first place that SQL Server 2000 or SQL Server 2005 supported much beyond UCS-2, with some minor support hooks there for UTF-16 that happen due to certain components being a bit further along in their evolution</FONT></P>
<P><FONT face=Tahoma>The length issue is kind of the same -- the length of a string in NCHARs of a single supplementary character is expected to be <STRONG>2</STRONG>, not <STRONG>1</STRONG>. This is true whether SQL Server supported UTF-16 or not (posts like <A HREF="http://archives.miloush.net/michkap/archive/2005/04/07/406060.html"><STRONG>this one</STRONG></A> discuss the length issue in more detail).</FONT></P>
<P><FONT face=Tahoma>In the end, I would call SQL Server more "surrogate neutral" than "surrogate supporting". :-)</FONT></P>
<P><FONT face=Tahoma>Though this, so many years after the surrogate mechanism was first added to Unicode in version 2.1, is bad enough for me to mark this post on the "Unicode Lame List". It is time to get this fixed, I think....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>ㄛ</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/311b">U+311b</A>, BOPOMOFO LETTER O)<BR><FONT size=1>(A character listed in unihan as being derived from <A href="http://www.fileformat.info/info/unicode/char/20000">U+20000</A>, and there is some slight resemblence!)</FONT></EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/08 <a href="http://archives.miloush.net/michkap/archive/2008/09/08/8931641.html">UCS-2 to UTF-16, Part 1: Getting the obvious out of the way</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/06/618628.html" title="Is this the Über-font post? No, but it is the teaser for it!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/05/617447.html" title="More on case insensitivity and its intuitivality">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/05/617896.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>