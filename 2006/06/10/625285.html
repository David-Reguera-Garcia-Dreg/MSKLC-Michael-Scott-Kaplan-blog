<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/10/625285.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Is the SendKeys juice worth the squeeze?</title></head><body>
<h1>Is the SendKeys juice worth the squeeze?</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/10 05:35 -07:00, original URI: http://blogs.msdn.com/michkap/archive/2006/06/10/625285.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P><FONT face=Tahoma>There was a funny scene in <A href="http://imdb.com/title/tt0081573/">Superman II</A> where after a ton of oranges Lois Lane has just a tiny bit of actual Orange Juice. And that was even with someone like Superman wielding the juicer. The truth is that the juice is not always worth the squeeze....</FONT></P>
<P><FONT face=Tahoma>So, looking to SendKeys, the <A href="http://search.msdn.microsoft.com/search/Redirect.aspx?title=SendKeys+Statement&amp;url=http://msdn.microsoft.com/library/en-us/vbenlr98/html/vastmsendkeys.asp">SendKey statement</A> has been around in Visual Basic for a long time.</FONT></P>
<P><FONT face=Tahoma>It is at its core an attempt to get around all of the confusion of the difference between <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN</A> and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_char.asp">WM_CHAR</A>. It accomplishes this by shoving them all in one string that the caller passes in and then parsing out what it needs to.</FONT></P>
<P><FONT face=Tahoma>Most people still found it to be fairly confusing, for what it is worth. Some of the most complex problems come out of such attempts at simplification. :-)</FONT></P>
<P><FONT face=Tahoma>While people may primitively try to emulate this behavior by passing their own <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_char.asp">WM_CHAR</A> (or even <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp">WM_KEYDOWN</A>&nbsp;for the more sophisticated among the developer crowd), VB has long accomplished its task in a much more complicated way: via a <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/hookreference/hookfunctions/setwindowshookex.asp">SetWindowsHookEx function</A> call to create a WH_JOURNALPLAYBACK hook. The journal stuff is described simply:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE>
<P><STRONG>WH_JOURNALPLAYBACK</STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>Installs a hook procedure that posts messages previously recorded by a <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/abouthooks.asp">WH_JOURNALRECORD</A> hook procedure. For more information, see the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/hookreference/hookfunctions/journalplaybackproc.asp">JournalPlaybackProc</A> hook procedure. </P></BLOCKQUOTE>
<P><STRONG>WH_JOURNALRECORD</STRONG></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>Installs a hook procedure that records input messages posted to the system message queue. This hook is useful for recording macros. For more information, see the <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/hookreference/hookfunctions/journalrecordproc.asp">JournalRecordProc</A> hook procedure.</P></BLOCKQUOTE></BLOCKQUOTE>
<BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>.NET and its <A href="http://msdn2.microsoft.com/en-us/library/system.windows.forms.sendkeys(VS.80).aspx">SendKeys class</A> carry on that bold, low level&nbsp;tradition of using the journaling support.</FONT></P>
<P><FONT face=Tahoma>You can dig in further to understand more about it if you like, although to be honest it may not be worth the trouble. As many developers have found, the current incarnation in both VB and in .NET does really strange things in beta builds of IE7 (character duplication, etc.) and actual exceptions in beta builds of Vista due to some of the security changes in the OS.</FONT></P>
<P><FONT face=Tahoma>Of course, most developers only care about security when it affects them; otherwise most of them run as Administrators on their boxes and many of them are finding Vista to be a new experience since even administrators have to approve some of the changes they run (and developers get no free&nbsp;pass to run their code with impunity).</FONT></P>
<P><FONT face=Tahoma>SendKeys was in its own way doing the same sort of thing -- moving to some of the lowest levels to do its work. </FONT><FONT face=Tahoma>And because of that, it is now having problems.</FONT></P>
<P><FONT face=Tahoma>Of course people are looking at the problem now and working out the best way to solve the problem, though with a security decision to not allow less privileged windows to talk to windows with higher privileges, it is hard to imagine supporting the random VB application that assumes it can talk to any window it pleases.</FONT></P>
<P><FONT face=Tahoma>So there will have to be some changes for developers, no matter what problems are solved on the .NET or OS side.</FONT></P>
<P><FONT face=Tahoma>I would highly recommend staying away from SendKeys at this point. </P>
<P><FONT face=Tahoma>Now looking back, every step that SendKeys went through to get where it is was done for sensible reasons. But now, having reached this point it is reasonable to wonder whether the juice was, in fact, worth the squeeze.</FONT></P>
<P>In my opinion, it wasn't....</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>êÇì</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/10093">U+10093</A>, a.k.a. LINEAR B MONOGRAM B127 KAPO)</EM></FONT></P></FONT>
<hr/><p><a id="641697" href="#641697">#</a> <strong>Pasquale Esposito</strong> on Wednesday, June 21, 2006 12:27 PM:</p><div style="margin-left: 1em">My God! If I think of all the VB6 applications I have sold over the last few years which make large use of SendKeys... I can't believe I have to provide all my customers with un apdated version.<br><br>What's the point in neutralizing the SendKeys command when it is equally possible to get the same results resorting to WinAPI32?<br><br>What is even more crazy is that SendKeys seems not to work even under .NET 2.0. I really hate it when Microsoft is not compatible with Microsoft!<br><br>Let's hope this bug will be fixed when the final version of Windows Vista is released.</div>
<p><a id="642309" href="#642309">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, June 21, 2006 10:37 PM:</p><div style="margin-left: 1em">Hello Pasquale -- <br><br>Well, how many times have developers opened registry keys in their applications asking for all access because they did not realize that they may not have the permissions?<br><br>This is the moral equivalent of what happened with SendKeys and its dependence on journal hooks. I am pretty sure there is some thought beng put into how to fix this problem, though it would be a mistake to fix it on the Win32 side as opposed to the app that is making the mistake (in this case SendKeys), as it would be a mistake to allow people to have any sort of privilege elevation....</div>
<p><a id="643034" href="#643034">#</a> <strong>Pasquale Esposito</strong> on Thursday, June 22, 2006 1:11 PM:</p><div style="margin-left: 1em">I only used SendKeys to move the focus from a TextBox to the next one or to simulate the pressure of the F1 key in order to launch the help file. I'm afraid millions of VB6 programmers did the same.<br><br>Don't you think it could have been much wiser to neutralize SendKeys only in the case of an interaction with an external application? What should the millions of VB6 developers tell their customers now? &quot;Please, if you decide to upgrade to Vista, don't ever push the Help button or press Enter to move to the next TextBox, otherwise the program will crash!&quot;<br><br>And, besides, don't you think it is absurd (or even unprofessional) to support SendKeys in .NET 2.0 and make it incompatible with a concomitant operating system?<br><br>If you give me teeth, you should not take them away from me the next day.</div>
<p><a id="643097" href="#643097">#</a> <strong>Michael S. Kaplan</strong> on Thursday, June 22, 2006 2:17 PM:</p><div style="margin-left: 1em">Hello Pasquale -- <br><br>You are kind of making my case for me here. :-)<br><br>The SendKeys implementation is serious overkill for most of the scenarios where it is used. That is the whole point of the post!<br><br>There are people working to address the sceanrio, and while do not know about the plans or the timeline, I suspect that dealing with the overkill of the implementation might be high on the list....</div>
<p><a id="643176" href="#643176">#</a> <strong>Pasquale Esposito</strong> on Thursday, June 22, 2006 3:34 PM:</p><div style="margin-left: 1em">Thanks for your prompt reply and sorry for bothering you again.<br><br>The fact is that I just panicked when I heard that, under Windows Vista, all of my VB5/6 applications are going to crash, simply because in all of my applications I used the following cursed line of code:<br>----------<br>Private Sub cmdHelp_Click()<br> &nbsp; &nbsp;SendKeys &quot;{F1}&quot;<br>End Sub<br>----------<br>and this other one:<br>---------- <br>Private Sub txtSurname_KeyPress(KeyAscii As Integer)<br> &nbsp; &nbsp;If KeyAscii = 13 Then SendKeys &quot;{Tab}&quot; &nbsp; &nbsp;<br>End Sub<br>----------<br><br>Now, I think it is tremendously unfair to penalize all the developers who used SendKeys, simply because their only fault was to rely on code they MS provided VB6 natively with.<br><br>In theory, the solution to the problem exists (you have to replace SendKeys with an API function) but what is difficult to do is provide all of your customers with an updated version of the software they bought from you.<br><br>This is the reason why in my previous post I said that, in my opinion, MS should prevent SendKeys from causing an exception under Vista if it is only used inside the application in contexts like the ones I mentioned.<br><br>MS promised that, if a VB6 app works under XP, it will also work under Vista. Let's wait and see how reliable they are...</div>
<p><a id="659636" href="#659636">#</a> <strong>bwking</strong> on Friday, July 07, 2006 10:52 PM:</p><div style="margin-left: 1em">We have a number of VB6 apps that make heavy use if the SendKeys command. Do you think there may be a slight chance that MS might relax the restricition at all?<br>If the sendkeys is within the context of the app that called it, I don't see a reason why it should be denied.</div>
<p><a id="659641" href="#659641">#</a> <strong>Michael S. Kaplan</strong> on Friday, July 07, 2006 11:01 PM:</p><div style="margin-left: 1em">I think I explained why -- it is not that what you are wanting should require such permissions; it is that the way VB is doing it requires heavy permissions. They are not restricting their request on your behalf, and because of this, you need a lot more permissions than you think you ought to.<br><br>It is not your fault -- it is VB's. But even if they scale back how sendkeys works in .NET, whether or how they would alter VB6/VBA is an unknown to me, that offhand seems to me to be unlikely but do not know the exact plans here....</div>
<p><a id="659664" href="#659664">#</a> <strong>Michael S. Kaplan</strong> on Friday, July 07, 2006 11:55 PM:</p><div style="margin-left: 1em">To put it another way -- you need to borrow $5. Instead of using the form for $5 loans, the teller uses the form for $100,000 wire transfers that require approval from the manager, who by default says NO to these things.<br><br>The bug is that the teller used the wrong form for your $5 loan. The problem is that the teller is an automated response system written eight years ago that probably can't be updated to change the forms they fill out, to change this &quot;one size fits all&quot; strategy....</div>
<p><a id="660676" href="#660676">#</a> <strong>Pasquale Esposito</strong> on Sunday, July 09, 2006 1:16 PM:</p><div style="margin-left: 1em">Your explanation would be flawless if it were not for the fact that you can still write potentially malicious code resorting to the Windows API.<br><br>In other words, the measure taken by MS would make sense if it were impossible for a VB application to press/send keys programmatically, BUT IT IS STILL POSSIBLE using SendInput.<br><br>Here is a function that will allow you to work around the limitation under Windows Vista:<br><br>----------<br>Option Explicit<br><br>Private Const KEYEVENTF_KEYUP = &amp;H2<br>Private Const INPUT_KEYBOARD = 1<br><br>Private Type KEYBDINPUT<br>wVk As Integer<br>wScan As Integer<br>dwFlags As Long<br>time As Long<br>dwExtraInfo As Long<br>End Type<br><br>Private Type GENERALINPUT<br>dwType As Long<br>xi(0 To 23) As Byte<br>End Type<br><br>Private Declare Function SendInput Lib &quot;user32.dll&quot; (ByVal nInputs As Long, pInputs As GENERALINPUT, ByVal cbSize As Long) As Long<br>Private Declare Sub CopyMemory Lib &quot;kernel32&quot; Alias &quot;RtlMoveMemory&quot; (pDst As Any, pSrc As Any, ByVal ByteLen As Long)<br><br>Public Function SendKeysA(ByVal vKey As Integer, Optional booDown As Boolean = False)<br>Dim GInput(0) As GENERALINPUT<br>Dim KInput As KEYBDINPUT<br>KInput.wVk = vKey<br>If Not booDown Then<br> &nbsp; &nbsp;KInput.dwFlags = KEYEVENTF_KEYUP<br>End If<br>GInput(0).dwType = INPUT_KEYBOARD<br>CopyMemory GInput(0).xi(0), KInput, Len(KInput)<br>Call SendInput(1, GInput(0), Len(GInput(0)))<br>End Function<br><br>----------<br><br>So hackers will continue to develop harmful software calling SendInput, whereas honest VB6 programmers will have to waste tens and tens of hours to update their software. THIS IS CRAZY!</div>
<p><a id="660717" href="#660717">#</a> <strong>Michael S. Kaplan</strong> on Sunday, July 09, 2006 2:52 PM:</p><div style="margin-left: 1em">Pasquale, <BR><BR>Actually, my logic is still intact -- there is as lot more you can do with journal playback hooks than just key input. <BR><BR>Which has been my point all along! The method VB uses is quite simply overkill. Like "Someone stole my lunch money? Give me a submachine gun."</div>
<p><a id="661303" href="#661303">#</a> <strong>Pasquale Esposito</strong> on Monday, July 10, 2006 7:14 AM:</p><div style="margin-left: 1em">Okay, let's keep it simple, in order to make myself clear. The situation (that I consider as ABSURD) is the following:<br><br>1. MS points out there is a problem with SendKeys because this statement allows hackers to write malicious code.<br><br>2. MS decides to neutralize SendKeys under Windows Vista because they want to prevent hackers from writing malicious code.<br><br>3. SendKeys has also been used by millions of honest VB6 programmers over the last years to write harmless code.<br><br>4. MS does NOT neutralize the SendInput API that still allows hackers to write the same malicious code as the one they could write with SendKeys.<br><br>5. MS does not take into any account that a hacker's criminal mind will not stop writing harmful code simply because SendKeys does not work anymore. Obviously, he or she will now use SendInput instead.<br><br>6. So, while hackers have not been stopped from doing anything, honest VB6 programmers who relied on standard VB6 code will now have to roll up their sleeves and amend all the software they have distributed over the last few years.<br><br>The measure MS took was, &quot;Somebody wrote some malicious code using SendKeys. I'll now grab a submachine gun and exterminate millions of innocent people... and let bastards commit the same crime again!&quot;<br><br>Sorry, I still cannot see what sense it makes.</div>
<p><a id="661378" href="#661378">#</a> <strong>Michael S. Kaplan</strong> on Monday, July 10, 2006 9:37 AM:</p><div style="margin-left: 1em">Pasquale, let me make it not only simpler but also accurate (which you does not): <BR><BR>1) The VB team uses a method to enable SendKeys that they should not have. <BR>2) That METHOD -- *NOT* the SendKeys call itself -- allows much more theoretical access to the system then it ought to <BR>3) Vista locks down the METHOD. <BR>4) Pasquale and others refeuse to understand #1 - #3 above, thinking that MS locked down SendKeys itself as a security hole. <BR><BR>That is about as simple as I can make it. And I am REALLY hoping that it is simple enough to allow you to understand what the problem is. It is NOT that SendKeys is insecure -- it is that the grenade they attached it to is. <BR><BR>The issues *YOU* point out with SendInput actually suggest both a workaround for users and also a potential category of solutions for the people who own the SendKeys code (all of this was known long before you suggested the latter, and possibly in some cases the former). <BR><BR>I am really hoping that this makes sense now, finally. Since it is the central issue I was trying to point out, it is frutrating to me that it is apparently not being communicated....</div>
<p><a id="661496" href="#661496">#</a> <strong>Pasquale Esposito</strong> on Monday, July 10, 2006 12:30 PM:</p><div style="margin-left: 1em">Who invented &quot;that METHOD that allows much more theoretical access to the system then it ought to?&quot; Pasquale or Microsoft?<br><br>Pasquale's only fault was to rely on standard (allegedly legitimate) code provided by Microsoft. Pasquale was stupid because he did not understand that Microsoft is not compatible with Microsoft!<br><br>So, who is going to pay for somebody else's mistake? Millions of innocent VB6 users are!<br><br>If you want to act professionaly, you should sort out the problem in such a way that all the terabytes of VB6 software currently in circulation should not be prevented from working. If you don't, you will let somebody else pay for the grenade YOU attached to SendKeys.<br><br>Do you know what it means to provide all of your customers with an updated version of your software as soon as Windows Vista is released? Most of them may not be willing to pay for the upgrade.<br><br>You have made your point perfectly. But, possibly, I haven't made mine. So, I'll state it once again in plain English: IT IS UNFAIR TO LET OTHER PEOPLE PAY FOR YOUR MISTAKES.<br><br>Believe me, this is frustrating also to me. And to millions of other VB6 users.</div>
<p><a id="661615" href="#661615">#</a> <strong>Michael S. Kaplan</strong> on Monday, July 10, 2006 3:01 PM:</p><div style="margin-left: 1em">Perhaps through understanding the nature of the problem, customers will be armed with the knowledge of what to ask for, and who to ask it of. <BR><BR>If there is anything I want this blog to highlight -- it is that Microsoft is not one single monolith that understands every aspect of every problem. Microsoft is a huge number of different people in different groups, and I am being as transparent as I can about all that I know here. <BR><BR>Just remember -- I do not even have permission to view the VB6 source code (or the VBA source code) -- so I could not go off randomly fix bugs myself in random products, even if I were the sort of person random enough to try that sort of thing. <BR><BR>But now I have acted as a messenger about the issue, and you have decided to shoot the messenger for hurting millions of VB users. :-(</div>
<p><a id="661702" href="#661702">#</a> <strong>Pasquale Esposito</strong> on Monday, July 10, 2006 5:04 PM:</p><div style="margin-left: 1em">Michael, I am not taking it out on you. I know you are not the one who developed VB6.<br><br>I was just complaining about MS' attitude towards their customers.<br><br>The SendKeys issue may look like a minor problem, but it isn't.<br><br>Over the last five years, I have sold more than 3,000 (three-thousand) licenses of my software developed in VB6. Unfortunately, in all of my applications I used SendKeys to implement at least two functions: opening the Help file page (simulating the pressure of the F1 key) and moving the focus from one TextBox to the next (simulating the pressure of the Tab key).<br><br>Now, three thousand customers of mine will have problems using my software under Windows Vista and, believe me, this is very hard cheese for me to swallow.<br><br>A few weeks ago I made up my mind to switch to Delphi just because I would not be able to trust MS again.</div>
<p><a id="683850" href="#683850">#</a> <strong>Pasquale Esposito</strong> on Monday, July 31, 2006 3:51 AM:</p><div style="margin-left: 1em">Hello, I have some very good news! This morning I received the following message from Chris Mayo, the VB Program Manager responsible for Visual Basic 6 on Vista:<br><br>----------<br>re: Vista To Support Legacy VB6 Apps <br>Pasquale, <br><br>I'm the VB Program Manager responsible for Visual Basic 6 on Vista. &nbsp;The SendKeys issues has been corrected and will be released in Vista RC1. &nbsp;The calls to SendKeys that work under Windows XP will work the same way under Vista. <br><br>Hope that helps. <br>Thanks, <br>Chris Mayo <br>Visual Basic Program Manager <br>Sunday, July 30, 2006 7:38 PM by cmayo<br>----------<br><br>You can reach the Blog page at<br><br><a rel="nofollow" target="_new" href="http://blogs.msdn.com/davbosch/archive/2006/02/26/539470.aspx">http://blogs.msdn.com/davbosch/archive/2006/02/26/539470.aspx</a><br><br>Thank you, Microsoft, from the bottom of my heart!</div>
<p><a id="8295755" href="#8295755">#</a> <strong>Craig Matthews</strong> on Monday, March 17, 2008 5:10 PM:</p><div style="margin-left: 1em"><p>I wonder why it is that the SendKeys issue was reported to Pasquale Esposito on July 30, 2006 by Visual Basic Program Manager Chris Mayo as being &quot;fixed&quot; still does exactly the same thing for me on March 17, 2008?</p>
<p>With UAC turned off, running as a &quot;normal&quot; user, running a compiled (by myself) VB6 application I still get the run-time error 70 &quot;Permission denied&quot;.</p></div>
<p><a id="8296977" href="#8296977">#</a> <strong>Michael S. Kaplan</strong> on Monday, March 17, 2008 6:24 PM:</p><div style="margin-left: 1em"><P>Running Vista SP1 (or Server2008), which as Chris indicated is where the "fix" was put?</P></div>
<p><a id="8712301" href="#8712301">#</a> <strong>rohit_kap11</strong> on Wednesday, July 09, 2008 7:32 AM:</p><div style="margin-left: 1em"><p>The problem remains the same.</p>
<p>until and unless we (The VB6 Programmers) r confirmed about the exact solution of the problem. even i m facing lots of problems as i have also delivered thousand copies of my software worldwide, in which around 346 complains, i have got by mail regarding the error 70.</p>
<p>pls make it clear that how can our old s/w run on new OS flawlessely. i dont wanna change the code again n again, just bcs ...</p></div>
<p><a id="9563999" href="#9563999">#</a> <strong>Yuhong Bao</strong> on Thursday, April 23, 2009 1:03 AM:</p><div style="margin-left: 1em"><p>rohit_kap11 and Craig Matthews: Are you sure you are using the version of msvbvm60.dll shipped with Vista? Because older versions won't contain this fix.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/05/13 <a href="http://archives.miloush.net/michkap/archive/2010/05/13/9993808.html">Minimalism isn't laziness, really; it's trying to do the job right without side effects!</a></p><p>2007/09/10 <a href="http://archives.miloush.net/michkap/archive/2007/09/10/4850360.html">The SendKeys *blog post* juice was definitely not worth the squeeze</a></p><p>2006/07/13 <a href="http://archives.miloush.net/michkap/archive/2006/07/13/664497.html">IME + .NET = Input Madness Editor?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/10/625998.html" title="Cut off from society?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/08/621253.html" title="Reading the boilerplate">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/10/625285.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>