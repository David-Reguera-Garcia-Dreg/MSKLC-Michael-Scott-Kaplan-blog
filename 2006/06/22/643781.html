<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/22/643781.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting the length in bytes</title></head><body>
<h1>Getting the length in bytes</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/23 02:35 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/06/22/643781.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Overheard in microsoft.public.win32.programmer.inernational: </FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Hi Guys,<BR><BR>Sorry for posting this. I have gone through lots of postings here and unable to get an answer. Here is my problem.<BR><BR>I am using Windows XP Pro English.<BR><BR>I have a VB dll that passes strings to COM DLL (written in VC++). VC DLL converts the string to ANSI before writing to a file. The VC DLL has function called AddData that expects 2 parameters - One is the string to write and second parameter is length of the string.<BR><BR>Sample Code -<BR>s="Write this to file"<BR>MyFile.AddData(s,len(s))<BR><BR>Result<BR>Contents of file - "Write this to file"<BR><BR>Well, everything was fine till the application was supposed to write chinese characters as well. I first tried to do the same on my machine and could not generated any chinese characters (only ???). I was then asked to configure my machine to display chinese characters (the way chinese guys are doing it). This is what I did -<BR><BR>1. Install East Asian language support.<BR>2. Added Chinese (PRC) language to input/keyboard language (With US Keyborad layout being default)<BR>3. Changed the non-unicode language from default to Chinese (PRC)<BR><BR>Sample code -<BR>s="Write 测试this to file"<BR>MyFile.AddData(s,len(s))<BR><BR>Result<BR>Contents of file - "Write 测试this to fi"<BR><BR>The number of characters lost are same as number of Chinese characters in the string.<BR><BR>My Analysis -<BR>Len returns the number of characters in a string and not the number bytes that will be written to the file.<BR><BR>Limitations<BR>I cannot change the VC COM dll as we do not own it.<BR><BR>My questions -<BR>1. Why is the string length not reported correctly?<BR>2. How can I get the actual length of the string?<BR><BR>Cheers<BR>Siva</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>The problem here is that strings in VB are Unicode, and the Len() function returns a count of UTF-16 code units in that Unicode string.</FONT></P>
<P><FONT face=Tahoma>To work around this, i</FONT><FONT face=Tahoma>f you want the length in bytes of the string in the default system code page, you need to try something different, such as:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New"><STRONG>s = "Write 测试this to file"<BR>MyFile.AddData(s, LenB(StrConv(s, vbFromUnicode))</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>This will convert the string using the default system locale's code page, and pass the length of that string in bytes to the AddDate method....</FONT></P>
<P><FONT face=Tahoma>Note the dependence on the default system locale, which will not be correct if the conversion being done in the VC++ COM DLL is not CP_ACP, the default system code page. In that case, you just need to make sure that the same code page is used in both the VB and the VC++ components....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>测</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/6d4b">U+6d4b</A>, a CJK Ideograph)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/23/643843.html" title="Leg godt with the Lego!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/22/643461.html" title="Things I [don&#39;t] like about blogging">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/22/643781.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>