<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/29/650680.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Working beyond the BMP is going off script (according to GDI)</title></head><body>
<h1>Working beyond the BMP is going off script (according to GDI)</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/29 08:06 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/06/29/650680.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Yesterday when I was talking about <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/06/28/649791.html">WYSIWYG font dropdowns</A></STRONG> and using the <A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_4svn.asp">GetGlyphIndices function</A> to determine if a font supported a character or set of characters, regular reader Mihai mentioned in a <A href="http://archives.miloush.net/michkap/archive/2006/06/28/649791.html#649868">comment</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>GetGlyphIndices does not handle chars outside BMP (true in XP SP2 and an older Vista build)</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>This is true, it doesn't. As a function it looks at each individual UTF-16 code unit and checks to see if it is in the font.</FONT></P>
<P><FONT face=Tahoma>Now in theory you could create a font that puts surrogate code points in the ligature table that might work here, but (a) that won't help <A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_4svn.asp">GetGlyphIndices</A> since it will just globally say the high surrogate and low surrogate are there and not whether there is an actual ligature defined, and (b) it is not generally considered good typographic practice to create an "off the BMP" font that way.</FONT></P>
<P><FONT face=Tahoma><EM>(We don't mind it so much in keyboards, but that's a story for another day!)</EM></FONT></P>
<P><FONT face=Tahoma>There is actually a real solution that can handle things off the Basic Multilingual Plane -- the <A href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_2kog.asp">ScriptGetCMap function</A>, which is described as&nbsp;being able to retrieve&nbsp;"<EM>...the glyph indexes of the Unicode characters in a string according to either the TrueType cmap table or the standard cmap table implemented for old style fonts.</EM>"</FONT></P>
<P><FONT face=Tahoma>And it will do the extra work with supplementary characters defined as surrogate pairs, and it is even easier than GetGlyphIndices in terms of determining whether the font supports the string since it will simply return S_FALSE if one or more of the code points were mapped to the&nbsp;default glyph.</FONT></P>
<P><FONT face=Tahoma>There is one warning in the documentation which is theoretically troubling:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Note that some code points can be rendered by a combination of glyphs as well as by a single glyph — for example, 00C9; LATIN CAPITAL LETTER E WITH ACUTE. In this case, if the font supports the capital E glyph and the acute glyph but not a single glyph for 00C9, <B>ScriptGetCMap</B> will show 00C9 is unsupported.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Although in practice the situation is very uncommon, because in general any time a particular composite sequence is suppprted in a font, the precomposed character (if it exists) is also supported. It is just the way things usually work in fonts, and it is much less common for the precomposed character to not be supported.</FONT></P>
<P><FONT face=Tahoma>Though there is info in the docs on how to handle that situation if one suspects it may be happening, anyway, via the <A href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_7yhx.asp">ScriptShape function</A>....</FONT></P>
<P><FONT face=Tahoma>Now I was talking to Peter about this whole issue yesterday, and he pointed out that people could simply special case their code to use GetGlyphIndices for BMP cases and ScriptGetCMap for when things are off the BMP (in truth GDI handles nothing off the BMP anyway, so it is hardly an artificial split -- if you are using supplementary characters, you are using <A href="http://archives.miloush.net/michkap/archive/2006/05/31/611340.html"><STRONG>complex scripts</STRONG></A> as far as GDI is concerned).</FONT></P>
<P><FONT face=Tahoma>Though in truth if one is going to use Uniscribe here, it seems using it all the time when it is available is probably better, or at least more consistent. And why not use Uniscribe in little ways explicitly if it is going to be use implicitly in bigger ways like rendering anyway? :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>ফ</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/09ab">U+09ab</A>, a.k.a. BENGALI LETTER PHA)</EM></FONT></P>
<hr/><p><a id="650816" href="#650816">#</a> <strong>Nick Lamb</strong> on 29 Jun 2006 11:26 AM:</p><div style="margin-left: 1em">&quot;you could create a font that puts surrogate code points in the ligature table&quot;<br><br>This would not be legal so far as I can see. Surrogate code points are not Unicode characters, they're just an artefact of UTF-16.</div>
<p><a id="650870" href="#650870">#</a> <strong>Michael S. Kaplan</strong> on 29 Jun 2006 12:22 PM:</p><div style="margin-left: 1em">re: &quot;not legal&quot; <br><br>Well, notice I am not recommending it, and also notice that the meaning of &quot;not legal&quot; is unclear when there are no law enforcment personnel who are going to pull over a font. :-)</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/12/16 <a href="http://archives.miloush.net/michkap/archive/2007/12/16/6780417.html">How best to keep the font switcheroo from happening?</a></p><p>2007/10/11 <a href="http://archives.miloush.net/michkap/archive/2007/10/11/5396360.html">If you aren't adequate, I guess that means you're inadequate; if you're not complex, I suppose that means you're simple?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/30/653149.html" title="Quando Dio vuole castigarci ci manda quello che desideriamo">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/28/649791.html" title="WYSIWYG font dropdowns">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-29">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/29/650680.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>