<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/08/621213.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>DEP is not affected by locale settings</title></head><body>
<h1>DEP is not affected by locale settings</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/08 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/06/08/621213.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>When I hear someone has a problem involving VB5/VB6 and strings that involves language issues, I can usually make a good guess at what is going wrong....</FONT></P>
<P><FONT face=Tahoma>So the other day, when Christopher used the contact link to ask me a question, I had a notion of what might be happening:</FONT></P><FONT face="Times New Roman" size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>Hello,<BR><BR>I've got an interesting regional settings situation that I thought you might have some knowledge of (there is a question somewhere in here...). I've got an app that makes use of some fancy VB6 code to dynamically execute some assembly code stored in a string (for CPU info stuff). It had worked fine until XP SP2 and all the various DEP issues. I've now fixed them. Or so I thought. <BR><BR>It seems that the DEP problem is fixed on English setups, but if I switch to Thai or Hebrew (the two that I tested, could be others), I get a DEP warning! By switched, I mean change the setting in both Standards and Formats and the non-Unicode Language field.<BR><BR>I don't run any code that is locale/language/etc specific. It should run the same on all scenarios. So my question is: What in the world goes in there that would cause DEP warnings on Thai/Hebrew, but not in English? Does VirtualAlloc/Protect/Free have any code internally that depends on the regional settings? It seems very odd. Any chance the fantastic Kaplan knows what sort of actions are taking place? :) If there is something weird here, there might be more than a few developers that would want to know about it...<BR><BR>Thanks,<BR><BR>-Christopher J. Thibeault</P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>I don't think I'm fantastic or anything, but like I said I think I know what is going on.... :-)</FONT></P>
<P><FONT face=Tahoma>Now the XPSP2 DEP (Data Execution Prevention) functionality does not itself have language-specific hooks in it. As a feature, it just keeps you from executing code that is actually sitting in a data section of a binary (a "feature" that is unique to x86 and which is used in some of security exploits that have been seen in the past related to buffer overruns on the heap).</FONT></P>
<P><FONT face=Tahoma>But any time you are using strings in VB &lt;= 6.0&nbsp;and you are not taking special care to avoid it you are going to see a lot of string conversion via the default system code page (which is directly affected by the <STRONG>default system locale</STRONG>, also known as the <STRONG>language for non-Unicode programs</STRONG>.</FONT></P>
<P><FONT face=Tahoma>It boils down to the same problem&nbsp;behind the&nbsp;</FONT><FONT face=Tahoma>whole <A href="http://archives.miloush.net/michkap/archive/2005/10/28/486019.html"><STRONG>Double Secret Unicode thing</STRONG></A> I have talked about before.&nbsp;Basically, a VB string being passed to a Win32 API, which VB will automatically convert from and to Unicode using the default system code page, andall of that conversion is basically either (a) useless or (b) destructive to the data.</FONT></P>
<P><FONT face=Tahoma>In this case, where a string is being used in a <A href="http://www.powervb.com/">Curland</A>-esque running of assembler, any operation that is potentially destructive of the string is potentially very dangerous, and can certainly do things that were not intended.</FONT></P>
<P><FONT face=Tahoma>It was a good thing DEP was there to protect the computer, when you think about it!</FONT></P>
<P><FONT face=Tahoma>Of course it is hard to answer more specifically what to do here to fix the problem than what the <A href="http://archives.miloush.net/michkap/archive/2005/10/28/486019.html"><STRONG>Double Secret Unicode</STRONG></A>&nbsp;post talks about, but keeping that principle in mind it is usually easy enough to see where Visual Basic might be doing a bit of that evil conversion on data that&nbsp;ought not to be converted....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>‡¨è</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0b0f">U+0b0f</A>, a.k.a. ORIYA LETTER E)</EM></FONT></P>
<hr/><p><a id="622814" href="#622814">#</a> <strong>dumb programmer</strong> on 8 Jun 2006 4:38 PM:</p><div style="margin-left: 1em">Executing assembly code stored in a string in VB6<br>WTF ?!?<br><br>I've seen some s** done in VB6 but not that far!</div>
<p><a id="623081" href="#623081">#</a> <strong>Michael S. Kaplan</strong> on 8 Jun 2006 7:54 PM:</p><div style="margin-left: 1em">Hi dp,<br><br>I try not to judge -- I have seen some really brilliant code that used such a technique and some code I was embarrassed to even look at. So who knows whether its good or not without seeing it? :-)</div>
<p><a id="623241" href="#623241">#</a> <strong>Christopher J. Thibeault</strong> on 8 Jun 2006 10:49 PM:</p><div style="margin-left: 1em">Hi Michael,<br><br>Thanks for the reply. Having read your book (along with Matt Curland's book, one of the few that have a spot on my 'nearby' bookshelf...), this should have been the first thing I thought of, but I eventually found it...<br><br>Besides the CPU stuff, I also use this technique for some other performance related hacks, subclassing, as well as for some anti-cracking measures. In an attempt to hide what I am doing to a small degree (cracker roadblocks...), I stored encrypted copies of my ASM bytes at compile time in a string, and then decrypt them at runtime. The decryption is where things went wrong on some locales.<br><br>My DEP workarounds were indeed working. The memory I was trying to make executable was executable. But since the decryption failed to happen as planned, the code that was executing was not the code I intended. What ended up in there was just executable enough that it made a jump into the middle of nowhere. Apparently, the middle of nowhere doesn't have execute permissions... :(<br><br>Anway, I've got it worked out now, but I do appreciate you taking the time to respond (wow, I made the blog). And yes, you are indeed fantastic. And speaking of fantastic people, do you still keep in touch with Curland? He seems to have vanished...<br><br>Thanks again,<br>-Chris</div>
<p><a id="623472" href="#623472">#</a> <strong>Michael S. Kaplan</strong> on 9 Jun 2006 1:52 AM:</p><div style="margin-left: 1em">Matt Curland is alive and well, working at Northface University in Utah. If you look at Matt's book site (<a rel="nofollow" target="_new" href="http://powervb.com/">http://powervb.com/</a>) there is a link there to email him... :-)<br><br>Definitely still a very cool guy (and one of only four people I know of in Utah who I'd want the chance to say hi to again if I was pasing through Utah!).</div>
<p><a id="623499" href="#623499">#</a> <strong>Christopher J. Thibeault</strong> on 9 Jun 2006 2:42 AM:</p><div style="margin-left: 1em">Hi Michael,<br><br>I knew he was at Northface, but I had seen a newsgroup posting that indicated that he was no longer at the email address. I haven't tried to contact him myself (I'm sure he is a busy guy and I'd rather not bother him unless I absolutely was deperate with a PushParamThunk mod question...), but it is good to hear that he is well.<br><br>Thanks,<br>-Chris</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/08/621253.html" title="Reading the boilerplate">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/07/620955.html" title="Yi Syllables are totally Radical, dude!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/08/621213.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>