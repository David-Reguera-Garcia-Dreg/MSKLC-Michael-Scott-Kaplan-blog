<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/02/615571.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What the @!#$% is the TERTIARY_WEIGHTS() function for?</title></head><body>
<h1>What the @!#$% is the TERTIARY_WEIGHTS() function for?</h1>
<p><em>by Michael S. Kaplan, published on 2006/06/02 23:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/06/02/615571.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>This function <A href="http://msdn2.microsoft.com/en-us/library/ms186881.aspx">TERTIARY_WEIGHTS</A>() has been in Microsoft SQL Server for a while.</FONT></P>
<P><FONT face=Tahoma>Now you have perhaps read what I have had to say about tertiary weights previously in posts like <A href="http://archives.miloush.net/michkap/archive/2004/12/30/344389.html"><STRONG>this one</STRONG></A> or <A href="http://archives.miloush.net/michkap/archive/2006/01/11/511557.html"><STRONG>this one</STRONG></A> or <A href="http://archives.miloush.net/michkap/archive/2006/03/02/542395.html"><STRONG>this one</STRONG></A> (the latter is especially topical to some of what I will point out in this post -- note that lowercase is given less weight than uppercase!).</FONT></P>
<P><FONT face=Tahoma>According to SQL Server's <A href="http://msdn2.microsoft.com/en-us/library/ms186881.aspx">Books Online in SQLS 2005</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2>Returns a binary string of weights for each character in a non-Unicode string expression defined with an SQL tertiary collation.</FONT></P>
<P><FONT size=2><STRONG>Syntax</STRONG>&nbsp;<BR>TERTIARY_WEIGHTS( non_Unicode_character_string_expression )<BR>&nbsp;</FONT></P>
<P><FONT size=2><STRONG>Arguments</STRONG><BR>non_Unicode_character_string_expression<BR>Is a string expression of type char, varchar, or varchar(max) defined on a tertiary SQL collation. For a list of these collations, see Remarks.</FONT></P>
<P><FONT size=2><STRONG>Return Types<BR></STRONG>TERTIARY_WEIGHTS returns varbinary when non_Unicode_character_string_expression is char or varchar, and returns varbinary(max) when non_Unicode_character_string_expression is varchar(max).</FONT></P>
<P><FONT size=2><STRONG>Remarks</STRONG><BR>TERTIARY_WEIGHTS returns NULL when non_Unicode_character_string_expression is not defined with an SQL tertiary collation. The following table shows the SQL tertiary collations.</FONT></P>
<P><FONT size=2>Sort order ID&nbsp; SQL collation&nbsp; <BR>33&nbsp;&nbsp;&nbsp; SQL_Latin1_General_Pref_CP437_CI_AS<BR>34&nbsp;&nbsp;&nbsp; SQL_Latin1_General_CP437_CI_AI<BR>43&nbsp;&nbsp; &nbsp;SQL_Latin1_General_Pref_CP850_CI_AS<BR>44&nbsp; &nbsp;&nbsp;SQL_Latin1_General_CP850_CI_AI<BR>49 &nbsp;&nbsp;&nbsp;SQL_1xCompat_CP850_CI_AS<BR>53&nbsp;&nbsp;&nbsp;&nbsp;SQL_Latin1_General_Pref_CP1_CI_AS<BR>54&nbsp;&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1_CI_AI<BR>56&nbsp;&nbsp;&nbsp;&nbsp;SQL_AltDiction_Pref_CP850_CI_AS<BR>57&nbsp;&nbsp;&nbsp; SQL_AltDiction_CP850_CI_AI<BR>58&nbsp;&nbsp;&nbsp;&nbsp;SQL_Scandinavian_Pref_CP850_CI_AS<BR>82&nbsp;&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1250_CI_AS<BR>84&nbsp;&nbsp;&nbsp;&nbsp;SQL_Czech_CP1250_CI_AS<BR>86&nbsp;&nbsp;&nbsp;&nbsp;SQL_Hungarian_CP1250_CI_AS<BR>88&nbsp;&nbsp;&nbsp;&nbsp;SQL_Polish_CP1250_CI_AS<BR>90&nbsp;&nbsp;&nbsp;&nbsp;SQL_Romanian_CP1250_CI_AS<BR>92&nbsp;&nbsp;&nbsp;&nbsp;SQL_Croatian_CP1250_CI_AS<BR>94&nbsp;&nbsp;&nbsp;&nbsp;SQL_Slovak_CP1250_CI_AS<BR>96&nbsp;&nbsp;&nbsp;&nbsp;SQL_Slovenian_CP1250_CI_AS<BR>106&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1251_CI_AS<BR>108&nbsp;&nbsp;&nbsp;SQL_Ukrainian_CP1251_CI_AS<BR>113&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1253_CS_AS<BR>114&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1253_CI_AS<BR>130&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1254_CI_AS<BR>146&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1256_CI_AS<BR>154&nbsp;&nbsp;&nbsp;SQL_Latin1_General_CP1257_CI_AS<BR>156&nbsp;&nbsp;&nbsp;SQL_Estonian_CP1257_CI_AS<BR>158&nbsp;&nbsp;&nbsp;SQL_Latvian_CP1257_CI_AS<BR>160&nbsp;&nbsp;&nbsp;SQL_Lithuanian_CP1257_CI_AS<BR>183&nbsp;&nbsp;&nbsp;SQL_Danish_Pref_CP1_CI_AS<BR>184&nbsp;&nbsp;&nbsp;SQL_SwedishPhone_Pref_CP1_CI_AS<BR>185&nbsp;&nbsp;&nbsp;SQL_SwedishStd_Pref_CP1_CI_AS<BR>186&nbsp;&nbsp;&nbsp;SQL_Icelandic_Pref_CP1_CI_AS<BR></FONT></P>
<P><FONT size=2>TERTIARY_WEIGHTS is intended for use in the definition of a computed column that is defined on the values of a char, varchar, or varchar(max) column. Defining an index on both the computed column and the char, varchar, or varchar(max) column can improve performance when the char, varchar, or varchar(max) column is specified in the ORDER BY clause of a query.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Hmmm.... this does not sound much like any of the tertiary stuff I was talking about. And did you notice how many <STRONG>CI</STRONG> (case insensitive) collations are listed there?</FONT></P>
<P><FONT face=Tahoma>Let's try it out:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>SELECT TERTIARY_WEIGHTS('ABCDEFGHIJKLMNOPQRSTUVWZYZ' COLLATE SQL_Latin1_General_Pref_CP437_CI_AS)<BR><BR>0x0101010101010101010101010101010101010101010101010101</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Hmmm... well, it is not using Microsoft's weights (remember our aversion to embeded 0x01 bytes!) but if uppercase with an ignore case flag returns a low number, perhaps there is some common ground.</FONT></P>
<P><FONT face=Tahoma>Let's try the lowercase letters:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>SELECT TERTIARY_WEIGHTS('abcdefghijklmnopqrstuvwxyz' COLLATE SQL_Latin1_General_Pref_CP437_CI_AS)<BR><BR>0x0202020202020202020202020202020202020202020202020202</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Hmmm... never mind. :-)</FONT></P>
<P><FONT face=Tahoma>Clearly it is only capturing case differences, and since it will not work with either Unicode types or unusual letters like U+028f (ʏ, a.k.a. LATIN LETTER SMALL CAPITAL Y), all of the numbers will be 0x01 or 0x02. Let's make sure:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG><FONT face="Consolas,Courier New" size=2>SELECT TERTIARY_WEIGHTS('AbCdEfGhIjKlMnOpQeStUvWxYz' COLLATE SQL_Latin1_General_Pref_CP437_CI_AS)<BR><BR>0x0102010201020102010201020102010201020102010201020102</FONT></STRONG></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Ok, that looks a bit like proof, right? :-)</FONT></P>
<P><FONT face=Tahoma>So this is a function that will return information about case distinctions even in case insensitive sorts, to help with index performance of non-Unicode SQL compatibility collation columns. Though how it helps is quite&nbsp;unclear at this point.</FONT></P>
<P><FONT face=Tahoma>And to&nbsp;wind down&nbsp;on a weird note, you can try the following query:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>SELECT &nbsp;TERTIARY_WEIGHTS('W' COLLATE SQL_Scandinavian_Pref_CP850_CI_AS), <BR>&nbsp;&nbsp;TERTIARY_WEIGHTS('w' COLLATE SQL_SwedishStd_Pref_CP1_CI_AS),<BR>&nbsp;&nbsp;TERTIARY_WEIGHTS('W' COLLATE SQL_SwedishStd_Pref_CP1_CI_AS)<BR><BR>0x03&nbsp;&nbsp;&nbsp;0x02&nbsp;&nbsp;&nbsp;&nbsp;0x01</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>I am afraid to ask what it is about the letter <STRONG>W</STRONG> in Scandinavia that would cause TERTIARY_WEIGHTS() to return a 0x03 here.</FONT></P>
<P><FONT face=Tahoma><EM><STRONG>Trivia </STRONG>-- does anyone know how to get a 0x04? Or another byte value higher than that? :-)</EM></FONT></P>
<P><FONT face=Tahoma>Perhaps I am even more afraid of asking how on earth anything one does with this function can help performance. Does anyone have any thoughts here?</FONT></P>
<P><FONT face=Tahoma>I would probably recommend giving this function a miss, in the meantime (a statement I will happily retract if someone can explain a purpose or use for this function that makes sense!).</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM>&nbsp;<STRONG><FONT size=6>ʏ</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/028f">U+028f</A>, a.k.a. LATIN LETTER SMALL CAPITAL Y)</EM></FONT></FONT></P>
<hr/><p><a id="673192" href="#673192">#</a> <strong>Steve Kass</strong> on 20 Jul 2006 6:12 PM:</p><div style="margin-left: 1em">Here's a clue for your trivia question: SELECT TERTIARY_WEIGHTS('Aa&#192;&#224;&#193;&#225;&#194;&#226;&#195;&#227;&#196;&#228;&#197;&#229;' COLLATE SQL_Latin1_General_CP850_CI_AI)<br><br>Steve Kass<br></div>
<p><a id="679349" href="#679349">#</a> <strong>Michael S. Kaplan</strong> on 26 Jul 2006 3:25 PM:</p><div style="margin-left: 1em">Indeed, and that is a great example -- can you explain why? :-)</div>
<p><a id="6682355" href="#6682355">#</a> <strong>John Cowan</strong> on 6 Dec 2007 12:34 PM:</p><div style="margin-left: 1em"><p>I'm no SQL Server mavin, but clearly what is special about W in Scandinavia is that it's just a glyphic variant of V, mostly used in proper names nowadays. &nbsp;The old royal dynasty of Sweden (1523-1654) is usually spelled Vasa now, but the rye-crisps are still Wasa.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/10/29 <a href="http://archives.miloush.net/michkap/archive/2006/10/29/897317.html">SQL Server: compatibility collations vs. Window collations</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/06/04/616814.html" title="Important changes in NLS that span Windows and the .NET Framework">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/06/02/615536.html" title="Je, for sure, from Sweden.">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-06-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/06/02/615571.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>