<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/10/24/867880.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Sometimes in the future 'ANSI' is really going to be unsupported!</title></head><body>
<h1>Sometimes in the future 'ANSI' is really going to be unsupported!</h1>
<p><em>by Michael S. Kaplan, published on 2006/10/24 03:44 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/10/24/867880.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<font face="Tahoma" size="3"> <p>The question to the microsoft.public.win32.programmer.international newsgroup was simple enough: </p> <blockquote><font face="Times New Roman,Times" size="2"> <p><strong>TITLE</strong>: RegLoadMUIString Vista P Invoke<br><br>Hello,<br>I'm trying to get an MUI string out of the registry in display friendly format. From what I've read, strings in the following format:<br>“@[path]\dllname,-strID” are MUI strings and receive special handling via the RegLoadMUIString API call. <br><br>This is what I have come up with for the call:<br><br>[DllImport("advapi32.dll")]<br>internal static extern long RegLoadMUIString(IntPtr hKey, string pszValue, StringBuilder pszOutBuf, int cbOutBuf, out int pcbData, uint Flags, string pszDirectory);<br><br>I'm calling this function with a valid pointer to an open registry key, passing in the appropriate value key (pszValue) which has the MUI formatted string. When I check the output buffer (pszOutBuf) it's always an empty string. <br><br>Has anyone been able to get this call to work? I cannot find any examples on the web. <br><br>thanks,<br>-bp </p></font></blockquote> <p>A few exchanges back and forth where he showed me how he was calling the function showed three problems: one caused by him, one caused by the .NET Framework team, and one caused by the MUI team. I'll explain all three of these problems here....</p> <p>&nbsp;The problem that was bp's fault was that several Win32 API functions were being called, but the return value was not being checked. So a functionality error was being reported with an implicit assumption that function calls succeeded when there was really no evidence of success. Luckily this same person put the code up on the MSDN Forums in <a href="http://forums.microsoft.com/MSDN/ShowPost.aspx?PostID=811826&amp;SiteID=1">this post</a> where this problem was fixed, and the failure was now known -- it was returning error 120, which can be found in winerror.h:</p> <blockquote><font face="Consolas,Courier New,Lucida Console,Courier" size="2"><b> <p>//<br>// MessageId: ERROR_CALL_NOT_IMPLEMENTED<br>//<br>// MessageText:<br>//<br>// This function is not supported on this system.<br>//<br>#define ERROR_CALL_NOT_IMPLEMENTED 120L</p></b></font></blockquote> <p>Ok, this leads us to the next problem, one that in my opinion is caused by the .NET Framework. For the sake of backward compatibility with VB4, VB5, and VB6, all P-Invoke calls that do not have charset&nbsp;information attached default to use the&nbsp;"A" version of functions. This means that even though the code is running in .NET&nbsp;where all the strings are Unicode on Vista where&nbsp;the registry and everything else is Unicode that everything is&nbsp;being dealt with as if it were a non-Unicode string, and the non-Unicode&nbsp;version of functions&nbsp;is being called.</p> <p>Remember when&nbsp;I wrote about how <a href="http://archives.miloush.net/michkap/archive/2005/10/02/476213.html"><strong>The Unicode train is leaving the station</strong></a> and was quite clear that there would no longer be non-Unicode function calls added to the NLS API? And how we'd be recommending to other teams that they do the same, either the way we did with <a href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html"><strong>FindNLSString</strong></a> (not even decorating the name with a "W") or the way the Shell team did with StrCmpLogicalW (a "W" decoration), no "A" version is being provided.</p> <p>Anyway, we&nbsp;now hit the final problem, which in my opinion is the MUI team's fault. They&nbsp;have only provided a Unicode implementation, but have provided&nbsp;both RegLoadMUIStringA and RegLoadMUIStringW, one of which the precompiler will convert <a href="http://msdn.microsoft.com/library/en-us/sysinfo/base/regloadmuistring.asp">RegLoadMUIString</a> to depending on whether UNICODE is defined. </p> <p>RegLoadMUIStringA is, in fact, not supported. </p> <p>But if you look at the requirements section in the docs, they clearly claim that the function is "Implemented as <b>RegLoadMUIStringW</b> (Unicode) and <b>RegLoadMUIStringA</b> (ANSI)."</p> <p>For those who are interested (someone who spends time on the MSDN forums can pass the word if it has not been answered there yet!), the code that will work on Vista and solves all three of these problems is:</p> <blockquote><font face="Consolas,Courier New,Lucida Console,Courier" size="1"><b> <p>using System;<br>using System.Text;<br>using System.Runtime.InteropServices;<br>using Microsoft.Win32; <br><br>namespace RegMUITest {<br>&nbsp; class Program {<br>&nbsp;&nbsp;&nbsp; [DllImport("advapi32.dll", CharSet=CharSet.Unicode, ExactSpelling=true, EntryPoint="RegOpenKeyExW", CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; public static extern int RegOpenKeyEx(IntPtr hKey, string lpSubKey,int ulOptions,int samDesired, out IntPtr phkResult); <br><br>&nbsp;&nbsp;&nbsp; [DllImport("advapi32.dll", CharSet=CharSet.Unicode, ExactSpelling=true, EntryPoint="RegLoadMUIStringW", CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; internal static extern int RegLoadMUIString(IntPtr hKey, string pszValue, StringBuilder pszOutBuf, int cbOutBuf, out int pcbData, uint Flags, string pszDirectory); <br><br>&nbsp;&nbsp;&nbsp; [DllImport("advapi32.dll", ExactSpelling=true, CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; public static extern int RegCloseKey(IntPtr hKey);<br><br>&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr localMachine = new IntPtr((long)unchecked((int)0x80000002)); <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr regKey;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int pcbData, retval; <br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //NOTE: Open a device key with KEY_READ access rights.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; retval = RegOpenKeyEx(localMachine, @"SYSTEM\CurrentControlSet\Control\Class\{36FC9E60-C465-11CF-8056-444553540000}", 0, 0x20019, out regKey);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(retval != 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("RegOpenKeyEx failed with error {0}.", retval);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //NOTE: Build the output buffer reference<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder lptStr = new StringBuilder(1024);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //NOTE: ClassDesc contains the MUI formatted string<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; retval = RegLoadMUIString(regKey, "ClassDesc", lptStr, 1024, out pcbData, 0, null);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(retval != 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("RegOpenKeyEx failed with error {0}.", retval);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //NOTE: Output values to console<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Reg key : {0}", regKey);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("LPWSTR : {0}", lptStr.ToString());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("pcbData : {0}", pcbData);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } </p> <p>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//NOTE: Close the key<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RegCloseKey(regKey);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; }<br>&nbsp; &nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;catch (Exception ex) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Exception : " + ex.Message);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.ReadLine();<br>&nbsp;&nbsp;&nbsp; }<br>&nbsp; }<br>}</p></b></font></blockquote> <p>&nbsp;Enjoy!</p> <p>&nbsp;</p> <p><font color="#ff0080"><em>This post brought to you by</em>&nbsp;<strong><font size="6">ꄾ</font></strong>&nbsp;<em>(<a href="http://www.fileformat.info/info/unicode/char/a13e/">U+a13e</a>, a.k.a. YI SYALLABLE DDAX)</em></font></p></font>
<hr/><p><a id="1044404" href="#1044404">#</a> <strong>Ted.</strong> on 9 Nov 2006 11:42 AM:</p><div style="margin-left: 1em"><p>It's unfortunate that this &quot;A&quot; function is exported at all. &nbsp; Are there any other functions that have &quot;A&quot; versions that return &quot;call not implemented?&quot; &nbsp; I was hoping that all &quot;Unicode only&quot; functions would not have dummy &quot;A&quot; stubs included as well. &nbsp;</p>
<p>In a sick way, I can see a need for an MSLA DLL (Microsoft Layer for ANSI), for certain customers.</p></div>
<p><a id="1053974" href="#1053974">#</a> <strong>Michael S. Kaplan</strong> on 10 Nov 2006 6:25 AM:</p><div style="margin-left: 1em"><p>Yikes! Just say NAY to MSLA! :-)</p>
<p>I did not even know about this one until looking into the reported problem, so I am not sure if there are others....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/03/26 <a href="http://archives.miloush.net/michkap/archive/2012/03/26/10286723.html">The Unicode train left the station YEARS ago, in fact! (2012 edition)</a></p><p>2007/02/22 <a href="http://archives.miloush.net/michkap/archive/2007/02/22/1738882.html">Getting the resource info you want</a></p><p>2006/11/20 <a href="http://archives.miloush.net/michkap/archive/2006/11/20/1112734.html">Putting the *backward* in backward compatibility</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/10/25/868025.html" title="Out of [implied] range">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/10/24/867463.html" title="Typos, the 5th Amendment, the 25th Amendment, and Language Log already did it!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-10-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/10/24/867880.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>