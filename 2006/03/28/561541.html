<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/28/561541.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting all you can out of a keyboard layout, Part #5</title></head><body>
<h1>Getting all you can out of a keyboard layout, Part #5</h1>
<p><em>by Michael S. Kaplan, published on 2006/03/28 03:11 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/03/28/561541.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Previous posts in this series: Parts <A href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html"><STRONG>0</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/23/558674.html"><STRONG>1</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/24/558715.html"><STRONG>2</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/24/559169.html"><STRONG>3</STRONG></A>, and <A href="http://archives.miloush.net/michkap/archive/2006/03/27/561353.html"><STRONG>4</STRONG></A>.</FONT></P>
<P><FONT face=Tahoma>I have been slowly building up a sample that is (so far)&nbsp;</FONT><FONT face=Tahoma>actually of limited use. I mean, who the hell cares about running through one shift state of a keyboard, even if it is definitive?</FONT></P>
<P><FONT face=Tahoma>But it has only been a few days, and I am going to take care of the "easy shift states" now. So you can take the code from this sample and consider it done enough to handle a lot of the conventional scenarios and keyboards that exist.</FONT></P>
<P><FONT face=Tahoma>Now it won't get you everything, but there are future posts for that.... :-)</FONT></P>
<P><FONT face=Tahoma>We'll start by defining a nice enumeration to cover all those easy shift states:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>public enum ShiftState : int {<BR>&nbsp;&nbsp;&nbsp;&nbsp;Base&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 0<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;Shft&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 1</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;Ctrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 2</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;ShftCtrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Shft | Ctrl,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 3</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;Menu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 4 -- NOT USED</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;ShftMenu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Shft | Menu,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 5 -- NOT USED</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;MenuCtrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Menu | Ctrl,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// 6</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;ShiftMenuCtrl&nbsp;&nbsp; = Shft | Menu | Ctrl,&nbsp;&nbsp; <FONT color=#008000>// 7</FONT><BR>}<BR></STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now, there are a few important things to note here:</FONT></P>
<UL>
<LI><FONT face=Tahoma>Only four of them have any real independent meaning; the other four are the various combinations when you consider the first four;</FONT> 
<LI><FONT face=Tahoma>Two of the eight states (<STRONG>Menu</STRONG> and <STRONG>ShftMenu</STRONG>) cannot be assigned in keyboards on Windows, at all, and are included only for completeness;</FONT> 
<LI><FONT face=Tahoma>One of the eight states (<STRONG>Ctrl</STRONG>) is not generally recommended in applications due to the fact that it is often co-opted for use in <A href="http://archives.miloush.net/michkap/archive/2004/12/23/331112.html">shortcuts</A>;</FONT> 
<LI><FONT face=Tahoma>There is assumed to be no difference between the LEFT and RIGHT versions of these keys -- we'll save that for later.</FONT></LI></UL>
<P><FONT face=Tahoma>And, how will we use this enumeration, exactly?</FONT></P>
<P><FONT face=Tahoma>Well, we will build a Key State array (basically an array of Virtual Key values), and send it in our various calls to <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicodeex.asp">ToUnicodeEx</A>. A</FONT><FONT face=Tahoma>ccording to the documentation such as that in handy functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/getkeyboardstate.asp">GetKeyboardState</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>...each member of the array pointed to by the lpKeyState parameter contains status data for a virtual key. If the high-order bit is 1, the key is down; otherwise, it is up.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>There is more there, but we'll get to it later. :-)</FONT></P>
<P><FONT face=Tahoma>The high order bit of a byte is the top bit -- thus setting the byte value to 0x80 will indicate it is pressed. We'll also add a handy function to do the&nbsp;bit&nbsp;work for us:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>private static void FillKeyState(KeysEx[] lpKeyState, ShiftState ss) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;lpKeyState[(int)KeysEx.VK_SHIFT]&nbsp;&nbsp;&nbsp; = (((ss &amp; ShiftState.Shft) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;lpKeyState[(int)KeysEx.VK_CONTROL]&nbsp; = (((ss &amp; ShiftState.Ctrl) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;lpKeyState[(int)KeysEx.VK_MENU]&nbsp;&nbsp;&nbsp;&nbsp; = (((ss &amp; ShiftState.Menu) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>}</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Since as I mentioned before, we are only dealing with the up/down state of these three keys, that's all we need to get the Key State array set&nbsp;up correctly.</FONT></P>
<P><FONT face=Tahoma>Then, as I mentioned in <A href="http://archives.miloush.net/michkap/archive/2006/03/27/561353.html">Part #4</A>, we do need to clean up our output a bit to keep it sensible. So, let's look at our function:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" color=#808080 size=1><STRONG>using System;<BR>using System.Text;<BR>using System.Windows.Forms;<BR>using System.Runtime.InteropServices;</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>namespace KeyboardLayouts {<BR>&nbsp;&nbsp;&nbsp; class Class1 {<BR></STRONG></FONT><FONT face="Courier New" size=1><STRONG><BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //&nbsp; You'll want to insert that enumeration from part #0 here!<BR></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public enum ShiftState : int {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Base&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 0,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 0<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Shft&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 1<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ctrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 2<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShftCtrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Shft | Ctrl,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 3<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Menu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = 4,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 4 -- NOT USED<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShftMenu&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Shft | Menu,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 5 -- NOT USED<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MenuCtrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = Menu | Ctrl,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 6<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ShiftMenuCtrl&nbsp;&nbsp; = Shft | Menu | Ctrl,&nbsp;&nbsp; // 7<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal const uint KLF_NOTELLSHELL&nbsp; = 0x00000080;</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("user32.dll", CharSet=CharSet.Unicode, EntryPoint="MapVirtualKeyExW", ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static extern uint MapVirtualKeyEx(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint uCode, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint uMapType, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr dwhkl);</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("user32.dll", CharSet=CharSet.Unicode, EntryPoint="LoadKeyboardLayoutW", ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static extern IntPtr LoadKeyboardLayout(string pwszKLID, uint Flags);</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("user32.dll", ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static extern bool UnloadKeyboardLayout(IntPtr hkl);</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("user32.dll", CharSet=CharSet.Unicode, ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; internal static extern int ToUnicodeEx(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint wVirtKey,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint wScanCode,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeysEx[] lpKeyState,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder pwszBuff,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int cchBuff,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint wFlags,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr dwhkl);</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("user32.dll", ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public static extern int GetKeyboardLayoutList(int nBuff, [Out, MarshalAs(UnmanagedType.LPArray)] IntPtr[] lpList);</STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int cKeyboards = GetKeyboardLayoutList(0, null);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr[] rghkl = new IntPtr[cKeyboards];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetKeyboardLayoutList(cKeyboards, rghkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr hkl = LoadKeyboardLayout(args[0], KLF_NOTELLSHELL);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(hkl == IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Sorry, that keyboard does not seem to be valid.");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KeysEx[] lpKeyState = new KeysEx[256];<BR></FONT><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint[] rgScOfVk = new uint[256];</FONT></STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Scroll through the Scan Code (SC) values and get the valid Virtual Key (VK)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // values in it. Then, store the SC in each valid VK so it can act as both a <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // flag that the VK is valid, and it can store the SC value.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(uint sc = 0x01; sc &lt;= 0x7f; sc++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint vk = MapVirtualKeyEx(sc, 1, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(vk != 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rgScOfVk[vk] = sc;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR></FONT></STRONG></FONT><FONT face="Courier New" size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("SC\tVK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \t_\ts\tc\tsc\tca\tsca");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("==\t==========\t\t====\t====\t====\t====\t====\t====");<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(uint vk = 0x01; vk &lt; rgScOfVk.Length; vk++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rgScOfVk[vk] != 0) {<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool fSomeActualLetters = false;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Were actual letters found in the row?<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sbBuffer;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Scratchpad we use many places<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sbLayout = new StringBuilder();&nbsp;&nbsp; // Will hold an entire layout 'row'<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sbStates = new StringBuilder();&nbsp;&nbsp; // Will hold all of the shift state info</STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // First, get the SC/VK info stored<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbLayout.Append(string.Format("{0:x2}\t{1:x2} - {2}", rgScOfVk[vk], vk, ((KeysEx)vk).ToString().PadRight(13)));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(ShiftState ss = ShiftState.Base; ss &lt;= ShiftState.ShiftMenuCtrl; ss++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ss == ShiftState.Menu || ss == ShiftState.ShftMenu) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Alt and Shift+Alt don't work, so skip them<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FillKeyState(lpKeyState, ss);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbBuffer = new StringBuilder(10);<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int rc = ToUnicodeEx(vk, rgScOfVk[vk], lpKeyState, sbBuffer, sbBuffer.Capacity, 0, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(rc &gt; 0) {<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sbChar = new StringBuilder(5 * rc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(sbBuffer.Length == 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Someone defined NULL on the keyboard; let's coddle them<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbChar.Append("0000 ");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else {<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int ich = 0; ich &lt; rc; ich++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbChar.Append(((ushort)sbBuffer.ToString()[ich]).ToString("x4"));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbChar.Append(' ');<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fSomeActualLetters = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbStates.Append(string.Format("\t{0}", sbChar.ToString(0, sbChar.Length - 1)));<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else if(rc &lt; 0) {<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fSomeActualLetters = true;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbStates.Append(string.Format("\t{0:x4}@", ((ushort)sbBuffer.ToString()[0])));</STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // It's a dead key; let's flush out whats stored in the keyboard state.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ToUnicodeEx((uint)KeysEx.VK_DECIMAL, rgScOfVk[(uint)KeysEx.VK_DECIMAL], lpKeyState, sbBuffer, sbBuffer.Capacity, 0, hkl);<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbStates.Append("\t&nbsp; -1");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Skip the layout rows that have nothing in them<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(fSomeActualLetters) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sbLayout.Append(sbStates.ToString());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(sbLayout.ToString());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach(IntPtr i in rghkl) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(hkl == i) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hkl = IntPtr.Zero;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New" color=#808080 size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(hkl != IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UnloadKeyboardLayout(hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New" size=1><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private static void FillKeyState(KeysEx[] lpKeyState, ShiftState ss) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpKeyState[(int)KeysEx.VK_SHIFT]&nbsp;&nbsp;&nbsp; = (((ss &amp; ShiftState.Shft) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpKeyState[(int)KeysEx.VK_CONTROL]&nbsp; = (((ss &amp; ShiftState.Ctrl) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpKeyState[(int)KeysEx.VK_MENU]&nbsp;&nbsp;&nbsp;&nbsp; = (((ss &amp; ShiftState.Menu) != 0) ? (KeysEx)0x80 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lpKeyState[(int)KeysEx.VK_CAPITAL]&nbsp; = (fCapsLock ? (KeysEx)0x01 : (KeysEx)0x00);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><FONT color=#808080>&nbsp;&nbsp;&nbsp; }<BR>}</FONT></STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>And there we go.</FONT></P>
<P><FONT face=Tahoma>Note some of the important changes:</FONT></P>
<UL>
<LI><FONT face=Tahoma>Rather than directly writing results, they are put into StringBuffer objects, which are only written out for each "row", where a row represents everything that a single key can do, in the various shift states;</FONT> 
<LI><FONT face=Tahoma>The fascinating case of a key having NULL assigned in a keystroke is handled, a necessity since for some ridiculous reason the US keyboard has such an assignment;</FONT> 
<LI><FONT face=Tahoma>When no assignment was found in a shift state, -1 was entered (this is the convention used in .KLC files as well in part to act as a placeholder);</FONT> 
<LI><FONT face=Tahoma>When a dead key assignment is found, a COMMERCIAL AT&nbsp;(@) sign in placed just after it, so we know it is a dead key;</FONT>
<LI><FONT face=Tahoma>I changed the "dead key buffer clearing character" from VK_SPACE to VK_DECIMAL.</FONT></LI></UL>
<P><FONT face=Tahoma>Let's take a look at a random keyboard when we run this code, say the French keyboard layout (0000040c), chosen since we get to see both dead keys and keys that have multiple code points in them (even though the latter messes up our columns for a few rows!):</FONT></P>
<P><FONT face="Courier New" size=1><STRONG>SC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ca&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sca<BR>==&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ==========&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ====&nbsp;&nbsp;&nbsp; ====&nbsp;&nbsp;&nbsp; ====&nbsp;&nbsp;&nbsp; ====&nbsp;&nbsp;&nbsp; ====&nbsp;&nbsp;&nbsp; ====<BR>0e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 08 - VK_BACK&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0008&nbsp;&nbsp;&nbsp; 0008&nbsp;&nbsp;&nbsp; 007f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>7c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 09 - VK_TAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0009&nbsp;&nbsp;&nbsp; 0009&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;<BR>1c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0d - VK_RETURN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 000d&nbsp;&nbsp;&nbsp; 000d&nbsp;&nbsp;&nbsp; 000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>01&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1b - VK_ESCAPE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 001b&nbsp;&nbsp;&nbsp; 001b&nbsp;&nbsp;&nbsp; 001b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20 - VK_SPACE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0020&nbsp;&nbsp;&nbsp; 0020&nbsp;&nbsp;&nbsp; 0020&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>0b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 30 - VK_0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00e0&nbsp;&nbsp;&nbsp; 0030&nbsp;&nbsp;&nbsp; 0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 0040&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31 - VK_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0026&nbsp;&nbsp;&nbsp; 0031&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 32 - VK_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00e9&nbsp;&nbsp;&nbsp; 0032&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 007e@&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33 - VK_3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 007e 0022&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0033&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 0023&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>05&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 34 - VK_4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0027&nbsp;&nbsp;&nbsp; 0034&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 007b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>06&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 35 - VK_5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0028&nbsp;&nbsp;&nbsp; 0035&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 001b&nbsp;&nbsp;&nbsp; 005b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 36 - VK_6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002d&nbsp;&nbsp;&nbsp; 0036&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 001f&nbsp;&nbsp;&nbsp; 007c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 37 - VK_7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00e8&nbsp;&nbsp;&nbsp; 0037&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 0060@&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>09&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 38 - VK_8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0060 005f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0038&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 001c&nbsp;&nbsp;&nbsp; 005c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>0a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 39 - VK_9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00e7&nbsp;&nbsp;&nbsp; 0039&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 001e&nbsp;&nbsp;&nbsp; 005e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 41 - VK_A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0061&nbsp;&nbsp;&nbsp; 0041&nbsp;&nbsp;&nbsp; 0001&nbsp;&nbsp;&nbsp; 0001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 42 - VK_B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0062&nbsp;&nbsp;&nbsp; 0042&nbsp;&nbsp;&nbsp; 0002&nbsp;&nbsp;&nbsp; 0002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>2e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 43 - VK_C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0063&nbsp;&nbsp;&nbsp; 0043&nbsp;&nbsp;&nbsp; 0003&nbsp;&nbsp;&nbsp; 0003&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 44 - VK_D&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0064&nbsp;&nbsp;&nbsp; 0044&nbsp;&nbsp;&nbsp; 0004&nbsp;&nbsp;&nbsp; 0004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 45 - VK_E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0065&nbsp;&nbsp;&nbsp; 0045&nbsp;&nbsp;&nbsp; 0005&nbsp;&nbsp;&nbsp; 0005&nbsp;&nbsp;&nbsp; 20ac&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 46 - VK_F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0066&nbsp;&nbsp;&nbsp; 0046&nbsp;&nbsp;&nbsp; 0006&nbsp;&nbsp;&nbsp; 0006&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 47 - VK_G&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0067&nbsp;&nbsp;&nbsp; 0047&nbsp;&nbsp;&nbsp; 0007&nbsp;&nbsp;&nbsp; 0007&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 48 - VK_H&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0068&nbsp;&nbsp;&nbsp; 0048&nbsp;&nbsp;&nbsp; 0008&nbsp;&nbsp;&nbsp; 0008&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>17&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 49 - VK_I&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0069&nbsp;&nbsp;&nbsp; 0049&nbsp;&nbsp;&nbsp; 0009&nbsp;&nbsp;&nbsp; 0009&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4a - VK_J&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006a&nbsp;&nbsp;&nbsp; 004a&nbsp;&nbsp;&nbsp; 000a&nbsp;&nbsp;&nbsp; 000a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4b - VK_K&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006b&nbsp;&nbsp;&nbsp; 004b&nbsp;&nbsp;&nbsp; 000b&nbsp;&nbsp;&nbsp; 000b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>26&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4c - VK_L&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006c&nbsp;&nbsp;&nbsp; 004c&nbsp;&nbsp;&nbsp; 000c&nbsp;&nbsp;&nbsp; 000c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4d - VK_M&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006d&nbsp;&nbsp;&nbsp; 004d&nbsp;&nbsp;&nbsp; 000d&nbsp;&nbsp;&nbsp; 000d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4e - VK_N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006e&nbsp;&nbsp;&nbsp; 004e&nbsp;&nbsp;&nbsp; 000e&nbsp;&nbsp;&nbsp; 000e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>18&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4f - VK_O&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 006f&nbsp;&nbsp;&nbsp; 004f&nbsp;&nbsp;&nbsp; 000f&nbsp;&nbsp;&nbsp; 000f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>19&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50 - VK_P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0070&nbsp;&nbsp;&nbsp; 0050&nbsp;&nbsp;&nbsp; 0010&nbsp;&nbsp;&nbsp; 0010&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>1e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 51 - VK_Q&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0071&nbsp;&nbsp;&nbsp; 0051&nbsp;&nbsp;&nbsp; 0011&nbsp;&nbsp;&nbsp; 0011&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 52 - VK_R&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0072&nbsp;&nbsp;&nbsp; 0052&nbsp;&nbsp;&nbsp; 0012&nbsp;&nbsp;&nbsp; 0012&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>1f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 53 - VK_S&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0073&nbsp;&nbsp;&nbsp; 0053&nbsp;&nbsp;&nbsp; 0013&nbsp;&nbsp;&nbsp; 0013&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 54 - VK_T&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0074&nbsp;&nbsp;&nbsp; 0054&nbsp;&nbsp;&nbsp; 0014&nbsp;&nbsp;&nbsp; 0014&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 55 - VK_U&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0075&nbsp;&nbsp;&nbsp; 0055&nbsp;&nbsp;&nbsp; 0015&nbsp;&nbsp;&nbsp; 0015&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>2f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 56 - VK_V&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0076&nbsp;&nbsp;&nbsp; 0056&nbsp;&nbsp;&nbsp; 0016&nbsp;&nbsp;&nbsp; 0016&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>2c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 57 - VK_W&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0077&nbsp;&nbsp;&nbsp; 0057&nbsp;&nbsp;&nbsp; 0017&nbsp;&nbsp;&nbsp; 0017&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>2d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 58 - VK_X&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0078&nbsp;&nbsp;&nbsp; 0058&nbsp;&nbsp;&nbsp; 0018&nbsp;&nbsp;&nbsp; 0018&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 59 - VK_Y&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0079&nbsp;&nbsp;&nbsp; 0059&nbsp;&nbsp;&nbsp; 0019&nbsp;&nbsp;&nbsp; 0019&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5a - VK_Z&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 007a&nbsp;&nbsp;&nbsp; 005a&nbsp;&nbsp;&nbsp; 001a&nbsp;&nbsp;&nbsp; 001a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6a - VK_MULTIPLY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002a&nbsp;&nbsp;&nbsp; 002a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>4e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6b - VK_ADD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002b&nbsp;&nbsp;&nbsp; 002b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>4a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6d - VK_SUBTRACT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002d&nbsp;&nbsp;&nbsp; 002d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>1b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ba - VK_OEM_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0024&nbsp;&nbsp;&nbsp; 00a3&nbsp;&nbsp;&nbsp; 001d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 00a4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>0d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bb - VK_OEM_PLUS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 003d&nbsp;&nbsp;&nbsp; 002b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 007d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bc - VK_OEM_COMMA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002c&nbsp;&nbsp;&nbsp; 003f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>33&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; be - VK_OEM_PERIOD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 003b&nbsp;&nbsp;&nbsp; 002e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bf - VK_OEM_2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 003a&nbsp;&nbsp;&nbsp; 002f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>28&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c0 - VK_OEM_3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00f9&nbsp;&nbsp;&nbsp; 0025&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>0c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; db - VK_OEM_4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0029&nbsp;&nbsp;&nbsp; 00b0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp; 005d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>2b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dc - VK_OEM_5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 002a&nbsp;&nbsp;&nbsp; 00b5&nbsp;&nbsp;&nbsp; 001c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>1a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dd - VK_OEM_6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 005e@&nbsp;&nbsp; 00a8@&nbsp;&nbsp; 001b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>29&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; de - VK_OEM_7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 00b2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>35&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; df - VK_OEM_8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0021&nbsp;&nbsp;&nbsp; 00a7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; e2 - VK_OEM_102&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 003c&nbsp;&nbsp;&nbsp; 003e&nbsp;&nbsp;&nbsp; 001c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1</STRONG></FONT></P>
<P><FONT face=Tahoma>And there we have it -- all of the easy shift states in a nice grid.</FONT></P>
<P><FONT face=Tahoma>Items for future posts (not necessarily in this order!):</FONT></P><FONT face=Tahoma>
<LI><FONT face=Tahoma>the base characters that go with the dead keys and the composite characters they create</FONT> 
<LI><FONT face=Tahoma>the CAPS LOCK key</FONT> 
<LI><FONT face=Tahoma>the harder shift states</FONT> 
<LI>SGCAPS 
<LI><FONT face=Tahoma>chained dead keys</FONT></FONT> 
<P><FONT face=Tahoma>And perhaps a few more goodies if anyone is&nbsp;still reading by then....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT color=#ff1493><FONT face=Tahoma><EM>This post brought to you by</EM> "5" </FONT></FONT><EM><FONT color=#ff1493><FONT face=Tahoma>(</FONT><A href="http://www.fileformat.info/info/unicode/char/0035"><FONT face=Tahoma>U+0035</FONT></A><FONT face=Tahoma>, DIGIT FIVE)<BR><FONT size=1>A Unicode character that is in the very small family of those whose VK value is the same as it's code point!</FONT></FONT></FONT></EM></P></LI>
<hr/><p><a id="6176232" href="#6176232">#</a> <strong>Stuart Dunkeld</strong> on 13 Nov 2007 10:47 AM:</p><div style="margin-left: 1em"><p>This is a great series, it's been extremely useful to me, thank you.</p>
<p>This part doesn't compile though as FillKeyState references fCapsLock which isn't introduced until part 8 or so..</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/04/22 <a href="http://archives.miloush.net/michkap/archive/2006/04/22/581107.html">Getting all you can out of a keyboard layout, Part #10a</a></p><p>2006/04/13 <a href="http://archives.miloush.net/michkap/archive/2006/04/13/575500.html">Getting all you can out of a keyboard layout, Part #9b</a></p><p>2006/04/12 <a href="http://archives.miloush.net/michkap/archive/2006/04/12/575080.html">Getting all you can out of a keyboard layout, Part #9a</a></p><p>2006/04/10 <a href="http://archives.miloush.net/michkap/archive/2006/04/10/570570.html">Getting all you can out of a keyboard layout, Part #8</a></p><p>2006/04/06 <a href="http://archives.miloush.net/michkap/archive/2006/04/06/569632.html">Getting all you can out of a keyboard layout, Part #7</a></p><p>2006/03/31 <a href="http://archives.miloush.net/michkap/archive/2006/03/31/565407.html">Getting all you can out of a keyboard layout, Part #6</a></p><p>2006/03/29 <a href="http://archives.miloush.net/michkap/archive/2006/03/29/562606.html">Is the CAPS LOCK on?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/03/28/561725.html" title="Only ONE WCHAR per dead key">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/03/27/562220.html" title="Technical jargon bordering on a new dialect?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/28/561541.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>