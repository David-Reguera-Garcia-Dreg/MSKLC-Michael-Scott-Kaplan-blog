<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/11/549624.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If you don't commit, you may not get what you want</title></head><body>
<h1>If you don't commit, you may not get what you want</h1>
<p><em>by Michael S. Kaplan, published on 2006/03/11 16:36 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/03/11/549624.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma><EM>(No, this is not a post about relationship advice!)</EM></FONT></P>
<P><FONT face=Tahoma>The other day, Karthik asked:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Hi Michael,<BR><BR>The issue is: GetWindowTextLength returns 0 for any edit control that has Chinese Pinyin IME or Japanese IME characters in it.... GetWindowText also returns nothing. Hiding the field not make these characters disappear....<BR><BR>...This is an issue with many dialog boxes hosted in property sheets that I looked around at. It malfunctions with in certain ways with other dialogs also.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The issue here is that when you first type text using an IME, it is not yet in the underlying control that has the focus.</FONT></P>
<P><FONT face=Tahoma>Let's say you are in Notepad and with the Japanese IME&nbsp;in full width katakana mode you type the letters <STRONG>kazuka</STRONG>. What will appear is something like the following:</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/kazuka_pending.jpg"></FONT></P>
<P><FONT face=Tahoma>See that dotted line? It is an important one.</FONT></P>
<P><FONT face=Tahoma>If you hit ENTER now, the text will be committed and then it will be in the underlying control.</FONT></P>
<P><FONT face=Tahoma>If you hit the space bar twice, the candidate window will come up, giving you whatever options are available:</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/kazuka_candidate.jpg"></FONT></P>
<P><FONT face=Tahoma>(in this case all that is available is the Katakana and Hiragana versions of ノチツナノチ&nbsp;a.k.a.&nbsp;<A href="http://www.fileformat.info/info/unicode/char/30ce">30ce</A> <A href="http://www.fileformat.info/info/unicode/char/30c1">30c1</A> <A href="http://www.fileformat.info/info/unicode/char/30c4">30c4</A> <A href="http://www.fileformat.info/info/unicode/char/30ca">30ca</A> <A href="http://www.fileformat.info/info/unicode/char/30ce">30ce</A> <A href="http://www.fileformat.info/info/unicode/char/30c1">30c1</A>)</FONT></P>
<P><FONT face=Tahoma>Once you either hit that initial ENTER key or choose from the candidate window, you will have text in the underlying control.</FONT></P>
<P><FONT face=Tahoma>But until then, any call to functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/getwindowtext.asp">GetWindowText</A>&nbsp;will not return this&nbsp;text and functions like&nbsp;<A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowfunctions/getwindowtextlength.asp">GetWindowTextLength</A> will return 0. Other operations such as trying to hide control text will have other result consistent with the fact that control itself has not yet been given the text.</FONT></P>
<P><FONT face=Tahoma>Because when you are using the IME, just as in life, you often have to commit before you can get what you are looking for....</FONT></P>
<P><FONT face=Tahoma>(Some other day I will talk more about what to do if you want the interim text in the IME)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "ツ" <EM>(<A href="http://www.fileformat.info/info/unicode/char/30c4">U+30c4</A>, a.k.a. KATAKANA LETTER TU)</EM></FONT></P>
<hr/><p><a id="571804" href="#571804">#</a> <strong>Michael F</strong> on 9 Apr 2006 3:03 AM:</p><div style="margin-left: 1em">The next question is:<br><br>How do you commit programatically after using SendInput to send unicode characters to another process' window?<br><br>Not even sure why IME is getting involved when I am sending exactly what I want to see.</div>
<p><a id="571807" href="#571807">#</a> <strong>Michael S. Kaplan</strong> on 9 Apr 2006 3:09 AM:</p><div style="margin-left: 1em">Bypassing the IME is not something easily done; a commit would have to be done via the IMM API or the TSF interfaces.<br><br>I usually find it easier to switch keyboard layouts and then switch back, sll things considered (since every IME is different).</div>
<p><a id="571815" href="#571815">#</a> <strong>Michael F</strong> on 9 Apr 2006 4:47 AM:</p><div style="margin-left: 1em">I've tried it all (except TSF, I need to support Win2K) but nothing seems to solve the problem.<br><br>Does your approach work when input is sent to another process?</div>
<p><a id="571861" href="#571861">#</a> <strong>Michael S. Kaplan</strong> on 9 Apr 2006 10:00 AM:</p><div style="margin-left: 1em">Hi Michael,<br><br>Well, you would have to inject yourself into that other thread (say via a SetWindowsHookEx WH_CALLWNDPROC hook), change the layout, send yourself a message with the input, send the input, change the layout back, and unhook yourself....<br><br>Though the more I think about it, the more concerned I get about what you are trying to do here -- it seems a bit dangerous/insecure to be inserting random text into some other thread of some other process?</div>
<p><a id="572005" href="#572005">#</a> <strong>Michael F</strong> on 9 Apr 2006 2:51 PM:</p><div style="margin-left: 1em">It's not random. &nbsp;We're developing an SSO application that inserts user-defined input into applications on demand.<br><br>Up until multi-byte languages everything was working as expected. &nbsp;I was hoping to avoid any kind of hooking for the purpose of inserting characters but it looks like it's unavoidable.<br><br>I am still puzzled by why IME would get involved in this whole process since I am sending unicode characters exactly as I want to see them in the other application.<br><br>Is there a way to determine if whatever I am sending is ending up in the uncomitted state? &nbsp;If I could do that I'd be able to send a VK_RETURN to accept the changes.<br><br>Thanks for your replies,<br>Michael.</div>
<p><a id="572013" href="#572013">#</a> <strong>Michael S. Kaplan</strong> on 9 Apr 2006 3:08 PM:</p><div style="margin-left: 1em">&quot;I am still puzzled by why IME would get involved in this whole process&quot;<br><br>When you are involved at a very low level like the IMM/TSF components, what is given to you does not look any different than any of the myriad of bizarre ways there are to get text into an application (IMM works by being integrated in with USER, and TSF works via those very same sorts of hooks).<br><br>The whole KEYEVENTF_UNICODE thing, I'll be talking more about it another day....</div>
<p><a id="572181" href="#572181">#</a> <strong>Michael F</strong> on 10 Apr 2006 12:05 AM:</p><div style="margin-left: 1em">So, I've tried loading a U.S. English keyboard layout using a hook.<br><br>The problems turned out to be that SendInput either does not post the neccessary messages synchronously or the keyboard messages have lower priority than a registered message I am posting to restore the layout.<br><br>This means I would have to leave the new layout active. &nbsp;Not so great.<br><br>Another small problem is that when I unload the temporary layout, the IMM window does not remove the layout from its list. &nbsp;So, it's possible to see and select the temporary layout after it has been unloaded. &nbsp;Although it has no effect. &nbsp;Bug?</div>
<p><a id="572184" href="#572184">#</a> <strong>Michael S. Kaplan</strong> on 10 Apr 2006 12:14 AM:</p><div style="margin-left: 1em">Well, the WM_CHAR is a notification, not a message -- so it is not blocking. I suspect the unload issue you are hitting might be related to the keyboard quite literally being in use at the moment you try to do the unload....<br><br>Another choice could be that you document the limitation in the app? You can blame MS for it (it's our model for IMEs, after all!).<br><br>It may be worth trying it out in a few different IMEs and modes; I suspect some may work just fine while others will have the uncommitted text.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/03/11/549657.html" title="Was someone still looking for Uniscribe samples?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/03/10/548670.html" title="Setting the location in unattend?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/11/549624.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>