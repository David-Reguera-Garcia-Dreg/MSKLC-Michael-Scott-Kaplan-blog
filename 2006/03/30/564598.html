<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/30/564598.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If at first you don't succeed, there's probably still a bug</title></head><body>
<h1>If at first you don't succeed, there's probably still a bug</h1>
<p><em>by Michael S. Kaplan, published on 2006/03/30 00:01 -08:00, original URI: http://blogs.msdn.com/michkap/archive/2006/03/30/564598.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P><FONT face=Tahoma>Back near the beginning of the month, when I posted about how <STRONG><A HREF="http://archives.miloush.net/michkap/archive/2006/03/07/545097.html">Everybody's doing the wraparound....</A></STRONG>, I talked about how the particular implementation of multiple combining </FONT><FONT face=Tahoma>diacritic weights led to an interesting situation on Windows where the secondary, a.k.a. DW or 'diacritic weight', weight would wrap around.</FONT></P>
<P><FONT face=Tahoma>Regular reader Maurits <A HREF="http://archives.miloush.net/michkap/archive/2006/03/07/545097.html#564145">suggested</A> a real problem that seemed to be possible:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>Hmmm... I just thought of a potentially serious problem with the third method (wrap.) &nbsp;What if the value wraps to 0xfe or 0xfd? &nbsp;Then when you add 2, you get 01 or (worse?) 00. <BR><BR>In particular: <BR><BR>"e" with 15 tildes will have a DW of 15 * 17 which comes to 255; add 2 and you wrap to 1. <BR><BR>"e" with 5 circumflexes and 12 tildes will have a DW of (5 * 10) + (12 * 17) = 254; add 2 and you wrap to 0. <BR><BR>On the other hand, what are the odds of encountering a string with such a diacritically-loaded character? </EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>This was before he had actually tested things out -- once he did, his <A HREF="http://archives.miloush.net/michkap/archive/2006/03/07/545097.html#564274">report</A> was slightly different:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>I was trying to generate an example string that wraparounded (ugh) to 00 or 01, but I couldn't (on Windows 2000) <BR><BR>Maybe I'm trying to solve a problem that doesn't exist? </EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Well, let's back up a second....</FONT></P>
<P><FONT face=Tahoma>He is indeed right, the sort keys never seem to get created with bogus 0x00 or 0x01 weights inserted (therefore the bug Atsushi Enomoto <A HREF="http://archives.miloush.net/michkap/archive/2005/06/15/429279.html#429337">reported</A> still stands alone as the bug that inserts one of these byte sequences when it is not expected!).</FONT></P>
<P><FONT face=Tahoma>(That was another bug found through blogging!)</FONT></P>
<P><FONT face=Tahoma>But that does not mean there is no bug in this case.</FONT></P>
<P><FONT face=Tahoma>Now&nbsp;I suspected there&nbsp;might be a bug here after Maurits reported the original problem -- and after looking at it&nbsp; tonight I managed to find one....</FONT></P>
<P><FONT face=Tahoma>By carefully applying <A HREF="http://archives.miloush.net/michkap/archive/2005/11/12/491519.html"><STRONG>Tester's Axiom #5</STRONG></A> and the knowledge that there is a potentially incorrect issue with the implementation, what can we find out here?</FONT></P>
<P><FONT face=Tahoma>Well, if you look at <A HREF="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html"><STRONG>How to track down collation bugs</STRONG></A>&nbsp;from late last year, you will notice a couple of things:</FONT></P>
<UL>
<LI><FONT face=Tahoma>Most of the points in that post do not apply, and</FONT></LI>
<LI><FONT face=Tahoma>Point #12 leads to some interesting results</FONT></LI></UL>
<P><FONT face=Tahoma>Take the following sample code:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>using System;<BR>using System.Globalization;<BR><BR></STRONG></FONT><FONT face="Courier New"><STRONG>namespace SortTest {<BR>&nbsp;&nbsp;&nbsp; class&nbsp;Class1 {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CompareInfo ci = CompareInfo.GetCompareInfo(0x007f);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stOld= "e";<BR><BR></STRONG></FONT><FONT face="Courier New"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int i = 0; i &lt; 7; i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string st = "e\u0323\u0323" + ((char)(0x031d + i)).ToString();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(string.Compare(stOld, st));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write("\t\t");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(SortKey.Compare(ci.GetSortKey(stOld), </STRONG></FONT><FONT face="Courier New"><STRONG>ci.GetSortKey(st)));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stOld = st;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>}</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The output of this little function (which should be two rows of numbers, where each row contains two values equal to each other) is worth 1000 words....</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=4><STRONG>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1<BR>-1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -1</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>What are the sort key values here? They are:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>\u0065\u0323\u0323\u031d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 fe 01 01 01 00<BR>\u0065\u0323\u0323\u031e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 ff 01 01 01 00<BR>\u0065\u0323\u0323\u031f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 01 01 01 00<BR>\u0065\u0323\u0323\u0320&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 01 01 01 00<BR>\u0065\u0323\u0323\u0321&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 01 01 01 00<BR>\u0065\u0323\u0323\u0322&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 03 01 01 01 00<BR>\u0065\u0323\u0323\u0323&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0e 21 01 04 01 01 01 00</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>So, it looks like functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A> (and its managed equivalent) will consistently wrap around and give expected results, while <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A> for sort keys and <STRONG>its</STRONG> managed equivalent will, in an effort to avoid the problem with embedded invalid bytes will occasionally drop them.</FONT></P>
<P><FONT face=Tahoma>Three bytes are dropped:</FONT></P>
<UL>
<LI><FONT face=Tahoma>0x00 -- reserved for the end of the string;</FONT></LI>
<LI><FONT face=Tahoma>0x01 -- reserved for a sentinel between subsections of the sort key;</FONT></LI>
<LI><FONT face=Tahoma>0x02 -- reserved for the minimal weight with no diacritics, which is dropped when it is not needed as a placeholder for later secondary weights that greater than 0x02.</FONT></LI></UL>
<P><FONT face=Tahoma>As soon as I read that comment, I knew there was a bug here. :-)</FONT></P>
<P><FONT face=Tahoma>(Yet another bug found through blogging!)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6> Ì£</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0323">U+0323</A>, a.k.a. COMBINING DOT BELOW)</EM></FONT></P>
<hr/><p><a id="564953" href="#564953">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 12:01 PM:</p><div style="margin-left: 1em">I've found a minimal string that exhibits this bug:<br><br>&quot;e\x0340\x0345&quot;<br><br>0x0340 is COMBINING GRAVE TONE MARK (Vietnamese)<br><a rel="nofollow" target="_new" href="http://www.fileformat.info/info/unicode/char/340/index.htm">http://www.fileformat.info/info/unicode/char/340/index.htm</a><br><br>0x0345 is COMBINING GREEK YPOGEGRAMMENI (Greek)<br><a rel="nofollow" target="_new" href="http://www.fileformat.info/info/unicode/char/345/index.htm">http://www.fileformat.info/info/unicode/char/345/index.htm</a><br><br>Sort keys:<br><br>e\x0340 sort key: &nbsp;e 21 1 [70] 1 1 1 0<br><br>e\x0345 sort key: &nbsp;e 21 1 [92] 1 1 1 0<br><br>e\x0340\x0345 sort key: &nbsp;e 21 1 [] 1 1 1 0<br><br>(70 - 2) + (92 - 2) + 2 = x100 - wraps to 0.<br><br>I notice U+0349 through U+036f don't have any DW at all on W2K.</div>
<p><a id="564987" href="#564987">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 12:21 PM:</p><div style="margin-left: 1em">There are only two diacritic pairs (so far, as of W2K) that wrap to 0, 1, or 2:<br><br>e\x340\x345: wraps to 0 (as above)<br>e\x341\x345: wraps to 1<br><br>0x0341 is COMBINING ACUTE TONE MARK (Vietnamese)<br><a rel="nofollow" target="_new" href="http://www.fileformat.info/info/unicode/char/341/index.htm">http://www.fileformat.info/info/unicode/char/341/index.htm</a><br><br>To wrap to 2 takes at least three diacritics in the same text element.</div>
<p><a id="564999" href="#564999">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 12:34 PM:</p><div style="margin-left: 1em">&gt; functions like CompareString (and its managed equivalent) will consistently wrap around and give expected results<br><br>I have to disagree... it's not wrapping at all. &nbsp;If it had wrapped, one of the numbers in the first column would have been 1.</div>
<p><a id="565012" href="#565012">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 12:46 PM:</p><div style="margin-left: 1em">Another way the bug sneaks in is to look at pure-diacritic strings... these don't have the free 0x2 from the base character (e)<br><br>These three strings of length two are all incorrectly equal to &quot;&quot;:<br><br>\x0342\x0346<br>\x0342\x0347<br>\x0343\x0346<br></div>
<p><a id="565031" href="#565031">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 1:09 PM:</p><div style="margin-left: 1em">We may need to develop a max. number of comments per reader? :-)<br><br>I should likely have said &quot;wraps cleanly&quot; rather than just &quot;wraps&quot;, as this is what the example showed....<br><br>As for &quot;diacritic only strings&quot;, they are meaningless and therefore prove nothing. :-)</div>
<p><a id="565044" href="#565044">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 1:22 PM:</p><div style="margin-left: 1em">How is CompareString doing the comparison, if it's not using sort keys?<br><br>I could see ameliorating the 00/01/02 issue by doing something like<br><br>while (dw &gt;= 0x100 || dw &lt;= 0x2) { dw = dw % 0x100 + 03; }<br><br>... but the columns would still be different. &nbsp;You'd have:<br><br>-1 -1<br>-1 -1<br>-1 1 (LCMapString wraps... to 03, now, not to 00)<br>-1 -1 (to 04, now, not to 01)<br>-1 -1 (to 05, now, not to 02)<br>-1 -1<br><br>So LCMapString would only be wrong in one place instead of 3.<br><br>But how does CompareString get it right??</div>
<p><a id="565057" href="#565057">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 1:34 PM:</p><div style="margin-left: 1em">CompareString is not exactly using sort keys -- what it ias doing is actually very complex, I'll talk about it in a future blog post....</div>
<p><a id="565096" href="#565096">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 1:59 PM:</p><div style="margin-left: 1em">&quot;something like&quot; should be<br><br>// need &quot;while&quot; rather than &quot;if&quot;... consider 0x1ff<br>// it will only iterate twice at most<br>while (dw &gt;= 0x100) { dw = dw % 0x100 + 0x03 * (dw / 0x100); }<br><br>This is as-monotone-as-possible (wraps are as far as possible apart, monotone in between wraps)</div>
<p><a id="565144" href="#565144">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 3:02 PM:</p><div style="margin-left: 1em">BINGO!!<br><br>I just wasn't trying hard enough. &nbsp;Here's a string that yeilds a sort key with an embedded 0, due to diacritic weight wrapping.<br><br>String: e\x0340\x0345e\x0340<br>Sort key: (e 21 e 21) 1 [0 70] 1 1 1 0<br><br>And here's one with an embedded 1:<br>String: e\x0341\x0345e\x0340<br>Sort key: (e 21 e 21) 1 [1 70] 1 1 1 0<br><br>There's probably a way to make an embedded 2, but that's not such a big deal.<br><br>Note that I had to use my phenomenal psychic ability to decide where to put the []s in the second sort key. ;)</div>
<p><a id="565153" href="#565153">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 3:11 PM:</p><div style="margin-left: 1em">It hit me that LCMapString only dropped TRAILING 02 weights in any category. &nbsp;If it only dropped trailing 02's, it probably only dropped trailing 01's and 00's too. &nbsp;Sho'nuff...</div>
<p><a id="565160" href="#565160">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 3:24 PM:</p><div style="margin-left: 1em">Now you're thinking like a[n international] tester! :-)</div>
<p><a id="565189" href="#565189">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 4:00 PM:</p><div style="margin-left: 1em">Here's a couple sample strings with just tildes and circumflexes. &nbsp;(Note my math is wrong in the second quoted statement in your OP... I was misreading hex as decimal)<br><br>string: e(15 tildes)e(tilde)<br>sort key: (e 21 e 21) 1 [1 13] 1 1 1 0<br><br>string: e(1 circumflex)(14 tildes)e(tilde)<br>sort key: (e 21 e 21) 1 [0 13] 1 1 1 0<br><br>(Tongue-in-cheek mode = ON)<br>Q: What do you get when you combine a base character with a butt-load of diacritics?<br>A: Sometimes, you get a malformed sort key!</div>
<p><a id="565197" href="#565197">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 4:17 PM:</p><div style="margin-left: 1em">Last one...<br><br>string: e(16 circumflexes)e(tilde)<br>sort key: (e 21 e 21) 1 [2 13] 1 1 1 0<br><br>Note this is the same as<br><br>string: ee(tilde)<br>sort key: (e 21 e 21) 1 [2 13] 1 1 1 0<br></div>
<p><a id="565203" href="#565203">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 4:26 PM:</p><div style="margin-left: 1em">&gt; Last one... <br><br>Seems doubtful. :-)<br><br>The key here is looking for useful strings, of course.<br><br>In both the font example and the sorting examples, I am showing holes based on taking an implementations past their reasonable breaking point.... the nature of bugs here are essentially &quot;do something really unreasonable, and then end up with bad results.&quot;</div>
<p><a id="565300" href="#565300">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 6:30 PM:</p><div style="margin-left: 1em">... all right, maybe one more. &nbsp;Or two.<br><br>&gt; looking for useful strings<br><br>Well, here's the list of the 747 two- and three-diacritic sets that overflow to 0 or 1 when combined with a base element:<br><br><a rel="nofollow" target="_new" href="http://www.geocities.com/mvaneerde/dw-overflows.txt">http://www.geocities.com/mvaneerde/dw-overflows.txt</a><br><br>This only considers the 72 combining characters from U+0300 to U+0347 because the other combining characters I tried (U+0348 to U+036F) had zero DW.<br><br>Considering other characters with diacritic weights would expand the list.<br><br>The task is now, it seems, to find one of the 747 triples where all three combining characters are from the same region/discipline*, and all fit on the same character simultaneously. &nbsp;I'm betting that if such a triple exists, it will be from the International Phonetic Alphabet discipline.<br><br>* also allowing neutrals, like U+0332 COMBINING LOW LINE (poor man's underline?)</div>
<p><a id="565324" href="#565324">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 6:59 PM:</p><div style="margin-left: 1em">It seems at least one person has posted on how to use combining characters to decorate otherwise plaintext web posts:<br><br>How to create sÌ¶tÌ¶rÌ¶iÌ¶kÌ¶eÌ¶tÌ¶hÌ¶rÌ¶oÌ¶uÌ¶gÌ¶hÌ¶ and uÌ²nÌ²dÌ²eÌ²rÌ²lÌ²iÌ²nÌ²eÌ²dÌ² text<br><a rel="nofollow" target="_new" href="http://www.epinions.com/content_3826622596">http://www.epinions.com/content_3826622596</a><br><br>(As I post this, &quot;strikethrough&quot; in the title above is -struck-through-, and &quot;underlined&quot; is _underlined_)<br><br>That raises the danger level somewhat.<br><br>For example, this almost seems sensible (from list of 747 above:)<br>229)<br>e<br>0x301 COMBINING ACUTE ACCENT<br>0x332 COMBINING LOW LINE<br>0x345 COMBINING GREEK YPOGEGRAMMENI<br>wraps to 1<br><br>Greek letters can have accents; and small following iotas;* and if this were in an epinions post by someone who read the underline tutorial, it could be underlined.<br><br>If there were another DW character later in the string (or the word,) the sort key for the post (or the word) would have an embedded 1.<br><br>If epinions' full-text search engine used sort keys, the bug would be triggered.<br><br>* U+1FF4 GREEK SMALL LETTER OMEGA WITH OXIA AND YPOGEGRAMMENI <a rel="nofollow" target="_new" href="http://www.fileformat.info/info/unicode/char/1ff4/index.htm">http://www.fileformat.info/info/unicode/char/1ff4/index.htm</a><br><br>So here it is: ÏÌÍÌ²<br><br>Make a string with that text element, and another accented character anywhere after it, and you get a sort key with five 1's.<br><br>String: \x03c9\x0301\x0345\x0332 \x03c9\x0301<br>Sort key: (f 19 7 2 f 19) 1 [1 2 e] 1 1 1 0</div>
<p><a id="565352" href="#565352">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 7:50 PM:</p><div style="margin-left: 1em">I thought you were done?<br><br>Told you.... :-)<br><br>However, strikethough and underlining is for higher level markup, not plain text. And the need to not only misuse Unicode by doing such things but to need to index it with sort keys is a fair indication of piling on misuse of multiple technologies....<br><br>It all gets back to that &quot;meaningful string&quot; issue. Truly!</div>
<p><a id="565362" href="#565362">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 8:08 PM:</p><div style="margin-left: 1em">'K, found another one.<br><br>615)<br>e<br>0x305 COMBINING OVERLINE<br>0x32c COMBINING CARON BELOW<br>0x332 COMBINING LOW LINE<br>wraps to 0<br><br>Hear me out.<br><br>Suppose someone wants to use a username that contains a COMBINING CARON BELOW. &nbsp;(Why? who knows.)<br><br>And let's suppose they stumble onto this &quot;HOWTO: get a box around your name:&quot;<br><a rel="nofollow" target="_new" href="http://www.mpcforum.com/showthread.php?t=105521">http://www.mpcforum.com/showthread.php?t=105521</a><br><br>And let's further suppose that the caron-below is on any character in their username but the last one.<br><br>EVERY username that satisfies those three conditions trips the bug, because all of the characters after the one with the caron have DW.</div>
<p><a id="565365" href="#565365">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 8:11 PM:</p><div style="margin-left: 1em">My name in a box: [MÌÌ¬aÌÌ¬uÌÌ¬rÌÌ¬iÌÌ¬tÌÌ¬sÌÌ¬]</div>
<p><a id="565366" href="#565366">#</a> <strong>Maurits</strong> on Thursday, March 30, 2006 8:14 PM:</p><div style="margin-left: 1em">That would have worked out better if I'd used LOW LINE instead of CARON BELOW (oops)<br><br>Take two: [MÌÌ²aÌÌ²uÌÌ²rÌÌ²iÌÌ²tÌÌ²sÌÌ²]</div>
<p><a id="565368" href="#565368">#</a> <strong>Michael S. Kaplan</strong> on Thursday, March 30, 2006 8:16 PM:</p><div style="margin-left: 1em">Okay, you have convincingly established what I have already said -- if people do stupid things, then bad things will happen. <BR><BR>Easy fix -- don't do stupid things! <BR><BR>You can find as many examples as you want, but I am not sure it actually helping anything, or making anything more readable or understandable.... <BR><BR>Try to focus on ACTUAL TEXT needed for language support, without these IMHO lame websites that give bad advice about trying to put in plain text that which belongs in rich text. <BR><BR>This is what the weights were optimized for....</div>
<p><a id="565733" href="#565733">#</a> <strong>Phylyp</strong> on Friday, March 31, 2006 5:41 AM:</p><div style="margin-left: 1em">This is looking too much like a dialog, so for the sake of other readers, I just wanted to enjoy seeing a different name for the commenter!</div>
<p><a id="566879" href="#566879">#</a> <strong>Tsuyoshi Ito</strong> on Sunday, April 02, 2006 12:59 PM:</p><div style="margin-left: 1em">Hi,<br>This looks more than a wraparound issue to me. You are doing a wrong thing when you add &quot;values&quot; of combining characters to calculate a sort key.<br>For example, two strings U+0063 U+0307 U+030D and U+0063 U+0308 have the same sort key (0E 21 01 13 01 01 01 00). According to the mechanism to calculate sort keys you explained in the earlier entry &quot;Everybody's doing the wraparound....&quot;, apparently this has nothing to do with wraparound.<br>Moreover, string.Compare returns 0 when you compare these two strings. In other words, string.Compare(&quot;e\u0307\u030D&quot;, &quot;e\u0308&quot;, true, CultureInfo.InvariantCulture) gives 0.<br>I obtained these results by a small C# program written with Visual Studio 2005 on Windows XP SP2 Japanese. I am not familier with the .NET CLI environment, but this is not desirable, is it?<br><br>By the way, I have been reading your blog for a few months but this is the first time I post a comment. Let me thank you for writing many interesting topics. I especially like Every Character Has a Story entries.<br><br>- Tsuyoshi</div>
<p><a id="566926" href="#566926">#</a> <strong>Michael S. Kaplan</strong> on Sunday, April 02, 2006 3:59 PM:</p><div style="margin-left: 1em">Hello Tsuyoshi-san,<br><br>There are of course other issues that come into play here -- in the case you pointed out it is the fact that each combining mark has a specific DW and the numbers under 0307 + 030d happen to equal 0308.<br><br>Now that is not the wraparound issue, but it is the same basic issue with weights.<br><br>I should probably cover the wider topic a bit more, since it is potentially a lot more relevant to people than the admittedly rare wraparound issue....<br><br>Glad you are enjoying the blog! :-)</div>
<p><a id="567043" href="#567043">#</a> <strong>Maurits</strong> on Monday, April 03, 2006 12:15 AM:</p><div style="margin-left: 1em">Wow... to solve that issue you'd almost need to give each diacritic its own byte in the sort key. &nbsp;Might need sentinels anyway to mark multiply-diacritic'd characters so that they sort correctly:<br>e(e'^) &lt; (e')(e^) &lt; (e'^)e<br><br>Currently:<br>... 01 [2 2+'+^] 01 ... &lt; ... 01 [2+' 2+^] 01 ... &lt; ... 01 [2+'+^ 2] 01 ...<br><br>But without being able to add diacritics... hmm... sentinels to the rescue...<br><br>... 01 [2 ff 2 ' ^] 01 ... &lt; ... 01 [ 2+' 2+^] 01 ... &lt; ... 01 [ ff 2 ' ^ 2 ] 01 ...<br><br>where the &quot;ff 2&quot; means:<br>ff: this character has multiple diacritics<br>2: this character has, in particular, two diacritics<br>' and ^ are the diacritic weights<br><br>The sort key is much longer this way, alas.<br><br>Question: reorder diacritics that are on the same base character in some standard fashion? If so, that would allow e'^ == e^'.</div>
<p><a id="567044" href="#567044">#</a> <strong>Michael S. Kaplan</strong> on Monday, April 03, 2006 12:20 AM:</p><div style="margin-left: 1em">Well, luckily that sort of problem stays theoretical since I do not know of any attested single language usage of both orders of two diacritics on a letter. :-)</div>
<p><a id="567063" href="#567063">#</a> <strong>Tsuyoshi Ito</strong> on Monday, April 03, 2006 1:42 AM:</p><div style="margin-left: 1em">It seems the problem is I did not know what the invariant culture is. I should have searched &quot;invariant culture&quot; on your blog and read any entries before I post. Sorry for a noise.<br><br>My current understanding is that if there is a culture where both &quot;e\u0307\u030D&quot; and &quot;e\u0308&quot; are used, then they have differnt sort keys and they compare as different strings in that culture.<br><br>(And I meant string.Compare(&quot;e\u0307\u030D&quot;, &quot;e\u0308&quot;, false, CultureInfo.InvariantCulture) when I wrote true instead of false.)</div>
<p><a id="567067" href="#567067">#</a> <strong>Michael S. Kaplan</strong> on Monday, April 03, 2006 2:10 AM:</p><div style="margin-left: 1em">Hi Tsuyoshi-san, <br><br>I don't consider it noise -- at the very least, what you are pointing out is a more realistic case than most of the &quot;wrap-around&quot; issues, if for no other reason than it is easier to hit.<br><br>Your understanding is correct -- if a language is being supported that makes such a distinction, then we do the work to make sure that collation will support the requirement. But it still makes for an interesting case, I think....</div>
<p><a id="567544" href="#567544">#</a> <strong>Tsuyoshi Ito</strong> on Monday, April 03, 2006 4:02 PM:</p><div style="margin-left: 1em">Hi Michael, (please call me Tsuyoshi if you like)<br><br>Thank you for the clarification. As you know, I did not know what string.Compare do or what the invariant culture is for when I wrote the first comment. Now I know:<br>- string.Compare(string, string, boolean, CultureInfo) performs a linguistic comparison, which means the two strings must be meaningful in the specified culture; otherwise, the result will be unpredictable or at least difficult to interpret.<br>- Not every string is considered meaningful in the invariant culture.<br><br>Therefore...<br><a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2004/12/29/344136.html">http://blogs.msdn.com/michkap/archive/2004/12/29/344136.aspx</a><br>&gt; That problem remains to this day, though every single time I speak at a conference or answer a question in a newsgroup or get someone to look at posts like this one, then there is at least one less developer who has this problem. Maybe this time it is you? :-)<br>Yay, it's me!<br><br>...sigh. I will never confuse the linguistic comparison in the invariant locale/culture with the ordinal comparison!</div>
<p><a id="567615" href="#567615">#</a> <strong>Michael S. Kaplan</strong> on Monday, April 03, 2006 5:17 PM:</p><div style="margin-left: 1em">Hi Tsuyoshi,<br><br>Great to hear -- welcome to the club!<br><br>(we ought to get shirts or something)</div>
<p><a id="567719" href="#567719">#</a> <strong>Maurits</strong> on Monday, April 03, 2006 7:36 PM:</p><div style="margin-left: 1em">how about this for a T-shirt: <a rel="nofollow" target="_new" href="http://tinyurl.com/rjxyt">http://tinyurl.com/rjxyt</a></div>
<p><a id="567729" href="#567729">#</a> <strong>Michael S. Kaplan</strong> on Monday, April 03, 2006 7:52 PM:</p><div style="margin-left: 1em">I actually own it. But I would not call it a T-shirt for *this* club! :-)</div>
<p><a id="567739" href="#567739">#</a> <strong>Maurits</strong> on Monday, April 03, 2006 8:12 PM:</p><div style="margin-left: 1em">Ah, good point.<br><br>Maybe this then: <a rel="nofollow" target="_new" href="http://tinyurl.com/rzag5">http://tinyurl.com/rzag5</a> :)</div>
<p><a id="567741" href="#567741">#</a> <strong>Maurits</strong> on Monday, April 03, 2006 8:13 PM:</p><div style="margin-left: 1em">grrr... stupid hotlink restrictions.<br><a rel="nofollow" target="_new" href="http://www.geocities.com/mvaneerde/einstein.jpg">http://www.geocities.com/mvaneerde/einstein.jpg</a></div>
<p><a id="567761" href="#567761">#</a> <strong>Michael S. Kaplan</strong> on Monday, April 03, 2006 8:39 PM:</p><div style="margin-left: 1em">Ok, that is flattering. :-) <BR><BR>I am not sure I could really wear it, but if anyone walked up to me wearing that on a T-shirt I would certainly (assuming my head didn't explode!) try to buy that person a drink....</div>
<p><a id="569190" href="#569190">#</a> <strong>Maurits</strong> on Wednesday, April 05, 2006 2:35 PM:</p><div style="margin-left: 1em">&gt; attested single language usage of both orders of two diacritics on a letter<br><br>In physics, a'^ and a^' are two different things[1], but that probably doesn't count as a language.<br><br>Edward John Garrett, in his paper about the IPA[2] gives the tantalizing sentence &quot;the order of diacritics is *often* irrelevant&quot; (emphasis mine)<br><br>... but fails to give a counterexample as to when the order of diacritics *is* relevant. &nbsp;That doesn't mean there isn't a counterexample, but it would have been nice if he'd been explicit.<br><br>*ugh*<br><br>It would be much better if diacritic order *did* matter and there was a clear case we could point to. &nbsp;This feels like a trap... (1) invest in a structure of commutative diacritics; (2) five years later some language comes up with a diacritic construct that needs to be uncommutative; (3) tear down the structure and build a new one at terrible cost.<br><br>[1] a'^ is the direction an object is moving (') in three-dimensional space, normalized (^) to a unit vector. &nbsp;a^' is the direction (') an object APPEARS to be moving when viewed from the origin (^). &nbsp;If an object is at (1, 0, 0) and is moving away from the origin, a'^ is (1, 0, 0) and a^' is (0, 0, 0).<br>[2] <a rel="nofollow" target="_new" href="http://altiplano.emich.edu/~egarrett/papers/ejg_CICLing2005.pdf">http://altiplano.emich.edu/~egarrett/papers/ejg_CICLing2005.pdf</a></div>
<p><a id="569201" href="#569201">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, April 05, 2006 2:42 PM:</p><div style="margin-left: 1em">Hi Maurits,<br><br>No need to tear anything down -- any time a language has a requirement, we can customize the sort under that language's LCID to mak sure that there would be no break....<br><br>So no need to tear down anything. :-)</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/10/09 <a href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html">A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/03/31/565407.html" title="Getting all you can out of a keyboard layout, Part #6">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/03/29/562606.html" title="Is the CAPS LOCK on?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03-30">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/30/564598.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>