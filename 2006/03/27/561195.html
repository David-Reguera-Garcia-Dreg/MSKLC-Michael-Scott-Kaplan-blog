<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/27/561195.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Is it a bug?</title></head><body>
<h1>Is it a bug?</h1>
<p><em>by Michael S. Kaplan, published on 2006/03/27 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/03/27/561195.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P><FONT face=Tahoma>Regular readers you can think of this as a part of&nbsp;the <STRONG><A href="http://archives.miloush.net/michkap/">Sorting It All Out</A></STRONG> mid-term.</FONT></P>
<P></FONT><FONT face=Tahoma>Basically we are looking at two calls to CompareString. The first is:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG><FONT face="Courier New" size=5>CompareStringW(0x0409, 0, L"Hello-Bob", -1, L"Hello Bob", -1)</FONT></STRONG></P></BLOCKQUOTE>
<P><FONT face=Tahoma>which returns <FONT face="Courier New"><STRONG>CSTR_GREATER_THAN</STRONG><FONT face=Tahoma>,</FONT></FONT> and the second is:</FONT></P><FONT face="Courier New" size=5>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG>CompareStringW(0x0409, 0, L"-", -1, L" ", -1)</STRONG></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>which returns <FONT face="Courier New"><STRONG>CSTR_LESS_THAN</STRONG></FONT>.</FONT></P>
<P><FONT face=Tahoma>I promise there are no "spoofing" characters or anything else unexpected in the strings, it is literally</FONT></P>
<UL>
<LI><FONT face=Tahoma>a comparison of two almost identical strings and </FONT>
<LI><FONT face=Tahoma>a comparison of two substrings that literally represent the only differences between those two almost identical strings</FONT></LI></UL>
<P><FONT face=Tahoma>The question -- is the difference between the two calls a bug? And if so, then which one is incorrect? And if not, then why?</FONT></P>
<P><FONT face=Tahoma>Answers will be graded for accuracy, or short of that for&nbsp;how convincing the provided expository bullshit is, in&nbsp;an otherwise&nbsp;inaccurate answer....</FONT></P>
<P><FONT face=Tahoma><EM>(All posts will be moderated unless they do not give away the answers!)</EM></FONT></P>
<hr/><p><strong>Phylyp</strong> on 27 Mar 2006 5:52 AM:</p><div style="margin-left: 1em">Accuracy: 0% Bullshit: probably 100% <br><br>Is it the fact that the &quot; &quot; and &quot;-&quot; are in difference Unicode subcategories (punctuation vs. separator)? </div>
<p><strong>nat</strong> on 27 Mar 2006 6:52 AM:</p><div style="margin-left: 1em">it's not a bug i guess...<br><br><a rel="nofollow" target="_new" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp</a><br><br>Typically, strings are compared using what is called a &quot;word sort&quot; technique. In a word sort, all punctuation marks and other nonalphanumeric characters, except for the hyphen and the apostrophe, come before any alphanumeric character. The hyphen and the apostrophe are treated differently than the other nonalphanumeric symbols, in order to ensure that words such as &quot;coop&quot; and &quot;co-op&quot; stay together within a sorted list. <br><br>If the SORT_STRINGSORT flag is specified, strings are compared using what is called a &quot;string sort&quot; technique. In a string sort, the hyphen and apostrophe are treated just like any other nonalphanumeric symbols. Their positions in the collating sequence are before the alphanumeric symbols. <br></div>
<p><strong>Nick Lamb</strong> on 27 Mar 2006 9:17 AM:</p><div style="margin-left: 1em">A self-consistent, reproducible result from a localised collation function is a bug if and only if it conflicts with the reasonable expectations of the users of that locale in the context of the collation. If all the users disagree, you have a bug. If a substantial population of users disagree then in fact you have one or more new groups who might need a new locale.<br><br>You'll need some native English speaking Americans. My guess is that they don't care either way, and so the current collation is not a bug.</div>
<p><strong>Maurits [MSFT]</strong> on 27 Mar 2006 1:14 PM:</p><div style="margin-left: 1em">There's no bug. &nbsp;This is a documented feature called &quot;word sort&quot;. &nbsp;To avoid it, use SORT_STRINGSORT in dwCmpFlags.<br><br><a rel="nofollow" target="_new" href="http://tinyurl.com/t4k4">http://tinyurl.com/t4k4</a><br>Typically, strings are compared using what is called a &quot;word sort&quot; technique. In a word sort, all punctuation marks and other nonalphanumeric characters, except for the hyphen and the apostrophe, come before any alphanumeric character. The hyphen and the apostrophe are treated differently than the other nonalphanumeric symbols, in order to ensure that words such as &quot;coop&quot; and &quot;co-op&quot; stay together within a sorted list.<br><br>&quot;Hello-Bob&quot; is word-sorted as &quot;HelloBob&quot;, which comes AFTER &quot;Hello Bob&quot;.<br>&quot;-&quot; is word-sorted as &quot;&quot;, which comes BEFORE &quot; &quot;.</div>
<p><strong>Maurits [MSFT]</strong> on 27 Mar 2006 2:28 PM:</p><div style="margin-left: 1em">Some sort key weights...<br><br>&quot;&quot;: 1 1 1 1<br>&quot; &quot;: 7 2 1 1 1 1<br>&quot;-&quot;: 1 1 1 1 128 7 6 130<br>&quot;ab&quot;: 14 2 14 9 1 1 1 1<br>&quot;a b&quot;: 14 2 7 2 14 9 1 1 1 1<br>&quot;a-b&quot;: 14 2 14 9 1 1 1 1 128 11 6 130<br><br>&quot;a&quot; is 14 2<br>&quot;b&quot; is 14 9<br>&quot; &quot; is 7 2<br><br>Note &quot;a-b&quot; sorts as &quot;ab&quot; plus a little bit (128 11 6 130)<br>Note &quot;-&quot; sorts as &quot;&quot; plus that same little bit (128 11 6 130)</div>
<p><strong>Michael S. Kaplan</strong> on 27 Mar 2006 11:36 PM:</p><div style="margin-left: 1em">Ok, Maurits is the one who had the full answer, and nat is the runner up. :-)</div>
<p><strong>Michael S. Kaplan</strong> on 27 Mar 2006 11:41 PM:</p><div style="margin-left: 1em">The trick that causes the difference here is that due to the WORD SORT rules (which happen on all languages, by the way!), the hyphen gets kind of put at the end -- so in actuality the space is being compared to the &quot;B&quot; and of course it will be less than, so string1 will be greater than string2....</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 11:22 AM:</p><div style="margin-left: 1em">The hyphen-and-apostrophe rule makes me think this is for sorting names... so Jo-Anne comes next to Joanne, and O'Brady comes next to OBrady.<br><br>Oops in my previous comment... the &quot;little bit&quot; for &quot;-&quot; is 128 7 6 130, which is not quite the same as the &quot;little bit&quot; for &quot;a-b&quot; (128 11 6 130) (perhaps because of where in the string the hyphen occurs?)<br><br>There are primary weights, secondary weights, and tertiary weights:<br><br>primary weights: a &lt; b<br>secondary weights: a &lt; A<br>tertiary weights: &quot;&quot; &lt; ' &lt; -<br><br>These are visible in the sort keys:<br>a: (0e 02) 01 01 [] 01 01 {}<br>a': (0e 02) 01 01 [] 01 01 {80 0b 06 80}<br>a-: (0e 02) 01 01 [] 01 01 {80 0b 06 82}<br>A: (0e 02) 01 01 [12] 01 01 {}<br>A': (0e 02) 01 01 [12] 01 01 {80 0b 06 80}<br>A-: (0e 02) 01 01 [12] 01 01 {80 0b 06 82}<br><br>(primary weight) 01 01 [secondary weight] 01 01 {tertiary weight}<br><br>The x0101 is used as a boundary between weights because (guess mode = ON)<br>* a x00 would terminate the byte array and<br>* x0101 is LESS than any weight -- which is necessary to make shorter strings sort as &quot;less than&quot; longer strings with the same prefix (a &lt; a')<br></div>
<p><strong>Michael S. Kaplan</strong> on 28 Mar 2006 11:27 AM:</p><div style="margin-left: 1em">Actually. primary weights are often alphabetic, secondary weights are often &nbsp;diacritic, tertiary weights are often case, and punctuation in a WORD sort is quaternary, along with other &quot;special weights.&quot;</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 11:49 AM:</p><div style="margin-left: 1em">a: (0e 02) 01 [] 01 {} 01 ? 01 &lt;&gt;<br>a': (0e 02) 01 [] 01 {} 01 ? 01 &lt;80 0b 06 80&gt;<br>&#225;: (0e 02) 01 [0e] 01 {} 01 ? 01 &lt;&gt;<br>A: (0e 02) 01 [] 01 {12} 01 ? 01 &lt;&gt;<br>b: (0e 09) 01 [] 01 {} 01 ? 01 &lt;&gt;<br><br>(primary weight)<br>01<br>[secondary weight]<br>01<br>{tertiary weight}<br>01<br>?missing quaternary weight?<br>01<br>&lt;quaternary or quintary weight&gt;<br><br>primary weight: a &lt; b<br>secondary weight: a &lt; A<br>tertiary weight: a &lt; &#225;<br>quaternary weight: a &lt; a' (in a WORD sort)<br><br>Hmmm... what goes where the question mark is?</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 11:51 AM:</p><div style="margin-left: 1em">Oops, I switched secondary and tertiary weight... in my previous comment: A &lt; &#225;.</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 12:05 PM:</p><div style="margin-left: 1em">&gt; what goes where the question mark is:<br>Ah, here we go:<br><a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/06/15/429279.html">http://blogs.msdn.com/michkap/archive/2005/06/15/429279.aspx</a><br><br>Primary weight is &quot;UW&quot;<br>Secondary weight is &quot;DW&quot;<br>Tertiary weight is &quot;CW&quot;<br>Quaternary weight is &quot;SW&quot;<br>Quintary weight is unnamed (the sort key in that post has nothing between the last 01 and the final 00)<br><br>Alas, SW happens to be empty.<br><br>UW... I got nothing.<br>DW... &quot;diacritic weight&quot;, n'est-pas?<br>CW... &quot;case weight&quot;, perhaps?<br>SW... &quot;something weight&quot; (but WHAT?)<br>(anonymous)... &quot;word sort weight&quot;, if you will</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 12:12 PM:</p><div style="margin-left: 1em">Heh, re-reading the comments to that post, I missed this gem:<br>&quot;some implementations assume the byte array is NULL terminated since it is doc-ed as such&quot;</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 12:41 PM:</p><div style="margin-left: 1em">OK, found UW and SW:<br><a rel="nofollow" target="_new" href="http://download.microsoft.com/download/d/1/8/d18fc51c-1f18-436e-8e1e-312a47353a77/DBA319.ppt">http://download.microsoft.com/download/d/1/8/d18fc51c-1f18-436e-8e1e-312a47353a77/DBA319.ppt</a><br><br>Slide 24:<br>[all Unicode] 0x01 [all Diacritic] 0x01 [all Case] 0x01 [all Special] 0x01 0x0<br><br>So U is Unicode, and S is Special.<br><br>Slide 26 has examples of strings with SW... but I can't copy them :'(</div>
<p><strong>Maurits [MSFT]</strong> on 28 Mar 2006 12:48 PM:</p><div style="margin-left: 1em">Here's a screenshot (from PowerPoint Viewer 2003 on Windows 2000)<br><br><a rel="nofollow" target="_new" href="http://www.geocities.com/mvaneerde/sw-example.gif">http://www.geocities.com/mvaneerde/sw-example.gif</a></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/03/27/561353.html" title="Getting all you can out of a keyboard layout, Part #4">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/03/26/561016.html" title="Non-default paths and instructions....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03-27">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/27/561195.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>