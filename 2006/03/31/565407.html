<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/31/565407.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting all you can out of a keyboard layout, Part #6</title></head><body>
<h1>Getting all you can out of a keyboard layout, Part #6</h1>
<p><em>by Michael S. Kaplan, published on 2006/03/31 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/03/31/565407.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Previous posts in this series: Parts <A href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html"><STRONG>0</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/23/558674.html"><STRONG>1</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/24/558715.html"><STRONG>2</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/24/559169.html"><STRONG>3</STRONG></A>, <A href="http://archives.miloush.net/michkap/archive/2006/03/27/561353.html"><STRONG>4</STRONG></A> and <A href="http://archives.miloush.net/michkap/archive/2006/03/28/561541.html"><STRONG>5</STRONG></A>.</FONT></P>
<P><FONT face=Tahoma>It is funny when I do posts like these and find that although they get a lot of comments, they do get a lot of hits. Of course that could mean that people don't find them helpful so they move on to the next site. :-)</FONT></P>
<P><FONT face=Tahoma>Anyway, if you look at the first six posts, between them all of the "basics" are covered; everything from here on in gets a little molre complicated. Mainly because most of the additional information is more complicated....</FONT></P>
<P><FONT face=Tahoma>We'll start with the small issue I mentioned earlier about using Scan Codes versus using Virtual Keys. The problem is that as a rule there is not a 100% round trip between them, and the strange behavior can happen when you move between VK and SC, not the other way around.</FONT></P>
<P><FONT face=Tahoma>So if I take the following code:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Courier New" size=1><STRONG>for(KeysEx ke = KeysEx.VK_NUMPAD0; ke &lt;= KeysEx.VK_NUMPAD9; ke++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint sc02 = MapVirtualKeyEx((uint)ke, 0, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint vk02 = MapVirtualKeyEx(sc02, 1, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint sc03 = MapVirtualKeyEx(vk02, 0, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint vk03 = MapVirtualKeyEx(sc03, 1, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint sc04 = MapVirtualKeyEx(vk03, 0, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint vk04 = MapVirtualKeyEx(sc04, 1, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine("{0} == {1:x2} -&gt; {2:x2} -&gt; {3:x2} -&gt; {4:x2} -&gt; {5:x2} -&gt; {6:x2} -&gt; {7:x2} == {8}", <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ke, ((uint)ke).ToString("x2"), sc02, vk02, sc03, vk03, sc04, vk04,((KeysEx)vk04));<BR>}</STRONG></FONT></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>then the output will be:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>VK_NUMPAD0 == 60 -&gt; 52 -&gt; 2d -&gt; 52 -&gt; 2d -&gt; 52 -&gt; 2d == VK_INSERT<BR>VK_NUMPAD1 == 61 -&gt; 4f -&gt; 23 -&gt; 4f -&gt; 23 -&gt; 4f -&gt; 23 == VK_END<BR>VK_NUMPAD2 == 62 -&gt; 50 -&gt; 28 -&gt; 50 -&gt; 28 -&gt; 50 -&gt; 28 == VK_DOWN<BR>VK_NUMPAD3 == 63 -&gt; 51 -&gt; 22 -&gt; 51 -&gt; 22 -&gt; 51 -&gt; 22 == VK_NEXT<BR>VK_NUMPAD4 == 64 -&gt; 4b -&gt; 25 -&gt; 4b -&gt; 25 -&gt; 4b -&gt; 25 == VK_LEFT<BR>VK_NUMPAD5 == 65 -&gt; 4c -&gt; 0c -&gt; 4c -&gt; 0c -&gt; 4c -&gt; 0c == VK_CLEAR<BR>VK_NUMPAD6 == 66 -&gt; 4d -&gt; 27 -&gt; 4d -&gt; 27 -&gt; 4d -&gt; 27 == VK_RIGHT<BR>VK_NUMPAD7 == 67 -&gt; 47 -&gt; 24 -&gt; 47 -&gt; 24 -&gt; 47 -&gt; 24 == VK_HOME<BR>VK_NUMPAD8 == 68 -&gt; 48 -&gt; 26 -&gt; 48 -&gt; 26 -&gt; 48 -&gt; 26 == VK_UP<BR>VK_NUMPAD9 == 69 -&gt; 49 -&gt; 21 -&gt; 49 -&gt; 21 -&gt; 49 -&gt; 21 == VK_PRIOR</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>You can see how the journey from VK <FONT color=#ff0000><STRONG>to</STRONG></FONT> SC to VK to SC to VK clearly has some round tripping issues, basically at the point I marked in red, at that first transition.</FONT></P>
<P><FONT face=Tahoma>Now, if you think about how these keys are mapped, you'll see a pattern in what is happening here:</FONT></P>
<P><FONT face="Courier New"><STRONG>7&nbsp; &nbsp;&nbsp;&nbsp; 8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Home&nbsp; Up&nbsp;&nbsp;&nbsp; PgUp<BR>4&nbsp;&nbsp;&nbsp; &nbsp; 5&nbsp;&nbsp;&nbsp; &nbsp; 6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Left&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Right<BR>1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2&nbsp; &nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; End&nbsp;&nbsp;&nbsp;Down&nbsp; PgDown<BR>0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ins</STRONG></FONT></P>
<P><FONT face=Tahoma>Suddenly what is happening becomes clear, doesn't it? :-)</FONT></P>
<P><FONT face=Tahoma>What is more, you do not need to have the NUMLOCK key toggled to get the VK_NUMPAD# Virtual Key values to give you numbers either -- they always work.</FONT></P>
<P><FONT face=Tahoma>And&nbsp;to stay&nbsp;consistently inconsistent with the rest of the keyboard,&nbsp;other VK values with the VK_NUMLOCK toggled don'e return numbers.</FONT></P>
<P><FONT face=Tahoma>So, the advantage to using Scan Codes for most of the keyboard is that you are appropriately limiting yourself to keys that are expected to exist. Though to get all of the keys on the keyboard there are as few that you will need to handle via VK values anyway....</FONT></P>
<P><FONT face=Tahoma>So what we will insert into our keyboard code is a little bit of info to get the keys that we cannot get via Scan Code alone (new code in black):</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG><FONT size=2><FONT color=#808080>// Scroll through the Scan Code (SC) values and get the valid Virtual Key (VK)<BR>// values in it. Then, store the SC in each valid VK so it can act as both a <BR>// flag that the VK is valid, and it can store the SC value.<BR>for(uint sc = 0x01; sc &lt;= 0x7f; sc++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;uint vk = MapVirtualKeyEx(sc, 1, hkl);<BR>&nbsp;&nbsp;&nbsp;&nbsp;if(vk != 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rgScOfVk[vk] = sc;<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR>}</FONT><BR><BR></FONT></STRONG></FONT><FONT face="Courier New" size=2><STRONG>// add the special keys that do not get added from the code above<BR>for(KeysEx ke = KeysEx.VK_NUMPAD0; ke &lt;= KeysEx.VK_NUMPAD9; ke++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;rgScOfVk[(uint)ke] = MapVirtualKeyEx((uint)ke, 0, hkl);<BR>}<BR>rgScOfVk[(uint)KeysEx.VK_DECIMAL] = MapVirtualKeyEx((uint)KeysEx.VK_DECIMAL, 0, hkl);<BR>rgScOfVk[(uint)KeysEx.VK_DIVIDE] = MapVirtualKeyEx((uint)KeysEx.VK_DIVIDE, 0, hkl);<BR>rgScOfVk[(uint)KeysEx.VK_CANCEL] = MapVirtualKeyEx((uint)KeysEx.VK_CANCEL, 0, hkl);</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now, just in case any of this is making sense, I'll close with some #defines in kbd.h:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>#define SCANCODE_NUMPAD_FIRST 0x47<BR>#define SCANCODE_NUMPAD_LAST&nbsp; 0x52</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>I think we have already established that most of the Scan Codes do not fit in this range (not to mention the fact that 0x47 to 0x52 would be <STRONG>eleven</STRONG> keys, not ten!). At this point I still have no idea what these are for, if not solely to confuse -- I did find it used a few places in the Windows source but clearly they are not meant for most people since the functions that come out of user32.dll do not ever provide them.</FONT></P>
<P><FONT face=Tahoma>Coming up, even weirder stuff....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT color=#ff1493><FONT face=Tahoma><EM>This post brought to you by</EM> "6" </FONT></FONT><EM><FONT color=#ff1493><FONT face=Tahoma>(</FONT><A href="http://www.fileformat.info/info/unicode/char/0036"><FONT face=Tahoma>U+0036</FONT></A><FONT face=Tahoma>, DIGIT SIX)<BR><FONT size=1>A Unicode character that is in the very small family of those whose VK value is the same as it's code point!</FONT></FONT></FONT></EM></P>
<hr/><p><a id="565735" href="#565735">#</a> <strong>Phylyp</strong> on 31 Mar 2006 5:47 AM:</p><div style="margin-left: 1em">&gt; that could mean that people don't find them helpful so they move on to the next site <br>If others are like me... they get too engrossed meddling with the code you've provided. I do, until I'm reminded (by self or others) that I'm at work :) </div>
<p><a id="566024" href="#566024">#</a> <strong>Mihai</strong> on 31 Mar 2006 12:43 PM:</p><div style="margin-left: 1em">&quot;Of course that could mean that people don't find them helpful so they move on to the next site.&quot;<br><br>Or it means it is interesting, so ppl just shut up an listen (like you do for a good movie :-)<br></div>
<p><a id="566064" href="#566064">#</a> <strong>Mihai</strong> on 31 Mar 2006 1:55 PM:</p><div style="margin-left: 1em">for(uint sc = 0x01; sc &lt;= 0x7f; sc++) {<br><br>Enumerating only to 0x7F seems a bit arbitrary to me.<br><br>There are a bunch of scancodes above 0x7f that do not map to VK codes, is true, but are still valid.<br>They return good info with GetKeyNameText, for instance (ie 0x137 =&gt; &quot;Prnt Scrn&quot;, 0x138 =&gt; &quot;Right Alt&quot;).<br></div>
<p><a id="566411" href="#566411">#</a> <strong>Maurits [MSFT]</strong> on 1 Apr 2006 2:58 AM:</p><div style="margin-left: 1em">Actually, 0x47 to 0x52 is twelve keys.</div>
<p><a id="566420" href="#566420">#</a> <strong>Maurits [MSFT]</strong> on 1 Apr 2006 3:42 AM:</p><div style="margin-left: 1em">This is a bit of a stretch, but...<br><br>It may be that FIRST and LAST don't refer to a range (twelve keys is still too few) but rather to the layout of the number pad.<br><br>Check out the layout of the Apple Extended Keyboard (I know, I know, this is really a stretch. &nbsp;But keep reading until the end of this comment...)<br><br><a rel="nofollow" target="_new" href="http://www.wasd.k12.pa.us/schools/fairview/Gayle/tn5250 folder/Mocha TN5250 Help">http://www.wasd.k12.pa.us/schools/fairview/Gayle/tn5250%20folder/Mocha%20TN5250%20Help</a><br><br>Notice that the first key in the FIRST row of the number pad (&quot;clear&quot;) has scan code 0x47.<br>Notice that the first key in the LAST row of the number pad (&quot;0&quot;) has scan code 0x52.<br><br>#define SCANCODE_NUMPAD_FIRST 0x47<br>#define SCANCODE_NUMPAD_LAST &nbsp;0x52</div>
<p><a id="566473" href="#566473">#</a> <strong>Michael S. Kaplan</strong> on 1 Apr 2006 6:24 AM:</p><div style="margin-left: 1em">I'd be more convinced if it were from the top left to the bottom right? :-)<br><br>Just kidding -- this may well be what is meant here....</div>
<p><a id="6801000" href="#6801000">#</a> <strong>jennico</strong> on 18 Dec 2007 7:50 PM:</p><div style="margin-left: 1em"><p>well, the use of the scan codes is quite clear. if you want to make a script, that uses hoteys, working no matter of the kb layout you will have to refer to scan codes. so you can emulate a certain char to any key no matter if it is a cirillic, arabic or western keyboard, even no matter if qwerty, qwertz or azerty. that is the point of globalized programming. &nbsp;j.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/07/04 <a href="http://archives.miloush.net/michkap/archive/2007/07/04/3690200.html">Pimping the numeric keypad</a></p><p>2006/09/14 <a href="http://archives.miloush.net/michkap/archive/2006/09/14/754162.html">Why doesn't MSKLC have a numeric keypad?</a></p><p>2006/04/22 <a href="http://archives.miloush.net/michkap/archive/2006/04/22/581107.html">Getting all you can out of a keyboard layout, Part #10a</a></p><p>2006/04/13 <a href="http://archives.miloush.net/michkap/archive/2006/04/13/575500.html">Getting all you can out of a keyboard layout, Part #9b</a></p><p>2006/04/12 <a href="http://archives.miloush.net/michkap/archive/2006/04/12/575080.html">Getting all you can out of a keyboard layout, Part #9a</a></p><p>2006/04/10 <a href="http://archives.miloush.net/michkap/archive/2006/04/10/570570.html">Getting all you can out of a keyboard layout, Part #8</a></p><p>2006/04/06 <a href="http://archives.miloush.net/michkap/archive/2006/04/06/569632.html">Getting all you can out of a keyboard layout, Part #7</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/02/567003.html" title="Punctuation keys can make lousy shortcuts">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/03/30/564598.html" title="If at first you don&#39;t succeed, there&#39;s probably still a bug">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-03-31">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/03/31/565407.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>