<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/22/581356.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Unicode? Zip don't need no stinking Unicode!</title></head><body>
<h1>Unicode? Zip don't need no stinking Unicode!</h1>
<p><em>by Michael S. Kaplan, published on 2006/04/22 13:48 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/04/22/581356.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>I have talked about the limitations in ZIP before in the post <STRONG><A HREF="http://archives.miloush.net/michkap/archive/2005/05/10/416181.html">Zipping up Unicode file names</A></STRONG>, but <A href="http://blogs.msdn.com/heaths/">Heath</A> has pointed out a new and interesting wrinkle in the problem in his post <A HREF="http://blogs.msdn.com/581186.aspx">Update for the Palm Treo 700w Available, with Problems</A>.</FONT></P>
<P><FONT face=Tahoma>Now Heath may seem to some to be some kind of lightning rod for <A href="#12973">Unicode Lame List</A> stories, but he isn't -- he is just a smart developer who is finding himself thrown into bad software situations that he did not design....</FONT></P>
<P><FONT face=Tahoma>In this case we see the biggest problem with not using Unicode -- the basic problem of deciding what code page to use. It is probably not so much that zipfldr.dll is specifically using <A href="http://www.microsoft.com/globaldev/reference/oem/437.mspx">cp437</A> and <A href="http://www.microsoft.com/globaldev/reference/sbcs/1252.mspx">cp1252</A>, it is that it is using CP_OEMCP and CP_ACP.</FONT></P>
<P><FONT face=Tahoma>What causes such a mistake to not get noticed, though? I mean, it is pretty un-natural to be using both constants, isn't it?</FONT></P>
<P><FONT face=Tahoma>As luck (or unluck) would have it, they are not. The problem starts with the Shell folks,&nbsp;are using funky macros wrapped around funky shlwapi wrappers like <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/others/SHAnsiToUnicode.asp">SHAnsiToUnicode</A> and <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/others/SHUnicodeToAnsi.asp">SHUnicodeToAnsi</A>. I call them funky because they are. They are also quite consistent in their underlying use of CP_ACP always.</FONT></P>
<P><FONT face=Tahoma>And as for the rest of the problem, it looks like the CP_OEMCP is coming from the fact that it is a console app that is running things so that some of the translations are happening in this&nbsp;different context....</FONT></P>
<P><FONT face=Tahoma>How smart is Palm feeling for putting <STRONG>™</STRONG> and <STRONG>®</STRONG> in the filename, at this point? No wonder they took the update down. :-)</FONT></P>
<P><FONT face=Tahoma>Clearly we'll need to see people using ASCII file names until people move up to Unicode. Code pages are just too damn confusing!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6><STRONG>®</STRONG></FONT>" <EM>and</EM> "<FONT size=6><STRONG>™</STRONG></FONT>"&nbsp;<EM>(<A href="http://www.fileformat.info/info/unicode/char/00ae">U+00ae</A> and&nbsp;<A href="http://www.fileformat.info/info/unicode/char/2122">U+2122</A>, a.k.a. REGISTERED SIGN and&nbsp;TRADE MARK SIGN)</EM></FONT></P>
<hr/><p><a id="581390" href="#581390">#</a> <strong>Heath Stewart</strong> on 22 Apr 2006 4:20 PM:</p><div style="margin-left: 1em">I don't think it's that there's any console app involved - there shouldn't be, since zipfldr.dll is just a shell extension server DLL; I think it's just that they interpreting the file names as DOS file names and using the OEM code page.<br><br>What else is interesting regarding code pages is that when I came to your page the (R) and (TM) glyphs weren't displaying correctly. I actually filed a bug last night on Community Server because the new post page uses ISO-8859-1 while the page content sends the Content-Type HTTP header with UTF-8. In this case, Internet Explorer apparently ignored the Content-Type header and automatically chose Windows 1252. I changed the encoding to UTF-8 and it appears correctly. How lame.<br><br>For my post you linked to I actually used the appropriate HTML entities where defined, and coded the entities myself otherwise. It's a big hassle to have to fix-up my HTML but hopefully I won't have to with a future update to Community Server.<br><br>PS: When I was younger I was also a lightening rod for major accidents. Before you know it, I'll have a white stripe of hair and go running every time a storm brews. (Anyone know the reference?)</div>
<p><a id="581447" href="#581447">#</a> <strong>Heath Stewart</strong> on 22 Apr 2006 6:57 PM:</p><div style="margin-left: 1em">Oh yeah, and don't forget to add to the lame Unicode support you mentioned about my blog from <a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/10/08/478479.html">http://blogs.msdn.com/michkap/archive/2005/10/08/478479.aspx</a>. You should add that to the &quot;Unicode Lame List&quot; category, too.</div>
<p><a id="581533" href="#581533">#</a> <strong>Michael S. Kaplan</strong> on 23 Apr 2006 1:56 AM:</p><div style="margin-left: 1em">Good idea on the post category for that other post. :-)<br><br>All I know is that the DLL does not ever use the OEMCP -- so someone is putting that particular interpretation on it....<br><br>I can't repro the encoding problem of the pages, though -- everything seems to display fine here, for me at least. I wonder why?</div>
<p><a id="582281" href="#582281">#</a> <strong>Mihai</strong> on 24 Apr 2006 12:56 PM:</p><div style="margin-left: 1em">&lt;&lt;In this case, Internet Explorer apparently ignored the Content-Type header and automatically chose Windows 1252.&gt;&gt;<br><br>A good reason to always add the meta &quot;text/html; charset=utf-8&quot; to web pages.<br></div>
<p><a id="9472459" href="#9472459">#</a> <strong>Yuhong Bao</strong> on 12 Mar 2009 9:04 PM:</p><div style="margin-left: 1em"><p>&quot;All I know is that the DLL does not ever use the OEMCP&quot;</p>
<p>Except it does, I looked at the zipfldr.dll imports and it imports OemToCharBuffA and CharToOemA.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/05/13 <a href="http://archives.miloush.net/michkap/archive/2008/05/13/8498184.html">WinZip, the [long awaited] Unicode edition!!!</a></p><p>2006/04/30 <a href="http://archives.miloush.net/michkap/archive/2006/04/30/587267.html">Sometimes, you have to keep it in ASCII</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/23/581531.html" title="What difference does the &#39;e&#39; make?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/04/22/581107.html" title="Getting all you can out of a keyboard layout, Part #10a">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/22/581356.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>