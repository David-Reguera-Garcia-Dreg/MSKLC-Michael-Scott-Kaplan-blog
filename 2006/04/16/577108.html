<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/16/577108.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The Unicode Lame List</title></head><body>
<h1>The Unicode Lame List</h1>
<p><em>by Michael S. Kaplan, published on 2006/04/16 06:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/04/16/577108.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>It might take you back to <A HREF="http://blogs.msdn.com/oldnewthing/archive/2005/02/25/380351.aspx"><STRONG>Almost Live</STRONG> and the Lame List</A>, and if so then I was able to inspire the right memories.</FONT></P>
<P><FONT face=Tahoma>It is not a weekly posting, so it's not '<STRONG>What's weak, this week</STRONG>'. But it&nbsp;will likely&nbsp;just be me periodically posting something that I think shows a certain ignorance of the importance of Unicode/internationalization in software, so perhaps you can think of it as&nbsp;something more&nbsp;like a&nbsp;'<STRONG>Who put Unicode in the commode</STRONG>' (you have to work a little harder to get the scansion right, but it is possible!).</FONT></P>
<P><FONT face=Tahoma>Anyway, I am looking over at <A HREF="http://blogs.msdn.com/heaths/">Heath Stewart's blog</A>, and his recent post <A HREF="http://blogs.msdn.com/heaths/archive/2006/03/31/566288.aspx">Opening Patch Files when Compiled for Unicode</A>. Now I am not calling Heath lame here at all&nbsp;-- he isn't, and this is really good information, and I am glad&nbsp;he is putting it out there:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2>If you want to open a <I>.msp</I> file with the Windows Installer APIs, you must pass <CODE>MSIDBOPEN_PATCHFILE</CODE> to the </FONT><A href="http://msdn.microsoft.com/library/en-us/msi/setup/msiopendatabase.asp"><FONT size=2><CODE>MsiOpenDatabase</CODE> function</FONT></A><FONT size=2>, or <CODE>ERROR_OPEN_FAILED</CODE> (110) is returned. Below is the definition of both <CODE>MSIDBOPEN_PATCHFILE</CODE> and <CODE>MSIDBOPEN_READONLY</CODE> from <I>msiquery.h</I> in the Windows Installer SDK.</FONT></P>
<P><FONT face=monospace><FONT size=2><FONT color=blue>#define</FONT> MSIDBOPEN_READONLY (LPCTSTR)0<BR><FONT color=blue>#define</FONT> MSIDBOPEN_PATCHFILE 32/<FONT color=blue>sizeof</FONT>(*MSIDBOPEN_READONLY)</FONT></FONT></P>
<P><FONT size=2><CODE>LPCTSTR</CODE> is defined as <CODE>LPCWSTR</CODE> when <CODE>UNICODE</CODE> is defined, which is defined as <CODE>wchar_t*</CODE>. Since <CODE>sizeof(wchar_t)</CODE> is 2, the value of <CODE>MSIDBOPEN_PATCHFILE</CODE> is 16 when <CODE>UNICODE</CODE> is defined. If you pass this to either the <CODE>MsiOpenDatabaseA</CODE> function or the <CODE>MsiOpenDatabaseW</CODE> function <CODE>ERROR_OPEN_FAILED</CODE> is still returned. The value must always be defined as 32.</FONT></P>
<P><FONT size=2>For the automation method <CODE><A href="http://msdn.microsoft.com/library/en-us/msi/setup/installer_opendatabase.asp">Installer.OpenDatabase</A></CODE> the second parameter must be set to <CODE>msiOpenDatabaseModePatchFile</CODE> to open a patch, which is always defined as 32.</FONT></P></BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>The lame part is a general approach that people take when they think about Unicode, due to specific attitudes both inside and outside of Microsoft:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2>Most developers probably haven't run into this problem yet because of support for Windows 95, 98, and Me, where Unicode is not natively supported and it's typically undesirable to have to ship and support two bootstrap applications. Since Windows NT, 2000, XP, 2003, and future platforms support both ANSI and Unicode it makes sense to compile bootstrap applications for ANSI or MBCS.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>It is actually this particular prevailing attitude that finally inspired MSLU as a project -- there had to be a way to get people supporting Unicode, even if they did have to support Win9x.</FONT></P>
<P><FONT face=Tahoma>The problem now is that no one wants to support Win9x in their platforms, but if there is any kind of downlevel story involved (whether it is the Windows Installer folks not supporting a Win9x Unicode version of their support or the C++ folks <A HREF="http://archives.miloush.net/michkap/archive/2006/03/21/556489.html">not wanting to ship an MSLU-ized version of MFC</A>, or whatever) it amounts to a passive-agressive, whiney&nbsp;"it's too late to&nbsp;support your Unicode solution in our product, but we have to keep encouraging the customer ANSI solution of our product."</FONT></P>
<P><FONT face=Tahoma>I wonder how many more years will these teams try to wish the problem away (as people did on the Windows side for so many years before approval was given to <STRONG>do</STRONG> MSLU) before they give up and finally do something about it. Because until it is easy to do, until there is a good backcompat story, and until it is the default setting, most people will not choose Unicode for their solution....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "á»€" <EM>(<A href="http://www.fileformat.info/info/unicode/char/1ec0">U+1ec0</A>, a.k.a. LATIN CAPITAL LETTER E WITH CIRCUMFLEX AND GRAVE)</EM></FONT></P>
<hr/><p><a id="577269" href="#577269">#</a> <strong>mpz</strong> on 16 Apr 2006 8:37 PM:</p><div style="margin-left: 1em">Like Joelonsoftware writes (see URL), a lot of programmers think it's too much work and wish the problem would just go away (which it won't).<br><br>Even in 2006, there's way too much software that is simply oblivious to the whole issue. FTP servers and clients.. argh.<br><br>We need to be more vocal about getting UTF-8 supported everywhere and universally.</div>
<p><a id="578061" href="#578061">#</a> <strong>Dean Harding</strong> on 18 Apr 2006 3:41 AM:</p><div style="margin-left: 1em">Actually, looking at the comments to Heath's post, the problem isn't that no one has been using Unicode in their installers yet, it's because of the strange semantics of the function call - the fact that they're overloading the parameter as both a string and an integer!!<br><br>The idea is supposed to be that you either pass in an LPTCSTR which is the name of a new database file, or you can pass in these &quot;constants&quot; which direct the API to do something special.<br><br>But to combine the constants, you don't OR (|) them, you ADD (+) them, so if you've got UNICODE defined, the pointer arithmetic that results from (MSIDBOPEN_READONLY + MSIDBOPEN_PATCHFILE) is the correct value (on the other hand, if UNICODE is not defined then (MSIDBOPEN_READONLY + MSIDBOPEN_PATCHFILE) is exactly equivalent to (MSIDBOPEN_READONLY | MSIDBOPEN_PATCHFILE) anyway.<br><br>So as long as you're doing EXACTLY what the documentation says (and not what your intuition would tell you) then it should work with both UNICODE defined and not defined...</div>
<p><a id="578065" href="#578065">#</a> <strong>Michael S. Kaplan</strong> on 18 Apr 2006 3:48 AM:</p><div style="margin-left: 1em">But Dean, most people avoid shipping both installers if they can, the same way they don't build apps two ways....</div>
<p><a id="578616" href="#578616">#</a> <strong>Dean Harding</strong> on 18 Apr 2006 7:21 PM:</p><div style="margin-left: 1em">Yeah, I know. What I mean is that if you have UNICODE defined, then you have to combine the flags by ADDing them, rather than ORing them. If you don't have UNICODE defined, then it just so happens that ADDing and ORing would do the same thing.</div>
<p><a id="578633" href="#578633">#</a> <strong>Michael S. Kaplan</strong> on 18 Apr 2006 7:54 PM:</p><div style="margin-left: 1em">That can't be the *design* though -- it makes no sense that a code change would be needed when going to Unicode. I think they just have a bug in the definition....</div>
<p><a id="578669" href="#578669">#</a> <strong>Dean Harding</strong> on 18 Apr 2006 9:27 PM:</p><div style="margin-left: 1em">But if you look at the documentation, it actually says &quot;*Add* this flag to indicate a patch file&quot; which I'll admit goes a little against the usual custom, and I'll also admit it's a silly design.<br><br>The problem is that they're overloading this one parameter to accept either a string or an integer. So it's defined as an LPCTSTR type, and the flags are defined as &quot;(LPCTSTR)x&quot;. This means that you CAN'T OR two of the flags together (the | operator is not defined for pointer types) so you HAVE to + them.<br><br>Like I said, it just so happens that | and + are the same when you have a pointer to a 'char', but | and + are different when your pointer is to a unicode character.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/16/577278.html" title="Suggest a Topic (April 16, 2006)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/04/16/577083.html" title="She slipped out last Friday">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/16/577108.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>