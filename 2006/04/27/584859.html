<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/27/584859.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>'Doctor, it hurts when I do this.' Well, don't do that!</title></head><body>
<h1>'Doctor, it hurts when I do this.' Well, don't do that!</h1>
<p><em>by Michael S. Kaplan, published on 2006/04/27 03:00 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/04/27/584859.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Regular reader Mike Lippert </FONT><FONT face=Tahoma>asked the Suggestion Box:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>Hi Michael, <BR>Your blog is great and I really appreciate all you've written. <BR><BR>I just ran into some odd behavior I was wondering if you could explain. <BR><BR>Our app uses the Symbol font to display certain characters. We recently converted the app from ANSI to Unicode. <BR><BR>While testing QA set the system codepage to Russian (charset cyrillic 1251). Now many of characters drawn using the symbol font show as square boxes. <BR><BR>One of the characters displaying as a square box is at 0xD9, which is a logical and (U+2227). In the 1252 charset, that has the same codepoint as in Unicode U+00D9 (Latin capital letter U with grave). In the 1251 charset that position contains the Unicode U+0429 (Cyrllic capital letter shcha). <BR><BR>Since our app is now Unicode the MFC CDC TextOut maps to TextOutW. <BR><BR>Here's the odd behavior: when TextOut is called with the symbol font selected in the DC and a string consisting of the single Unicode character U+00D9, a square box is displayed. When it is called with the character U+0429, the "logical and" glyph is displayed. <BR><BR>So what seems to be happening when drawing with the symbol font selected, is that the Unicode string is converted to the current system codepage and those codepoints are drawn. <BR><BR>Is that really what's going on? I couldn't find any documentation to that effect... <BR><BR>Thanks, <BR>Mike </FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>He then followed up the next day with:
<DIV></DIV>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2>Michael, <BR>If you've got a sec to look at the topic I just posted above I'd appreciate it as I'm trying to figure out how to work around that behavior now. <BR>If you can't I totally understand, and I'll come up with something. <BR><BR>Thanks, <BR>Mike Lippert <BR><BR>ps I understand if you want to delete this comment as it isn't really a topic request, but was the best way I could think of to communicate w/ you. </FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>Apparently Mike thought he would make me his personal support line representative.&nbsp;I<FONT face=Tahoma> decided to get my revenge by pointing this out.</FONT></FONT></P>
<P><FONT face=Tahoma><FONT face=Tahoma>:-)</FONT></FONT></P>
<P>Now I am the first person to tell people to move to Unicode, believe me.</P>
<P>But symbol fonts aren't really Unicode. In fact, like I pointed out in <STRONG><A HREF="http://archives.miloush.net/michkap/archive/2005/11/08/490495.html">More than you ever wanted to know about CP_SYMBOL</A></STRONG>, GDI and NLS can't even agree on how to try and fit them into the "character" metaphor.</P>
<P>In this case, it is clear from the behavior that Mike is seeing that the claim folks in GDI made that "<EM>GDI maps by&nbsp;a different scheme and will accept U+0020 - U+00ff</EM>" is not always going to be true -- especially (as in this case) if you are calling an MFC method that maps the bytes to Unicode for you before the call to TextOut/ExtTextOut happens....</P>
<P>So although I am a fan of Unicode, these symbols aren't Unicode in their current form -- so making an app Unicode but passing on symbol bytes like this will cause them to be mapped using CP_ACP. Which is pretty much guaranteed to be wrong.</P>
<P>To fix? Well, if you make sure to pass the symbols as the appropriate Unicode characters --&nbsp;either by</P>
<UL>
<LI>converting the bytes you have directly with a <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_17si.asp">MultiByteToWideChar</A>&nbsp;call with the CP_SYMBOL code page, or</LI>
<LI>making sure to put them in that <A href="http://www.fileformat.info/info/unicode/char/0000">U+0000</A> - <A href="http://www.fileformat.info/info/unicode/char/001f">U+001f</A>, <A href="http://www.fileformat.info/info/unicode/char/f020">U+f020</A> - <A href="http://www.fileformat.info/info/unicode/char/f0ff">U+f0ff</A>&nbsp;range that GDI will recognize as being symbol font stuff</LI></UL>
<P>OR you could just not do this one piece with Unicode at all -- symbols are just as happy not having to be in Unicode. So the advice in the title of this post can help a lot!</P>
<P>Then (with any of those three methods) you&nbsp;should be able to see the symbols from that symbol font.</P>
<P><EM>Now at this point I will apologize to Mike Lippert for teasing him, hopefully he won't be too angry (and I doubt I have enough readers to start scaring away the ones who aren't insufferably rude!).</EM></P>
<P>Though I will say to everyone that you may want to look at the text in the <A HREF="http://archives.miloush.net/michkap/archive/2004/11/01/280092.html">Contacting Michael link</A> about looking here for Product Support. I might have to add that the punishmentfor violations&nbsp;may be a tiny bit of good natured ridicule.... :-)</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> "âˆ‘" <EM>(<A href="http://www.fileformat.info/info/unicode/char/2211">U+2211</A>, a.k.a. N-ARY SUMMATION)</EM></FONT></P></FONT></FONT></FONT>
<hr/><p><a id="585222" href="#585222">#</a> <strong>mlippert</strong> on 27 Apr 2006 1:25 PM:</p><div style="margin-left: 1em">Hehe, I cheerfully accept all the teasing you want to dish out, since it meant I'm also getting an answer.<br><br>Thank you, I know you've got many other real responsiblities, but when my web search turned up no info, I figured it was a valid topic others might be interested in as well, and I was likely to get a better answer from you, if you responded, than from anyone else (and I was right :-).<br><br>I wish I had found your other article, I was obviously using the wrong search terms.<br><br>I was considering the 1st option you mentioned, but it seemed like it would be fraught with problems, and implementing it was going to be a little painful. Knowing that GDI will translate the 0xf020-0xf0ff range appropriately should do the trick.<br><br>Thanks again,<br>Mike</div>
<p><a id="585350" href="#585350">#</a> <strong>mlippert</strong> on 27 Apr 2006 2:33 PM:</p><div style="margin-left: 1em">I thought I'd add that I want to change the code stop using the Symbol font for these characters (they all have representations in Unicode), but that will also require finding a font that contains those characters and testing to make sure the new font still looks as expected (for example when drawing integral signs using the top [U+2320], extender [U+23AE] and bottom [U+2321] characters).<br><br>Mike</div>
<p><strong>Gale</strong> on 5 Jan 2009 1:04 PM:</p><div style="margin-left: 1em"><p>Thank you for this post. Quite helpful to me - especially the links.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/03/21 <a href="http://archives.miloush.net/michkap/archive/2007/03/21/1924167.html">Warning: when private is used in public, it can really suck</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/27/585169.html" title="Stay ahead of the culture by creating the culture">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html" title="The disunification of Norwegian and Danish sorting">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04-27">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/27/584859.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>