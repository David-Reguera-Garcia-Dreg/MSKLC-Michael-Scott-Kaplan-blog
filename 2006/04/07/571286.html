<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/07/571286.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Find the [globalization] bug(s)?</title></head><body>
<h1>Find the [globalization] bug(s)?</h1>
<p><em>by Michael S. Kaplan, published on 2006/04/07 21:50 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/04/07/571286.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>This may be fun. Extra credit to those who can find problems <STRONG>without</STRONG> copying and pasting the code somewhere and compiling it (and you are all on the honor system if you want to claim the extra credit!)....</FONT></P>
<P><FONT face=Tahoma>It is technically a C# question, though mainly it is just a .NET Framework question.</FONT></P>
<P><FONT face=Tahoma>First, there is a step to set up the machine (for the extra credit&nbsp;just do this step mentally and keep in mind that you did it!):</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT size=2>In Regional and Language Options-&gt;Regional Options-&gt;Customize-&gt;Date, set the Date Separator to ":" -- the idea is to make sure that both the Date and Time Separators are identical.&nbsp;</FONT>&nbsp;</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Ok, now just review the following bit of code: </FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>DataTime dt1 = System.DataTime.Now();<BR>String st = dt1.ToUniversalTime().ToString();<BR>DateTime dt2 = System.Convert.ToDateTime(st);</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>All comments will be moderated until some time over the weekend.</FONT></P>
<P><FONT face=Tahoma>I suppose there could even be additional extra credit for any non-programmer who has a reasonable theory....</FONT></P>
<P><FONT face=Tahoma>Enjoy!</FONT></P>
<hr/><p><a id="571379" href="#571379">#</a> <strong>Gabriel Lozano-Mor&#225;n</strong> on 8 Apr 2006 2:32 AM:</p><div style="margin-left: 1em">My guess is that this would fail because the date is not an ISO 8601 date format and therefore the internal parsing will fail.<br><br>I think that the real question here is &quot;why does the above code fail?&quot;<br><br></div>
<p><a id="571748" href="#571748">#</a> <strong>Michael S. Kaplan</strong> on 8 Apr 2006 10:26 PM:</p><div style="margin-left: 1em">Hmmm... not too many people wanting to make any guesses (or to try compiling the code and running it to see what happens, either). I'll wait a bit longer before the answers get posted, and give some people a chance to look good. :-)</div>
<p><a id="572132" href="#572132">#</a> <strong>mharen@gmail.com</strong> on 9 Apr 2006 9:58 PM:</p><div style="margin-left: 1em">The convert piece needs a locale.</div>
<p><a id="572483" href="#572483">#</a> <strong>Jeff Parker</strong> on 10 Apr 2006 9:50 AM:</p><div style="margin-left: 1em">Sorry just getting in and reading the blogs from over the weekend. <br><br>Anyway, my answer would be very similar to this one I gave on webservices. <a rel="nofollow" target="_new" href="http://blogs.msdn.com/suryaj/archive/2006/03/29/564322.aspx">http://blogs.msdn.com/suryaj/archive/2006/03/29/564322.aspx</a><br><br>Anyway this is not really a bug but the time here dt1.ToUniversalTime().ToString();<br>Will not contain any UTC offset in it as by default the ToString does not have it. So when you convert it back in on the second line it will be that time in the string but will have the UTC offset of the computer you are running this code on. <br><br></div>
<p><a id="572506" href="#572506">#</a> <strong>Mark</strong> on 10 Apr 2006 10:19 AM:</p><div style="margin-left: 1em">Without running the code, my guess would be that because the date and time seperators are the same, that the convert will have problems differentiating the date portion from the time portion. &nbsp;</div>
<p><a id="572604" href="#572604">#</a> <strong>Brandon Haase</strong> on 10 Apr 2006 1:04 PM:</p><div style="margin-left: 1em">I'll take a guess, trying for partial extra-credit since I referenced msdn ;)<br><br>First, the first line has DataTime instead of DateTime... so it wouldn't compile unless you've defined System.DataTime. Also, Now is a static property of DateTime, so you'll get another error for the parenthesis.<br><br>Assuming you meant DateTime dt1 = DateTime.Now;, dt1 would be fine, because internal representation of the data does not care about the delimiters.<br><br>The string representation of the date assigned to the st variable would have :'s as a date seperator. You would get something like &quot;4:10:2006 12:52:31 PM&quot;. Note the universal time conversion subtracts the UtcOffset.<br><br>System.Convert.ToDateTime doesn't blow up because the DateTime.Parse method (what ToDateTime invokes) disregards unrecognized elements and substitutes missing elements from the current date to avoid throwing an exception.<br><br>I wouldn't be too surprised if the date value is parsed as date *and* time or the operation swaps or otherwise munges the date/time info.<br><br>Now I am going to compile it and see what happens...</div>
<p><a id="572608" href="#572608">#</a> <strong>Brandon Haase</strong> on 10 Apr 2006 1:10 PM:</p><div style="margin-left: 1em">Ooh... just barely missed it.<br><br>The parse operation ignores the real date value and parses the time as though it were a date. No time value is parsed.<br><br>Nice one. Where was this found?</div>
<p><a id="572752" href="#572752">#</a> <strong>Michael S. Kaplan</strong> on 10 Apr 2006 4:23 PM:</p><div style="margin-left: 1em">There are indeed many problems here, some of whicch were found by people (see above comments).<br><br>The principal problem is the mismatch -- formatting a date into a string in a manner independent of culture and then parsing it back to a date in a culture-sensitive manner.<br><br>As Brandon indicated, the change in Regional Options makes the problem more noticable, since instead of sometimes causing invalid date values to be returned it will actually throw an exception due to the confusion that the change causes.<br><br>I won't argue that this makes the bug worse though; I would argue it makes the bug better! Because bugs that corrupt data without being noticed can be much much worse for an application, in the long run.<br><br>Additional problems on the time value itself -- the format call moves it to universal time, while the Parse call will assume local time -- so you will watch the dat move around even if the other potential mismatches were not present....</div>
<p><a id="572817" href="#572817">#</a> <strong>Maurits [MSFT]</strong> on 10 Apr 2006 5:52 PM:</p><div style="margin-left: 1em">&gt; the format call moves it to universal time, while the Parse call will assume local time<br><br>SMTP solves this by adding an RFC2822-style &quot;zone&quot; offset.<br><br>Pacific Time: -0800 or -0700 depending on whether DST is on<br>Eastern Time: -0500 or -0400 depending on DST<br>Chatham Islands: +1245 or +1345 depending on DST<br><br>This keeps local time readable but without letting ambiguity into the picture.</div>
<p><a id="572856" href="#572856">#</a> <strong>Michael S. Kaplan</strong> on 10 Apr 2006 6:56 PM:</p><div style="margin-left: 1em">Of course here the ambiguity has been multiplied by intentionally using mismatched methods, right? :-)<br><br>Plus, if you always added that info to every string, then most users would likely very confused since they do not expect that sort of detail in all cases....</div>
<p><a id="572878" href="#572878">#</a> <strong>Maurits [MSFT]</strong> on 10 Apr 2006 7:29 PM:</p><div style="margin-left: 1em">&gt; most users would likely very confused<br><br>I suppose it would depend on how used they are to dealing with times and dates from different time zones.<br><br>Most USAnians can handle &quot;Lost! Season Finale at 8/7 Central&quot;...<br>And most USAnians can handle &quot;Super Bowl plays at 9PM Eastern&quot;...<br><br>And most email server sysadmins can handle the RFC2822 syntax...<br><br>... but I don't know how (say) Europeans deal with international conference calls. &nbsp;Do corporate netizens use Central Office Time, even if no-one on the call happens to be at the Central Office?<br><br>I think this would mandate some new structs :( since DateTime's don't keep track of their own time zone.<br><br>struct DateTimeWithTimeZone<br>{<br>DateTime dateTime; // stored in UTC, natch<br>TimeZoneOffset timeZoneOffset; // +1245 or -0800<br>}<br><br>TimeZoneOffset<br>{<br>bool Positive; // + or -<br>int Hours; // 12<br>int Minutes; // 45<br>}<br><br>and some static constants<br><br>TimeZoneOffset<br>{<br>static TimeZoneOffset EST = { false, 5, 0 };<br>static TimeZoneOffset PST = { false, 8, 0 };<br>static TimeZoneOffset UTC = { true, 0, 0 }; // true by convention<br>...<br>}</div>
<p><a id="572898" href="#572898">#</a> <strong>Michael S. Kaplan</strong> on 10 Apr 2006 8:00 PM:</p><div style="margin-left: 1em">Hmmm.... okay. But of course this has nothing to do with the original question (in pointing out bugs in the code we don't try to design one or more of the types in the underlying programming framework!). <br><br>:-)</div>
<p><a id="572902" href="#572902">#</a> <strong>Maurits [MSFT]</strong> on 10 Apr 2006 8:08 PM:</p><div style="margin-left: 1em">&quot;mandate&quot; was the wrong word... I meant something more like &quot;entail.&quot;<br><br>AFAICS the underlying problem[1] is not solvable without major surgery[2], which cure is worse than the disease... so the bug is firmly located in the code, as you describe, and not in the framework.<br><br>All this addresses only the time-zone-offset bug, and not the &quot;regional date format&quot; bug.<br><br>[1] time zones are hard<br>[2] make time zones part and parcel of datetimes, a-la RFC2822</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/08/571353.html" title="It may not always end with ի">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/04/07/570980.html" title="File redirection corruption?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/07/571286.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>