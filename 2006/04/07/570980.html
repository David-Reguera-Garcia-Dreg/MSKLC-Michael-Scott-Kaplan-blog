<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/07/570980.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>File redirection corruption?</title></head><body>
<h1>File redirection corruption?</h1>
<p><em>by Michael S. Kaplan, published on 2006/04/07 14:21 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/04/07/570980.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>A question I received in email:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>In the FRA and ESN OSes, when I type some word on the command prompt with an acute-accented e like génération and redirect it to a file (eg: “echo génération &gt; abcd.txt”) then the file contains a comma instead of the é. (The file has g,n,ration). But when I don’t redirect, I can see the character properly in the command prompt. I am also able to copy-paste to that file with the characters intact. Only the redirection is causing trouble.<BR><BR>Can you advise as to why this could happen? I would have thought that it has the wrong code page but the fact that I can see the characters properly on screen seems to preclude that guess. Any help would be very appreciated.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Of course, any time the difference is between a console application and a regular windows application, the first guess as to the problem is one of those OEMCP vs. ACP issues.</FONT></P>
<P><FONT face=Tahoma>So, looking at some code pages (<A href="http://www.microsoft.com/globaldev/reference/sbcs/1252.mspx">1252</A> and <A href="http://www.microsoft.com/globaldev/reference/oem/437.mspx">437</A>):</FONT></P>
<P><FONT face=Tahoma>On code page 437,&nbsp;</FONT><FONT face=Tahoma>0x82&nbsp;is U+00E9 (<STRONG>é</STRONG> -- LATIN SMALL LETTER E WITH ACUTE), while&nbsp;On code page 1252, 0x82 is U+201a (<STRONG>‚</STRONG> -- SINGLE LOW-9 QUOTATION MARK).</FONT></P>
<P><FONT face=Tahoma>So the output was never different at all -- but the way that the underlying byte was being interpretted was....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6><STRONG>‚</STRONG></FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/201a">U+201a</A>, SINGLE LOW-9 QUOTATION MARK)</EM></FONT></P>
<hr/><p><a id="571095" href="#571095">#</a> <strong>Maurits [MSFT]</strong> on 7 Apr 2006 4:53 PM:</p><div style="margin-left: 1em">&gt; I am also able to copy-paste to that file with the characters intact<br><br>So the copy/paste is switching code pages automatically? &nbsp;How does that work?</div>
<p><a id="571116" href="#571116">#</a> <strong>Michael S. Kaplan</strong> on 7 Apr 2006 5:21 PM:</p><div style="margin-left: 1em">Hi Maurits --<br><br>Well, usually each application that is not smart enough to use Unicode (such as the console) is smart enough to properly pivot from the code page it is using TO Unicode (either converting and putting CF_UNICODETEXT on the clipboard or just putting up the code page and letting the clipboard map and convert through synthetic clipboard formats)....</div>
<p><a id="571177" href="#571177">#</a> <strong>Maurits [MSFT]</strong> on 7 Apr 2006 6:17 PM:</p><div style="margin-left: 1em">I see... copying from the console gets you to Unicode (through WM_COPY, presumably) but output redirection is a naked string of bytes.<br><br>And for some reason (?) the console is using a different code page than Notepad.<br><br>So &quot;type abcd.txt&quot; shows the accents, and &quot;notepad abcd.txt&quot; shows the commas. (Verified)</div>
<p><a id="571189" href="#571189">#</a> <strong>Maurits [MSFT]</strong> on 7 Apr 2006 6:27 PM:</p><div style="margin-left: 1em">Ah, a fix!<br><br>&quot;The command processor has an option (/U) to generate all piped and redirected output in Unicode rather than the OEM code page.&quot;<br><a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2005/03/08/389527.aspx">http://blogs.msdn.com/oldnewthing/archive/2005/03/08/389527.aspx</a></div>
<p><a id="571338" href="#571338">#</a> <strong>Gabe</strong> on 8 Apr 2006 12:43 AM:</p><div style="margin-left: 1em">I would just run &quot;chcp 1252&quot; so that the console code page was the same as the system code page.</div>
<p><a id="571408" href="#571408">#</a> <strong>Srivatsn</strong> on 8 Apr 2006 3:12 AM:</p><div style="margin-left: 1em">Why is it that when i run chcp 1252 and paste &#233; (U+00E9) from character map, it displays Θ &nbsp;which is E9 in cp 437? What is the conversion that happens here and on what basis?</div>
<p><a id="571701" href="#571701">#</a> <strong>Michael S. Kaplan</strong> on 8 Apr 2006 7:09 PM:</p><div style="margin-left: 1em">Hi Srivatsn,<br><br>Well, chcp affects the output code page -- but what you enter in the console is input, not output. So the OEMCP is used....</div>
<p><a id="571822" href="#571822">#</a> <strong>Gabe</strong> on 9 Apr 2006 5:16 AM:</p><div style="margin-left: 1em">So if I type:<br><br>chcp 1252<br>echo g&#233;n&#233;ration &gt; abcd.txt<br>notepad abcd.txt<br><br>Notepad will show an eacute.<br><br>Now, by default the console uses the Terminal font, which has a theta at code point 0xE9. However, Lucida Console is a Unicode font and things show up as I expect them to.<br><br>I would just recommend that the original email user set his console font to Lucida Console and use chcp 1252, and he should get what he expects.</div>
<p><a id="571857" href="#571857">#</a> <strong>Michael S. Kaplan</strong> on 9 Apr 2006 9:50 AM:</p><div style="margin-left: 1em">Or try the /U option and have some of those other scebarios work, too.... :-)</div>
<p><a id="572207" href="#572207">#</a> <strong>Gabe</strong> on 10 Apr 2006 12:52 AM:</p><div style="margin-left: 1em">When I write batch files that require &quot;international&quot; characters, I put &quot;chcp 1252&quot; at the beginning of them because I can't guarantee that they'll be run by a Unicode cmd.exe.</div>
<p><a id="572238" href="#572238">#</a> <strong>Michael S. Kaplan</strong> on 10 Apr 2006 1:49 AM:</p><div style="margin-left: 1em">Um, &quot;international&quot; is at a minimum worthy of a &quot;chcp 65001&quot;, isn't it?<br><br>I mean, with 1252 being such a far cry from &quot;international&quot; ? :-)</div>
<p><a id="572953" href="#572953">#</a> <strong>Dean Harding</strong> on 10 Apr 2006 9:46 PM:</p><div style="margin-left: 1em">I think that's why he put &quot;international&quot; in quotes... at least it's &quot;more&quot; international that US-ASCII.<br><br>Anyway, for serious international stuff, I'd say switch to Monad or something (if possible anyway)... it's much more consistent, being .NET and all Unicode internally.</div>
<p><a id="573719" href="#573719">#</a> <strong>Maurits [MSFT]</strong> on 11 Apr 2006 6:11 PM:</p><div style="margin-left: 1em">There doesn't seem to be a code page that will allow &quot;type&quot; to print a UTF-16 text file. &nbsp;chcp 1200 and chcp 1201 both return &quot;Invalid code page.&quot; &nbsp;This could be worked-around with some kind of utf16le_to_utf8.exe, which would read UTF-16LE and spit it out as UTF8:<br><br>rem make a utf16le file<br>cmd /c /u echo g&#233;n&#233;ration &gt; utf16le.txt<br><br>rem switch console to the UTF8 code page<br>chcp 65001<br><br>rem type the file back to the console with the utf16le_to_utf8 shim<br>type utf16le.txt | utf16le_to_utf8</div>
<p><a id="573724" href="#573724">#</a> <strong>Maurits [MSFT]</strong> on 11 Apr 2006 6:15 PM:</p><div style="margin-left: 1em">Er, switch /c and /u in that cmd call:<br>cmd /u /c echo g&#233;n&#233;ration &gt; utf16le.txt </div>
<p><a id="573790" href="#573790">#</a> <strong>Maurits [MSFT]</strong> on 11 Apr 2006 8:07 PM:</p><div style="margin-left: 1em">Yup, that works.<br><br>C:\&gt;chcp<br>Active code page: 437<br><br>C:\&gt;cmd /u /c echo g&#233;n&#233;ration &gt; utf16le.txt<br><br>(Opening utf16le.txt in Notepad and a hex editor confirms the UTF16-LE-ness of the file.)<br><br>C:\&gt;type utf16le.txt<br> &nbsp;Θ n Θ r a t i o n<br><br>C:\&gt;chcp 65001<br>Active code page: 65001<br><br>C:\&gt;type utf16le.txt<br>???n?r?a?t?i?o?n? ?<br>?<br><br>(type'ing a UTF16-LE-encoded file in a UTF8 code page doesn't work...)<br><br>C:\&gt;type utf16le.txt | perl utf16le_to_utf8.pl<br>g&#233;n&#233;ration<br><br>(... but piping it through a converter does.)<br><br>For the sake of completeness, here's the code for the converter:<br><br>C:\&gt;type utf16le_to_utf8.pl<br>use strict;<br>use Encode;<br><br># slurp whole files to avoid spurious line break issues with 0d 00 0a 00 etc.<br>undef $/;<br><br># read text<br>my $text = &lt;&gt;;<br><br># convert text<br>Encode::from_to($text, 'UTF-16LE', 'UTF-8');<br><br># output converted text<br>print $text;<br><br>(It's probably reasonably trivial to write a simple .exe to convert from UTF-16LE on wcin to UTF-8 on cout... that would obviate the need for Perl.)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/04/07/571286.html" title="Find the [globalization] bug(s)?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/04/06/569957.html" title="Dandy of Johns Hopkins">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-04-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/04/07/570980.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>