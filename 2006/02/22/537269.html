<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/22/537269.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Keep off the grass</title></head><body>
<h1>Keep off the grass</h1>
<p><em>by Michael S. Kaplan, published on 2006/02/22 16:20 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/02/22/537269.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Well, at the very least keep MSLU apps out of the VMWare shared folders? :-)</FONT></P>
<P><FONT face=Tahoma>The other day, Brian asked in the microsoft.public.platformsdk.mslayerforunicode newsgroup:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>I&nbsp;have a strange situation, seemingly involving MSLU on VMWare.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>First, let me say that I have a fully unicode enabled program, using MSLU to run on 95, 98, and NT.&nbsp; It works well on all platforms, including Japanese, Chinese, and Korean 98, ME, and all versions of 2k and XP.&nbsp; I can display unicode characters in titles, menus, dialogs, and everywhere else needed, so I believe my application is built and linked correctly.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>Now, with that said, here is my problem...</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>I am running a Windows XP VM as a guest OS in VMWare 5.5, with XP also as the host OS.&nbsp; My app runs fine if I run it from the desktop or a local folder in VMWare, but if I run my app from a shared folder in VMWare, I get garbled strings.&nbsp; It took me a while, but I've traced this down to MSLU.&nbsp; It seems that when running under a shared folder, my LoadUnicowsProc() function is called, the unicows.dll is loaded, and from then on, MSLU is trying to translate strings, with disasterous results.&nbsp; Symptoms range from garbage in strings to truncated window titles similer to one reported in this post:</EM></FONT></P>
<P><A href="http://groups.google.com/group/microsoft.public.platformsdk.mslayerforunicode/browse_thread/thread/97e1f5b8fe16617d/246a7f1e2e2cc65a?q=vmware&amp;rnum=2#246a7f1e2e2cc65a"><FONT face="Times New Roman" size=2><EM><A href="http://groups.google.com/group/microsoft.public.platformsdk.mslayerforunicode/browse_thread/thread/97e1f5b8fe16617d/246a7f1e2e2cc65a?q=vmware&amp;rnum=2#246a7f1e2e2cc65a">http://groups.google.com/group/microsoft.public.platformsdk.mslayerforunicode/browse_thread/thread/97e1f5b8fe16617d/246a7f1e2e2cc65a?q=vmware&amp;rnum=2#246a7f1e2e2cc65a</EM></FONT></A><FONT face="Times New Roman" size=2><EM></EM></FONT></A></P>
<P><FONT face="Times New Roman" size=2><EM>My understanding is that Unicows&nbsp; DLL should never have to be loaded on XP.&nbsp; I wonder what the difference is here?&nbsp; I use VMWare all the time, with excellent results even on Win95, 98, ME.&nbsp; Without the source to the MSLU Loader, it's a bit difficult to figure out why it would be trying to load the DLL in this situation.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>Does anyone (MichKa)&nbsp; have even Pseudo-code for what the loader is looking for before loading the DLL?&nbsp; I imagine it's at least calling GetVersion() or GetVersionEx(), both of which seem to be returning the proper values.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>The problem goes away when I do the following:</EM></FONT></P>
<OL>
<LI><FONT face="Times New Roman" size=2><EM>Copy the exe from the shared folder to the local machine.</EM></FONT> 
<LI><FONT face="Times New Roman" size=2><EM>Simply remove Unicows.lib from the link list and recompile</EM></FONT></LI></OL>
<P><FONT face="Times New Roman" size=2><EM>I've even replicated the problem in a scaled-down program containing only a WinMain.&nbsp; Let me know if you're interested in seeing it.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>Any suggestions would be appreciated.</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>My response was of course grounded in <A HREF="http://archives.miloush.net/michkap/archive/2005/11/12/491519.html"><STRONG>Tester's Axiom #1</STRONG></A>, and said:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT face="Times New Roman" size=2>VMWare compatibility testing is not a scenario we ever covered, so of course&nbsp;there could be bugs (and it appears there are?).</FONT></EM></P>
<P><EM><FONT face="Times New Roman" size=2>The workaround -- keep apps out of the shared folder....</FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Brian did then respond back with more information, including info from the VMWare folks:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>That would be fine, as my program is normally installed under "program files", except that the same problem occurs when a document is opened (by double-clicking in explorer) from the shared folder.&nbsp; The application, because of it's association with the document extension, starts up but its working directory is the shared folder and the problem still exists.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>So, now the workaround is: don't put programs or documents in the shared folder.&nbsp; So, what's the shared folder for anyway!!</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>I brought this up here because it is unclear to me which piece is broken.&nbsp; There's obviously an undesirable interaction between VMWare and MSLU, and considering the popularity of both, it seems someone would be interested in fixing this.&nbsp; I just don't know who.&nbsp; I'm not sure how interested Microsoft would be to work with VMWare on a resolution.&nbsp; Looking at the VMWare forums, there are loads of similar issues, with symptoms in other apps that are identical to my own problems (running programs, opening documents).&nbsp; However, nowhere did I see anyone else track it down to an interaction with MSLU.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>I opened the same issue with VMWare and got this response:</EM></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>----------------------------------------------------------------<BR>Dear Brian,<BR><BR>We are currently tracking this issue in Vmware Bug # 60617. I have added your comments to the bug and we will be in touch with you if we need any additional information. Unfortunately there is no current workaround or fix for this issue except to avoid using the shared folder as a working directory. You will be notified if there are any updates or workarounds for this issue.<BR>----------------------------------------------------------------</EM></FONT></P></BLOCKQUOTE>
<P><FONT face="Times New Roman" size=2><EM>Anyway, I just thought I'd bring it up.&nbsp; I know MSLU does some tricky stuff behind the scenes.&nbsp; Obviously, something it is doing is giving VMWare fits.</EM></FONT></P></BLOCKQUOTE><FONT face=Tahoma>
<P><FONT face=Tahoma>Now we actually went through a few iterations on methods to do this detection, which happens in both unicows.lib (the MSLU loader, used by C/C++ applications) and unicows.dll (MSLU, used directly by applications like VB that cannot use the loader).</FONT></P>
<P><EM>(In this case, Brian is using an MSLU loader override, which means he is using unicows.lib. Getting the latest version of the .LIB may be helpful here, but of course knowing which version of the .LIB is being used is also a good idea)</EM></P>
<P>There is no compatibility issue where a mismatch between .LIB version and .DLL version could cause problems, other than if one of the bugs that caused us to change methods came up, but that is kind of expected, I think. There is a benfit to using the latest version,&nbsp;as usual.</P>
<P>We also has the benefit of being produced by the Windows team within the Windows source tree, which gave us a lot of chances to see all of the good and bad ways that people tried to do this very thing in their own programs, both inside the Windows source and from many reports of applications inside and outside of MS....</P>
<P>Anyway, some more detail about MSLU....</P>
<P>A long time ago, MSLU used <A href="http://msdn.microsoft.com/library/en-us/sysinfo/base/getversion.asp">GetVersion</A> to do its version checking. However, the ability added to XP that allows you to run an application as if it were a different version was able to raise a pretty huge set of problems.</P>
<P>So it became important to look for a way to detect the version that was not quite so subject to being changed by the&nbsp;whim of someone intentionally asking the OS to lie about its own version.</FONT></P>
<P><FONT face=Tahoma>After all, only MSLU should be allowed to&nbsp;lie for MSLU apps, right? :-)</FONT></P>
<P><FONT face=Tahoma>At this point,&nbsp;the Microsoft Layer for Unicode&nbsp;is itself in maintenance mode. So there is not a high chance that&nbsp;the .DLL&nbsp;will be able to be modified to fix such a problem. There is a bit more flexibility on the .LIB file, but more info would be needed from VMWare to be able to consider proceeding in such a direction....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "Â±" <EM>(<A href="http://www.fileformat.info/info/unicode/char/00b1">U+00b1</A>, a.k.a. PLUS-MINUS SIGN)</EM></FONT></P>
<hr/><p><a id="537651" href="#537651">#</a> <strong>Mihai</strong> on 23 Feb 2006 2:30 AM:</p><div style="margin-left: 1em">&lt;&lt;After all, only MSLU should be allowed to lie for MSLU apps, right?&gt;&gt;<br><br>No! The user should always be the final master!<br><br>If an application developed with MSLU by a company that died 1 year ago refuses to work on Vista (or Win XP SP3 :-), I should have the power to lie.<br><br>And, in general, I hate any software that thinks it knows better than me.</div>
<p><a id="537679" href="#537679">#</a> <strong>Ben Cooke</strong> on 23 Feb 2006 3:34 AM:</p><div style="margin-left: 1em">Serifs and Italics at a small size == ick! I had to zoom to 200% to read it!<br><br></div>
<p><a id="537691" href="#537691">#</a> <strong>Michael S. Kaplan</strong> on 23 Feb 2006 3:57 AM:</p><div style="margin-left: 1em">Hi Mihai --<br><br>Sorry, but MSLU has to have the final say here -- because running it under NT and pretending to be 9x, it is impossible to make things work. Running that way *is* suicide for a process, and suicide is simply not a scenario we have ever supported with MSLU....</div>
<p><a id="537714" href="#537714">#</a> <strong>Mihai</strong> on 23 Feb 2006 4:40 AM:</p><div style="margin-left: 1em">An application committing suicide if you lie to her :-)<br>This is a funny thought :-)<br><br>(PS: &quot;her&quot; is not a mistake. In most Latin languages &quot;application&quot; is feminin :-)<br></div>
<p><strong>Yuhong Bao</strong> on 21 Sep 2010 5:24 PM:</p><div style="margin-left: 1em"><p>Lying as a NT version will not be a problem, only lying as a 9x version will cause problems.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/02/23/537696.html" title="On an upgrade, we maintain">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/02/22/536877.html" title="And the digits just keep on coming">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/22/537269.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>