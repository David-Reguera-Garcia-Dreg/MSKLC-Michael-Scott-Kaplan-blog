<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/07/526359.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If the text is not complex, does it have to be treated like it is?</title></head><body>
<h1>If the text is not complex, does it have to be treated like it is?</h1>
<p><em>by Michael S. Kaplan, published on 2006/02/07 11:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/02/07/526359.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><font face=Tahoma>James Brown asked in the microsoft.public.win32.programmer.international newsgroup:</font></p>
<blockquote dir=ltr style="MARGIN-RIGHT: 0px">
<p><font face="Times New Roman" size=2><em>I have a fully working Uniscribe wrapper which renders a line of Unicode text, using the low-level ScriptItemize /Layout/Shape/Place/TextOut calls. Its working pretty well (very well in fact) but there is still one area I am not happy with. For a regular string of "english" text (i.e. non-complex), ScriptItemize always breaks the string into individual words. For a long line of text, containing much&nbsp;white-space and punctuation, this can result in quite a number of SCRIPT_ITEMs being returned.</em></font></p>
<p><font face="Times New Roman" size=2><em>This results in a large number of calls to ScriptTextOut to render the text, which is where the problem is - because I am required to call ScriptTextOut for each "item-run" in the text, this results in a fairly slow mode of operation - alot slower than calling ExtTextOut for the whole line for example. It's not that ScriptTextOut itself is slow, it is just the shear number of calls to the OS that is causing the problem.</em></font></p>
<p><font face="Times New Roman" size=2><em>So my idea is as follows:</em></font></p>
<p><font face="Times New Roman" size=2><em>After Shaping, all of the returned glyph-data for every item-run in the string is stored consecutively in a large buffer. Ordinarily I isolate each run in this buffer and draw the runs individually with ScriptTextOut.</em></font></p>
<p><font face="Times New Roman" size=2><em>However for a "simple" string of text (i.e one that ScriptIsComplex&nbsp;recognizes as such), I am proposing to pass the entire buffer of glyph/widths etc to&nbsp;ScriptTextOut in one go - so even if there was 30 runs of text, I would just treat this as one run and call ScriptTextOut just once - in essence, recombining all script-items into one single unit.</em></font></p>
<p><font face="Times New Roman" size=2><em>Assuming for the moment that I am using just one font, does anyone see any problem in this approach? The only issue I can see is specifying a correct SCRIPT_ANALYSIS structure (there is a unique structure per run so which&nbsp;would I specify?)</em></font></p>
<p><font face="Times New Roman" size=2><em>I have seen hints that maybe ScriptTextOut performs some trickery prior to calling ExtTextOut (for complex scripts) and that combining runs prior to calling it would be bad.....but for regular english text (code-points &lt; 255 for example) would this be ok?</em></font></p>
<p><font face=Tahoma><font face="Times New Roman" size=2><em>I have tested this method, and it does seem to work - and it is *much*&nbsp;faster this way... it would be nice for a Microsoft uniscribe/typography rep to comment on this approach.</em></font></font></p></blockquote>
<p><font face=Tahoma>The method itself should be sound (this type of use of <a href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_6m2g.asp">ScriptIsComplex</a>&nbsp;is very similar to the method that LPK.DLL (discussed <a HREF="http://archives.miloush.net/michkap/archive/2006/01/10/511194.html">previously</a>) uses to determine whether to forward text rendering calls to Uniscribe or not.</font></p>
<p><font face=Tahoma>(Of course in the case of LPK.DLL, Uniscribe is not called in the non-complex case, <a href="http://msdn.microsoft.com/library/en-us/gdi/fontext_2ks4.asp">ExtTextOutW</a> is; there may be&nbsp;a&nbsp;performance benefit to doing this since <a href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_6304.asp">ScriptTextOut</a> must evetually call <a href="http://msdn.microsoft.com/library/en-us/gdi/fontext_2ks4.asp">ExtTextOutW</a>&nbsp;to do the actual rendering -- so eliminating the extra overhead may&nbsp;be everyone's advantage).</font></p>
<p><font face=Tahoma>No I am not entirely clear on why non-complex text would be broken into separate runs (especially text for which <a href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_6m2g.asp">ScriptIsComplex</a>&nbsp;resturns FALSE), so I will probably try to dig a little deeper on that point.</font></p>
<p><font face=Tahoma>Does anyone have any theories? :-)</font></p>
<p><font face=Tahoma></font>&nbsp;</p>
<p><font face=Tahoma color=#ff1493><em>This post brought to you by</em> "<font size=6>à½œ</font>" <em>(<a href="http://www.fileformat.info/info/unicode/char/0f5c">U+0f5c</a>, a.k.a. TIBETAN LETTER DZHA)</em></font></p>
<hr/><p><a id="527166" href="#527166">#</a> <strong>Robert</strong> on 7 Feb 2006 8:13 PM:</p><div style="margin-left: 1em">I had exactly the same problem. In particular, splitting strings like &quot;the car, that&quot; into three separate runs &quot;the car|, |that&quot; prevents kerning of 'r' and ',' for fonts that support advanced typographic features. (You can see this in Notepad if complex script support is turned on: Set the font to Palatino Linotype 72pt, and type &quot;To the car, that&quot;; note that kerning is applied to &quot;To&quot; but not to &quot;r,&quot;.)<br /><br />I resorted to substituting punctuation (C1_PUNCT) with space characters (U+0020) prior to calling ScriptItemize. ScriptItemize seems to accept space characters for any script, so it does not generate separate items for punctuation and alphabetic characters. Of course, this method has undesirable effects in some cases. For example, it should not be used if the string contains RTL text because it would hide the directional information implied by the punctuation. Also it might cause problems in ScriptShape if the SCRIPT_ANALYSIS returned for the space character does not actually support punctuation marks.</div>
<p><a id="527236" href="#527236">#</a> <strong>Michael S. Kaplan</strong> on 7 Feb 2006 10:02 PM:</p><div style="margin-left: 1em">Wow, is this on all versions of Windows/Uniscribe, or is it specific to partcular versions?</div>
<p><a id="527679" href="#527679">#</a> <strong>James Brown</strong> on 8 Feb 2006 12:01 PM:</p><div style="margin-left: 1em">thanks (again) for picking this issue up from usetnet Michael! I'm part-way to finding an answer after stumbling over this quote from MSDN under the &quot;Shaping Engines&quot; section:<br /><br />&quot;Only scripts that have the property fComplex should be shaped with the script returned by the ScriptItemize function. All other runs may be merged and shaped with SCRIPT_UNDEFINED specified in the SCRIPT_ANALYSIS structure&quot;<br /><br />took me a while to figure out what this meant exactly. The fComplex flag belongs to the SCRIPT_PROPERTIES structure, however this is not directly related to any of the results returned by ScriptItemize, so how do I tell which script a SCRIPT_ITEM belongs to?. here's how:<br /><br />BOOL IsRunComplex(SCRIPT_ITEM *item)<br />{<br /> &nbsp; SCRIPT_PROPERTIES **propList;<br /> &nbsp; int propCount;<br /><br /> &nbsp; // get pointer to the global script table<br /> &nbsp; ScriptGetProperties(&amp;propList, &amp;propCount);<br /><br /> &nbsp; int scriptIndex = scriptItem.a.eScript;<br /><br /> &nbsp; return &nbsp; propList[scriptIndex]-&gt;fComplex;<br />}<br /><br />This method was buried within the Uniscribe docs under &quot;Determining if a script requires glyph shaping&quot;... well at least it was mentioned, wouldn't really call it 'documented' at any rate.<br /><br />So after this, any run which is _not_ complex can be merged, and the run's SCRIPT_ANALYSIS.eScript value set to SCRIPT_UNDEFINED. This will require careful coding as longer runs won't be breakable for word-wrapping so I guess this &quot;non-complex-script&quot; merging should happen after ScriptBreak has been called.<br /><br />It's not perfect - some forms of English punctuation/whitespace still aren't mergable. After testing I found a 30% &quot;reduction&quot; overall. Better than nothing I guess..<br /><br /><br /><br /></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/03/13 <a href="http://archives.miloush.net/michkap/archive/2007/03/13/1871045.html">We need to be optimizing for more than just the simple cases</a></p><p>2006/07/10 <a href="http://archives.miloush.net/michkap/archive/2006/07/10/661427.html">The PUA isn't complex enough</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/02/08/527375.html" title="They make &#39;em smarter than GetDateFormat">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/02/07/526339.html" title="ELK cultures for other platforms">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/07/526359.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>