<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/09/528297.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Is RtlCompareUnicodeString used correctly?</title></head><body>
<h1>Is RtlCompareUnicodeString used correctly?</h1>
<p><em>by Michael S. Kaplan, published on 2006/02/09 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/02/09/528297.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><font face=Tahoma>I'm not sure how many of you remember when I posted <a HREF="http://archives.miloush.net/michkap/archive/2005/11/13/491646.html"><strong>Hungarian is even more complicated than I thought</strong></a> and <a HREF="http://archives.miloush.net/michkap/archive/2005/11/22/495033.html"><strong>More on the fabled EqualString</strong></a>.</font></p>
<p><font face=Tahoma>Not because I don't have stats or anything, but because there is no way to gauge how many of you are new readers and how many of you really have nothing better to do that read what I am posting here. :-)</font></p>
<p><font face=Tahoma>Anyway, I am going to talk about <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_59d7c507-968a-4cf5-b1f0-91c8cd7ccb64.xml.asp">RtlEqualUnicodeString</a> and <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_ddeef320-7510-446b-af6f-756c3999bec1.xml.asp">RtlCompareUnicodeString</a>, the functions in ntdll.dll that do binary comparisons that can be cae insensitive,&nbsp;again.</font></p>
<p><font face=Tahoma>I found out something really interesting about them the other day.</font></p>
<p><font face=Tahoma>Now it is obvious how <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_59d7c507-968a-4cf5-b1f0-91c8cd7ccb64.xml.asp">RtlEqualUnicodeString</a>&nbsp;might be used -- I mean, if you have two strings and you need to know <em>in a binary sense</em> whether they are equal (possibly ignoring case) then it can be very handy. Because no matter how un-natural the comparison seems to humans, the fact is that lots of Windows loves it.</font></p>
<p><font face=Tahoma>Of course the actual usage of <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_ddeef320-7510-446b-af6f-756c3999bec1.xml.asp">RtlCompareUnicodeString</a>&nbsp;is a bit less clear -- I mean, the order has no meaning to humans. So a function that uses it to order two strings seems like a ripe source for incorrect usage.</font></p>
<p><font face=Tahoma>Don't worry, it turns out that nobody is using that order inappropriately.</font></p>
<p><font face=Tahoma>In just about every case, the return value of the function is tested to see whether it was equal to or not equal to zero.</font></p>
<p><font face=Tahoma>Yes, that is right -- almost everyone who uses it is essentially duplicating the functionality of <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_59d7c507-968a-4cf5-b1f0-91c8cd7ccb64.xml.asp">RtlEqualUnicodeString</a>.</font></p>
<p><font face=Tahoma>When you get down to it, one has to wonder how much more expensive is operation A than operation B:</font></p>
<p><font face=Tahoma size=2><em><strong>A</strong> - compare two strings, one WCHAR at a time, return the difference if there is one as soon as you find it, then compare that number to zero to see if there is in fact a difference.</em></font></p>
<p><font face=Tahoma size=2><em><strong>B</strong> - compare two strings, one WCHAR at a time, return TRUE or FALSE as soon as you know whether they are in fact equal.</em></font></p>
<p><font face=Tahoma>Remembering for a moment that a difference that makes no difference, makes no difference -- do you think it makes a significant difference?</font></p>
<p><font face=Tahoma>Hopefully not. Though it worries me that no one seems to be doing anything beyond what <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_59d7c507-968a-4cf5-b1f0-91c8cd7ccb64.xml.asp">RtlEqualUnicodeString</a>&nbsp;would provide. So why take a hit at all?</font></p><font face=Tahoma>
<p><font face=Tahoma>I resisted the temptation to just go and fix all of the occurrences&nbsp;(it is a 100% safe change but even so, I hate when people do it to code I own).</font></p>
<p><font face=Tahoma>I also resisted the temptation to send out a bunch of mail to all of the owners to tell them to change their code (I hate when people do that to me, too).</font></p>
<p>Now that I read this post again, it occurs to me that this&nbsp;will probably not actually be very interesting to people. It just seemed weird to me.</p>
<p>Though if you own one of those calls to <a href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_ddeef320-7510-446b-af6f-756c3999bec1.xml.asp">RtlCompareUnicodeString</a>,&nbsp;then feel free to change it; at worst it will just be more self-documenting as to the intention, and at best (if the code is called many times in a tight loop) it&nbsp;could even help performance!</p>
<p>&nbsp;</p>
<p><font color=#ff1493><em>This post brought to you by</em> "P" <em>(<a href="http://www.fileformat.info/info/unicode/char/0050">U+0050</a>, a.k.a. LATIN CAPITAL LETTER P)</em></font></p></font>
<hr/><p><a id="528412" href="#528412">#</a> <strong>Siva</strong> on 9 Feb 2006 3:45 AM:</p><div style="margin-left: 1em">It is very useful</div>
<p><a id="528481" href="#528481">#</a> <strong>Nick Lamb</strong> on 9 Feb 2006 7:04 AM:</p><div style="margin-left: 1em">The links suffer from the usual MSDN URL instability, do they work for you Michael?<br /><br />RtlCompareUnicodeString ought to be useful except that it is poorly described, which tends to make one think that the people who wrote it didn't know what it was for either...<br /><br />Anyway, an optimist would expect it to be useful where strings (e.g. filenames) need an order, any unique order. This allows you to binary search, build various types of tree structure etc. Obviously doing such things with a locale-sensitive function would be silly (Microsoft has done it before, but it's still silly).<br /><br />The UTF-16 WCHAR algorithm described in this article would probably work for such a purpose, but if that's what was used it should be clearly indicated because UTF-16 isn't code point order, unlike UTF-8 or UTF-32. So the result is even /more/ unintuitive.</div>
<p><a id="528536" href="#528536">#</a> <strong>Michael S. Kaplan</strong> on 9 Feb 2006 8:48 AM:</p><div style="margin-left: 1em">They do work for me, maybe something was down?<br /><br />Well, it is as useful as the *_BIN collations in SQL Server (which actually have the same order!).</div>
<p><a id="528943" href="#528943">#</a> <strong>Dean Harding</strong> on 9 Feb 2006 5:29 PM:</p><div style="margin-left: 1em">Yeah, I would have imagined that RtlCompareUnicodeString would be useful for building sorted lists or trees needed for searching, but not necessarily by humans.<br /><br />It does seem a little silly to use it instead of RtlEqualUnicodeString, but surely the only difference would be the return statement (i.e. just return the difference between the two inequal WCHARs, instead of a constant TRUE/FALSE) so it's probably at most 1 extra seembly instruction...</div>
<p><a id="529281" href="#529281">#</a> <strong>Christian Kaiser</strong> on 10 Feb 2006 2:32 AM:</p><div style="margin-left: 1em">Just what I wanted to write: comparing the strings and returning an order is needed for skip lists and other lists that need a way to find a key. This function is well needed.<br><br>So my question would be: what's better with RtlEqualUnicodeString()? All us C/C++ programmers will mix TRUE with &quot;==0&quot; is the APIs are mixed... Who has not yet written (&quot;if (strcmp())&quot;) at east once and meant that the following code should be executed when the strings are equal? ;-) <br><br>The execution speed should be the same, testing for a Zero or non-Zero-result is no difference.<br><br>My conclusion: both are needed, but adding the &quot;Equal&quot; function helps for clarity of source code, in places where only the &quot;equalness&quot; counts. <br><br>Christian<br></div>
<p><a id="529309" href="#529309">#</a> <strong>Michael S. Kaplan</strong> on 10 Feb 2006 3:16 AM:</p><div style="margin-left: 1em">I agree both are potentially needed (each for different sitautions), it is just bothersome to me that most of the usage of one ought to be the other, that's all. :-)</div>
<p><a id="530144" href="#530144">#</a> <strong>Serge Wautier</strong> on 11 Feb 2006 8:07 AM:</p><div style="margin-left: 1em">Ouch... for a while, I figured Rtl stands for Right-to-left!<br>I hope I don't need some coffee because I hate coffee :-D</div>
<p><strong>Yuhong Bao</strong> on 12 Mar 2009 1:00 AM:</p><div style="margin-left: 1em"><p>&quot;Ouch... for a while, I figured Rtl stands for Right-to-left! &quot;</p>
<p>Nope, it stands for &quot;Run-Time Library&quot;. Do you know about the NT Native APIs in NTDLL.DLL? Rtl* APIs were utility functions that in user mode did not call directly to kernel mode. Nt* and Zw* APIs were in user mode stubs to do a system call to kernel mode which implements the API. In kernel mode, the Win32 API do not exist, and so the NT Native APIs are always used, and in kernel mode there is a difference between Zw* and Nt*. These APIs are mostly undocumented, the third-party that created Interix (a replacement for the POSIX subsystem) had to obtain NT source code to do so.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/03/15 <a href="http://archives.miloush.net/michkap/archive/2010/03/15/9974423.html">Thus the problems resist solution, and the workarounds are often inadequate</a></p><p>2007/10/15 <a href="http://archives.miloush.net/michkap/archive/2007/10/15/5462057.html">We're Lost. Maybe the map is wrong. Maybe all maps are wrong?</a></p><p>2007/09/14 <a href="http://archives.miloush.net/michkap/archive/2007/09/14/4900107.html">How do I feel about lstrcmpi? I think it blows....</a></p><p>2007/07/12 <a href="http://archives.miloush.net/michkap/archive/2007/07/12/3829450.html">Wait til you see my 'O'[EMCP based technology]</a></p><p>2006/04/29 <a href="http://archives.miloush.net/michkap/archive/2006/04/29/586726.html">'Which comes first?' vs. 'Are they equal?'</a></p><p>2006/03/02 <a href="http://archives.miloush.net/michkap/archive/2006/03/02/542395.html">CompareString ignores case by lowercasing....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/02/09/528337.html" title="Every character has a story #17: U+534d and U+5350">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/02/08/527375.html" title="They make &#39;em smarter than GetDateFormat">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02-09">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/09/528297.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>