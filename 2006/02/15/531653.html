<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/15/531653.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Mixing MLang and Uniscribe</title></head><body>
<h1>Mixing MLang and Uniscribe</h1>
<p><em>by Michael S. Kaplan, published on 2006/02/15 05:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/02/15/531653.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Ian Treleaven asked in the Suggestion Box:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>Thanks for getting to my Uniscribe question this past December, which I now realized was very open-ended. </EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>I would like to see an example or hints on font substitution when using Uniscribe.&nbsp; It seems you can use MLang to build a font, but there seem to be some tricks involved in getting that font used.&nbsp; I assume the right place is after a call to ScriptShape that returns USP_E_SCRIPT_NOT_IN_FONT. </EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>At the 2005 PDC, David Brown mentioned informally that Uniscribe should not be used to render Asian text.&nbsp; Can you elaborate? </EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Hopefully Ian will not mind if I take some of his post out of order. :-)</FONT></P>
<P><FONT face=Tahoma>First, I don't think your question I responded to in the post <A href="http://archives.miloush.net/michkap/archive/2005/12/06/500485.html"><STRONG>The Lack of Uniscribe Samples</STRONG></A> was specifically open-ended, other than (as I pointed out that post) that there needs to be more info on the actual scenarios using Uniscribe that are involved.&nbsp;Scenarios do exist, but samples do need to have the ones whose solutions are being illustrated explained a bit more fully....</FONT></P>
<P><FONT face=Tahoma>Talking to David Brown about your question about Uniscribe and Asain text, he had this to say:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>I don’t remember what the context of this was – that certainly seems too general a statement given the amount of East Asian support that has been added to Uniscribe over the years.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>Background: Originally Uniscribe was designed to solve complex script rendering by a team (and team lead – me) that had little experience of East Asian issues. One particularly messy issue that took a few years before it was fixed was the rendering of surrogate codepoints in vertical text – before that fix went in surrogate codepoints were not rotated correctly.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>I’m sure there are plenty of things still left that don’t work too well without extra work by the customer. ScriptBreak for example provides wordbreak points for complex scripts, but not for East Asian text, indeed it isn’t designed right to handle East Asian - it currently is passed individual runs, which doesn’t allow it to handle the junction between runs correctly.</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>Font fallback is designed entirely for complex scripts. To roll your own font linking life gets a lot more complex when you want to support both complex scripts and East Asian, with hindsight we should have made it easier....</EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>The thing the we should probably tell customers about rendering East Asian text is that they will need to implement font fallback, line breaking and vertical run handling themselves, and that this requires more code than just supporting Western and complex scripts does. (And we don’t have a sample). Nonetheless they should be sending East Asian text through Uniscribe as it is required to get the OpenType features just coming in with the latest fonts.</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now Ian -- you may have noticed what David has (perhaps intentionally?) provided here -- some good example scenarios for potential future samples.</FONT></P>
<P><FONT face=Tahoma>And yes I am taking note and will see if I can provide some of these in the future! :-)</FONT></P>
<P><FONT face=Tahoma>For that last point (well actually your second point -- I told you I was working out of order here!)....</FONT></P>
<P><FONT face=Tahoma>The interaction between MLang font linking and Uniscribe font fallback is somewhat involved, to put it mildly.</FONT></P>
<P><FONT face=Tahoma>MLang is creating a synthetic font that can be used to render text that spans script boundaries, as I discuss in <A href="http://archives.miloush.net/michkap/archive/2005/05/16/417711.html"><STRONG>Font substitution and linking #2</STRONG></A>. Awesome feature, but....</FONT></P>
<P><FONT face=Tahoma>Since this support is external to GDI,&nbsp;MLang is not creating an updated CMAP table for this synthetic&nbsp;font, and it is indeed&nbsp;the CMAP table that Uniscribe uses to figure out whether the font supports all the characters. So how to get Uniscribe to use this synthesized font that may have been created by carefully getting the best glyphs possible?</FONT></P>
<P><FONT face=Tahoma>Well, you were looking in the right place --&nbsp;after&nbsp;that&nbsp;call to <A href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_7yhx.asp">ScriptShape</A>. But there are actually two things to check here:</FONT></P>
<UL>
<LI><FONT face=Tahoma>A&nbsp;USP_E_SCRIPT_NOT_IN_FONT error code (as you mentioned), and</FONT> 
<LI><FONT face=Tahoma>Missing glyphs.</FONT></LI></UL>
<P><FONT face=Tahoma>The reason for the second check for East Asian text is that there are no typographic features required of fonts, so you wouldn't really expect to see USP_E_SCRIPT_NOT_IN_FONT. You basically must scan the output of ScriptShape for missing glyphs in order to discover when to do font substitution.</FONT></P>
<P><FONT face=Tahoma>But if Uniscribe is using the font's CMAP tables, it becomes difficult to know how to tell it to just try to render and ignore what the CMAP table is telling it.</FONT></P>
<P><FONT face=Tahoma>To accomplish things here you would have to take these East Asian runs and then (as David mentioned) implement font fallback, line breaking and vertical run handling yourself. Decidely non-trivial....</FONT></P>
<P><FONT face=Tahoma>However, the truth is that combining MLang and Uniscribe for the East Asian scripts does not make as much sense since the fonts themselves are big enough that it is unlikely to require a synthetic font, and Uniscribe itself does not handle East Asian all that specially anyway. Picking a font that supports the characters to start with may well be the best answer for this case.</FONT></P>
<P><FONT face=Tahoma>For the actual complex script cases, you can actually work to modify those 'missing character' entries if you know that the font supports the glyphs in question, of course.</FONT></P>
<P><FONT face=Tahoma>A very rich area for future posts!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>囗</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/56d7">U+56d7</A>, a CJK Unified Ideograph meaning erect, proud, upright, or bald)</EM></FONT></P>
<hr/><p><a id="532818" href="#532818">#</a> <strong>Andrew West</strong> on 15 Feb 2006 5:44 PM:</p><div style="margin-left: 1em">&quot;This post brought to you by &quot;囗&quot; (U+56d7, a CJK Unified Ideograph meaning erect, proud, upright, or bald)&quot;<br><br>... which I'm afraid is yet another Unihan mistake that has been around for years without anyone noticing.<br><br>U+56D7 囗 is the archaic form of U+570D w&#233;i 圍 &quot;to encircle, surround&quot;. In modern usage it is also used as an ultra-simplified form of U+56FD gu&#243; 国 &quot;country&quot;. But it has never meant anything like erect, proud, upright or bald (!). The definition must be for a different character, although it's not immediately obvious which one.<br><br>None of the non-normative fields in the Unihan database can be relied on to any great extent, and the definitions are particularly unreliable. There are some *really* awful ones -- U+6A36 is one that I have noticed just now (prize to anyone who can explain the definition).<br><br>Given that in many cases it is impossible to accurately or meaningfully define a character's meaning without giving lengthy, dictionary-like entries, if it were up to me I would dispense with the definitions altogether (if nothing else, it would knock off over 1MB in the size of Unihan.txt).<br></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/02/06 <a href="http://archives.miloush.net/michkap/archive/2007/02/06/1609072.html">MLang and GDI and Uniscribe, oh my!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/02/15/532394.html" title="Every character has a story #19: U+200c and U+200d (ZERO WIDTH [NON] JOINER)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/02/14/531621.html" title="A Read-Only, Modified CultureInfo?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-02-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/02/15/531653.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>