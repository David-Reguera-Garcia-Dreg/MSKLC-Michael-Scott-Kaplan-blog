<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/10/1053925.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Some people feel really insecure about the size of their [string] members</title></head><body>
<h1>Some people feel really insecure about the size of their [string] members</h1>
<p><em>by Michael S. Kaplan, published on 2006/11/10 06:05 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/11/10/1053925.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma size=3>
<P>Developer Andrew Arnott asks: </P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P>Michael,<BR><BR>David Kline recommended I forward my question on to you.&nbsp; If you have time to point me at the appropriate Windows API I’d surely appreciate it.<BR><BR>Michael Howard (Writing Secure Code) and this blog both suggest that UTF-16 has some 32-bit characters.&nbsp; In the .NET Compact Framework code that I work with, I see lots of code like this:<BR><BR><FONT face="consolas,courier new,lucida console,courier"><STRONG>int cchLengthInCharacters = cbLengthInBytes / sizeof(WCHAR);<BR><FONT color=#00cc00>// or</FONT><BR>int cbLengthInBytes = cchLengthInCharacters * sizeof(WCHAR);</STRONG></FONT><BR><BR>Yet my understanding of Writing Secure Code and of <A class="" href="http://www.tbray.org/ongoing/When/200x/2003/04/26/UTF" mce_href="http://www.tbray.org/ongoing/When/200x/2003/04/26/UTF">this blog</A> leads me to believe that if you have even one 32-bit Unicode character in there, you could be asking for a buffer overflow with code like this.&nbsp; I think the book suggests a Windows API call that should be made to evaluate the true character length of a Unicode string safely, but I can’t remember what it is. <BR><BR>Can you comment on this, and if you know the API Windows makes available can you let me know which it is?<BR><BR>Thanks,<BR><BR>Andrew</P></FONT></BLOCKQUOTE>
<P>Hmmm, kind of a trick question, that. One that I have sort of covered a few times <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/07/406060.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/07/406060.html">in</A></STRONG> <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">the</A></STRONG> <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html">past</A></STRONG>....</P>
<P>There are really three possible&nbsp;ways to answer the question "how big is that string?". There is </P>
<OL>
<LI>what a Unicode Win32 API thinks of as a character -- a single WCHAR -- the sort of thing you get back from the [unmanaged] <A class="" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/lstrlen.asp" mce_href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/lstrlen.asp">lstrlenW</A> or the [managed] <A class="" href="http://msdn2.microsoft.com/en-us/library/system.string.length.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.length.aspx">System.String.Length</A>;</LI>
<LI>what the Unicode standard thinks of as a character -- a single text element -- the sort of thing you get back&nbsp;from the [unmanaged] <A class="" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnext.asp" mce_href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnext.asp">CharNextW</A> (when <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html">it</A></STRONG> <A class="" href="http://archives.miloush.net/michkap/archive/2005/01/30/363420.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/30/363420.html"><STRONG>works</STRONG></A>) or the [managed] <A class="" href="http://msdn2.microsoft.com/library/k0hkw6hw(en-us,vs.80).aspx" mce_href="http://msdn2.microsoft.com/library/k0hkw6hw(en-us,vs.80).aspx">System.Globalization.StringInfo</A> class (discussed <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">here</A></STRONG>) and that Mark Davis (president of the Unicode Consortium) thinks of as a grapheme cluster;</LI>
<LI>what a typical user who reads and writes in a language thinks of as a character --&nbsp;a single sort element -- the sort of thing that no Win32 function returns directly but indirectly the unmanaged and managed collation functions/methods use and which I have also talked about <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html">previously</A></STRONG>.</LI></OL>
<P>The simple truth is that I find the blog post that <A class="" href="http://www.tbray.org/ongoing/misc/Tim" mce_href="http://www.tbray.org/ongoing/misc/Tim">Tim Bray</A> wrote that concerned Andrew so much (I mean that one entitled <A class="" href="http://www.tbray.org/ongoing/When/200x/2003/04/26/UTF" mce_href="http://www.tbray.org/ongoing/When/200x/2003/04/26/UTF">Characters vs. Bytes</A>) to be very confusing, mainly because it takes advantage of the fact that these three definitions plus a fourth one (the count of bytes) might be thought of as the same but truly are not. But it is written in a way that is easy to freak a person out who is worried about security. </P>
<P>However, in the context of SECURITY, only the first definition&nbsp;and fourth definitions are relevant to the "<STRONG>count of characters</STRONG>/<STRONG>count of bytes</STRONG>" issue&nbsp;and it is a bug to call anything else a secure answer. Surrogate pairs are ONE SMALL PART of this issue (and the most popular one for people who are trying to goose people on their assumptions in this space), but Ḝ (LATIN CAPITAL LETTER E+ COMBINING CEDILLA + COMBINING BREVE) is three WCHARs&nbsp;yet only a moron would not see that to most of the world this is one character even though to developers who have to deal with buffer allocation and WCHAR counts and such it is really secretly three.</P>
<P>You'd think, given </P>
<UL>
<LI>the male preoccupation with size in our culture (such as it is) and </LI>
<LI>the disproportionate number of male software developers in the world</LI></UL>
<P>that&nbsp;these developers&nbsp;would readily embrace the two&nbsp;answers to the "how big is it?" question that provide the largest number. But it still comes up quite often as a security concern or as "proof" that UTF-16 is incomplete because of surrogate pairs needing more than one code unit, and the trend does not seem to indicate that the problem is getting any better. There are way too many developers who feel quite insecure about the size of their string members, and they really need to be reassured on this point!</P>
<P>I will be doing my part next week at the <A class="" href="http://www.unicodeconference.org/conference-at-a-glance.htm" mce_href="http://www.unicodeconference.org/conference-at-a-glance.htm">30th Internationalization and Unicode conference</A>, in my afternoon presentation. If you read here&nbsp;then I know that you do not have this sort of problem, but perhaps if you can be there you might learn some tricks to help others. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=6>Ḝ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/1e1c" mce_href="http://www.fileformat.info/info/unicode/char/1e1c">U+1e1c</A>, a.k.a. LATIN CAPITAL LETTER E WITH CEDILLA AND BREVE)</EM></FONT></P></FONT>
<hr/><p><strong>Wilhelm Svenselius</strong> on 10 Nov 2006 7:05 AM:</p><div style="margin-left: 1em"><p>So what was the answer to the question? How _do_ you reliably find the number of bytes in a UTF-16 string?</p>
<p>My best guess would be System.Text.Encoding.Unicode.GetByteCount( string s ). &quot;Unicode&quot; actually means UTF-16 here according to MSDN.</p></div>
<p><strong>Michael S. Kaplan</strong> on 10 Nov 2006 7:13 AM:</p><div style="margin-left: 1em"><P>The number of bytes is actually the number of "characters" (by definition #1) * sizeof(WCHAR)....</P>
<P>If you are in managed code, it is string.Length * 2 -- since you know the length without walking the string, it is faster to use that information (just like in COM).</P></div>
<p><strong>Mihai</strong> on 10 Nov 2006 12:28 PM:</p><div style="margin-left: 1em"><p>By the way security articles (well, I had to link somehow to the current topic :-)</p>
<p>Read here: <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/msdnmag/issues/06/11/SecureHabits/default.aspx">http://msdn.microsoft.com/msdnmag/issues/06/11/SecureHabits/default.aspx</a></p>
<p>The article is &quot;8 Simple Rules For Developing More Secure Code&quot;</p>
<p>And rule number 6 is &quot;Don't Write Insecure Code&quot;</p>
<p>Duh! This alone is enough, you don't need any other rule!</p>
<p>:-)</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/01/24 <a href="http://archives.miloush.net/michkap/archive/2007/01/24/1520227.html">Sometimes a WCHAR really *is* just a character....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/11/11/1061686.html" title="Keeping out more of the undesirables">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/11/09/1043843.html" title="You wonder if like Vista supports custom locales? Fer shur!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/10/1053925.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>