<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/28/1166834.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When you ask how long it is, keep in mind that some guys may exaggerate their answer</title></head><body>
<h1>When you ask how long it is, keep in mind that some guys may exaggerate their answer</h1>
<p><em>by Michael S. Kaplan, published on 2006/11/28 14:30 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/11/28/1166834.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face="Segoe UI,Tahoma">
<P>A common question someone might have if they need to allocate a buffer is <STRONG>How much space do I need to allocate?</STRONG></P>
<P>The question seems simple enough to ask, right? </P>
<P>Of course there are two different possible answers to the question when one is dealing with the non-Unicode versions of functions:</P>
<UL>
<LI>Functions like <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp">GetDateFormat</A> and <A class="" href="http://msdn2.microsoft.com/en-us/library/ms776290.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776290.aspx">LCMapString</A>&nbsp;when called with a NULL target buffer, will return the exact value required as&nbsp;they will call the Unicode version (which will allocate as needed to get the exact size), and then convert the resulting string back out of Unicode;</LI>
<LI>Functions like <A class="" href="http://msdn2.microsoft.com/en-gb/library/ms724902.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/ms724902.aspx">RegQueryInfoKey</A> and <A class="" href="http://msdn2.microsoft.com/en-us/library/ms633521.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms633521.aspx">GetWindowsTextLength</A> which will actually just assume two bytes per WCHAR that the Unicode version tells it and return a "maximum buffer size" rather than the actual buffer size.</LI></UL>
<P>Now the hint I gave above about all of the extra work that the NLS API does is the answer to the obvious question people ask about why they have to put up with getting an estimated answer rather the actual answer -- there is a performance hit to that extra effort placed!</P>
<P>There are also plenty of people (like the SQL Server team) that hate the NLS "call twice" semantic due to the performance issue and the fact that we allocate. They&nbsp;prefer to&nbsp;use their own buffers and just call us once each time.</P>
<P>So clearly these two models each have&nbsp;a place in Windows (one is faster and less memory fragmenting, the other is more accurate), though admittedly the documentation could perhaps be clearer in some cases about which is which....</P>
<P>The rules are not always <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2004/12/19/325199.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/19/325199.html">totally consistent</A></STRONG>, either;&nbsp;even within NLS, there is the <A class="" href="http://msdn2.microsoft.com/en-us/library/ms776395.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776395.aspx">NormalizeString</A> function, which estimates (and sometimes in some extreme cases even returns a buffer size that is too small, a factoid that causes lots of grief for <A class="" href="http://msdn2.microsoft.com/en-gb/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/en-gb/library/ms647478.aspx">FoldString</A> function in Vista, which guarantees exact results even though for MAP_FOLDCZONE, MAP_PRECOMPOSED, and MAP_COMPOSITE it wraps <A class="" href="http://msdn2.microsoft.com/en-us/library/ms776395.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms776395.aspx">NormalizeString</A>).</P>
<P>Which just goes to show you that as in life you have to keep in mind when people might exaggerate when you ask them how long something is for reasons that they may or may not choose to make entirely clear to the people asking. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=6>ê®å</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/10a0c" mce_href="http://www.fileformat.info/info/unicode/char/10a0c">U+10a0c</A>, a.k.a. KHAROSHTI VOWEL LENGTH MARK)</EM></FONT></P></FONT>
<hr/><p><a id="1169724" href="#1169724">#</a> <strong>A.C.</strong> on 29 Nov 2006 12:32 AM:</p><div style="margin-left: 1em"><p>Your analogy breaks down quickly, Michael. Guys who exaggerate their &quot;length&quot; don't do it out of laziness.</p></div>
<p><a id="1169770" href="#1169770">#</a> <strong>Michael S. Kaplan</strong> on 29 Nov 2006 12:55 AM:</p><div style="margin-left: 1em"><p>True enough, A.C. But they sometimes do it out of performance anxiety. So I think my analogy may still be intact (though I admit it hadn't occurred to me before)....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/11/28/1170048.html" title="Your layout (in all likelihood) bores me">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/11/27/1160195.html" title="Any database developers reading this?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/28/1166834.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>