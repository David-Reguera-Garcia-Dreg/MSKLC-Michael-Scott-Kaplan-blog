<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/11/1061686.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Keeping out more of the undesirables</title></head><body>
<h1>Keeping out more of the undesirables</h1>
<p><em>by Michael S. Kaplan, published on 2006/11/12 00:36 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/11/11/1061686.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma size=3>
<P>Remember my posts about stripping diacritics using normalization? </P>
<P>Well, Feroze does. Just the other day he asked me: </P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P>I had spoke to you a couple of months ago, about normalizing a string to remove diacritics, and to expand some ligatures. You had pointed me to some code on your blog which shows how to do this.<BR><BR>Anyway all that is working fine for us. However, we have a problem – in that our test team is passing a string to our function, and that is causing String.Normalize(NormalizationForm.FormD) to throw an ArgumentException, saying that the Unicode code point at a certain index is invalid.<BR><BR>So I had a look at the code, and it seems that our test team is doing the following to generate a random string: First they generate a random character, and add that to a string using append. <BR><BR><FONT face="consolas,lucida console,courier new,courier"><STRONG>Char c = (char)rand.Next(32,65535)<BR>S = s + c;</STRONG></FONT><BR><BR>Now, I am not at all familiar with Unicode, but do you think that these two lines do not give a valid string always? Are all values in the range [32,65535] valid ordinal for Unicode characters?<BR><BR>Sorry if this is a silly question – I looked up the Unicode standard but could not figure out from it whether this was valid or not.<BR><BR>Feroze&nbsp;</P></FONT></BLOCKQUOTE>
<P mce_keep="true">Of course the answer is that the range of code units from 0x0020 (32) to 0xffff (65535) contains plenty of code units that&nbsp;are not valid in Unicode. Some are permanently reserved&nbsp;and&nbsp;will never be valid, some are roadmapped for future assignment, and some are just in the small pool of "nothing there yet but one day something could end up being assigned to the spot". Not all of those cases cause errors in nomalization, but deoending on what the ciode is trying to do, iut could be leading to invalid test cases.</P>
<P mce_keep="true">All of this led to an obvious anticipatory&nbsp;follow-up question from Feroze:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P mce_keep="true">Thanks for your reply. The only followup question I have is: why isn't the cast to Char from int throwing, or the append to string of an invalid Unicode character?<BR><BR>Is that a bug?</P></FONT></BLOCKQUOTE>
<P mce_keep="true">This is an excellent question,&nbsp;actually. In my opinion this&nbsp;is not a bug at all.&nbsp;Some might classify it as a&nbsp;design limitation in the datatype, and&nbsp;others may feel it borders more on a design flaw. But it does fall somewhere on that particular axis of interpretation.... :-)</P>
<P mce_keep="true">But let me explain why I do not feel that this is a bug.</P>
<P mce_keep="true">The problem here is that the <A class="" href="http://msdn2.microsoft.com/en-us/library/system.string.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.aspx">System.String</A> datatype (like it's WCHAR/LPWSTR ancestors)&nbsp;which is documented that it "<EM>represents text as a series of Unicode characters</EM>", is forgiving about any and all code units that are not valid Unicode code points, but the <A class="" href="http://msdn2.microsoft.com/en-us/library/system.string.normalize.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.normalize.aspx">System.String.Normalize</A> method, and its unmanaged counterpart the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_normalize_string.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_normalize_string.asp">NormalizeString</A>&nbsp;function, which implements Unicode normalization,&nbsp;is not quite so forgiving.</P>
<P mce_keep="true">Though in order to maximize their usefulness, these methods do allow all of those "not yet assigned" code units; it is only the ones that are reserved and which never represent valid Unicode data that are blocked. Which is why the code Feroze asked about will work just fine until it randomly doesn't.</P>
<P mce_keep="true">The Unicode terminology here has them described as noncharacters&nbsp;in section&nbsp;16.7 of Unicode 5.0 (more on 5.0 soon!):</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>Noncharacters are code points that are permanently reserved in the Unicode Standard for internal use. They are forbidden for use in open interchange of Unicode text data. See Section 3.4, Characters and Encoding, for the formal definition of noncharacters and conformance requirements related to their use.</EM></P></BLOCKQUOTE>
<P mce_keep="true">Since these code points cannot ever be valid in Unicode data, they make a potentially interesting set of sentinel or other such values that an implementation can use for a particular algorithm (kind of like what the console was doing with 0x0100 as I described in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/01/30/519760.html" mce_href="http://archives.miloush.net/michkap/archive/2006/01/30/519760.html">Ā was unexpected at this time</A></STRONG>, only having it not be a&nbsp;bug since the values are actually reserved and cannot ever be used....</P>
<P mce_keep="true">Now of course <A class="" href="http://msdn2.microsoft.com/en-us/library/system.string.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.string.aspx">System.String</A>&nbsp;can be used for both publicly interchanged strings and ones used only internally, so the use of non-characters in the latter is not necessarily a bug. The decision to make it illegal to pass them&nbsp;through Microsoft's implementation of the Unicode&nbsp;normalization algorithm (see <A class="" href="http://www.unicode.org/reports/tr15/" mce_href="http://www.unicode.org/reports/tr15/">Unicode Standard Annex #15: Unicode Normalization Forms</A>) is a choice that is not prescribed but it is also not forbidden -- think of it as another <A class="" href="http://archives.miloush.net/michkap/archive/2006/05/31/612544.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/31/612544.html"><STRONG>nice bit of social engineering</STRONG></A> to help keep these noncharacters from being publicly interchanged. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>this post brought to you by <A class="" href="http://www.fileformat.info/info/unicode/char/fffe" mce_href="http://www.fileformat.info/info/unicode/char/fffe">U+FFFE</A>, one of the most famous of all of the noncharacters</EM></FONT></P></FONT>
<hr/><p><strong>Doug</strong> on 12 Nov 2006 2:11 AM:</p><div style="margin-left: 1em"><p>You'll need to check for more than just invalid code points. You also need to check for incorrect usage of chars in the surrogate range.</p></div>
<p><strong>Michael S. Kaplan</strong> on 12 Nov 2006 2:43 AM:</p><div style="margin-left: 1em"><p>Very true, Doug. Though the rules about intercharacter invalidity are different than code points with noncharacter status....</p>
<p>This is also an issue that comes up in other contexts, such as code pages. I'll be covering this in a post coming up very soon (perhaps even tomorrow some time!).</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 12 Nov 2006 2:44 AM:</p><div style="margin-left: 1em"><P>(Note that the orginal "<A class="" href="http://archives.miloush.net/michkap/archive/2006/05/31/612544.html">keeping out the undesirables</A>" post featured unpaired surrogates quite prominently!)</P></div>
<p><strong>Alan McFarlane</strong> on 13 Nov 2006 8:43 AM:</p><div style="margin-left: 1em"><p><a rel="nofollow" target="_new" href="http://blogs.msdn.com/imtesty/archive/2006/11/12/more-on-globalization-testing-and-random-unicode-string-generation.aspx">http://blogs.msdn.com/imtesty/archive/2006/11/12/more-on-globalization-testing-and-random-unicode-string-generation.aspx</a> talks of a tool of his/hers which:</p>
<p>&quot;will generate random strings of Unicode characters between the ranges of U+0020 and U+FFFF up to 65,535 characters in length either as a fixed length string or a random length string. The ranges of Unicode code points that are not assigned to a language script, and special areas such as Private use and surrogate areas are excluded from the generated strings.&quot;</p>
<p>Haven't looked at it further...</p>
<p>Alan</p></div>
<p><strong>Michael S. Kaplan</strong> on 13 Nov 2006 11:03 AM:</p><div style="margin-left: 1em"><P>Yeah, this one may or may not have a problem here -- kind of eerie, all the similarities, huh? :-)</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/02/14 <a href="http://archives.miloush.net/michkap/archive/2007/02/14/1674482.html">Quite a [non]character, it is</a></p><p>2006/11/12 <a href="http://archives.miloush.net/michkap/archive/2006/11/12/1064717.html">Maybe it is the name that is 'Undesirable' ?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/11/12/1031784.html" title="If I wasn&#39;t watching her blog, could you really claim I was filtering the list of blogs I read?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/11/10/1053925.html" title="Some people feel really insecure about the size of their [string] members">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/11/1061686.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>