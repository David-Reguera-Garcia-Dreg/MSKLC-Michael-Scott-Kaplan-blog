<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/20/1112734.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Putting the *backward* in backward compatibility</title></head><body>
<h1>Putting the *backward* in backward compatibility</h1>
<p><em>by Michael S. Kaplan, published on 2006/11/20 22:31 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/11/20/1112734.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma size=3>
<P>There have been many times that I have championed backward compatibility. Or maybe it's backward<STRONG>s</STRONG> compatibility? Anyone from Language Log want to chime in on which one is right? :-)</P>
<P>Anyway, there have been many times I have championed backward[s] compatibility in the past.</P>
<P>But there are times when it is probably a bad idea. When it is, to put it simply, quite backward.</P>
<P>A good example of this? </P>
<P>Well, think about the recent post <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/10/24/867880.html" mce_href="http://archives.miloush.net/michkap/archive/2006/10/24/867880.html">Sometimes in the future 'ANSI' is really going to be unsupported!</A></STRONG>, and what it refers to as the second problem:</P>
<BLOCKQUOTE><FONT size=2>
<P>Ok, this leads us to the next problem, one that in my opinion is caused by the .NET Framework. For the sake of backward compatibility with VB4, VB5, and VB6, all P-Invoke calls that do not have charset&nbsp;information attached default to use the&nbsp;"A" version of functions. This means that even though the code is running in .NET&nbsp;where all the strings are Unicode on Vista where&nbsp;the registry and everything else is Unicode that everything is&nbsp;being dealt with as if it were a non-Unicode string, and the non-Unicode&nbsp;version of functions&nbsp;is being called.<BR><BR>Remember when&nbsp;I wrote about how <A href="http://archives.miloush.net/michkap/archive/2005/10/02/476213.html"><STRONG>The Unicode train is leaving the station</STRONG></A> and was quite clear that there would no longer be non-Unicode function calls added to the NLS API? And how we'd be recommending to other teams that they do the same, either the way we did with <A href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html"><STRONG>FindNLSString</STRONG></A> (not even decorating the name with a "W") or the way the Shell team did with StrCmpLogicalW (a "W" decoration), no "A" version is being provided?&nbsp;</P></FONT></BLOCKQUOTE>
<P mce_keep="true">So, the folks who created Visual Studio and .NET&nbsp;even its very first version were eager to get out of the Win9x version. After repeated problems came up with trying to get the Shell to work on Win9x, they dropped support for running VS there. They definitely did not actively support the work of&nbsp;Microsoft Layer for&nbsp;Unicode, with both MFC and ATL not building special versions that used it or allowing the posting of such special versions. Even though unicows.dll shipped with the very first version of VS.Net, there was no option to build MSLU projects. Clearly everyone was distancing themselves from Win9x, and I could easily come up with a dozen additional little issues that would indicate how everyone was moving on.</P>
<P mce_keep="true">So why use the CharSet.Ansi default in pinvoke? Especially when going forward there will be fewer non-Unicode functions?</P>
<P mce_keep="true">Well, sort of backward compatibility, I guess. </P>
<P mce_keep="true">Though to be honest changing the default to Unicode, or even more sensibly changing the default to CharSet.Auto, would keep the non-Unicode default from being injected into the world of Unicode operating systems. </P>
<P mce_keep="true">How many versions of .NET will it take before this seems lame to everyone (especially if using&nbsp;pinvoke in managed C++ projects, where the project default is now UNICODE/_UNICODE, gives similar results? Not sure on this one, the doc are anything but clear....)</P>
<P mce_keep="true">Now <STRONG>that</STRONG> is backwards! Or maybe backward. Whichever.</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>áŸ„</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/17c4" mce_href="http://www.fileformat.info/info/unicode/char/17c4">U+17c4</A>, a.k.a. KHMER VOWEL SIGN OO)</EM></FONT></P></FONT>
<hr/><p><a id="1122837" href="#1122837">#</a> <strong>orcmid</strong> on 22 Nov 2006 11:22 AM:</p><div style="margin-left: 1em"><p>Well, the default Unicode is actually a small mess for beginners using VC++ 2005 Express Edition because string literals (the undecorated &quot;...&quot;) and the char literals are still A-style. </p>
<p>But I think the bigger deal is code-page dependency. &nbsp;Until the platform supports Unicode top to bottom, including console sessions and keyboard mappings, it is not so easy for the development tools to impose Unicode by fiat.</p>
<p>And there is a lot of single-byte code running around. &nbsp;I just wrote some more in native Win32 ;).</p>
<p> - Dennis</p>
</div>
<p><a id="1122897" href="#1122897">#</a> <strong>Michael S. Kaplan</strong> on 22 Nov 2006 11:50 AM:</p><div style="margin-left: 1em"><p>Well, that has more to do with rules in the C/C++ standards, right? :-)</p>
<p>And of course the world of VB.NET and C# have no [good] reason for an ANSI default....</p>
</div>
<p><a id="8334249" href="#8334249">#</a> <strong>Andrew Cook</strong> on 24 Mar 2008 4:40 PM:</p><div style="margin-left: 1em"><p>Hmm...</p>
<p>&quot;Character Sets. You can specify in charsetmodifier how Visual Basic should marshal strings when it calls the external procedure. The Ansi modifier directs Visual Basic to marshal all strings to ANSI values, and the Unicode modifier directs it to marshal all strings to Unicode values. The Auto modifier directs Visual Basic to marshal strings according to .NET Framework rules based on the external reference name, or aliasname if specified. The default value is Ansi.</p>
<p>&quot;charsetmodifier also specifies how Visual Basic should look up the external procedure within its external file. Ansi and Unicode both direct Visual Basic to look it up without modifying its name during the search. Auto directs Visual Basic to determine the base character set of the run-time platform and possibly modify the external procedure name, as follows:</p>
<p> &nbsp; &nbsp;*On an ANSI platform, such as Windows 95, Windows 98, or Windows Millennium Edition, first look up the external procedure with no name modification. If that fails, append &quot;A&quot; to the end of the external procedure name and look it up again.</p>
<p> &nbsp; &nbsp;*On a Unicode platform, such as Windows NT, Windows 2000, or Windows XP, first look up the external procedure with no name modification. If that fails, append &quot;W&quot; to the end of the external procedure name and look it up again.&quot;</p>
<p>While the default value is ANSI, programmers need to explicitly state that the procedure name ends with &quot;A&quot; or else the name lookup will fail and thus an exception is thrown. The easiest way to fix that is to simply include &quot;Auto&quot;, which on NT platforms makes things use Unicode goodness.</p></div>
<p><a id="8334261" href="#8334261">#</a> <strong>Michael S. Kaplan</strong> on 24 Mar 2008 4:55 PM:</p><div style="margin-left: 1em"><p>Or just stick to NT-based platforms and assume the &quot;W&quot; semantics throughout, instead. :-)</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/24 <a href="http://archives.miloush.net/michkap/archive/2008/03/24/8331966.html">Unicode not being the default is slower and leads to bugs; maybe it ought to change?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/11/21/1113205.html" title="About that second presentation I did">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/11/20/1108172.html" title="No byte order marks when using encodings in StreamWriters?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11-20">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/20/1112734.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>