<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/02/929063.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>MFC + Spanish version of Windows = Oops!</title></head><body>
<h1>MFC + Spanish version of Windows = Oops!</h1>
<p><em>by Michael S. Kaplan, published on 2006/11/02 06:43 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/11/02/929063.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma size=3>
<P>Kurt's question was straightforward enough: </P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P>Hi,<BR><BR>Calling GetLocaleInfo on English Windows XP SP2 Professional and passing in the International Spanish LCID 3082 produces "ESN", however called on Spanish Windows XP SP2 Professional the result is "ES".<BR><BR>GetLocaleInfo(3082, LOCALE_SABBREVLANGNAME, szLangCode, 4);<BR><BR>This is a problem for MFC application debugged on Spanish Windows XP SP2, since the function _AfxLoadLangDLL in appcore.cpp causes an assertion (nResult == 3) (szLangCode == "ES"):<BR><BR>Code snippet from MFC's code:</P><FONT face="Consolas,Courier New,Lucida Console,Courier"><B>
<BLOCKQUOTE>
<P>nResult = ::GetLocaleInfo(lcid, LOCALE_SABBREVLANGNAME, szLangCode, 4);<BR>if (nResult == 0)<BR>&nbsp;&nbsp;&nbsp; return NULL;<BR>ASSERT( nResult == 4 );</P></BLOCKQUOTE></F></B></FONT>
<P>Background: The above code tries to build filenames for localizes, resource only Satellite DLLs:<BR><BR>Localized Resources in MFC Applications: Satellite DLLs <BR><BR></FONT><A href="http://msdn2.microsoft.com/en-us/library/8fkteez0.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/8fkteez0.aspx"><U><FONT color=#0000ff size=2>http://msdn2.microsoft.com/en-us/library/8fkteez0.aspx</U></FONT></A><BR><A href="http://msdn2.microsoft.com/en-us/library/8fkteez0(vs.71).aspx" mce_href="http://msdn2.microsoft.com/en-us/library/8fkteez0(vs.71).aspx"><U><FONT color=#0000ff size=2>http://msdn2.microsoft.com/en-us/library/8fkteez0(vs.71).aspx</U></FONT></A><FONT size=2><BR><BR>Is this a Windows XP localization bug? Or ... ?</FONT>&nbsp;</P></BLOCKQUOTE>
<P mce_keep="true">Now my first thought was that <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_7w1b.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_7w1b.asp ">SetLocaleInfo</A> does not support LOCALE_SABBREVLANGNAME, and that the value return by LOCALE_SABBREVLANGNAME is not really a localized piece of data. So there really should be no such difference between a localized and a non-localized version of Windows here.</P>
<P mce_keep="true">So I replied back to Kurt saying that this should not really be possible but I added someone to the thread who I knew would want to hear about the report, our NLS SDET Lead Gerardo Villarreal Guzman. He had another question to ask about the issue:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2>
<P>Kurt,<BR><BR>There should be no difference for SABBREVLANGNAME in XP SP2 for any language SKU. A favor to ask. Can you look in regedit HKCU\Control Panel\International and tell me the value for the sLanguage?<BR><BR>This is an overrideable field, so for some reason this may have been modified by an application.<BR><BR>Kind Regards,<BR><BR>Gerardo</FONT>&nbsp;</P></BLOCKQUOTE>
<P mce_keep="true">What Kurt found was that this sLanguage&nbsp;value was indeed set to "ES", and that it was changing the results returned by that <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A> call with the LOCALE_ABBREVLANGNAME flag. </P>
<P mce_keep="true">I separately looked at the localized Spanish version of&nbsp;the&nbsp;HIVEDEF.INF file that setup uses to write several portions of the registry and it indeed set this value to "ES" and this was the case in both&nbsp;XP and Server 2003 in&nbsp;every version that has been released. This was causing this problem with MFC. </P>
<P mce_keep="true">Damn.</P>
<P mce_keep="true">So there is a lot of little problems that conspired to cause this to be an issue for MFC running on Spanish localized versions of Windows:</P>
<OL>
<LI>
<DIV mce_keep="true">There is the fact that this field is&nbsp;overridable in the registry&nbsp;but is clearly not allowed in the function that&nbsp;we try to really insist that people use to update the user locale data fields that can be overridden.</DIV></LI>
<LI>
<DIV mce_keep="true">There is the fact that this field is overridable at all, though there is probably some hidden reason long long ago in the before time related to the need to change the two-letter code in the Language Bar that no one I talked to&nbsp;remembered ever hearing about.&nbsp;</DIV></LI>
<LI>
<DIV mce_keep="true">There is the problem of these non-localized fields which&nbsp;are actually stored in the locale data being duplicated on a per-language basis to populate the registry (rather than having code call GetLocaleInfo() to retrieve these values for the population).&nbsp;In addition to the&nbsp;particular issue in&nbsp;Spanish&nbsp;there are several languages whose values managed to fall out of sync with the locale data, which is an object lesson on why it is a bad idea to duplicate data. This is a problem&nbsp;that has been addressed in Vista, for all languages.</DIV></LI>
<LI>
<DIV mce_keep="true">There is the problem with the localizers whose data fell out of sync or whose data was never correct (as I suspect as the case for this "two character three-letter-code value!), though to be honest this whole architecture is unwieldy and was placing an unfair and unnecessary&nbsp;burden on localization -- so I am glad this flaw is gone in Vista.</DIV></LI>
<LI>
<DIV mce_keep="true">There is the fact that MFC uses this three letter string for its language resource lookups -- given all of the odd and arbitrary rules about where they come from (as I pointed out in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/02/17/375235.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/17/375235.html">this post</A></STRONG> and <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/09/27/773341.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/27/773341.html">this one</A></STRONG>), it seems like a&nbsp;really bad choice, especially since this particular dependency was not something that people who own the NLS data were specifically aware of.</DIV></LI>
<LI>
<DIV mce_keep="true">There is also the problem where MFC is not passing LOCALE_NOUSEROVERRIDE to avoid getting the user override here -- which would have kept them from getting into trouble here when the other issues insisted on coming up.</DIV></LI></OL>
<P mce_keep="true">I wonder how many Spanish speaking MFC developers and how many Spanish speaking customers running MFC apps had problems here. And how many worked around it with the slightly different name of their language resource DLLs? and whether the problem also happened prior to XP?</P>
<P mce_keep="true">Plenty of fault to go around here, with each individual issue working as a part of the larger problem. Some very cooperative bugs, these were!</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp; <FONT size=6>Ã±</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/00f1" mce_href="http://www.fileformat.info/info/unicode/char/00f1">U+00f1</A>, a.k.a. LATIN SMALL LETTER N WITH TILDE)</EM></FONT></P></FONT></B>
<hr/><p><a id="933548" href="#933548">#</a> <strong>Mihai</strong> on 2 Nov 2006 12:50 PM:</p><div style="margin-left: 1em"><p>&lt;&lt;I wonder how many Spanish speaking MFC developers and how many Spanish speaking customers running MFC apps had problems here.&gt;&gt;</p>
<p>I would guess not too many, because it is mostly unknown.</p>
<p>The feature was introduced in MFC 7.0 (VS .NET 2003) and I have not seen it documented until much later, for VS 2005. I have discovered it in 7.0 by checking the MFC sources for some other reason.</p>
<p>And I was not too happy about the implementation, because of the 3 char code (Win and Office MUI already decided for LCID), not happy because there was no programmatic way to control the language (it was the system UI and that was it), and not happy because it created yet another system for DLLs only, instead of making public the MUI API that can also support other localizable files (help, readme, samples, etc.)</p>
<p>Good part: Vista makes the MUI API public (and a lib is provided for back-port to XP).</p>
<p>We can only hope that the next version of MFC will use the recommended way.</p>
<p>And maybe even (one day) even have VS UI support for resource-only-dlls for native applications (like the one for .NET applications).</p></div>
<p><a id="946854" href="#946854">#</a> <strong>Jesper Holmberg [MSFT]</strong> on 3 Nov 2006 5:22 PM:</p><div style="margin-left: 1em"><p>I just checked the XP SP2 slp hivedef for all languages, and it seems that only Spanish happens to have a two-letter value in INTL_SLANGUAGE. </p>
<p>I then went back a digged a little further, and as far as I can tell, this issue was introduced way back when the file was first added to Windows - during the Windows 2000 localization. Hivedef used to be really problematic for localization (at least for us in Ireland), becase we didn't fully understand the file and due to tools issues, we localized this in notepad. Back in 98-99, localization errors in this file (and similar files, e.g. update.inf) caused a lot of BVT or build breaks (often due to bad data in the file, or syntax errors), and so the loc team developed a bit of fear and superstition about these files.</p>
<p>The file has been updated several times since W2k RTM, often in Service Packs and definitely in XP and Server 2003. Even though the tools improved, our battle scars remained and we have always tried not to touch those resources unnecessarily. Since the loc team has not heard about the issue until now, hivedef was never fixed. Maybe now that code has been written assuming the value should be &quot;ES&quot; it's too late, dunno... we'll keep it on the radar for Windows XP SP3 and Windows Server 2003 SP2 though.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/11/03/939272.html" title="Concatenating display names correctly?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/11/02/928185.html" title="Sometimes Microsoft is cooler than Apple (no matter what the Apple commercials say!)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-11-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/11/02/929063.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>