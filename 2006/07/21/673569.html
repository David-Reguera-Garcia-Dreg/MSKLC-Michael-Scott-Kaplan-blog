<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/21/673569.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The complexities of keyboard layout switching</title></head><body>
<h1>The complexities of keyboard layout switching</h1>
<p><em>by Michael S. Kaplan, published on 2006/07/21 03:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/07/21/673569.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Chris was thinking about how keyboard layouts work on Windows, and suggested: </FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Garamond size=2>Windows allows a user to set up multiple keyboards within an input language, and switch between them either by a keyboard shortcut or by clicking an icon on the taskbar. However, when the keyboard layout is changed, the change is only applied to the current window. <BR><BR></FONT><FONT face=Garamond size=2>This behaviour is extremely confusing to users, as the characters that appear as they type then vary from window to window. By default, using the keyboard shortcut or clicking the taskbar icon to select another keyboard, the new keyboard should be used in all windows. <BR><BR>If it is necessary to keep the old behaviour, this should be done via a (non-default) check-box on the "Language Bar" tab of the "Text Services and Input Languages" applet.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>It is an interesting idea, and also a difficult one. The list of <STRONG>installed</STRONG> keyboards (which actually means the list of <STRONG>enabled</STRONG> keyboards) is a per user setting on a machine. And, as Chris mentioned, every language can have more than one keyboard attached to it.</FONT></P>
<P><FONT face=Tahoma>So, let's say that I have English and Korean enabled, with multiple input methods on each:</FONT></P>
<P><IMG src="http://trigeminal.fmsinc.com/images/MultKeyboards1.jpg"></P>
<P><FONT face=Tahoma>If I look at the Language Bar, I have the option of choosing the language:</FONT></P>
<P><IMG src="http://trigeminal.fmsinc.com/images/MultKeyboards2.jpg"></P>
<P><FONT face=Tahoma>and then also the keyboard layout&nbsp;under the language once it is selected:</FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/MultKeyboards3.jpg"></FONT></P>
<P><FONT face=Tahoma><IMG src="http://trigeminal.fmsinc.com/images/MultKeyboards4.jpg"></FONT></P>
<P><FONT face=Tahoma>Thankfully, the selection mechanism is smart enough to remember the selection in each language. So that if I</FONT></P>
<UL>
<LI><FONT face=Tahoma>switch to Korean,</FONT></LI>
<LI><FONT face=Tahoma>switch to the Korean Input System (IME 2002),</FONT></LI>
<LI><FONT face=Tahoma>switch to English,</FONT></LI>
<LI><FONT face=Tahoma>switch back to Korean</FONT></LI></UL>
<P><FONT face=Tahoma>It is smart enough to remember that I switched to that specific IME. This is as good thing.</FONT></P>
<P><FONT face=Tahoma>Now we move to the complicated part&nbsp;-- the fact that actual, specific combination of language and layout&nbsp;is a <STRONG>per thread setting</STRONG>. This has been the design for a long time and it&nbsp;usually leads to&nbsp;two potentially non-intuitive behaviors:</FONT></P>
<UL>
<LI><FONT face=Tahoma>If you change the language, it will only apply to that one specific thread, and switching to any other UI thread in any other process will not follow the original thread's change.</FONT></LI>
<LI><FONT face=Tahoma>If you change the keyboard layout within a language, it will once again only apply to that one specific thread, and switching to any other UI thread in any other process with the same language will not follow the original thread's change.</FONT></LI></UL>
<P><FONT face=Tahoma>Now that first point is longstanding behavior that is often relied on by people (including me!), and although it is not immediately intuitive it does kind of make sense, especially when one finds oneself e.g.&nbsp;typing a document in a particular language and not expecting that to lead to changes in one's email program....</FONT></P>
<P><FONT face=Tahoma>The secone point is the one that Chris is talking about. </FONT><FONT face=Tahoma>Any time one changes the keyboard layout for a language, then isn't it often more likely that you would perhaps expect that switch to be applied to all other UI threads in the session that use this language?</FONT></P>
<P><FONT face=Tahoma>Clearly there are exceptions here (plus there is a legacy expectation that some people may be used to), but that is also why Chris is suggesting some kind of configurable switch. I tend to agree with Chris that the change here is more likely to meet the intuitive expectations of customers, don't you?</FONT></P>
<P><FONT face=Tahoma>This kind of change is complicated for someone to do themselves -- there would need to be a call to <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/hooks/hookreference/hookfunctions/setwindowshookex.asp">SetWindowsHookEx</A> to inject a DLL into every thread to run code to check <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/getkeyboardlayout.asp">GetKeyboardLayout</A> -- and if the languages (in the LOWORD) match and the device (in the HIWORD) do not then make a call to <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/activatekeyboardlayout.asp">ActivateKeyboardLayout</A> to make the switch.</FONT></P>
<P><FONT face=Tahoma>Yuck.</FONT></P>
<P><FONT face=Tahoma>But if you look at the Language Bar and the Text Services Framework, it already has a little something running in every thread, managing this information. So it is in a much better position to architect the kind of cross-thread, cross-process communication that might be required here.</FONT></P>
<P><FONT face=Tahoma>Not an easy change, by any means. But an excellent feature request that is definitely worth considering for a future version of Windows. Good idea, Chris! :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>ђ</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0452">U+0452</A>, a.k.a. CYRILLIC SMALL LETTER DJE)</EM></FONT></P>
<hr/><p><a id="673680" href="#673680">#</a> <strong>Mihai</strong> on 21 Jul 2006 5:38 AM:</p><div style="margin-left: 1em">If we get to talk about keyboard annoyances: starting with XP (I think) changing the user locale (“Standards and formats”) also adds the matching keyboard.<br>I know, might be about convenience, and the fact that people changing the “Standards and formats” kind of think is about “language I want to use,” kind of including the keyboard.<br>It might be convenient for the users, but formatting should have nothing to do with keyboard.<br><br>I think the confusion of the poor user is caused by the fact that the keyboard layout is well hidden. It was moved from keyboard (which might not be right technically, but it makes sense for a normal user), and is now buried under the “Language” tab (no indication about keyboard) and under something called “Text services and input languages.” Again, kind of clear for the programmer, but the user wants “keyboard.”<br><br>So, “feature request”: let formatting settings to affect formatting (not keyboard) and make clear where the language of the keyboard is set.<br></div>
<p><a id="673729" href="#673729">#</a> <strong>John Ingres</strong> on 21 Jul 2006 7:14 AM:</p><div style="margin-left: 1em">Would be nice indeed for casual users. They get frustrated and I haven't found a way to thread my wife yet;)<br><br>Another nice feature would be more control on the keyboard shortcut. Choices are limited and they sometimes conflict with other applications &amp; plug-ins. </div>
<p><a id="673926" href="#673926">#</a> <strong>Ben Cooke</strong> on 21 Jul 2006 11:33 AM:</p><div style="margin-left: 1em">This design was annoying me just the other day. I was working at home and using remote desktop to my office. I already had a desktop session active from the previous day when I was sitting at the console. My work machine has a UK keyboard.<br><br>In the morning I was working from my garden on my laptop. (Yes. I know I'm a smug git!) My laptop has a US keyboard. I switched over to the US keymap when I happened to have my text editor focused, and it worked. I then switched somewhere else and ended up typing at-signs where I wanted quotes. After a while I had them all switched.<br><br>Later in the day it got a bit too windy to work in the garden, so I retreated to my home office where I have a UK keyboard again. You can guess how the rest of the story goes.<br><br>Of course, I knew about this issue before I started, but I don't encounter it very often since it's only really when Remote Desktop comes into play that you end up typing with the &quot;wrong&quot; keyboard. <br><br>For my purposes, I'd be happy just to have an extra button on the language bar called &quot;Change All Windows&quot; which applies whatever is selected across all threads there and then.<br><br>I've moaned before about Remote Desktop dealing in scancodes rather than characters, but I accept that it's a architectural limitation. :)<br></div>
<p><a id="674636" href="#674636">#</a> <strong>josh</strong> on 22 Jul 2006 2:32 AM:</p><div style="margin-left: 1em">Even better and probably more evil would be not to do it for all windows, but for that physical keyboard (if you used a keyboard shortcut) or all physically attached keyboards at the time (from a menu, etc.)<br><br>I've got a US PS2 keyboard and a Japanese USB keyboard. &nbsp;It would be insanely cool to be able to type in the right language just by moving to the other keyboard. &nbsp;Maybe not convenient, but cool.</div>
<p><a id="674675" href="#674675">#</a> <strong>Michael S. Kaplan</strong> on 22 Jul 2006 3:42 AM:</p><div style="margin-left: 1em">Hi Josh, <BR><BR>That one would actually be much harder, given the lack of any good standards related to detection of the hardware's language....</div>
<p><a id="674845" href="#674845">#</a> <strong>cnettel</strong> on 22 Jul 2006 9:26 AM:</p><div style="margin-left: 1em">You don't need to detect what's actually painted on the keys, &quot;just&quot; what HID actually made the input. (It would make even more sense for mice with different DPI properties, or you could even have two identical pointing devices, just with one carrying an implicit setting of much lower sensitivity for pixel-precision work.)</div>
<p><a id="674988" href="#674988">#</a> <strong>Michael S. Kaplan</strong> on 22 Jul 2006 1:32 PM:</p><div style="margin-left: 1em">Hi cnettel, <br><br>This causes all kinds of other problems like with the input queue and more importantly with the input cache -- what do you do with input that is in progress like via dead keys or IMEs? <br><br>Such a deisgn would not only difficult to untangle from the current one, but it would break much of the design of input that is avilable now, from the messages on up....</div>
<p><a id="675526" href="#675526">#</a> <strong>josh</strong> on 23 Jul 2006 4:30 AM:</p><div style="margin-left: 1em">That's more what I was thinking. &nbsp;You manually tell it what language to use and the system attaches that information to that particular device. &nbsp;And I'm also thinking of it more as &quot;wouldn't that be a nifty piece of magic&quot; rather than an actual suggestion. &nbsp;:)</div>
<p><a id="675629" href="#675629">#</a> <strong>Michael S. Kaplan</strong> on 23 Jul 2006 7:48 AM:</p><div style="margin-left: 1em">Occupational hazard -- ideas brought up here get automatic feasibility assessment. :-)<br><br>So the actual thought here is to, rather than split input language per thread and then share all devices among them, split it per device AND per thread, and give device its own input queue....</div>
<p><a id="679055" href="#679055">#</a> <strong>Chris</strong> on 26 Jul 2006 11:02 AM:</p><div style="margin-left: 1em">Woohoo! One of my bug reports has made it into a blog post on one of my favourite blogs... so cool!<br><br>Thanks Michael - I really appreciate the extra insight and comments you've made here (and very reassuring compared to the feedback in the bug itself).<br><br>Chris.</div>
<p><strong>Nick Fagerlund</strong> on 27 Mar 2008 4:43 AM:</p><div style="margin-left: 1em"><p>I just got bit by this misbehavior. I switched to the Dvorak keyboard since the last time I tried using Windows, and when my computer ended up in the shop, I ended up sharing an XP box with someone else. I thought I'd just flip the switch whenever it was my turn to use the thing, but I've apparently been spoiled rotten by Mac OS X. </p>
<p>Not only shouldn't assigning different keyboard layouts to every single window be the default, but I'm having a hard time imagining *any* situation where you'd want it to work that way. This is total madness.</p></div>
<p><strong>YayWindows</strong> on 30 Jun 2011 5:26 PM:</p><div style="margin-left: 1em"><p>And, five years and two versions of Windows later, the problem remains: if I am working with multiple languages in multiple windows, as I often am, then there is no way for me to predict what will happen when I press a key on my keyboard except to squint at a tiny icon down at the corner of the screen that indicates which layout is active for whichever window has the focus. &nbsp;Click into another window? &nbsp;All bets are off.</p>
<p>The only thing that&#39;s changed since 2006 is that, so far as I can tell, none of the third-pary programs people have written over the years to fix this bug work any more in Windows 7. &nbsp;Yay Windows.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 30 Jun 2011 6:07 PM:</p><div style="margin-left: 1em"><p>It still remains too much of a corner case to interest the owners of Cicero or User to or the Window Manager to jump in and fix the issue.</p>
<p>Not sure what programs you&#39;re talking about or their methods of action, but I assume none of them were trying to fix it by supported means?</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/07/21/673813.html" title="We do seem to be short on time...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/07/20/672931.html" title="MSDN Blogs has achieved Kieranosity">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/21/673569.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>