<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/09/658454.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The fallacy of comparing out of context</title></head><body>
<h1>The fallacy of comparing out of context</h1>
<p><em>by Michael S. Kaplan, published on 2006/07/09 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/07/09/658454.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Perhaps you have heard of the Fallacy of quoting out of context, where support for an argument is produced by incompletely quoting a source -- where the incompleteness alters or changes the meaning.</FONT></P>
<P><FONT face=Tahoma>(for more info, see the <A href="http://en.wikipedia.org/wiki/Fallacy_of_quoting_out_of_context">Wikipedia article</A> about the subject)</FONT></P>
<P><FONT face=Tahoma>Well, this post is not about that.</FONT></P>
<P><FONT face=Tahoma>Instead, it is about an analagous practice in the world of collation, one that functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A> can unfortunately support the propogation of.</FONT></P>
<P><FONT face=Tahoma>If you call the function and specify a length (basically a count of UTF-16 code units)&nbsp;into the <EM>cchCount1</EM> and/or <EM>cchCount2</EM> parameters, the strings being passed in via <EM>lpString1</EM> and <EM>lpString2</EM> may be longer than the lengths.</FONT></P>
<P><FONT face=Tahoma>Now while it may be possible that this is okay, it is likely to cause problems due to the fact that the actual comparison is done by comparing <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html">sort elements</A></STRONG>, not UTF-16 code units. The comparison you are making may be invalid if you truncate the strings this way.</FONT></P>
<P><FONT face=Tahoma>In other words, by comparing the strings without the context of all of the relevant text, you may be corrupting the meaning of the comparison, and returning the wrong result!</FONT></P>
<P><FONT face=Tahoma>This actually came up recently&nbsp;in relation to Mohawk, one of the new locales in Vista. You see, in Mohawk the colon (<STRONG>:</STRONG>) is used as a diacritic, so that <STRONG>e</STRONG> and <STRONG>e:</STRONG> have two different primary weights. So what happens if you call <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A> like this:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New">CompareStringW(MAKELANGID(LANG_MOHAWK, SUBLANG_MOHAWK_MOHAWK),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; L"file",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wzFileUrl,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4);</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>where <EM>wzFileUrl</EM> is a string like <A href="file:///C:/Debuggers/debugger.chm">file:///C:/Debuggers/debugger.chm</A>, looking for that "file" prefix. It will truncate that path at four code points, b</FONT><FONT face=Tahoma>ecause the string you are looking for is using an entirely different letter there.</FONT></P>
<P><FONT face=Tahoma>Now in this case it is a good thing since the goal here is obviously not a proper linguistic result, but it is easy to imagine actual strings returning equality when they&nbsp;are not equal and inequality when they are. </FONT></P>
<P><FONT face=Tahoma>And what about canonically equivalent strings like "Å" (<A href="http://www.fileformat.info/info/unicode/char/00c5">U+00c5</A>) vs. "Å" (<A href="http://www.fileformat.info/info/unicode/char/0041">U+0041</A> <A href="http://www.fileformat.info/info/unicode/char/030a">U+030a</A>)? If you pass a length of 1 for both strings then you are actually comparing <A href="http://www.fileformat.info/info/unicode/char/00c5">U+00c5</A> and <A href="http://www.fileformat.info/info/unicode/char/0041">U+0041</A>, which are obviously not ever the same&nbsp;by the standards&nbsp;of&nbsp;any locale.</FONT></P>
<P><FONT face=Tahoma>If you think about problems like <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/04/06/405847.html">When Notepad's Find doesn't</A></STRONG>, they are clearly based on situations of assuming that "count of WCHARs" == "count of sort elements", and are caused by this very problem. Luckily, the Vista version of Notepad now uses <A href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html"><STRONG>FindNLSString</STRONG></A> to do its searching, which nicely avoids this particular problem.</FONT></P>
<P><FONT face=Tahoma>And now it is on other developers to do the same -- and to not fall inti the fallacy of comparing out of context!</FONT></P>
<P><FONT face=Tahoma size=2><EM>(Special thanks to Mike Dolenga for the inspiration of some of the concepts in this post!)</EM></FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM> <STRONG><FONT size=6>:</FONT></STRONG> <EM>(<A href="http://www.fileformat.info/info/unicode/char/003a">U+003a</A>, a.k.a. COLON)</EM></FONT></P></FONT>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/10/13 <a href="http://archives.miloush.net/michkap/archive/2011/10/13/10224477.html">Every rose has it's Þ....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/07/09/660584.html" title="All about yesterday">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/07/08/659302.html" title="They could be a little shorter">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07-09">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/09/658454.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>