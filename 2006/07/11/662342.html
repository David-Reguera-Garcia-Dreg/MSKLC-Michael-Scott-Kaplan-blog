<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/11/662342.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>More on that which breaks Windows Notepad</title></head><body>
<h1>More on that which breaks Windows Notepad</h1>
<p><em>by Michael S. Kaplan, published on 2006/07/11 10:26 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/07/11/662342.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>In the latest comment to the post that keeps on going (<STRONG><A href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html">Behind 'How to break Windows Notepad'</A></STRONG>), Sanjay Vyas <A href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html#662129">asks</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Garamond>Not all combinations of 4-3-3-5 will produce it. For example, Bush hid the truth does not work while Bush hid the facts does. Any explanation?</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Well, let us look at the two strings. First: </FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>Bush hid the facts<BR><A href="http://www.fileformat.info/info/unicode/char/0042">0042</A> <A href="http://www.fileformat.info/info/unicode/char/0075">0075</A> <A href="http://www.fileformat.info/info/unicode/char/0073">0073</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0069">0069</A> <A href="http://www.fileformat.info/info/unicode/char/0064">0064</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0074">0074</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0065">0065</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0066">0066</A> <A href="http://www.fileformat.info/info/unicode/char/0061">0061</A> <A href="http://www.fileformat.info/info/unicode/char/0063">0063</A> <A href="http://www.fileformat.info/info/unicode/char/0074">0074</A> <A href="http://www.fileformat.info/info/unicode/char/0073">0073</A></STRONG></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT face=Tahoma>becomes:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>畂桳栠摩琠敨映捡獴<BR><A href="http://www.fileformat.info/info/unicode/char/7542">7542</A> <A href="http://www.fileformat.info/info/unicode/char/6873">6873</A> <A href="http://www.fileformat.info/info/unicode/char/6820">6820</A> <A href="http://www.fileformat.info/info/unicode/char/6469">6469</A> <A href="http://www.fileformat.info/info/unicode/char/7420">7420</A> <A href="http://www.fileformat.info/info/unicode/char/6568">6568</A> <A href="http://www.fileformat.info/info/unicode/char/6620">6620</A> <A href="http://www.fileformat.info/info/unicode/char/6361">6361</A> <A href="http://www.fileformat.info/info/unicode/char/7374">7374</A></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The obvious question is why the second string does not do the same thing. Why does:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>Bush hid the truth<BR><A href="http://www.fileformat.info/info/unicode/char/0042">0042</A> <A href="http://www.fileformat.info/info/unicode/char/0075">0075</A> <A href="http://www.fileformat.info/info/unicode/char/0073">0073</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0069">0069</A> <A href="http://www.fileformat.info/info/unicode/char/0064">0064</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0074">0074</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A> <A href="http://www.fileformat.info/info/unicode/char/0065">0065</A> <A href="http://www.fileformat.info/info/unicode/char/0020">0020</A> <A href="http://www.fileformat.info/info/unicode/char/0074">0074</A> <A href="http://www.fileformat.info/info/unicode/char/0072">0072</A> <A href="http://www.fileformat.info/info/unicode/char/0075">0075</A> <A href="http://www.fileformat.info/info/unicode/char/0074">0074</A> <A href="http://www.fileformat.info/info/unicode/char/0068">0068</A></STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>not become the analagous:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>畂桳栠摩琠敨琠畲桴<BR><A href="http://www.fileformat.info/info/unicode/char/7542">7542</A> <A href="http://www.fileformat.info/info/unicode/char/6873">6873</A> <A href="http://www.fileformat.info/info/unicode/char/6820">6820</A> <A href="http://www.fileformat.info/info/unicode/char/6469">6469</A> <A href="http://www.fileformat.info/info/unicode/char/7420">7420</A> <A href="http://www.fileformat.info/info/unicode/char/6568">6568</A> <A href="http://www.fileformat.info/info/unicode/char/7420">7420</A> <A href="http://www.fileformat.info/info/unicode/char/7572">7572</A> <A href="http://www.fileformat.info/info/unicode/char/6874">6874</A></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>exactly?</FONT></P>
<P><FONT face=Tahoma>Neither string is very useful from a meaning standpoint, so we can dispell conspiracy theories involving both Japan and China right away (thankfully!).</FONT></P>
<P><FONT face=Tahoma>If you run both bits of text through <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_81np.asp">IsTextUnicode</A> running all tests, the first one returns TRUE and only returns IS_TEXT_UNICODE_STATISTICS, which means it only won the statistical tests.</FONT></P>
<P><FONT face=Tahoma>In a comment to the <A href="http://digg.com/software/No_forbidden_strings_in_Notepad">digg thread</A>, <A href="http://digg.com/users/neko">neko</A> asked (but no one answered):</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Garamond>I wonder if this will give the same result if you run notepad.exe in wine? Does wine emulate the dodgy isTextUnicode() behaviour as well?</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>I am not sure, though I am inclined to doubt that they are running the same statistical tests. A&nbsp;bit of&nbsp;Google&nbsp;spluenking suggests that the code is <A href="http://source.winehq.org/source/dlls/ntdll/rtlstr.c">here</A>&nbsp; somewhere, but I decided not to look myself. Hopefully it is not a dead link. Someone can tell me later if I was right. :-)</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>I won't post the actual code for <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_81np.asp">IsTextUnicode</A> -- no sense getting in thast kind of trouble, and even if that did not matter it is kind of embarrassing code....</FONT></P>
<P>(As a side note, the results on Windows vary a little bit depending on the default system locale as the function looks a bit at lead bytes -- and if the&nbsp;ratio of bytes in the string to lead bytes according to a DBCS default system code page is 2:1 -- which could in theory mean that on a Chinese, Japanese, or Korean system that the results could vary some....)</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>The tests (on Windows) are rather arbitrary and consist of&nbsp;a few&nbsp;parts, but the biggest piece it is really&nbsp;testing is a comparison of the fluctuation between high bytes and low bytes, and the diff between various high bytes and low bytes that&nbsp;the second&nbsp;string is failing on.</FONT></P>
<P>I honestly see no good reason for&nbsp;it to return TRUE&nbsp;here in either string, though I ran into problems even trying to fix <A href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html"><STRONG>this bug</STRONG></A> with CRLF due to it breaking a use of the function in detecting a Unicode JScript file, so changing the&nbsp;tests that the function does here is probably a no-no.</P></FONT>
<P><FONT face=Tahoma>Though it really is not a conspiracy with Microsoft making critical comments on the president's use of TRUTH or FACTS, I doubt I will have much luck convincing people of that.</FONT></P>
<P><FONT face=Tahoma>To me the more interesting conclusion here is that the passing of an arbitrary&nbsp;Unicode String like "畂桳栠摩琠敨琠畲桴" to <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_81np.asp">IsTextUnicode</A> returns FALSE due to these statistical tests. Once again, this is just not a function I like (or trust!) very much.</FONT></P>
<P><FONT face=Tahoma>But it is <STRONG>not</STRONG> some kind of easter egg. Truly, it is just a dumb algorithm!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>桴</STRONG></FONT> </FONT><EM><FONT color=#ff1493>(</FONT><A href="http://www.fileformat.info/info/unicode/char/6874">U+6874</A><FONT color=#ff1493>, a CJK ideograph)</FONT></EM></FONT></P>
<hr/><p><a id="662835" href="#662835">#</a> <strong>Dean Harding</strong> on 11 Jul 2006 7:53 PM:</p><div style="margin-left: 1em">Just goes to show... there are lies, damned lies and statistics.</div>
<p><a id="662911" href="#662911">#</a> <strong>Michael S. Kaplan</strong> on 11 Jul 2006 10:19 PM:</p><div style="margin-left: 1em">Hmmm... new version:<br><br>there are lies, damned lies, statistics, and there is the IsTextUnicode function.<br><br><br>:-)</div>
<p><a id="662949" href="#662949">#</a> <strong>Michael Dunn_</strong> on 11 Jul 2006 11:21 PM:</p><div style="margin-left: 1em">Maybe this calls for an IsTextReallyUnicode API, with better algorithms? ;) &nbsp;(in the tradition of RealDriveType and RealChildWindowFromPoint)</div>
<p><a id="663015" href="#663015">#</a> <strong>Michael S. Kaplan</strong> on 12 Jul 2006 1:04 AM:</p><div style="margin-left: 1em">Hi Mike -- <br><br>Actually, we have a whole WORD left for new flags that could be added (look at the old IsTextUnicode post for a whole bunch of expansion ideas!)....</div>
<p><a id="663197" href="#663197">#</a> <strong>Maximilian Haru Raditya</strong> on 12 Jul 2006 6:29 AM:</p><div style="margin-left: 1em">So, I'd like to ask:<br><br>has this bug already been fixed?</div>
<p><a id="663293" href="#663293">#</a> <strong>Michael S. Kaplan</strong> on 12 Jul 2006 8:28 AM:</p><div style="margin-left: 1em">Hi Maximillian -- <br><br>No, it has not (in fact the one bug I really tried to fix for Malayalam in IsTextUnicode had to have its fix backed out!).<br><br>But although it is a bit annoying, the actual user scenario is important -- how crucial are these text files that repro the problem? How common are they? There is lots that I hate about IsTextUnicode, but this bug is more of an oddity than a &quot;must fix&quot; issue....</div>
<p><a id="664138" href="#664138">#</a> <strong>Maximilian Haru Raditya</strong> on 13 Jul 2006 1:40 AM:</p><div style="margin-left: 1em">Hi Michael,<br><br>I can see that the actual user scenario is important and it's not a &quot;must fix&quot; issue. For me, it much more looks like such a rare occasion too.<br><br>I'm just hoping the next-to-come user scenarios would not break by this [IsTextUnicode], which I can't quite figure out them exactly for now what they would like to be in the future regards this matter. I hope everything would just be fine.<br><br>Anyway, thanks for the insight under the hood.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/25 <a href="http://archives.miloush.net/michkap/archive/2008/03/25/8334796.html">Bush might've still hid the facts, but he can't hide them from Vista SP1/Server 2008 Notepad!</a></p><p>2007/04/22 <a href="http://archives.miloush.net/michkap/archive/2007/04/22/2239345.html">The Notepad encoding detection issues keep coming up</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/07/11/662550.html" title="Is MSLU still supported?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/07/11/661966.html" title="Printing TrueType as graphics">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/11/662342.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>