<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/18/669509.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Occam's Razor, as applied to UTF-8</title></head><body>
<h1>Occam's Razor, as applied to UTF-8</h1>
<p><em>by Michael S. Kaplan, published on 2006/07/18 06:10 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/07/18/669509.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma><A href="http://en.wikipedia.org/wiki/Ockham%27s_razor">Occam's Razor</A> is a principle easily stated in Latin (entia non sunt multiplicanda praeter necessitatem) or English (entities should not be multiplied beyond necessity). Applying it to UTF-8 is an obvious matter --&nbsp;it is&nbsp;the shortest form of the encoding is the correct one. :-)</FONT></P>
<P><FONT face=Tahoma>Anyway, Tom Gewecke has been wanting me to talk about a particular issue to do with the problem of non-shortest forms&nbsp;for a few months now.... </FONT></P>
<P><FONT face=Tahoma>First he sent me the following via the Contacting Michael link: </FONT></P><FONT face=Tahoma><FONT size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P></FONT><FONT face=Garamond size=3>I recently came across some bizarre behavior by Win IE 6 , where it will interpret 3 different illegal UTF-8 byte sequences the same as a legal one, presumably because only the last 6 bits of the last 2 bytes in 3 byte sequences are being read. I had never seen reference to this anywhere before, and don't know if it is an app issue or an OS issue. It made it almost impossible to convince the author of a particular Greek UTF-8 web page that his code was totally wrong, since Win IE displayed it correctly. Have you ever heard of this or know if it is supposed to get fixed (or is it perhaps not considered a bug)? A demo is at&nbsp;<BR><BR>&nbsp;&nbsp;&nbsp; </FONT><A href="http://homepage.mac.com/thgewecke/badutf8.html"><U><FONT color=#0000ff><FONT face=Garamond>http://homepage.mac.com/thgewecke/badutf8.html</FONT></U></FONT></A></P></BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>Around the same&nbsp;time, a rather extensive thread was going on over on the Unicode List about the same issue... the fact that IE 6.0 and Outlook&nbsp;HTML mail were accepting non-shortest form UTF-8 and interpretting it. </FONT></P>
<P><FONT face=Tahoma>A little while later he posted a comment in a thread <A href="http://archives.miloush.net/michkap/archive/2006/05/27/608351.html#610370"><STRONG>here</STRONG></A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2>Some &nbsp;Windows programs (IE and Outlook that I know of) will &nbsp;also interpret invalid UTF-8 sequences &nbsp;as if they were real characters. &nbsp;A test of this is at <BR><BR></FONT><A href="http://homepage.mac.com/thgewecke/badutf8.html" target=_new rel=nofollow><FONT size=2>http://homepage.mac.com/thgewecke/badutf8.html</FONT></A><FONT size=2> </FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Of course there is one of those rules that if you wait long enough (I just had not gotten to posting about the issue yet? I've been busy!), the issues will resolve themselves. He asked me just the other day via the Contacting Michael link:</FONT></P><FONT face=Tahoma><FONT size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P></FONT><FONT face=Garamond size=3>I have one report that IE 7 beta 3 fixes the problem with IE interpreting bad utf-8 as actual Unicode characters, so if that is correct my earlier query regarding this issue can be considered OBE.<BR><BR></FONT><A href="http://homepage.mac.com/thgewecke/badutf8.html"><U><FONT color=#0000ff><FONT face=Garamond>http://homepage.mac.com/thgewecke/badutf8.html</FONT></U></FONT></A></P></BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>First I want to apologize to Tom, I had not meant to wait that long.&nbsp;I&nbsp;have been keeping busy lately though, at some point I'll probably be able to explain what has been keeping me busy. </FONT></P>
<P><FONT face=Tahoma>Second, it does indeed look like folks on the IE team at the very least read the Unicode List, and were able to turn the feedback into the effort to fix the issue. I do not&nbsp;know the exact build that the fix&nbsp;is in, but I too have&nbsp;been told that it has been addressed.&nbsp;:-)</FONT></P>
<P><FONT face=Tahoma>And last, I did want to point out one thing, about the issue in general. Especially as it relates to places that the final fix does not reach....</FONT></P>
<P><FONT face=Tahoma>While I believe that this was a very sensible issue to address, especially since a UTF-8 corrigendum went out some time ago that expressly stated that non-shortest forms of UTF-8 should not be accepted. The older text stated that while the non-shortest form should never be produced that it could be accepted by a process -- and it was with that older rule that&nbsp;a lot of the support of UTF-8 was done in MS products.</FONT></P>
<P><FONT face=Tahoma>The truth is that when Unicode makes changes to the standard such as this, that it takes time before the change gets propogated (and&nbsp;the change&nbsp;does not always get propogated to every version of every product produced by every company)....</FONT></P>
<P><FONT face=Tahoma>It is one of the reasons that Microsoft has started taking a more active interest in adopting the most recent versions of Unicode rather than 'hanging back', an issue that I will talk more about soon. To make sure that things can be implemented sooner, and of course&nbsp;because if more people are reviewing things that there is a greater likelihood of finding and avoiding problems.</FONT></P>
<P><FONT face=Tahoma>In the end, everybody wins (well everyone other than people with non-shortest form UTF-8 web pages?). :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM>&nbsp;<FONT size=8><STRONG>à¼º</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0f3a">U+0f3a</A>, a.k.a. TIBETAN MARK GUG RTAGS GYON)</EM></FONT></P>
<hr/><p><a id="669897" href="#669897">#</a> <strong>Tom Gewecke</strong> on 18 Jul 2006 1:29 PM:</p><div style="margin-left: 1em">Thanks much for your comments! &nbsp;However, I don't think this particular bug had anything to do with &quot;non-shortest form&quot; or any earlier change in the definition of acceptable UTF-8. &nbsp; It was just a matter of a &nbsp;faulty UTF-8 decoder which interpreted some byte sequences which have never represented characters under any definition as if they were the same as a sequence that does represent one (all sequences having the same length).</div>
<p><a id="669979" href="#669979">#</a> <strong>Michael S. Kaplan</strong> on 18 Jul 2006 2:15 PM:</p><div style="margin-left: 1em">Hi Tom, <br><br>The definition of non-shortest form UTF-8 is captured in these characters, which were once legal to accept (but not emit). We just needed the product to catch up to the standard, that's all....</div>
<p><a id="670361" href="#670361">#</a> <strong>Nick Lamb</strong> on 18 Jul 2006 8:21 PM:</p><div style="margin-left: 1em">You're quite right Tom, your example sequences aren't over-long, they're just plain invalid. Don't worry about Michael, he makes a lot of mistakes and isn't very good at admitting it.<br><br>Anyway, now that we're here, let's look at one of the examples in binary...<br><br>E1 BC D0 = 11100001 10111100 11010000<br><br>The Internet Explorer decoder does exactly what Tom said, it sees that E1 should have two trail bytes, reads out the bottom six bits from the next two code units, combines them with the E1 lead byte to give the result U+1F10 which is incorrect.<br><br>A compliant decoder reads the first two code units OK, but then the third code unit should be trail byte, and the leading '11' bits show that it's a lead byte so that's an error, it emits U+FFFD* and tries again with the D0 lead byte, but there are no trail bytes and it emits another U+FFFD before continuing to decode the document.<br><br>The other examples behave similarly.<br><br>* Of course it would also be compliant to throw an exception, return an error result etc. but that's not very practical in a tag soup web browser.</div>
<p><a id="670387" href="#670387">#</a> <strong>Tom Gewecke</strong> on 18 Jul 2006 9:08 PM:</p><div style="margin-left: 1em">Thanks for the comments, Nick. &nbsp;My impression is that such byte sequences were illegal even before the Unicode Corrigendum #1. &nbsp;TUC 3.0 (3.8, D31) seems to indicate that a decoder running into them should react by &quot;signaling an error, filtering the code value out, or representing the code value with a marker such as U+FFFD.&quot;</div>
<p><a id="670699" href="#670699">#</a> <strong>Michael S. Kaplan</strong> on 19 Jul 2006 3:10 AM:</p><div style="margin-left: 1em">Whether this particular example was contrived in error is not the real issue here. And neither is any sort of fetish about how wrong anyone thinks I am....<br><br>The fact is that in the original examples that concerned Tom there were actual UTF-8 pages that looked okay even though they were incorrect byte sequences. And IE, whose goal was to work with a wide variety of crap that existed on the web -- including crap created by MS/non-MS tools and for MS/non-MS browsers. <br><br>It was only later that people starting worrying about the security issues here -- and arguably IE is a little later coming to the party than some other products. That's all....</div>
<p><a id="670775" href="#670775">#</a> <strong>Nick Lamb</strong> on 19 Jul 2006 5:03 AM:</p><div style="margin-left: 1em">That's right Tom, your examples are almost identical to those found in Unicode test suites as illegal lead/ trail sequences. No compliant decoder, regardless of the version of Unicode / IETF / ISO standard could ever have given the results that you see from Internet Explorer.<br><br>If you look at Ken Thompson's sketched code for processing FSF-UTF you might see a family resemblance to the Internet Explorer code. It has all the relevant bugs here (but of course that code was an illustration, and FSF-UTF isn't compatible with UTF-8).<br><br>Did you ever find out what was generating the invalid sequences in the Greek page?</div>
<p><a id="670992" href="#670992">#</a> <strong>Tom Gewecke</strong> on 19 Jul 2006 9:35 AM:</p><div style="margin-left: 1em">One thing I find interesting about this is how little trouble has &nbsp;apparently resulted from having a non-compliant utf-8 decoder in such wide use for a considerable time. &nbsp;The (long-gone) Greek site which alerted me to &nbsp;the issue is the only case of systematically illegal utf-8 on the web &nbsp;that &nbsp;I have ever seen or heard of, and it was the result of the author writing his own utf-16 to utf-8 encoder. &nbsp;Even the case where unexpected Chinese is displayed, when Latin-1 accented chars are &nbsp;read as if they were utf-8, seems &nbsp;to be very uncommon in practice, or at least has never bothered anyone very much. &nbsp; Whether this phenomenon could be a security issue in certain circumstances I still don't know.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/07/18/669795.html" title="A new version of Unicode is released, and it&#39;s all five by five">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/07/18/669277.html" title="How is that pronounced, exactly?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-07-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/07/18/669509.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>