<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/28/728336.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What the hell is wrong with TranslateCharsetInfo, anyway?</title></head><body>
<h1>What the hell is wrong with TranslateCharsetInfo, anyway?</h1>
<p><em>by Michael S. Kaplan, published on 2006/08/28 09:49 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/08/28/728336.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>The other day, Colin had a customer with a question about some unexpected results from the Win32 function <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_2ovj.asp">TranslateCharsetInfo</A>: </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>My customer is having issues with the TranslateCharsetInfo API. They are using the TCI_SRCLOCALE to use the LCID as the source</P>
<P><FONT face="Consolas,Courier New"><STRONG>fResult = TranslateCharsetInfo((DWORD*)(langid), &amp;csi, TCI_SRCLOCALE);</STRONG></FONT></P>
<P>What they find is that the results of this call do not match always match the values listed in <A href="http://www.microsoft.com/globaldev/nlsweb/default.mspx">http://www.microsoft.com/globaldev/nlsweb/default.mspx</A></P>
<P>Specifically: </P>
<UL>
<LI>LCID 0x0C04 – Chinese (Hong Kong S.A.R.) - returns codepage 936 instead of the expected codepage 950 
<LI>LCID 0x0004 - Chinese (Simplified) – returns codepage 950 instead of the expected 936</LI></UL>
<P>Is what I’m seeing expected, if not is there a better way to achieve this?&nbsp; </P>
<P>We did also try: </P>
<P>GetLocaleInfo (langid, LOCALE_IDEFAULTANSICODEPAGE, szLocaleData, sizeof(szLocaleData)/sizeof(char)) ; </P>
<P>However from this the 0x0C04 LCID returns the expected 950 codepage (getting better), but the 0x0004 LCID still returns 950 instead of the 936 that the web documentation suggest I should have returned.</P>
<P>Or am I missing something?</P>
<P>Many thanks,</P>
<P>Colin</P></FONT></BLOCKQUOTE>
<P>The results of the two LCID values are actually caused by&nbsp;two entirely different issues.</P>
<P>In both cases, GDI is relying on the info that <A href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A> with the LOCALE_FONTSIGNATURE value for the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_8rse.asp">LCTYPE</A> returns. In other words, GDI is depending on NLS for the info on what to do here. </P>
<P>In one case, the fact that </P>
<UL>
<LI>the .NET Framework considers 0x0004 to be "Simplfied Chinese" even though 
<LI>Windows has for so many versions treated the neutral LCID as having an implicit SUBLANG_DEFAULT attached making it&nbsp;0x0404 (Chinese - Taiwan, a Traditional Chinese locale)</LI></UL>
<P>can be considered a legitimate design flaw in NLS that <STRONG>has only been fixed in Vista</STRONG> (via its <A href="http://msdn.microsoft.com/library/en-us/intl/nls_80o5.asp">ConvertDefaultLocale</A> function whose logic all NLS API functions that take an LCID go through.</P>
<P>In other words, that bug no longer repros on Vista. :-)</P>
<P>Now for the other half of the question, let's use the <A href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.aspx">CultureAndRegionInfoBuilder</A>'s secret <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A> parsing with a simple bit of code like the following:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Consolas,Courier New" size=2>
<P><STRONG>using System;<BR>using System.Globalization;</STRONG></P>
<P><STRONG>namespace LDML {<BR>&nbsp;&nbsp;&nbsp; class LDML {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [STAThread]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureAndRegionInfoBuilder carib = new CultureAndRegionInfoBuilder(args[0], CultureAndRegionModifiers.Replacement);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.LoadDataFromCultureInfo(new CultureInfo(args[0], false));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.LoadDataFromRegionInfo(new RegionInfo(args[0]));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; carib.Save(args[0] + ".ldml");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>}</STRONG></P></FONT></BLOCKQUOTE>
<P>Then, after you save this as ldml.cs and compile it:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>csc ldml.cs /r:sysglobl.dll</STRONG></FONT></P></BLOCKQUOTE>
<P>then you can save out the LDML that zh-HK (0x0c04) uses, and look at the markup afterward:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" color=#006400 size=2><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:fontSignature&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:unicodeRanges&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="0" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="1" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="2" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="3" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="5" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="7" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="9" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="31" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="35" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="36" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="37" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="38" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="39" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="42" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="43" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="45" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="46" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="48" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="49" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="50" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="51" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="54" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="59" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="60" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:range type="68" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:unicodeRanges&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:defaultCodePages&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:ansiCodePage /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:ansiOemCodePage&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:codePage type="<FONT color=#ff0000>936</FONT>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:ansiOemCodePage&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:oemCodePage /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:defaultCodePages&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:codePages&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:ansiCodePage /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:ansiOemCodePage&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:codePage type="<FONT color=#ff0000>936</FONT>" /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:ansiOemCodePage&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;msLocale:oemCodePage /&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:codePages&gt;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &lt;/msLocale:fontSignature&gt;</STRONG></FONT></P></BLOCKQUOTE>
<P>Note especially the code page that the <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A> has (marked in <FONT color=#ff0000>RED</FONT> above). So technically it is not GDI's fault for returning the wrong information, since it is simply relying on NLS.</P>
<P>Though technically you cannot blame NLS either, since all of the <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A>&nbsp;data is provided to us by the typography team. Eventually we may want an update from them on this so that <A href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A>&nbsp;can return consistent results between LOCALE_IDEFAULTANSICODEPAGE, LOCALE_IDEFAULTCODEPAGE, and LOCALE_FONTSIGNATURE....</P>
<P>How to fix is an interesting question, though.</P>
<P>In theory, given the increased usage of Simplified Chinese in Hong Kong in recent years would make it interesting to change the <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A>'s default code page to be 950, but to list both 936 <STRONG>and</STRONG> 950 in the code page section. And from a descriptive standpoint that might make a lot of sense.</P>
<P>In practice, however, the <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A>'s raison d'être is to provide informaton for creating a sensible default font to use for the locale. And generally speaking one does not have fonts that would support both -- the fact that either one may be used does not take into account that it really is an either/or proposition. So the best fix is likely just to make the <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A>&nbsp;match the locale it sits in....</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT face=DaunPenh size=8><STRONG>ញ</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/1789">U+1789</A>, KHMER LETTER NYO)</EM></FONT></P></FONT>
<hr/><p><a id="733526" href="#733526">#</a> <strong>SDiZ</strong> on 31 Aug 2006 10:02 AM:</p><div style="margin-left: 1em">Chinese (Hong Kong S.A.R.) and CP950 are so special.<br><br>Most Chinese user in Hong Kong use BIG5-HKSCS encoding, which is an extension to the BIG5 encoding.<br><br>Microsoft provide a varient of BIG5 on CP950. After installing a patch ( available <a rel="nofollow" target="_new" href="http://www.microsoft.com/hk/hkscs/">http://www.microsoft.com/hk/hkscs/</a> ), the CP950 becomes BIG5-HKSCS…… my CP950 may not be same as your CP950……<br><br></div>
<p><a id="733555" href="#733555">#</a> <strong>Michael S. Kaplan</strong> on 31 Aug 2006 10:26 AM:</p><div style="margin-left: 1em">Since there is no charset specific to HK, TraslateCharsetInfo will not help here.<br><br>Though note that Vista has a different solution to the problem than the hack/patch thing you are referring to. :-)</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/09/02 <a href="http://archives.miloush.net/michkap/archive/2009/09/02/9890204.html">How ConvertDefaultLocale sorta broke backward compatibility in Windows 7, and why</a></p><p>2008/10/05 <a href="http://archives.miloush.net/michkap/archive/2008/10/05/8977109.html">Can I get your [font]signature on this, please?</a></p><p>2008/08/15 <a href="http://archives.miloush.net/michkap/archive/2008/08/15/8869343.html">Yet another time that UTF-8 can't be the ACP</a></p><p>2008/06/19 <a href="http://archives.miloush.net/michkap/archive/2008/06/19/8620349.html">How do[es what] the common controls [call ]convert between ANSI and Unicode?</a></p><p>2007/03/20 <a href="http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html">Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/08/28/728868.html" title="There should always be a fallback available">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/08/27/727607.html" title="It has not always been so invariant">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/28/728336.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>