<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/24/712675.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It's not my imagination; that function is ignoring me!</title></head><body>
<h1>It's not my imagination; that function is ignoring me!</h1>
<p><em>by Michael S. Kaplan, published on 2006/08/24 06:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/08/24/712675.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>There is an alias at Microsoft that is the front line for the Shell team, the one place where the important issues like build breaks and blocking issues get brought up. Since&nbsp;even within Microsoft so many people assume that <STRONG>Windows == the Shell</STRONG>, this alias gets to triage and appropriately redirect issues a lot, too. Raymond talked about this list late last year in <A href="http://blogs.msdn.com/oldnewthing/archive/2005/12/08/501558.aspx">this post</A>. </P>
<P>And I belong to that list, so that every once in a while when someone complains about a Shell bug that is actually an internationalization bug, I can pitch in (though I am not on the official list to become a Dev O'Day or anything, it is always nice to help out if one has an area that know about!).</P>
<P>Also, every once in a while something interesting to blog about comes up.... :-)</P>
<P>Take&nbsp;the other day, for example.&nbsp;A problem was reported in Vista, with the SHLWAPI <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/functions/shsetlocalizedname.asp">SHSetLocalizedName function</A>, which sets the localized name of a folder. Basically it lets you set things up so that the Shell can use the <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/shloadindirectstring.asp">SHLoadIndirectString function</A> (which I have mentioned <A href="http://archives.miloush.net/michkap/search.aspx?q=SHLoadIndirectString+&amp;p=1"><STRONG>before</STRONG></A>) can be called.</P>
<P>Anyway, the problem was that sometimes it wasn't working. The function was reporting back success (S_OK), but the name was not being set. However, if the folder was made readonly, then the localized&nbsp;name would appear&nbsp;(<A href="http://blogs.msdn.com/oldnewthing/archive/2003/09/30/55100.aspx">this post</A> by Raymond explains how the setting actually has nothing to do with the folder being read-only, and why the setting would have an effect.</P>
<P>On the list it was quickly determined that the change of the attribute worked from an elevated command prompt and failed from a non-elevated one, and was thus quickly determined to be a permissions issue. The caller lacked the permissions to completely succeed in making the call to <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/functions/shsetlocalizedname.asp">SHSetLocalizedName</A>.</P>
<P>Of course the problem remained -- why was <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/functions/shsetlocalizedname.asp">SHSetLocalizedName</A>&nbsp;claiming success when it had technically failed?</P>
<P>I asked Raymond about this, hoping for understanding of some higher purpose behind it all. He quickly set me straight:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman" size=2>
<P>No, it's just a bug.<BR><BR>I mean, who would be so crazy as to make a directory that you could create and modify files in but which you couldn't attrib +R!<BR><BR>At the point this error occurs SHSetLocalizedName is kind of in a fix.<BR><BR>It already made half of the change and got an error making the other half.<BR><BR>Now what do you do?<BR><BR>You can't undo the first half because your change to the first half overwrote what used to be there (if the file already had a different localized name).<BR><BR>Sure, you could remember what used to be there before you overwrote it so you could restore it afterwards, but what if you encounter an error trying to restore it!?<BR><BR><EM>(or worse, what if somebody else also changed it in the meantime -- now your "restoration" is actually undoing somebody else's change)</EM><BR><BR>Basically, SHSetLocalizedName got itself into a jam and does its best to crawl out from under the rubble.</P></FONT></BLOCKQUOTE>
<P>One could even argue that it set the localized name just fine&nbsp;-- but like any situation where there is a setting and then a way to enable it, it simply hasn't been enabled yet. :-)</P>
<P>Technically, it seems that <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/functions/shsetlocalizedname.asp">SHSetLocalizedName</A>&nbsp;is doing its level best in the face of adversity, so perhaps there is a higher purpose here....</P>
<P>Anyway,&nbsp;we chatted about blogging about this issue. It seems worth doing since setting folder attributes is a pretty public process, and <A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/functions/shsetlocalizedname.asp">SHSetLocalizedName</A>&nbsp;is a pretty public function. So anyone could run into this very same problem, depending on how the foder was created and where.</P>
<P>And people really <STRONG>should</STRONG> be using the function to get the job done -- manually mucking about in desktop.ini or the cache in the registry or in file attributes in an NTFS stream or the folder's aura or its astrological sign or whatever other sneaky, undocumented&nbsp;method developers find to do work here can break anytime the underlying implementation of the functionality changes.</P>
<P>For the record, such a change <STRONG>did</STRONG> happen in Vista, which kind of proves the point, right?</P>
<P>Anyway, to answer the paranoia implicit in the title of the post -- the function isn't ignoring me, it is simply not pointing out the flaw in my approach when I didn't do everything right on my side. And the Shell is your friend -- what kind of friend is going to nitpick every little detail&nbsp;of a non-atomic operation? :-)</P>
<P>And now you can prove your worth to the Shell by <STRONG>calling the function</STRONG> to get the work done -- what kind of friend is going to ignore the polite ways to communicate and instead rifle through the drawers while&nbsp;your friend&nbsp;isn't looking?</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=6><STRONG>à¤‘</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0911">U+0911</A>, a.k.a. DEVANAGARI LETTER CANDRA O)</EM></FONT></P></FONT>
<hr/><p><a id="716987" href="#716987">#</a> <strong>Mike Dimmick</strong> on 24 Aug 2006 8:24 AM:</p><div style="margin-left: 1em">So this is a technique for giving a folder a different name in an Explorer view from its physical name on the disk? That'll nicely confuse anyone using cmd or msh to view it!</div>
<p><a id="717014" href="#717014">#</a> <strong>Jeroen Frijters</strong> on 24 Aug 2006 8:40 AM:</p><div style="margin-left: 1em">Now this would be a great story, except of course for the fact that Vista supports transactional NTFS, so that begs the question why doesn't SHLWAPI use a transaction to make the modification?</div>
<p><a id="718648" href="#718648">#</a> <strong>Mihai</strong> on 24 Aug 2006 2:25 PM:</p><div style="margin-left: 1em">&lt;&lt;what kind of friend is going to nitpick every little detail&gt;&gt;<br><br>The friends reading your blog? :-)</div>
<p><a id="719635" href="#719635">#</a> <strong>Michael Dunn_</strong> on 24 Aug 2006 9:29 PM:</p><div style="margin-left: 1em">Do you still have to grovel in desktop.ini to change the folder's icon? Now that I know about SHSetLocalizedName, all I need is an API that sets the icon, and I can get rid of some code that manually writes desktop.ini altogether.</div>
<p><a id="722676" href="#722676">#</a> <strong>Michael S. Kaplan</strong> on 25 Aug 2006 8:13 AM:</p><div style="margin-left: 1em">Hmmm, I am not sure. There is SHCreateDefaultExtractIcon, but I am not entirely sure if that will do the trick here....</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/08/25/722656.html" title="The Seattle Times plays Quechua-up, or &#39;How soon is now?&#39;">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/08/24/710624.html" title="Everybody&#39;s working for the weekend">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/24/712675.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>