<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/22/707665.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>'Unicode' doesn't corrupt, but 'ANSI' can corrupt, absolutely!</title></head><body>
<h1>'Unicode' doesn't corrupt, but 'ANSI' can corrupt, absolutely!</h1>
<p><em>by Michael S. Kaplan, published on 2006/08/22 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/08/22/707665.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P>The post that came from Chris Becke on the microsoft.public.platformsdk.gdi and the [now defunct] microsoft.public.platformsdk.localization newsgroups was:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>We had a problem with DrawTextA corrupting chinese text.<BR><BR>Inside our Dialog's WM_PAINT handler we were getting text from the applications string table and drawing it :-<BR><BR><FONT face="Consolas,Courier New"><STRONG>&nbsp;&nbsp;&nbsp; char szBuffer[256];<BR>&nbsp;&nbsp;&nbsp; LoadString(hResrc,IDS_MESSAGE,&amp;szbuffer,sizeof (szBuffer));<BR>&nbsp;&nbsp;&nbsp; DrawTextA(hDC,szbuffer,-1,&amp;rcText,DT_SINGLELING);</STRONG></FONT><BR><BR>No problem at all. At least on most systems we tried it on. Until our chinese translators said the string was garbage on our simplified chinese localization. Windows XP specifically. Our Windows 2000 and 98 testers hadn't reported problems...<BR><BR>So I got hold of a simplified chinese XP box, traced through the code, and examined the contents of szBuffer, and found that it contained the expected byte sequence for the 936 codepage. The LoadString *had* used the correct codepage to convert the string to ansi from unicode.<BR><BR>The DrawText however is displaying garbage characters. Not blocks, or ??'s, but random looking 'chinese'ish characters (to my untrained western eyes)<BR><BR>On a hunch, I took the 936 byte sequence, and did a MultiBytetoWideChar (950,... conversion. 950 being the "traditional chinese" codepage. And it produced in the debug window the exact text the DrawText was producing.<BR><BR>So, LoadString is using the system code page. DrawText was using codepage 950 to render the string! Why would it do this? GetACP, GetThreadLocale etc *all* indicated a simplified, not traditional, chinese localized system. The ansi APIs in a system should all be using the same ansi code-page right?<BR><BR>Wait. The problem was traced to our font creation. When creating the font we had inadverdently specified the CHINESEBIG5_CHARSET, rather than the GB2312_CHARSET character set.<BR><BR>However - the parameters to CreateFont are meant to be hints to the font mapper: I can understand the incorrect font definition causing a font without symbol support being loaded. i.e. I'd expect the undisplayable character glyph to be used, perhaps even ??'s.<BR><BR>I would't expect DrawTextA to use a different code page. The ability of DrawTextA to use codepages other than the system ansi code page certainly isnt mentioned *anywhere* in MSDN or in the MS KB.</FONT></P></BLOCKQUOTE>
<P>No question there obviously, since he figured out what the problem was. Though it does underscore that he did not see my <STRONG><A href="http://archives.miloush.net/michkap/archive/2005/05/13/417060.html">What code page does MSLU convert with?</A></STRONG> post. Which was technically posted on an MSDN blog. :-)</P>
<P>As I mentioned there:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Times New Roman">
<P><STRONG>Some [functions] use the ACP based on a particular device context handle (HDC), which has a Charset associated with it;<BR><FONT size=2>(e.g. most of the GDI functions that take an HDC parameter, like <A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_15kk.asp">GetTextExtentExPoint</A>)</FONT></STRONG></P></FONT></BLOCKQUOTE>
<P>That post alludes to another interesting story. I remember a long time ago when I was talking about the non-Unicode nature of Win9x on <A href="http://www.unicode.org/consortium/distlist.html">The Unicode List</A> and Microsoftie Chris Wendt (who, like many oldtimers,&nbsp;used to be on the Win9x team)&nbsp;sent me email to&nbsp;point out that I was wrong -- large parts of Win9x are actually 100% Unicode supporting.</P>
<P>And technically, Chris is right -- GDI (the piece in particular that is relevant here) is almost entirely Unicode internally, for example. It is even why there are several functions that support Unicode on Win9x within GDI. </P>
<P>I mean they were there anyway, so they figured why not expose them? </P>
<P>Imagine how silly it would be to provide a stub externally, while internally including the actual function? </P>
<P>Though there were times that was done in other places, so&nbsp;I guess it was not <EM>too</EM> silly. :-)</P>
<P>The problem is that&nbsp;most users and most developers never really get any real benefit from the pieces on Win9x that support Unicode since they were exposed so seldomly, which is why I think most people would tend to think of the point Chris was making as being like the <A href="http://www.minutecircle.co.uk/l1.htm">old joke</A> about MS employees:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2>A pilot is flying a single-engine charter plane to Seattle, with a couple of VIPs aboard, when he runs into thick fog. Visibility is less than a mile and the instrument panel starts to malfunction. He is in big trouble.<BR><BR>Unable to find the airport, he circles around looking for landmarks. After an hour he is low on fuel and his passengers are getting nervous. Then, through an opening in the fog, he spots a tall building with one guy working alone on the fifth floor. The pilot banks and shouts through the window:<BR>"Hey, buddy, where am I?"<BR>The lone worker replies:<BR>"You're in an airplane."<BR><BR>The pilot banks instantly into a 275 degree turn and makes a perfect blind landing on the airport runway five miles away. Just as the 'plane stops, the engine coughs and dies from lack of fuel.<BR><BR>The stunned passengers ask the pilot how he did it. <BR><BR>"Easy," he says. "I just asked the guy in that building a simple question. The answer he gave me was 100 percent accurate but absolutely useless. So I knew it must be the Microsoft Support Office - which is five miles from the runway on heading 087!" </FONT></P></BLOCKQUOTE>
<P>Whether the moral of the joke&nbsp;may be true or not, the simple&nbsp;fact is that since the non-Unicode functions had to convert to Unicode in order to work with the TrueType functions that were basically Unicode, they <EM>could</EM> have worked with CP_ACP, but why not use the extra information that they were being given if someone went to the effort to provide a FONT CHARSET in the device context that suggested another language? It kind of makes sense, in its own way.</P>
<P>Of course the number of times that people ever make use of this behavior is rather limited, which is probably why it&nbsp;does not&nbsp;come up much....</P>
<P>Though it is true that a more serious form of documentation than my blog would perhaps be in order, at this point (with <A href="http://archives.miloush.net/michkap/archive/2006/07/11/662550.html"><STRONG>Win9x no longer supported</STRONG></A>&nbsp;and all)&nbsp;I can see why the effort to update dozens of topics to describe the behavior that very few people ever actually run across may not be the biggest priority on anyone's list. :-)</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT face="Microsoft Yi Baiti" size=8>ꇟ</FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/a1df">U+a1df</A>, a.k.a. YI SYLLABLE GIEX)</EM></FONT></P></FONT>
<hr/><p><a id="712203" href="#712203">#</a> <strong>Chris Becke</strong> on 22 Aug 2006 5:57 AM:</p><div style="margin-left: 1em">&quot;Though it does underscore that he did not see my What code page does MSLU convert with? post. Which was technically posted on an MSDN blog. :-)&quot;<br><br>You know, depressingly enough, I actually read that post. &nbsp;Not too depressing though, I think perhaps it was the vague memory of that post that made me suspect that perhaps GDI was using a different code page which helped me resolve the problem that much faster.<br><br>One question remains in my mind, perhaps I can &quot;fix&quot; the code to work when the character set is misconfigured - is there any way - sort of hardcoding a table, to determine the code page GDI will use for any given character set value?</div>
<p><a id="712490" href="#712490">#</a> <strong>Michael S. Kaplan</strong> on 22 Aug 2006 7:29 AM:</p><div style="margin-left: 1em">You can call code to convert a codepage to a font charset -- something like this: <BR><BR><B><FONT face="Consolas,Courier New">UINT CpgFromHdc(HDC hdc) <BR>{ <BR>&nbsp; &nbsp;int chs; <BR>&nbsp; &nbsp;CHARSETINFO csi; <BR><BR>&nbsp; &nbsp;chs = GetTextCharset(hdc); <BR>&nbsp; &nbsp;if(TranslateCharsetInfo(&amp;(DWORD)chs, &amp;csi, TCI_SRCCHARSET)) <BR>&nbsp; &nbsp; &nbsp; &nbsp;return(csi.ciACP); <BR>&nbsp; &nbsp;else <BR>&nbsp; &nbsp; &nbsp; &nbsp;return(GetACP()); <BR>}</FONT></B> <BR><BR>As a way to simply know what GDI might do, on a per charset basis....</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/08/22/708503.html" title="A localizability problem is an application bug, or alternately: Ρύθμιση σήματος">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/08/21/707828.html" title="I missed a &#39;case&#39; pun....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/22/707665.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>