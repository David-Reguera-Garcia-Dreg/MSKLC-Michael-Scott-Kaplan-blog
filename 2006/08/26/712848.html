<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/26/712848.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The myth of cross-product compatibility</title></head><body>
<h1>The myth of cross-product compatibility</h1>
<p><em>by Michael S. Kaplan, published on 2006/08/26 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/08/26/712848.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<FONT face=Tahoma>
<P><EM><FONT size=2>Editorial note: there will be a certain type of Drunkard's Walk feel to this post, but that is because the navigation is actually controlled by a specific customer's attempt to understand behavior in SQL Server. The timeline will be a little abbreviated, but I'll try and hit all of the high points....</FONT></EM></P>
<P>The other day, when I was talking about <STRONG><FONT color=#ff1493><A href="http://archives.miloush.net/michkap/archive/2006/08/21/707790.html">Decimal vs. hexadecimal LCIDs, backcompat, and being weird</A></FONT></STRONG>, I made a statement about the irony of finding a bug that could have been found in many different COLLATIONS supported in SQL Server in a Unicode-only locale and a binary sort -- one of the specific collations that has nothing to add to either collation or code page behavior. </P>
<P>In fairness, I should take a bit of that back. The truth is that Unicode only, binary collations have one thing to add to the mix that other collations do not.</P>
<P>They can add a bug that adds inconsistency,&nbsp;makes SQLCLR integration a bit harder, and is very poorly documented, to boot!</P>
<P>To see the problem, let's take the following query and see which collations we are talking about (based on all the lessons we learned from <A href="http://archives.miloush.net/michkap/archive/2005/06/09/427293.html"><STRONG>this post</STRONG></A> and comments thereof!):</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>SELECT <BR>&nbsp;&nbsp;&nbsp; name, <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'CodePage') as CodePage, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'LCID')) as LCID, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'ComparisonStyle')) as ComparisonStyle, <BR>&nbsp;&nbsp;&nbsp; description <BR>FROM <BR>&nbsp;&nbsp;&nbsp; ::fn_helpcollations() <BR>WHERE <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'CodePage') = 0 AND<BR>&nbsp;&nbsp;&nbsp; name LIKE '%_BIN'</STRONG></FONT></P></BLOCKQUOTE>
<P>This will return just three rows:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>Divehi_90_BIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;0x00000465&nbsp;0x00000000&nbsp;Divehi-90, binary sort<BR>Indic_General_90_BIN&nbsp;&nbsp;&nbsp; 0&nbsp;0x00000439&nbsp;0x00000000&nbsp;Indic-General-90, binary sort<BR>Syriac_90_BIN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;0x0000045A&nbsp;0x00000000&nbsp;Syriac-90, binary sort</STRONG></FONT></P></BLOCKQUOTE>
<P>Hmmm... where is the Georgian? I mean, Georgian is a Unicode-only locale!</P>
<P>Ok, we will try a slightly different query:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG><FONT face=Consolas size=2>SELECT <BR>&nbsp;&nbsp;&nbsp; name, <BR>&nbsp;&nbsp;&nbsp; COLLATIONPROPERTY(name, 'CodePage') as CodePage, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'LCID')) as LCID, <BR>&nbsp;&nbsp;&nbsp; CONVERT(binary(4), COLLATIONPROPERTY(name, 'ComparisonStyle')) as ComparisonStyle, <BR>&nbsp;&nbsp;&nbsp; description <BR>FROM <BR>&nbsp;&nbsp;&nbsp; ::fn_helpcollations() <BR>WHERE&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;name LIKE 'Georgian%'&nbsp;AND<BR>&nbsp;&nbsp;&nbsp; name LIKE '%_BIN'</FONT></STRONG></P></BLOCKQUOTE>
<P>and run it. We get back just one row:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>Georgian_Modern_Sort_BIN&nbsp;1252&nbsp;0x00010437&nbsp;0x00000000&nbsp;Georgian-Modern-Sort, binary sort</STRONG></FONT></P></BLOCKQUOTE>
<P>It thinks the code page is 1252? That is nothing like <A href="http://msdn2.microsoft.com/en-us/library/system.globalization.textinfo.ansicodepage.aspx">CultureInfo("ka-GE").TextInfo.ANSICodePage</A>, at all! Somehow SQL Server has made Georgian a locale with a system code page that does not support any of the Georgian characters that are needed in the language.</P>
<P>So we already know that the sorting doesn't match -- now we know sometimes the codepages don't match, either?</P>
<P>Let's table that for a moment; we'll come back to it with the explanation.</P>
<P>It gets worse. That code page value of 0? That happens to be the number behind CP_ACP, the default system code page. Let's try that out with the following script:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Consolas,Courier New" size=2><STRONG>use master<BR>IF DB_ID (N'sql_test') IS NOT NULL<BR>&nbsp;&nbsp;&nbsp; DROP DATABASE sql_test;<BR>GO<BR><BR>CREATE DATABASE sql_test;<BR>GO<BR><BR>use sql_test<BR><BR>CREATE TABLE sql_cp (<BR>&nbsp;&nbsp;&nbsp; colD nvarchar (50) COLLATE Divehi_90_BIN NULL,<BR>&nbsp;&nbsp;&nbsp; colA nvarchar (50) COLLATE Arabic_BIN NULL<BR>)<BR><BR>GO<BR><BR>use sql_test<BR>INSERT INTO <BR>&nbsp;&nbsp;&nbsp; sql_cp (colD, colA) <BR>VALUES (<BR></STRONG></FONT><FONT face="Consolas,Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp; 'ابةتثجحخدذرزسشصضطظعغ',<BR>&nbsp;&nbsp;&nbsp; 'ابةتثجحخدذرزسشصضطظعغ')<BR><BR>SELECT * FROM sql_cp;</STRONG></FONT></P></BLOCKQUOTE>
<P>If you really did pass 0 to <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_17si.asp">MultiByteToWideChar</A> on a system with an Arabic system code page, it would convert the string via cp1256. What does the query return?</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><STRONG><FONT face=Consolas size=2>????????????????????&nbsp;&nbsp;&nbsp; ابةتثجحخدذرزسشصضطظعغ</FONT></STRONG></P></BLOCKQUOTE>
<P>Hmmm.... it must have changed the meaning of 0 to mean the default <STRONG>database</STRONG> codepage. Which in this case is based on the server collation, which happens to be one of the Latin1_General collations.</P>
<P>Ok, we'll just call that one unexpected rather than a bug. But the fact that Georgian is no longer a Unicode only locale when both Windows and the .NET Framework think it is remains a problem. </P>
<P>What about other Unicode only locales like Armenian? Well, they are slightly worse off; since they have no collations of their own (no code page requirement and no unique sort beyond the default table means no unique collation in SQL Server), they have lost their identity, in a way.</P>
<P>And finally we know why this bug in Georgian exists -- because the Traditional Georgian sort is in the default table (along with lots of other Unicode only locales) and since <STRONG>it</STRONG> has the CodePage of 1252, the modern sort has to as well.</P>
<P>But this means that a whole lot of SQL Server collations do not match their analagous cultures in the .NET Framework or locales in Windows. And that is even before we get into the whole rogue version of the sorting tables issue I've mentioned <A href="http://archives.miloush.net/michkap/archive/2005/09/13/463962.html"><STRONG>in the past</STRONG></A>, or the newer <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html">Danish/Norwegian problems</A></STRONG> or the <STRONG><A href="http://archives.miloush.net/michkap/archive/2006/04/25/583307.html">potential upcoming problem with Swedish/Finnish</A></STRONG>.</P>
<P>This is hardly the only reason for the changes that happened <A href="http://blogs.msdn.com/winfs/archive/2006/06/23/644706.aspx">with</A> <A href="http://blogs.msdn.com/winfs/archive/2006/06/26/648075.aspx">WinFS</A>, if you will notice it was not really mentioned at all. But these differences had a lot to do with the integration challanges, which had still not been fully worked at the point that the project's energies were redirected.</P>
<P>It is a problem that we in GIFT had to deal with ourselves with a managed child that was engineered to try to fix old problems but then which later had to find itself integrated back with its unmanaged parent for custom locales to work. And we did not even have the excuse of different teams since it was often the very same people. But we decided to dig in and solve the problems -- because that integration is so crucial.</P>
<P>What the next version of SQL Server needs here is a fix to the whole problem. A way to consistently represent the locale, codepage, and&nbsp;collation data that it consumes from Windows and then later on tries to use in concert with the operating system and the .NET Framework....</P>
<P>&nbsp;</P>
<P><FONT color=#ff1493><EM>This post brought to you by</EM> <FONT size=8><STRONG>ྊ</STRONG></FONT> <EM>(<A href="http://www.fileformat.info/info/unicode/char/0f8a">U+0f8a</A>, a.k.a. TIBETAN SIGN GRU CAN RGYINGS)</EM></FONT></P></FONT>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2006/08/26/725670.html" title="I must admit that an example would be nice">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2006/08/25/723880.html" title="Shortcuts can be so Goth, you know?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2006-08-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2006/08/26/712848.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:39 GMT -->
</html>