<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/06/29/8667900.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Did someone break GetTimeZoneInformation in XP?</title></head><body>
<h1>Did someone break GetTimeZoneInformation in XP?</h1>
<p><em>by Michael S. Kaplan, published on 2008/06/29 13:21 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/06/29/8667900.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Kim Gräsman asks via the Contact link:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><STRONG>Subject: GetTimeZoneInformation changed on XP?</STRONG><BR><BR>Hi Michael,<BR><BR>I haven't been following your blog closely, but I was recommended on a </FONT><A class="" href="http://groups.google.com/group/microsoft.public.win32.programmer.kernel/browse_thread/thread/7e908cab88a8c460/948ee6d7e14a47f1" mce_href="http://groups.google.com/group/microsoft.public.win32.programmer.kernel/browse_thread/thread/7e908cab88a8c460/948ee6d7e14a47f1"><FONT face="times new roman,times">newsgroup</FONT></A><FONT face="times new roman,times"> to ask y</FONT><FONT face="times new roman,times">ou about this. Hopefully you can help me out, or direct me to someone who can.<BR><BR>It seems GetTimeZoneInformation has changed recently, and broken its documented behavior -- as I understand it:<BR><BR>1) If Automatic DST adjustment is turned off, GTZI is documented to return TIME_ZONE_ID_UNKNOWN<BR>2) If Automatic DST adjustment is turned off, GTZI is documented to return a struct containing StandardDate and DaylightDate with the wMonth member set to zero.<BR><BR>For some reason, on all of our XP machines, GTZI does the following instead:<BR><BR>1) If Automatic DST adjustment is turned off -- returns TIME_ZONE_ID_DAYLIGHT (even though we're still in standard time)<BR>2) If Automatic DST adjustment is turned off -- returns a struct with both wMonths set to October (10), which is, incidentally, the month where DST turns off here.<BR><BR>I'm absolutely positive that this behavior has changed recently, though I can't say when, I stumbled upon it the other day.<BR><BR>Now, a question: is this likely due to a code change in GetTimeZoneInformation (i.e. has the code been updated for some XP patch) or can it be caused by the recent updates to the time zone database? I'm trying to get an idea of where to start looking...<BR><BR>I'm in the "(GMT+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna" time zone, FWIW.<BR><BR>Many thanks for any ideas,<BR>- Kim Gräsman</FONT></P></BLOCKQUOTE>
<P>Obviously there has been a great deal of interest in time zones lately.</P>
<P>If anything was ever going to change that was going to break some specific behavior while trying to fix the larger problem that </P>
<UL>
<LI>products all over the Microsoft&nbsp;landscape were broken, and</LI>
<LI>it was noticed inside the US</LI></UL>
<P>then we are definitely in the "right" time to see such a&nbsp;change....</P>
<P>Combine that information with the <A class="" href="http://archives.miloush.net/michkap/archive/2005/11/12/491519.html" mce_href="http://archives.miloush.net/michkap/archive/2005/11/12/491519.html"><STRONG>Second&nbsp;Tester's Axiom</STRONG></A>:</P>
<BLOCKQUOTE>
<P><STRONG><FONT size=4>Axiom II: If someone changes it, they probably broke it</FONT></STRONG></P></BLOCKQUOTE>
<P>and suddenly problems seem more likely -- and I'll take this bug report as more authoritative (off the top of my head) than assurances that no such bug exists. :-)</P>
<P>I don't know of a specific change to the XP-level&nbsp;<A class="" href="http://msdn.microsoft.com/library/ms724421.aspx" mce_href="http://msdn.microsoft.com/library/ms724421.aspx">GetTimeZoneInformation</A> that would change the return value this way for the non-DST-timezone case, and I would be curious if Server 2003 repros this, or whether Vista SP1/Server 2008 show the same behavior -- not just in <A class="" href="http://msdn.microsoft.com/library/ms724421.aspx" mce_href="http://msdn.microsoft.com/library/ms724421.aspx">GetTimeZoneInformation</A>&nbsp;but also in the newer <A class="" href="http://msdn.microsoft.com/library/bb540851.aspx" mce_href="http://msdn.microsoft.com/library/bb540851.aspx">GetTimeZoneInformationForYear</A> or <A class="" href="http://msdn.microsoft.com/library/ms724318.aspx" mce_href="http://msdn.microsoft.com/library/ms724318.aspx">GetDynamicTimeZoneInformation</A> functions.</P>
<P>I'll forward this blog and the forum note to some of the time zone movers/shakers to see if anything pops....</P>
<BLOCKQUOTE>
<P>A smattering of prior blogs from this Blog about time zones:</P>
<UL>
<LI><FONT size=1>May 2007: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/20/2752500.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/20/2752500.html"><STRONG><FONT size=1>Never without my permission, Redux</FONT></STRONG></A></LI>
<LI><FONT size=1>February 2007: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2007/02/05/1606868.html" mce_href="http://archives.miloush.net/michkap/archive/2007/02/05/1606868.html"><STRONG><FONT size=1>I'm sorry, but Microsoft does not get time zones</FONT></STRONG></A></LI>
<LI><FONT size=1>January 2007: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2007/01/09/1438044.html" mce_href="http://archives.miloush.net/michkap/archive/2007/01/09/1438044.html"><STRONG><FONT size=1>The Phantom [Time] Zone</FONT></STRONG></A></LI>
<LI><FONT size=1>December 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/22/1350684.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/22/1350684.html"><STRONG><FONT size=1>Sometimes when sorting the index is the last thing you want to use</FONT></STRONG></A></LI>
<LI><FONT size=1>December 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/18/1314233.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/18/1314233.html"><STRONG><FONT size=1>Don't get into the zone too soon....</FONT></STRONG></A></LI>
<LI><FONT size=1>September 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/09/16/755152.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/16/755152.html"><STRONG><FONT size=1>You want to change the time zone? Eto Akta Gamat!</FONT></STRONG></A></LI>
<LI><FONT size=1>July 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/07/07/658498.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/07/658498.html"><STRONG><FONT size=1>Results of the 'Time Zone Scenario Feedback' feared</FONT></STRONG></A></LI>
<LI><FONT size=1>May 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/05/24/605569.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/24/605569.html"><STRONG><FONT size=1>Did somebody say time zones were intuitive?</FONT></STRONG></A></LI>
<LI><FONT size=1>April 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/04/05/568208.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/05/568208.html"><STRONG><FONT size=1>Ok, so there may be *some* worries here</FONT></STRONG></A></LI>
<LI><FONT size=1>April 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/04/03/567489.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/03/567489.html"><STRONG><FONT size=1>Time zones make me cringe</FONT></STRONG></A></LI>
<LI><FONT size=1>April 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/04/03/567443.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/03/567443.html"><STRONG><FONT size=1>The Sri Lanka time zone shift?</FONT></STRONG></A></LI>
<LI><FONT size=1>January 2006: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2006/01/14/512530.html" mce_href="http://archives.miloush.net/michkap/archive/2006/01/14/512530.html"><STRONG><FONT size=1>Brother, can you spare a time[zone]?</FONT></STRONG></A></LI>
<LI><FONT size=1>December 2004: </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2004/12/20/328040.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/20/328040.html"><STRONG><FONT size=1>The Time [Zone] is Right...</FONT></STRONG></A></LI></UL></BLOCKQUOTE>
<P mce_keep="true"><BR><BR><EM><FONT color=#ff00ff>This post has no sponsor</FONT></EM></P>
<hr/><p><a id="8676957" href="#8676957">#</a> <strong>Kim Gr&#228;sman</strong> on 1 Jul 2008 9:29 AM:</p><div style="margin-left: 1em"><P>Hi Michael,</P>
<P>Thanks for the shout-out.</P>
<P>Here's a minimalistic repro case, should someone feel the urge to try it:</P>
<P>--</P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,courier new,courier,fixed"><STRONG>#include &lt;windows.h&gt;<BR>#include &lt;iostream&gt;<BR>using namespace std;<BR>static const char* RetvalNames[] = {<BR>&nbsp;"TIME_ZONE_ID_UNKNOWN",&nbsp;<BR>&nbsp;"TIME_ZONE_ID_STANDARD",<BR>&nbsp;"TIME_ZONE_ID_DAYLIGHT"<BR>};<BR><BR>int main(int argc, char* argv[])<BR>{<BR>&nbsp;&nbsp; &nbsp;TIME_ZONE_INFORMATION tzi = {0};<BR>&nbsp;&nbsp; &nbsp;DWORD retval = GetTimeZoneInformation(&amp;tzi);<BR>&nbsp;&nbsp;&nbsp; cout &lt;&lt; "Return value: " &lt;&lt; RetvalNames[retval] &lt;&lt; " (" &lt;&lt; retval &lt;&lt; ")" &lt;&lt; endl;<BR>&nbsp;&nbsp;&nbsp;&nbsp;cout &lt;&lt; "Daylight start month: " &lt;&lt; tzi.DaylightDate.wMonth &lt;&lt; endl;<BR>&nbsp;&nbsp;&nbsp; cout &lt;&lt; "Standard start month: " &lt;&lt; tzi.StandardDate.wMonth &lt;&lt; endl;<BR>}</STRONG></FONT></P></BLOCKQUOTE>
<P>--</P>
<P>It should say:</P>
<BLOCKQUOTE>
<P>Return value: TIME_ZONE_ID_UNKNOWN (0)<BR>Daylight start month: 0<BR>Standard start month: 0</P></BLOCKQUOTE>
<P>When we originally had this problem, I checked on Vista (pre SP1, I think) and it worked as expected. Haven't checked other platforms.<BR><BR>Cheers,<BR>- Kim</P></div>
<p><a id="8677026" href="#8677026">#</a> <strong>Gert-Jan</strong> on 1 Jul 2008 9:44 AM:</p><div style="margin-left: 1em"><p>Boy does this sound familiar! I already ran into these problems 7 years ago, and nothing has changed it seems.</p>
<p>My first assumption was that turning off automatic DST adjustment would do only that: stop Windows from automatically adjusting my system clock when switching from DST and back.</p>
<p>When I turn the automatic adjustment off I don't change timezones and the same DST rules are therefore still valid, so I expected Windows would still know about DST even with the automatic adjustment switched off.</p>
<p>In practice it completely disables DST, causes GTZI to return bogus data and its behavior doesn't follow the official documentation anymore.</p>
<p>I happened to have access to Microsoft support at the time (Win2k days), and the answer I got was that &quot;the internal structures do not have a boolean that says that daylight is enabled/disabled. All they carry are some strings and time values, so to &quot;disable daylight&quot; you set the daylight and standard to the same values.&quot;</p>
<p>So for me this weird behavior is not recent, since it has been broken since Win2k (so including XP); it actually only worked right under Windows98 :-/</p>
<p>At the time I already asked for a documentation update since GTZI returning TIME_ZONE_ID_DAYLIGHT the whole year round with bogus transition dates is just wrong and doesn't match the documentation, as mentioned by Kim. But apparently nothing happened since...</p>
<p>But for me the main problem is that disabling the automatic DST adjustment impacts GTZI for no good reason.</p>
<p>The on-line help for the automatic DST adjustment setting still says &quot;If you use more than one operating system, make sure that only one of them automatically adjusts for daylight saving time.&quot;</p>
<p>What it doesn't tell you is that disabling the adjustment in Windows has nasty side-effects...</p></div>
<p><a id="8678391" href="#8678391">#</a> <strong>John Cowan</strong> on 1 Jul 2008 3:44 PM:</p><div style="margin-left: 1em"><p>If only you people didn't suffer so badly from NIH and would use the Olson time zone data and library, like everyone else on the planet Earth.</p></div>
<p><a id="8978871" href="#8978871">#</a> <strong>Michael S. Kaplan</strong> on 6 Oct 2008 6:03 PM:</p><div style="margin-left: 1em"><p>There is a large installed base that would be broken by that move to support what &quot;everyone else on the planet&quot; uses, thus such moves should only be taken lightly by people who are willing to let large pieces of the world fall down in ways that make the DST 2007 problems look like a knee scrape....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/06/30/6633571.html" title="Thirdly, aka Forty two, aka Understanding the answer can require a properly defined question">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/06/29/8666513.html" title="If they say &quot;it&#39;s all relative&quot; then remind them it is not a coincidence that there is a show called Relative Madness on TV">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-06-29">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/06/29/8667900.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>