<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/06/19/8620349.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How do[es what] the common controls [call ]convert between ANSI and Unicode?</title></head><body>
<h1>How do[es what] the common controls [call ]convert between ANSI and Unicode?</h1>
<p><em>by Michael S. Kaplan, published on 2008/06/19 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/06/19/8620349.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The other day, <A class="" href="http://blogs.msdn.com/oldnewthing/" mce_href="http://blogs.msdn.com/oldnewthing/">Raymond Chen</A> blogged about <A class="" href="http://blogs.msdn.com/oldnewthing/archive/2008/06/16/8602155.aspx" mce_href="http://blogs.msdn.com/oldnewthing/archive/2008/06/16/8602155.aspx">How do the common controls convert between ANSI and Unicode?</A>, in response to a <A class="" href="http://blogs.msdn.com/oldnewthing/pages/407234.aspx#513761" mce_href="http://blogs.msdn.com/oldnewthing/pages/407234.aspx#513761">question</A> in his suggestion box:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>In the context of an ansi (not unicode) app: How do the common controls (listview for example) decide which code page to use when translating multibyte to widestring? <BR><BR>I had to debug an ansi app that was displaying corrupt strings on a traditional chinese system because the dialog font was causing the listview to use a codepage other than the system ACP when translating multibyte to widechar. </EM></FONT></P></BLOCKQUOTE>
<P>Although I would seldom if ever disagree with about anything that builds out of the Shell depot, in this particular case I know of two specific exceptions to the CP_ACP rule one generally sees, though the differences may have&nbsp;less of a&nbsp;direct relationship to the Shell/comctl32 code, meaning he might still be right within his domain. :-)</P>
<P>The two other behaviors I have run across in various versions of the common controls:</P>
<UL>
<LI>Use of the thread code page (CP_THREAD_ACP)<FONT size=1><SUP>1</SUP></FONT>. </LI>
<LI>Use of the code page associated with the font charset selected in a device context.</LI></UL>
<P>I honestly don't know much about the first one, but I remember&nbsp;reports of bugs where changing the thread locale (which changes the thread code page) would change the behavior here, and particularly on the pre-6.0 controls there was a real ANSI-Plus thing going on here that tried to move beyond CP_ACP, so while I had no proof it was true I suspected it might be.</P>
<P>The second one, I have more insight into since I had to debug it on a few occasions -- basically the text would not always be converted to Unicode at all; and the ANSI text is sent to GDI with a DC containing a font set to use a charset most associated with some other code page. GDI would then do its job to render and make choices there that it was kind of asked to, in a bizarre and not well understood sense.</P>
<P>As a rule, any time GDI tries to get into NLS stuff, the results are predictable -- buggered, every time. Thus we have problems like the ones I pointed out in <A class="" href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html"><STRONG>What the hell is wrong with TranslateCharsetInfo, anyway?</STRONG></A>. Between problems like that and the one discussed in <A class="" href="http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html"><STRONG>Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</STRONG></A>&nbsp;and <A class="" href="http://archives.miloush.net/michkap/archive/2007/06/25/3521939.html" mce_href="http://archives.miloush.net/michkap/archive/2007/06/25/3521939.html"><STRONG>Sometimes when you say 'the fix is in' you mean it in a good way</STRONG></A>, one thing is clear: the GDI folks&nbsp;should consider taking a trip over to the NLS team and giving them all <A class="" href="http://en.wikipedia.org/wiki/Wedgie" mce_href="http://en.wikipedia.org/wiki/Wedgie">atomic wedgies</A>.</P>
<P>Just kidding, but you know what I mean.</P>
<P>For the Common Controls, when I was doing MSLU work I ran across many cases where having the latest updates on Win9x would give a lot of GDI-influenced support of text where adding MSLU and a CP_ACP mechanism broke test applications until I changed the code to do something more like this to get the code page to convert with:</P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,ourier new,courier"><STRONG>UINT CpgFromHdc(HDC hdc) {<BR>&nbsp;&nbsp;&nbsp; int chs;<BR>&nbsp;&nbsp;&nbsp; CHARSETINFO csi;<BR><BR>&nbsp;&nbsp;&nbsp; chs = GetTextCharset(hdc);<BR>&nbsp;&nbsp;&nbsp; if(TranslateCharsetInfo(&amp;(DWORD)chs, &amp;csi, TCI_SRCCHARSET))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(csi.ciACP);<BR>&nbsp;&nbsp;&nbsp; else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(g_acp);<BR>}<BR></STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">So anyway, the CP_ACP rule should be the only rule. but there are way too many pieces of Windows that assume they know better what to use....</P>
<P mce_keep="true">On the other hand, so do I -- <STRONG>UNICODE</STRONG>! :-)<BR></P>
<P><FONT size=1>1 - Now you know how I feel about this one if you've ever seen </FONT><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/28/2960411.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/28/2960411.html"><STRONG><FONT size=1>Nothing stinks worse than the thread locale, other than the thread code page</FONT></STRONG></A><FONT size=1>. I think I was fairly&nbsp;unsubtle on my feelings. </FONT></P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=7> à¨¶ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0a36" mce_href="http://www.fileformat.info/info/unicode/char/0a36">U+0a36</A>, aka GURMUKHI LETTER SHA)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/06/19/8620456.html" title="Accelerator vs. Shortcut, revisited">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/06/18/8617581.html" title="The &#39;honor&#39; of being #523 out of 5486">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-06-19">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/06/19/8620349.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>