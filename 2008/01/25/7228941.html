<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/25/7228941.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On reversing the irreversible (grabbing the data, part I)</title></head><body>
<h1>On reversing the irreversible (grabbing the data, part I)</h1>
<p><em>by Michael S. Kaplan, published on 2008/01/25 08:16 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/01/25/7228941.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The first blog in this series was <A class="" href="http://archives.miloush.net/michkap/archive/2008/01/13/7090976.html" mce_href="http://archives.miloush.net/michkap/archive/2008/01/13/7090976.html"><STRONG>On reversing the irreversible (the introduction)</STRONG></A>&nbsp;and the second was <A class="" href="http://archives.miloush.net/michkap/archive/2008/01/14/7102809.html" mce_href="http://archives.miloush.net/michkap/archive/2008/01/14/7102809.html"><STRONG>On reversing the irreversible (The Set-Up)</STRONG></A>.</P>
<P>The real question that comes up is how to make InitializeSortkeyReverseData[Ex] do the job here -- starting with how to store the information?</P>
<P>Looking at our prototypical empty sort key value, discussed in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html"><STRONG>A&amp;P of Sort Keys, part 0 (aka The empty string sorts the same in every language)</STRONG></A>:</P>
<BLOCKQUOTE>
<P><STRONG><FONT face=Consolas>01 01 01 01 00</FONT></STRONG></P></BLOCKQUOTE>
<P>or with the placeholders for actual sort key data&nbsp;included:</P>
<BLOCKQUOTE>
<P><STRONG><FONT size=1><FONT face=Consolas><FONT color=#999966>[all Unicode sort weights]</FONT> 01 <FONT color=#999966>[all Diacritic weights]</FONT> 01 <FONT color=#999966>[all Case weights]</FONT> 01 <FONT color=#999966>[all Special weights]</FONT> 01 <FONT color=#999966>[Punctuation weights]</FONT> 00</FONT></FONT></STRONG></P></BLOCKQUOTE>
<P>For each sort key value obtained, we need to&nbsp;separately store these five chunks, hashing them by the original string used to get the sort key.</P>
<P>And how to get the big bunch of sort key values?</P>
<P>Well, you may recall some of my prior discussion on&nbsp;sort elements, such as <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/19/440320.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/19/440320.html"><STRONG>Sort element vs. text element</STRONG></A> and <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html"><STRONG>More on sort elements</STRONG></A>.</P>
<P><EM>(if not then you can read them now!)</EM></P>
<P mce_keep="true">Well, the goal is to isolate each call to retrieve only one single sort element. There are two important consequences of this need:</P>
<P mce_keep="true">1) Any time you have an expansion -- discussed in that second post above and more rigorously in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html"><STRONG>A&amp;P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</STRONG></A> --&nbsp;you do not need to store the information. Because you are really getting two or three sort elements there, your later attempts to do lookups of single sort keys are never going to find them (the individual sort elements will be found instead).</P>
<P mce_keep="true">The consequence? You will&nbsp;in most cases&nbsp;not&nbsp;be able to retrieve <STRONG>Æ</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/00c6" mce_href="http://www.fileformat.info/info/unicode/char/00c6">U+00c6</A>, LATIN CAPITAL LETTER AE) since it will for most locales&nbsp;only ever be treated like <STRONG>AE</STRONG>.</P>
<P mce_keep="true">It may be tempting to remove the items (perhaps detecting them via a call to <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A> with the MAP_EXPAND_LIGATURES flag), but as I point out in <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html"><STRONG>Why doesn't FoldString take an LCID?</STRONG></A> there is no way to get the information for anything but the default table. So on the whole storing this data is a harmless thing, and nothing you really need to worry about (though if you wanted to remove them to have fewer entries you could try that <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A>&nbsp;route).</P>
<P mce_keep="true">2) Any time you have a compression in a locale -- more on these all over the place in the blog like <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/17/439742.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/17/439742.html"><STRONG>A Microsoft convention for compressions in sorting</STRONG></A> and the definitive <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/16/4937196.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/16/4937196.html"><STRONG>A&amp;P of Sort Keys, part 6 (aka Relax, be calm, and deCOMPRESS if you are feeling out of sorts)</STRONG></A> -- you will get a single sort element from multiple letters. </P>
<P mce_keep="true">So reversing them is easy, but in order to store them you have to know what they are either because you know the language and its rules or because you had the actual data (or you have to do huge brute force&nbsp;calls to get every&nbsp;single letter combination to look for sort key values that&nbsp;are of different length than they are in the default&nbsp;table which has no compressions).</P>
<P mce_keep="true">This is actually the easiest part for people to skip (and most of the attempts at solving this problem, people do skip), even though it means you miss out on a lot of what Windows has to offer in the way of collation support.&nbsp;But in many ways being willing to be flexible and&nbsp;work a little harder to build the data cache up will reap huge rewards and is worth the extra effort....</P>
<P mce_keep="true">So how&nbsp;to proceed? Well, that&nbsp;part is easy to start -- naively you can scroll through every single&nbsp;code point from U+0001 to&nbsp;U+10fffd and store the sort key value. Less naively you can generally skip lots of different code points, like via a&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms647481.aspx" mce_href="http://msdn2.microsoft.com/library/ms647481.aspx">GetStringTypeW</A> call skipping anything that is C1_CONTROL or for some purposes consider whether you want to be throwing out C1_BLANK or C1_PUNCT or C3_SYMBOL values. </P>
<P mce_keep="true">You don't have to do this of course, but you have&nbsp;to ask yourself whether it is worth retaining all of that data or whether it is extraneous&nbsp;-- like you may want the punctuation saved so that the word <STRONG>don't</STRONG> can be retained, but do you really care about control characters? And if you are going to put in&nbsp;a SPACE for all of the characters you skip then maybe you could take that smallest symbolic weight (ref: <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/25/560416.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/25/560416.html"><STRONG>I need my SPACE, symbolically speaking</STRONG></A>) and plug it in for many of these non-letter type characters.</P>
<P mce_keep="true">And when you find a duplicate sort key, you can do one of two things -- you can throw away the new one, or you can replace the old one with it. And you probably want to not pass a bunch of NORM_IGNORE* flags as I mentioned before in <STRONG><U><FONT color=#800080>(The Set-Up)</FONT></U></STRONG>&nbsp;-- I'll discuss how to get those same results later, but for now let's keep the data.</P>
<P mce_keep="true">By default we'll assume that we should get all of the language specific stuff so we'll figure out a huge naive way of doing it -- we'll optimize it later, after we figure out what we have.</P>
<P mce_keep="true">Now I have skipped stuff that is seemingly quite important that has come up in this blog before, like Japanese Kana, Korean Jamo, and more. But for now just trust me when I say that they are either nothing to worry about (or at worst no more awful than compressions, above), and in an upcoming&nbsp;blog I will&nbsp;explain why.</P>
<P mce_keep="true">I will also explain in an upcoming blog about how the actual reversal operation will use this data that has been conceptually built in up, so that the combination of how we get the data and how we are gonna use it can help drive how to implement the actual storage....</P>
<P mce_keep="true">Think of this series like a&nbsp;bunch of interview questions, but ones that I am going to answer more than I ask (which is not to say I won't do some quizzing of you readers!).</P>
<P mce_keep="true">Stay tuned -- this series is only gonna get cooler! :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> Ặ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/1eb6" mce_href="http://www.fileformat.info/info/unicode/char/1eb6">U+1eb6</A>, aka LATIN CAPITAL LETTER A WITH BREVE AND DOT BELOW)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/03 <a href="http://archives.miloush.net/michkap/archive/2008/03/03/7984960.html">On reversing the irreversible (grabbing the data, part II: the weirdness not so related to locales)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/01/26/7245466.html" title="Overheard, yet again">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/01/25/7227422.html" title="Behold the Table Driven Text Service, Part 4 (Specifying when to modify, if not how)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/25/7228941.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>