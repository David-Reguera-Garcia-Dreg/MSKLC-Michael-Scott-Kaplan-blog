<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/02/6950506.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Here be dragons?</title></head><body>
<h1>Here be dragons?</h1>
<p><em>by Michael S. Kaplan, published on 2008/01/02 10:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/01/02/6950506.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Dan's question is one that has been on some people's minds ffrom time to time for as long as I can remember:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times">
<P>Based on code I’ve seen, I’d say that it’s okay to start threads (that call CRT functions) with CreateThread if you are dynamically linking to the CRT. Only when you are statically linking to the CRT do you need to use _beginthreadex. Am I right?<BR><BR>The only documentation I’ve found to support this says:</P>
<BLOCKQUOTE>
<P><EM>If you are going to call C run-time routines from a program built with Libcmt.lib, you must start your threads with the _beginthread or _beginthreadex function. Do not use the Win32 functions ExitThread and CreateThread. …</EM></P></BLOCKQUOTE>
<P>and</P>
<BLOCKQUOTE>
<P><EM>_beginthread and _beginthreadex are similar to the CreateThread function in the Win32 API but has these differences: … They initialize certain C run-time library variables. This is important only if you use the C run-time library in your threads. …</EM></P></BLOCKQUOTE>
<P>That first quote does say that if statically linking to the CRT, you must&nbsp; use _beginthread[ex], but nowhere seems to mention that if you are dynamically linking, it is okay to use CreateThread instead. (I assume the CRT DLL does its initialization in a THREAD_ATTACH notification)</P></FONT></BLOCKQUOTE>
<P mce_keep="true">A whole bunch of experts weighed in with advice to <STRONG>just use CreateThread</STRONG> ane not worry about these docs that are not too clear about the underlying problems they were warning about.</P>
<P mce_keep="true">and in some ways this is understandable, since the rule about giving the <STRONG><EM>there be dragons there!</EM></STRONG> warning is that you have to describe the dragon well enough that people will believe you (if not, then eventually they will remember that dragons are fictional and that there is really no reason to worry....</P>
<P mce_keep="true">Luickily there are some of the wise&nbsp;longtime dragonslayers out there who we can get the real answers that the documentation hints at without really giving the full story, like Alan Chan from the Visual C++ development team:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>Actually, you can use CreateThread (win32) or _beginthread[ex](CRT) for the dynamically linked CRT case.&nbsp; _beginthread() is essentially a wrapper around CreateThread + do some initialization with per-thread data initalization (mostly for locales).&nbsp; However, when dynamically linking, the CRT hooks the Dll_THREAD_ATTACH and do per-thread data initialization there instead.</EM></P></BLOCKQUOTE>
<P mce_keep="true">I was curious about&nbsp;the "mostly for locales" bit,&nbsp;so I asked him for some information, and he filled in some the details:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>I said mostly because the “big thing” we store in our PTD (per-thread data) is locale.&nbsp; However, locales is not the only that we store in PTD.&nbsp; On top of my head, I know there are some per-thread buffers that are stored in the ptd.<BR><BR>Actually, after sending this email and seeing so much stuff in the PTD, it got me thinking why I only seen locale related problems relating to this.&nbsp; I went back and re-checked the code again.&nbsp; The PTD is allocated on first use by _getptd() if it has not been allocated.&nbsp; The only reason why there are locale problems when not&nbsp;using _beginthread vs _createthread is how PTD is initialized.&nbsp; In _beginthread[ex](), the CRT can pass information between the thread spawning the new thread and the thread being created.&nbsp; In the case of _beginthread(), we can copy the ptd-&gt;ptlocinfo and initialize it.&nbsp; However, in the CreateThread case, during DLL_THREAD_ATTACH or first use of PTD, we can’t copy the locinfo from the thread that spawned us.&nbsp; Hence, the CRT copies from a global pointer.&nbsp; This might cause problems when using _ENABLE_PER_THREAD_LOCALE. </EM></P></BLOCKQUOTE>
<P mce_keep="true">Indeed, there are specific&nbsp;potential problems&nbsp;that come up if you use that flag&nbsp;with the dynamic C Runtime, which I'll try to cover another day to show the kinds if problem you can hit in this situation....</P>
<P mce_keep="true">And of course there is remionder that there may well be dragons lurking around these parts from time to time, even if the documentation is not properly scaring us away from the danger zone. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> ⻯ </FONT><EM>and</EM><FONT size=5> ⻰ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/2eef" mce_href="http://www.fileformat.info/info/unicode/char/2eef">U+2eef</A> and <A class="" href="http://www.fileformat.info/info/unicode/char/2ef0" mce_href="http://www.fileformat.info/info/unicode/char/2ef0">U+2ef0</A>, aka CJK RADICAL J-SIMPLIFIED DRAGON and CJK RADICAL C-SIMPLIFIED DRAGON)</EM></FONT></P>
<hr/><p><strong>Mike Dimmick</strong> on 2 Jan 2008 12:10 PM:</p><div style="margin-left: 1em"><p>Don't confuse them with exceptions. Always use _beginthreadex if you're using the C runtime. Theoretically, someone could put something in their own DLL_THREAD_ATTACH handling which relies on the CRT being correctly initialised for the thread, and there could be circumstances where you could manage to get that DLL initialised before the CRT. Don't take the risk.</p>
<p>The only exceptional case is if you're running on Windows CE, where _beginthreadex is not even provided. This is because the C runtime is an integral part of the system (implemented in coredll.dll, which also replaces user32, gdi32, kernel32, advapi32 and a few others) and therefore CreateThread already does the Right Thing to initialise the CRT for the new thread.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 2 Jan 2008 1:53 PM:</p><div style="margin-left: 1em"><p>Even in the DLL case? Anyone doing that will pretty likely find themselves broken, a little or a lot, given the current CW with folks here.</p>
</div>
<p><strong>Anonymous</strong> on 2 Jan 2008 2:31 PM:</p><div style="margin-left: 1em"><p>A very minor thing - the first CJK radical in the &quot;sponsored by&quot; section is U+2EFF (a typo of U+2EEF) and is mapped to a reserved character - so it doesn't show up for anybody.</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/01/02/6951081.html" title="All things being equal, the road on the map is much safer to use">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/01/01/6942010.html" title="But I *am* Michael...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/02/6950506.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>