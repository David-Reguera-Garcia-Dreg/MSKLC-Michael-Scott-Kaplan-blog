<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/02/6951081.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>All things being equal, the road on the map is much safer to use</title></head><body>
<h1>All things being equal, the road on the map is much safer to use</h1>
<p><em>by Michael S. Kaplan, published on 2008/01/02 10:16 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/01/02/6951081.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A while back,&nbsp;Mark-Andre sent me the following message:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">Hi,<BR><BR>I'm a young programmer interested in digging the subject you seem to be a specialist in. I'm currently making a keylogger, just for the fun of it, to see how it can be done (I just want to make clear I have no malicious intentions, otherwise I would have downloaded a complete one from the internet). Here's the current source code I have:<BR><BR></FONT></EM><A href="http://www.planetcpp.info/k.c"><U><FONT color=#0000ff><EM><FONT face="times new roman,times">http://www.planetcpp.info/k.c</FONT></EM></U></FONT></A><BR><BR><EM><FONT face="times new roman,times">The most relevant part of code is the keyLog() function. As you can see, I'm catching key presses with the GetAsyncKeyState() function and then converting them to their corresponding characters with the ToUnicode() function. It works fine, but it does not handle dead keys at all. When I press a dead key, the ToUnicode() function returns 2 instead of -1 (that's not how it should behave according to msdn). While this is not a very important issue for people using English on their computer, it becomes annoying here in Quebec for people using French. There are many accented letters in French that are typed using a dead key, so keylogging without handling them makes the logs harder to read. So far, I'm getting the spacing version of the accent instead. Not _so_ bad.<BR><BR>I've googled a lot about this, but there seem to be no easy solution. I've found that the keyboard layout information is stored in those kbd*.dll. As you said on your blog, these DLLs contain the KbdLayerDescriptor() function. You also said it was defined in kdb.h, available in the Windows DDK. I'm afraid using this function will require admin privileges, right, as it is at the driver level? Also, information about this function seems to lack on msdn.<BR><BR>Basically, all I'm looking for is a way to extract detailed information about the current keyboard layout from those DLLs, so that I can handle the dead keys by myself. Any idea on how I could parse these DLL to get information on how to combine dead keys with keys to get the resulting characters right?<BR><BR>Thanks,<BR><BR>Marc-Andre</FONT></EM></P></BLOCKQUOTE>
<P mce_keep="true">Now the problem here is one that I kind of explained in my series on interrogate keyboard layouts entitled <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/04/13/575500.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/13/575500.html">Getting all you can out of a keyboard layout</A></STRONG> (that link points to the last post in the series, which itself has links to the other parts).</P>
<P mce_keep="true">While it is possible to call the keyboard layout DLLs directly, there are a lot of worries here (such as architectural differences between 64-bit, 32-bit, and WoW64 (which is 32-bit running on 64-bit).</P>
<P mce_keep="true">Mark-Andre was able to get a version of this code working based on the information in kbd.h: </P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">I have made a function to replace (and improve) the ToUnicode() function. It finds the current keyboard layout and its DLL, and then loads it. It uses the information returned by KbdLayerDescriptor in order to get the information related to the keyboard layout and then uses it in order to make the conversion between the keys typed and the wchars that appear. It even supports dead chars, something that ToUnicode() doesn't do (and even messes up).</FONT></EM></P></BLOCKQUOTE>
<P mce_keep="true">He also provided the code he used, which I am not providing here.</P>
<P mce_keep="true">You see, this&nbsp;kind of solution would not work across all of those architectures, so on the whole I kind of prefer to use the code based on the documented functionality in user32.dll rather than the "only documented in a DDK header file" functionality being relied on here -- especially given the changes that have even occasionally happened between versions with kbd.h? They just don't make the same kinds of compatibility guarantees.</P>
<P mce_keep="true">The dead key issue is a problem that is very well-documented, and working with those documented ways is the best way to solve the problem, overall....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> ‚å¶ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/2326" mce_href="http://www.fileformat.info/info/unicode/char/2326">U+2326</A>, aka ERASE TO THE RIGHT, fka DELETE TO THE RIGHT)</EM></FONT></P>
<hr/><p><strong>Mihai</strong> on 3 Jan 2008 5:26 PM:</p><div style="margin-left: 1em"><p>Why hook WM_SYSKEYDOWN, WM_KEYDOWN and not directly WM_CHAR, WM_UNICHAR, WM_IME_CHAR?</p></div>
<p><strong>Michael S. Kaplan</strong> on 3 Jan 2008 7:44 PM:</p><div style="margin-left: 1em"><p>At the driver level, that would be all one has to work with (the character stuff is too late to save things like dead key info)....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/01/03/6965372.html" title="Throwing a BRIC [with Diwali written on it] at Outlook, aka Attn. Outlook: There *is* an &#39;I&#39; in BRIC">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/01/02/6950506.html" title="Here be dragons?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-01-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/01/02/6951081.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>