<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/20/8326152.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>That's no gap, dear; that's a huge freaking chasm!</title></head><body>
<h1>That's no gap, dear; that's a huge freaking chasm!</h1>
<p><em>by Michael S. Kaplan, published on 2008/03/20 09:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/03/20/8326152.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT color=#ff0000><EM><FONT size=1>Content of </FONT></EM><A class="" href="http://blogs.msdn.com/michkap" mce_href="http://blogs.msdn.com/michkap"><EM><FONT size=1>Michael Kaplan's personal blog</FONT></EM></A><EM><FONT size=1> not approved by Microsoft (see <A class="" href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html" mce_href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html"><EM><FONT size=1>disclaimer</FONT></EM></A>)!</FONT></EM></FONT></P>
<P>The other day, Qian asked me via the Contact link:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">Hi Michael,<BR><BR>I've been reading your blog for the past several months and find it really helpful.&nbsp; I've been able to crush several quite puzzling bugs just by reading the archives.&nbsp; Thank you for sharing such valuable knowledge.<BR><BR>I wonder if you can shed some light on a problem I've come across.&nbsp; I've been trying to use the ImmIsIME function to determine if the currently active input language uses an IME.&nbsp; I've got a plain US English XP (32-bit) system with the Simplified Chinese Pinyin IME installed.&nbsp; And in my code I'm doing the following:<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HKL hKeyLayout = GetKeyboardLayout(0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BOOL bIsIME = ImmIsIME(hKeyLayout) != 0;<BR><BR>If I look at the HKL value, I see that I get 0x4090409 for the English layout and 0x8040804 for the Chinese.&nbsp; But I get TRUE for ImmIsIME for both of them.<BR><BR>This didn't seem right to me, so I googled a bit and found this thread:<BR><BR></FONT></EM><A href="http://groups.google.com/group/microsoft.public.win32.programmer.international/browse_thread/thread/6431db45bf81e718/e8111909da418549?hl=en&amp;lnk=st&amp;q=ImmIsIme#e8111909da418549"><EM><FONT face="times new roman,times">http://groups.google.com/group/microsoft.public.win32.programmer.international/browse_thread/thread/6431db45bf81e718/e8111909da418549?hl=en&amp;lnk=st&amp;q=ImmIsIme#e8111909da418549</FONT></EM></A><BR><BR><EM><FONT face="times new roman,times">In it you said,<BR>&nbsp;&nbsp;&nbsp; "All IME's have a 0xE000000 prefix in front of them when you look at the HKL value. You can easily use the GetKeyboardLayout API to retrieve the active keyboard layout and test for whether it has such a prefix in the HKL."<BR><BR>And the OP of the thread indicated that this method worked for him.&nbsp; He was using a Japanese IME on an English XP system, so I installed the Japanese IME and got an HKL value of 0x4110411 for the Japanese layout.&nbsp; Obviously neither the Japanese nor the Chinese HKL on my system had an 0xE000000 prefix, so this test for IME didn't work either.<BR><BR>I haven't been able to find any information on why ImmIsIME would return TRUE for the US English layout.&nbsp; I've also not been able to find any other references to the 0xE000000 prefix.&nbsp; Do you see anything that I'm doing wrong or have any insight into why I'm not getting the expected values here?<BR><BR>I've also tested my code on Vista (32 and 64-bit) with exactly the same results.&nbsp; So if I'm screwing up somewhere, at least I'm doing it consistently. :)<BR><BR>I'd greatly appreciate any pointers you can give me on this.&nbsp; And thanks again for all the great info on your blog.<BR><BR>Best,<BR><BR>Qian</FONT></EM></P></BLOCKQUOTE>
<P>Well, I guess it can't ever hurt to have people say nice things about you, especially when you're feeling under-valued. :-)</P>
<P>In this case the problem is once again that the move from the IMM (Input Method Manager) based to the TSF (Text Services Framework) based IMEs has made an old behavior one could rely on go away forever. :-(</P>
<P>There are now a huge ton of IMEs that do not follow that "E" prefix rule, since their support is entirely through TSF now.</P>
<P>Now if one knows all of the GUIDs and such one could probably use <A class="" href="http://msdn2.microsoft.com/library/ms628571.aspx" mce_href="http://msdn2.microsoft.com/library/ms628571.aspx">ITfInputProcessorProfiles::IsEnabledLanguageProfile</A> to see if the IME in question is enabled, and one could probably use <A class="" href="http://msdn2.microsoft.com/library/ms628556.aspx" mce_href="http://msdn2.microsoft.com/library/ms628556.aspx">ITfInputProcessorProfiles::EnumInputProcessorInfo</A> to&nbsp;enumerate all of the Input Processor Profiles on the machine and look for the one that was desired here.</P>
<P>But the real problem is not answering this one particular question.</P>
<P>It is that there is no link in documentation between the <A class="" href="http://msdn2.microsoft.com/library/ms776145.aspx" mce_href="http://msdn2.microsoft.com/library/ms776145.aspx">Input Method Manager</A> and the <A class="" href="http://msdn2.microsoft.com/library/ms629032.aspx" mce_href="http://msdn2.microsoft.com/library/ms629032.aspx">Text Services Framework</A>. </P>
<P>Not even a notice to developers that lots of the IMM won't work anymore.</P>
<P>Let alone a huge map&nbsp;akin to&nbsp;the <A class="" href="http://msdn2.microsoft.com/library/aa302340.aspx" mce_href="http://msdn2.microsoft.com/library/aa302340.aspx">Microsoft Win32 to Microsoft .NET Framework API Map</A> that I mentioned <A class="" href="http://archives.miloush.net/michkap/archive/2005/02/23/379320.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/23/379320.html"><STRONG>here</STRONG></A> and suggested corrections to <A class="" href="http://archives.miloush.net/michkap/archive/2005/02/27/381189.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/27/381189.html"><STRONG>here</STRONG></A>.</P>
<P>Let alone what would best of all, which would be a little link in each <A class="" href="http://msdn2.microsoft.com/library/ms776145.aspx" mce_href="http://msdn2.microsoft.com/library/ms776145.aspx">Input Method Manager</A> topic that provided the best way to accomplish the same thing in the <A class="" href="http://msdn2.microsoft.com/library/ms629032.aspx" mce_href="http://msdn2.microsoft.com/library/ms629032.aspx">Text Services Framework</A>.</P>
<P>People over here talk all the time about <STRONG>gaps in international support</STRONG>, but calling this lack of information not only in how to migrate but in the fact that migration is needed is a lot more than a gap. It's a huge chasm!</P>
<P>And this problem is not one you can just aim a doc writer at -- not even a doc writer ninja or doc writer ninja II. This requires&nbsp;developers and testers, people&nbsp;who actually know the answers to the questions here and who know enough about the IMM "wrappers" put in for compatibility that they could even find and perhaps fix bugs in the current backcompat work that happens.</P>
<P>There is an old story about the four friends -- Everybody, Anybody, Nobody and Somebody. There was an important job to be done and Everybody was sure that Somebody would do it. In truth, Anybody could have done it, but Nobody did it. Somebody got angry about that because it was Anybody's job and the fact that Nobody did it was incredibly irresponsible (something that Everybody knew). In the end, Nobody did the work and Everybody got blamed for not taking responsibility.</P>
<P>I just wonder how long these four friends are going to rule the IMM/TSF documentation situation?</P>
<P><EM>I don't want to minimize the importance of this prolem with humor, and to be honest I wish more developers around the world and especially in East Asia would complain about this more loudly and force Microsoft to do something about it. The lack of assistance here is unpardonable considering the sizes of the markets affected....</EM></P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This&nbsp;blog brought to you by</EM><FONT size=5> ê‡¥ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/a1e5" mce_href="http://www.fileformat.info/info/unicode/char/a1e5">U+a1e5</A>, aka YI SYLLABLE GAP)</EM></FONT></P>
<hr/><p><strong>Qian</strong> on 20 Mar 2008 11:23 AM:</p><div style="margin-left: 1em"><p>Michael, thank you for replying to my message. &nbsp;I had figured out that the problem was caused by the IMM/TSF transition little while back after rereading some of the IME releated posts that you made before. &nbsp;Another score for the archives. &nbsp;But I'll definitely check out IsEnabledLanguageProfile and see if that'll do the trick. &nbsp;When I last looked at the TSF docs, my feeling was that it was too much trouble to go through to accomplish what I wanted (the feature's not a must have). &nbsp;Also, since TSF may not be installed on Win2000, I'd still need the IMM code as well. &nbsp;Like you said, there's definitely a chasm in the documentation. &nbsp;I'm just glad I have to option of punting the problem for now.</p></div>
<p><strong>Ankur Mohan</strong> on 7 Apr 2008 6:38 PM:</p><div style="margin-left: 1em"><P>Hello Michael,</P>
<P>your posts on IME/Keyboard related stuff have been extremely useful for me as well. I'm working on implementing our own IME UI for windows XP and Vista. This requires obtaining information from Windows about the contents of different IME windows (reading window, candidate window etc) and then displaying them properly using our rendering pipeline. </P>
<P>I've used IMM for implementing IME on Windows XP and TSF for Vista. However, after installing Office 2007 and all the Language packs for it (which replace some of the existing IME's), I find that the new IME's are hopelessly broken- as in, some of the important information such as candidate list contents is never sent. The behaviour of these IME's also seem suspiciosly similar to Vista IME's, which makes me thing that I should use TSF with these newer IME's. However, I haven't been able to use TSF successfully on XP- specifically, a pointer to ThreadManagerEx interface that's needed for IME implementation using TSF can't be obtained on XP- QI'ng the ThreadManager for IID_ITfThreadMgrEx always returns No_Interface..</P>
<P>Documentation for ThreadManagerEx says that it's implemented on XP..any ideas?</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/12/04 <a href="http://archives.miloush.net/michkap/archive/2008/12/04/9173920.html">ImmGetDescription: another casualty of the IMM to TSF migration</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/03/20/8327043.html" title="I cannot underscore that ampersand enough">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/03/19/8323216.html" title="The forensic typographers found no link to Lucida Console, and the D.A. had nothing to fallback to">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03-20">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/20/8326152.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>