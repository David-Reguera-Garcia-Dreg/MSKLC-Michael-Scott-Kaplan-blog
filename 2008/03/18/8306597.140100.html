<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/18/8306597.140100.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Conventional wisdom is retarded, aka What the @#%&* is _O_U16TEXT?</title></head><body>
<h1>Conventional wisdom is retarded, aka What the @#%&* is _O_U16TEXT?</h1>
<p><em>by Michael S. Kaplan, published on 2008/03/18 14:01 +00:00, original URI: http://blogs.msdn.com/michkap/archive/2008/03/18/8306597.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostGoogleFeed -->
<p><font color="#ff0000" size="1"><em>Please read </em></font><a href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html"><em><font size="1">disclaimer</font></em></a><em><font color="#ff0000" size="1">; content of <a href="http://blogs.msdn.com/michkap">Michael Kaplan's blog</a> not approved by Microsoft!</font></em></p>
<p>Once upon a time, <strong>everybody knew</strong> that the Earth was flat.</p>
<p>And not too long after that, <strong>everybbody knew</strong> that the Sun orbited around the Earth instead of the other way around.</p>
<p>And most developers <strong>know</strong> that there is no way to get Unicode output support in the console that will work properly both in the console and when redirected to a file.</p>
<p>I was just looking at some internal guidelines for developers inside of Microsoft that bemoaned all the things that don't work in the console:</p>
<blockquote>
<p><font face="Verdana">The main limitations can be summarized as:</font></p>
<ol style="MARGIN-TOP:0in;MARGIN-BOTTOM:0in">
<li><em style="FONT-STYLE:normal"><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">Unicode I/O with ReadConsoleW/WriteConsoleW is always supported; but default raster font will break it. </span></em>
<li><em style="FONT-STYLE:normal"><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">Changing console codepage is always possible, but DBCS codepages are supported under DBCS system locales (not necessarily matching).</span></em> 
<li><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">The console does not support </span><strong style="FONT-WEIGHT:400"><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">complex script </span></strong><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">languages such as Arabic or the various Indic languages that can only be rendered with Uniscribe. </span> 
<li><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">Unicode I/O is supported through Win32, but with several limitations: </span></li>
<ul>
<li><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">a user has to select a truetype font in console; </span></li>
<li><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">no redirection of input/output is supported; </span></li>
<li><span style="FONT-SIZE:10pt;FONT-FAMILY:Verdana">CJK languages are supported only under CJK system locales.</span> </li></ul></li></li></li></ol></blockquote>
<p>Now of these caveats that <strong>everybody knows</strong>, most of them are <em>not true</em>!</p>
<p>And not too long ago someone sent me a piece of mail about that second sub-bullet in #4 and the code he wrote to work around it:</p>
<blockquote><font face="Times New Roman,Times">
<p><em>I think I’m mostly ready. However, I’m still not quite certain about proper handling of redirection of output to a file. The site above suggests the option of using WriteConsole for normal output, and WriteFile+BOM for file output; this is the direction I’ve tried, but I wanted to get confirmation that I’m doing it correctly.<br><br>I’ve written the following function (mostly copied from other code):</em></p>
<blockquote>
<blockquote><font face="Consolas,Lucida Console,Courier New,Courier,fixed,Fixed"><b>
<p>static const WCHAR UNICODE_BOM = 0xFEFF;<br><br>void UPrint (LPCWSTR String) {<br>    DWORD ConsoleMode;<br>    BOOL ConsoleOutput;<br>    DWORD FileType;<br>    BOOL Result;<br>    HANDLE StdOut;<br>    DWORD StringCharCount;<br>    DWORD Written;<br><br>    //<br>    // StdOut describes the standard output device.  This can be the console<br>    // or (if output has been redirected) a file or some other device type.<br>    //<br>    StdOut = GetStdHandle(STD_OUTPUT_HANDLE);<br><br>    if (StdOut == INVALID_HANDLE_VALUE) {<br>        goto PrintExit;<br>    }<br><br>    //<br>    // Check whether the handle describes a character device.  If it does, then<br>    // it may be a console device.  A call to GetConsoleMode will fail with<br>    // ERROR_INVALID_HANDLE if it is not a console device.<br>    //<br>    FileType = GetFileType(StdOut);<br><br>    if ((FileType == FILE_TYPE_UNKNOWN) &amp;&amp; (GetLastError() != ERROR_SUCCESS)) {<br>        goto PrintExit;<br>    }<br><br>    FileType &amp;= ~(FILE_TYPE_REMOTE);<br><br>    if (FileType == FILE_TYPE_CHAR) {<br>        Result = GetConsoleMode(StdOut, &amp;ConsoleMode);<br><br>        if ((Result == FALSE) &amp;&amp; (GetLastError() == ERROR_INVALID_HANDLE)) {<br>            ConsoleOutput = FALSE;<br>        } else {<br>            ConsoleOutput = TRUE;<br>        }<br>    } else {<br>        ConsoleOutput = FALSE;<br>    }<br><br>    //<br>    // If StdOut is a console device then just use the UNICODE console write<br>    // API.  This API doesn&#39;t work if StdOut has been redirected to a file or<br>    // some other device.  In this case, write to StdOut using WriteFile.<br>    //<br><br>    StringCharCount = (DWORD) wcslen(String);<br><br>    if (ConsoleOutput != FALSE) {<br>        WriteConsoleW(StdOut,<br>                      (PVOID)String,<br>                      StringCharCount,<br>                      &amp;Written,<br>                      NULL);<br>    } else {<br>        //<br>        // Write out a Unicode BOM to ensure proper processing by text readers<br>        //<br>        WriteFile(StdOut,<br>                  (PVOID)&amp;UNICODE_BOM,<br>                  sizeof(UNICODE_BOM),<br>                  &amp;Written,<br>                  NULL);<br><br>        //<br>        // The number of bytes to write to standard output must exclude the null<br>        // terminating character.<br>        //<br>        WriteFile(StdOut,<br>                  (PVOID)String,<br>                  (StringCharCount * sizeof(WCHAR)),<br>                  &amp;Written,<br>                  NULL);<br>    }<br><br>PrintExit:<br>    return;<br>}</p></b></font></blockquote></blockquote>
<p><em>Based on a couple quick tests, this seems to do the right thing, but review from someone more familiar with the area would be much appreciated. :-)<br><br>Thanks!</em></p></font></blockquote>
<p>Well, at the time the only comment he had gotten back was that that it was a little odd that the BOM was being written on every call since it should only be in the beginning of the file.</p>
<p>Anyway, remember the other day when I was mentioned in <a href="http://archives.miloush.net/michkap/archive/2008/03/07/8086758.html"><strong>Some armchair root cause analysis of the suckage of lstrcmpi</strong></a> how I mentioned that <a href="http://nuwen.net/stl.html">STL</a> dropped by and we were talking about stuff?</p>
<p>One of the things I mentioned was this problem, and related ones like how you had to use binary mode to write out Unicode text with the CRT functions, thus losing all of the newline and line semantics. He agreed this was lame.</p>
<p>Then last night he showed me how both Visual Studio 2005 and 2008 (well, Vissual C++ 8.0 and 9.0) that it was not true!</p>
<p>Basically he created a file something like this:</p>
<blockquote><font face="Consolas,Lucida Console,Courier New,Courier,fixed,Fixed"><b>
<p>#include &lt;fcntl.h&gt;<br>#include &lt;io.h&gt;<br>#include &lt;stdio.h&gt;<br><br>int main(void) {<br>    _setmode(_fileno(stdout), _O_U16TEXT);<br>    wprintf(L&quot;\x043a\x043e\x0448\x043a\x0430 \x65e5\x672c\x56fd\n&quot;);<br>    return 0;<br>}</p></b></font></blockquote>
<p>And then I compiled the file in the Visual Studio 2005 command line (where I already had my console font set to Lucida Console):</p>
<blockquote><font face="Consolas,Lucida Console,Courier New,Courier,fixed,Fixed"><b>
<p>cl /W4 foo.c</p></b></font></blockquote>
<p>And that FOO.EXE worked beautifully, outputting the Cyrillic and Ideograhic text (<strong>кошка 日本国</strong>) without corruption, to the command line....</p>
<p>And when I redirected it to a file, it worked then too, writing out the file as Unicode!</p>
<p><img src="http://trigeminal.fmsinc.com/images/unicodeconsole01.png"></p>
<p>Notepad opened it fine and detected it as Unicode even without the BOM; I did have to save it in Notepad to have the console see it that way when I used the <strong>type</strong> command in the console.</p>
<p>Here was that console window:</p>
<p><img src="http://trigeminal.fmsinc.com/images/unicodeconsole02.png"></p>
<p><em>When I copied those boxes from the console and pasted them into Notepad, I once again got the Unicode text both times.</em></p>
<p>So much for conventional wisdom. All that WriteConsoleW blitting, the binary file mode, the chcp, the console output CP crap. All to get an answer not as cool as the above.</p>
<p>The earth? It isn't flat.</p>
<p>The sun? It doesn't orbit around the sun.</p>
<p>And the CRT? Starting in 2005/8.0, it knows more about Unicode than any of us having been giving it credit for....</p>
<p>The heroes of the day? <strong>_O_U16TEXT</strong> and <strong>_O_U8TEXT</strong>, which I will probably talk about more at some point.</p>
<p>Or you can look at the <a href="http://msdn2.microsoft.com/library/tw4k6df8(VS.80).aspx">_setmode</a> and <a href="http://msdn2.microsoft.com/library/w7sa2b22(vs.80).aspx">_wsopen</a> topics (the latter is the only place that <strong>_O_U16TEXT</strong> and <strong>_O_U8TEXT</strong> seem to be mentioned:</p>
<blockquote>
<p><em><strong>_O_U16TEXT</strong> <br>Open the file in Unicode UTF-16 mode. This option is available in Visual C++ 2005.<br><br><strong>_O_U8TEXT </strong><br>Open the file in Unicode UTF-8 mode. This option is available in Visual C++ 2005.<br><br><strong>_O_WTEXT </strong><br>Open the file in Unicode mode. This option is available in Visual C++ 2005. </em></p></blockquote>
<p>But it works right here too.</p>
<p>Awesome, truly.</p>
<p>And conventional wisdom is quite retarded!</p>
<p> </p>
<p><font color="#ff00ff"><em>This post brought to you by</em><font size="5"> U </font><em>(<a href="http://www.fileformat.info/info/unicode/char/0055">U+0055</a>, aka LATIN CAPITAL LETTER U)</em></font></p>
<hr/><div style="margin-left: 1em"><em>comments not archived</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/12/01 <a href="http://archives.miloush.net/michkap/archive/2010/12/01/10098812.html">The IN door can go a different way than the OUT door</a></p><p>2010/10/07 <a href="http://archives.miloush.net/michkap/archive/2010/10/07/10072032.html">Myth busting in the console</a></p><p>2010/09/23 <a href="http://archives.miloush.net/michkap/archive/2010/09/23/10066660.html">A confluence of circumstances leaves a stone unturned...</a></p><p>2010/06/27 <a href="http://archives.miloush.net/michkap/archive/2010/06/27/10028282.html">Bugs hidden in plain sight, and commented that way too ANSWERS</a></p><p>2010/06/18 <a href="http://archives.miloush.net/michkap/archive/2010/06/18/10024976.html">Bugs hidden in plain sight, and commented that way too</a></p><p>2010/05/07 <a href="http://archives.miloush.net/michkap/archive/2010/05/07/10008232.html">Cunningly conquering communicated console caveats. Comprende, mon Capitán?</a></p><p>2010/04/07 <a href="http://archives.miloush.net/michkap/archive/2010/04/07/9989346.html">Anyone who says the console can't do Unicode isn't as smart as they think they are</a></p><p>2009/12/01 <a href="http://archives.miloush.net/michkap/archive/2009/12/01/9930855.html">When changing behavior is like killing puppies</a></p><p>2009/08/14 <a href="http://archives.miloush.net/michkap/archive/2009/08/14/9869928.html">Header files are not retarded, aka What the @#%&* is _O_WTEXT?</a></p><p>2008/03/19 <a href="http://archives.miloush.net/michkap/archive/2008/03/19/8323216.html">The forensic typographers found no link to Lucida Console, and the D.A. had nothing to fallback to</a></p><p>2008/03/19 <a href="http://archives.miloush.net/michkap/archive/2008/03/19/8321717.html">Before you say "What's next?" you have to figure out the action items</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/03/18/8306597.html" title="Conventional wisdom is retarded, aka What the @#%&amp;* is _O_U16TEXT?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/03/18/8301435.html" title="M&amp;Ms -- they melt in your mouth, but what about in your cat?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/18/8306597.140100.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>