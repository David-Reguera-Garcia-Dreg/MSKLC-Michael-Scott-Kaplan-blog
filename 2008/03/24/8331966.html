<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/24/8331966.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Unicode not being the default is slower and leads to bugs; maybe it ought to change?</title></head><body>
<h1>Unicode not being the default is slower and leads to bugs; maybe it ought to change?</h1>
<p><em>by Michael S. Kaplan, published on 2008/03/24 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/03/24/8331966.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM><FONT color=#ff0000 size=1>Content of </FONT></EM><A class="" href="http://blogs.msdn.com/michkap" mce_href="http://blogs.msdn.com/michkap"><EM><FONT size=1>Michael Kaplan's personal blog</FONT></EM></A><EM><FONT color=#ff0000 size=1> not approved by Microsoft (see </FONT></EM><A class="" href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html" mce_href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html"><EM><FONT size=1>disclaimer</FONT></EM></A><EM><FONT color=#ff0000 size=1>)!</FONT></EM>&nbsp;</P>
<P>Meanwhile over in the microsoft.public.dotnet.internationalization newsgroup, don rau asked:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>I am trying to load a Korean string resource from a DLL. <BR><BR>I use LoadStringW after setting Thread.CurrentThread.CurrentCulture to&nbsp;Korean.&nbsp; <BR><BR>The string I'm trying to receive should be comprised of the following 5 characters:<BR>0xc6a9 0xc9c0 0x002f 0xd488 0xc9c8<BR><BR>however what I get is:<BR>0x00a9 0x00c6 0x00c0 0x00c9 0x002f<BR><BR>Note the relationship between what I expected and what I received.<BR><BR>Anyone have ideas on what I'm doing wrong?</EM></FONT></P></BLOCKQUOTE>
<P>You might be able to see the pattern and know what is going on already. You might incorrectly be reminded of <A class="" href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html" mce_href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html"><STRONG>Behind 'How to Break Windows Notepad'</STRONG></A> but that isn't it since there is no guessing going on here....</P>
<P>They wanted "<STRONG>용지/품질</STRONG>" and they got "<STRONG>©ÆÀÉ/</STRONG>" instead!</P>
<P>Regular reader Mihai had the answer for don rau:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Thread.CurrentThread.CurrentCulture should not affect the result.<BR>Most likely you declared that LoadStringW uses ANSI strings.<BR>Take a look at [MarshalAs(UnmanagedType.LPWStr)]</FONT></P></BLOCKQUOTE>
<P>That is one way to do it; the other way is to use something like the following p/invoke signature:</P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,courier new,courier"><STRONG>[DllImport("user32.dll", CharSet=CharSet.Unicode, EntryPoint="LoadStringW", ExactSpelling=true)]<BR>static extern int LoadString(IntPtr hInstance, uint uID, StringBuilder lpBuffer, int nBufferMax);</STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Then you can let the .NET Framework do all the marshaling for you (I always prefer explicit entry points and exact spellings to save the real problems associated with the weird guessing that .NET does as part of its effort to be <A class="" href="http://archives.miloush.net/michkap/archive/2006/11/20/1112734.html" mce_href="http://archives.miloush.net/michkap/archive/2006/11/20/1112734.html"><STRONG>Putting the *backward* in backward compatibility</STRONG></A> and choosing a terrible CharSet default....</P>
<P mce_keep="true">Which leads me to wonder, actually. If Visual Studio can default new C++ projects to Unicode (as they now do, ref: <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/02/476213.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/02/476213.html"><STRONG>The Unicode train is leaving the station</STRONG></A>), why couldn't they change the default for new projects to use CharSet.Unicode and all of the related behaviors in a new version of .Net?</P>
<P mce_keep="true">All they would need to do is add a new project level property for the "Default CharSet value to use" -- if it is not specified (like all pre-existing projects would be), then use CharSet.Ansi. And then have all of the new projects for the next version default to set that new property to CharSet.Unicode. And that's all you need to move everyone over to using Unicode.</P>
<P mce_keep="true"><A class="" href="http://blogs.msdn.com/kimhamil/" mce_href="http://blogs.msdn.com/kimhamil/">Kim</A>, are you reading this? Maybe you could help push this where it needs to go over there,&nbsp;I'll buy lunch if you will! :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=5> U </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0055" mce_href="http://www.fileformat.info/info/unicode/char/0055">U+0055</A>, aka LATIN CAPITAL LETTER U)</EM></FONT></P>
<hr/><p><a id="8334629" href="#8334629">#</a> <strong>Mike Dimmick</strong> on 24 Mar 2008 8:53 PM:</p><div style="margin-left: 1em"><p>My god! Something that Compact Framework got right!</p>
<p>(CharSet.ANSI is not in .NET Compact Framework's vocabulary. Something about there not being any ANSI version of the APIs to call might have had something to do with this choice...)</p></div>
<p><a id="8334813" href="#8334813">#</a> <strong>Michael S. Kaplan</strong> on 24 Mar 2008 10:45 PM:</p><div style="margin-left: 1em"><p>I suspect that may be the reason. :-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/03/24/8332674.html" title="Overheard, yet again">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/03/23/8332017.html" title="The ballad of Hope Sandoval?, aka Where are The Warm Inventions when you need &#39;em?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/24/8331966.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>