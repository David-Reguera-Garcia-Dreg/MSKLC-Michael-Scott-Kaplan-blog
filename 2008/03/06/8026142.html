<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/06/8026142.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Getting the IME name (for someone who speaks Chinese, based on code from an article written in Chinese, when you don't speak Chinese)</title></head><body>
<h1>Getting the IME name (for someone who speaks Chinese, based on code from an article written in Chinese, when you don't speak Chinese)</h1>
<p><em>by Michael S. Kaplan, published on 2008/03/06 10:16 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/03/06/8026142.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT color=#ff0000 size=1><EM>Please read the </EM></FONT><A class="" href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html" mce_href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html"><EM><FONT size=1>disclaimer</FONT></EM></A><EM><FONT color=#ff0000 size=1>; content not approved by Microsoft!</FONT></EM></P>
<P>The other day I heard from programmer Scawen Roberts via the Contact link over a couple of days. His question was:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Thank you for your "random stuff of dubious value" which has helped me here and there recently as I've been updating LFS to support Chinese, Japanese and Korean.&nbsp; I have found the IMM / IME documentation and internet references a bit more sparse than most things but eventually managed to get over most hurdles.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>It's nearly there but a tester in China has come across one Vista issue that I cannot find the answer to.&nbsp; It's about showing the name of the active input method (important as LFS usually runs in full screen mode).&nbsp; At the moment I can show the IME name in XP but not in Vista.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>As you know, when the user presses CTRL+SHIFT (having pressed ALT+SHIFT to select Simplified Chinese) the active input method is changed (US Keyboard / ZhengMa / Microsoft PinYin etc...).<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>In XP I am able to retrieve the name of the active input method using a little code something like this :<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>char k_layout(KL_NAMELENGTH);<BR>GetKeyboardLayoutName(k_layout);<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>Then I look up the k_layout entry with a registry lookup in SYSTEM\CurrentControlSet\Control\Keyboard Layouts\[k_layout] and Query the value "Layout Text".<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>This works great in Windows XP, LFS then displays the retrieved value in its text entry dialog and the user can see the active input method.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>The problem : In Vista, the Simplified Chinese input methods have been unified into a single IME and the GetKeyboardLayoutName function always returns the same value regardless of which input method the user has selected.&nbsp; So the registry lookup always returns "Chinese (Simplified) - US Keyboard" regardless of which input method is selected.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>All I want to do is display "ZhengMa / Pinyin / NeiMa" or whatever when it is selected.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>Well... I hope that is an interesting problem in some way and perhaps you'll be able to point me in the right direction.<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>Thanks for your help!<BR><BR></EM></FONT><FONT face="times new roman,times"><EM>Scawen</EM></FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P>And then the message a few days later:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Just following up an email I sent to you the other day, I've made a post on our forum asking any of our community programmers if any of them might just know how to solve this issue of how to display the name of the active input method when using the new "unified" Chinese IME in Windows Vista.&nbsp; I wrote a tiny Windows program which demonstrates the issue by working correctly in XP but not in Vista.<BR><BR></FONT><A href="http://www.lfsforum.net/showthread.php?t=39845"><FONT face="times new roman,times">http://www.lfsforum.net/showthread.php?t=39845</FONT></A><BR><BR><FONT face="times new roman,times">Anyway any help would be much appreciated, or if you could let me know who I should contact.&nbsp; I'm starting to get the feeling this might have been a design oversight in Vista.<BR><BR></FONT><FONT face="times new roman,times">Thanks, Scawen</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P>Technically, it might be worth it to look into the information in <A class="" href="http://archives.miloush.net/michkap/archive/2006/05/06/591174.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/06/591174.html"><STRONG>Getting the real (localized) name of the keyboard</STRONG></A> rather than using the <STRONG>Layout Text</STRONG> registry value directly, but that won't help for this problem either so I'll just leave that mention in passing for Scawen to consider. :-)</P>
<P><EM>Plus I feel like that blog post is one that I should get more mileage out of, since to this day it has remained the most popular spam target for reasons still never identified!</EM></P>
<P>But to answer&nbsp;Scawen's question, this is not an oversight in Vista, no.</P>
<P>Though it is a part of the design change to move fully into the world of the <A class="" href="http://msdn2.microsoft.com/library/ms629032.aspx" mce_href="http://msdn2.microsoft.com/library/ms629032.aspx">Text Services Framework</A>.</P>
<P>As I explained in <A class="" href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html"><STRONG>Cutting the cord while someone else is shoring it up</STRONG></A>, with the exception of the three input methods that Office 97 "adds back" to that legacy list for programs that do not use TSF, the IMEs that have moved on have in fact moved on and the only way to query them for information is through <A class="" href="http://msdn2.microsoft.com/library/ms629037.aspx" mce_href="http://msdn2.microsoft.com/library/ms629037.aspx">the interfaces of the Test Services Framework</A>.</P>
<P>In this particular case the <A class="" href="http://msdn2.microsoft.com/library/ms538196.aspx" mce_href="http://msdn2.microsoft.com/library/ms538196.aspx">IEnumTfLanguageProfiles interface</A> holds the most hope, I suppose, which gets you a bunch of <A class="" href="http://msdn2.microsoft.com/library/ms629075.aspx" mce_href="http://msdn2.microsoft.com/library/ms629075.aspx">TF_LANGUAGEPROFILE structs</A>. </P>
<P>From there? I don't really know -- something with </P>
<UL>
<LI>TF_LANGUAGEPROFILE-&gt;clsid</LI>
<LI>TF_LANGUAGEPROFILE-&gt;langid</LI>
<LI>TF_LANGUAGEPROFILE-&gt;guidProfile</LI></UL>
<P>I suppose, to query information from the text service itself to get the actual name somehow?</P>
<P>Maybe the <A class="" href="http://msdn2.microsoft.com/library/ms538984.aspx" mce_href="http://msdn2.microsoft.com/library/ms538984.aspx">ITfInputProcessorProfiles interface</A> is the one with the information? </P>
<P>It's <A class="" href="http://msdn2.microsoft.com/library/ms628568.aspx" mce_href="http://msdn2.microsoft.com/library/ms628568.aspx">ITfInputProcessorProfiles::GetLanguageProfileDescription method</A> looks the most hopeful, especially since it takes an rclsid, a langid, and a guidProfile, and returns a "description string" as a BSTR.</P>
<P>Yes, I know -- a <A class="" href="http://archives.miloush.net/michkap/archive/2006/08/26/725670.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/26/725670.html"><STRONG>TSF sample</STRONG></A> would still be a really good idea for this kind of thing. It is just difficult to start jumping in here, I think. Not to mention how 90's COM interfaces feel -- almost like a foreign language that one spoke in one's youth? :-)</P>
<P>The closest I have seen for this kind&nbsp;of thing is in&nbsp;an article from last year, entitled <A class="" href="http://www.microsoft.com/taiwan/msdn/columns/huang_jhong_cheng/vista.htm" mce_href="http://www.microsoft.com/taiwan/msdn/columns/huang_jhong_cheng/vista.htm">Vista 與輸入法程式介面</A> (There's no English translation of the article, and my&nbsp;Mandarin is far less than stellar; the online translation sites suggest something like "Vista programming interface and input method" and that sound reasonable enough). </P>
<P>The code there includes perhaps enough hints to get one started even if you too don't speak the language? :-)</P>
<P><EM>The irony involved with answering the question to a developer from a software company helping their customer in China with this article is not completely lost on me, but let's ignore that and focus on the potential coolness of the solution!</EM></P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=5> པ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0f54" mce_href="http://www.fileformat.info/info/unicode/char/0f54">U+0f54</A>, aka TIBETAN LETTER PA)</EM></FONT></P>
<hr/><p><a id="8526850" href="#8526850">#</a> <strong>Arthur Hsu</strong> on 21 May 2008 3:10 AM:</p><div style="margin-left: 1em"><P>The article entitled "Vista 與輸入法程式介面" should be translated as "How to programatically select input methods under Vista"</P>
<P>The code basically provides C# wrapper for .Net 1.0/2.0/3.0. &nbsp;I've heard that .Net 3.5 provide equivalent support in CLR directly, but I did not really test it.</P>
<P>BTW, the sample code links for TSF on MSDN (links provided in <A class="" href="http://msdn.microsoft.com/library/ms629032.aspx">this page</A>&nbsp;are all dead. &nbsp;Did you know where can we find them?</P>
<P><EM><FONT color=#ff0000>I have inquired of the PSDK owners and they are looking into getting the dead link issue fixed... - Michael</FONT></EM></P></div>
<p><strong>june</strong> on 15 Aug 2011 7:55 PM:</p><div style="margin-left: 1em"><p>hi,i am chinese.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/03/07/7994143.html" title="Requirements first, criticism of attempted solutions second!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/03/06/8004266.html" title="As Forrest Gump used to [sorta] say, &quot;Smarmy is as Smarmy Does.&quot;">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-03-06">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/03/06/8026142.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>