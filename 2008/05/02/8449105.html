<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/05/02/8449105.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>That non-character can be the BOM at the right kind of party</title></head><body>
<h1>That non-character can be the BOM at the right kind of party</h1>
<p><em>by Michael S. Kaplan, published on 2008/05/02 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/05/02/8449105.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The question from Vikash was:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hi,<BR><BR>I am using CreateFile API to generate a Unicode file <BR><BR>I have added the Unicode flags in my sources file and the file that is generated is also in Unicode format except for the first two bytes which do not have 0xFEFF<BR><BR>However if I save the file as Unicode then these two bytes get added to it.<BR><BR>I am creating the file with the following attributes:</EM></FONT></P>
<P><FONT face="courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hFile = CreateFile(L"D:\\AddinConfig.Addin",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERIC_WRITE,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_SHARE_READ|FILE_SHARE_WRITE,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CREATE_ALWAYS,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NULL);</STRONG></FONT></P>
<P><FONT face="times new roman,times"><EM>How can I generate a Unicode file with the first two bytes as 0xFEFF?<BR><BR>Thanks in advance,<BR>Vikash</EM></FONT></P></BLOCKQUOTE>
<P>There it is, the good old <A class="" href="http://www.fileformat.info/info/unicode/char/feff" mce_href="http://www.fileformat.info/info/unicode/char/feff">U+feff</A>, aka ZERO WIDTH NO-BREAK SPACE, aka the BYTE ORDER MARK.</P>
<P>The semantics of file creation in Win32 don't ever add the BOM automatically -- the person writing data out to the file had to add the character on their own.</P>
<P>Though it is probably a good idea to add it as a WCHAR directly, and not as bytes -- that way whatever endian-ness you are using will be the way that it is automatically written out. </P>
<P>Because if you have 0xfeff in a USHORT or a WCHAR on Windows (a little endian shop), when you write it out what actually gets written is a byte reversed&nbsp;0xff 0xfe -- the little end first. So writing pure bytes out might put in a&nbsp;big endian BOM if you blindly write out bytes....</P>
<P>But in the end, the BOM is not always required for a Unicode file. It is fine to add one if you want and if you have a detection requirement or cross-platform needs then it might make sense. But it is optional to do.</P>
<P>Now in .NET this is much more a part of the platform, with the option for BOM-writing as part of Unicode file creation available directly, and interestingly the big-endian vs. little-endian issues are much less theoretical there given the conceptual and potential cross-platformishness of the .Net Framework. The lack of this support in Win32 may yet be a cause for grief for people.</P>
<P>I suspect if I knew less about this stuff I'd get invited to parties that are more fun. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This blog brought to you by <A class="" href="http://www.fileformat.info/info/unicode/char/fffe" mce_href="http://www.fileformat.info/info/unicode/char/fffe">U+fffe</A>, a non-character.</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/05/02/8449317.html" title="More things that don&#39;t work for locales in the CRT">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/05/01/8446501.html" title="Was last night Walpurgis [Night|Eve] or May Day Eve?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-05-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/05/02/8449105.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>