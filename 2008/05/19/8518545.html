<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/05/19/8518545.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Everyone seems averse to the BOM these days; Should we blame TSA? :-)</title></head><body>
<h1>Everyone seems averse to the BOM these days; Should we blame TSA? :-)</h1>
<p><em>by Michael S. Kaplan, published on 2008/05/19 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/05/19/8518545.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Sometimes things work by accident.</P>
<P>You know -- no one ever planned for it to work, no one tested it to make sure it kept working. Of course it was never documented; the people behind the scenes may not have even known the feature <STRONG>ever</STRONG> worked the way&nbsp;some people&nbsp;were using it.</P>
<P>It&nbsp;can go on for a long time, that kind of unintentional enablement of a scenario.</P>
<P>Of course, people relying on the undocumented, or more importantly the unintended, have one thing they have to worry about.</P>
<P>They are living on borrowed time.</P>
<P>Because one day a security problem might be detected that this feature is based on. Or one day an actual intended feature may break compatibility with this feature that never made it on the official, documented, supported, and <STRONG>intended</STRONG> radar.</P>
<P>This blog is about such an "unintended feature".</P>
<P>The other day, in response to my <A class="" href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html"><STRONG>The new complier error C4819</STRONG></A>&nbsp;blog from years ago that discussed a new compiler error intended to flush out bugs with inappropriately encoded source files (a longtime problem when developers moved projects between different system locales)&nbsp;Vladislav Vaintroub&nbsp;<A class="" href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html#8464049" mce_href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html#8464049">commented</A>:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Too much i18n does not seem good for the compiler.<BR><BR>Michael, by all respect I cannot share your view on this "incredibly cool" feature. I think it is incredibly uncool.<BR><BR>The bad thing about this warning &nbsp;can result to an error like here<BR><BR></FONT><A href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=341454" target=_new rel=nofollow><FONT face="times new roman,times">http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=341454</FONT></A><FONT face="times new roman,times"> <BR><BR>is that : C strings, &nbsp;the null terminated arrays of bytes, do not have any encoding information per se, i.e are supposed to be treated as opaque arrays of bytes. Now, I have a perfectly valid C file, containing ASCII-only, except for UTF8 bytes instrings (UTF8 for a good reason, I intend to edit this file in UTF-8 editor). And such a file will break with incomprehensible message on Whidbey on Japanese Windows now <BR><BR>The connect bug is now resolved with Won't Fix, so I can not even hope that this will be fixed with the next version of the compiler.<BR><BR>Alternatives for me?<BR>1)Documentation and support says &nbsp;- add a BOM to the file.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <EM>No way, then it will break on older compiler and on non-Microsoft compilers.</EM><BR>2)#pragma setlocale? <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="times new roman,times"><EM>Does not work<BR></EM>3) convert strings &nbsp;to &nbsp;their hex-byte-array array form. something like char foo={0xba,0xad,0xf0,0x0d,0x00}? <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </FONT><FONT face="times new roman,times"><EM>Will work, will look ugly and I'll have to forget about editing this file in a my wonderful UTF8 -capable editor , VS2005 IDE.<BR><BR></EM>Or forget about getting this file compiled on Japanese Windows. It is not important *for me* anyway. &nbsp;This compiler works quite well on latin1 territories:)</FONT></P></BLOCKQUOTE>
<P>First of all, note that the old situation didn't always work, and there was a bug to fix here to make sure that a known issue would no longer be an issue.</P>
<P>And&nbsp;remember that UTF-8 without BOM support was never promised or intended -- it was only working when the default system locale assumption didn't step in the sequences used for UTF-8.</P>
<P>But the "move a&nbsp;project to a new machine and&nbsp;watch the&nbsp;project have problems&nbsp;in compiling, linking, or in the final application" problem? THAT problem was on the radar.</P>
<P>And then they fixed it -- with a <A class="" href="http://msdn.microsoft.com/library/ms173715.aspx" mce_href="http://msdn.microsoft.com/library/ms173715.aspx">level 1 compiler warning C4819</A>.</P>
<P><EM>I have talked about this one in several blogs, e.g. </EM><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html"><STRONG><EM>here</EM></STRONG></A><EM>, </EM><A class="" href="http://archives.miloush.net/michkap/archive/2005/12/09/502290.html" mce_href="http://archives.miloush.net/michkap/archive/2005/12/09/502290.html"><STRONG><EM>here</EM></STRONG></A><EM>, </EM><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/08/349230.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/08/349230.html"><STRONG><EM>here</EM></STRONG></A><EM>, and </EM><A class="" href="http://archives.miloush.net/michkap/archive/2005/10/28/486019.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/28/486019.html"><STRONG><EM>here</EM></STRONG></A><EM>.</EM></P>
<P>Now I happen to agree with the comments that Jonathan Caves from the VC++ Compiler Team made in that <A class="" href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=341454" mce_href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=341454">Compile error with source file containing UTF8 strings (in CJK system locale)</A> VS Feedback submission:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">our suggestion for fixing this issue would be to use a BOM - this unambiguously lets the compiler know the encoding of the file - without this the compiler needs to revert to guess work.<BR><BR>you are correct the BOM is not part of the C++ Standard - but if you want non-ASCII characters then the "official" and portable way to get them is to use the \u (or \U) hex encoding (which is, I agree, just plain ugly and error prone).<BR><BR>The compiler when faced with a source file that does not have a BOM the compiler reads ahead a certain distance into the file to see if it can detect any Unicode characters - it specifically looks for UTF-16 and UTF-16BE - if it doesn't find either then it assumes that it has MBCS. I suspect that in this case that in this case it falls back to MBCS and this is what is causing the problem.<BR><BR>Being explicit is really best and so while I know it is not a perfect solution I would suggest using the BOM.</FONT></EM></P></BLOCKQUOTE>
<P>It is funny, it was just days ago that I blogged about another issue with a missing BOM (in <A class="" href="http://archives.miloush.net/michkap/archive/2008/05/16/8511203.html" mce_href="http://archives.miloush.net/michkap/archive/2008/05/16/8511203.html"><STRONG>My Spidey senses blame the rogue text editor</STRONG></A>, about .KLC source files in MSKLC).</P>
<P>Maybe it is something in the water.</P>
<P>Or a generic fear of BOM instilled in people by the Transportation Security Administration (TSA) in the United States, which leads to <A class="" href="http://archives.miloush.net/michkap/archive/2007/12/11/6726647.html" mce_href="http://archives.miloush.net/michkap/archive/2007/12/11/6726647.html"><STRONG>this</STRONG></A> kind of misunderstanding....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by </EM></FONT><A class="" href="http://www.fileformat.info/info/unicode/char/feff" mce_href="http://www.fileformat.info/info/unicode/char/feff"><EM>U+feff</EM></A><EM><FONT color=#ff00ff>, aka ZERO WIDTH NO-BREAK SPACE)</FONT></EM></P>
<hr/><p><strong>Andrew Cook</strong> on 19 May 2008 12:11 PM:</p><div style="margin-left: 1em"><p>#pragma warning (disable : 4819)</p>
<p>as line 1 in your code files? Does that do the trick?</p>
<p><a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/2c8f766e">http://msdn.microsoft.com/en-us/library/2c8f766e</a>(VS.71).aspx</p></div>
<p><strong>Tyler</strong> on 19 May 2008 2:30 PM:</p><div style="margin-left: 1em"><p>So, I usually run my system with Japanese locale.</p>
<p>Oddly, this tends to make me unable to build some projects, because someone somewhere used an editor that converted &quot;...&quot; to a triple '.' character (in a comment).</p>
<p>It's a pain in the posterior to walk away from a compile, come back a while later, and see you stopped about a quarter of the way through because some yahoo forgot to turn off autocorrect, and never set a BOM.</p>
<p>The experience is not that uncommon, either. &nbsp; Anyhow, that's my 'How I Learned to Stop Worrying and Love the BOM' story. &nbsp;Either people need to add a BOM to all sourcefiles, or someone needs to specify the standard encoding for this stuff. (Which I feel ought to be either utf-8 or UCS-32).</p></div>
<p><strong>Michael S. Kaplan</strong> on 19 May 2008 3:07 PM:</p><div style="margin-left: 1em"><p>UCS-32? No such beast, Tyler -- there is UTF-32 and UCS-4.</p>
<p>But not allowing UTF-16 here would be a huge mistake given the many platforms that have this as their default encoding, including Windows. It is doubtful that any standard that did not account for that would be very widely adopted....</p>
<p>Though I am firmly in favor of disabling Word Autocorrect with extreme prejudice! :-)</p>
</div>
<p><strong>Tyler</strong> on 19 May 2008 3:53 PM:</p><div style="margin-left: 1em"><p>Bah. &nbsp;One of the 4 byte encodings, anyway. :)</p></div>
<p><strong>vonsrdmn</strong> on 19 May 2008 5:20 PM:</p><div style="margin-left: 1em"><p>It is quite a bit more complicated, but it seems that the IDE itself could manage this. Since the standard itself calls for using the \u escape sequence to store unicode strings (AFAIK and per the original post) in source files, it seems that the VS IDE could parse the source file when opening/closing and render on the screen the correct characters, but actually store the string in the \u notation. </p>
<p>This way you get an easy to UI, and you get a file that conforms to the standard. Obviously this is a lot more work to implement though...</p></div>
<p><strong>Michael S. Kaplan</strong> on 19 May 2008 5:38 PM:</p><div style="margin-left: 1em"><p>It would also break the expectations of the person asking the original question -- someone doing cross-platform compiles with their source in an encoding (UTF-8) that does *not* \u encode so that they can see their strings as strings in their editor, which chokes on a BOM.</p>
<p>Parsing the entire file to do UTF-8 detection does add a potentially huge performance burden on large source files, so I am glad that approach is not what currently happens. :-)</p>
</div>
<p><strong>Ambarish Sridharanarayanan</strong> on 20 May 2008 2:50 AM:</p><div style="margin-left: 1em"><p>&quot;Parsing the entire file to do UTF-8 detection does add a potentially huge performance burden on large source files, so I am glad that approach is not what currently happens. :-)&quot;</p>
<p>This should not be necessary. The real issue is that the default (if the compiler doesn't detect UTF-16) is MBCS, when it ought to be UTF-8.</p></div>
<p><strong>Michael S. Kaplan</strong> on 20 May 2008 2:56 AM:</p><div style="margin-left: 1em"><p>Since there is more than a decade of MBCS as the default, a UTF-8 default is much more likely to break people than the default that is there now. I'm a fan of Unicode, but I am an even bigger fan of not breaking something that has worked a specific way for more years than Unicode (and definitely more than UTF-8) even really existed....</p>
</div>
<p><strong>Mike Dimmick</strong> on 20 May 2008 5:51 AM:</p><div style="margin-left: 1em"><P>This is one of the areas that the C++ standard leaves 'implementation-defined'. They do not define the character set of the source files. As far as the compiler is concerned, it's a 'translation unit' and how the source text appears at the compiler front-end is up to the vendor.</P>
<P>Traditionally when people were still working with 7-bit ISO-646 variants, C users in non-US locales had to write their code using whatever characters matched the code point in ISO-646-US (ASCII). So in Denmark you'd have to write Æ where you needed a [, Ø for a \, Å for ], æ for a {, ø for a | and å for }. So your Hello World program starts looking like:</P>
<P>int main()</P>
<P>æ</P>
<P>&nbsp; &nbsp;printf( "Hello World!Øn" );</P>
<P>&nbsp; &nbsp;return 0;</P>
<P>å</P>
<P>Not exactly intuitive. So POSIX defined iso646.h which defines macros for a number of problematic operators (&amp;&amp;, &amp;=, &amp;, |, ~, !, !=, ||, |=, ^, ^=). Separately, trigraphs - sequences of three characters beginning ?? - were added as a workaround. Finally, digraphs were also added as alternate ways of spelling #, ##, [, ], { and }.</P></div>
<p><strong>Paul Dempsey</strong> on 23 May 2008 7:39 PM:</p><div style="margin-left: 1em"><p>It would be nice if the compiler added a command line switch to specify the encoding of the source file. This would provide a tool to manage the situation without possible breaking cross-plat/sys/compiler compatibility by changing the actual file encoding.</p>
<p>Then you could manage those legacy source files where different strings contained text pasted from a number of _different_ encodings. This worked when built on a non-MBCS system because the compiler would leave the bytes alone, and each string would be used only in the matching locale. (I've seen this long ago - would be doen differen today).</p>
<p>It is possible that </p>
<p> &nbsp;#pragma setlocale</p>
<p>would be of use when faced with this situation. Look it up.</p>
<p>As I recall, this gets very tricky and hard to understand what the #pragma really means. When I last looked into this many years ago the docs had more details, bbut still confusing.</p>
<p>Gratifying to see the nice comment about VS as a nice UTF-8 editor. You're welcome :-).</p>
<p>--- P</p></div>
<p><strong>Michael S. Kaplan</strong> on 23 May 2008 10:44 PM:</p><div style="margin-left: 1em"><P>That would just be the beginning of course; all of the following need to be considered:</P>
<UL>
<LI>encoding</LI>
<LI>to BOM or not to BOM</LI>
<LI>how to end lines? (CR, LF, CRLF, or other)</LI></UL>
<P>And all of that would have to be done *per* file if they are to be command line flags....</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/01/07 <a href="http://archives.miloush.net/michkap/archive/2009/01/07/9287052.html">Someone please detect if there's a BOM before the plane takes off!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/05/19/8518747.html" title="Have you had your [auto]fill of Outlook?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/05/18/8518476.html" title="The song[ and the answer] remains the same">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-05-19">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/05/19/8518545.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>