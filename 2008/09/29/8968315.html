<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/29/8968315.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What a tangled web we weave when a KLID from an HKL we must receive</title></head><body>
<h1>What a tangled web we weave when a KLID from an HKL we must receive</h1>
<p><em>by Michael S. Kaplan, published on 2008/09/29 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/09/29/8968315.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><i><font color="#ff0000">For the title to work best, you have to use the pronunciations from <b><a href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html" mce_href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html">Some keyboarding terms</a></b> for the terms...</font></i><br></p>

<p>In&nbsp;a series of newsgroup posts, Udi Raz asked many related questions:</p>

<blockquote>
<p><font face="times new roman,times"><i>There </i></font><font face="times new roman,times"><i>are two Bengali layouts on XP.</i></font><br><font face="times new roman,times"><i><br></i></font><font face="times new roman,times"><i>I am able to load and activate the Bengali layout using :<br><br></i></font><font face="times new roman,times"><i>CString strLCID = _T("00000445");<br>HKL hNewKeyboard = LoadKeyboardLayout(strLCID,KLF_SUBSTITUTE_OK);<br>HKL hkl = ActivateKeyboardLayout(hNewKeyboard,0);<br><br></i></font><font face="times new roman,times"><i>or to activate the bengali on a different window using :<br>::PostMessage( m_foregrounfWnd, WM_INPUTLANGCHANGEREQUEST, 1, 0x04450445 );<br><br></i></font><font face="times new roman,times"><i>the second layout, Bengali inscript does not work.<br><br></i></font><font face="times new roman,times"><i>I obtain the Bengali Inscript by adding it to the language bar, choosing it <br>and using :<br>DWORD dwThreadID = ::GetWindowThreadProcessId (foregrounfWnd, &amp;dwProcessID);<br>HKL focusLangId = ::GetKeyboardLayout(dwThreadID);<br><br></i></font><font face="times new roman,times"><i>The value I got is : focusLangId = 0xF02A0445<br><br></i></font><font face="times new roman,times"><i>Please advice how to load it<br>Thanks,<br>Udi Raz</i><br><br><br>Hi,<br><br></font><font face="times new roman,times">The following code does not activate Bengali Inscript but do activate <br>Benagli (0x00000445)&nbsp;<br><br></font><font face="times new roman,times">&nbsp;LoadKeyboardLayout(strLCID,KLF_SUBSTITUTE_OK);<br>::PostMessage( m_foregrounfWnd, WM_INPUTLANGCHANGEREQUEST, <br>INPUTLANGCHANGE_SYSCHARSET, 0x00010445); <br><br></font><font face="times new roman,times">while the code below works well for both Bengali layouts<br>HKL hNewKeyboard = LoadKeyboardLayout(strLCID,KLF_ACTIVATE);<br>ActivateKeyboardLayout(hNewKeyboard,KLF_SETFORPROCESS);<br><br></font><font face="times new roman,times">I would like to change the language of other application and therefore I am <br>using PostMessage. It looks like that the postmessage does not call <br>ActivateKeyboardLayout with KLF_SETFORPROCESS flag.<br><br></font><font face="times new roman,times">Please advice</font></p>
</blockquote>

<p mce_keep="true">Now the biggest problem here is a misunderstanding I cover in one of my earliest blogs (<b><a href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html" mce_href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html">Some keyboarding terms</a></b>) -- the difference between a <b>KLID</b> and an <b>HKL</b>.</p>

<p mce_keep="true">Now the topic has come up a few times since then, like in <b><a href="http://archives.miloush.net/michkap/archive/2004/12/16/318271.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/16/318271.html">Thursday morning wrestling: LCID vs. HKL</a></b>, <b><a href="http://archives.miloush.net/michkap/archive/2005/04/17/409032.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/17/409032.html">Why are the HKL and KLID of the keyboard different?</a></b>, and many others.</p>

<p mce_keep="true">Now the problem here is kind of like the one I discuss in <b><a href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html">How do I get the @!#$% name of the keyboard?</a></b>, which is trying to get the <b>KLID</b> when one has the <b>HKL</b>.</p>

<p mce_keep="true">This is essentially the same problem -- one has the <b>HKL</b> but one wants to get the <b>KLID</b>.</p>

<p mce_keep="true">Now of course solving the converse problem is easy -- a simple call to <a href="http://msdn.microsoft.com/library/ms646305.aspx" mce_href="http://msdn.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</a> will take a KLID and give you an HKL. And then the only thing you need to do is make sure that you unload it (via an <a href="http://msdn.microsoft.com/library/ms646324.aspx" mce_href="http://msdn.microsoft.com/library/ms646324.aspx">UnloadKeyboardLayout</a> call) <i>if it was not already loaded</i>, a problem I talk about in <b><a href="http://archives.miloush.net/michkap/archive/2006/03/24/558715.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/24/558715.html">Getting all you can out of a keyboard layout, Part #2</a></b>. But that is really very easy.</p>

<p mce_keep="true">Now admittedly that problem would have much easier to handle if USER's keyboarding API borrowed a page from the ADVAPI32 registry API with its <a href="http://msdn.microsoft.com/library/ms724844.aspx" mce_href="http://msdn.microsoft.com/library/ms724844.aspx">RegCreateKeyEx</a>/<a href="http://msdn.microsoft.com/library/ms724897.aspx" mce_href="http://msdn.microsoft.com/library/ms724897.aspx">RegOpenKeyEx</a> or KERNEL32's DLLs/Processes/Threads API did with its <a href="http://msdn.microsoft.com/library/ms684175.aspx" mce_href="http://msdn.microsoft.com/library/ms684175.aspx">LoadLibrary</a>/<a href="http://msdn.microsoft.com/library/ms683199.aspx" mce_href="http://msdn.microsoft.com/library/ms683199.aspx">GetModuleHandle</a> -- distinguishing between trying to point to something if it is already around, versus load it first if it's not there.</p>

<p mce_keep="true">And life would much easier if that existed, I will admit -- in fact my own life would have been easier when the MSKLC work was going on. But the problem is still easily solvable so there are no real worries there. It is probably time to get over it and stop whining so much. :-)<br></p>

<p mce_keep="true">But as I pointed out in <b><a href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html">How do I get the @!#$% name of the keyboard?</a></b>, the other way around is not so easy at all.</p>

<p mce_keep="true">The only function that exists to help is <a href="http://msdn.microsoft.com/library/ms646298.aspx" mce_href="http://msdn.microsoft.com/library/ms646298.aspx">GetKeyboardLayoutName</a>. And it will only deal with the current input language in a thread, not the other ones that may be loaded with their own HKL values.</p>

<p mce_keep="true">Changing the current HKL (via <a href="http://msdn.microsoft.com/library/ms646289.aspx" mce_href="http://msdn.microsoft.com/library/ms646289.aspx">ActivateKeyboardLayout</a>, for example) is a nightmare of unwanted notification messages and communications that is so awful that even .NET's <a href="http://msdn.microsoft.com/library/system.windows.forms.inputlanguage.aspx" mce_href="http://msdn.microsoft.com/library/system.windows.forms.inputlanguage.aspx">InputLanguage class</a> saw its developers throwing up their hands and writing their own code to parse the almost-impossible-to-figure-out HKCU keys to find out about loaded input languages, in order to avoid tripping up its own input language events functionality.</p>

<p mce_keep="true">It's a freaking clusterfrick, if you know what I mean.</p>

<p mce_keep="true">Even if you are willing to live with the unwanted events and such, using the same code <b><a href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/05/275231.html">How do I get the @!#$% name of the keyboard?</a></b> uses to only unload what is already loaded, you will won't have everything.</p>

<p mce_keep="true">Because a long time ago it was decided that you could put any keyboard under any language. And the HKL's LANGID is based on the language you put the keyboard under, not the actual keyboard layout that the KLID expresses.</p>

<p mce_keep="true">In fact <a href="http://msdn.microsoft.com/library/ms629036.aspx" mce_href="http://msdn.microsoft.com/library/ms629036.aspx">the TSF functions</a> are the only way to even add such language/keyboard combinations yourself, though there is a newly documented function (only really available in Vista) that makes this all at least possible (<a href="http://msdn.microsoft.com/library/bb847907.aspx" mce_href="http://msdn.microsoft.com/library/bb847907.aspx">EnumEnabledLayoutOrTip</a>). It returns a bunch of <b>LAYOUTORTIPPROFILE</b> stuctures, which are defined as follows:</p>

<blockquote>
<p mce_keep="true"><b><font face="consolas,lucida console,courier new,courier,fixed">typedef struct tagLAYOUTORTIPPROFILE {<br>&nbsp;&nbsp;&nbsp; DWORD&nbsp; dwProfileType;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // InputProcessor or HKL<br>#define LOTP_INPUTPROCESSOR 1<br>#define LOTP_KEYBOARDLAYOUT 2<br>&nbsp;&nbsp;&nbsp; LANGID langid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // language id<br>&nbsp;&nbsp;&nbsp; CLSID&nbsp; clsid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // CLSID of tip<br>&nbsp;&nbsp;&nbsp; GUID&nbsp;&nbsp; guidProfile;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // profile description<br>&nbsp;&nbsp;&nbsp; GUID&nbsp;&nbsp; catid;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // category of tip<br>&nbsp;&nbsp;&nbsp; DWORD&nbsp; dwSubstituteLayout;&nbsp; // substitute hkl<br>&nbsp;&nbsp;&nbsp; DWORD&nbsp; dwFlags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Flags<br>&nbsp;&nbsp;&nbsp; WCHAR&nbsp; szId[MAX_PATH];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // KLID or TIP profile for string<br>} LAYOUTORTIPPROFILE;</font></b><br></p>
</blockquote>

<p mce_keep="true">Note that this structure will give you both the LANGID and the KLID, though interestingly not the HKL.</p>

<p mce_keep="true">Though now, even armed with <a href="http://msdn.microsoft.com/library/bb847907.aspx" mce_href="http://msdn.microsoft.com/library/bb847907.aspx">EnumEnabledLayoutOrTip</a>, you still need <a href="http://msdn.microsoft.com/library/ms646289.aspx" mce_href="http://msdn.microsoft.com/library/ms646289.aspx">ActivateKeyboardLayout</a>, <a href="http://msdn.microsoft.com/library/ms646298.aspx" mce_href="http://msdn.microsoft.com/library/ms646298.aspx">GetKeyboardLayoutName</a>, <a href="http://msdn.microsoft.com/library/ms646305.aspx" mce_href="http://msdn.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</a>, and <a href="http://msdn.microsoft.com/library/ms646324.aspx" mce_href="http://msdn.microsoft.com/library/ms646324.aspx">UnloadKeyboardLayout</a> if you really want to get the <b>KLID</b> of a specific <b>HKL</b>, unless you trust that the never-explained-member of LAYOUTORTIPPROFILE member dwSubstituteLayout is a 32-bit HKL (shadows of the <b><a href="http://archives.miloush.net/michkap/archive/2006/08/01/684909.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/01/684909.html">32 bit vs. 64 bit HKLs?</a></b> problem now, since this function works the same on 64-bit Windows as on 32-bit!).</p>

<p mce_keep="true">We'll just leave the actual problem Udi Raz was having, of trying to load anything other than the first, default input language under the same LANGID as the underlying KLID is used as a difficult one (though all of the clues are now here for how to solve the problem in Windows &gt;= Vista and most of the clues are now here for Windows in prior versions.</p>

<p mce_keep="true">In my opinion the fact that it is so hard for users to do something in this space ought to be considered a genuine bug, though this is just my opinion and have no proof or belief that the owners of the components would feel the same way.</p>

<p mce_keep="true">An upcoming blog later this week will clear up the loose ends and make this all a bit easier to work out the solution here.<br></p>

<p mce_keep="true">Perhaps some of this will even be coded up in a future blog beyond that, too.<br></p>

<p mce_keep="true">And I still have bug to explain as well -- this will be in a blog coming up tomorrow or the next day...</p>

<p mce_keep="true"><br></p>

<p mce_keep="true"><font color="#ff00ff"><i>This blog brought to you by</i><font size="7"> ঐ </font><i>(<a href="http://www.fileformat.info/info/unicode/char/0990" mce_href="http://www.fileformat.info/info/unicode/char/0990">U+0990</a>, aka BENGALI LETTER AI)</i></font><br></p>
<hr/><p><a id="8969134" href="#8969134">#</a> <strong>John Cowan</strong> on 29 Sep 2008 12:04 PM:</p><div style="margin-left: 1em"><p>As a result of a misspent youth reading too much Heinlein, HKL to me will always stand for &quot;Hong Kong Luna&quot;.</p></div>
<p><a id="8969372" href="#8969372">#</a> <strong>Michael S. Kaplan</strong> on 29 Sep 2008 3:30 PM:</p><div style="margin-left: 1em"><p>There is <b>no</b> such thing as too much Heinlein.</p>
<p>Too much L. Ron Hubbard? Easy. But Heinlein? Never. :-)</p></div>
<p><a id="9471505" href="#9471505">#</a> <strong>KC Teo</strong> on 12 Mar 2009 5:54 AM:</p><div style="margin-left: 1em"><p>Greeting. &nbsp; </p>
<p>Just wonder has any one tried calling EnumEnabledLayoutOrTip following what suggested on the MSDN website, ie. using LoadLibrary and GetProcAddress ? &nbsp;I tried and it crashed my program with error message: 0xC0000005: Access violation writing location &lt;memory location&gt;. &nbsp;</p>
<p>To make sure I am doing the right thing, I have tried using the same approach to call QueryLayoutOrTipString which belongs to the same Input.dll, that works fine.</p>
<p>Does this some how indicate that the parameters of EnumEnabledLayoutOrTip documented on the MSDN website are inaccurate ? &nbsp;Thanks.</p></div>
<p><a id="9963578" href="#9963578">#</a> <strong>FRG</strong> on 15 Feb 2010 7:05 AM:</p><div style="margin-left: 1em"><p>My comment is quite outdated, but since there are no much information about Vista/W7's TSF, I'll hope it'll help someone:</p>
<p>1. EnumEnabledLayoutOrTip() is misdocumented. The correct prototype is &nbsp;</p>
<p>UINT EnumEnabledLayoutOrTip(LPCWSTR pszUserReg, LPCWSTR pszSystemReg, LPCWSTR pszSoftwareReg, LAYOUTORTIPPROFILE *pLayoutOrTipProfile, UINT uBufLength);</p>
<p>2. There is a very handy (but undocumented) function in input.dll :</p>
<p>HRESULT GetLayoutDescription (LPWSTR szId, LPCWSTR pszName,	 LPUINT uBufLength, DWORD dwFlags) that returns a human-readable IME description (like &quot;English(US) - Dvorak&quot;). Combining both together, it's easy to get a list of all active IMEs installed.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/08/28 <a href="http://archives.miloush.net/michkap/archive/2012/08/28/10344043.html">'If it is easy, then there are samples. And if it's very easy, everyone is writing them.'</a></p><p>2008/10/01 <a href="http://archives.miloush.net/michkap/archive/2008/10/01/8971160.html">What do you get when you put a Hebrew on top of a Russian? (aka What lies beneath can bite you on the ass)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/09/29/8968429.html" title="The difference between Six Sigma and Sigma Diaresis is one must never fail; the other seems to do so by default">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/09/28/8968269.html" title="I&#39;ll start by saying לשנה טובה to everyone who understands what I just @#%&amp;*! said">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09-29">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/29/8968315.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>