<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/25/8964094.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When to make a change, when to stay the same</title></head><body>
<h1>When to make a change, when to stay the same</h1>
<p><em>by Michael S. Kaplan, published on 2008/09/25 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/09/25/8964094.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>The roots of this blog run pretty deep.</p>

<p>It starts within months of the very beginning of this Blog, with <b><a href="http://archives.miloush.net/michkap/archive/2005/01/31/363701.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/31/363701.html">FoldString.NET? No, but Whidbey has Normalization (which is kinda more cooler)</a></b>, where the fact that the NLS API function <a href="http://msdn.microsoft.com/library/ms647478.aspx" mce_href="http://msdn.microsoft.com/library/ms647478.aspx">FoldString</a>, which predates Unicode normalization by many years, provides very Normalization-esque functionality.</p>

<p>In fact, the analogues given are valid on their face since they conceptually do the same thing:</p>

<blockquote>
<p><font size="2" face="Courier New"><b>FormC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAP_PRECOMPOSED<br></b></font><font size="2" face="Courier New"><b>FormD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAP_COMPOSITE<br></b></font><font size="2" face="Courier New"><b>FormKC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAP_PRECOMPOSED | 
MAP_FOLDCZONE<br></b></font><font size="2" face="Courier New"><b>FormKD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAP_COMPOSITE | MAP_FOLDCZONE</b></font> <br></p>
</blockquote>

<p>As an interesting side point,. the fact that Asmus Freytag was heavily involved with both the Microsoft function when the spec was originally being developed and the UAX when it was being written is not a coincidence -- he was instrumental in both of them.</p>

<p>Of course there can be (or, in this case, is) a wide chasm to deal with.</p>

<p>You know, the chasm between the concept and the reality.</p>

<p>As an example, if you run the following code on an XP machine to compare Microsoft's <a href="http://msdn.microsoft.com/library/ms647478.aspx" mce_href="http://msdn.microsoft.com/library/ms647478.aspx">FoldString</a> functionality with Unicode's normalization, looking just at the Basic Multilingual Plane (U+0001 to U+ffff):</p>

<blockquote><font size="2" face="Consolas,Lucida Console,Courier New,Courier"><b>
<p>using System;<br>using System.Text;<br>using System.Globalization;<br>using System.Runtime.InteropServices;<br><br>public class Test {<br>&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll", CharSet=CharSet.Unicode, EntryPoint="FoldStringW", ExactSpelling=true, CallingConvention=CallingConvention.StdCall)]<br>&nbsp;&nbsp;&nbsp; private static extern int FoldString(uint dwMapFlags, string lpSrcStr, int cchSrc, StringBuilder lpDestStr, int cchDest);<br><br>&nbsp;&nbsp;&nbsp; private const uint MAP_PRECOMPOSED = 0x00000020;&nbsp; // convert to precomposed chars<br>&nbsp;&nbsp;&nbsp; private const uint MAP_COMPOSITE = 0x00000040;&nbsp; // convert to composite chars<br><br>&nbsp;&nbsp;&nbsp; public static void Main() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(ushort uch = 0x0001; uch != 0xffff; uch++) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if((CharUnicodeInfo.GetUnicodeCategory((char)uch) == UnicodeCategory.Surrogate) || <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (CharUnicodeInfo.GetUnicodeCategory((char)uch) == UnicodeCategory.OtherNotAssigned)) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder sb = new StringBuilder(10);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string st = ((char)uch).ToString();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stFormD = st.Normalize(NormalizationForm.FormD);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string stComposite;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int ret = FoldString(MAP_COMPOSITE, st, -1, sb, sb.Capacity);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(ret &gt; 0) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stComposite = sb.ToString(0, ret - 1);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(stComposite != stFormD) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write("USV: ");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(uch.ToString("x4"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write("&nbsp;&nbsp; |||&nbsp;&nbsp; Microsoft: ");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int ich=0; ich &lt; ret - 1; ich++) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(((ushort)stComposite[ich]).ToString("x4"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(' ');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write("&nbsp;&nbsp; |||&nbsp;&nbsp; Unicode: ");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int ich=0; ich &lt; stFormD.Length; ich++) {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(((ushort)stFormD[ich]).ToString("x4"));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.Write(' ');<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>} <br></p>
</b></font></blockquote>

<p>You will see that even just looking at the MAP_COMPOSITE vs. Normalization Form D case, there are 12,224 entries that have different results.</p>
<p>Now 11,172 of those are Korean so we'll throw those out for a moment.</p>
<p>There are still 1,052 differences between the two.</p>
<p>Now in Vista, the work was done to dump these older tables and instead call the normalization functionality provided by the <a href="http://msdn.microsoft.com/library/ms776395.aspx" mce_href="http://msdn.microsoft.com/library/ms776395.aspx">NormalizeString</a> function that was now also a part of the NLS API. That work involved some interesting tradeoffs that might be worthy of a blog another day, but for now I have a totally different set of things to talk about....</p>
<p>You see, we now have to talk about the other place that these prehistoric normalization-esque are used.</p>
<p>In the <a href="http://msdn.microsoft.com/library/ms776413.aspx" mce_href="http://msdn.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</a> function and its MB_PRECOMPOSED and MB_COMPOSITE flags, which map as one would expect to the MAP_PRECOMPOSED asnd MAP_COMPOSITE flags from <a href="http://msdn.microsoft.com/library/ms647478.aspx" mce_href="http://msdn.microsoft.com/library/ms647478.aspx">FoldString</a>.</p>
<p>Now I am not going to pretend that these flags are such great things -- in fact I am on record (ref: <b><a href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html">A few of the gotchas of MultiByteToWideChar</a></b> and <b><a href="http://archives.miloush.net/michkap/archive/2007/06/26/3558548.html" mce_href="http://archives.miloush.net/michkap/archive/2007/06/26/3558548.html">The MB_PRECOMPOSED flag is stupid, and the MB_COMPOSITE ain't no genius either</a></b>) explaining how one of them is bad and the other is not needed since t is the dfault and can cause bugs by being passed gratuitously.</p>
<p><i>It is also connected to the WC_COMPOSITECHECK flag for <a href="http://msdn.microsoft.com/library/ms776420.aspx" mce_href="http://msdn.microsoft.com/library/ms776420.aspx">WideCharToMultiByte</a> that I blogged about in <b><a href="http://archives.miloush.net/michkap/archive/2005/04/18/409095.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/18/409095.html">A few of the gotchas of WideCharToMultiByte</a></b>, though not nearly as much to worry about except occasionally. We'll ignore it for now. :-)<br></i></p>
<p>Now it is true that changing a mapping function whose job it is to try it's best to map as requested, and that changing to provide better data is a good thing, is for the majority of people a decision. I believe that, and it is a decision I would defend as being the correct behavior.<br></p>
<p>But changing the behavior of <a href="http://msdn.microsoft.com/library/ms776413.aspx" mce_href="http://msdn.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</a> to cause it return so man potential differences, that is another kind of decision entirely. In that case I would defend the decision not to change the behavior.<br></p>
<p>Especially when we are on record as not ever wanting to add, remove, extend, or modify code pages! </p>
<p>Even though this extra operation is not in the code pages themselves, it is behavior that is built into the functions. And claiming on the one hand that we won't make changes ever while deciding on the other hand to make over a thousand changes? It is easy to imagine customers being unhappy with the end result.</p><p>&nbsp;</p><p><font color="#ff00ff"><i>Sponsor? We don't need no stinking sponsor! :-)</i></font> <br></p>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/09/25/8964291.html" title="You&#39;re not my type if you have no culture">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/09/24/8963238.html" title="It used to be right, dammit!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/25/8964094.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>