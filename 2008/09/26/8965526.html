<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/26/8965526.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When Flat is not the Standard, the System is null?</title></head><body>
<h1>When Flat is not the Standard, the System is null?</h1>
<p><em>by Michael S. Kaplan, published on 2008/09/26 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/09/26/8965526.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
&nbsp;<p>The question to the alias was simple enough:</p><blockquote><p><i><font face="times new roman,times">I have an issue dealing with winform button,&nbsp; I want to get the font used by button by sending WM_GETFONT message, if button’s FlatStyle=Standard, it returns NULL, however if button’s FlatStyle=System,&nbsp; it returns the correct font handle, anyone can take a look? <br><br>According to MSDN, if WM_GETFONT returns NULL, it means system font, but I specifically set the button font to a non-system font, and this seems it’s a bug to me.</font></i> <br></p></blockquote><p>Everything is actually behaving as it was designed to, though.</p><p>What is important to remember is that <b>Windows Forms</b> or "<b>WinForms</b>" is layer on top of Windows -- sometimes a very thick layer with a lot of functionality, and other times a vey thin layer that gives the smallest amount of an illusion a it can get away with.</p><p>Now for the <b>FlatStyle=System</b> setting on the button, the wrappet becomes very thin -- and the OS is used to do everything, including the rendering.</p><p>While when <b>FlatStyle=Standard</b> is used, however, the control goes the "owner draw" route, and since Windows doesn't really need a font itself in that case (and since .NET has to have it's own managed Font object to do its own work, there is no benefit to creating an extra object and storing it when it is not needed.</p><p>Now this deisgn had very interesting consequences when WinForms was supporte don Win9x -- because it meant that <b>FlatStyle=System</b> would not support text of the default system code page, while <b>FlatStyle=Standard</b> would support any text you had the font for.</p><p>And even moving into NT-based platforms, you could easily find yourself dealing with the differences between GDI/Uniscribe being used in one case vs. GDI+ in the other.</p><p>This particular <a href="http://msdn.microsoft.com/library/ms632624.aspx" mce_href="http://msdn.microsoft.com/library/ms632624.aspx">WM_GETFONT</a> issue is an interesting side effect (the reason the questioner wanted to use the <a href="http://msdn.microsoft.com/library/ms632624.aspx" mce_href="http://msdn.microsoft.com/library/ms632624.aspx">WM_GETFONT</a> message was for a test tool that was itself using native code, trying to verify what the font was on a particular control.</p><p>And this even provides a workaround!</p><p>I mean WinForms doesn't bother setting up an object that it does not need. And I can respect that (plus you should, too).</p><p>But if your particular application does care about it, then you have no reason to stay with the limitation....<br></p><p>If your managed code wants to call <a href="http://msdn.microsoft.com/library/ms632642.aspx" mce_href="http://msdn.microsoft.com/library/ms632642.aspx">WM_SETFONT</a> itself by taking the Font object you have and using <a href="http://msdn.microsoft.com/library/system.drawing.font.tohfont.aspx" mce_href="http://msdn.microsoft.com/library/system.drawing.font.tohfont.aspx">Font.ToHfont</a>, it can definitely do so -- and then the font will be available to the process that wants to be using <a href="http://msdn.microsoft.com/library/ms632624.aspx" mce_href="http://msdn.microsoft.com/library/ms632624.aspx">WM_GETFONT</a>. Though keep in mind the rules that <a href="http://msdn.microsoft.com/library/system.drawing.font.tohfont.aspx" mce_href="http://msdn.microsoft.com/library/system.drawing.font.tohfont.aspx">Font.ToHfont</a> mentions:</p><blockquote><p><font face="times new roman,times">When using this method, you must dispose of the resulting Hfont using the GDI DeleteObject method to ensure the resources are released.</font></p></blockquote><p>This mirrors what the <a href="http://msdn.microsoft.com/library/ms632642.aspx" mce_href="http://msdn.microsoft.com/library/ms632642.aspx">WM_SETFONT</a> message says:</p><blockquote><p><font face="times new roman,times">The application should call the DeleteObject function to delete the font when it is no longer needed; for example, after it destroys the control.&nbsp; </font></p></blockquote><p>in case you weren't convinced yet. :-)</p><p>Now note that you do not necessarily have to wait until the control is destroyed -- no one is using that <b>HFONT</b> other than you, so you can destroy it when you are done with it. Though you should probably call <a href="http://msdn.microsoft.com/library/ms632642.aspx" mce_href="http://msdn.microsoft.com/library/ms632642.aspx">WM_SETFONT</a> with a NULL wParam just in case some other process you don't know about has similar ideas to yours and tries to use an object after you have stopped doing so.</p><p>Now moving back to these kinds of behavioral differences that pop up, where entirely different code paths get utilized based on solitary settings like the FlatStyle of a button, as I said way back in the beginning, that's by design. Though I wouldn't mind seeing more advasnced documentation cover consequences like the ones mentioned here, to make it easier to understand the results in one's application....<br></p><p>&nbsp;</p><p><font color="#ff00ff"><i>This blog brought to you by</i><font size="7"> ি </font><i>(<a href="http://www.fileformat.info/info/unicode/char/09bf" mce_href="http://www.fileformat.info/info/unicode/char/09bf">U+09bf</a>, aka BENGALI VOWEL SIGN I)</i></font><br></p>
<hr/><p><strong>bahgat mashaly</strong> on 31 Dec 2010 2:53 PM:</p><div style="margin-left: 1em"><p>many thanks for that Article.</p>
<p>but what can i do if i want to get font of control in other applications ?</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 31 Dec 2010 3:26 PM:</p><div style="margin-left: 1em"><p>Other managed applications that are doing this, from your native application? Just have the managed applications make the change in this article....</p>
</div>
<p><strong>Bahgat Mashaly</strong> on 1 Jan 2011 9:02 AM:</p><div style="margin-left: 1em"><p>many thanks for your reply &nbsp;</p>
<p>try to make google translate any ware so i I want to get a word under the mouse I was able to do that with textbox and richtextbox but not with other control i tray to simulate that control as richtextbox or textbox by get size ,location and font of that control then call ScreenToClient so the other control FlatStyle my be System or standard As you are a professional person and I am a newbie what do you think in my steps?? Is there a better way??and how to solve this problem ? </p>
<p>I&#39;m using c# to do this</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 1 Jan 2011 9:34 AM:</p><div style="margin-left: 1em"><p>Wanting to get the text has almost nothing to do with getting the font, so I&#39;m not sure I see the connection, to be honest. Given that your goal is to translate, the font you want to use is the on supporting the TARGET language you are translating into, not the SOURCE language. So why would you ever want to the font to be the same?</p></div>
<p><strong>Bahgat Mashaly</strong> on 1 Jan 2011 11:18 AM:</p><div style="margin-left: 1em"><p>i want to get the font to get the mouse &nbsp;position of that text , then i can get the word under the mouse </p>
<p>if i use any other font the mouse position my be Refers to another word</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 1 Jan 2011 5:29 PM:</p><div style="margin-left: 1em"><p>That&#39;s where I disagree with your approach. Having knowledge of what font is used does not give some magical way to read the text -- in the case of complex scripts this is patently obvious, but even in other cases such an approach will fail.</p>
<p>In any case, there is no supported/supportable solution anyway to get the info in this specific, as I said. So even if the approach was productive, it is not always feasible. And that is even before we bring the plethorea of WINDOWLESS controls that exist, too.</p>
</div>
<p><strong>Radhika</strong> on 4 Jan 2011 12:39 AM:</p><div style="margin-left: 1em"><p>Thanks for the Article. </p>
<p>I need to get textsize and width of UI controls like Button, Labels of any application.</p>
<p>Tried WM_GETFONT but throws exception saying only TrueType fonts are supported. What should be done to get any type of fonts? Please help</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 4 Jan 2011 12:53 AM:</p><div style="margin-left: 1em"><p>There is no one method to support even every Win32 application, let alone every other kind of application that exists.</p>
</div>
<p><strong>Radhika</strong> on 4 Jan 2011 1:53 AM:</p><div style="margin-left: 1em"><p>Would you be able to give pointers for retriving font information of WPF applications or Winform Applications.? I&#39;m trying for both and not an issue if it points to different procedure.</p>
<p>Thanks</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 5 Jan 2011 6:54 AM:</p><div style="margin-left: 1em"><p>That sounds more like something for the Suggestion Box, though as a question it is so broad that there are real problems delivering on it....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/09/27/8966847.html" title="On why I think my birthday sucks">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/09/25/8964291.html" title="You&#39;re not my type if you have no culture">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/26/8965526.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>