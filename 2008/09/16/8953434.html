<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/16/8953434.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Is the flaw is in the constructs, or in the one who constructs? (aka I shoulda schwa that one coming)</title></head><body>
<h1>Is the flaw is in the constructs, or in the one who constructs? (aka I shoulda schwa that one coming)</h1>
<p><em>by Michael S. Kaplan, published on 2008/09/16 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/09/16/8953434.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, Gregory asked:</p>
<blockquote>



<p><font face="times new roman,times">Hi Michael,<br><br>I stumbled across a piece of code that implements a .NET HttpModule to remove 
whitespace and other junk from pages as you hit them (as can be seen <a href="http://www.darkside.co.za/archive/2008/03/03/web-page-optmisation-using-httpmodule.aspx" mce_href="http://www.darkside.co.za/archive/2008/03/03/web-page-optmisation-using-httpmodule.aspx">here</a>).<br><br>Speaking purely about encoding issues in the code, are there any? The 
particular lines I am worried about are:<br><br><b><font face="consolas,lucida console,courier new,courier,fixed">&nbsp; class PageCleanFilter : Stream<br>&nbsp; {<br>&nbsp; &nbsp; &nbsp; public override void Write(byte[] 
buffer, int offset, int count)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; byte[] data = new 
byte[count];<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Buffer.BlockCopy(buffer, offset, data, 0, 
count);<br>&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp; string html = Encoding.Default.GetString(buffer);<br>&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 
...<br>&nbsp; &nbsp; &nbsp; }</font></b><br><br>This code makes me uncomfortable. Specifically:<br><br>Is it okay to assume that the request response has the encoding specified by 
Encoding.Default?<br><br>This code assumes (I think) that the byte buffer range it works with has all 
the character data - What if a two byte character happens to be split up by the 
calling method? I can't imagine this could be a good thing...<br><br>Thanks in advance</font></p>
</blockquote>
<p>Well, Gregory has good instincts, the kind that I like to think <a href="http://archives.miloush.net/michkap/" mce_href="../../../../">SiaO</a> helps to teach people about. :-)</p><p>This code basically takes a chunk of text and assumes it is in the default system code page.</p><p>If you follow that link, you'll see that between the time I got the message and now, the author took some feedback (from Gregory!) from a <a href="http://darkside.co.za/archive/2008/03/03/web-page-optmisation-using-httpmodule.aspx#33" mce_href="http://darkside.co.za/archive/2008/03/03/web-page-optmisation-using-httpmodule.aspx#33">comment</a> that he left there.</p><p>The code does now gets rid of an extraneous copy operation.</p><p>But it still has the same bad code page assumption, which could easily break depending on the server's settings and really the whole operation should be using UTF-8 here anyway.</p><p>On the one hand it does not matter much since the developer, and the site, are going to be in a single code page.</p><p>But on the other hand, this is advice for a useful bit of code ou can download, with descriptive information such as:</p><blockquote><p><i><font face="times new roman,times">This article details a HttpModule that removes white space, certain javascript comments, as well as optimising ASPX post-back javascript. This is useful when trying to save on the bandwidth your blog is using, or just plain and simply trying to decrease load time of your pages. I've also implemented a custom configuration section to allow the consumer to enable only the functionality required - you can look here for information on creating your own custom sections.</font></i></p></blockquote><p>And the sample is being posted on a blog on the <b>World Wide</b> Web, which means anyone looking for a code sample might find it, and want to use it.</p><p>Plus with methods like <b>RemoveWhiteSpace</b> and <b>RemoveLineBreaks</b> it is worth considering how incomplete their work might be without all of Unicode to work with (not to mention the additional string copies that each of these methods do but let's stay focused on the international stuff!).<br></p><p>and then, when all is said and done, the current code is still converting stuff in and out of the default system code page a lot when it does not have to. At the top of the <b>Write</b> method:</p><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: blue;">string</span> html = <span style="color: rgb(43, 145, 175);">Encoding</span>.Default.GetString(buffer, offset, count);</pre><p>and then at the bottom of the method:</p><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; <span style="color: blue;">byte</span>[] outdata = <span style="color: rgb(43, 145, 175);">Encoding</span>.Default.GetBytes(html);</pre><pre style="margin: 0px;">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; _sink.Write(outdata, 0, outdata.GetLength(0));</pre><p>instead of (like I said) going through UTF-8 here -- which will only lose invalid data, rather than potentially losing anything off the (comparatively small) code page.</p><p>But (taking a step back) where is the flaw? </p><p>Is it truly in the people who misuse the tools, or is it in those who design tools that so easily suggest usages that are not ideal?</p><p>Or as I put it in the title:</p><p>Is the flaw is in the constructs, or in the one who constructs?</p><p>Which then puts me in an odd sentence, where identical words are being used and the only difference is in the pronunciation, you know:</p><p><font size="4"> kən-strŭkt'</font> vs. <font size="4">kŏn'strŭkt'</font></p><p>I like reminders of this when people act skeptically about how when I mention Han ideographs have multiple pronunciations, since it clearly happens in English too. It helps keep people humble.</p><p>But to get back to the encoding question.</p><p>Gregory is right, the code is wrong on a few levels, though primarily the concerns I have would be:<br></p><ul><li>The encoding passed to the method and then converted back out friom it<br></li><li>The operations inside the method that are employed&nbsp;</li></ul><p>The lots-of-copying stuff is something that others probably are much more interested in. I mean, I care -- but not for the purposes of this blog...<br></p><p>I think I am probably going to have to jump into ASP.NET a bit here, and see if I can put some samples together. I'll probably have to dig up a website I have a bit more control over that runs managed code, but I think it might be a useful exercise to do, if described later from soup to nuts.</p><p>Anyway sorry to dēkŏn'strŭkt' things so much. Or actually, to dēkən-strŭkt' them. I'll try to kən-strŭkt' a better kŏn'strŭkt' if I can, later.... :-)</p><p>&nbsp;</p><p>&nbsp;<font color="#ff00ff"><i>This blog brought to you by</i><font size="6"> ə </font><i>(<a href="http://www.fileformat.info/info/unicode/char/0259" mce_href="http://www.fileformat.info/info/unicode/char/0259">U+0259</a>, aka LATIN SMALL LETTER SCHWA)</i><br></font></p>
<hr/><p><strong>Mike Dimmick</strong> on 16 Sep 2008 10:09 AM:</p><div style="margin-left: 1em"><p>The benefit you get from removing blank spaces is generally dwarfed by the benefit of compressing the page entirely. IIS 6.0 has two checkboxes to enable compressing static and dynamic pages.</p></div>
<p><strong>Jan Kučera</strong> on 17 Sep 2008 2:11 PM:</p><div style="margin-left: 1em"><p>I am able to offer public Windows Server 2008 / IIS7 / .NET 3.5 for your asp.net experiments if you would like, including switching the language settings / mui on the fly...</p>
<p>Jan</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/09/16/8953564.html" title="Vérité (add MUI support in a service pack) ou oser (tell me whether returning &#39;vrai&#39; was intentional)?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/09/15/8952073.html" title="UCS-2 to UTF-16, Part 2: A&amp;P of a &#39;linguistic character&#39;">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-09-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/09/16/8953434.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>