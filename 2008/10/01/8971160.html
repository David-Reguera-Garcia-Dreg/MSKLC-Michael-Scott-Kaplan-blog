<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/10/01/8971160.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What do you get when you put a Hebrew on top of a Russian? (aka What lies beneath can bite you on the ass)</title></head><body>
<h1>What do you get when you put a Hebrew on top of a Russian? (aka What lies beneath can bite you on the ass)</h1>
<p><em>by Michael S. Kaplan, published on 2008/10/01 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/10/01/8971160.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>So it was actually a couple of days ago (in the blog titled <b><a href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html" mce_href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html">What a tangled web we weave when a KLID from an HKL we must receive</a></b>) that I painted a picture that would cause any normal, sane developer charged with working with keyboard layouts to either run out of the room screaming or to collapse into despair, convinced that Microsoft designed all of this exclusively to make their lives more difficult.<br></p>

<p>Lucky for us that so few normal, sane developers around these parts! :-)</p>

<p>Now as a responsible blog author, I really need to inject some calm into the situation.</p>

<p>I mean, just because I'm unofficial doesn't mean I'm supposed to hit the fire alarm, after all....</p>

<p>With that said, the blog you are reading now is not going to reassure; that will happen in a blog later this week.</p>

<p>For now I am going to turn up the heat.</p>

<p>Did you know that every time you add a keyboard layout to Windows, it stores a bunch of information?</p>

<p>Let's tabulate some of it:</p>

<ul>
<li>The LANGID (either inherited from the KLID or the one you choose) that will usually provide both the big and abbreviated strings that will go in the language bar (the LOCALE_SLANGUAGE and the first two letters of the LOCALE_SABBREVLANGNAME);</li>

<li>The KLID (Keyboard Layout Identifier) that points to the registry key that will get other stuff, like the DLL name and the string that identifies the actual keyboard layout;</li><li>The ANSI code page to associate with text input by the keyboard in non-Unicode Windows applications (gleaned from information in the fsCsb member of the <a href="http://msdn.microsoft.com/library/ms776424.aspx" mce_href="http://msdn.microsoft.com/library/ms776424.aspx">FONTSIGNATURE</a> from the locale in the LOWORD of the KLID);</li>

<li>The OEM code page to associate with text input by the keyboard in non-Unicode console applications (gleaned from information in the fsCsb member of the <a href="http://msdn.microsoft.com/library/ms776424.aspx" mce_href="http://msdn.microsoft.com/library/ms776424.aspx">FONTSIGNATURE</a> from the locale in the LOWORD of the KLID);</li><li>Some other stuff not relevant to the current discussion that I'll talk about some other time when it won't distract from the point I'm trying to make in a bit.<br></li>
</ul>

<p>Now you'll notice that on top of the keyboard is a language, and it shows up everywhere.</p>

<p>But underneath, there is this other language. And that is the one that seems to control a whole bunch of the underlying behavior of the keyboard layout.</p>

<p>This setup mostly makes sense -- after all, if you put the Hebrew language on top of the Cyrillic keyboard layout on a system with an en-US system locale:<br></p>

<blockquote>
<p><img src="http://trigeminal.fmsinc.com/images/hebrewonrussian.png" mce_src="http://trigeminal.fmsinc.com/images/hebrewonrussian.png" width="404" border="0" height="478">&nbsp;&nbsp; <img src="http://trigeminal.fmsinc.com/images/hebrewonrussian02.png" mce_src="http://trigeminal.fmsinc.com/images/hebrewonrussian02.png" width="404" border="0" height="478"><br></p>
</blockquote>

<p>then you would not be very well-served by running your non-Unicode application's input through code page 1252 and your console applications through code page 437 (as the default system locale might recommend).</p><p> Just as you would not be well-served by running your non-Unicode applications input through code page 1256 and your console applications through code page 862 (as the user's chosen "language atop" might recommend).</p><p>The best locale to base the decision off is the one associated with the layout itself.</p><p>What a wonbderful coincidence that this is the actual design!</p><p>Uh oh, I was trying to make people less at ease in this blog. I need to point out why this is bad, not why it is good.</p><p>Well, remember the central message of <b><a href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html" mce_href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html">What a tangled web we weave when a KLID from an HKL we must receive</a></b> -- that it is hard to get a KLID if you have an HKL.</p><p>But all of this information inside the input language that does all of this work and makes all of these decisions <b>is KLID-based</b>!!!</p><p>And very hard to get, just like KLID, but a little harder since you need to get a little bit more information once you are exhausted from getting the KLID.<br></p><p>This means that if you have a non-Unicode legacy application and you need to convert the input to Unicode, you are not given the best information do the conversion.</p><p>And then there has been the occasion that the data has been wrong, like in Vista prior to a hotfix and SP1, leading to the problems covered in <b><a href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html">Double Secret ANSI, part 1 (Somewhere between ANSI and Unicode)</a></b> and <b><a href="http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html">Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</a></b>.</p><p>Why are USER (keyboards) and GDI (fonts) tied together here so tightly, you might wonder? Well, most of the code that does this work is in WIN32K.SYS, and these two components help each other out.</p><p>Now wait a minute -- as bad as that bug is, we fixed it. How is that supposed to cause unease? <br></p><p>Well, let's try this on for size....</p><p>The bug might not be 100% fixed just yet. (insert evil laugh here?)</p><p>And then there is the actual flaw to discuss. <br></p><p>Remember <b><a href="http://archives.miloush.net/michkap/archive/2006/10/14/825404.html" mce_href="http://archives.miloush.net/michkap/archive/2006/10/14/825404.html">Understanding (and explaining) why English is everywhere</a></b> from a couple of years back? </p><p>It explains why/how most locales have the regular old KBDUS.DLL vanilla US English keyboard avalable.</p><p>Do you see the problem yet?</p><p>I'll give you a hint -- the KLID is 00000409.</p><p>Second hint -- the underlying ANSI code page (ACP) is 1252.</p><p>Last hint -- the underlying OEM code page (OEMCP) is 437.</p><p>Now 437 is okay if you are in pure English, but it kind of sucks for dealing with almost any other language supported by code page 1252 (which is why most of the locales that have an ACP of 1252 have an OEMCP of 850 and why most of them wish the had an OEMCP of 858 -- so that their language would be supported well in the console).</p><p>But the alternate keyboard layout that exists for most locales does not provide good support for even the locales that it could, in the console.</p><p>And there is no workaround for this other than using existing layouts or defining your own layouts based on a locale that would actually be useful.</p><p>Yuck.</p><p>And what about the fact that most IMEs and text based TIPs have the underlying 00000409 keyboard underneath them?</p><p>Double yuck.</p><p>Alright, that's enough for now.My heart is not in the task of trying to make people panic. I'll end this trilogy on a much happier note, soon. :-)</p><p>&nbsp;</p><p><font color="#ff00ff"><i>This blog brought to you by</i><font size="7"> ‡¶è </font><i>(<a href="http://www.fileformat.info/info/unicode/char/098f" mce_href="http://www.fileformat.info/info/unicode/char/098f">U+098f</a>, aka BENGALI LETTER E)</i></font> <br></p>
<hr/><p><strong>Yuhong Bao</strong> on 20 Nov 2010 2:17 PM:</p><div style="margin-left: 1em"><p>&quot;most of them wish the had an OEMCP of 858 -- so that their language would be supported well in the console&quot;</p>
<p>Well, IBM instead of creating codepage 858 decided to modify codepage 850 with the same modification. So depending on your version of PC-DOS or OS/2, the same character can be either displayed as a dotless i or an Euro sign.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 20 Nov 2010 7:33 PM:</p><div style="margin-left: 1em"><p>For those still working in PC-DOS or OS/2, that is....</p>
</div>
<p><strong>Yuhong Bao</strong> on 2 Dec 2010 11:08 AM:</p><div style="margin-left: 1em"><p>So why was codepage 858 never considered as an OEMCP for ANY locale? The real Turkish locale actually use codepage 857, BTW.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 2 Dec 2010 1:51 PM:</p><div style="margin-left: 1em"><p>Because we don&#39;t ever change OEMCP values after they are set, and these were set before 858 was added to Windows setup.</p></div>
<p><strong>Yuhong Bao</strong> on 2 Nov 2012 2:26 AM:</p><div style="margin-left: 1em"><p>That is why I said ANY locale. I know there was plenty of new locales added in Win2000, for example.</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/08/28 <a href="http://archives.miloush.net/michkap/archive/2012/08/28/10344043.html">'If it is easy, then there are samples. And if it's very easy, everyone is writing them.'</a></p><p>2008/10/05 <a href="http://archives.miloush.net/michkap/archive/2008/10/05/8977109.html">Can I get your [font]signature on this, please?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/10/01/8971236.html" title="Parents, to be perfectly blunt, suck at names, sometimes">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/09/29/8968429.html" title="The difference between Six Sigma and Sigma Diaresis is one must never fail; the other seems to do so by default">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-10-01">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/10/01/8971160.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>