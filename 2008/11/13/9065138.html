<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/11/13/9065138.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>No need to throw out the baby with the streamwriter; they probably could have just put in a replacement</title></head><body>
<h1>No need to throw out the baby with the streamwriter; they probably could have just put in a replacement</h1>
<p><em>by Michael S. Kaplan, published on 2008/11/13 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/11/13/9065138.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>So anyway, <a href="http://blogs.msdn.com/kimhamil/" mce_href="http://blogs.msdn.com/kimhamil/">Kim</a>'s other recent blog, entitled <a href="http://blogs.msdn.com/kimhamil/archive/2008/11/11/making-a-streamwriter-usable-even-after-given-garbage-characters.aspx" mce_href="http://blogs.msdn.com/kimhamil/archive/2008/11/11/making-a-streamwriter-usable-even-after-given-garbage-characters.aspx">Making a StreamWriter usable even after given garbage characters</a>, highlights an interesting difference some of the methodology between the way that Windows and .Net handle encoding and codepages.</p><p>In Windows (in contrast to the behavior of most NLS API functions, as I have mentioned <b><a href="http://archives.miloush.net/michkap/archive/2005/03/06/386194.html" mce_href="http://archives.miloush.net/michkap/archive/2005/03/06/386194.html">previously</a></b>), the <a href="http://msdn.microsoft.com/library/en-us/intl/unicode_2bj9.asp" title="WideCharToMultiByte" target="_blank">WideCharToMultiByte</a> and <a href="http://msdn.microsoft.com/library/en-us/intl/unicode_17si.asp" title="MultiByteToWideChar" target="_blank">MultiByteToWideChar</a> functions will use the target buffer up until the point of failure, so that in the case of failure you may be able to do something with the partial results.</p><p>Now without a length indication the options of what can be done are more limited, but if nothing else then at least subsequent calls will not be affected by their predecessors.</p><p>.Net, on the other hand, has a default behavior here when you write to the stream that causes the StreamWriter to be useless.</p><p>The description in Kim's blog did not fully explain the problem, so I'll fill in the blank to it. :-)</p><p>She said:</p><blockquote><p><i><font face="times new roman,times">For example, on an attempt to write U+DFC9, which is only half of a Unicode character (not a complete surrogate pair) an EncoderFallbackException was thrown</font></i></p></blockquote><p>Now we have a stream here, so why is the stiry iver? Isn't the point of the stream thing that you can do it in chunks? Why would this be unrecoverable?</p><p>Well, the problem is that <a href="http://www.fileformat.info/info/unicode/char/dfc9" mce_href="http://www.fileformat.info/info/unicode/char/dfc9">U+dfc9</a> is a <b>low surogate</b>. </p><p>See <a href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html">The basics of supplementary</a> for a glossary update here!</p><p>As I mention in <b><a href="http://archives.miloush.net/michkap/archive/2005/07/31/445850.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/31/445850.html">Why do the high surrogates have the low numbers?</a></b> and other places, a surrogate pair is a high surrogate followed by a low surrogate.</p><p>A lone high surrogate is recoverable because it is incomplete.</p><p>But a lone low surrogate with no preceding high surrogate has no place to go, nothing to do -- it is toast unless you have a fallback plan in place, as Kim mentioned.</p><p>Though to be perfectly honest, after situations like that described in <b><a href="http://archives.miloush.net/michkap/archive/2007/09/17/4950277.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/17/4950277.html">The torrents of U+fffd</a></b>, I would much rather have had the default fallback plan be the <a href="http://www.fileformat.info/info/unicode/char/fffd" mce_href="http://www.fileformat.info/info/unicode/char/fffd">U+fffd</a> insertion.</p><p>I'm not a fan of the whole <a href="http://www.fileformat.info/info/unicode/char/fffd" mce_href="http://www.fileformat.info/info/unicode/char/fffd">U+fffd</a> thing, as I pointed out many times before. But given the huge push to change behavior from "drop illegal sequences" to "replace illegal sequences with the replacement character", I think behavior that did not throw in this case would have made for a better default.... </p><p><i>And yes, I know there is a backcompat question here for the behavior, but since behavior was being changed anyway in this "in a service pack" change, there was a good opportunity to take a hard look at changing that default (since even already compiled applications were going to change their behavior</i>!</p><p>&nbsp;</p><p><font color="#ff00ff"><i>This post brought to you by</i> <font size="5">ï¿½</font> 
<i>(<a href="http://www.fileformat.info/info/unicode/char/fffd" class="" mce_href="http://www.fileformat.info/info/unicode/char/fffd">U+fffd</a>, a.k.a. 
REPLACEMENT CHARACTER)</i></font></p>
<hr/><p><strong>MSDNArchive</strong> on 15 Nov 2008 5:11 AM:</p><div style="margin-left: 1em"><p>Excellent! But you've set a dangerous precedent...I may start adding &quot;todo: Michael&quot; notes when I'd rather hand off Unicode explanations to the official Unicode bulldog!</p></div>
<p><strong>MSDNArchive</strong> on 15 Nov 2008 5:12 AM:</p><div style="margin-left: 1em"><p>btw, I wish I'd thought of that title. Right after posting I was actually lamenting my lack of &quot;title flair&quot;</p></div>
<p><strong>Michael S. Kaplan</strong> on 15 Nov 2008 7:27 PM:</p><div style="margin-left: 1em"><p>Well, you and I could occasionally collaborate on titles. :-)</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/11/01 <a href="http://archives.miloush.net/michkap/archive/2010/11/01/10083846.html">The consequences of being unintuitive and nonconformant</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/11/13/9065195.html" title="On reverting unexplained spontaneous alteration of language">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/11/12/9061246.html" title="&quot;We&quot; don&#39;t tell you how to spell *our* language in *yours*, so...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-11-13">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/11/13/9065138.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>