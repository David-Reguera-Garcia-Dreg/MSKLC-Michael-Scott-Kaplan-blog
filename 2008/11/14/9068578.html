<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/11/14/9068578.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When features collide (aka Your LCID sucks, but sometimes the bug sucks more)</title></head><body>
<h1>When features collide (aka Your LCID sucks, but sometimes the bug sucks more)</h1>
<p><em>by Michael S. Kaplan, published on 2008/11/14 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/11/14/9068578.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Regular readers might recall a long ago blog entitled <b><a href="http://archives.miloush.net/michkap/archive/2006/01/31/520694.html" mce_href="http://archives.miloush.net/michkap/archive/2006/01/31/520694.html">New in Vista: What's your name? Who's your daddy?</a></b>,
which talked about the new name-based NLS API functions, intended to
wean people off of their use of LCIDs. Because let's face it, <b><a href="http://archives.miloush.net/michkap/archive/2007/07/23/4021529.html" mce_href="http://archives.miloush.net/michkap/archive/2007/07/23/4021529.html">LCIDs suck</a></b>.</p>

<p>Anyway, it turns out that in one case at least, bugs suck more. <br></p>

<p>Maybe people recall the even earlier blog entitled <b><a href="http://archives.miloush.net/michkap/archive/2005/08/02/446522.html" mce_href="http://archives.miloush.net/michkap/archive/2005/08/02/446522.html">New in Vista Beta 1: more use of the word 'linguistic'</a></b>, which described (among other things) the NORM_LINGUISTIC_CASING flag -- a flag to do <b><a href="http://archives.miloush.net/michkap/archive/2004/12/03/274288.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/03/274288.html">proper casing for Turkic languages</a></b>.<br></p>

<p>Turns out there is a problem getting these two features to work together properly....</p>The bug? 

<p>Well, take the following code in C# (it is a Win32 bug not a C# bug, but this lets us look at the managed case and the native one, which is sometimes relevant; plus in this case, more people can test it out themselves!):</p>

<blockquote>
<p><b><font face="consolas,lucida console,courier new,courier,fixed">using System;<br>using System.Globalization;<br>using System.Runtime.InteropServices;<br><br>class&nbsp; test {<br>&nbsp;&nbsp;&nbsp; static unsafe void Main() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Turkish by name (native)");<br><font color="#ff0000">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("131, \u0049 = " + CompareStringEx("tr-TR", 0x08000010, "\u0131", -1, "\u0049", -1, null, null, 0));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("130, \u0069 = " + CompareStringEx("tr-TR", 0x08000010, "\u0130", -1, "\u0069", -1, null, null, 0));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("\u0069, \u0049 = " + CompareStringEx("tr-TR", 0x08000010, "\u0069", -1, "\u0049", -1, null, null, 0));<br></font>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("English by name (native)");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("131, \u0049 = " + CompareStringEx("en-US", 0x08000010, "\u0131", -1, "\u0049", -1, null, null, 0));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("130, \u0069 = " + CompareStringEx("en-US", 0x08000010, "\u0130", -1, "\u0069", -1, null, null, 0));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("\u0069, \u0049 = " + CompareStringEx("en-US", 0x08000010, "\u0069", -1, "\u0049", -1, null, null, 0));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Turkish by LCID (native)");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("131, \u0049 = " + CompareStringW(0x041f, 0x08000010, "\u0131", -1, "\u0049", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("130, \u0069 = " + CompareStringW(0x041f, 0x08000010, "\u0130", -1, "\u0069", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("\u0069, \u0049 = " + CompareStringW(0x041f, 0x08000010, "\u0069", -1, "\u0049", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("English by LCID (native)");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("131, \u0049 = " + CompareStringW(0x0409, 0x08000010, "\u0131", -1, "\u0049", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("130, \u0069 = " + CompareStringW(0x0409, 0x08000010, "\u0130", -1, "\u0069", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("\u0069, \u0049 = " + CompareStringW(0x0409, 0x08000010, "\u0069", -1, "\u0049", -1));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("CultureInfo Turkey");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureInfo ci;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci = new CultureInfo("tr-TR");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0131", "\u0049", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0130", "\u0069", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0069", "\u0049", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("CI en-US");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ci = new CultureInfo("en-US");<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Name);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0131", "\u0049", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0130", "\u0069", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.CompareInfo.Compare("\u0069", "\u0049", CompareOptions.IgnoreCase));<br>&nbsp;&nbsp;&nbsp; }<br><br>&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll",CharSet=CharSet.Unicode)]<br>&nbsp;&nbsp;&nbsp; static unsafe extern int CompareStringEx(String strLocale, uint dwCmpFlags, String str1, int count1, string str2, int count2,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char* version, char* reserved, int param );&nbsp;&nbsp;&nbsp; <br><br>&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll",CharSet=CharSet.Unicode)]<br>&nbsp;&nbsp;&nbsp; static unsafe extern int CompareStringW(uint Locale, uint dwCmpFlags, string lpString1,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int cchCount1, string lpString2, int cchCount2);<br>}</font></b> <br></p>
</blockquote>

<p>The results?</p>
<blockquote>
<p><font face="consolas,lucida console,courier new,courier,fixed">Turkish by name (native)<br><font color="#ff0000">131, I = 3<br>130, i = 3<br>i, I = 2<br></font>English by name (native)<br>131, I = 3<br>130, i = 3<br>i, I = 2<br><br>Turkish by LCID (native)<br>131, I = 2<br>130, i = 2<br>i, I = 3<br>English by LCID (native)<br>131, I = 3<br>130, i = 3<br>i, I = 2<br><br>CultureInfo Turkey<br>tr-TR<br>0<br>0<br>1<br>CI en-US<br>en-US<br>1<br>1<br>0</font> <br></p>
</blockquote>
<p>The results that are the bug are in red.</p><p>Basically, the NORM_LINGUISTIC_CASING flag feature added in Vista does not work if you use the name-based NLS collation API functions added in Vista.</p><p>Not as bad as the whole <b><a href="http://archives.miloush.net/michkap/archive/2006/09/06/742073.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/06/742073.html">IsSortable() == false? Well, sometimes it may be lying....</a></b> situation since in this case at least it was two different people.</p>

<p>However, that just lets the two people feel a
little better; it doesn't really do anything for someone hit by the bug.</p><p>Thus on a scale of 1 to LAME, as mitigations go, this one is kinda lame. :-)<br></p><p>This is fixed in Windows 7, so I guess that's why we have new versions.</p><p>And I mentioned it here, so I guess that's why we have blogs. :-)</p><p><br></p><p><font color="#ff00ff"><i>This post brought to you by</i><font size="6" face="times new roman,times"> Ä°</font><font size="6"> </font><i>(U+0130, a.k.a. LATIN CAPITAL 
LETTER I WITH DOT ABOVE)</i></font> <br></p>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/11/17/9104690.html" title="Same shit, different decade/century/millennium">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/11/13/9065195.html" title="On reverting unexplained spontaneous alteration of language">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-11-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/11/14/9068578.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>