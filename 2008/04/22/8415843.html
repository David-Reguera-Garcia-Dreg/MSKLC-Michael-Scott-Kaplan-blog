<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/04/22/8415843.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Premature keystroke processing? Don't worry, it happens to everyone....</title></head><body>
<h1>Premature keystroke processing? Don't worry, it happens to everyone....</h1>
<p><em>by Michael S. Kaplan, published on 2008/04/22 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/04/22/8415843.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM><FONT color=#ff0000 size=1>Content of </FONT></EM><A class="" href="http://blogs.msdn.com/michkap" mce_href="http://blogs.msdn.com/michkap"><EM><FONT size=1>Michael Kaplan's personal blog</FONT></EM></A><FONT color=#ff0000 size=1><EM> not approved by Microsoft (see </EM></FONT><A class="" href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html" mce_href="http://archives.miloush.net/michkap/archive/2008/02/28/7934999.html"><EM><FONT size=1>disclaimer</FONT></EM></A><FONT color=#ff0000 size=1><EM>)!<BR></EM></FONT><EM><FONT color=#ff0000 size=1>Regular readers should keep in mind that all I said in <A class="" href="http://archives.miloush.net/michkap/archive/2008/03/30/8340299.html" mce_href="http://archives.miloush.net/michkap/archive/2008/03/30/8340299.html">The End?</A> still applies; the allusion to the X-Files continues for people who understand such references....</FONT></EM></P>
<P>Ben Supnik asked over in the Suggestion Box:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Hi,<BR><BR>Your post on dead key states "Sometimes you *want* to interfere with the keyboard's state buffer" was very helpful in understanding what's going on with ToUnicodeEx.&nbsp; But I have the opposite problem of Sebastien:<BR><BR>I want to be able to calculate the unicode key that is generated by one or more virtual key presses.&nbsp; But I am supporting a legacy API; I need to dispatch this unicode key with the second key press (e.g. in the second WM_KEYDOWN) rather than wait for the WM_CHAR message.&nbsp; Similarly, I need to know when the first WM_KEYDOWN comes in that it is a dead key without waiting for WM_DEADCHAR.<BR><BR>Here's the part that surprises me: when I call ToUnicode with the virtual key code of the dead key (in response to the very first WM_KEYDOWN I get two unicode chars back, typically a repeat of the spacing version of the diacritic.&nbsp; For example: on the first key press of the ^ key on a French keyboard, I get a return of 2 and a buffer with ^^ (a pair of non-spacing circumflexes) when I would have expected to get a return of -1 and a single ^, telling me the circumflex is getting set up.<BR><BR>What am I missing here?&nbsp; It looks like something is calling ToUnicode with my vkey code once before I get the WM_KEYDOWN message, and thus pre-loading the unicode buffer.&nbsp; I don't think I can drain the buffer because when the second (real) key is hit, I'll have drained out my precious dead key state.<BR><BR>Could you please revisit this topic?&nbsp; In particular, what part of the system is looking up my vkey so early that I'm losing my dead key state?&nbsp; Is there any programmatic access to accumulated dead key state?</FONT></P></BLOCKQUOTE>
<P>The post that Ben refers to is <A class="" href="http://archives.miloush.net/michkap/archive/2006/09/10/748775.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/10/748775.html"><STRONG>Sometimes you *want* to interfere with the keyboard's state buffer</STRONG></A>.</P>
<P>The first answer is to the last question asked, an the answer is that there is no way to access that buffer directly.</P>
<P>But let's look a little deeper at the bigger questions here.</P>
<P>One of the changes that happened in Windows is hinted at in the help for <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keydown.asp"><STRONG>WM_KEYDOWN</STRONG></A> and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputmessages/wm_keyup.asp"><STRONG>WM_KEYUP</STRONG></A>:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Windows 2000/XP: Applications must pass wParam to TranslateMessage without altering it at all.</FONT></P></BLOCKQUOTE>
<P>Thinking aloud for a moment...</P>
<P>Why it would be necessary for you to not change the wParam (which contains the virtual key) -- it shouldn't be important to avoid making such a change if the processing is all to come after the TraslateMessage call.</P>
<P>Perhaps if it was doing that lookup or that caching&nbsp;without waiting?</P>
<P>To be honest I am guessing aloud here, and will be forwarding this speculative blog to someone who should know the actual answer and who can explain the difference between them. :-)</P>
<P>But my advice here would be to do the same thing that MSKLC does --it loads up the information contained in the entire keyboard, not only to display all of the information but also to simulate what the keystroke processing code does without being negatively impacted by mixing up the system with multiple sources of&nbsp;<A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode</A>&nbsp;and <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicodeex.asp">ToUnicodeEx</A> type calls....</P>
<P>Although this is a bigger investment upfront, in the long run it is much more maintainable than trying to make queries that&nbsp;can (or apparently in this case, does) negatively impact the state of the buffer.</P>
<P>If one really wants to go down the harder road, that solution is not <EM>too</EM> awful:</P>
<OL>
<LI>Clear the buffer as the previous articles talked about;</LI>
<LI>Call <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicode.asp">ToUnicode</A>/<A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/tounicodeex.asp">ToUnicodeEx</A>&nbsp;with the same key and shift state info again to fill the buffer;</LI>
<LI>Don't touch the buffer again until the next time a keystroke message comes in.</LI></OL>
<P>Now as I said I am going to try to get answers on the question of what is going on here since it appears to violate my (admittedly older) understanding of what happens during keystroke processing, and it was only after testing both of the methods I suggest above that I realized that even if the underlying behaavior <EM>did</EM> change, neither method is broken.</P>
<P>So perhaps the only real bug at this point is in the documentation, which does seem to be a little off now (though I am trying to get my head entirely around how!).</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=5> à¶… </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0d85" mce_href="http://www.fileformat.info/info/unicode/char/0d85">U+0d85</A>, aka SINHALA LETTER AYANNA)</EM></FONT></P>
<hr/><p><strong>Marc Durdin</strong> on 22 Apr 2008 6:52 PM:</p><div style="margin-left: 1em"><p>The AbiWord team did this in an early version - it turned out to be a whole lot of code and never worked 100%. &nbsp;They ended up using TranslateMessage/WM_CHAR for a later version and that was much, much simpler and far more robust.</p>
<p>You could consider testing the return value of TranslateMessage instead:</p>
<p> - Call TranslateMessage to do the WM_*CHAR generation</p>
<p> - If it returns non-zero, peek the message queue for 1 or more WM_*CHAR messages and then handle the set of WM_KEYDOWN + WM_*CHAR together (remembering that a single key can generate more than 1 WM_*CHAR message)</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/04/23/8415969.html" title="On the clipboard, and why sometimes the dumber you are the better you can do">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/04/22/8415727.html" title="Vowel DISharmony?, aka The case of the missing dot">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-04-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/04/22/8415843.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>