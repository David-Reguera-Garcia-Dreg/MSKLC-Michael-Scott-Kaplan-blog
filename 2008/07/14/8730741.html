<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/14/8730741.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On installing and removing fonts, Part 5: The takeaway from that is...</title></head><body>
<h1>On installing and removing fonts, Part 5: The takeaway from that is...</h1>
<p><em>by Michael S. Kaplan, published on 2008/07/14 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/07/14/8730741.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
series: 
<UL>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/02/8681646.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/02/8681646.html"><STRONG>0: A long journey begins with the zeroeth step</STRONG></A> 
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html"><STRONG>1: Do I know you, or some version of you at least?</STRONG></A> 
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/07/8699735.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/07/8699735.html"><STRONG>2: Are you done using me yet?</STRONG></A> 
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/08/8706789.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/08/8706789.html"><STRONG>3: I'll love you forever, or at least for this session.</STRONG></A></LI>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/11/8720555.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/11/8720555.html"><STRONG>4: The easiest part is the addition!</STRONG></A></LI></UL>
<P>It has been quite an odd&nbsp;little series&nbsp;-- initially showing hopelessness than only got worse, then moving into the normal information one might expect.</P>
<P>This blog is going to talk about the half that seen less often than the previous blog about installation -- this one is going to be about <STRONG>font removal</STRONG>.</P>
<P>Why do I claim it is less common when almost every installer has an uninstaller?</P>
<P>Well, frankly, because most fonts are not uninstalled. They are either build into the platform or they are bought or downloaded later. Most of them live out their existence in a random font folder.</P>
<P>But uninstall is important, since it sometimes happens.</P>
<P>Now <A class="" href="http://archives.miloush.net/michkap/archive/2008/07/07/8699735.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/07/8699735.html"><STRONG>Part 2</STRONG></A>&nbsp;and <A class="" href="http://archives.miloush.net/michkap/archive/2008/07/08/8706789.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/08/8706789.html"><STRONG>Part 3</STRONG></A>&nbsp;discuss some of the more difficult aspects of removal. The ones that seem largely intractable.</P>
<P>But we'll deal with those issues as best as we can later.</P>
<P>For now, I'm going to focus on the easier difficult issues....</P>
<P>The process is kind of the reverse of the installation process, not necessarily in this order:</P>
<OL>
<LI>Remove the <STRONG>HKLM\SOFTWARE\Microsoft\Windows[ NT]\CurrentVersion\Fonts</STRONG>&nbsp;entry in the registry that loads the file on session initialization;</LI>
<LI>Call the <A class="" href="http://msdn.microsoft.com/library/ms533925.aspx" mce_href="http://msdn.microsoft.com/library/ms533925.aspx">RemoveFontResource</A> function;</LI>
<LI>Remove the file (or at least try to);</LI>
<LI>Send the <A class="" href="http://msdn.microsoft.com/library/ms533930.aspx" mce_href="http://msdn.microsoft.com/library/ms533930.aspx">WM_FONTCHANGE</A> message so everyone can know now.</LI></OL>
<P>Now all of the problems mentioned before are still around, but there are some interesting additional problems....</P>
<P>For example, did you know that calls to <A class="" href="http://msdn.microsoft.com/library/ms534231aspx" mce_href="http://msdn.microsoft.com/library/ms534231aspx">AddFontResource</A> and <A class="" href="http://msdn.microsoft.com/library/ms533925.aspx" mce_href="http://msdn.microsoft.com/library/ms533925.aspx">RemoveFontResource</A>&nbsp;are ref-counted?</P>
<P>It's true.</P>
<P>And this makes very little sense if you think about it -- refcounting is an attempt to maintain usage information. And for pairs like <A class="" href="http://msdn.microsoft.com/library/ms684175.aspx" mce_href="http://msdn.microsoft.com/library/ms684175.aspx">LoadLibrary</A>/<A class="" href="http://msdn.microsoft.com/library/ms683152.aspx" mce_href="http://msdn.microsoft.com/library/ms683152.aspx">FreeLibrary</A> where the use is bounded and the same&nbsp;process is probably going to make both calls, this makes sense.</P>
<P>But the most typical usage here is an initial call to <A class="" href="http://msdn.microsoft.com/library/ms534231aspx" mce_href="http://msdn.microsoft.com/library/ms534231aspx">AddFontResource</A> on install, with follow-up calls done by GDI on new session starts/reboots in the future, with the font then being available to everyone and with no way to really know if everyone is done yet.</P>
<P>The reference count for the one occasional case where separate calls are made but ignoring the larger issue of the possibility that the font is widely in use seems a bit like a hubcap on a tractor, all things considered.</P>
<P>Does one imagine that a font uninstaller is going to change its mind if it discovered that the font was in use after calling <A class="" href="http://msdn.microsoft.com/library/ms533925.aspx" mce_href="http://msdn.microsoft.com/library/ms533925.aspx">RemoveFontResource</A>?</P>
<P>Well, technically that question is irrelevant -- <A class="" href="http://msdn.microsoft.com/library/ms533925.aspx" mce_href="http://msdn.microsoft.com/library/ms533925.aspx">RemoveFontResource</A>, just like <A class="" href="http://msdn.microsoft.com/library/ms683152.aspx" mce_href="http://msdn.microsoft.com/library/ms683152.aspx">FreeLibrary</A>, does not indicate the difference between decrementing a reference count an the refcount hitting zero -- both function succeed in the exact same way in both cases. And since the font uninstaller is going to remove the font anyway, it actually makes sense to keep calling <A class="" href="http://msdn.microsoft.com/library/ms533925.aspx" mce_href="http://msdn.microsoft.com/library/ms533925.aspx">RemoveFontResource</A>&nbsp;a few more times just for good luck (or until it fails) to do one's best to ensure it is not in use.</P>
<P>This will not help 100% of the time since not all usage it tracked this way. But if you are removing the font anyway it can't hurt (and it might actually help!).</P>
<P>And there is one more removal issue that is worth mentioning... you'll in fact witness me blogging about it tomorrow!</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=5> Ê© </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/02a9" mce_href="http://www.fileformat.info/info/unicode/char/02a9">U+02a9</A>, aka LATIN SMALL LETTER FENG DIGRAPH)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/08 <a href="http://archives.miloush.net/michkap/archive/2008/09/08/8932366.html">On installing and removing fonts, Part 8: Sometimes being selfish makes you more trustworthy</a></p><p>2008/07/30 <a href="http://archives.miloush.net/michkap/archive/2008/07/30/8791285.html">On installing and removing fonts, Part 7: What was the question, exactly?</a></p><p>2008/07/15 <a href="http://archives.miloush.net/michkap/archive/2008/07/15/8732674.html">On installing and removing fonts, Part 6: That's your name? What's your real name? Nah. What was it before you changed it?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/07/14/8730875.html" title="I *do* think it&#39;s Sovereignty Day in Montenegro!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/07/13/8727207.html" title="Developers are really not generally ones for spontanenous make-out sessions (aka Code jocks can talk themselves out of anything)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/14/8730741.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>