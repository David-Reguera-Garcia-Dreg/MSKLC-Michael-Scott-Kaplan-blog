<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/07/8699735.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On installing and removing fonts, Part 2: Are you done using me yet?</title></head><body>
<h1>On installing and removing fonts, Part 2: Are you done using me yet?</h1>
<p><em>by Michael S. Kaplan, published on 2008/07/07 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/07/07/8699735.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous blogs in this series:</P>
<UL>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/02/8681646.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/02/8681646.html"><STRONG>0: A long journey begins with the zeroeth step</STRONG></A></LI>
<LI><A class="" href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html"><STRONG>1: Do I know you, or some version of you at least?</STRONG></A></LI></UL>
<P>This next part of the series is about a phenomenon that I hope most people are unfamiliar with, whether in their personal or professional lives.</P>
<P>In one's professional life, it is&nbsp;usually less than ideal to be in a pure <STRONG>do you want fries with that?</STRONG> kind of situation where there is really nothing beyond where you are being used and for how long. Thus even feeling the question is appropriate to ask is a sign that one&nbsp;might be&nbsp;in the wrong job.</P>
<P>And in one's personal life, it is always a&nbsp;net negative kind of a&nbsp;sign if one is being used, only made slightly less negative if one is aware of it (since one can then change the situation). But the ultimate low point would likely be feeling the title&nbsp;question bubble up.</P>
<P>I won't talk about the few times (<STRONG>very</STRONG> few times) this has come up in my personal life in this blog. Maybe some other day in this Blog. Though holding one's breath waiting might be a poor bet....</P>
<P>Ditto on the professional side of this atomic wedgie inducing fence.</P>
<P>But I'll talk about an aspect of the question that one wants one's code to be able to ask any time one wants to remove or replace a component.</P>
<P>I run across this issue quite a bit with keyboard layouts, and it is even harder to handle when one is dealing with fonts.</P>
<P>The latter is the subject of today's blog (the former might be the subject of some future blog).</P>
<P>So about asking a font whether anyone is still using it....</P>
<P>Ironically, the font is no better off than the two situations I hinted at in the beginning of this blog -- there is really no way to ask the question. There is, quite simply, no way to find out if the font is in use by the system. At all.</P>
<P>The files may not be locked (the various components that use fonts tend to open the file, cache some information like metrics of the font and glyphs, keep weak pointers to other information for easy lookup later, and then closes the file. This all happens very quick, so the odds of the file being in use at the time are not very good; your only real hope if it is in use is that it will not be asking for any glyphs or other information not already cached -- which includes new sizes or other attributes of the same font.</P>
<P>This causes two different somewhat intractable problems:</P>
<P>1) Obviously if one is removing a font that is in use one will have GDI or whomever pointing to something that isn't there. This is really quite unlikely to crash or blue screen because of years of hardening, but it is quite capable of causing strange problems with processes that assume the font is still valid.</P>
<P>2) If you try to install a font and an earlier version of the font has been determined to exist (see <A class="" href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html" mce_href="http://archives.miloush.net/michkap/archive/2008/07/03/8682763.html"><STRONG>Part 1</STRONG></A>&nbsp;for more on the version stuff), there is no way to know if the font is currently in use. If it is then there is no way to know the impact of replacing the font file due to orphaning all of those&nbsp;references to information in the font. </P>
<P>Paul Linnerud relayed in a document an anecdote that helps underscore the consequences of these problems here:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>...were to replace the font file with an updated file, Windows would not be aware of this change and would still assume the cached pointers were valid. If an application attempts to access the font for more glyphs than are cached or withes to change size unexpected results will occur and they may not occur for some period of time. The first time I saw this, the font Tahoma was replaced and was in use by Microsoft Mail. About ½ hour after the font was updated, suddenly all the lower case characters using that font would not display.</EM></FONT></P></BLOCKQUOTE>
<P>There are even worse scenarios you could imagine here, I'm sure. I am quite bullish about the safety aspects here -- the code has been quite throughly hardened here to keep terrible results from happening. But I am not so bullish about potential appearance problems; in fact I am really quite bearish. And the problems are (ironically given the word usage) quite unbearable in many situations.</P>
<P>You may have noticed the interesting&nbsp;consequences of the&nbsp;problems hinted at&nbsp;here&nbsp;occasionally in the past without really attributing a specific cause. A reboot will obviously fix it so I suppose you could just attribute it to @#%&amp;*! Microsoft software and/or operating systems and call it a day. :-)</P>
<P>But the deeper issue remains -- if you remove or replace an installed&nbsp;font file you have no real way to know the potential impact on anything that may have been using or may still be using (or even may plan to use) the font.</P>
<P>Again I will talk about some partial mitigations for all of this in a future blog in this series, as well as some "apparent" solutions that can actually be much worse.</P>
<P>At the core of it all is that any time one can reasonably desire to ask the question <STRONG>Are you done using me yet?</STRONG>, one is in a potentially bad and possibly weird situation until and unless one gets the opportunity to reboot....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This blog brought to you by</EM><FONT size=6> Ƒ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0191" mce_href="http://www.fileformat.info/info/unicode/char/0191">U+0191</A>, aka LATIN CAPITAL LETTER F WITH HOOK)</EM></FONT></P>
<hr/><p><strong>Andrew West</strong> on 7 Jul 2008 10:52 AM:</p><div style="margin-left: 1em"><p>Surely the font installer does not need to know who exactly may or may not be using the font; it just broadcasts the WM_FONTCHANGE message and well-behaved applications will handle it and update their font information accordingly.</p></div>
<p><strong>Michael S. Kaplan</strong> on 7 Jul 2008 11:51 AM:</p><div style="margin-left: 1em"><p>This will come up under partial mitigations (coming soon!). It is &quot;the way&quot; but there are significant problems with it, enough that I would hesitate to place too much stock in the message.... :-)</p>
</div>
<p><strong>John Cowan</strong> on 8 Jul 2008 1:34 AM:</p><div style="margin-left: 1em"><p>The obvious tactic would be to shut down, boot up using a Linux live CD or DVD, and remove or change things on the disk (including the Windows registry) to your heart's content. &nbsp;Make sure to back up whatever you have changed, of course.</p></div>
<p><strong>Michael S. Kaplan</strong> on 8 Jul 2008 2:27 AM:</p><div style="margin-left: 1em"><p>Changing the filesystem and registry from another OS is &quot;obvious&quot;? </p>
<p>In what dictionary can that definition be found? :-)</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/08 <a href="http://archives.miloush.net/michkap/archive/2008/09/08/8932366.html">On installing and removing fonts, Part 8: Sometimes being selfish makes you more trustworthy</a></p><p>2008/07/30 <a href="http://archives.miloush.net/michkap/archive/2008/07/30/8791285.html">On installing and removing fonts, Part 7: What was the question, exactly?</a></p><p>2008/07/15 <a href="http://archives.miloush.net/michkap/archive/2008/07/15/8732674.html">On installing and removing fonts, Part 6: That's your name? What's your real name? Nah. What was it before you changed it?</a></p><p>2008/07/14 <a href="http://archives.miloush.net/michkap/archive/2008/07/14/8730741.html">On installing and removing fonts, Part 5: The takeaway from that is...</a></p><p>2008/07/11 <a href="http://archives.miloush.net/michkap/archive/2008/07/11/8720555.html">On installing and removing fonts, Part 4: The easiest part is the addition!</a></p><p>2008/07/08 <a href="http://archives.miloush.net/michkap/archive/2008/07/08/8706789.html">On installing and removing fonts, Part 3: I'll love you forever, or at least for this session.</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/07/08/8705722.html" title="$string1 =~ s/file/pack/; (aka What the @#%&amp;*! is a language file?, aka Suits to a т)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/07/07/8697885.html" title="The bigger they are, the worse they are when they&#39;re dead?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/07/8699735.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>