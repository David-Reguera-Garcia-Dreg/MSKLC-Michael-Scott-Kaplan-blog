<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/26/8776572.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Don't sneak a BOM in on someone who promises to ignore free space</title></head><body>
<h1>Don't sneak a BOM in on someone who promises to ignore free space</h1>
<p><em>by Michael S. Kaplan, published on 2008/07/26 17:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/07/26/8776572.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM><FONT color=#ff0000>This is not a&nbsp;blog advising terrorists on how to&nbsp;circumvent&nbsp;the efforts of TSA inspectors!</FONT></EM></P>
<P>Developer Sean mentioned:</P>
<BLOCKQUOTE>
<P><EM>Not sure who to address this to, but we just noticed that the wide string conversion functions don’t handle the whitespace Unicode markers (0xfeff).</EM></P></BLOCKQUOTE>
<P>The function where he first noticed the behavior in was in <A class="" href="http://msdn.microsoft.com/library/5k9xb7x1.aspx" mce_href="http://msdn.microsoft.com/library/5k9xb7x1.aspx">wcstoul</A>, a function which clearly describes its whitespace behavior:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">expects nptr to point to a string of the following form:<BR><BR>[whitespace] [{+ | –}] [0 [{ x | X }]] [digits]<BR><BR>A whitespace may consist of space and tab characters, which are ignored...</FONT></P></BLOCKQUOTE>
<P>Okay, so it easy to see why he was expecting it to be ignored, but now leads us to wonder how <A class="" href="http://msdn.microsoft.com/library/5k9xb7x1.aspx" mce_href="http://msdn.microsoft.com/library/5k9xb7x1.aspx">wcstoul</A>&nbsp;is deciding what "whitespace" is -- are they doing a simple check for tab and space?</P>
<P>The great thing about the C Runtime is that the source is right there so anyone can take a look. Let's do that now. The function can be found in VC\crt\src\wcstol.c, and the relevant bit of the function is:</P>
<P><FONT face="courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp; while ( _iswspace_l(c, _loc_update.GetLocaleT()) )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; c = *p++;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* skip whitespace */</STRONG></FONT></P>
<P>Ok, so the function skips the initial whitespace, like it claims to. But <A class="" href="http://www.fileformat.info/info/unicode/char/feff" mce_href="http://www.fileformat.info/info/unicode/char/feff">U+feff</A>, the famous ZERO WIDTH NO-BREAK SPACE, obviously fails this particular test.</P>
<P>It turns out that <A class="" href="http://msdn.microsoft.com/library/y13z34da.aspx" mce_href="http://msdn.microsoft.com/library/y13z34da.aspx">iswspace</A> and its cousins like <A class="" href="http://msdn.microsoft.com/library/y13z34da.aspx" mce_href="http://msdn.microsoft.com/library/y13z34da.aspx">_iswspace_l</A> are using the character property information that comes out of the NLS <A class="" href="http://msdn.microsoft.com/library/ms647481.aspx" mce_href="http://msdn.microsoft.com/library/ms647481.aspx">GetStringTypeW</A> function, which I have talked about <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/31/486870.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/31/486870.html"><STRONG>before</STRONG></A>.</P>
<P>So where does <A class="" href="http://msdn.microsoft.com/library/ms647481.aspx" mce_href="http://msdn.microsoft.com/library/ms647481.aspx">GetStringTypeW</A> decide what is a C1_SPACE or C1_BLANK?</P>
<P>This is something I mentioned last year in <A class="" href="http://archives.miloush.net/michkap/archive/2007/06/11/3230072.html" mce_href="http://archives.miloush.net/michkap/archive/2007/06/11/3230072.html"><STRONG>The difference between C1_SPACE-ing out and drawing a C1_BLANK</STRONG></A>, and clearly from that list you can see that although some space characters are covered there, ZERO WIDTH NO-BREAK SPACE is not -- because Unicode calls it a formating character (general category&nbsp;Cf), not a space -- and NLS goes along with that.</P>
<P>It turns out that the code in question was grabbing its source string from a file that started with a BOM -- which kind of points to the best way to resolve the problem: strip the BOM out since it is a part of the file "envelope" and not a part of its content....</P>
<P mce_keep="true">&nbsp;</P>
<P><EM><FONT color=#ff00ff>This blog brought to you by <A class="" href="http://www.fileformat.info/info/unicode/char/feff" mce_href="http://www.fileformat.info/info/unicode/char/feff">U+feff</A>, aka ZERO WIDTH NO-BREAK SPACE)</FONT></EM></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/01/07 <a href="http://archives.miloush.net/michkap/archive/2009/01/07/9287052.html">Someone please detect if there's a BOM before the plane takes off!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/07/27/8777624.html" title="Doing virtual simulationary keyboard stuff, only for real">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/07/26/8773862.html" title="When the lines get too complex, the characters may go off script">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-07-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/07/26/8776572.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>