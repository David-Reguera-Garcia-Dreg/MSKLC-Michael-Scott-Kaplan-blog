<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/02/03/7413169.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When exactly will we take a hint about all of that keyboard cord cutting stuff?</title></head><body>
<h1>When exactly will we take a hint about all of that keyboard cord cutting stuff?</h1>
<p><em>by Michael S. Kaplan, published on 2008/02/03 10:46 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2008/02/03/7413169.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>If you are a regular reader, you may recall either <A class="" href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html"><STRONG>Cutting the cord while someone else is shoring it up</STRONG></A>&nbsp;or <A class="" href="http://archives.miloush.net/michkap/archive/2007/12/01/6631463.html" mce_href="http://archives.miloush.net/michkap/archive/2007/12/01/6631463.html"><STRONG>Cutting the cord, revisited -- and documenting how to get the job done!</STRONG></A>, or maybe even both. Between them they pretty clearly show how the Text Services Framework has really been supplanting the former glory of </P>
<P>Anyway, in a <A class="" href="http://archives.miloush.net/michkap/archive/2007/12/01/6631463.html#7118788" mce_href="http://archives.miloush.net/michkap/archive/2007/12/01/6631463.html#7118788">comment</A> to that second post, <A class="" href="http://www.dyalog.com/" mce_href="http://www.dyalog.com/">John Daintree</A> noted another problem related to <A class="" href="http://msdn2.microsoft.com/library/ms646305.aspx" mce_href="http://msdn2.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</A>:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hi Michael,<BR><BR>Interesting stuff, thanks for talking through this. &nbsp;What I'm seeing on Vista is that if I call ActivateKeyboardLayout (or LoadKeyboardLayout), to activate an already installed layout, "at some time later" the keyboard reverts back to the default.<BR><BR>What seems to happen is that next time I get to the Message Queue something in msctf.dll (Text Services I guess) switches the layout back (C stack is attached). &nbsp;Do you have any ideas about what could be causing this?<BR><BR>What I've done here is put a breakpoint on a Window proc when it gets a WM_INPUTLANGCHANGE message.<BR><BR>The culprit seems to be:</EM></FONT></P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,courier new,courier" size=1><STRONG>msctf.dll!PostInputLangRequest() &nbsp;+ 0xc9 bytes </STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Thanks for your continued input (pardon the pun),<BR><BR>/john</EM></FONT></P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,Courier New,Courier" size=1><STRONG>&gt; dyalog.exe!Session_wnd_proc(HWND__ * hWnd=0x002608fc, unsigned int msg=0x00000051, unsigned int wParam=0x00000000, long lParam=0x08090809) &nbsp;Line 1879 C<BR>user32.dll!_InternalCallWinProc@20() &nbsp;+ 0x23 bytes <BR>user32.dll!_UserCallWinProcCheckWow@32() &nbsp;+ 0xb3 bytes <BR>user32.dll!_CallWindowProcAorW@24() &nbsp;+ 0x51 bytes <BR>user32.dll!_CallWindowProcW@20() &nbsp;+ 0x1b bytes <BR>dyalog.exe!OwnerProc(HWND__ * hWnd=0x002608fc, unsigned int msg=0x00000051, unsigned int wParam=0x00000000, long lParam=0x08090809) &nbsp;Line 456 C<BR>user32.dll!_InternalCallWinProc@20() &nbsp;+ 0x23 bytes <BR>user32.dll!_UserCallWinProcCheckWow@32() &nbsp;+ 0xb3 bytes <BR>user32.dll!_DispatchClientMessage@20() &nbsp;+ 0x4b bytes <BR>user32.dll!___fnDWORD@4() &nbsp;+ 0x24 bytes <BR>ntdll.dll!_KiUserCallbackDispatcher@12() &nbsp;+ 0x2e bytes <BR>user32.dll!_NtUserActivateKeyboardLayout@8() &nbsp;+ 0xc bytes <BR>msctf.dll!PostInputLangRequest() &nbsp;+ 0xc9 bytes <BR>msctf.dll!SyncActivateAssemblyByAsm() &nbsp;+ 0x1b914 bytes <BR>msctf.dll!SyncActivateAssembly() &nbsp;+ 0x76 bytes <BR>msctf.dll!ActivateAssemblyPostCleanupCallback() &nbsp;+ 0x22 bytes <BR>msctf.dll!CCleanupShared::~CCleanupShared() &nbsp;+ 0x2a bytes <BR>msctf.dll!CCleanupShared::`scalar deleting destructor'() &nbsp;+ 0xd bytes <BR>msctf.dll!CThreadInputMgr::_CleanupContextsWorker() &nbsp;+ 0x69 bytes <BR>msctf.dll!CThreadInputMgr::_CleanupContexts() &nbsp;+ 0x38 bytes <BR>msctf.dll!ActivateAssembly() &nbsp;+ 0xa4 bytes <BR>msctf.dll!SetFocusDIMForAssembly() &nbsp;+ 0x5e bytes <BR>msctf.dll!CThreadInputMgr::_SetFocus() &nbsp;+ 0x133 bytes <BR>msctf.dll!SetDIMFocus() &nbsp;+ 0x55 bytes <BR>msctf.dll!_GetMsgHook() &nbsp;+ 0x4afd bytes <BR>msctf.dll!_TF_Notify@12() &nbsp;+ 0x91 bytes <BR>user32.dll!_CtfHookProcWorker@16() &nbsp;+ 0x21 bytes <BR>user32.dll!_CallHookWithSEH@16() &nbsp;+ 0x21 bytes <BR>user32.dll!___fnHkINLPMSG@4() &nbsp;+ 0x25 bytes <BR>ntdll.dll!_KiUserCallbackDispatcher@12() &nbsp;+ 0x2e bytes <BR>user32.dll!_NtUserGetMessage@16() &nbsp;+ 0xc bytes <BR>user32.dll!_GetMessageW@16() &nbsp;+ 0x2b bytes <BR>dyalog.exe!w3_next_message() &nbsp;Line 848 + 0x10 bytes C<BR>dyalog.exe!MessageLoop(int (void)* readfn=0x00676ed0)</STRONG></FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P mce_keep="true">Now my prior posts I had been mostly focusing on how the Text Services Framework and its changes to the input stack and (let's be frank) the input model affected the loading of <STRONG>Input Method Editors</STRONG>, but John's issue kind of points out a situation where the state that USER32/win32k keeps may not always be consulted by TSF (I guess it thinks that it knows better?).</P>
<P mce_keep="true">Looking at the stack, I am not so eager to blame that <STRONG>msctf.dll!PostInputLangRequest</STRONG> call, though.</P>
<P mce_keep="true">That function has a purpose, and it appears to be succeeding at it, The blame would have to lie with whatever decided that getting this function involved was the answer!</P>
<P mce_keep="true">It appears that there is some component (maybe an input&nbsp;thread?) in TSF that is getting recycled and as a part of its shutdown it seems to be making sure that USER32/win32k have their story right -- so it is setting the input language.</P>
<P mce_keep="true">Clearly this looks like a bug, especially since in this case a clearly documented member of the Win32 API and the lower level input stack has the correct notion of what is going on, and TSF really has no excuse to be changing it.</P>
<P mce_keep="true">And I don't disagree with the assessment that this is a bug.</P>
<P mce_keep="true">But more than that, it seems like those last two posts and this one are successively more encroaching warnings to <STRONG>stop relying on LoadKeyboardLayout</STRONG> and all of the lower level stuff. The higher level TSF component&nbsp;and the model that it provides atop that older model just does not seem quite compatible with the notion of making changes out from under it.</P>
<P mce_keep="true">How many problems do we have to run across before we move on to TSF? Will we delay the migration until we finally get&nbsp;after a future version&nbsp;of Window inspires an&nbsp;MSKB article with a title like <STRONG>LoadKeyboardLayout will physically harm the user</STRONG> or something like that?</P>
<P mce_keep="true">When will all of us (including me) finally get the hint? :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> ред </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0964" mce_href="http://www.fileformat.info/info/unicode/char/0964">U+0964</A>, aka DEVANAGARI DANDA)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2008/02/03/7414197.html" title="A sign that is actually a symptom, and not in Unicode anyway">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2008/02/02/7385461.html" title="[Confusing functionality] + [New features] = [Documentation that can be confusing]">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2008-02-03">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2008/02/03/7413169.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>