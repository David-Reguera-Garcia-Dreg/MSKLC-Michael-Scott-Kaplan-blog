<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2012/08/24/6631463.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:47 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Cutting the cord, revisited -- and documenting how to get the job done!</title></head><body>
<h1>Cutting the cord, revisited -- and documenting how to get the job done!</h1>
<p><em>by Michael S. Kaplan, published on 2007/12/01 19:31 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/12/01/6631463.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Over in the Suggestion Box, John Daintree asks:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">Could you please follow up the missing functionality of LoadKeyboardLayout() on Windows Vista? I need to be able to load a specific layout for my application as the app starts. </FONT></EM></P></BLOCKQUOTE>
<P>The missing functionality in question is I believe what I described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html"><STRONG>Cutting the cord while someone else is shoring it up</STRONG></A>, which is the ability to load IMEs via a call to <A class="" href="http://msdn2.microsoft.com/library/ms646305.aspx" mce_href="http://msdn2.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</A>, partially ameliorated by Office 2007 which adds three of them back:</P>
<LI>Microsoft Pinyin IME 2007 for Simplified Chinese (KLID E0200804) 
<LI>Microsoft Office IME 2007 for Korean (KLID E0200412) 
<LI>Microsoft Office IME 2007 for Japanese (KLID E0200411)</LI>
<P>Perhaps&nbsp;"add" is the wrong word since these three values don't exist in any prior version, but they do enable the <A class="" href="http://msdn2.microsoft.com/library/ms646305.aspx" mce_href="http://msdn2.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</A>-style bootstrapping technique of loading up the&nbsp;appropriate IME....</P>
<P>At the time, I suggested:</P>
<BLOCKQUOTE>
<P><EM>(The question itself is one I'll provide some answers for another time -- since it involves for the IME a </EM><A class="" href="http://archives.miloush.net/michkap/archive/2006/07/13/664497.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/13/664497.html"><STRONG><EM>TSF</EM></STRONG></A><EM> <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/08/26/725670.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/26/725670.html">sample</A></STRONG>!)</EM></P></BLOCKQUOTE>
<P>However, when I looked into creating such a sample, I noticed a topic in MSDN entitled <A class="" href="http://msdn2.microsoft.com/library/ms628994.aspx" mce_href="http://msdn2.microsoft.com/library/ms628994.aspx">Language Bar</A>, which states:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P>An application cannot add items to the language bar; only a text service can add items to the language bar. An application can affect how certain items on the language bar appear.</P></BLOCKQUOTE></BLOCKQUOTE>
<P>This is a clear departure from prior versions, since in the TSF world you have to have the IME "installed" to the Language Bar to make use of it, but the decision to place it in the Language Bar has clearly been moved to be considered a user decision, not an application one (back in the world of doing this via <A class="" href="http://msdn2.microsoft.com/library/ms646305.aspx" mce_href="http://msdn2.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</A>&nbsp;it was obviously an easy application decision)....</P>
<P>With that said, I ma curious about a situation where a user </P>
<UL>
<LI>understands how to use an IME, and</LI>
<LI>expects a certain application to use that IME, yet</LI>
<LI>does not have that IME installed to the Language Bar already?</LI></UL>
<P>And interestingly, switching to an installed IME is an easy operation via an <A class="" href="http://msdn2.microsoft.com/library/ms646289.aspx" mce_href="http://msdn2.microsoft.com/library/ms646289.aspx">ActivateKeyboardLayout</A> call, and the ability to add a keyboard layout or TSF TIP using the same technique as Regional Options does has now been documented, by calling the <A class="" href="http://msdn2.microsoft.com/library/bb847909.aspx" mce_href="http://msdn2.microsoft.com/library/bb847909.aspx">InstallLayoutOrTip</A> function in input.dll.</P>
<P>The latter function call provides the way to directly install or uninstall any keyboard layout or TIP from the Language Bar (it is also the same function that is used by MSKLC 1.4 to support the automatic install and uninstall of keyboard layouts in the automatically provided setup!).</P>
<P>The function takes the same strings as Regional Options unattend does (discussed previously in <A class="" href="http://archives.miloush.net/michkap/archive/2006/09/03/738032.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/03/738032.html"><STRONG>On building a list of keyboards</STRONG></A>).</P>
<P>The technique&nbsp;only works in Vista, Server 2008, and above (the function does not exist downlevel), though this is the only place that the <A class="" href="http://msdn2.microsoft.com/library/ms646305.aspx" mce_href="http://msdn2.microsoft.com/library/ms646305.aspx">LoadKeyboardLayout</A>&nbsp;method is broken, so it is at least a step in right direction in terms of keeping functionality working....</P>
<P>And I will be&nbsp;talking about&nbsp;some of the rest of these now-documented functions (now listed <A class="" href="http://msdn2.microsoft.com/library/ms629036.aspx" mce_href="http://msdn2.microsoft.com/library/ms629036.aspx">here</A> along with&nbsp;previously documented TSF functions!) inupvoming blogs.</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> à²Š </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0c8a" mce_href="http://www.fileformat.info/info/unicode/char/0c8a">U+0c8a</A>, aka KANNADA LETTER UU)</EM></FONT></P>
<hr/><p><strong>John Daintree</strong> on 15 Jan 2008 11:17 AM:</p><div style="margin-left: 1em"><P>Hi Michael,</P>
<P>Interesting stuff, thanks for talking through this. &nbsp;What I'm seeing on Vista is that if I call ActivateKeyboardLayout (or LoadKeyboardLayout), to activate an already installed layout, "at some time later" the keyboard reverts back to the default.</P>
<P>What seems to happen is that next time I get to the Message Queue something in msctf.dll (Text Services I guess) switches the layout back (C stack is attached). &nbsp;Do you have any ideas about what could be causing this?</P>
<P>What I've done here is put a breakpoint on a Window proc when it gets a WM_INPUTLANGCHANGE message.</P>
<P>The culprit seems to be:</P>
<P>msctf.dll!PostInputLangRequest() &nbsp;+ 0xc9 bytes </P>
<P>Thanks for your continued input (pardon the pun),</P>
<P>/john</P>
<P><FONT face="Consolas,Lucida Console,Courier New,Courier">&gt; dyalog.exe!Session_wnd_proc(HWND__ * hWnd=0x002608fc, unsigned int msg=0x00000051, unsigned int wParam=0x00000000, long lParam=0x08090809) &nbsp;Line 1879 C<BR>user32.dll!_InternalCallWinProc@20() &nbsp;+ 0x23 bytes <BR>user32.dll!_UserCallWinProcCheckWow@32() &nbsp;+ 0xb3 bytes <BR>user32.dll!_CallWindowProcAorW@24() &nbsp;+ 0x51 bytes <BR>user32.dll!_CallWindowProcW@20() &nbsp;+ 0x1b bytes <BR>dyalog.exe!OwnerProc(HWND__ * hWnd=0x002608fc, unsigned int msg=0x00000051, unsigned int wParam=0x00000000, long lParam=0x08090809) &nbsp;Line 456 C<BR>user32.dll!_InternalCallWinProc@20() &nbsp;+ 0x23 bytes <BR>user32.dll!_UserCallWinProcCheckWow@32() &nbsp;+ 0xb3 bytes <BR>user32.dll!_DispatchClientMessage@20() &nbsp;+ 0x4b bytes <BR>user32.dll!___fnDWORD@4() &nbsp;+ 0x24 bytes <BR>ntdll.dll!_KiUserCallbackDispatcher@12() &nbsp;+ 0x2e bytes <BR>user32.dll!_NtUserActivateKeyboardLayout@8() &nbsp;+ 0xc bytes <BR>msctf.dll!PostInputLangRequest() &nbsp;+ 0xc9 bytes <BR>msctf.dll!SyncActivateAssemblyByAsm() &nbsp;+ 0x1b914 bytes <BR>msctf.dll!SyncActivateAssembly() &nbsp;+ 0x76 bytes <BR>msctf.dll!ActivateAssemblyPostCleanupCallback() &nbsp;+ 0x22 bytes <BR>msctf.dll!CCleanupShared::~CCleanupShared() &nbsp;+ 0x2a bytes <BR>msctf.dll!CCleanupShared::`scalar deleting destructor'() &nbsp;+ 0xd bytes <BR>msctf.dll!CThreadInputMgr::_CleanupContextsWorker() &nbsp;+ 0x69 bytes <BR>msctf.dll!CThreadInputMgr::_CleanupContexts() &nbsp;+ 0x38 bytes <BR>msctf.dll!ActivateAssembly() &nbsp;+ 0xa4 bytes <BR>msctf.dll!SetFocusDIMForAssembly() &nbsp;+ 0x5e bytes <BR>msctf.dll!CThreadInputMgr::_SetFocus() &nbsp;+ 0x133 bytes <BR>msctf.dll!SetDIMFocus() &nbsp;+ 0x55 bytes <BR>msctf.dll!_GetMsgHook() &nbsp;+ 0x4afd bytes <BR>msctf.dll!_TF_Notify@12() &nbsp;+ 0x91 bytes <BR>user32.dll!_CtfHookProcWorker@16() &nbsp;+ 0x21 bytes <BR>user32.dll!_CallHookWithSEH@16() &nbsp;+ 0x21 bytes <BR>user32.dll!___fnHkINLPMSG@4() &nbsp;+ 0x25 bytes <BR>ntdll.dll!_KiUserCallbackDispatcher@12() &nbsp;+ 0x2e bytes <BR>user32.dll!_NtUserGetMessage@16() &nbsp;+ 0xc bytes <BR>user32.dll!_GetMessageW@16() &nbsp;+ 0x2b bytes <BR>dyalog.exe!w3_next_message() &nbsp;Line 848 + 0x10 bytes C<BR>dyalog.exe!MessageLoop(int (void)* readfn=0x00676ed0) &nbsp; </FONT></P></div>
<p><strong>Michael S. Kaplan</strong> on 15 Jan 2008 1:12 PM:</p><div style="margin-left: 1em"><P>Okay, that issue goes a little beyond the scope of what I was trying to cover here, so I moved it over to the suggestion box, <A class="" href="http://archives.miloush.net/michkap/archive/2007/07/29/4120528.html#7119166"><STRONG>here</STRONG></A>....</P></div>
<p><strong>john daintree</strong> on 17 Jan 2008 6:11 AM:</p><div style="margin-left: 1em"><p>OK, I guessed as much. Thanks.</p></div>
<p><strong>Jon Fullerton</strong> on 24 Aug 2012 9:53 AM:</p><div style="margin-left: 1em"><p>Michael,</p>
<p>I&#39;m trying to use InstallLayoutOrTip to install Tips for the current user, but they seem to only go to local machine. &nbsp;Can you provide a sample of the correct calling convention to have it apply to the current user. &nbsp;From the above discussion I&#39;m unclear on how you use ActivateKeyboardLayout if it is not proceeded by LoadKeyboardLayout.</p>
<p>Thanks,</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/08/28 <a href="http://archives.miloush.net/michkap/archive/2012/08/28/10344043.html">'If it is easy, then there are samples. And if it's very easy, everyone is writing them.'</a></p><p>2012/08/27 <a href="http://archives.miloush.net/michkap/archive/2012/08/27/10343714.html">When functions don't do what you want them to...</a></p><p>2008/05/23 <a href="http://archives.miloush.net/michkap/archive/2008/05/23/8537281.html">When the LANGID in the LOWORD of the KLID doesn't match the LANGID you want keyboard under?</a></p><p>2008/02/03 <a href="http://archives.miloush.net/michkap/archive/2008/02/03/7413169.html">When exactly will we take a hint about all of that keyboard cord cutting stuff?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/12/01/6632929.html" title="A whole new spin on the term &#39;Vertical markets&#39; (aka in SiaO we trust?)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/11/30/6624125.html" title="It&#39;s like PowerToys for language geeks!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12-01">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2012/08/24/6631463.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:47 GMT -->
</html>