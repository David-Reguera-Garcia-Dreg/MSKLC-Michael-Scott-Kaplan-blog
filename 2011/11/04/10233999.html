<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/11/04/10233999.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The evolving Story of Locale Support, part 4 (working beyond one's bugs, and the case for an MSKLC update)</title></head><body>
<h1>The evolving Story of Locale Support, part 4 (working beyond one's bugs, and the case for an MSKLC update)</h1>
<p><em>by Michael S. Kaplan, published on 2011/11/04 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2011/11/04/10233999.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Previous blogs from this series:</p>
<ul>
<li><strong><a title="part 0 (The introduction)" href="http://archives.miloush.net/michkap/archive/2011/10/31/10231661.html">part 0 (The introduction)</a></strong></li>
<li><strong><a title="part 1 (Some people don't want to double-d's)" href="http://archives.miloush.net/michkap/archive/2011/11/01/10232070.html">part 1 (Some people don't want to double-d's)</a></strong></li>
<li><strong><a title="part 2 (raising the roof on keyboards)" href="http://archives.miloush.net/michkap/archive/2011/11/02/10232468.html">part 2 (raising the roof on keyboards)</a></strong>&nbsp;</li>
<li><strong><a title="part 3 (working beyond one's bugs, the setup)" href="http://archives.miloush.net/michkap/archive/2011/11/03/10233591.html">part 3 (working beyond one's bugs, the setup)</a>&nbsp;</strong></li>
</ul>
<p>Now the net effect of Part 3 was a whole lot of nothing -- I mean, I&nbsp;pointed out&nbsp;a bug, I claimed to be the person who essentially introduced it, and I apologized for it. I didn't explain what was going on or even give hints as to what the next step would be.</p>
<p>Sorry about that....</p>
<p>Anyway, we'll start over.</p>
<p>That mail&nbsp;Frank Grie&szlig;hammer of Adobe sent me?</p>
<p style="padding-left: 60px;"><em>Michael, Maybe you remember &ndash; I asked you some questions once before &ndash; most of which I could actually deal with myself. </em><br /><br /><em>I have been creating a bunch of keyboard layouts for Windows and Mac, to be shipped with the Adobe Pi fonts. The motivation behind this project is providing the user with a method to &lsquo;key&rsquo; their symbol glyphs. The layouts were created for the Mac first, the XML was converted to a .klc file using a Python script, the final layout being compiled with MS Keyboard Layout Creator. In the process, I made the following observation, which might be interesting material for your blog: </em><br /><br /><em>As of Unicode 5, Unicode values with 5 digits exist. Both Mac and Windows have (at least) four possible shift states for keyboards, I kept them unified across the platforms: &lsquo;alt&rsquo; on the Mac would become &lsquo;altGr&rsquo; on Windows (e.g. the right &lsquo;alt&rsquo;-key). </em><br /><br /><em>The observation I made has to do with the altGr/altGr+Shift states: If there is a 5-digit unicode value mapped to a key in either of those states, the respective key just won&rsquo;t return anything on Windows. I filed a bug with your colleagues, and in a long email conversation we came down to the point that unicode support in the OS is &ndash; to say the least &ndash; leaving a lot to desire. It&rsquo;s broken. We could rule out MSKLC being the culprit, it really came down to the OS. By the way: I tested my example layout on a developer version of Windows 8 as well, and the same problem exists. </em><br /><br /><em>Now here&rsquo;s my question: Do you maybe have an explanation for that? I see your latest post is about keyboards, so that might fit in just nicely. </em><br /><br /><em>Best greetings, </em><br /><em>Frank Grie&szlig;hammer </em><br /><em>Type Design &amp; Font Production </em><br /><em>Adobe Systems</em></p>
<p>I could make some minor corrections -- like supplementary characters were first introduced in Unicode 3.1, not 5.0. But that's not the point.</p>
<p>I could point out that as bad as Microsoft may be for not properly supporting a Unicode <span style="color: #999999; text-decoration: line-through;"><span style="text-decoration: line-through;">5.0</span></span>3.1 feature, but Adobe was not properly supporting a Unicode 2.0 feature (ref: <strong><a title="Beauty isn't only glyph deep" href="http://archives.miloush.net/michkap/archive/2010/07/06/10031112.html">Beauty isn't only glyph deep</a></strong>), but that's not the point either. :-)</p>
<p>The point is one of the main feature additions in KBDUTOOL.EXE is the ability to define supplementary characters in the <strong>LAYOUT</strong> table of the .KLC file, which the tool then converts to surrogate pairs and adds them to the <strong>LIGATURE</strong> table. Which is where supplementary characters work - by defining surrogate pairs in the&nbsp;<strong>LIGATURE</strong> table.</p>
<p>Here is where the bug comes in.</p>
<p>When the .KLC file defines supplementary characters in the L<strong>AYOUT</strong> table in any state other than the <strong>BASE</strong> or <strong>SHIFT</strong> states, the supplementary characters are not properly converted to surrogate pairs. So those keys won't work properly.</p>
<p>This is the bug that Frank was reporting.</p>
<p>Now MSKLC.EXE does not have UI for a ligature table -- it just lets you define up to four UTF-16 code units on a key and any time 2, 3, or 4 are defined on a key, it adds them to the <strong>LIGATURE</strong> table.</p>
<p>Now before you decide to just convert the supplementary characters to surrogate pairs yourself, there is an <strong>MSKLC</strong>&nbsp;feature that automatically converts surrogate pairs to supplementary characters.</p>
<p>So you can't ever save the file in <strong>MSKLC.EXE</strong>, because it is designed to do something that exacerbates the problem in <strong>KBDUTOOL.EXE</strong>.</p>
<p>The only way to define these characters is to calculate the surrogate pairs and add them to the <strong>LIGATURE</strong> table directly, and then run <strong>KBDUTOOL.EXE</strong> from the command line to generate the various layout DLLs for the different platform architectures.</p>
<p>This is pretty awful, and I'm a little embarrassed no one found this bug.</p>
<p>I'm even more embarrassed that <strong>I</strong> never found this bug.</p>
<p>For Frank (who is generating his <strong>.KLC</strong> files from a Python script, the problem is slightly less onerous to deal with, though it is still ugly.</p>
<p>For a look the syntax, you can create some actual <strong>LIGATURE</strong> entries and see the syntax <strong>MSKLC.EXE</strong> uses for the table:</p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">SHIFTSTATE</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">0&nbsp;//Column 4</span></strong><br /><strong><span style="font-family: courier new,courier;">1&nbsp;//Column 5 : Shft</span></strong><br /><strong><span style="font-family: courier new,courier;">2&nbsp;//Column 6 :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ctrl</span></strong><br /><strong><span style="font-family: courier new,courier;">6&nbsp;//Column 7 :&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ctrl Alt</span></strong><br /><strong><span style="font-family: courier new,courier;">7&nbsp;//Column 8 : Shft&nbsp; Ctrl Alt</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">LAYOUT&nbsp;&nbsp;;an extra @ at the end is a dead key</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">//SC&nbsp;VK_&nbsp;&nbsp;Cap&nbsp;0&nbsp;1&nbsp;2&nbsp;6&nbsp;7</span></strong><br /><strong><span style="font-family: courier new,courier;">//--&nbsp;----&nbsp;&nbsp;----&nbsp;----&nbsp;----&nbsp;----&nbsp;----&nbsp;----</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">29&nbsp;&nbsp;&nbsp; OEM_3&nbsp;&nbsp;&nbsp;0&nbsp; %%&nbsp;&nbsp; %%&nbsp;&nbsp; -1 &nbsp;%% &nbsp;%%&nbsp;&nbsp;// &lt;null&gt;, &lt;null&gt;, &lt;none&gt;, &lt;null&gt;, &lt;null&gt;</span></strong><br /><strong><span style="font-family: courier new,courier;">39&nbsp;&nbsp;&nbsp; SPACE&nbsp;&nbsp;&nbsp;0&nbsp; 0020&nbsp;0020&nbsp;-1&nbsp; -1 &nbsp;-1&nbsp;&nbsp;// SPACE, SPACE, &lt;none&gt;, &lt;none&gt;, &lt;none&gt;</span></strong><br /><strong><span style="font-family: courier new,courier;">53&nbsp;&nbsp;&nbsp; DECIMAL&nbsp;0&nbsp; 002e&nbsp;002e&nbsp;-1&nbsp; -1 &nbsp;-1&nbsp;&nbsp;// FULL STOP, FULL STOP, , ,</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">LIGATURE</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;">//VK_&nbsp;Mod#&nbsp;Char0&nbsp;Char1&nbsp;Char2&nbsp;Char3</span></strong><br /><strong><span style="font-family: courier new,courier;">//----&nbsp;&nbsp;----&nbsp;----&nbsp;----&nbsp;----&nbsp;----</span></strong></p>
<p style="padding-left: 60px;"><strong><span style="font-family: courier new,courier;"></span></strong><strong><span style="font-family: courier new,courier;">OEM_3&nbsp;&nbsp;0&nbsp;0041&nbsp;0041&nbsp;&nbsp;// LATIN CAPITAL LETTER A + LATIN CAPITAL LETTER A</span></strong><br /><strong><span style="font-family: courier new,courier;">OEM_3&nbsp;&nbsp;1&nbsp;0042&nbsp;0042&nbsp;&nbsp;// LATIN CAPITAL LETTER B + LATIN CAPITAL LETTER B</span></strong><br /><strong><span style="font-family: courier new,courier;">OEM_3&nbsp;&nbsp;3&nbsp;0043&nbsp;0043&nbsp;&nbsp;// LATIN CAPITAL LETTER C + LATIN CAPITAL LETTER C</span></strong><br /><strong><span style="font-family: courier new,courier;">OEM_3&nbsp;&nbsp;4&nbsp;0044&nbsp;0044&nbsp;&nbsp;// LATIN CAPITAL LETTER D + LATIN CAPITAL LETTER D</span></strong></p>
<p>&nbsp;Obviously only the <strong>ALTGR</strong> and <strong>SHIFT+ALTGR</strong> states will need this done, but I defined a single ligature in all four states so you can see the syntax.</p>
<p>For the syntax of <strong>KBDUTOOL.EXE</strong>, you can see other blogs I've done before like <strong><a title="In case you have a yen to extend your keyboard (or at least want a yen?)" href="http://archives.miloush.net/michkap/archive/2006/09/26/771554.html">In case you have a yen to extend your keyboard (or at least want a yen?)</a></strong>.</p>
<p>For the record, I consider this a <strong>must fix</strong> bug in <strong>MSKLC</strong>, or more specifically the <strong>KBDUTOOL.EXE</strong> binary that is within the <strong>MSKLC</strong> package.</p>
<p>In fact, I think between this bug and the need to remove enough of the IA64 support to shrink the download and created setup package size (discussed in <strong><a title="Still with the Itanium?" href="http://archives.miloush.net/michkap/archive/2010/11/20/10094190.html">Still with the Itanium?</a></strong>), and the bug discussed in <strong><a title="A picture that *still* can't be easily described with words" href="http://archives.miloush.net/michkap/archive/2010/06/24/10028177.html">A picture that *still* can't be easily described with words</a></strong>, someone really ought to do a little dev work and release a tiny update --&nbsp;<strong>MSKLC 1.5</strong>!</p>
<p>Now in the interests of turning this blog post into a mini "IStartedSomething.com" type issue, does anyone agree with me that these three bugs are worh fixing? Yes they can all be worked around, but they all suck IMNSHO.</p>
<p><em>Okay, and now with that said this series is officially off track (assuming I am not given the job to fix&nbsp;MSKLC!), so in the next part, I'll return to topic....</em></p>
<hr/><p><strong>Doug Ewell</strong> on 4 Nov 2011 7:22 AM:</p><div style="margin-left: 1em"><p>So since you&#39;ve told us 538 times now that you are no longer responsible for updating MSKLC, how do we get hold of the people who are?</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 4 Nov 2011 8:27 AM:</p><div style="margin-left: 1em"><p>It actually isn&#39;t clear (to me, at least!) who the owners are, at this point. Which makes pointing out the need all the more important (it&#39;s how I got our GM to approve 1.4, overruling the decision of the leads)....</p></div>
<p><strong>Michael S. Kaplan</strong> on 4 Nov 2011 8:57 AM:</p><div style="margin-left: 1em"><p>And of course the question remains -- do you believe it&#39;s worth doing the work?</p>
</div>
<p><strong>Van</strong> on 5 Nov 2011 1:55 AM:</p><div style="margin-left: 1em"><p>Yes, I believe it is worth updating MSKLC to handle surrogates in AltGr shift states (and removing IA64/fixing the blank window problems). I also believe it is worth updating MSKLC to at least not remove, and if possible support chained dead keys.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 5 Nov 2011 12:45 PM:</p><div style="margin-left: 1em"><p>Hey Van -- Supporting chained dead keys is a whole different kettle of fish, and the UI changes that would be required are decidedly non-trivial....</p>
</div>
<p><strong>Van</strong> on 5 Nov 2011 10:48 PM:</p><div style="margin-left: 1em"><p>That&#39;s why I wrote that it should at least not remove chained dead keys. The ideal would be that you could generate them within MSKLC, but the fact that the program actively strips previously defined chained dead key definitions from files that it opens is decidedly non-user-friendly. That should be fixed, even if we aren&#39;t going to get a little dead key checkbox and ... button in the dead key dialogue.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 6 Nov 2011 12:45 AM:</p><div style="margin-left: 1em"><p>The trouble is that it only can save what it can read; and making it able to read them is complicated....</p></div>
<p><strong>Andrew_Cunningham</strong> on 6 Nov 2011 3:41 PM:</p><div style="margin-left: 1em"><p>I&#39;d like to see an update of MSKLC.</p>
</div>
<p><strong>Andrew West</strong> on 7 Nov 2011 7:06 AM:</p><div style="margin-left: 1em"><p>We&#39;d all like to see an update to MSKLC. &nbsp;If MS doesn&#39;t feel it is worthwhile continuing to support this tool maybe they should just release the source code and let the user community do the dirty work (yeah, I know this is never going to happen). </p>
</div>
<p><strong>Michael S. Kaplan</strong> on 7 Nov 2011 7:21 AM:</p><div style="margin-left: 1em"><p>It isn&#39;t a matter of &quot;worth it&quot; per se -- since the tool is central to how we support keyboards ourselves. It just the resources to update it that are the tricky part. The open source route seems highly unlikely, though....</p>
</div>
<p><strong>Matthew Slyman</strong> on 16 Apr 2013 11:09 PM:</p><div style="margin-left: 1em"><p>@MichaelKaplan:</p>
<p>&gt; &quot;The trouble is that it only can save what it can read; and making it able to read them is complicated....&quot;</p>
<p>So, read them as a plain string, and write them as a plain string. Beginners won&#39;t notice the dummy &quot;functionality&quot; is there. And advanced users (who will have put those annotations there on purpose) won&#39;t curse MSKLC for stripping them out!</p>
<p>At least, one might have an option in a MSKLC v1.4b, to NOT strip out the extra chained dead key information?</p>
</div>
<p><strong>Matthew Slyman</strong> on 16 Apr 2013 11:28 PM:</p><div style="margin-left: 1em"><p>@MichaelKaplan: Will you put me in touch with Frank Griesshammer please? I&#39;ve been looking for ways to bridge the gap between .KLC and Apple&#39;s XML-based format (that I haven&#39;t studied much yet). I&#39;m developing a range of new keyboard layouts that I hope to propose/promote as a new international standard. (Perhaps naive of me, but what would the world be like without crazy people like me?)</p>
<p><a rel="nofollow" target="_new" href="http://xkcd.com/927/">http://xkcd.com/927/</a></p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2013/04/17 <a href="http://archives.miloush.net/michkap/archive/2013/04/17/10411861.html">One of these days you'll want to stand back, as I am working to ARM myself with another Surface RT!</a></p><p>2013/03/11 <a href="http://archives.miloush.net/michkap/archive/2013/03/11/10400818.html">That MSKLC with a jailbroken Surface RT thing? I dared to disturb the universe, and...</a></p><p>2012/10/26 <a href="http://archives.miloush.net/michkap/archive/2012/10/26/10362603.html">The evolving Story of Locale Support, part 28: We finally fixed that 'Install New Languages' thing!</a></p><p>2012/10/02 <a href="http://archives.miloush.net/michkap/archive/2012/10/02/10354988.html">The evolving Story of Locale Support, part 27: No, the T and the H aren't silent...</a></p><p>2012/08/20 <a href="http://archives.miloush.net/michkap/archive/2012/08/20/10341516.html">The evolving Story of Locale Support, part 26: Hey Windows 8, there's someone on the phone for you.</a></p><p>2012/07/30 <a href="http://archives.miloush.net/michkap/archive/2012/07/30/10334641.html">2nd amendment issues don't apply; I'm not ARMed!</a></p><p>2012/07/11 <a href="http://archives.miloush.net/michkap/archive/2012/07/11/10327775.html">The evolving Story of Locale Support, part 25: Something old, something new, something repurposed, and something...</a></p><p>2012/06/07 <a href="http://archives.miloush.net/michkap/archive/2012/06/07/10316511.html">The evolving Story of Locale Support, part 24: I Adar you! Hell, I Double Adar you! (Windows 8 ed.)</a></p><p>2012/06/05 <a href="http://archives.miloush.net/michkap/archive/2012/06/05/10315033.html">The evolving Story of Locale Support, part 23: Tamazight? Outta sight!</a></p><p>2012/04/12 <a href="http://archives.miloush.net/michkap/archive/2012/04/12/10292952.html">The evolving Story of Locale Support, part 22: Digit Substitution 2.0</a></p><p>2012/03/08 <a href="http://archives.miloush.net/michkap/archive/2012/03/08/10278921.html">The evolving Story of Locale Support, part 21: The Windows 8 Hijripalooza extraordinaire!</a></p><p>2012/03/02 <a href="http://archives.miloush.net/michkap/archive/2012/03/02/10276258.html">The evolving Story of Locale Support, part 20: Yes, it's Bangla. Not Bengali!</a></p><p>2012/02/21 <a href="http://archives.miloush.net/michkap/archive/2012/02/21/10270502.html">The evolving Story of Locale Support, part 19: In honor of International Mother Language Day...</a></p><p>2012/02/15 <a href="http://archives.miloush.net/michkap/archive/2012/02/15/10268235.html">The evolving Story of Locale Support, part 18: Two scripts that share ten digits can be trouble</a></p><p>2012/02/02 <a href="http://archives.miloush.net/michkap/archive/2012/02/02/10263136.html">The evolving Story of Locale Support, part 17: Today I feel like translating you more than before</a></p><p>2012/01/24 <a href="http://archives.miloush.net/michkap/archive/2012/01/24/10259941.html">The evolving Story of Locale Support, part 16: We can't scale to a Xishuangbanna Dai locale, but…</a></p><p>2012/01/17 <a href="http://archives.miloush.net/michkap/archive/2012/01/17/10256884.html">The evolving Story of Locale Support, part 15: Fixing our listings up in Windows 8!</a></p><p>2011/12/23 <a href="http://archives.miloush.net/michkap/archive/2011/12/23/10250600.html">What I'd do with my 'Microsoft 20% time'</a></p><p>2011/12/22 <a href="http://archives.miloush.net/michkap/archive/2011/12/22/10250349.html">The evolving Story of Locale Support, part 14: Tifinagh, Tamazight, and Berber? Oh my!</a></p><p>2011/12/21 <a href="http://archives.miloush.net/michkap/archive/2011/12/21/10249983.html">The evolving Story of Locale Support, part 13: Divvying up locales, yet again!</a></p><p>2011/12/09 <a href="http://archives.miloush.net/michkap/archive/2011/12/09/10246051.html">The evolving Story of Locale Support, part 12: Logic dictates that we keep a sense of proportion about the RATIO</a></p><p>2011/11/23 <a href="http://archives.miloush.net/michkap/archive/2011/11/23/10240896.html">The evolving Story of Locale Support, part 11: What language is that keyboard for?</a></p><p>2011/11/22 <a href="http://archives.miloush.net/michkap/archive/2011/11/22/10239572.html">The evolving Story of Locale Support, part 10: Perhaps it is best to think of it as unintelligent design?</a></p><p>2011/11/16 <a href="http://archives.miloush.net/michkap/archive/2011/11/16/10237715.html">The evolving Story of Locale Support, part 9: Nastaleeq vs. Nastaliq? Either way, Windows 8 has got it!</a></p><p>2011/11/15 <a href="http://archives.miloush.net/michkap/archive/2011/11/15/10237317.html">The evolving Story of Locale Support, part 8: [Finally] taking care of some [more] languages in Pakistan</a></p><p>2011/11/11 <a href="http://archives.miloush.net/michkap/archive/2011/11/11/10236194.html">The evolving Story of Locale Support, part 7: That would be a "call and a raise" for Hawaiian</a></p><p>2011/11/09 <a href="http://archives.miloush.net/michkap/archive/2011/11/09/10235391.html">The evolving Story of Locale Support, part 6: Behind the Cherokee Phonetic layout in Windows 8</a></p><p>2011/11/08 <a href="http://archives.miloush.net/michkap/archive/2011/11/08/10234995.html">The evolving Story of Locale Support, part 5 (...until the decision was made to not refuse to add it)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2011/11/07/10234592.html" title="Unicode in the console (including STDIN)?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2011/11/03/10233591.html" title="The evolving Story of Locale Support, part 3 (working beyond one&#39;s bugs, the setup)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-11-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/11/04/10233999.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>