<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/05/19/10166285.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How do I find out what state you're in?</title></head><body>
<h1>How do I find out what state you're in?</h1>
<p><em>by Michael S. Kaplan, published on 2011/05/19 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2011/05/19/10166285.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, John asked:</p>
<p style="padding-left: 60px;"><em><span style="font-family: times new roman,times; font-size: medium;">I'm trying to figure out how to get (and possibly change) the IME state of the active window, like the language bar does.&nbsp; Assume for the moment that I only need to support TSF.&nbsp; Is there a reasonable (a.k.a., will probably continue to work in the future) way to accomplish this?</span></em></p>
<p style="padding-left: 60px;"><em><span style="font-family: times new roman,times; font-size: medium;">The only thing I've been able to find in the TSF docs that seems potentially of interest is ITfLangBarMgr::GetThreadLangBarItemMgr.&nbsp; I'm somewhat concerned that the only documentation MSDN provides for this function is "Should not be used."&nbsp; I've tried calling it, but it only seems to work if I pass the thread ID of my own thread; otherwise I get "The RPC server is unavailable. (Exception from HRESULT: 0x800706BA)".&nbsp; Can this function be made to work, is there a better way, or is there no good way to do this?</span></em></p>
<p>Now the Language Bar does its magic in what most reasonable people would consider to be an extreme way -- it puts itself in every thread (well, technically every threadgroup) so that it can make changes from any input thread, if need be.</p>
<p>Many "internal" Text Services Framework methods like <a href="http://msdn.microsoft.com/library/ms628756.aspx">ITfLangBarMgr::GetThreadLangBarItemMgr</a>&nbsp;that work differently within one's own thread than outside of it -- because they are helper classes and methods designed to be used by that code that lives in every threadgroup to keep the central code behind the language bar up to date.</p>
<p>Others, such as this one, are actually not internal so much as meant to be used by actual text services like IMEs that need to do things to update the language bar based on their own state. thus it won't really work very well unless you can manage to be in each threadgroup that might need the information.</p>
<p>However, this does not mean there is no hope!</p>
<p>For starters there is IMM32 way (i.e. <a href="http://msdn.microsoft.com/library/en-us/intl/ime_8jzn.asp">ImmGetConversionStatus</a>&nbsp;and <a href="http://msdn.microsoft.com/library/en-us/intl/ime_5j8z.asp">ImmSetConversionStatus</a>) that can help here.... </p>
<p>But let's look more to the services TSF provides for <a href="http://msdn.microsoft.com/library/ms538049.aspx">Applications</a>, specifically the <a href="http://msdn.microsoft.com/library/ms628994.aspx">Language Bar</a>&nbsp;services. Although the examples on that page talking about speech are misleadingly unhelpful, the GUID_COMPARTMENT_* links from that page point to the <a href="http://msdn.microsoft.com/library/ms629013.aspx">Predefined Compartments</a>&nbsp;page which has several promising compartments like <strong>GUID_COMPARTMENT_KEYBOARD_INPUTMODE_CONVERSION</strong> and <strong>GUID_COMPARTMENT_KEYBOARD_INPUTMODE_SENTENCE</strong>, and these compartments are actually about as useful as they sound and more so. :-)</p>
<p>At some point I'll have to put together a sample using these, though Eric Brown in <a href="http://blogs.msdn.com/b/tsfaware/archive/2007/05/30/what-is-a-keyboard.aspx">this blog</a>&nbsp;points to a sample showing how they can be used from within a text service. I'll just put the idea of an application style&nbsp;sample on my list of things to do....</p>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2011/05/20/10166588.html" title="Every character has a story #33: GREEK ANO TELEIA (U+0387)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2011/05/18/10165599.html" title="A difference that makes no difference makes a blog">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-05-19">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/05/19/10166285.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>