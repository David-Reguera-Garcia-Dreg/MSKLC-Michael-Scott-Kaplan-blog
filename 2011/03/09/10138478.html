<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/03/09/10138478.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Hidden in plain site: a purloined letter kind of a bug report</title></head><body>
<h1>Hidden in plain site: a purloined letter kind of a bug report</h1>
<p><em>by Michael S. Kaplan, published on 2011/03/09 07:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2011/03/09/10138478.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, Andrew Dunbar asked:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;"><em>The Windows API WriteFile is documented to put the number of *bytes* written in the variable pointed to by lpNumberOfBytesWritten, but when writing to the console set to codepage 65001 (Unicode UTF-8) it actually returns the number of characters or Unicode codepoints written. Is this a bug or a feature or a misreading of the docs? There is a year old bug report but has anything been looked into over that year?</em></span></p>
<p style="padding-left: 60px;"><a href="https://connect.microsoft.com/VisualStudio/feedback/details/543801/unicode-issues-with-writefile-and-in-the-crt"><span style="font-family: times new roman,times;"><em>https://connect.microsoft.com/VisualStudio/feedback/details/543801/unicode-issues-with-writefile-and-in-the-crt</em></span></a></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;"><em>I'm glad that finding this bug led me to your blog by the way, I've been reading it regularly since.</em></span></p>
<p>Indeed, that Connect report is interesting:</p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">I believe there is an issue with WriteFile [1]. Either in it's implementation, or its documentation is lacking.</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">WriteFile is supposed to return the number of _bytes_ written. Taking the same input, the returned value for number of bytes written can be different for different codepages. And when writing UTF-8 data with multibyte characters to stdout it seems to return the number of _characters_ written.</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">For example when writing a char* buffer with value { 0xC3, 0xA4, 0 } (character &auml; encoded as UTF-8) WriteFile returns the following values:</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">With console output codepage 850:<br />- Output: +&ntilde;<br />- Bytes written: 2 (correct, and output is obviously broken)</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">With console output codepage 65001:<br />- Output: &auml;<br />- Bytes written: 1 (incorrect since "&auml;" in UTF-8 takes 2 bytes, but output is correct)</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">This behavior results in issues in Microsoft's C Runtime implementation. Several functions (like fflush) are required to verify that the number of bytes written is equal to the number of bytes in the input. The behavior of WriteFile triggers those checks and output streams are flagged with _IOERR, thus breaking programs that verify streams with ferror().</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">All tests were done on a German Windows 7 Professional (64-bit) using 32- and 64-bit test programs.</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">MSVCR90.DLL: 9.0.30729.4926<br />KERNEL32.DLL: 6.1.7600.16385<br />cmd.exe: 6.1.7600.16385</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">Also please refer to this thread [2] in the Visual C++ General forum where the CRT behavior was confirmed for VS 2010 RC.</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">[1]: </span><a href="http://msdn.microsoft.com/en-us/library/aa365747(VS.85).aspx"><span style="font-family: times new roman,times;">http://msdn.microsoft.com/en-us/library/aa365747%28VS.85%29.aspx</span></a><br /><span style="font-family: times new roman,times;">[2]: </span><a href="http://social.msdn.microsoft.com/Forums/en-US/vcgeneral/thread/e4b91f49-6f60-4ffe-887a-e18e39250905"><span style="font-family: times new roman,times;">http://social.msdn.microsoft.com/Forums/en-US/vcgeneral/thread/e4b91f49-6f60-4ffe-887a-e18e39250905</span></a><span style="font-family: times new roman,times;"> </span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">--------------------------------------------------------------------------------</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">Posted by Microsoft on 3/22/2010 at 11:21 PM <br />Thanks for your feedback. </span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">We are rerouting this issue to the appropriate group within the Visual Studio Product Team for triage and resolution. These specialized experts will follow-up with your issue.</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">Thank you</span></p>
<p>I can confirm that the bug appears to be just sitting there with the title <strong>Unicode issues with WriteFile an in CRT</strong> in the Dev10 PS database, with a "Release" field marked <strong>Dev11</strong>.</p>
<p>It is being treated as a CRT bug, even though it seems more like a Win32 issue and not a CRT issue.</p>
<p>So it is in the wrong database, for the wrong product, being looked at by no one since basically March of last year.</p>
<p>This may as well be considered a <strong>lost bug</strong> at this point. Kind of a <strong>lost in plain site bug</strong>, now that I think about it....</p>
<p>The truth is, there is a very good reason that the whole <strong>WriteFile</strong>/<strong>WriteConsoleW</strong> split where if you call the wrong function when dealing with consoles and/or redirected consoles you will get screwed up results.</p>
<p>It is because the relationship between these functions and their behavior in the various supported and "unsupported" situations is really screwy.</p>
<p>Perhaps the bug getting lost ain't no thing since it is largely wrapped up in there and improvong the documentation to make it clear that if you are writing to the console you should always use <strong>WriteConsoleW</strong> and not <strong>WriteFile </strong>in order to avoid less than predictable results is probably the only fix that one might expect here.</p>
<p>Though the current <a href="http://msdn.microsoft.com/library/ms687401.aspx">WriteConsole</a> docs are pretty clear on the situation:</p>
<p style="padding-left: 60px;">WriteConsole fails if it is used with a standard handle that is redirected to a file. If an application processes multilingual output that can be redirected, determine whether the output handle is a console handle (one method is to call the GetConsoleMode function and check whether it succeeds). If the handle is a console handle, call WriteConsole. If the handle is not a console handle, the output is redirected and you should call WriteFile to perform the I/O.</p>
<p>Perhaps being just as clear in the <a href="http://msdn.microsoft.com/library/aa365747.aspx">WriteFile</a> docs will clean this situation up sufficiently....</p>
<p>Anyway, I'll give the report a few weeks to see if someone cleans up the Connect bug and the Product Studio issue and gets it made into a doc bug, if not then I'll follow up on it. this might be perceived as me being lazy, but in a lot of cases the right people really do happen to be reading here. And when they are everything is much easier than tracking the right people down....</p>
<hr/><p><strong>Random832</strong> on 21 Mar 2011 6:15 AM:</p><div style="margin-left: 1em"><p>The reason it&#39;s [at least also] a CRT bug is probably because &#39;fixing&#39; the documentation to tell you not to call WriteFile on the console won&#39;t actually cause the CRT to not call WriteFile on the console, and (unlike for WriteFile) it would be completely unreasonable to say you shouldn&#39;t call fputs, or cout &lt;&lt; &quot;whatever&quot;, if stdout is a console. The current behavior is a problem for whatever version of the ISO C/C++ standards VS attempts to conform to, and if Win32 won&#39;t change, then the CRT has to.</p>
<p>(There&#39;s also the fact that if a multibyte character is split across a _write() boundary it will be lost if written to the console, which probably _can&#39;t_ be solved at the WriteFile level)</p></div>
<p><strong>Roman</strong> on 4 Dec 2012 5:28 AM:</p><div style="margin-left: 1em"><p>Thank you for quoting the report, since the original link is no longer operational (like tens of thousands other links leading to MS Connect...)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2011/03/10/10139120.html" title="A resource segue, #1">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2011/03/08/10137970.html" title="Lackng official influence frees me up somewhat to talk about things that interest me">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-03-09">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/03/09/10138478.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>