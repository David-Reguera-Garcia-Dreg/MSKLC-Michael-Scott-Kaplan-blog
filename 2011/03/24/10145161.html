<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/03/24/10145161.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Knowing the layout doesn't mean knowing how to lay it out....</title></head><body>
<h1>Knowing the layout doesn't mean knowing how to lay it out....</h1>
<p><em>by Michael S. Kaplan, published on 2011/03/24 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2011/03/24/10145161.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, Marcus B. asked:</p>
<p style="padding-left: 30px;"><em><span style="font-family: times new roman,times;">I currently have to delvelop an on-screen-keyboard at work. I wonder how the windows osk knows what keyboard type to display. I mean not the keyboard layout but the location and size of the return key and the surrounding keys. Is there any win API and where is this kind of information stored or is that a hardcoded feature for the windows osk?</span></em></p>
<p style="padding-left: 30px;"><em><span style="font-family: times new roman,times;">Thank you :)</span></em></p>
<p>Sometimes the quickest answers are the most disappointing ones. :-(</p>
<p>There is no function one can call to tell you what layout to use for the emulation of the physical keys.</p>
<p>Generally there are just a few basic general types of layouts, and to solve this problem one would keep a list matching the KLID of the keyboard with the layout type. And of course have a general choice to use when an uknwon keyboard comes along....</p>
<p>For hardware itself it is kind of tied up in the use of <a href="http://msdn.microsoft.com/library/ms724336.aspx">GetKeyboardType</a>, as I mentioned in <a href="http://archives.miloush.net/michkap/archive/2011/01/07/10112915.html" title="Had I known that my last release would be *the* last release..., aka hindsight is 2020"><strong>Had I known that my last release would be *the* last release..., aka hindsight is 2020</strong></a>. Though as I mentioned in that very blog, despite the fact that there is a clear realationship between each keyboard layout DLL and the keyboard type information, this data is not directly exposed.</p>
<p>You can actually see it in the KBDTABLES structure defined in kbd.h, added to the end of the structure in Windows XP:</p>
<p style="padding-left: 30px;"><span style="font-family: consolas,lucida console,courier new,courier,FIXED;"><strong>.<br />.<br />.<br />#if (NTDDI_VERSION &gt;= NTDDI_WINXP)<br /><br />&nbsp;&nbsp;&nbsp; /*<br />&nbsp;&nbsp;&nbsp;&nbsp; * Type and subtype. These are optional.<br />&nbsp;&nbsp;&nbsp;&nbsp; */<br />&nbsp;&nbsp;&nbsp; DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwType;&nbsp;&nbsp;&nbsp;&nbsp; // Keyboard Type<br />&nbsp;&nbsp;&nbsp; DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dwSubType;&nbsp; // Keyboard SubType: may contain OemId<br /><br />#endif<br /><br />} KBDTABLES, *KBD_LONG_POINTER PKBDTABLES;</strong></span></p>
<p>Now in theory this means one could write a function to call the KbdLayerDescriptor function exported by the layout DLL (as previously described in <a href="http://archives.miloush.net/michkap/archive/2007/11/13/6122573.html" title="I know that header file is around here somewhere"><strong>I know that header file is around here somewhere</strong></a> and then you could get the dwType here and then by spending some time in the header file and with that&nbsp;<a href="http://archives.miloush.net/michkap/archive/2011/01/07/10112915.html" title="Had I known that my last release would be *the* last release..., aka hindsight is 2020"><strong>Had I known that my last release would be *the* last release..., aka hindsight is 2020</strong></a> blog, one could have a simple mapping of intended keyboard types for each layout and the way the keys themselves are laid out.</p>
<p>However, the fact that the tools (kbdtool.exe and kbdutool.exe) that are used to build the keyboard layout DLLs do not expose a direct method you can use to set these values, it is unclear how useful the data will be. The heuristics that are used to set the values are deterministic, but they are not documented....</p>
<p>I would deem the risk of it to ever change to be exceedingly low, since such a change could break all the existing layouts; given this it may be reasonably safe for someone to try to reverse engineer it if they wanted to. Though I had a tough time omin up with a ompelling reason to want to. YMMV!</p>
<p>In the end you're better off just storing a table, like I said. But that looked like way too short of a blog, and I knew someone would ask about <a href="http://msdn.microsoft.com/library/ms724336.aspx">GetKeyboardType</a>....</p>
<hr/><p><strong>Markus B.</strong> on 28 Mar 2011 3:39 AM:</p><div style="margin-left: 1em"><p>Thank you for the answer. :)</p>
<p>As you said it&#39;s disappointing. I hoped that there is a easy and clean way for that. :/</p>
<p>I would guess that the windows osk uses a table for that.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2011/03/25/10145717.html" title="Nastaliq is not just another script...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2011/03/23/10144161.html" title="When your Clipboard isn&#39;t their Clipboard. Or my Clipboard...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2011-03-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2011/03/24/10145161.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>