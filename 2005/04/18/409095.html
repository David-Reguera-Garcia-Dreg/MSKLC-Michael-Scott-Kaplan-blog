<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/18/409095.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A few of the gotchas of WideCharToMultiByte</title></head><body>
<h1>A few of the gotchas of WideCharToMultiByte</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/18 02:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/04/18/409095.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>I have talked a bunch of times about the way that different forms of strings that are canonically equivalent according to Unicode and&nbsp;which actually look identical visually exist in the world.</FONT></P>
<P><FONT face=Tahoma>My uber typical example is comparing <A href="http://www.fileformat.info/info/unicode/char/00e5/index.htm">U+00e5</A>&nbsp;to <A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">U+0061</A> <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A> (å to å, or LATIN SMALL LETTER A WITH RING ABOVE to&nbsp;LATIN SMALL LETTER A +&nbsp;COMBINING RING ABOVE). They usually look the same, Unicode says they are the same, Unicode Normalization will convert between them, and even good old <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/foldstring.asp"><STRONG>FoldString</STRONG></A> will do a job converting a lot of the cases.</FONT></P>
<P><FONT face=Tahoma>So what happens when you use <A href="http://msdn.microsoft.com/library/en-us/intl/unicode_2bj9.asp"><STRONG>WideCharToMultiByte</STRONG></A> to convert a string containing one of these sets of characters from Unicode to a code page that contains the letter in question (like 0xe5 on <A href="http://www.microsoft.com/globaldev/reference/sbcs/1252.htm">code page 1252</A> for our friend A-Ring)?</FONT></P>
<P><FONT face=Tahoma>Well, <A href="http://www.fileformat.info/info/unicode/char/00e5/index.htm">U+00e5</A> will always convert to 0xe5 with no problems. That one is easy.</FONT></P>
<P><FONT face=Tahoma>However, <A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">U+0061</A> <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A> will not convert by default in the way you might want.</FONT></P>
<P><FONT face=Tahoma>If you pass the <STRONG>WC_COMPOSITECHECK</STRONG> flag, then the good news is that it will try to map stuff like <A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">U+0061</A> <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A>&nbsp;to <A href="http://www.fileformat.info/info/unicode/char/00e5/index.htm">U+00e5</A>. Of course the bad news is that&nbsp;it will use those same old tables that <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/foldstring.asp"><STRONG>FoldString</STRONG></A>'s MAP_PRECOMPOSED has been using for years. Which is missing some of what Unicode normalization defines.</FONT></P>
<P><FONT face=Tahoma>If you pass the <STRONG>WC_DISCARDNS</STRONG> flag along with <STRONG>WC_COMPOSITECHECK</STRONG>, then non-spacing characters that do not find composite characters will be discarded. Since that table does not have all of the mappings in it, you may be losing some information when you pass this flag.</FONT></P>
<P><FONT face=Tahoma>If you pass the <STRONG>WC_DEFAULTCHAR</STRONG> flag along with <STRONG>WC_COMPOSITECHECK</STRONG>, then anything not on the code page (even as a best fit mapping) will be replaced with the default character (usually the question mark).</FONT></P>
<P><FONT face=Tahoma>If you pass the <STRONG>WC_NO_BEST_FIT_CHARS</STRONG> flag, then no best fit mappings (described further in&nbsp;<a href="http://archives.miloush.net/michkap/archive/2005/02/13/371895.html"><STRONG>If the shoe [best-]fits....</STRONG></A> and <a href="http://archives.miloush.net/michkap/archive/2005/02/15/373713.html"><STRONG><STRIKE><FONT color=#808080>Best</FONT></STRIKE>Better than nothing fit mappings, unleashed, #1</STRONG></A>) will happen. It is particularly relevant to our <A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">U+0061</A> <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A>&nbsp;case, since <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A>&nbsp;has a best fit mapping to <A href="http://www.fileformat.info/info/unicode/char/00b0/index.htm">U+00b0</A>&nbsp;(a.k.a. DEGREE SIGN). While one could argue endlessly about whether <STRONG>a°</STRONG> is better than <STRONG>a?</STRONG>, no one tends to disagree that just passing <STRONG>WC_COMPOSITECHECK</STRONG> and getting your <STRONG>å</STRONG> is better than both of those options. Even if it is a little slower.</FONT></P>
<P><FONT face=Tahoma>So you probably always want the <STRONG>WC_COMPOSITECHECK</STRONG> flag, just to have the best chance of getting the right mapping. In theory the incompleteness of the mappings it will support is a problem, but in practice most of them will not be on the code page anyway; you may be more likely to get a mapping (even if it is just a "best fit" one) with those incomplete tables. Since the code pages will never again change from version to version, and those compsite mappings have seen improvement from time to time....</FONT></P>
<P><FONT face=Tahoma>Makes a person just wish they had stayed in Unicode all along, don't it? :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "°" <EM>(</EM><EM><A href="http://www.fileformat.info/info/unicode/char/00b0/index.htm">U+00b0</A></EM><EM>, a.k.a. DEGREE SIGN)</EM></FONT></FONT></P>
<hr/><p><a id="409249" href="#409249">#</a> <strong>Ben Bryant</strong> on 18 Apr 2005 11:10 AM:</p><div style="margin-left: 1em">You have an incredible blog!<br>Do you run across programs or APIs that generate composite characters? For example, an edit control producing a string containing composite characters? I would hope that most stuff avoids them whenever there is a single character equivalent, even in japanese characters. Obviously every program trying to display and process the Unicode string does not want to worry about this, right?</div>
<p><a id="409251" href="#409251">#</a> <strong>Michael S. Kaplan</strong> on 18 Apr 2005 11:23 AM:</p><div style="margin-left: 1em">Thanks, Ben!<br><br>Most of the data on a Windows box will be in Unicode Normalization Form C (basically precomposed form). But anyone could use MSKLC to create a custom keyboard that does not do this, and obviously data coming from other platforms will follow its own rules. <br><br>If you are processing data and are unsure of where it is coming from and what form it might be in, passing the right flag can be very helpful. :-)</div>
<p><a id="409312" href="#409312">#</a> <strong>Ben Karas</strong> on 18 Apr 2005 1:35 PM:</p><div style="margin-left: 1em">This is wonderful information.  I wish MSDN would provide &quot;You almost always want these flags...&quot; in their documentation.  Maybe you could poke the editors?</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/25 <a href="http://archives.miloush.net/michkap/archive/2008/09/25/8964094.html">When to make a change, when to stay the same</a></p><p>2005/04/20 <a href="http://archives.miloush.net/michkap/archive/2005/04/20/410043.html">Encoding APIs and Security Concerns, APIs and Security Decisions</a></p><p>2005/04/19 <a href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html">A few of the gotchas of MultiByteToWideChar</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/18/409125.html" title="How soon is now?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/17/409062.html" title="Brett Shirley really ought to blog">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/18/409095.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>