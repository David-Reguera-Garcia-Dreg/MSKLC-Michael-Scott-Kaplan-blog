<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/16/408853.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Not all keyboards are included in MSKLC's lists</title></head><body>
<h1>Not all keyboards are included in MSKLC's lists</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/16 14:40 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/04/16/408853.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Yesterday, </FONT><A id=_ctl0__ctl0__ctl0__ctl0__ctl0__ctl0_Comments__ctl0_Comments__ctl20_NameLink title=Ovate href="http://blogs.msdn.com/Profile.aspx?UserID=5209" target=_blank><FONT face=Tahoma>Ovate</FONT></A><FONT face=Tahoma> left a comment to my post <a href="http://archives.miloush.net/michkap/archive/2005/02/01/364707.html">What is my locale? Well, which locale do you mean?</A>&nbsp;entitled <a href="http://archives.miloush.net/michkap/archive/2005/02/01/364707.html#408778">Chinese locales and Dvorak</A>. Not entirely ontopic and probably better for the <a href="http://archives.miloush.net/michkap/archive/2005/04/01/404554.html">suggestion box</A>, but I am not going to judge too harshly. :-)</FONT></P>
<P><FONT face=Tahoma>Ovate said:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Tahoma size=2><EM>Hi there, I type with Dvorak for the right hand. However the Chinese locale input method MS-Pinyin 98 that I need to use to type Chinese relies on the Qwerty layout. I need to be able to change this to the right hand Dvorak layout within the Chinese locale (I actually need to be able to do the same for Japanese) <BR><BR>I have downloaded a copy of MKLC (Microsoft Keyboard layout creator). However when I go to File\ load existing keyboard, it only displays Chinese (PRC) US keyboard option. This is not even a Chinese input method. I already have all the Chinese locals installed on my computer. Would anyone have any idea why the other Chinese input methods do not display or how I can locate them so that I can alter the keys to a Dvorak right hand layout. If I'm going about this totally the wrong way, please excuse the ignorance :-)</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>This is unfortunately an intentional filtering that is done in the <A href="http://www.microsoft.com/globaldev/tools/msklc.mspx">Microsoft Keyboard Layout Creator</A>.</FONT></P>
<P><FONT face=Tahoma>Back when I first wrote MSKLC, the "Load Existing Keyboard Layout" functionality was intended to support every layout under the HKLM\SYSTEM\CurrentControlSet\Control\Keyboard Layouts subkey, but there were two problems with this:</FONT></P>
<UL>
<LI><FONT face=Tahoma>Keyboards installed by third party tools like Keyman often did not use the keyboarding APIs to report results, so the methods MSKLC would use to interrogate the layout were ineffectual;</FONT> 
<LI><FONT face=Tahoma>Keyboards attached to IMEs were basically pointers to other keyboards, and thus modifying them would never return the results you would expect.</FONT></LI></UL>
<P><FONT face=Tahoma>Entries like the Chinese (PRC) US layout actually exist if you go to the Add Input Language dialog provided by the Text Services Framework team, as you can see below.</FONT></P>
<P><FONT face=Tahoma><IMG height=566 src="http://trigeminal.fmsinc.com/images/AddInputLanguage.jpg" width=425></FONT></P>
<P><FONT face=Tahoma>And those entries are the only ones that MSKLC can actually get good information out of using the standard keyboarding APIs. If you look at the entries in the registry&nbsp;for the IMEs, they look like this:</FONT></P>
<P><IMG src="http://trigeminal.fmsinc.com/images/IMERegistry.jpg"></P>
<P><FONT face=Tahoma>Now obviously the "Layout File" is the keyboard DLL that is used. But the rules for the IME-attached DLLs are different. For example the Japanese file actually forwards to different DLLs depending on other system settings that are not documented, and the actual code in the IME has all different kinds of rules for reading the keyboard input, only some of which is Virtual Key-based and none of which is easily discerned with the keyboarding APIs. So in the end I hd to filter out those IME entries since I was unable to do anything with them.</FONT></P>
<P><FONT face=Tahoma>Now in some cases, you can actually modify that <STRONG>Layout File</STRONG> setting to actually get the keyboard you want attached to the IME. In Ovate's case, the United States-Dvorak for right hand info can be found in the 00040409 entry:</FONT></P>
<P><IMG height=340 src="http://trigeminal.fmsinc.com/images/DvorakRt.jpg" width=828></P>
<P><FONT face=Tahoma>So the layout file is KBDUSR.DLL. It may or may not work to change this value in the IMEs, mainly depending on what the IMEs themselves do to use the layout. But MSKLC could not really get in the business of modifying existing system configuration settings (for obvious reasons), since that is a sure recipe for disaster, even if it would always work. </FONT></P>
<P><FONT face=Tahoma>So if you choose to make those kinds of changes in the registry, you are on your own. Be sure to save somewhere what the original settings were, by right-clicking on the registry key and choosing to export it to an .REG file:</FONT></P>
<P><IMG height=340 src="http://trigeminal.fmsinc.com/images/ExportRegistry.jpg" width=835></P>
<P><FONT face=Tahoma>so you can restore the old settings and recover from anything that does not work properly. If you do not and you mess up the IME beyond all repair, then be sure to tell the support person on the phone what you did, and don't get mad if they suggest that you reinstall Windows. :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<FONT size=5>á¸°</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/1e30/index.htm">U+1e30</A>, a.k.a. LATIN CAPITAL LETTER K WITH ACUTE)</EM></FONT></FONT></P>
<hr/><p><a id="437190" href="#437190">#</a> <strong>Jim Gomes</strong> on 9 Jul 2005 9:08 PM:</p><div style="margin-left: 1em">Thank you for this great information!  This is exactly what I was looking for.  I was able to change the Japanese IME keyboard layout to a Dvorak layout by changing the registry database entries from KBDJPN.DLL to KBDDV.DLL.  That's all it took, and it works great!  Now I can enter the Romaji characters with a Dvorak layout.  Thanks again.</div>
<p><a id="7009727" href="#7009727">#</a> <strong>Jonathan</strong> on 6 Jan 2008 3:45 PM:</p><div style="margin-left: 1em"><p>This works great. Except for MS Word 2007. Does anyone know how to get this work in office? My Pinyin keeps using qwerty while this works perfect in Notepad.</p>
<p>And I agree, Microsoft should allow users to choose keyboard layouts and IME separately in the control panel.</p></div>
<p><a id="7010361" href="#7010361">#</a> <strong>Michael S. Kaplan</strong> on 6 Jan 2008 5:45 PM:</p><div style="margin-left: 1em"><p>Office 2007 is using the TSF interfaces, so t he legacy ones and modifications thereof will not work, and there is no workaround with those IMEs in such platforms.</p>
<p>Sorry!</p>
</div>
<p><strong>Morphiis</strong> on 21 Jun 2010 6:29 PM:</p><div style="margin-left: 1em"><p>For MS Office 2007 which uses TSF interface, you need to change the layout file for language, not just for the IME. </p>
<p>For example, if you want to use dvorak for Chinese IME, you need to change the layout for 0000804, not just for E0XX0804, where E0XX0804 is the registry entry for Chinese IME</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/02/22 <a href="http://archives.miloush.net/michkap/archive/2008/02/22/7847522.html">What's missing from the model</a></p><p>2007/10/25 <a href="http://archives.miloush.net/michkap/archive/2007/10/25/5660239.html">Ding dong, the hack is gone (aka Cutting the hacked cord, too)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/16/408871.html" title="My linguistic profile....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/16/408841.html" title="The headline was &#39;Killer flu samples shipped via FedEx, DHL&#39;">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/16/408853.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>