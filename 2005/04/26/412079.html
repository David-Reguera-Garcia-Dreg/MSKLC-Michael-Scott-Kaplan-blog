<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/26/412079.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Intelligent unmanaged string comparison</title></head><body>
<h1>Intelligent unmanaged string comparison</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/26 08:20 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/04/26/412079.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>If you look at the documentation for <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asphttp://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A>&nbsp;(but not <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A>, though it probably ought to be there, too), there is a small security note in there:</FONT></P>
<BLOCKQUOTE dir=ltr>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Tahoma><IMG alt="security note" src="http://msdn.microsoft.com/library/en-us/winui/winui/graphics/UI_security_bang_16.gif"></IMG><STRONG> Security Alert</STRONG>&nbsp;&nbsp;Using this function incorrectly can compromise the security of your application. Strings that are not compared correctly can produce invalid input. Test strings to make sure they are valid before using them and provide error handlers. For more information, see <A href="http://msdn.microsoft.com/library/en-us/intl/sec_intl.asp">Security Considerations: International Features</A>.</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P><FONT face=Tahoma>That link about <A href="http://msdn.microsoft.com/library/en-us/intl/sec_intl.asp">Security Considerations: International Features</A>&nbsp;leads to an interesting discussion:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr>
<BLOCKQUOTE dir=ltr>
<H3><A name=comparison_functions>Comparison Functions</A></H3>
<P>String comparisons can potentially present security issues. Because all comparison functions are slightly different, one function might report two strings as equal, but another function might consider them distinct. There are various functions that you can use to compare strings. The following are three examples of such functions. </P>
<UL>
<LI>lstrcmpi 
<LI>lstrcmp 
<LI>CompareString </LI></UL>
<P>The <B>lstrcmpi</B> function compares two character strings. The comparison is not case sensitive but is sensitive to the locale selected by the user in <B>Control Panel</B>. The <B>lstrcmpi</B> function does not perform byte comparisons. It compares strings according to the rules of the selected locale. The <B>lstrcmpi</B> function compares the strings by checking the first characters against each other, the second characters against each other, and so on until it finds an inequality or reaches the ends of the strings. The selected locale determines which string is greater (or whether the strings are the same). If no locale (language) is selected, the system performs the comparison by using default values. For some locales, such as Japanese, the <B>lstrcmpi</B> function might not be capable of comparing two strings. For more information, see <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp"><B>CompareString</B></A>.</P>
<P>The <B>lstrcmp</B> function is like the <B>lstrcmpi</B> function. The only difference is that it performs a case sensitive comparison.</P>
<P><B>CompareString</B> is similar to <B>lstrcmpi</B> and <B>lstrcmp</B> except that its first parameter specifies a locale instead of using the user selected locale. Usually, <B>CompareString</B>, <B>lstrcmp</B>, and <B>lstrcmpi</B> evaluate strings character-by-character. However, many languages have multiple-character elements, such as the two-character pair 'CH' in Traditional Spanish. Because <B>CompareString</B> uses the locale passed in the locale parameter to identify multiple-character elements and <B>lstrcmp</B> and <B>lstrcmpi</B> use the thread locale, identical strings might not be found as equal. In addition, <B>CompareString</B> ignores undefined characters <FONT color=#ff0000>so it returns 0 (equal)</FONT> for many string pairs that are quite distinct. A string might contain values that do not map to any character or it might contain characters with semantics outside the domain of the application, such as control characters within a URL. Test strings to make sure they are valid before using them and provide error handlers. </P></BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>(Ignore the typo in RED above, they are going to fix that to read "so it returns CSTR_EQUAL").</FONT></P>
<P><FONT face=Tahoma>Regular readers of this blog will recognize many of the concepts that are discussed, from <a href="http://archives.miloush.net/michkap/archive/2004/12/29/344136.html"><STRONG>Comparison confusion: INVARIANT vs. ORDINAL</STRONG></A>&nbsp;to <a href="http://archives.miloush.net/michkap/archive/2005/01/18/355210.html"><FONT color=#0000ff><STRONG>The jury will give this string no weight</STRONG></FONT></A>, the issues here have all been covered. But it all boils down to intelligent use of the APIs. If you are trying to match the results of the file system (or of Win32 namespace objects like the names for events, names pipes, mutexes, etc.) then you should be uppercasing the string and then doing a binary comparison. If you are not, then you have to ask yourself why are you bothering to compare at all, since your comparison will not match the one that the opedrating system is about to do. It seems like common sense to me.</FONT></P>
<P><FONT face=Tahoma>But then APIs like <A href="http://msdn.microsoft.com/library/en-us/vclib/html/_crt__stricmp.2c_._wcsicmp.2c_._mbsicmp.asp">_wcsicmp</A>&nbsp;do a lowercase comparison of strings, so what do I know? :-)</FONT></P>
<P><FONT face=Tahoma>Ok, no fair to pick on an implementation that actually follows a&nbsp;standard; there are only two good reasons to uppercase here:</FONT></P>
<OL>
<LI><FONT face=Tahoma>The operating system does it for other purposes;</FONT></LI>
<LI><FONT face=Tahoma>The whole <a href="http://archives.miloush.net/michkap/archive/2004/12/02/273619.html">Georgian thing</A> on Windows;</FONT></LI></OL>
<P><FONT face=Tahoma>And there is a good reason to lowercase if you are doing full Unicode casing (which no one in Win32 or the CRT is): the Sharp S moves to two characters if you uppercase it, increasing the length of the string.</FONT></P>
<P><FONT face=Tahoma>So the CRT can hardly be blamed for not going down that road, when no one was really thinking too much about it then anyway, can they?</FONT></P>
<P><FONT face=Tahoma>Now this whole security warning applies equally to <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A>&nbsp;and sort keys, since they are designed to work the same way as string comparisons; any time they do not, we consider it a bug. Now if the bug is in LCMapString then we can't really change the result without changing the version number so we'd be more likely to break <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asphttp://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A>&nbsp;in the same way. Though in practice for as long as I have been here it is always <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asphttp://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A>&nbsp;that is broken, not <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A>. Something to do with how much easier it is to make a mistake when you try to do less work, maybe? :-)</FONT></P>
<P><FONT face=Tahoma>I think what we need is a good way to match the operating system behavior that we can point to. People never read warnings that go on for paragraaphs about best practices <STRONG>like this blog</STRONG>, but they do pay attention to "Use function&nbsp;YYYY rather than function XXXX for this particular scenario, if you say it in enough places.</FONT></P>
<P><FONT face=Tahoma>Of course we'd have to figure out what to call it and all that kind of stuff. </FONT></P>
<P><FONT face=Tahoma>Let me go think on this for a bit....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you&nbsp;by</EM> "<FONT face="Times New Roman" size=5>á…£</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/1163/index.htm">U+1163</A>, a.k.a. HANGUL JUNGSEONG YA)</EM></FONT></FONT></P>
<hr/><p><a id="412374" href="#412374">#</a> <strong>Ben</strong> on 26 Apr 2005 10:16 PM:</p><div style="margin-left: 1em">Wow, now that's something I didn't know!  Thanks.<br><br>I wonder if it would help to have a &quot;When to use this API?&quot; section in the MSDN article.  It could list typical uses, and typical non-uses, and typical misuses.  For CompareString, it would might say<br> uses: character element by character element comprison skipping unknown characters.<br> non-uses: file-system comparisons, bit-wise comparisons.<br> mis-uses: thinking that the NORM_IGNORECASE will get you a case insensitive comparison of every character including unknown characters.<br><br>This would be like the &quot;Drug Facts&quot; table for OTC drugs.</div>
<p><a id="412410" href="#412410">#</a> <strong>Michael S. Kaplan</strong> on 27 Apr 2005 12:11 AM:</p><div style="margin-left: 1em">Ben -- Yep, I am going to work with the doc. writer (as well as with team members) to see what makes sense here....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2005/05/08 <a href="http://archives.miloush.net/michkap/archive/2005/05/08/415522.html">Similar descriptions does not mean similar methodologies</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/26/412398.html" title="Good things can happen when religious authorities work with science and technology">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/25/411861.html" title="Speaking gig tonight (April 25) in Cleveland, OH, USA">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/26/412079.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>