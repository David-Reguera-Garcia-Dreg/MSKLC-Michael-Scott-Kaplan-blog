<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/05/405443.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>So what happened in v.Next?</title></head><body>
<h1>So what happened in v.Next?</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/05 02:02 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/04/05/405443.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A few days ago I talked about <a href="http://archives.miloush.net/michkap/archive/2005/04/03/404931.html">how ClearCachedData found its way into the .NET Framework</A>. I told the whole fun story, and I waited hopefully for someone to ask the question.</P>
<P>I explained how it was too late to do anything more extensive in the first version of the .NET Framework. And held my breath waiting for the question.</P>
<P>Alas,&nbsp;the question did not come.</P>
<P>What was the question, you may ask? </P>
<P>The question was "<EM>so what happened in version 1.1?</EM>" I mean, we cannot refuse to&nbsp;address issues&nbsp;in a later release that are "too late to address" in the current relese, can we?</P>
<P>I assume everyone was just so beguiled by the excellent storytelling job I did&nbsp;that no one noticed.</P>
<P><EM>Well, technically one person asked the question, but I believe he is the one who was behind it so I couldn't count him. :-)</EM></P>
<P>Version 1.1 of the .NET Framework (Everett) added the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfmicrosoftwin32systemeventsclassuserpreferencechangedtopic.asp">SystemEvents.UserPreferenceChanged</A> event!</P>
<P>By using the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfmicrosoftwin32userpreferencechangedeventargsclasscategorytopic.asp">UserPrefereceChangedEventArgs.Category</A> of UserPreferenceCategory.Locale, you will be getting the&nbsp;same notification that the <A href="http://msdn.microsoft.com/library/en-us/sysinfo/base/wm_settingchange.asp">WM_SETTINGCHANGE</A> message with a&nbsp;wParam of 0 and an lParam of "intl". The very message that means someone has changed a setting in Regional Options!</P>
<P>Unfortunately it cannot tell you <EM>what</EM> has changed, but then again the WM_SETTINGCHANGE cannot tell you either. But it can tell you that <EM>something</EM> has changed. So if you are caching anything, you have to dump your cache. But that is just what <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfSystemGlobalizationCultureInfoClassClearCachedDataTopic.asp">CultureInfo.ClearCachedData</A> is meant to do, so everything works out quite nicely. Like a marriage made in Arkon, as my 7th grade teacher would have said....</P>
<P>Now there is no specific sample for using this event for locales, but I figured no body would mind if I whipped one up here for this post.</P>
<P>First create the event procedure in your main class:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New"><STRONG>public void UserPreferenceChanged(object sender, <BR>&nbsp; Microsoft.Win32.UserPreferenceChangedEventArgs e) {<BR><BR>&nbsp;&nbsp;&nbsp; switch(e.Category)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case UserPreferenceCategory.Locale:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.CurrentThread.CurrentCulture.ClearCachedData();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default:<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</STRONG></FONT><FONT face="Courier New"><BR><STRONG>&nbsp;&nbsp;&nbsp; }</STRONG></FONT><FONT face="Courier New"><BR><STRONG>}</STRONG></FONT></P></BLOCKQUOTE>
<P>Then to make sure it gets called by adding the following in your constructor:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New"><STRONG>Microsoft.Win32.SystemEvents.UserPreferenceChanged&nbsp;<BR>&nbsp; += new Microsoft.Win32.UserPreferenceChangedEventHandler(<BR>&nbsp;&nbsp;&nbsp;&nbsp; this.UserPreferenceChanged);</STRONG></FONT></P></BLOCKQUOTE>
<P>Finally, make sure to add the following to the form's Dispose event to unhook the event:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New"><STRONG>Microsoft.Win32.SystemEvents.UserPreferenceChanged&nbsp;<BR>&nbsp; -= new Microsoft.Win32.UserPreferenceChangedEventHandler(<BR>&nbsp;&nbsp; &nbsp; this.UserPreferenceChanged);</STRONG></FONT></P></BLOCKQUOTE>
<P>And that is all you have to do; let the .NET Framework do the rest....</P>
<P>One final thought -- don't look longingly at the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfmicrosoftwin32systemeventsclassuserpreferencechangingtopic.asp">SystemEvents.UserPreferenceChanging</A> event, it does not really add anything here. :-)</P>
<P>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post brought to you by</EM> "Ä»" <EM>(U+013b, a.k.a. LATIN CAPITAL LETTER L WITH CEDILLA)<BR><FONT size=1>A letter that for some unknown reason was quite excited about the notion of hooking the "<STRONG>L</STRONG>ocale changing" event!</FONT></EM></FONT></P>
<hr/><p><a id="405526" href="#405526">#</a> <strong>Eric</strong> on 5 Apr 2005 9:18 AM:</p><div style="margin-left: 1em">Will UserPreferenceChanged always be raised on the UI thread, or should one call Form.Invoke in order to make sure the &quot;right&quot; thread's CurrentCulture is affected?</div>
<p><a id="405540" href="#405540">#</a> <strong>Michael S. Kaplan</strong> on 5 Apr 2005 10:29 AM:</p><div style="margin-left: 1em">The message technically goes to the top level windows and also to threads (I think the latter is used), and you can always have more than one of those. <br><br>But technically you should be able to call it from anywhere and see it reset the data all over (the cache is not itself per thread). The truly paranoid could enumerate threads and call it repeatedly from all of them, but I believe the results would be the same.<br><br>And of course you could do the more complicated dance that I referred to in the code in the article (<a rel="nofollow" target="_new" href="http://msdn.microsoft.com/msdnmag/issues/05/03/CultureInfo/">http://msdn.microsoft.com/msdnmag/issues/05/03/CultureInfo/</a>) but the purpose here was just to show the event, not the plumbing....</div>
<p><a id="405570" href="#405570">#</a> <strong>Eric</strong> on 5 Apr 2005 11:43 AM:</p><div style="margin-left: 1em">Incidentally, the code in that article doesn't compile.  The else is missing a closing bracket, and localeCur is a variable, not a method, but it has parens after it.  :)</div>
<p><a id="405597" href="#405597">#</a> <strong>Michael S. Kaplan</strong> on 5 Apr 2005 12:29 PM:</p><div style="margin-left: 1em">Oops! Sorry about that. :-(</div>
<p><a id="405678" href="#405678">#</a> <strong>Ruben</strong> on 5 Apr 2005 4:11 PM:</p><div style="margin-left: 1em">I meant to ask that. Honest! But a comment on the docs though: jeez, could they be any more contradictory?<br><br>&quot;The ClearCachedData method refreshes the information in CurrentCulture, ...&quot;<br><br>right next to<br><br>&quot;This method does not refresh the information in CurrentCulture for existing threads.&quot;<br><br>Isn't the current thread an &quot;existing thread&quot;?<br><br>What about changing your regional settings to a completely different culture, not just changing some values. I guess this is covered here as well? All new LCID and Name properties and such? In that case: what does ClearCachedData do on a culture not bound to Current(UI)Culture (CreateSpecificCulture, new()). It doesn't say! (Hint: a small yes and a big NO!)<br><br>Thankfully, Reflector tells me that the static properties Current(UI)Culture of CultureInfo (and some more) are reset, not the properties of the culture you used to call ClearCachedData on. Somehow I get the feeling that this method should have been static...<br><br>Oh, and didn't your mother tell you never to lock(typeof(...))? ;-)</div>
<p><a id="405831" href="#405831">#</a> <strong>Michael S. Kaplan</strong> on 6 Apr 2005 9:18 AM:</p><div style="margin-left: 1em">The docs are a little confusing on this point -- they mean to refer to the fact that the ones in other threads have this issue. If you need to, you can actually either put the listener in other threads or just enumerate the threads and call it on each one.<br><br>Which I guess explains why it is an instance method, because although its biggest effect is static there are some instnace features, too....<br><br>The current behavior of a culture that is not the user default (and has not been the user default since creation or the last time ClearCachedData was called) is that it just makes the data get re-fetched. But if that ever changed this would be the method to get those changes made, right? :-)<br><br>Pesky Reflector!!! :-)</div>
<p><a id="410071" href="#410071">#</a> <strong>Scott</strong> on 20 Apr 2005 10:54 AM:</p><div style="margin-left: 1em">About the threading of UserPreferenceChanged, if you're using Windows Forms controls (or anything with thread affinity), you should invoke.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/01/03 <a href="http://archives.miloush.net/michkap/archive/2011/01/03/10110996.html">Bad news: you may have to clear the cache; Good news: you *can* clear the cache</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/06/405847.html" title="When Notepad&#39;s Find doesn&#39;t">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/04/405363.html" title="Two Birds of a Feather Sessions proposed for TechEd 2005">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/05/405443.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>