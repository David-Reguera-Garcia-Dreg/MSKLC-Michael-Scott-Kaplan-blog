<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/13/407912.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>AVICAP32.DLL sucks (from the MSLU point of view)</title></head><body>
<h1>AVICAP32.DLL sucks (from the MSLU point of view)</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/13 16:15 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/04/13/407912.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>It is all about perspective.</FONT></P>
<P><FONT face=Tahoma>I am sure there are people who look at this DLL as being the answer to their prayers in terms of providing helpful interface to AVI capabilities. </FONT></P>
<P><FONT face=Tahoma>But from my point of view, it kind of sucks. :-(</FONT></P>
<P><FONT face=Tahoma>The other day someone with the handle PRR posted the following to the microsoft.public.platformsdk.mslayerforunicode newsgroup:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr>Problem description: If unicows.lib is included in the project, floating point control word may become invalid during program startup on Windows 98/95 machines (not tested on ME).</P>
<P dir=ltr>Compiler platform: MS VS.NET 2003 Pro, Platform SDK Feb 2003, Unicows.dll 1.1.3790, Win XP Pro, <A href="mailto:P4@2.4G">P4@2.4G</A>, 1G RAM, </P>
<P dir=ltr>Steps to repro:</P></BLOCKQUOTE>
<UL>
<LI>Create new Win32 Console Application (default settings). 
<LI>Under Project Property Pages dialog choose Release configuration 
<LI>Add following to Linker/Command line:</LI></UL>
<BLOCKQUOTE dir=ltr>
<BLOCKQUOTE dir=ltr>
<P>/nod:kernel32.lib /nod:advapi32.lib /nod:user32.lib /nod:gdi32.lib /nod:shell32.lib /nod:comdlg32.lib <BR>/nod:version.lib /nod:mpr.lib /nod:rasapi32.lib /nod:winmm.lib /nod:winspool.lib /nod:vfw32.lib <BR>/nod:secur32.lib /nod:oleacc.lib /nod:oledlg.lib /nod:sensapi.lib unicows.lib kernel32.lib advapi32.lib <BR>user32.lib gdi32.lib shell32.lib comdlg32.lib version.lib mpr.lib rasapi32.lib winmm.lib winspool.lib <BR>vfw32.lib secur32.lib oleacc.lib oledlg.lib sensapi.lib</P></BLOCKQUOTE></BLOCKQUOTE>
<UL>
<LI>Modify main cpp file to following:</LI></UL>
<BLOCKQUOTE dir=ltr>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><FONT face="Courier New">#include "stdafx.h"<BR>#include &lt;stdio.h&gt;<BR>#include &lt;float.h&gt;<BR><BR>int _tmain(int argc, _TCHAR* argv[])<BR>{<BR>&nbsp;&nbsp;&nbsp; printf("%x\n", _control87(0, 0));<BR>&nbsp;&nbsp;&nbsp; return 0;<BR>}</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<UL>
<LI>Compile the Release project and run on Win98SE PC.<BR>Output: 40003<BR>Expected output: 9001f</LI></UL>
<BLOCKQUOTE dir=ltr>
<P dir=ltr>The problem was reproduced on machine, which has a clean install of Win95OSR2 + clean upgrade to Win98SE. It does not happen all the time. If program should return 9001f, reboot&nbsp;Win98 and try again.</P>
<P dir=ltr>Note: It does not matter, whether project uses Multi-byte or Unicode charset.</P>
<P dir=ltr>Note: As soon as unicows.lib is removed from project, program starts acting as expected.</P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now for the record, it is not MSLU that is doing this. In order to have maximum compatibility with every version of Win9x (including Windows 95), there is no dependency whatsoever on the C Runtime. So it is defnitely not setting the floating point stuff. It is actually harder to do this than I realized, but Phil Lucido helped me shed the dependency while still using stuff like structured exception handling....</FONT></P>
<P><FONT face=Tahoma>Now I knew this issue had come up before but honestly could not remember what it was. </FONT><FONT face=Tahoma>Luckily, Ted (who unlike me remembered this issue) came to the rescue with the answer for PRR, and a workaround:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><EM><FONT face=Tahoma size=2>The thing that actually destroys the floating point is avicap32.dll which unicows.dll is dependent on.&nbsp; Several searches will come up with information about this.<BR><BR>The solution is to create your own AVICAP32.DLL stub DLL that sits in the same folder as unicows.dll (if you don't rely on functionality in that DLL).</FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The problem is that unicows.lib is statically linked to many of the system DLLs that it has to call for the functions it wraps, and AVICAP32.DLL&nbsp;does indeed change these settings in the process. Whether you wanted it to or not.</FONT></P>
<P><FONT face=Tahoma>Now this DLL only has two APIs that MSLU wraps: <A href="http://msdn.microsoft.com/library/en-us/multimed/htm/_win32_capcreatecapturewindow.asp">capCreateCaptureWindow</A> and <A href="http://msdn.microsoft.com/library/en-us/multimed/htm/_win32_capgetdriverdescription.asp">capGetDriverDescription</A>. For all of the trouble that they cause with this floating point crap, I wish no one had noticed these two APIs that were missed for so long (they were added to MSLU on March 24, 2001 and I doubt anyone has actually used the wrappers since then, beyond the meager tests I wrote!).</FONT></P>
<P><FONT face=Tahoma>Back then,&nbsp;I had toyed with the idea of delay loading all of the DLLs and functions being called, but somewhere in the 15+ DLLs and 550+ APIs it just seemed like an excessive amount of work. And it never ended up happening. It probably should have happened for this one DLL/two functions to work around the floating point problem, but it is not really worth rev'ing the DLL for that one change. I'll put it on the list of things to triage, if and when....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<FONT size=4>à²Š</FONT>" </FONT><EM><FONT color=#ff0000>(<A href="http://www.fileformat.info/info/unicode/char/0c8a/index.htm">U+0c8a</A>, a.k.a. KANNADA LETTER UU)<BR><FONT size=1>A letter that is selcom seen on Win9x but well represented in the Tunga font that ships with Windows XP and Server 2003!</FONT></FONT></EM></FONT></P>
<hr/><p><a id="408439" href="#408439">#</a> <strong>Steve Loughran</strong> on 15 Apr 2005 5:53 AM:</p><div style="margin-left: 1em">OK,<br><br>I'm going to take up your request for comments with something vaguely off topic but win9x related. No, its not a support call &quot;my obscuro 312 printer doesnt work on win95, please help&quot;.<br><br>But its this: where do you get your legacy win9x images from? Cos there is apparently nowhere on MSDN Universal Subscriptions to get ISO images for the OS releases, and hence no way to bring up new system images under VMWare or VPC unless you have old CDs around. Do you treasure the CDs from the elder days, or what?<br><br>Steve<br><br>(who has a my-app-doesnt-work-on-win98 call that  he's ignoring right now)</div>
<p><a id="408477" href="#408477">#</a> <strong>Michael S. Kaplan</strong> on 15 Apr 2005 7:04 AM:</p><div style="margin-left: 1em">I don't realy install in9x myself these days, as I have a laptop that can boot into about thirty different versions of it in different languages. :-)<br><br>But when I used to, I would do full installs from a share that had the builds. I am sure I have old CDs somewhere from  prior PC purchases, but I never keep track of where they are. :-)<br><br>While MSDN Universal does not have ISO images, I believe the Win9x versions are there, somewhere....</div>
<p><a id="408865" href="#408865">#</a> <strong>James Todd</strong> on 16 Apr 2005 1:34 PM:</p><div style="margin-left: 1em">Thanks for the information! This exact problem has been driving me up the wall and I couldn't figure out what in the world was changing the control word. Interestingly the non-optimized version of my program doesn't reproduce the problem, even though both debug and release are linking with unicows.lib.<br><br>I do have one question about Ted's workaround. Does the stubbed AVICAP32.dll need to actually export the two functions capCreateCaptureWindow and capGetDriverDescription, or can the dll export nothing?<br><br>As an alternate workaround, is it sufficient to reset the control word ourselves early in main() by calling _control87 with _CW_DEFAULT as the first parameter?<br><br>Thanks again,<br>James</div>
<p><a id="408869" href="#408869">#</a> <strong>Michael S. Kaplan</strong> on 16 Apr 2005 2:54 PM:</p><div style="margin-left: 1em">James -- I believe if your application does not call any of those APIs, it can have nothing in them, since it will never be called anyway. If you use AVICAP32.DLL that can cause problems though, so make sure you are not using any of the APIs from that DLL. :-)<br><br>You should be able to change the setting yourself any time after they have changed it in their code. The &quot;dueling DLLs configuring&quot; scenario works as long as you are the last one to change the setting!</div>
<p><a id="409806" href="#409806">#</a> <strong>James Todd</strong> on 19 Apr 2005 5:06 PM:</p><div style="margin-left: 1em">Thanks Michael. I've implemented my workaround by setting the control word myself early in my main(). There's one weird thing though: The control word doesn't always seem to be wrong by the time main() starts. Do you expect it to always be wrong, or are there other variable that affect whether or not the control word is wrong by the time the user program's main() starts?<br><br>It feels like a thread race condition, but that doesn't feel right either since floating point control words are per-thread state.</div>
<p><a id="410100" href="#410100">#</a> <strong>Michael S. Kaplan</strong> on 20 Apr 2005 11:58 AM:</p><div style="margin-left: 1em">To tell you the truth, I am not sure. But you are right that it seems like a race condition.</div>
<p><a id="413266" href="#413266">#</a> <strong>James Todd</strong> on 28 Apr 2005 6:46 PM:</p><div style="margin-left: 1em">As an addendum to this workaround, in my experience I had to actually put stubbed versions of the functions capCreateCaptureWindowA and capGetDriverDescriptionA into my dll. Once I did that all seemed to be well. If I didn't actually stub out the functions and have them exported from my dll, then the fix didn't take. I'm not sure why, but stubbing out the actual functions was easy enough.<br><br>To save others time, here's the quick and dirty stubbed code. I exported the two functions from the dll by linkinking in an old-school .def file.<br><br>#include &lt;vfw.h&gt;<br><br>extern &quot;C&quot; {<br><br>    HWND WINAPI capCreateCaptureWindowA(<br>                                        LPCSTR lpszWindowName,<br>                                        DWORD dwStyle,<br>                                        int x,<br>                                        int y,<br>                                        int nWidth,<br>                                        int nHeight,<br>                                        HWND hWnd,<br>                                        int nID<br>                                        )<br>  {<br>    return NULL;<br>  }<br><br>    BOOL WINAPI capGetDriverDescriptionA(<br>                                         UINT wDriverIndex,<br>                                         LPSTR lpszName,<br>                                         INT cbName,<br>                                         LPSTR lpszVer,<br>                                         INT cbVer<br>                                         )<br>  {<br>    return false;<br>  }<br><br>}</div>
<p><a id="413277" href="#413277">#</a> <strong>Michael S. Kaplan</strong> on 28 Apr 2005 7:15 PM:</p><div style="margin-left: 1em">James, that makes sense -- those are the two functions that we call, so it makes sense that it would fail if they were not there in the .LIB.<br><br>Thanks for posting this! :-)</div>
<p><a id="414014" href="#414014">#</a> <strong>James Todd</strong> on 2 May 2005 12:38 PM:</p><div style="margin-left: 1em">Sorry to keep beating this dead horse... Can you tell me which version of unicows.dll first wrapped avicap32.dll and thus had this floating point bug?<br><br>I'm looking at unicows.dll version 1.0.3665, and I see that it does have a dependency on avicap32.dll, so I would expect it to also have this issue. Is am I safe in assuming that any unicows.dll that is dependent on avicap32.dll will have this bug?<br><br>Thanks again,<br>James</div>
<p><a id="414032" href="#414032">#</a> <strong>Michael S. Kaplan</strong> on 2 May 2005 1:29 PM:</p><div style="margin-left: 1em">They were checked into the project in March of 2001, so other than early beta versions, they have always been there.<br><br>I have no idea when or if changes were made (or if it was always there) in avicap32.DLL to alter the setting.</div>
<p><a id="414358" href="#414358">#</a> <strong>James Todd</strong> on 3 May 2005 2:35 PM:</p><div style="margin-left: 1em">Actually nevermind. 1.0.3665 does have the issue as well, as expected.<br><br>James</div>
<p><strong>Yuhong Bao</strong> on 30 Dec 2010 2:05 AM:</p><div style="margin-left: 1em"><p>&quot;I don&#39;t realy install in9x myself these days, as I have a laptop that can boot into about thirty different versions of it in different languages. :-) &quot;</p>
<p>How do you do this? Do you use WinBoot?</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 30 Dec 2010 7:51 AM:</p><div style="margin-left: 1em"><p>It was an internal program provided by test. of course the MSLU virtual test machine is no more at this point....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/04/28 <a href="http://archives.miloush.net/michkap/archive/2006/04/28/585735.html">DEFAULT_GUI_FONT really stinks</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/14/408116.html" title="On approaching international programming....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/13/407823.html" title="Invariant and Ordinal Redux">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-13">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/13/407912.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>