<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/28/413019.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Looking for that internationally savvy palindrome checker....</title></head><body>
<h1>Looking for that internationally savvy palindrome checker....</h1>
<p><em>by Michael S. Kaplan, published on 2005/04/28 10:42 -07:00, original URI: http://blogs.msdn.com/michkap/archive/2005/04/28/413019.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P><A id=_ctl0__ctl0__ctl0__ctl0__ctl0__ctl0_Comments__ctl0_Comments__ctl0_NameLink title=Anonymous href="http://blogs.msdn.com/utility/Redirect.aspx?U=http://www.zero-one-zero.com/" target=_blank><FONT face=Tahoma>Jonathan Payne</FONT></A><FONT face=Tahoma>&nbsp;<a href="http://archives.miloush.net/michkap/archive/2005/04/28/412977.html#412988">asked</A> if I had an international thought about the palindrome pseudo interview question at this site:</FONT></P>
<P><A href="http://channel9.msdn.com/ShowPost.aspx?PostID=19171" target=_new><FONT face=Tahoma color=#0000ff>http://channel9.msdn.com/ShowPost.aspx?PostID=19171</FONT></A><FONT face=Tahoma>&nbsp;&nbsp;</FONT></P>
<P><FONT face=Tahoma>I did. :-)</FONT></P>
<P><FONT face=Tahoma>Using the new StringInfo stuff in Whidbey Beta 2:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><BR><FONT face="Courier New" size=4>bool IsPalindrome(string st) {<BR>&nbsp; &nbsp; StringInfo si = new StringInfo(st);<BR>&nbsp;&nbsp;&nbsp; int count = si.LengthInTextElements;</FONT></P>
<P><FONT face="Courier New" size=4>&nbsp;&nbsp;&nbsp; if (count == 0) return false; </FONT></P>
<P><FONT face="Courier New" size=4>&nbsp;&nbsp;&nbsp; for (int i = 0; i &lt; (count / 2); i++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string st1 = si.SubstringByTextElements(i, 1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string st2 = si.SubstringByTextElements(count - i - 1, 1);</FONT></P>
<P><FONT face="Courier New" size=4>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (CultureInfo.CurrentCulture.CompareInfo.Compare(st1, st2) != 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return(false);<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; }</FONT></P>
<P><FONT face="Courier New" size=4>&nbsp;&nbsp;&nbsp; return (true);<BR>}</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma>Quickest way to handle all those cool issues like cultural sensitivity and combining characters and supplementary characters and such!</FONT></P>
<hr/><p><a id="413036" href="#413036">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 11:42 AM:</p><div style="margin-left: 1em">By the way, this is a good example of an interesting trick you can do to be impressive interviews in almost any group other than ours -- in most interview loops, devs are imperssed by people who point out the internationsl scenarios in the questions.<br><br>Does not work as well in our group, as we may be more likely to find mistakes and then it just looks like you are trying to show off and failing. But it is great in many other cases. :-)</div>
<p><a id="413114" href="#413114">#</a> <strong>ronab49</strong> on Thursday, April 28, 2005 1:54 PM:</p><div style="margin-left: 1em">you will get better performance (for a non-opitimizing compiler) and a more reaable code if you manually move the calculation of the for loop length before the for loop:<br><br>...<br>  int nComparision = ((count % 2 != 0) ? count - 1 : count) / 2;<br>  for (int i = 0; i &lt; nComparisons; i++) {<br>...<br><br>Now, it is easy to see that the first line above is the same as (assuming count is &gt;= 0):<br>...<br> int nComparision = count / 2;<br>...<br><br><br>I do not know about the details of StringInfo functions, but you can get better performance if it is possible to precompute the SubsStringByTextElements(j, 1) for all consecutive values of j, in less time than computing SubsStringByTextElements(j, 1) in some random order. That is, I would write the following code (I also like to consider zero length strings as palindromes):<br><br>bool IsPalindrome(string st) {<br>    StringInfo si = new StringInfo(st);<br>    int count = si.LengthInTextElements;<br><br>    TextElementEnumerator k=si.GetTextElementEnumerator(st);<br>     <br>    vector &lt;string *&gt; precomp_st;<br>    int count=0;<br>    do {<br>        precomp_st[count++] = k.GetTextElement();<br>    } while (k.MoveNext());<br><br>    int nComparision = count / 2;<br><br>    for (int i = 0; i &lt; nComparisons; i++) {<br>        if (CultureInfo.CurrentCulture.CompareInfo.Compare(*precomp_st[i], *precomp_st[count-i-1]) != 0) <br>            return(false);<br>    }<br><br>    return (true);<br>}</div>
<p><a id="413124" href="#413124">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 2:14 PM:</p><div style="margin-left: 1em">Interesting -- of course creating another object (a text element enumerator) when you already did the work to create an object that has the divisions might negatively impact some of the perf gains....<br><br>Also, there was a recent blog post on Brad Abram's blog at <a rel="nofollow" target="_new" href="http://blogs.msdn.com/brada/archive/2005/04/23/411321.aspx">http://blogs.msdn.com/brada/archive/2005/04/23/411321.aspx</a> which suggests that caching outside the loop can hurt performance.<br><br>(I knew about this post and still split out the count to make it look more readable!)<br><br>Finally, this code will fail for odd numbers of text elements since is just doing a &quot;divide by 2&quot; and not checking for the odd number case. :-)<br><br>Do you get the job if you optimize the code in a way that makes it not work and potentially slower? :-)</div>
<p><a id="413206" href="#413206">#</a> <strong>Jonathan Payne</strong> on Thursday, April 28, 2005 4:31 PM:</p><div style="margin-left: 1em">Thank you - I suspect you would have done very well in that interview!<br><br>The classes you used look like a very neat way of handling this sort of problem.  I guess in a lot of cases, working with strings in this way should be the preferred (or at least more correct) option over using array indexing even if internationalisation isnâ€™t an immediate goal.</div>
<p><a id="413220" href="#413220">#</a> <strong>Maurits</strong> on Thursday, April 28, 2005 5:07 PM:</p><div style="margin-left: 1em">I've written a test-driving app for palindrome-checking using any combination of CompareOptions:<br><a rel="nofollow" target="_new" href="http://channel9.msdn.com/ShowPost.aspx?PostID=63167#63167">http://channel9.msdn.com/ShowPost.aspx?PostID=63167#63167</a><br><br>Also see my follow-up posts to your post linked above</div>
<p><a id="413243" href="#413243">#</a> <strong>ronab49</strong> on Thursday, April 28, 2005 5:59 PM:</p><div style="margin-left: 1em">-- Interesting -- of course creating another object (a text element enumerator) when you already did the work to create an object that has the divisions might negatively impact some of the perf gains.... <br><br>Not in C or C++. And I do not know enough about C# or VB to claim otherwise. However, I am going to provide you running times using VS .NET 2003 in a few minutes. <br><br>-- Also, there was a recent blog post on Brad Abram's blog at <a rel="nofollow" target="_new" href="http://blogs.msdn.com/brada/archive/2005/04/23/411321.aspx">http://blogs.msdn.com/brada/archive/2005/04/23/411321.aspx</a> which suggests that caching outside the loop can hurt performance. <br><br>Yep, I had read it, the premise was that if the JIT cannot deduce the range of the index variable at runtime, it will try to perform range checking for every access. However, my experince with compiler are that they are not that smart to deduce the effective range of slightly complex expression like the one you used. <br><br>Moreover, I believe the code behaves correctly for the cases with the odd lengths. Unless you point me to a case where it does not!<br> <br>Now, back to the TextEnumerator ...  As I wrote before, I do not know the details of StringInfo, but my educated guess is that everytime you use its length or substring functions, it will scan the string from its beginning. So, for a string of length N, the code gave about is O(N^2). However, it becomes O(N) if a textenumerator is used. <br><br>Besides, this annoying perf improvements. If you precomputer the text elemnts, using the collating functions could be much faster.<br><br>--Do you get the job if you optimize the code in a way that makes it not work and potentially slower? :-)<br><br>Was this an interview question ?  Oh no! I should have reviewed my code before I hit the submit button then.  :)</div>
<p><a id="413246" href="#413246">#</a> <strong>Maurits</strong> on Thursday, April 28, 2005 6:04 PM:</p><div style="margin-left: 1em">--<br>I do not know the details of StringInfo, but my educated guess is that everytime you use its length or substring functions, it will scan the string from its beginning<br>--<br><br>Hmmm... I'd guess that it builds an array of text elements, similarly to the way I use the TextElementEnumerator to build a String[]<br><a rel="nofollow" target="_new" href="http://channel9.msdn.com/ShowPost.aspx?PageIndex=5&amp;PostID=63246#63246">http://channel9.msdn.com/ShowPost.aspx?PageIndex=5&amp;PostID=63246#63246</a><br><br>If that is in fact the case, then it wouldn't need to rescan.</div>
<p><a id="413264" href="#413264">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 6:39 PM:</p><div style="margin-left: 1em">Basically, StringInfo is  a wrappear around ParseCombiningCharacters. It calls the method once and never calls it again unless you change the string.<br><br>It has size is the size of an array of ints that store the text elements, so it does not walk the string again for the count (and array stores the length).<br><br>The object has the string in there, and is uses a char array sort of access -- so it is not going through the string each time, it would be like C's &amp;lpwz[n].<br><br>PLUS if it is not a palindrome the original code exists without getting every string, while your code always gets all strings.<br><br>I am pretty the original code may be faster, especially for long non-palindrome strings.</div>
<p><a id="413269" href="#413269">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 7:00 PM:</p><div style="margin-left: 1em">For the odd number case of 7, it goes like this:<br><br>0  vs.  7-0-1 == 6<br>1  vs.  7-1-1 == 5<br>2  vs.  7-2-1 == 4<br>3  vs.  7-3-1 == 3<br><br>So, will it work? Yes. But did you just needlessly compare a character to itself? Yes. :-)<br><br>So you could cache the calced smaller number and save yourself an extra compare....</div>
<p><a id="413270" href="#413270">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 7:04 PM:</p><div style="margin-left: 1em">Maurits -- The new StringInfo stuff does not cache the strings. Only the string iteslf and the index values of each text element are cached (see the ParseCombiningCharacters method for details)<br><br>Grabbing a substring does alloc a new string, but it does not have to walk the string to do so....</div>
<p><a id="413293" href="#413293">#</a> <strong>ronab49</strong> on Thursday, April 28, 2005 8:14 PM:</p><div style="margin-left: 1em">-- Basically, StringInfo is a wrappear around ParseCombiningCharacters. It calls the method once and never calls it again unless you change the string. <br><br>Great! I rest the case then. All I was trying to do was what StringInfo will do by itself. <br><br>However, you should be able to see that the two expression:<br>((count % 2 != 0) ? count - 1 : count) / 2<br>and <br>count / 2<br>evaulate to the same number for all positive integer values of count.<br><br>...<br><br>The difference in using <br>((count % 2 != 0) ? count - 1 : count) / 2<br>versus<br>count / 2<br>as a loop upper bound is neglibile  when optimizing the code. <br><br>But with nonoptimized code, the difference is<br>observable:<br><br>((count % 2 != 0) ? count - 1 : count) / 2<br>Total Time: 0.9375<br><br>count / 2<br>Total Time: 0.859375</div>
<p><a id="413308" href="#413308">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 10:06 PM:</p><div style="margin-left: 1em">Hey ronab49 -- Well what about the third case -- do the calc outside the loop? That and a bunch of long strings may be slightly better....<br><br>Plus it just feels wrong to me to compare that middle character to itself. :-)</div>
<p><a id="413328" href="#413328">#</a> <strong>Maurits</strong> on Thursday, April 28, 2005 11:44 PM:</p><div style="margin-left: 1em">Oh, I see... ParseCombiningCharacters stores the byte offset of the *i*th grapheme in offset[i], allowing for a fast lookup.  If the data is seven-bit, or all single-byte Unicode, then offset[0] == 0, offset[1] == 1, ... offset[i] == i - but if any graphemes are multibyte (2 bytes, 3 bytes, 4 bytes...) then offset[i] &gt; i...<br><br>Do you perform another internal optimization and store offset_optimal[i] as offset[i] - i?  So if the data is all single-byte, offset_optimal[i] == 0 for all i... and in general offset_optimal[i] is the number of &quot;extra bytes&quot; in graphemes 0 through i - 1<br>?</div>
<p><a id="413329" href="#413329">#</a> <strong>Michael S. Kaplan</strong> on Thursday, April 28, 2005 11:55 PM:</p><div style="margin-left: 1em">We do not do any other optimizations, no. The goal was a more usable method than ParseCombiningCharacters that would not be slower -- but it still keeps that int array that it returns....<br><br>But it is pretty fast. And arrays keep their lengths in a member rather than alking the array for the value.</div>
<p><a id="413334" href="#413334">#</a> <strong>ronab49</strong> on Friday, April 29, 2005 12:24 AM:</p><div style="margin-left: 1em">well, neither your code nor mine, compares the middle character to itself. Say, for count == 7, nComparisons will be (7 / 2)  = 3. The compared grpahemes are then: <br><br>0 and 6 <br>1 and 5<br>2 and 4<br><br>and the loop stops right here.<br><br>BTW, why is not there a preview button on the comments form?</div>
<p><a id="413340" href="#413340">#</a> <strong>Michael S. Kaplan</strong> on Friday, April 29, 2005 12:34 AM:</p><div style="margin-left: 1em">Blame Community Server for the preview thing, it is out of my control....</div>
<p><a id="413341" href="#413341">#</a> <strong>Michael S. Kaplan</strong> on Friday, April 29, 2005 12:36 AM:</p><div style="margin-left: 1em">And you are right on the count thing,not sure what I was thinking....</div>
<p><a id="413378" href="#413378">#</a> <strong>Uwe Keim</strong> on Friday, April 29, 2005 3:25 AM:</p><div style="margin-left: 1em">Am I paranoid that I always use <br><br>    &quot;...if ( count &lt;= 0 ) ...&quot; <br><br>instead of<br><br>    &quot;...if ( count == 0 ) ...&quot; <br><br>whenever I have int returns like in &quot;string.Length&quot;?</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/18 <a href="http://archives.miloush.net/michkap/archive/2008/09/18/8956650.html">UCS-2 to UTF-16, Part 3: It starts with cursor movement (where MS simultaneously gets better and worse)</a></p><p>2008/07/24 <a href="http://archives.miloush.net/michkap/archive/2008/07/24/8768909.html">When you assess, you make an...</a></p><p>2007/05/09 <a href="http://archives.miloush.net/michkap/archive/2007/05/09/2497106.html">Sometimes you need more than StringInfo</a></p><p>2005/06/15 <a href="http://archives.miloush.net/michkap/archive/2005/06/15/429279.html">Once more into the palindrome</a></p><p>2005/04/30 <a href="http://archives.miloush.net/michkap/archive/2005/04/30/413676.html">Normalization vs. .NET text elements</a></p><p>2005/04/29 <a href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">Where did the new StringInfo stuff come from?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html" title="Where did the new StringInfo stuff come from?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/28/412977.html" title="Cleaning out the suggestion box a bit">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-04-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/04/28/413019.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>