<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/04/414520.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Collation data -- must be stable, but it must not stand still</title></head><body>
<h1>Collation data -- must be stable, but it must not stand still</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/04 02:28 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/04/414520.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>(Apologies to Roscoe Pound, he was talking about the law here)</FONT></P>
<P><FONT face=Tahoma>We add new locales to Windows with&nbsp;a new Windows version (or if you count the </FONT><a href="http://archives.miloush.net/michkap/archive/2005/01/26/360685.html">ELK locales in XPSP2</A><FONT face=Tahoma> a new service pack). Or even in hotfixes in <a href="http://archives.miloush.net/michkap/archive/2005/02/02/365993.html">extreme situations</A>.</FONT></P>
<P><FONT face=Tahoma>And that means adding new sorts for many of those new locales. And sometimes it even means it adding new code points to the default table, if they were not there already.</FONT></P>
<P><FONT face=Tahoma>But how do we do that? Or more the point, how do developers and applications deal with the repercussions of that happening between versions?</FONT></P>
<P><FONT face=Tahoma>The key is that an application cannot assume that the collation data may never change. Because the truth is that it may, and it has. </FONT></P>
<P><FONT face=Tahoma>But an application has a choice here -- rather than just forcing a re-index automatically with a new version, it can&nbsp;make use of the collation version APIs (<A href="http://msdn.microsoft.com/library/en-us/intl/nls_19ev.asp" target=_blank>IsNLSDefinedString</A> and <A title=GetNLSVersion href="http://msdn.microsoft.com/library/en-us/intl/nls_5e7i.asp" target=_blank>GetNLSVersion</A>), in a method I first described when I talked about <a href="http://archives.miloush.net/michkap/archive/2005/02/03/366145.html">what makes a string <EM>meaningful</EM>.</A></FONT></P>
<P><FONT face=Tahoma>I thought it was worth repeating the process again, just to get in people's systems....</FONT></P>
<P><FONT face=Tahoma>Now GetNLSVersion is used by major databases like Active Directory in order to know when it needs to re-index their data. Basically looking at the </FONT><A title=NLSVERSIONINFO href="http://msdn.microsoft.com/library/en-us/intl/nls_6faq.asp" target=_blank><FONT face=Tahoma>NLSVERSIONINFO</FONT></A><FONT face=Tahoma> struct, the dwDefinedVersion member will be incremented any time a major version sort of change happens, and the dwNLSVersion member will be incrememented any time a minor version sort of change happens.</FONT></P>
<P><FONT face=Tahoma>Now looking at IsNLSDefinedString, if you have a database and create indexes based on sort keys from </FONT><A title=LCMapString href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp" target=_blank><FONT face=Tahoma>LCMapString</FONT></A><FONT face=Tahoma> or B-Trees built from CompareString calls:</FONT></P>
<OL>
<LI><FONT face=Tahoma>Any time the major version is incremented, you should re-index <STRONG>no matter what</STRONG>, and </FONT>
<LI><FONT face=Tahoma>Any time the minor version is incremented, you should re-index for any entry where IsNLSDefinedString used to return FALSE (in case it now returns TRUE or different results due to part of the string now being defined)</FONT></LI></OL>
<P><FONT face=Tahoma>Obviously, major version changes are expensive and would be expected to be rare -- not even every major release of Windows requires a new major version. </FONT></P>
<P><FONT face=Tahoma>Why is that? Well, usually a new&nbsp;version would just mean a whole bunch of new characters added, and thus there is no need to re-index strings that are already indexed -- which suggests a minor version. Minor version changes would be much more common. With <EM>them</EM> you can trust all existing index values, and only need to re-index strings that previously contained one or more unsortable elements. </FONT></P>
<P><FONT face=Tahoma>I have mentioned that the Whidbey release of the .NET Framework includes a method analagous to IsNLSDefinedString (CompareInfo.IsSortable, now there in Beta 2). And it is the first step. The collation data is actually the same as the data that shipped in Windows Server 2003 (the first version of the sorting data that is reported by these APIs), so for all versions of the .NET Framework so far you can assume it is version 0x0001 and a GetNLSVerion equivalent is not needed. </FONT></P>
<P><FONT face=Tahoma>Obviously not even Windows technically needed the GetNLSVersion API when there was only one version being tracked, but this does allow you to contrast that version with all of the earlier ones.</FONT></P>
<P><FONT face=Tahoma>Those kinds of careful backcompat schemes&nbsp;can really help an application to re-index when appropriate and only when it is appropriate....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "Ð­" <EM>(<A href="http://www.fileformat.info/info/unicode/char/042d/index.htm">U+042d</A>, a.k.a.&nbsp;CYRILLIC&nbsp;CAPITAL LETTER E)</EM></FONT></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/08/28 <a href="http://archives.miloush.net/michkap/archive/2007/08/28/4605786.html">Every character has a story #29: U+1000^H^H^H^H0f40, (TIBETAN or MYANMAR LETTER KA, depending on when you ask)</a></p><p>2007/07/30 <a href="http://archives.miloush.net/michkap/archive/2007/07/30/4143574.html">See that version there? It is going down, man! #1</a></p><p>2005/12/07 <a href="http://archives.miloush.net/michkap/archive/2005/12/07/500869.html">Some sorts resist the future</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/04/414562.html" title="Why does MSLU wrap ________ ?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/04/414514.html" title="Aimee Mann -- The Forgotten Arm">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/04/414520.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>