<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/08/415522.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Similar descriptions does not mean similar methodologies</title></head><body>
<h1>Similar descriptions does not mean similar methodologies</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/08 13:30 -07:00, original URI: http://blogs.msdn.com/michkap/archive/2005/05/08/415522.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P><FONT face=Tahoma>The other day, I had to take a look at the various unmanaged case insensitive string comparison functions. I thought I would post what the comparison/contrast information.</FONT></P>
<P><FONT face=Tahoma>First the locale sensitive functions:</FONT></P>
<UL>
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareStringW</A>&nbsp;(kernel32.dll) -- the mother of all of the functions below, you&nbsp;can choose the locale, the flags, and whether the strings are counted or null-terminated. Embedded nulls are allowed.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/lstrcmpi.asp">lstrcmpiW</A>&nbsp;(user32.dll) -- assumes null-terminated strings, then calls CompareStringW with the NORM_IGNORECASE flag and the thread locale (if that fails then it tries again with the system locale; in the unlikely event both fail, it uses a call to _wcsicmp).</FONT><FONT face=Tahoma> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/vclib/html/_crt__stricoll.2c_._wcsicoll.2c_._mbsicoll.asp">_wcsicoll</A>&nbsp;(CRT) -- assumes null-terminated strings. If using the "C" locale, does an ASCII (A to Z) ToLowercase followed by a binary compare; otherwise it calls CompareStringW with the LCID of the CRT locale and the SORT_STRINGSORT&nbsp;and NORM_IGNORECASE flags.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/vclib/html/_crt__strnicoll.2c_._wcsnicoll.2c_._mbsnicoll.asp">_wcsnicoll</A>&nbsp;(CRT) -- takes&nbsp;one count parameter for both strings, but will also exit on an embedded null. If using the "C" locale, does an ASCII (A to Z) ToLowercase followed by a binary compare; otherwise it calls CompareStringW with the LCID of the CRT locale and the SORT_STRINGSORT&nbsp;and NORM_IGNORECASE flags (note that using just one count parameter will break compressions on locales that use them and expansions on all locales).</FONT> 
<LI><A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/strcmpi.asp">StrCmpIW</A>&nbsp;(shlwapi.dll) -- assumes null-terminated strings, then calls CompareStringW with the NORM_IGNORECASE flag and the thread locale (if that fails then it tries again with the system locale). Manages to look a lot like lstrcmpiW, though not completely so in rare scenarios.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/strcmpnic.asp">StrCmpNIW</A>&nbsp;(shlwapi.dll) -- takes&nbsp;one count parameter for both strings, but will also exit on an embedded null.&nbsp;It calls CompareStringW with the thread&nbsp;locale of the CRT locale and the&nbsp;NORM_IGNORECASE flags (note that using just one count parameter will break compressions on locales that use them and expansions on all locales). Manages to look a lot like a hybrid of lstrcmpiW and _wcsnicoll.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/strcmplogicalw.asp">StrCmpLogicalW</A> (shlwapi.dll) -- does linguistic comparisons using the thread locale (falling back to the system locale on failure), <a href="http://archives.miloush.net/michkap/archive/2005/01/05/346933.html">cleverly</A> wrapping multiple calls to CompareStringW to support treating the 0123456789 digits as numbers.</FONT></LI></UL>
<P><FONT face=Tahoma>And now the locale insensitive functions:</FONT></P>
<UL>
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/kmarch/hh/kmarch/k109_ddeef320-7510-446b-af6f-756c3999bec1.xml.asp">RtlCompareUnicodeString</A>&nbsp;(ntdll.dll) -- taking lengths in it UNICODE_STRING parameters (and allowing embedded nulls), it converts characters to uppercase and then does&nbsp;a binary comparison on them. This comparison matches what&nbsp;a lot of the operating system does for many of its objects (most of which use this very function!).</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/vclib/html/_crt__stricmp.2c_._wcsicmp.2c_._mbsicmp.asp">_wcsicmp</A> (CRT) -- assumes null-terminated strings. If using the "C" locale, on each character it does an ASCII (A to Z) ToLowercase followed by a binary compare; otherwise on each character it does a full ToLowercase followed by a binary compare.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/vclib/html/_crt__strnicmp.2c_._wcsnicmp.2c_._mbsnicmp.asp">_wcsnicmp</A> (CRT) -- takes&nbsp;one count parameter for both strings, but will also exit on an embedded null.&nbsp;If using the "C" locale, on each character it does an ASCII (A to Z) ToLowercase followed by a binary compare; otherwise on each character it does a full ToLowercase followed by a binary compare.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/strcmpnic.asp">StrCmpICW</A>&nbsp;(shlwapi.dll) -- assumes null-terminated strings. On each character it does an ASCII (A to Z) ToLowercase followed by a binary compare. It matches the "C" locale behavior of _wcsicmp, which of course does not match the OS behavior at all.</FONT> 
<LI><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/strcmpnic.asp">StrCmpNICW</A>&nbsp;(shlwapi.dll) -- takes&nbsp;one count parameter for both strings, but will also exit on an embedded null.&nbsp;On each character it does an ASCII (A to Z) ToLowercase followed by a binary compare. It matches the "C" locale behavior of _wcsicmp, which of course does not match the OS behavior at all.</FONT></LI></UL>
<P><FONT face=Tahoma>A few&nbsp;interesting points about these functions:</FONT></P>
<P><FONT face=Tahoma>1) According to comments in the SHLWAPI source, many of them were initially added because the CRT and user32&nbsp;counterparts were not supported on earlier versions of Win9x. Kind of ironic when you note the small behavior differences between them all, huh?</FONT></P>
<P><FONT face=Tahoma>2) Given the <a href="http://archives.miloush.net/michkap/archive/2004/12/02/273619.html">Georgian casing issue</A>, it&nbsp;is a little sad&nbsp;that almost&nbsp;all of these functions that convert prior to comparison use a lowercasing operation when so much of the core OS uses uppercasing.&nbsp;Especially given how often people use the functions to emulate&nbsp;the OS behavior for tidier validation messages. Luckily, the amount of data in Khutsuri is small so the inconsistency is not often noticed.</FONT></P>
<P><FONT face=Tahoma>3) Am I the only person who thinks it is weird that _wcsicmp and _wcsnicmp have locale-specific behaviors, especially such&nbsp;really weird ones? They doc this&nbsp;a bit I guess, but until I looked at the code I would never have guessed.</FONT></P>
<P><FONT face=Tahoma>4) CompareStringW&nbsp;is definitely the king of the linguistic comparison&nbsp;-- everyone else is either (a) calling our function, (b) doing&nbsp;the job&nbsp;wrong, or (c) both!</FONT></P>
<P><FONT face=Tahoma>Now there is no king (nor good heir apparent)&nbsp;for the non-linguistic comparison right now in unmanaged code, like I talk about <a href="http://archives.miloush.net/michkap/archive/2005/04/26/412079.html">here</A>. </FONT></P>
<P><FONT face=Tahoma>Yes, I am still thinking about it. :-)&nbsp; </FONT></P>
<P><FONT face=Tahoma>The situation&nbsp;is kind of like when you have&nbsp;a vacancy in management and a lot of "wannabe" replacements (like these other functions), none of whom really fit the bill and none of whom can get the job done themselves. If you know what I mean....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "Ï‚" <EM>(<A href="http://www.fileformat.info/info/unicode/char/03c2/index.htm">U+03c2</A>, a.k.a. GREEK SMALL LETTER FINAL SIGMA)</EM></FONT></FONT></P>
<hr/><p><a id="415529" href="#415529">#</a> <strong>Sriram</strong> on Sunday, May 08, 2005 2:40 PM:</p><div style="margin-left: 1em">All for the sake of comparing 2 strings. Whatever happened to good old strcmp? :-)</div>
<p><a id="415532" href="#415532">#</a> <strong>Michael S. Kaplan</strong> on Sunday, May 08, 2005 2:51 PM:</p><div style="margin-left: 1em">Ah, remember my criteria -- Unicode, case insensitive. The strcmp function (intrinsic or CRT) is none of those. :-)</div>
<p><a id="415542" href="#415542">#</a> <strong>Michael S. Kaplan</strong> on Sunday, May 08, 2005 3:37 PM:</p><div style="margin-left: 1em">Don't worry, I'll point out the explosion of methods and overrides in managed code soon. I hinted at them in <a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/04/14/408116.html">http://blogs.msdn.com/michkap/archive/2005/04/14/408116.aspx</a><br><br>:-)</div>
<p><a id="415568" href="#415568">#</a> <strong>Dean Harding</strong> on Sunday, May 08, 2005 7:04 PM:</p><div style="margin-left: 1em">Well, to be honest, I prefer lots of overloads to lots of differently-named functions.  At least with overloads you can look in the same place for all the documentation whereas with differently-named functions, you've got to rely on the documentation to include pointers to all the other possible variants.<br><br>Still, one function that can do it all would be best of all, even if I have to write my own little wrappers for my own special cases.  At least then I can follow my own standards, rather than trying to remember the difference between RtlCompareUnicodeString, StrCmpNIW and lstrcmpiW for example...</div>
<p><a id="415573" href="#415573">#</a> <strong>Michael S. Kaplan</strong> on Sunday, May 08, 2005 7:17 PM:</p><div style="margin-left: 1em">Well, me too.<br><br>But I prefer fewer functions with fewer overrides best of all -- with lots of intuitive enumerations, which intellisense also help with....</div>
<p><a id="415860" href="#415860">#</a> <strong>Someone passing by</strong> on Monday, May 09, 2005 5:56 PM:</p><div style="margin-left: 1em"># StrCmpLogicalW (shlwapi.dll) -- does linguistic comparisons using the thread locale (falling back to the system locale on failure), cleverly wrapping multiple calls to CompareStringW to upport treating the 0123456789 digits as numbers.<br>^<br><br>to support;)</div>
<p><a id="415903" href="#415903">#</a> <strong>Michael S. Kaplan</strong> on Monday, May 09, 2005 9:26 PM:</p><div style="margin-left: 1em">Good catch -- fixed now. :-)</div>
<p><a id="435646" href="#435646">#</a> <strong>Nazgul</strong> on Tuesday, July 05, 2005 9:16 AM:</p><div style="margin-left: 1em">Hi. I'm trying to use CompareStringW to compare some WideStrings and I need to compare them case-sensitively. However, I always got then compared case-insensitively. I did NOT set the &quot;NORM_IGNORECASE&quot; flag on.<br>So, when I sort strings &quot;France&quot;, &quot;Portugal&quot; and &quot;other&quot;, I want the result to be either<br><br>France<br>Portugal<br>other<br><br>or<br><br>other<br>France<br>Portugal<br><br>but what I get is<br><br>France<br>other<br>Portugal<br><br>cuz when I compare &quot;France&quot; and &quot;Portugal&quot;, the result is 1 (this is correct), comparing &quot;other&quot; and &quot;Portugal&quot; gives 1 (that's correct, too), but comparing &quot;France&quot; and &quot;other&quot; also gives 1 (incorrect, should be 3).<br>It's interesting that whene I call CompareStringW on &quot;portugal&quot; and &quot;Portugal&quot; the result I get is not 2, but 1. It looks like this function does case-insensitive comparison, and only if the compared strings don't differ (case-insensitive) it looks on the case.<br>Is there a way to make the CompareStringW function not ignore the case?<br>I am using locale MAKELCID(MAKELANGID(LANG_CZECH, SUBLANG_DEFAULT), SORT_DEFAULT), but it behaves exactly in the same way even if I set it to MAKELCID(MAKELANGID(LANG_ENGLISH, SUBLANG_DEFAULT), SORT_DEFAULT).</div>
<p><a id="435670" href="#435670">#</a> <strong>Michael S. Kaplan</strong> on Tuesday, July 05, 2005 10:32 AM:</p><div style="margin-left: 1em">Hi Nazgul, See my post 'What it means to be case insensitive' at &lt;A HREF=&quot;/michkap/archive/2005/06/16/429667.aspx&quot;&gt;<a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/06/16/429667.html</A>">http://blogs.msdn.com/michkap/archive/2005/06/16/429667.aspx&lt;/A&gt;</a> to understand what is meant here. There is no NLS function that does what you want here, and it would certainly not be an 'ignore case' since that is the opposite of what you are doing -- you are not only *not* ignoring case, you are going out o you way to pay attention to it in non-intuitive ways! :-)</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/06/16 <a href="http://archives.miloush.net/michkap/archive/2006/06/16/634124.html">Neither GDI nor Uniscribe solve the ultimate font problem completely, either</a></p><p>2006/03/15 <a href="http://archives.miloush.net/michkap/archive/2006/03/15/551773.html">Casing and IgnoreCase are still not the same thing....</a></p><p>2005/06/16 <a href="http://archives.miloush.net/michkap/archive/2005/06/16/429759.html">More on locales in SQL Server</a></p><p>2005/06/12 <a href="http://archives.miloush.net/michkap/archive/2005/06/12/428429.html">Browsing the shoals of managed string comparisons</a></p><p>2005/06/02 <a href="http://archives.miloush.net/michkap/archive/2005/06/02/424128.html">The New String recommendations</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/08/415539.html" title="Why do we park on a driveway, and drive on a parkway?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/07/415376.html" title="VB6 isn&#39;t using Unicode, most of the time">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/08/415522.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>