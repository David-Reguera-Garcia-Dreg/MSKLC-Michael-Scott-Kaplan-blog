<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/05/414845.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A few of the gotchas of CompareString</title></head><body>
<h1>A few of the gotchas of CompareString</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/05 02:12 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/05/414845.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A> is one of the coolest APIs. I thought so even before I owned it, before I really even met the people who used to own it (or the woman who wrote it, for that matter).</FONT></P>
<P><FONT face=Tahoma>But&nbsp;like any API, it can have its gotchas, its problems.</FONT></P>
<P><FONT face=Tahoma>Now if you think of the NLS information as a huge database, then the Locale Identifier (a.k.a. the LCID) is its primary key. It is the very first parameter of <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A>.</FONT></P>
<P><FONT face=Tahoma>If you are&nbsp;calling the non-Unicode version (CompareStringA), then rather than converting via the default system code page, it converts parameters via the default code page of the locale you pass in. Among other things, this means that you can't ever use CompareStringA to handle UTF-8 text.</FONT></P>
<P><FONT face=Tahoma>Ok, let's move on to the all important second parameter, the one with the flags. I'll talk about each of the flags here:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Tahoma><STRONG>NORM_IGNORECASE</STRONG> - Ignore case. A better name for this flag might have been IGNORE_TERTIARYWEIGHT since that is what it accomplishes (it masks the tertiary weight), although it is obviously too late to consider such a change. It can cause undesirable results when used in the comparison of strings containing characters that depend on the weight for vital information, which thankfully is a very small number of cases. But if you are not expecting "ʏ", "Y", and "y"&nbsp;(<A href="http://www.fileformat.info/info/unicode/char/028f/index.htm">U+028f</A>, <A href="http://www.fileformat.info/info/unicode/char/0059/index.htm">U+0059</A>, and <A href="http://www.fileformat.info/info/unicode/char/0079/index.htm">U+0079</A>, a.k.a. LATIN LETTER SMALL CAPITAL Y, LATIN LETTER CAPITAL Y, and LATIN LETTER SMALL Y) to all be equal, then you may want to think twice about throwing this flag into the mix. You will also lose the distinctions of the final forms for Hebrew (e.g. "מ" and "ם", <A href="http://www.fileformat.info/info/unicode/char/05de/index.htm">U+05de</A> <A href="http://www.fileformat.info/info/unicode/char/05dd/index.htm">U+05dd</A> a.k.a. HEBREW LETTER MEM and HEBREW LETTER FINAL MEM), Arabic (e.g. "ش" <A href="http://www.fileformat.info/info/unicode/char/0634/index.htm">U+0634</A> a.k.a. ARABIC LETTER SHEEN and its isolated, final, initial, and medial forms (ﺵ, ﺶ, ﺷ, and ﺸ) at <A href="http://www.fileformat.info/info/unicode/char/feb5/index.htm">U+feb5</A>, <A href="http://www.fileformat.info/info/unicode/char/feb6/index.htm">U+feb6</A>, <A href="http://www.fileformat.info/info/unicode/char/feb7/index.htm">U+feb7</A>, and <A href="http://www.fileformat.info/info/unicode/char/feb8/index.htm">U+feb8</A>, and other languages.</FONT></P>
<P><FONT face=Tahoma><STRONG>NORM_IGNORENONSPACE</STRONG> - Ignore nonspacing characters. A better name for this flag might have been IGNORE_SECONDARYWEIGHT since that is what it accomplishes (it masks the secondary weight). It can cause undesirable results when used in the comparison of strings containing characters that depend on the weight for vital information. The most visible example of this is in Korean, where <A href="http://www.fileformat.info/info/unicode/char/ac00/index.htm">U+ac00</A> (가, Hangul Syllable Kiyeok A) can suddenly be considered eqivalent to all of the following characters: 伽 佳 假 價 加 可 呵 哥 嘉 嫁 家 暇 架 枷 柯 歌 珂 痂 稼 苛 茄 街 袈 訶 賈 跏 軻 迦 駕 仮 傢 咖 哿 坷 宊 斝 榎 檟 珈 笳 耞 舸 葭 謌. For the rest of the Hangul syllables, some are better and some are worse, and the problem exists in other languages as well. </FONT></P>
<P><FONT face=Tahoma><STRONG>NORM_IGNORESYMBOLS</STRONG> - Ignore symbols such as "_", "#", and "*". The list of symbols is "increased" when SORT_STRINGSORT is specified, since punctuation is then also treated as symbols. This is often useful but can wreak havoc if you are searching for things like C++ or C#.</FONT></P>
<P><FONT face=Tahoma><STRONG>SORT_STRINGSORT</STRONG> - Treat punctuation the same as symbols. For example, a STRING sort treats co-op and co_op as strings that should sort together since the hyphen and the underscore are both treated as symbols. On the other hand, a WORD sort treats the hyphen and apostrophe differently, so that co-op and co_op would not sort together but co-op and coop would. The real documentation for this is built into the winnls.h header file:</FONT></P>
<BLOCKQUOTE dir=ltr>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=1>//<BR>//&nbsp; Sorting Flags.<BR>//<BR>//&nbsp;&nbsp;&nbsp; WORD Sort:&nbsp;&nbsp;&nbsp; culturally correct sort<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hyphen and apostrophe are special cased<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; example: "coop" and "co-op" will sort together in a list<BR>//<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; co_op&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; underscore (symbol)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coat<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comb<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coop<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; co-op&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; hyphen (punctuation)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cork<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; went<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; were<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; we're&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; apostrophe (punctuation)<BR>//<BR>//<BR>//&nbsp;&nbsp;&nbsp; STRING Sort:&nbsp; hyphen and apostrophe will sort with all other symbols<BR>//<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; co-op&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; hyphen (punctuation)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; co_op&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; underscore (symbol)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coat<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comb<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coop<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cork<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; we're&nbsp;&nbsp;&nbsp;&nbsp; &lt;-------&nbsp; apostrophe (punctuation)<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; went<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; were<BR>//</FONT></P></BLOCKQUOTE></BLOCKQUOTE><FONT face=Tahoma>
<P><STRONG>NORM_IGNOREKANATYPE</STRONG> - Do not differentiate between Hiragana and Katakana characters. Corresponding Hiragana and Katakana characters compare as equal (e.g. "げ" <A href="http://www.fileformat.info/info/unicode/char/3052/index.htm">U+3052</A> HIRAGANA LETTER GE versus "ゲ" <A href="http://www.fileformat.info/info/unicode/char/30b2/index.htm">U+30B2</A> KATAKANA LETTER GE) Calling LCMapString with the LCMAP_HIRAGANA or the LCMAP_KATAKANA flag on both strings would flatten the comparison in an analogous manner. There are many times that the distinction is important (certainly the times they are used are different such that searching through both may often give unexpected results).</P>
<P><STRONG>NORM_IGNOREWIDTH</STRONG> - Do not differentiate between the halfwidth and fullwidth forms of characters. These two forms exist in Unicode for the sake of backward compatibility with legacy CJK standards that encoded the two forms. In those legacy standards, the halfwidth forms used one byte while the fullwidth forms used two bytes, and by convention the glyph was twice as large (e.g.&nbsp; "ヲ"&nbsp; <A href="http://www.fileformat.info/info/unicode/char/30f2/index.htm">U+30F2</A> KATAKANA LETTER WO&nbsp; versus "ｦ", <A href="http://www.fileformat.info/info/unicode/char/ff66/index.htm">U+FF66</A> HALFWIDTH KATAKANA LETTER WO). Calling LCMapString with the LCMAP_FULLWIDTH or the LCMAP_HALFWIDTH flag on both strings would flatten the comparison in an analogous manner. Generally speaking, there are interesting times that each is often used for the sake of appearance or functionality, so while the initial purpose was for those legacy standards, modern usage is a bit more reasoned (example:properties in Japanese Access are full-width, while the descriptive string in the property sheet often uses the halfwidth string as it has a preferred appearance.</P></BLOCKQUOTE>
<P>Looking at the third and fifth parameters, they are the actual strings being compared.</P>
<P>And then finally, the fourth and sixth parameters give the length of the string, in UTF-16 code points.</P>
<P>Now for actual usage, the intent is clear: through the use of <a href="http://archives.miloush.net/michkap/archive/2005/02/02/365251.html">meaningful strings</A>&nbsp;that have <a href="http://archives.miloush.net/michkap/archive/2005/01/18/355210.html">defined weights</A> in the Windows collation tables, developers have the opportunity to get back linguistically appropriate results. When you veer outside of this realm, you may not get the results you (or your users) are expecting. And as the info about flags above really indicates, the indiscriminate use of flags here is&nbsp;a really bad idea that can lead to non-intuitive results.</P>
<P>Now what would be intuitive? In my opinion the following approach is best:</P>
<OL>
<LI>Passing potentially destructive flags with the API call, which will produce more search results 
<LI>Calling again without the flags, to get the smaller and more specific list 
<LI>Using these "preferred results" from #2 to prioritize #1 in any type of search list</LI></OL>
<P>We could call this the "Google" principle -- the large searchlist is not impessive because many choices would need review, but because the most relevant items are near the top snd you seldom need to look at the full list. I would highly recommend such an approach, to go along with the versioning issues that I have discussed in the past. Such an approach can give you intuitive results while minimixing confusing resultsets.</P>
<P>Now there are more issues that I could discuss, but I thought it might wait unil another day to talk about it a bit more....</P>
<P>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post brought to you by </EM>"ʏ"<EM> (<A href="http://www.fileformat.info/info/unicode/char/028f/index.htm">U+028f</A>, a.k.a. LATIN LETTER SMALL CAPITAL Y)</EM></FONT></P></FONT>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/09/07 <a href="http://archives.miloush.net/michkap/archive/2010/09/07/10058112.html">Refusing to ignore some particular character's width isn't [always] an act of discrimination…</a></p><p>2010/06/10 <a href="http://archives.miloush.net/michkap/archive/2010/06/10/10021417.html">WORD SORT...Why'd it have to be...WORD SORT?</a></p><p>2008/02/22 <a href="http://archives.miloush.net/michkap/archive/2008/02/22/7846597.html">Optimized for English (oh, and also Invariant, and NOTHING ELSE) Redux</a></p><p>2007/10/09 <a href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html">A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</a></p><p>2007/09/20 <a href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html">A&P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)</a></p><p>2007/05/06 <a href="http://archives.miloush.net/michkap/archive/2007/05/06/2448753.html">One product's feature is another product's bug -- just ask 'em!</a></p><p>2006/11/16 <a href="http://archives.miloush.net/michkap/archive/2006/11/16/1086283.html">The problem of string comparisons, WORD sorts, and the minus that is treated like the hyphen</a></p><p>2006/11/01 <a href="http://archives.miloush.net/michkap/archive/2006/11/01/916477.html">If you add enough characters to a sort, intuitive distinction can suffer</a></p><p>2006/05/24 <a href="http://archives.miloush.net/michkap/archive/2006/05/24/605603.html">Is it punctuation, symbol, or diacritic?</a></p><p>2006/05/24 <a href="http://archives.miloush.net/michkap/archive/2006/05/24/605599.html">Invariant vs. Ordinal, the third</a></p><p>2006/05/04 <a href="http://archives.miloush.net/michkap/archive/2006/05/04/589656.html">Sort the words, sort the strings</a></p><p>2005/09/11 <a href="http://archives.miloush.net/michkap/archive/2005/09/11/463672.html">Fonts that are 'fixed-width' even if they do not claim to be</a></p><p>2005/06/24 <a href="http://archives.miloush.net/michkap/archive/2005/06/24/432121.html">LCMapString's *other* job</a></p><p>2005/05/11 <a href="http://archives.miloush.net/michkap/archive/2005/05/11/416293.html">Case/kana/accent/width sensitive SQL Server, for testing</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/05/414933.html" title="Community Server issues that seem affect this blog">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/04/414562.html" title="Why does MSLU wrap ________ ?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/05/414845.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>