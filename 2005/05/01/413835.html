<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/01/413835.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Exploiting the linker's rules in unicows.lib</title></head><body>
<h1>Exploiting the linker's rules in unicows.lib</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/01 12:43 -07:00, original URI: http://blogs.msdn.com/michkap/archive/2005/05/01/413835.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P><FONT face=Tahoma>I wanted to clarify the way that unicows.lib works.</FONT></P>
<P><FONT face=Tahoma>This .LIB file is not the usual sort. It has in it a bunch of symbols, for each API that unicows.dll supports. Lets look at what a bit of that looks like -- say running the following on unicows.lb and kernedl32.lib looking at a particular API (I'll try using my favorite API -- <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp">CompareString</A>):</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=4><STRONG>link -dump -all unicows.lib &gt;link_unicows.txt<BR>link -dump -all kernel32.lib &gt;link_kernel32.txt</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>The output is huge (over 11mb)&nbsp;for unicows.lib,&nbsp;and most of them are obviously for other functions anyway, which is why I dumped them both&nbsp;to a file. Here is what kernel32.lib has to say about CompareStringW:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp; 19400 </STRONG></FONT><FONT face="Courier New" size=2><STRONG><A href="mailto:_CompareStringW@24">_CompareStringW@24</A> &nbsp;</STRONG></FONT><BR><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp; 19400 </STRONG></FONT><FONT face="Courier New" size=2><STRONG><A href="mailto:__imp__CompareStringW@24">__imp__CompareStringW@24</A></STRONG></FONT><BR><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2D </STRONG></FONT><A href="mailto:_CompareStringW@24"><FONT face="Courier New" size=2><STRONG>_CompareStringW@24</STRONG></FONT></A><BR><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 2D </STRONG></FONT><A href="mailto:__imp__CompareStringW@24"><FONT face="Courier New" size=2><STRONG>__imp__CompareStringW@24</STRONG></FONT></A><BR><FONT face="Courier New" size=2><STRONG>&nbsp; Version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 0<BR>&nbsp; Machine&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 14C (x86)<BR>&nbsp; TimeDateStamp: 41C232BB Thu Dec 16 17:13:31 2004<BR>&nbsp; SizeOfData&nbsp;&nbsp; : 00000020<BR>&nbsp; DLL name&nbsp;&nbsp;&nbsp;&nbsp; : KERNEL32.dll<BR>&nbsp; Symbol name&nbsp; : </STRONG></FONT><A href="mailto:_CompareStringW@24"><FONT face="Courier New" size=2><STRONG>_CompareStringW@24</STRONG></FONT></A><BR><FONT face="Courier New" size=2><STRONG>&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : code<BR>&nbsp; Name type&nbsp;&nbsp;&nbsp; : undecorate<BR>&nbsp; Hint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : 59<BR>&nbsp; Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : CompareStringW<BR></STRONG></FONT><FONT face="Courier New" size=2><STRONG>Archive member name at 19470: KERNEL32.dll/&nbsp;&nbsp; <BR>41C232BB time/date Thu Dec 16 17:13:31 2004<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; gid<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 mode<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 35 size<BR>correct header end<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </STRONG></FONT><A href="mailto:_CompareStringW@24"><FONT face="Courier New" size=2><STRONG>_CompareStringW@24</STRONG></FONT></A></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now&nbsp;looking at the bigger unicows.lib file and its references to CompareString. Those who are curious can run the above command line -- it is a huge file. </FONT></P>
<P dir=ltr><FONT face=Tahoma>The biggest part of all this is the names that are the same between them. By putting unicows.lib <STRONG>before</STRONG> kernel32.lib, any time anyone tries to reference CompareStringW in any of its forms, it will find MSLU's rather than the operating system's. Simple misdirection, really. Now the rules of the linker in looking for symbols are simple: l</FONT><FONT face=Tahoma>ook in all of the .OBJ files, then l</FONT><FONT face=Tahoma>ook in all of the .LIB files, in order from left to right as they are explicitly listed.</FONT></P>
<P><FONT face=Tahoma>So the trick is just to put unicows.lib first -- it will win!</FONT></P>
<P><FONT face=Tahoma>The rest is a little bit trickier -- there is a pointer called _kernel32_CompareStringW_Thunk which will sit in the user's image, and it points to a function also inside of the user's image called ResolveThunk(). This ResolveThunk() function is the one that does the work to figure out what platform you are running on and then call either the function in unicows.dll or the one in the operating system (calling something like the same GetProcAddress that you would call if you wanted a function pointer). It then fixes up that pointer in _kernel32_CompareStringW_Thunk to call the function it selected, so that ResolveThunk() never needs to be called again for the function that was just resolved.</FONT></P>
<P><FONT face=Tahoma>Think of it as&nbsp;a static version of the information that is dynamically generated when you use DelayLoad.</FONT></P>
<P><FONT face=Tahoma>Now I do not want to take credit for this work, the real genius here comes from two people: Bryan Tuttle (most likely person to fix and least likely person to break the Windows build on any given day of the week, and the person who originally pointed out to me the real problems in Godot using DelayLoad itself and blocking others from using it) and the recently retired Dan Spalding (also known to many as the father of the linker or the <a href="http://blogs.msdn.com/aprilr/archive/2005/3/29.aspx">linker god at Microsoft</A>&nbsp;and the original author of the Delayload technology on which much of this approach is based). </FONT></P>
<P><FONT face=Tahoma>And o<FONT face=Tahoma>f course I am oversimplifying here, as there are many interesting gotchas that unicows.lib hits (from failure cases to functions that are not there to functions that are hard to call to avoiding assembly language and more), which I'll talk about another day....</FONT></P></FONT>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "U" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0055/index.htm">U+0055</A>, a.k.a. LATIN CAPITAL LETTER U)<BR><FONT size=1>(Because "U" is for Unicows, Unicode, and UBetcha!)</FONT></EM></FONT></FONT></P>
<hr/><p><a id="413964" href="#413964">#</a> <strong>James Todd</strong> on Monday, May 02, 2005 10:44 AM:</p><div style="margin-left: 1em">Nifty. Thanks for the info! I'd like to ask a few more questions about this to make sure I'm understanding it correct.<br><br>So let's say I'm calling CompareStringW, and I properly link with unicows.lib early in my link line. Then at runtime, I make my first call to CompareStringW. What happens at that stage? I'm assuming it goes into the unicows.lib function, which in turn just calls _kernel32_CompareStringW_Thunk. Now since this is the first time I've called CompareStringW, it thunks to the ResolveThunk function, which is also in unicows.lib. That function decides I'm on win9x, and points _kernel32_CompareStringW_Thunk to another function in unicows.dll that actually does the conversion of the wide string arguments so that the OS's non-unicode CompareString can be called. Then later in my runtime when I make additional calls to CompareStringW, I still end up in a unicows.lib function which again calls _kernel32_CompareStringW_Thunk, but this time it goes straight to the actual implementation function in unicows.dll, thus skipping the call to ResolveThunk.<br><br>Is that more or less correct? In my scenario above, each function is only resolved on the first time it's called, rather than all functions being resolved at once during program initialization, and I'm not sure if that's what's happening or not.<br><br>Last question: When exactly does unicows.dll get loaded?<br><br>Thanks!<br>James</div>
<p><a id="413970" href="#413970">#</a> <strong>Michael S. Kaplan</strong> on Monday, May 02, 2005 11:01 AM:</p><div style="margin-left: 1em">Hi James -- Your understanding is exactly correct. ;-)<br><br>unicows.dll is loaded the first time you call an API that has to load it. On NT-based systems that means never....</div>
<p><a id="414002" href="#414002">#</a> <strong>James Todd</strong> on Monday, May 02, 2005 12:20 PM:</p><div style="margin-left: 1em">Thanks Michael. :-)<br><br>James</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/12/26 <a href="http://archives.miloush.net/michkap/archive/2010/12/26/10108989.html">I don't see any scripture claiming 413835 is the number of the beast, but...</a></p><p>2005/05/11 <a href="http://archives.miloush.net/michkap/archive/2005/05/11/416624.html">Why UnicoWS.dll forwards to the OS on Unicode platforms</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/01/413886.html" title="Some more Windows acronyms explained">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/04/30/413721.html" title="Pronunciational ambiguity">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-01">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/01/413835.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>