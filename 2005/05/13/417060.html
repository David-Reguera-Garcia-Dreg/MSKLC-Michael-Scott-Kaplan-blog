<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/13/417060.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What code page does MSLU convert with?</title></head><body>
<h1>What code page does MSLU convert with?</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/13 02:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/13/417060.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>The <A href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx">Microsoft Layer for Unicode</A> is usually just a very simple wrapper over the non-Unicode APIs on Window 95, 98, and Me, that uses the default system code page to do the conversions.</FONT></P>
<P><FONT face=Tahoma>There are of course exceptions to this; there are times when Win9x will do just fine with the original Unicode strings, and when that is the case, MSLU works hard to honor that support. I will talk about those cases another day. </FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma><EM>(A lot of the information in this post has already been published in that article that was written for </EM></FONT><A href="http://msdn.microsoft.com/msdnmag/"><FONT face=Tahoma><EM>MSDN Magazine</EM></FONT></A><FONT face=Tahoma><EM> entitled </EM></FONT><A href="http://msdn.microsoft.com/msdnmag/issues/01/10/MSLU/"><FONT face=Tahoma><EM>MSLU: Develop Unicode Applications for Windows 9x Platforms with the Microsoft Layer for Unicode</EM></FONT></A><FONT face=Tahoma><EM>. I just did not have the same space restrictions here!)</EM></FONT></P>
<P>But the question of what code page to use is not one that is always universally clear. </P>
<P>I would say there are six different buckets that the various functions fall into:</FONT></P>
<UL>
<LI><FONT face=Tahoma>Some use the default system codepage (CP_ACP), the one returned by the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_21bk.asp">GetACP</A> function;<BR><FONT size=2>(e.g. functions like </FONT><A href="http://msdn.microsoft.com/library/en-us/gdi/devcons_5g83.asp"><FONT size=2>CreateDC</FONT></A><FONT size=2>, and most of the other functions that MSLU wrapped)</FONT></FONT> 
<LI><FONT face=Tahoma>Some use the default system OEM code page (CP_OEMCP), the one returned by the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_7q5s.asp">GetOEMCP</A>() function;<BR><FONT size=2>(e.g. functions like </FONT><A href="http://msdn.microsoft.com/library/en-us/winui/winui/stringreference/stringfunctions/chartooembuff.asp"><FONT size=2>CharToOemBuff</FONT></A><FONT size=2>)</FONT></FONT> 
<LI><FONT face=Tahoma>Some could use either of the above two code pages, depending on the return from the <A href="http://msdn.microsoft.com/library/en-us/fileio/base/arefileapisansi.asp">AreFileApisANSI</A> function;<BR><FONT size=2>(e.g. file managment functions like </FONT><A href="http://msdn.microsoft.com/library/en-us/fileio/fs/findfirstfile.asp"><FONT size=2>FindFirstFile</FONT></A><FONT size=2>)</FONT></FONT> 
<LI><FONT face=Tahoma>Some use the ACP of a particular LCID, as returned by a call to <A href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A>&nbsp;with the LOCALE_IDEFAULTANSICODEPAGE flag;<BR><FONT size=2>(e.g. all of the NLS APIs that take LCID parameters, like </FONT><A href="http://msdn.microsoft.com/library/en-us/intl/nls_8a0k.asp"><FONT size=2>GetNumberFormat</FONT></A><FONT size=2>)</FONT></FONT> 
<LI><FONT face=Tahoma>Some use the ACP based on a particular device context handle (HDC), which has a Charset associated with it;<BR><FONT size=2>(e.g. most of the GDI functions that take an HDC parameter, like </FONT><A href="http://msdn.microsoft.com/library/en-us/gdi/fontext_15kk.asp"><FONT size=2>GetTextExtentExPoint</FONT></A><FONT size=2>)</FONT></FONT> 
<LI><FONT face=Tahoma>A very few use other mechanisms entirely, we'll call it the miscellaneous bucket.<BR><FONT size=2>(e.g. </FONT><A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/dataexchange/clipboard/clipboardreference/clipboardfunctions/getclipboarddata.asp"><FONT size=2>GetClipboardData</FONT></A><FONT size=2>, which can use all manner of code pages depending on whether CF_LOCALE is specified on the clipboard or synthetic formats are being supported)</FONT></FONT></LI></UL>
<P><FONT face=Tahoma>The decisions over what to use for the conversion were not arbitrary. </FONT></P>
<P><FONT face=Tahoma>Because, believe it or not, there are many internal pieces of Win9x that actually do support Unicode. This is&nbsp;a fact that Chris Wendt reminded me of years ago, when he pointed to TrueType fonts, large pieces of the GDI that uses those fonts, the NLS data, all of the COM interfaces in the Shell, and more. And he was right; Unicode support is sometimes more than just the interface.&nbsp;&nbsp;</FONT></P>
<P><FONT face=Tahoma>Thus in cases where conversion was already being done by the operating system, the goal was to match that conversion that the OS itself was doing. Because any time we did not match the OS behavior,&nbsp;all of the string outside of ASCII was probably corrupted.</FONT></P>
<P><FONT face=Tahoma>So the answer to the question first posed in the title of this post (<EM>What code page does MSLU convert with?</EM>) is that it really depends.&nbsp;On the function you are calling,&nbsp;sometimes on how you are calling it, and sometimes on the way other functions have set the stage....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<FONT size=4>Üœ</FONT>" </FONT><EM><FONT color=#ff0000>(</FONT><A href="http://www.fileformat.info/info/unicode/char/071c/index.htm">U+071c</A><FONT color=#ff0000>, a.k.a. SYRIAC LETTER TETH GARSHUNI)</FONT></EM></FONT></P>
<hr/><p><a id="417219" href="#417219">#</a> <strong>Mike Dimmick</strong> on 13 May 2005 10:42 AM:</p><div style="margin-left: 1em">How much consideration did you give to the implementation of NT's A version of the APIs?</div>
<p><a id="417223" href="#417223">#</a> <strong>Michael S. Kaplan</strong> on 13 May 2005 10:57 AM:</p><div style="margin-left: 1em">Good question. Not very much, to tell the truth. The goal has always been to encourage movement to Unicode-based platforms, not to make non-Unicode platforms more appealing....</div>
<p><a id="417568" href="#417568">#</a> <strong>Qflash</strong> on 15 May 2005 2:33 AM:</p><div style="margin-left: 1em">RePost:<br><a rel="nofollow" target="_new" href="http://www.yeyan.cn/SoftwareEngineering/MSLUconvert.aspx">http://www.yeyan.cn/SoftwareEngineering/MSLUconvert.aspx</a></div>
<p><strong>Yuhong Bao</strong> on 30 Aug 2010 7:29 PM:</p><div style="margin-left: 1em"><p>What is unfortunate is that the only choices in .NET P/Invokes are Charset.Ansi, Charset.Unicode, and Charset.Auto! There is no Charset.Oem or Charset.AutoOem options, which is a problem when calling console functions. And classic VB always use the ANSI codepage of course. You have to be careful when you call functions using any of these to ensure the function really do use the ANSI codepage. Usually that is quite easy, but often when calling console functions you have no other choice!</p>
</div>
<p><strong>Yuhong Bao</strong> on 30 Aug 2010 7:32 PM:</p><div style="margin-left: 1em"><p>Some workarounds if there is no other choice include manually converting the string, which is easy in .NET, but in classic VB, I think you have to manually invoke WideCharToMultiByte and MultiByteToWideChar!</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/07/11 <a href="http://archives.miloush.net/michkap/archive/2007/07/11/3823291.html">GB18030 isn't an ACP, either</a></p><p>2006/08/22 <a href="http://archives.miloush.net/michkap/archive/2006/08/22/707665.html">'Unicode' doesn't corrupt, but 'ANSI' can corrupt, absolutely!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/13/417167.html" title="What it means to be in the default install">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/12/416761.html" title="Why doesn&#39;t GetDateFormat take a CALID?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-13">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/13/417060.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>