<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/14/417384.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Encoding questions from the Suggestion Box</title></head><body>
<h1>Encoding questions from the Suggestion Box</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/14 02:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/14/417384.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma><A href="http://www.magerquark.com/">Uwe Keim</A> asked (in the <a href="http://archives.miloush.net/michkap/archive/2005/04/01/404554.html">suggestion box</A>) several questions about encoding support and strings in the .NET Framework:</FONT></P>
<P><EM><FONT color=#808080>Michael, I need your knowledge about how all this encoding stuff on strings work on .NET (I searched hours without finding usful things).</FONT></EM></P>
<P><EM><FONT color=#808080>Maybe you can enlight me a little bit. Maybe I can motivate you with some italien Limonata? :-)</FONT></EM></P>
<P><FONT face=Tahoma>Well, no Limonata needed (I already have a big stack of&nbsp;cases of it already &lt;grin&gt;).&nbsp;I thought I would answer the&nbsp;qustions&nbsp;here even without the generous bribe :-)</FONT></P>
<P><EM><FONT color=#808080>- how do I detect the encoding of the content of a System.String? </FONT></EM></P>
<P><FONT face=Tahoma>Ah, that part is easy -- System.String is always assumed to be UTF-16 LE (little endian). Always. If you convert it to anything else, you get a byte array in the encoding you convert to.</FONT></P>
<P><FONT face=Tahoma>Now this is a change from the old world of VB and VBA and VBScript, where people would often use the String type to store non-Unicode string things, occasionally getting into trouble when conversions happened.&nbsp;But it is how things are now.</FONT></P>
<P><FONT face=Tahoma>Now the detection of encodings in byte arrays is an interesting question, one that does not have a good managed answer at this time.</FONT></P>
<P><FONT color=#808080><EM>- how can we at all convert a string from one encoding to another encoding (like in the example at <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemtextencodingclasstopic.asp">http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemtextencodingclasstopic.asp</A></EM></FONT><FONT color=#808080><EM>), since I read that .NET internally stores all strings as UTF-16 in memory? (or do I confuse codepage with encoding?) </EM></FONT></P>
<P><FONT face=Tahoma>Well, encodings are the classes that make use of code pages -- so they are in essence the same thing. The code pages are esssentially mappings between Unicode and various non-Unicode encodings -- the "String" end is UTF-16 LE and the "byte" end is the other encoding, whatever it is. </FONT></P>
<P><FONT face=Tahoma>So you can never convert from one encoding to another -- but you can use Unicode as a pivot -- going from one encoding to Unicode to another encoding, if you want to. </FONT></P>
<P><EM><FONT color=#808080>- What happens behind the scenes when loading a database value from NVARCHAR into System.String? Is there any encoding/codepage-conversion done? </FONT></EM></P>
<P><FONT face=Tahoma>In SQL Server 7.0, 2000, or 2005, the NTEXT, NVARCHAR, and NCHAR types also represent UTF-16 LE, so no conversion needs to be done. </FONT></P>
<P><FONT face=Tahoma>If you come from a TEXT, VARCHAR, or CHAR column, then a conversion must be done. Both SQL Server and the .NET Framework have support for that conversion&nbsp;(SQL Server uses the MultiByteToWideChar function, and the .NET Framework uses an Encoding object based on the appropriate code page value). </FONT></P>
<P><FONT face=Tahoma>To be honest, I am not sure which product does the actual conversion in this case, but it is pretty much the same operation, either way. :-)</FONT></P>
<P><FONT face=Tahoma>If you have any other questions about encodings/code pages, you can ask them here. You can also take a look at Shawn Steele's <a href="http://blogs.msdn.com/shawnste">blog</A>&nbsp;(he is the dev. owner of the encoding stuff in Windows and the .NET Framework).</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<FONT size=6>à°¹</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0c39/index.htm">U+0c39</A>, a.k.a. TELUGU LETTER HA)<BR><FONT size=1>A letter that can only be found on one code page on Windows -- ISCII&nbsp;57005 -- supports, unless you count UTF-8 and GB-18030 that support all of Unicode....</FONT></EM></FONT></FONT></P>
<hr/><p><a id="417517" href="#417517">#</a> <strong>bg</strong> on 14 May 2005 4:16 PM:</p><div style="margin-left: 1em">i had a strange run in with an Encoder (UTF8Encoding) yesterday.<br><br>i had some bytes in an array, and needed to convert them to a string so i did this:<br><br>char[] chars = Utf8Encoding.UTF8.GetChars(bytes);<br>string xml = new string(chars);<br><br>and to my surprise the string started with a BOM. this is really annoying because i can't find anything in the docs that would indicate this would happen. (mind u i haven't looked that hard :))<br><br>its easy to fix: ... xml = new string(chars,1,chars.Length-1);<br><br>but still annoying!<br><br>bg</div>
<p><a id="417522" href="#417522">#</a> <strong>Michael S. Kaplan</strong> on 14 May 2005 5:07 PM:</p><div style="margin-left: 1em">If there is a BOM in the UTF-8, it should still be there after conversion, right?</div>
<p><a id="417525" href="#417525">#</a> <strong>bg</strong> on 14 May 2005 5:40 PM:</p><div style="margin-left: 1em">encoding problem:<br><br>actually thinking about it, it must be me thats writing crap code, I thought the BOM was being introduced by the Getchars call, but it can't be because it would push all my chars down in the the string and and truncate it - which it wasn't - the BOM is being introduced further up in my code. The actual &quot;string&quot; is being build up by an xmlwriter thats wrapped around a memorystream and it must be adding a BOM to the byte array i'm getting out of it (via a call o memorystream.read).<br><br>sorry my fault - me being stoopid.<br><br>i've just got back from the theatre (Kevin spacey in Philadelphia story - very good) And it's taking a while to get the mind back into gear - don't ever get old ;)<br><br>bg</div>
<p><a id="417529" href="#417529">#</a> <strong>Michael S. Kaplan</strong> on 14 May 2005 6:49 PM:</p><div style="margin-left: 1em">No worries, bg. Glad you were able to track down the cause.</div>
<p><a id="417561" href="#417561">#</a> <strong>Uwe Keim</strong> on 15 May 2005 1:52 AM:</p><div style="margin-left: 1em">Thank you very much for your answers!</div>
<p><a id="417572" href="#417572">#</a> <strong>Dean Harding</strong> on 15 May 2005 2:46 AM:</p><div style="margin-left: 1em">I would assume that the conversion from TEXT, CHAR and VARCHAR to unicode actually happens at the database, since the db libraries are all COM and COM is Unicode as well.<br><br>But that's just a guess...</div>
<p><a id="417605" href="#417605">#</a> <strong>Michael S. Kaplan</strong> on 15 May 2005 10:31 AM:</p><div style="margin-left: 1em">Hi Dean,<br><br>Ordnarily I would agree, but the one thing that made me wonder would be the scenario of a &quot;native&quot; managed provider -- would it be required to let the database do it? Or would it have the freedom to do it itself, later?<br><br>I do not know enough about the new data provider model's internals....</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/15/417601.html" title="Not all SQL Server collations are created equal">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/13/417167.html" title="What it means to be in the default install">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/14/417384.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>