<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/10/416181.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Zipping up Unicode file names</title></head><body>
<h1>Zipping up Unicode file names</h1>
<p><em>by Michael S. Kaplan, published on 2005/05/10 20:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/05/10/416181.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Let's&nbsp;create the following filenames:</FONT></P>
<UL>
<LI><FONT size=4><FONT face=Tahoma>αβγδεζηθ.txt</FONT> </FONT>
<LI><FONT size=4><FONT face=Tahoma>АБВГДЕЖЗ.txt</FONT> </FONT>
<LI><FONT size=4><FONT face=Tahoma>אבגדהוזח.txt</FONT> </FONT>
<LI><FONT face=Tahoma size=4>กขฃคฅฆจ.txt</FONT></LI></UL>
<P><FONT face=Tahoma>(they can be empty or have data in them)</FONT></P>
<P><FONT face=Tahoma>And then try to zip them up with your favorite program (I'll use WinZip, you can use anything you like here).</FONT></P>
<P><FONT face=Tahoma>The zip will fail, in the case of WinZip with the following error:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2>---------------------------<BR>WinZip<BR>---------------------------<BR>Error: No files were found for this action that match your criteria - nothing to do. (C:\TEMP\TEMP.zip).<BR>---------------------------<BR>OK&nbsp;&nbsp; Help&nbsp;&nbsp; <BR>---------------------------</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>And then if you choose to look at the error log you will see why you had zero files instead of the four you asked it zip up:</FONT></P><FONT face=Tahoma><FONT size=1>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2>Action: Add (and replace) files Include subfolders: yes Save full path: no<BR>Include system and hidden files: yes<BR>"C:\TEMP\aß?de???.txt" is not a valid file name and was skipped<BR>"C:\TEMP\????????.txt" is not a valid file name and was skipped<BR>"C:\TEMP\????????.txt" is not a valid file name and was skipped<BR>Warning: name not matched: C:\TEMP\????????.txt<BR>"C:\TEMP\aß?de???.txt" is not a valid file name and was skipped<BR>"C:\TEMP\????????.txt" is not a valid file name and was skipped<BR>"C:\TEMP\????????.txt" is not a valid file name and was skipped<BR>Warning: name not matched: C:\TEMP\????????.txt<BR>"C:\TEMP\???????.txt" is not a valid file name and was skipped<BR>Warning: name not matched: C:\TEMP\???????.txt<BR>"C:\TEMP\aß?de???.txt" is not a valid file name and was skipped<BR>Warning: name not matched: C:\TEMP\aß?de???.txt<BR>Error: No files were found for this action that match your criteria - nothing to do. (C:\TEMP\TEMP.zip)</FONT></P></BLOCKQUOTE>
<P></FONT><FONT size=3>Your mileage may vary if your default system code page supports one of these filenames, and those question marks with best fit mappings for the Greek names will probably give the clues as to what is going on here.</FONT></P>
<P>The ZIP format is fine with Unicode data in filenames, but is not so fine with the filenames themselves being off of the default system code page.</P>
<P>Curses, foiled again!</P>
<P>Now one could work around this by using the short file names, but this would have a negative impact on being able to use them in the ZIP file:</P>
<UL>
<LI><FONT size=4><FONT face=Tahoma>αβγδεζηθ.txt --&gt; 3864~1.TXT</FONT> </FONT>
<LI><FONT size=4><FONT face=Tahoma>АБВГДЕЖЗ.txt --&gt; 833B~1.TXT</FONT> </FONT>
<LI><FONT size=4><FONT face=Tahoma>אבגדהוזח.txt --&gt; A0E9~1.TXT</FONT> </FONT>
<LI><FONT face=Tahoma size=4>กขฃคฅฆจ.txt --&gt; 0344~1.TXT</FONT></LI></UL>
<P>I think we need to have someone look into an extension to the ZIP format....</P>
<P>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post brought to you by</EM> "Ž" <EM>(<A href="http://www.fileformat.info/info/unicode/char/017d/index.htm">U+017d</A>, a.k.a. LATIN CAPITAL LETTER Z WITH CARON)<BR>(which is unfortunately not a zippable file name character on most code pages)</EM></FONT></FONT><FONT face=Tahoma></P></FONT>
<hr/><p><a id="416186" href="#416186">#</a> <strong>Maurits [MSFT]</strong> on 10 May 2005 6:45 PM:</p><div style="margin-left: 1em">Interesting - I've submitted this to WinZip.<br>Another question occurs to me.<br><br>Suppose John zip's up a file containing some eight-bit characters in his code page.<br><br>Then he emails the file to Mischa who has a different code page.<br><br>Mischa extracts the file.<br><br>What does he see?  Are the eight-bit characters in the file name just whatever those eight-bit numbers happen to map to in his code page?<br><br>I wonder if there's any kind of ../.. vulnerability possible here.</div>
<p><a id="416191" href="#416191">#</a> <strong>Michael S. Kaplan</strong> on 10 May 2005 6:55 PM:</p><div style="margin-left: 1em">Yes, you are right -- the cross-codepage issues are kind of scary here -- since you could have files that you would be unable to open on some platforms? Yikes!<br><br>I don't think you will find the other kind of vulnerability here though -- the path separators and related characters are pretty firmly embedded in the ASCII range....</div>
<p><a id="416194" href="#416194">#</a> <strong>Maurits [MSFT]</strong> on 10 May 2005 6:59 PM:</p><div style="margin-left: 1em">../.. is something to watch out for if Unicode filenames are allowed, though.  It's easy to imagine a malicious zip file containing a &quot;filename&quot; of &quot;../../../../../../boot.ini&quot; - where the .'s or &quot;/&quot;'s are obfuscated with overlong Unicode escapes.</div>
<p><a id="416197" href="#416197">#</a> <strong>Dean Harding</strong> on 10 May 2005 7:06 PM:</p><div style="margin-left: 1em">Plus, if you used the short filenames, you'd not be able to expand them back to their originals after unzipping them, making it kind of useless anyway (it'd be better to manually rename to something in English I reckon).<br><br>Perhaps an extension to WinZip (or whatever) could be to encode the Unicode characters using utf-7 or maybe even using the same scheme as IDNs  or something?  That way, you'd still be able to unzip with another program, just not with the friendly filenames.</div>
<p><a id="416198" href="#416198">#</a> <strong>Michael S. Kaplan</strong> on 10 May 2005 7:07 PM:</p><div style="margin-left: 1em">Hmmmm.... I am not sure if that would even work. Plus, there are no escapes that are legal here anyway? It currently fails any attempt to use the characters, and all of the cases I know of with relative paths start with the highest path, don't they?</div>
<p><a id="416199" href="#416199">#</a> <strong>Michael S. Kaplan</strong> on 10 May 2005 7:10 PM:</p><div style="margin-left: 1em">Previous comment was to Maurits, not Dean. :-)<br><br>Dean, UTF-7 might actually do the trick here....</div>
<p><a id="416235" href="#416235">#</a> <strong>MGrier</strong> on 10 May 2005 9:04 PM:</p><div style="margin-left: 1em">We noticed this problem when doing the packaging and deployment support for VS6.<br><br>The net result is that this is why _A_UTF8 was added to the fci/fdi headers for CABs; we just utf8 encoded the filenames in the CAB as it was already 8-bit clean.  (I claim that the cab code owner added it at my request but maybe someone else beat me to the request...)<br><br>For ZIPs we had a similar issue but I believe that ZIPs for JARs were already specified as being either 7-bit clean or UTF-8 encoded already.  I think we forced a fix in the Java Package Manager to deal with UTF-8 encoded class names but these still tended to have problems on Win9x since the underlying registry APIs couldn't deal with characters in key or value names not representable in the system's CP_ACP.</div>
<p><a id="416241" href="#416241">#</a> <strong>Michael S. Kaplan</strong> on 10 May 2005 9:24 PM:</p><div style="margin-left: 1em">Yep, thats the problem -- now the next step is to solve it for everyone. :-)</div>
<p><a id="416337" href="#416337">#</a> <strong>pb</strong> on 11 May 2005 2:15 AM:</p><div style="margin-left: 1em">Actually NTFS-conformance problems are very common with Win32 software. Many do not understand that NTFS is Unicode (and then I haven't mentioned ADS).<br><br>The scariest part is that most file managers also have complete ignorance of Unicode. This can be funny when you have an English locale and you try to copy a file with e.g. cyrillic or just East-European characters in its name.<br><br>Another typical area of problems is with email clients.</div>
<p><a id="416388" href="#416388">#</a> <strong>Alexey Chernjayeff</strong> on 11 May 2005 6:49 AM:</p><div style="margin-left: 1em">I tried to compress these files with RAR and 7-Zip (<a rel="nofollow" target="_new" href="http://www.rarsoft.com/">http://www.rarsoft.com/</a> <a rel="nofollow" target="_new" href="http://www.7-zip.org/">http://www.7-zip.org/</a>)...<br>They work well, all files in both archives are extractable as original names. So it seems to be only zip format problem.</div>
<p><a id="416413" href="#416413">#</a> <strong>Michael S. Kaplan</strong> on 11 May 2005 8:19 AM:</p><div style="margin-left: 1em">Alexey, that is great news! None of those formats are in the default install of winzip, but I believe they can be plugged in if you have them. Thanks for posting this.</div>
<p><a id="416477" href="#416477">#</a> <strong>Maurits [MSFT]</strong> on 11 May 2005 11:05 AM:</p><div style="margin-left: 1em">There is unfortunately some ambiguity within Zip files as to the character set that the filename is stored in. Whenever a file can be stored in the OEM character set (which is the character set originally used by MS-DOS), WinZip does so for compatibility with other Zip utilities. In this case, it marks the Zip file as made by MS-DOS, since the original Zip utilities were DOS utilities that used the OEM character set for filenames.<br><br>One thing to note is that on NT-based systems such as Windows NT, Windows 2000, and Windows XP, file and folder names are stored as Unicode (a multi-byte character set that includes characters from various ANSI and OEM code pages).  Such files and folders can only be processed by Unicode-aware applications.  WinZip is not a Unicode-aware application at this time.  For this reason, WinZip can only display and process characters that exist in your current codepage. If your current code page is English 1252, for example, you will not be able to see or process files that have Chinese characters.  On the other hand, if your current code page is set to Traditional Chinese - 950, you should see and be able to process files with Chinese characters but you may not be able to see or process files and folders whose names contain Greek characters.<br><br>We are looking into how to handle this better in a future version of WinZip.<br><br>Please let me know if you have any further questions.<br><br>    --Chuck Campbell, WinZip Technical Support</div>
<p><a id="416554" href="#416554">#</a> <strong>Bob Burger</strong> on 11 May 2005 2:26 PM:</p><div style="margin-left: 1em">It works just fine in Mac OS X.  The Mac uses UTF-8, which would be the ideal choice for encoding filenames in the existing zip format.<br><br>When I brought the zip file onto my Windows box, WinZip thought αβγδεζηθ.txt was &#206;&#177;&#206;&#178;&#206;&#179;&#206;&#180;&#206;&#181;&#206;&#182;&#206;&#183;&#206;&#184;.txt.  You can see the UTF-8 encoding in there, mapped to 1252.<br><br>Too bad Windows doesn't have a UTF-8 API.  It already has a UTF-16 API.  I wish I could use the ANSI APIs but tell the system to use UTF-8 as my current encoding scheme.</div>
<p><a id="416566" href="#416566">#</a> <strong>Maurits [MSFT]</strong> on 11 May 2005 2:49 PM:</p><div style="margin-left: 1em">The Unicode exploit I was thinking of is if the &quot;../&quot; check is only placed against the raw string, and not the normalized form.<br><br>For example if the string is stored in UTF-8, a [c0][af] byte sequence will not trigger the path validator.  On the other hand it may very well be normalized during the extraction routine - boom, a vulnerability.<br><br>Such vulnerabilities are not new to the Zip world - see <a rel="nofollow" target="_new" href="http://secunia.com/advisories/8781">http://secunia.com/advisories/8781</a> for an example of path interpretation vulnerabilities (though admittedly this one is not Unicode-related.)</div>
<p><a id="416601" href="#416601">#</a> <strong>Mihai</strong> on 11 May 2005 3:52 PM:</p><div style="margin-left: 1em">The ZIP file format specs are here:<br><a rel="nofollow" target="_new" href="http://www.pkware.com/company/standards/appnote/">http://www.pkware.com/company/standards/appnote/</a><br>A quote:<br>&quot;The current Header ID mappings defined by PKWARE are:<br>...<br>0x0008        Reserved for future Unicode file name data (PFS)&quot;<br><br>So, it seems something is there already. But someone should bite the bullet and use it. Probably the backward-compatibility is a problem, but sooner or later someone should do it :-)</div>
<p><a id="416710" href="#416710">#</a> <strong>Dean Harding</strong> on 11 May 2005 9:48 PM:</p><div style="margin-left: 1em">The latest version of WinZip has a new compression algorithm that is not compatible with older version or with other ZIP-compatible products.  When you select it, it just says &quot;files compressed with this scheme will not be able to be opened in older version of WinZip or other products&quot;.  So there's no reason why they couldn't do the same with Unicode file names.<br><br>Ah well, no point bitching about here, I guess :)</div>
<p><a id="416715" href="#416715">#</a> <strong>Michael S. Kaplan</strong> on 11 May 2005 10:31 PM:</p><div style="margin-left: 1em">If I combine the info from Chuck Campbell obtained by Maurits, the info on the ZIP file format provided by Mihai, the info on the way backcompat has been treated in the past by WinZip, and the info from Alexey on other compression formats that support the names now, there are clearly all of pieces in place to make this feature work in a future version of WinZip (if they choose to do it!).</div>
<p><a id="416945" href="#416945">#</a> <strong>Serge Wautier</strong> on 12 May 2005 2:48 PM:</p><div style="margin-left: 1em">Of course WinZip et al can zip your Unicode data. But MichKa discovered that the name of zipped files cannot be Unicode !</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/04 <a href="http://archives.miloush.net/michkap/archive/2012/01/04/10252916.html">If someone blathers on about how Windows supports Unicode, you can suggest they just ZIP it, if you like!</a></p><p>2008/05/13 <a href="http://archives.miloush.net/michkap/archive/2008/05/13/8498184.html">WinZip, the [long awaited] Unicode edition!!!</a></p><p>2006/12/07 <a href="http://archives.miloush.net/michkap/archive/2006/12/07/1232365.html">Zipping up Unicode file PATHs</a></p><p>2006/04/22 <a href="http://archives.miloush.net/michkap/archive/2006/04/22/581356.html">Unicode? Zip don't need no stinking Unicode!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/05/10/416187.html" title="A better question -- what is the performance, Everett vs. Whidbey?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/05/10/416129.html" title="More on &#39;repetoire fences&#39;">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-05-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/05/10/416181.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>