<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/06/24/432121.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>LCMapString's *other* job</title></head><body>
<h1>LCMapString's *other* job</h1>
<p><em>by Michael S. Kaplan, published on 2005/06/24 02:41 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/06/24/432121.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>To me, the NLS API function <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp"><STRONG>LCMapString</STRONG></A> has a full-time job, one that is crucial to the fundamental fabric of Windows -- sort key generation. I know it is crucial because if I accidentally mess up the tables then there are components that are unable to even let Windows finish booting up due to fear of corruption of information!</FONT></P>
<P><FONT face=Tahoma>Clearly the order is important, and the ability to create indexes that use this order is therefore equally important. It is no accident that the name of this blog is <a href="http://blogs.msdn.com/michkap"><STRONG>Sorting It All Out</STRONG></A>, you know. Keeping it all in some order so that no matter how complex it is, you can eventually work your way through it is (to me) a hideously important operation that is crucial to all of our work. And not just our international work -- if we mess up the simple ABCs then how can we ever hope to handle really complex operations?</FONT></P>
<P><FONT face=Tahoma>However, just as an artist often has to wait tables or bag groceries in order to pay her rent, <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A> has been forced to take on some side work. :-)</FONT></P>
<P><EM><FONT face=Tahoma size=2>(Now I know that is a completely revisionist way of looking at things and I know its not really how things are. But it's a more convenient way of looking at things for me, so like the Bohr model for the atom I am going to let the "not entirely accurate" model stand, since it a useful way of looking at things!)</FONT></EM></P>
<P><FONT face=Tahoma>Anyway, I thought I'd take a look at some of the other work this conversion function does....</FONT></P>
<P><FONT face=Tahoma>I hint at uses of&nbsp;a few of these conversions in my post <a href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html">A few of the gotchas of CompareString</A>&nbsp;but now I am going to try to lay it all out, once and for all.</FONT></P>
<P><FONT face=Tahoma>As a side note, Julie Bennett once told me that she thought this function was kind of a hack, not because it wasn't useful but because it did too much, all in one place. It really wanted to be separate functions. Which is I guess a hazard of taking on too many part time job -- no one knows what your actual occupation is!</FONT></P>
<P><FONT face=Tahoma>Here are the additional flags and what they do:</FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_BYTEREV</STRONG> -- a very useful little conversion, whether used by itself or with any of the other results -- it will reverse the bytes in each word of a string. As the Platform SDk topic indicates, dor example, if you pass in 0x3450 0x4822 the result is 0x5034 0x2248. The conversion is the equivalent of <FONT face="Courier New" size=2><STRONG>lpDestStr[ich] = MAKEWORD( HIBYTE(lpSrcStr[ich], LOBYTE(lpSrcStr[ich]) )</STRONG></FONT> across the whole string. Good honest side work for our girl!</FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_FULLWIDTH</STRONG> -- Converts each character to a full width one every time it encounters a half width one (all other characters pass through unchanged). Thus <STRONG>ﾎ</STRONG> (U+ff8e a.k.a. HALFWIDTH KATAKANA LETTER HO) becomes <STRONG>ホ</STRONG> (U+30db a.k.a. KATAKANA LETTER HO). In the legacy Japanese code page, full width characters took up twice as much space (the half width characters were in the 'high ansi' range of the code page,&nbsp;greater than&nbsp;0x7f but less than 0xff, where the full width ones were double-byte characters). As a convention the full width ones are twice as wide -- the same width as the ideographs --&nbsp;and according to some people are considered to be less aesthetically pleasing. In Unicode obviously both sets take up two bytes, but the typographic tradition continues to this day, and therefore this is no longer really just a 'legacy code page' issue -- it is a real typographic difference.</FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_HALFWIDTH</STRONG> -- Converts each character to a half width one every time it encounters a full width one (all other characters pass through unchanged). Thus&nbsp;<STRONG>ワ</STRONG> (U+30ef a.k.a. KATAKANA LETTER WA) becomes <STRONG>ﾜ</STRONG> (U+ff9c a.k.a. HALFWIDTH KATAKANA LETTER WA). See the previous LCMAP_FULLWIDTH text for more information on the difference between them.</FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_HIRAGANA</STRONG> -- Converts each&nbsp;Katakana character to the equivalent Hiragana one&nbsp; (all other characters pass through unchanged). Thus <STRONG>ヅ</STRONG> (U+30c5 a.k.a. KATAKANA LETTER DU) becomes&nbsp;<STRONG>づ</STRONG> (U+3065 a.k.a. HIRAGANA LETTER DU). The more literal meaning of Hiragana is "smooth kana." The differences between Hiragana and Katakana are a bit beyond the scope of this blog post, but there is a fascinating <A href="http://en.wikipedia.org/wiki/Hiragana">Wikipedia article</A> on it that covers the topic, and includes the poem <I><A title=Iroha href="http://en.wikipedia.org/wiki/Iroha">Iroha</A>-uta</I> ("Song of colours"). This poem comes from the 10th century, and in a very cool way uses every hiragana once (and proves to me that Hiragana is more lyrically suited than English with its 'the quick brown fox jumpes over the lazy dog' nonsense!):</P>
<BLOCKQUOTE dir=ltr>
<P>
<TABLE cellSpacing=0 cellPadding=0>

<TR>
<TD>いろはにほへと&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
<TD>Iro ha nihohe to &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD>
<TD>Even if colours have sweet perfume&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TD></TR>
<TR>
<TD>ちにぬるを</TD>
<TD>chirinuru wo</TD>
<TD>eventually they fade away</TD></TR>
<TR>
<TD>わかよたれそ</TD>
<TD>wakayo tare so</TD>
<TD>What in this world</TD></TR>
<TR>
<TD>つねならむ</TD>
<TD>tsune naramu</TD>
<TD>is eternal&nbsp;?</TD></TR>
<TR>
<TD>うゐのおくやま</TD>
<TD>uwi no okuyama</TD>
<TD>The deep montains of vanity</TD></TR>
<TR>
<TD>けふこえて</TD>
<TD>kefu koete</TD>
<TD>I cross them today</TD></TR>
<TR>
<TD>あさきゆめみし</TD>
<TD>asaki yume mishi</TD>
<TD>renouncing the superficial dreeams</TD></TR>
<TR>
<TD>ゑひもせすね</TD>
<TD>wehi mo sesu ne</TD>
<TD>not giving in to their madness any more</TD></TR></TABLE></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma><STRONG>LCMAP_KATAKANA</STRONG> -- Converts each&nbsp;Hiragana character to the equivalent Katakana one&nbsp; (all other characters pass through unchanged). Thus <STRONG>ま</STRONG> (U+307e&nbsp;a.k.a. HIRAGANA LETTER MA) becomes <STRONG>マ</STRONG> (U+30de a.k.a. KATAKANA LETTER MA). The more literal meaning of Katakana is "partial kana." Again, the differences between Hiragana and Katakana are a bit beyond the scope of this blog post, but there is a fascinating <A href="http://en.wikipedia.org/wiki/Katakana">Wikipedia article</A> on this script too that covers the topic. The article does mention one important difference in usage between the two scripts:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2>Katakana spelling differs slightly from hiragana. While hiragana spells long vowels with the addition of a second vowel kana, katakana uses a <B>vowel extender mark</B>. This mark is a short line following the direction of the text (horizontal in horizontal text, vertical in columns).</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Neither the Hiragana nor the Katakana conversions in Windows extend to cover this particular convention, though it is fascinating to contemplate doing so some day, in some kind of extension to the "linguistic casing" notion I'll talk about in a bit. Interesting feature idea, if it truly is the convention. :-)</FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_UPPERCASE</STRONG> -- Maps lowercase characters to uppercase characters passing through other characters unchanged. Thus <STRONG>ç</STRONG> (U+00e7, a.k.a. LATIN SMALL LETTER C WITH CEDILLA) becomes <STRONG>Ç</STRONG> (U+00c7 a.k.a. LATIN CAPITAL LETTER C WITH CEDILLA).&nbsp;Can be modifed with the <STRONG>LCMAP_LINGUISTIC_CASING</STRONG> flag which enables a whole bunch of new scenarios, discussed when I asked (then answered) the question <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279942.html">What does "linguistic casing" mean</A>&nbsp;and plays a fundamental role in the life of all but the "C" locale CRT casing operations and functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charupper.asp">CharUpper</A>, such that although technically <a href="http://archives.miloush.net/michkap/archive/2005/06/22/431394.html">I do not own</A> those <EM>functions</EM>, I basically <EM>own</EM> those functions (isn't emphasis a wonderful thing? &lt;grin&gt;). . Note that none of these wrappers uses the LCMAP_LINGUISTIC_CASING flag, which means that unless they are calling LCMapStringA there is absolutely no effect whatsoever based on the locale, and all claims to the contrary in both PSDK and CRT documentation are in the long, slow process of being fixed. The last word that I have to say about uppercasing is <a href="http://archives.miloush.net/michkap/archive/2004/12/02/273619.html">Georgian</A>.</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma><STRONG>LCMAP_LOWERCASE -- </STRONG>Maps uppercase characters to lowercase characters passing through other characters unchanged. Thus <STRONG>Ħ</STRONG> (U+0126, a.k.a. LATIN CAPITAL LETTER H WITH STROKE) becomes <STRONG>ħ</STRONG> (U+0127, a.k.a. LATIN SMALL LETTER H WITH STROKE).&nbsp;Can be modifed with the LCMAP_LINGUISTIC_CASING flag which enables a whole bunch of new scenarios, discussed when I asked (then answered) the question <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279942.html">What does "linguistic casing" mean</A>&nbsp;and plays a fundamental role in the life of all of the "C" locale CRT casing operations and functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charlower.asp">CharLower</A>, such that although technically <a href="http://archives.miloush.net/michkap/archive/2005/06/22/431394.html">I do not own</A> those <EM>functions</EM>, I basically <EM>own</EM> those functions (isn't emphasis a wonderful thing? &lt;grin&gt;). Note that none of these wrappers uses the LCMAP_LINGUISTIC_CASING flag, which means that unless they are calling LCMapStringA there is absolutely no effect whatsoever based on the locale, and all claims to the contrary in both PSDK and CRT documentation are in the long, slow process of being fixed. The last word I have to say about lowercasing is <a href="http://archives.miloush.net/michkap/archive/2005/05/26/421987.html">Sigma</A>.</FONT></P>
<P><STRONG>LCMAP_SIMPLIFIED_CHINESE</STRONG> -- Maps traditional Chinese characters to simplified Chinese, passing through other characters unchanged. Thus <STRONG>樂</STRONG>&nbsp;(U+6a02) becomes <STRONG>乐</STRONG> (U+4e50). The dictionary used for this mapping is small (only 2,620 ideographs) and has not been updated since the feature was added in NT 4.0 (it was originally added at the request of people in Office, who actually ended up going with their own more sophisticaated dictionary solution in Word that does a better job with the sometimes complicated mapping. Now although casing, width, and Kana mappings can all be done in place, this is not allowed for traditional-&gt;simplified Chinese mappings, even though the same restrictions (always the same lnegth, etc.) apply here -- <EM><FONT color=#ff0000>if any NLS testers who are reading this want to put in a bug, I'll see what I can do about fixing that!</FONT></EM></FONT></P>
<P><FONT face=Tahoma><STRONG>LCMAP_TRADITIONAL_CHINESE</STRONG> -- Maps simplified Chinese characters to traditional Chinese, passing through other characters unchanged. Thus <STRONG>儈</STRONG> (U+5108) becomes <STRONG>侩</STRONG> (U+4fa9). The dictionary used for this mapping is even smaller (only 2,191 ideographs) since there are many times that several traditional Chinese ideographs will map to one simplified ideograph (thus these two flags are not 100% reversible versions of each other). The table has not been updated since the LCMAP_SIMPLIFIED_CHINESE one was. Same problems with in-place update apply here -- <EM><FONT color=#ff0000>if any NLS testers who are reading this want to put in a bug, I'll resolve it as a duplicate of the other bug I was suggesting, above!</FONT></EM></FONT></P>
<P><FONT face=Tahoma>Ok, that is probably enough for today. Tip your server (she may have subroutines to support). Enjoy the veal!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT color=#ff0000><FONT face=Tahoma>This post brought you by "<FONT size=5>ﾎホワﾜヅづまマçÇĦħ乐樂儈侩</FONT>" <FONT size=2>(<A href="http://www.fileformat.info/info/unicode/char/ff8e/index.htm">U+ff8e</A> <A href="http://www.fileformat.info/info/unicode/char/30db/index.htm">U+30db</A> <A href="http://www.fileformat.info/info/unicode/char/30ef/index.htm">U+30ef</A> <A href="http://www.fileformat.info/info/unicode/char/30c5/index.htm">U+30c5</A> <A href="http://www.fileformat.info/info/unicode/char/3065/index.htm">U+3065</A> <A href="http://www.fileformat.info/info/unicode/char/307e/index.htm">U+307e</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/30de/index.htm">U+30de</A> <A href="http://www.fileformat.info/info/unicode/char/00e7/index.htm">U+00e7</A> <A href="http://www.fileformat.info/info/unicode/char/00c7/index.htm">U+00c7</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0126/index.htm">U+0126</A> <A href="http://www.fileformat.info/info/unicode/char/0127/index.htm">U+0127</A> <A href="http://www.fileformat.info/info/unicode/char/4e50/index.htm">U+4e50</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/6a02/index.htm">U+6a02</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/4fa9/index.htm">U+4fa9</A> <A href="http://www.fileformat.info/info/unicode/char/5108/index.htm">U+5108</A> a.k.a. HALFWIDTH KATAKANA LETTER HO, KATAKANA LETTER HO,&nbsp;KATAKANA LETTER WA, HALFWIDTH KATAKANA LETTER WA, KATAKANA LETTER DU, HIRAGANA LETTER DU, HIRAGANA LETTER MA, KATAKANA LETTER MA, LATIN SMALL LETTER C WITH CEDILLA, LATIN CAPITAL LETTER C WITH CEDILLA, LATIN CAPITAL LETTER H WITH STROKE, LATIN SMALL LETTER H WITH STROKE, HAPPY, HAPPY, BROKER, BROKER)<BR></FONT><FONT size=1>(A group of characters that were happy to be asked to help showcase the technology behind LCMapString!)</FONT></FONT></FONT></P>
<hr/><p><a id="432268" href="#432268">#</a> <strong>Duncan</strong> on 24 Jun 2005 10:28 AM:</p><div style="margin-left: 1em">On top of 乐 and 樂, which are the two Chinese ways （simplified and traditional) to write the character that means 'happiness', the Japanese way is:　楽.<br><br>乐　樂　楽</div>
<p><a id="432283" href="#432283">#</a> <strong>Michael S. Kaplan</strong> on 24 Jun 2005 11:27 AM:</p><div style="margin-left: 1em">There are often multiple ways to do it, even when you asre just moving in the circle of Chinese....</div>
<p><a id="432544" href="#432544">#</a> <strong>Atsushi Enomoto</strong> on 25 Jun 2005 12:35 AM:</p><div style="margin-left: 1em">It's so cosmetic but the last &quot;ne&quot; is extraneous in Iroha Uta (ne is already on the fourth line ;-). I fixed referenced wikipedia article.<br><br>As for Simplified/Traditional Chinese and Japanese, I think some of Parenthesized CJK ideographs (U+3220 - U+3243) and Circled ones (U+3280-U+32B0) are sorted incorrectly. For example, U+32A2 is sorted next to U+5BEB (traditional Chinese) instead of corresponding U+5199 (Japanese).</div>
<p><a id="432569" href="#432569">#</a> <strong>Michael S. Kaplan</strong> on 25 Jun 2005 3:37 AM:</p><div style="margin-left: 1em">Sorted incorrectly in what locale? :-)</div>
<p><a id="432618" href="#432618">#</a> <strong>Atsushi Enomoto</strong> on 25 Jun 2005 10:59 AM:</p><div style="margin-left: 1em">Oops, I'm sorry. Apparently I needed more explaination.<br><br>What I had in mind is InvariantCulture.<br><br>In InvariantCulture U+32A2 has &quot;ac 46 01 01 01 01&quot; as its sortkey value, which is next to U+5BEB (&quot;ac 45 01 01 01 01 00&quot;). But U+32A2 is actually NFKD compatible with U+5199. For most of Circled CJK ideographs, each of them have such a sortkey that is next to its equivalent CJK character. But some characters (like U+32A2) are mapped incorrectly in that sense.<br><br>The same discussion applies to ja(-JP) too. I know (I should mention) CJK sort order depends the cultures (namely zh-CHS, zh-CHT, ko and possibly more). Though in ja-JP CJK sortkey values are shifted (from AC 45 ... to 8E 64 ...), this discussion is still true to them. <br><br>In zh-CHS it is not mapped to be equivalent anymore (and thus it keeps InvariantCulture mapping). I think it makes sense because as long as I have heard Chinese people don't use that mark (actually that is one of the reason I think it is &quot;incorrect&quot; mapping).<br><br>If my argument still makes sense, I can put some other &quot;incorrect&quot; mapping examples (in my speak).</div>
<p><a id="432717" href="#432717">#</a> <strong>Michael S. Kaplan</strong> on 25 Jun 2005 10:15 PM:</p><div style="margin-left: 1em">Actually, we are not a 100% normalization shop in our collation (a fact about which I have posted before). ZBut even if we were, we would only deal with NFC and NFD -- NFKC and NFKD are both destructive operations in that they remove distinctions that are often important when they are in data.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/06/25 <a href="http://archives.miloush.net/michkap/archive/2008/06/25/8652525.html">Seeing the tears, my heart went out to her as I asked her "Why the Long S?"</a></p><p>2007/10/22 <a href="http://archives.miloush.net/michkap/archive/2007/10/22/5588441.html">Traditional to Simplified or vice-versa? According to Windows, you're on your own....</a></p><p>2006/10/20 <a href="http://archives.miloush.net/michkap/archive/2006/10/20/847933.html">Complex string mapping</a></p><p>2005/10/20 <a href="http://archives.miloush.net/michkap/archive/2005/10/20/482926.html">Parameter confusion</a></p><p>2005/09/11 <a href="http://archives.miloush.net/michkap/archive/2005/09/11/463672.html">Fonts that are 'fixed-width' even if they do not claim to be</a></p><p>2005/07/24 <a href="http://archives.miloush.net/michkap/archive/2005/07/24/442720.html">When other teams lock down your implementation....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/06/24/432492.html" title="Многоликий класс CultureInfo — .NET-приложения станут дружелюбнее к пользователю">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/06/24/432114.html" title="Seeing red. But in a good way....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-06-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/06/24/432121.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>