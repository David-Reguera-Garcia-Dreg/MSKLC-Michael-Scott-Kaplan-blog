<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/06/15/429279.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Once more into the palindrome</title></head><body>
<h1>Once more into the palindrome</h1>
<p><em>by Michael S. Kaplan, published on 2005/06/15 05:21 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/06/15/429279.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Back in April, in a series of posts, I talked about many&nbsp;cool features in Whidbey, from comparison (been there all along) to text elements (been there all along, better in Whidbey) to normalization (new in Whidbey), all in the context of one of the most important features that any computer program can possibly support -- palindrome detection:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Tahoma><a href="http://archives.miloush.net/michkap/archive/2005/04/28/413019.html">Looking for that internationally savvy palindrome checker....</A></FONT><FONT face=Tahoma><BR><a href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">Where did the new StringInfo stuff come from?</A></FONT><FONT face=Tahoma><BR><a href="http://archives.miloush.net/michkap/archive/2005/04/30/413676.html">Normalization vs. .NET text elements</A></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>It was all very cool stuff, and a lot of fun to do. </FONT></P>
<P><FONT face=Tahoma>And then I blew it. </FONT></P>
<P><FONT face=Tahoma>In that last post, I said:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>Now, </EM></FONT><A href="http://www.geocities.com/mvaneerde/"><FONT size=2><EM>Maurits</EM></FONT></A><FONT size=2><EM>&nbsp;went on in his </EM></FONT><A href="http://channel9.msdn.com/ShowPost.aspx?PostID=63297"><FONT size=2><EM>Channel 9 posting</EM></FONT></A><FONT size=2><EM>&nbsp;to discuss sort elements, or cases when two or more characters are to be given a single sort weight (kind of the opposite of an expansion like these ligatures). However, in my opinion these are not really suitable for a palindrome detection algorithm, as I don't think they are usually treated as letters except in the case where they are also treated as unique text elements (the case covered by the StringInfo code).</EM></FONT></P>
<P><FONT size=2><EM>Any native speakers of languages with such constructs as the Spanish <STRONG>ch</STRONG> and the Hungarian <STRONG>dzs</STRONG> who think they should or should not be treated as a unit in trying to detect palindomosity should feel free to leave a comment to that effect. Also, if any of my collagues in the GIFT group agree or disagree&nbsp;here (<STRONG><FONT color=#ff0000>and they are reading this!</FONT></STRONG>) they are invited to do the same (or stop me in the hall and accost me with this information!). </EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Well, the good news is that no one accosted me. </FONT></P>
<P><FONT face=Tahoma>The bad news is that some people posted that I was wrong, and colleagues informed me that I was wrong. Those 'sort elements' (for lack of a better term) would be taken as a unit, just as the text elements are.</FONT></P>
<P><FONT face=Tahoma>Damn.&nbsp;I hate being wrong.</FONT></P>
<P><FONT face=Tahoma>Especially when I pointed out that there was no good way pick up these 'sort element' compressions, where two or more UTF-16 code points are given the weight of a single element. We have the data, sure. But we do not currently excpose it in a convenient way to answer this particular question.</FONT></P>
<P><FONT face=Tahoma>And to top it all off, <a href="http://archives.miloush.net/michkap/archive/2005/03/16/396704.html">there is no good way to reverse a sort key</A>, though the sort key obviously contains the information about when these compressions (known in the <A href="http://www.unicode.org/reports/tr10/">Unicode Collation Algorithm</A> as 'contractions').</FONT></P>
<P><FONT face=Tahoma>I stewed on this for a bit today, after finally deciding to tackle this post. There had to be some way short of a new Win32 or .NET function to make this work.</FONT></P>
<P><FONT face=Tahoma>So I closed my eyes and told myself to pretend I was interviewing for a job at Microsoft. :-)</FONT></P>
<P><FONT face=Tahoma>Then something suddenly occurred to me!</FONT></P>
<P><FONT face=Tahoma>We do not care about reversing or undoing&nbsp;the sort key; we only care about comparing the pieces of each sort key! And we can do that, we have the bytes, so why not just compare them?</FONT></P>
<P><FONT face=Tahoma>Let's take a hideously contrived string to test for palindromodity: <STRONG>abddzsCÅbÅCdzsdzsba</STRONG></FONT></P>
<P><FONT face=Tahoma>The code points are:</FONT></P>
<P><FONT face=Tahoma size=2><A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">0061</A> <A href="http://www.fileformat.info/info/unicode/char/0062/index.htm">0062</A> <A href="http://www.fileformat.info/info/unicode/char/0064/index.htm">0064</A> <A href="http://www.fileformat.info/info/unicode/char/0064/index.htm">0064</A> <A href="http://www.fileformat.info/info/unicode/char/007a/index.htm">007a</A> <A href="http://www.fileformat.info/info/unicode/char/0073/index.htm">0073</A> <A href="http://www.fileformat.info/info/unicode/char/0043/index.htm">0043</A> <A href="http://www.fileformat.info/info/unicode/char/00c5/index.htm"><STRONG>00c5</STRONG></A><STRONG> </STRONG><A href="http://www.fileformat.info/info/unicode/char/0062/index.htm">0062</A> <A href="http://www.fileformat.info/info/unicode/char/0041/index.htm"><STRONG>0041</STRONG></A><STRONG> </STRONG><A href="http://www.fileformat.info/info/unicode/char/030a/index.htm"><STRONG>030a</STRONG></A><STRONG> </STRONG><A href="http://www.fileformat.info/info/unicode/char/0043/index.htm">0043</A> <A href="http://www.fileformat.info/info/unicode/char/0064/index.htm">0064</A> <A href="http://www.fileformat.info/info/unicode/char/007a/index.htm">007a</A> <A href="http://www.fileformat.info/info/unicode/char/0073/index.htm">0073</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0064/index.htm">0064</A> <A href="http://www.fileformat.info/info/unicode/char/007a/index.htm">007a</A> <A href="http://www.fileformat.info/info/unicode/char/0073/index.htm">0073</A>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0062/index.htm">0062</A> <A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">0061</A></FONT></P>
<P><FONT face=Tahoma>Note especially the Hungarian dzs double compression ('ddzs' == 'dzsdzs') and the A Ring in both precomposed and composite forms (code points marked in bold).</FONT></P>
<P><FONT face=Tahoma>We grab the sort key:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2><STRONG>string st = "abddzsCÅbÅCdzsdzsba";<BR>CompareInfo ci = CompareInfo.GetCompareInfo("hu-HU");<BR>byte[] rgbyt = ci.GetSortKey(stIn, CompareOptions.None).KeyData</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>and then take a look at what those bytes look like:</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=1><STRONG>0e 02 0e 09 0e 1e 0e 1e 0e 0a 0e 02 0e 09 0e 02 0e 0a 0e 1e 0e 1e 0e 09 0e 02 01&nbsp;02 02 02 02 02 1a 02 1a 01&nbsp;02 02 02 02 12 12 02 12 12 01&nbsp;01 00</STRONG></FONT></P></BLOCKQUOTE>
<P dir=ltr><FONT face=Tahoma>Let's split&nbsp;it into&nbsp;the various&nbsp;pieces:&nbsp;</FONT></P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2><STRONG>UW: 0e 02 0e 09 0e 1e 0e 1e 0e 0a 0e 02 0e 09 0e 02 0e 0a 0e 1e 0e 1e 0e 09 0e 02 01 <BR>DW: 02 02 02 02 02 1a 02 1a 01 <BR>CW: 02 02 02 02 12 12 02 12 12 01 <BR>SW: 01 00</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Now the rules are very simple for the detection:</FONT></P>
<OL>
<LI><FONT face=Tahoma>Strip out the 00 and 01 byte values, those are just sentinels;</FONT></LI>
<LI><FONT face=Tahoma>The UW values will always be two bytes per sort element, and will always therefore be an even number;</FONT></LI>
<LI><FONT face=Tahoma>The DW/CW/SW weights can be prefixed by 02 byte values. You can ignore them, and assume that identical weights exist in suffix form if the weight ends early (02 is the minimal weight and is just used to pad the piece of the sort key when are looking further into the string).</FONT></LI></OL>
<P><FONT face=Tahoma>So, looking at our sort key:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2><STRONG>UW: 0e 02 <FONT color=#800080>0e 09</FONT> <FONT color=#ff1493>0e 1e</FONT> <FONT color=#7fffd4>0e 1e</FONT> <FONT color=#ffa500>0e 0a</FONT> <FONT color=#a52a2a>0e 02</FONT> <FONT color=#ff0000>0e 09</FONT> <FONT color=#a52a2a>0e 02</FONT> <FONT color=#ffa500>0e 0a</FONT> <FONT color=#7fffd4>0e 1e</FONT> <FONT color=#ff1493>0e 1e</FONT> <FONT color=#800080>0e 09</FONT> 0e 02 <BR>DW: 02 02 02 02 02 <FONT color=#000080>1a</FONT> 02 <FONT color=#000080>1a</FONT> <FONT color=#d3d3d3>02 02 02 02 02</FONT><BR>CW: 02 02 02 02 <FONT color=#800080>12</FONT> <FONT color=#9acd32>12</FONT> 02 <FONT color=#9acd32>12</FONT> <FONT color=#800080>12</FONT> <FONT color=#d3d3d3>02 02 02 02</FONT><BR>SW: </STRONG></FONT></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>Yes folks, we have a palindrome! And the method to do so is using code that has been around since NT 3.1.</FONT></P>
<P><FONT face=Tahoma>Now if you really want to, you can normalize the string to take care of some of the issues brought up in the earlier posts.</FONT></P>
<P><FONT face=Tahoma>The code to sort through the byte array and verify the results is left as an exercise for the reader. If someone had figured this out in an interview, they would have impressed the hell out of me; I am temporarily way too impressed with myself for thinking of it.... :-)</FONT></P>
<P><FONT face=Tahoma>I will do some more "sort key cracking" another day, if there is interest. I have only ever known on one team inside or outside of Microsoft that has ever had a scenario that required cracking sort keys, but perhaps I have just not talked to everyone yet. I have run across many people who have found it to be an interesting area, even if they could not find an immediate use for the knowledge.</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "﴿"<EM> (<A href="http://www.fileformat.info/info/unicode/char/fd3f/index.htm">U+fd3f</A>, a.k.a. ORNATE RIGHT PARENTHESIS)</EM></FONT></FONT></P>
<hr/><p><a id="429337" href="#429337">#</a> <strong>Atsushi Enomoto</strong> on 15 Jun 2005 9:01 AM:</p><div style="margin-left: 1em">Hello. I doubt that 00 and 01 byte values are always just sentinels and UW are always two values. For example SortKey data for &quot;U+1113&quot; is 58 F7 FF 07 FF 00 FF 00 01 01 01 01 00 (a TextElementEnumerator created from &quot;U+1113&quot; returns just one string that contains single U+1113).</div>
<p><a id="429360" href="#429360">#</a> <strong>Michael S. Kaplan</strong> on 15 Jun 2005 10:09 AM:</p><div style="margin-left: 1em">&quot;Hello. I doubt that 00 and 01 byte values are always just sentinels&quot;<br><br>They are. I know -- In the table that contains the weights, 2 is the smallest weight value ever given -- 1 must be reserved for the sentinels.<br><br>&quot;and UW are always two values.&quot;<br><br>It is -- there are times that many characters mean one UW and many times that one character means many UW values. But the number of weights there will always be even and they always are two bytes each....<br><br>&quot;For example SortKey data for &quot;U+1113&quot; is 58 F7 FF 07 FF 00 FF 00 01 01 01 01 00 (a TextElementEnumerator created from 'U+1113' returns just one string that contains single U+1113).&quot;<br><br>Yes -- and Jamo are often getting more than one UW -- part of the state table logic for support of Old Hangul.<br><br>I did forget that the algorithm for the Old Hangul will occasionally insert single 0 bytes in there. But it will never insert a 1. It does not look like it is possible with valid Hangul syllables, only with incomplete Jamo sequences that do not make up a valid syllable....<br><br>This technically ought to be considered a bug anyway (some implementations assume the byte array is NULL terminated since it is doc-ed as such. I think I will consider this a bug and investigate it as such, in any case.<br><br>Another bug found through blogging? :-)</div>
<p><a id="429471" href="#429471">#</a> <strong>serras</strong> on 15 Jun 2005 2:55 PM:</p><div style="margin-left: 1em">Just as a comment: since a few years ago, ch is no longer treated as a special letter (that followed c), but as C+H. The same goes to ll: it used to go after the l, now it is treated as L+L in dictionaries.<br>This tradicional sort has completely been replace, at least in Spain. However, I think in other places where Spanish is spoken (Latin America) it already is used.<br>But RAE (Royal Spanish Academy: the institution that speaks about our language) in conjuntion with the other Spanish Languages Acdemies in the world (there's even one in USA), are changung it.</div>
<p><a id="429494" href="#429494">#</a> <strong>Michael S. Kaplan</strong> on 15 Jun 2005 3:45 PM:</p><div style="margin-left: 1em">Hi serras --<br><br>Except if you choose the Traditional Spanish sort (the modern Spanish one works as you say it does; the traditional one works the old way).<br><br>:-)</div>
<p><a id="429509" href="#429509">#</a> <strong>Ruben</strong> on 15 Jun 2005 4:58 PM:</p><div style="margin-left: 1em">Unsurprisingly, the Dutch word &quot;kijk&quot; (look) is not seen as a palindrome. But that's probably because the ij is neither a text element, nor does it have any special sorting rules. <br><br>Having said that, word games always treat the ij as a single letter. For example, a cross word puzzle will insist that ijsvrij consists of 5 letters (or boxes). I'm pretty sure that also happens with palindromes (kijk, pijp, sijs, neppijpen, nijlkoortsmeetsysteemstrooklijn). Okay, so I looked some up.<br><br>Note however, that in your demo app, substituting ij (U+0069 U006a) with ĳ (U+0133) does seem to make it work, even with split ligatures set. Weird. But then again, there's no way to access that digraph/ligature from a keyboard, so nobody uses it anyway.</div>
<p><a id="429551" href="#429551">#</a> <strong>Maurits [MSFT]</strong> on 15 Jun 2005 6:43 PM:</p><div style="margin-left: 1em">I believe that the letter &quot;y&quot; historically arises as a ligature for ij:<br><br>ij<br>&#255;<br>y<br><br>See <a rel="nofollow" target="_new" href="http://en.wikipedia.org/wiki/IJ_(letter)">http://en.wikipedia.org/wiki/IJ_%28letter%29</a> for more... for example, though dictionaries treat ij as two letters, encyclopediae and phone books treat it as one sort element</div>
<p><a id="429558" href="#429558">#</a> <strong>Maurits [MSFT]</strong> on 15 Jun 2005 6:46 PM:</p><div style="margin-left: 1em">In Afrikaans kijk is spelled &quot;kyk&quot; (rhymes with &quot;lake&quot;)</div>
<p><a id="429570" href="#429570">#</a> <strong>Maurits [MSFT]</strong> on 15 Jun 2005 7:09 PM:</p><div style="margin-left: 1em">I'd have to guess that Windows doesn't consider the ĳ character (U+0133) to be a ligature of i and j... could this be considered a bug?  Or is ĳ (U+0133) a letter in its own right, distinct from a ligature of i and j?</div>
<p><a id="429584" href="#429584">#</a> <strong>Michael S. Kaplan</strong> on 15 Jun 2005 7:48 PM:</p><div style="margin-left: 1em">U+0133 has a compatibility decomposition to U+0069 U+006a, so the code I put in the third post should actually split it up okay. The Windows table is not as up to date (see <a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/01/31/363701.html">http://blogs.msdn.com/michkap/archive/2005/01/31/363701.aspx</a> for more info on *that* issue; it is one that will be addressed in Longhorn, fwiw).</div>
<p><a id="429640" href="#429640">#</a> <strong>Michael S. Kaplan</strong> on 15 Jun 2005 10:53 PM:</p><div style="margin-left: 1em">Hey Maurits --<br><br>&quot;for example, though dictionaries treat ij as two letters, encyclopediae and phone books treat it as one sort element&quot;<br><br>Interesting. AFAIK we have never gotten a request for a Dutch (Phonebook) sort or anything like that. I am sure we would have no problems with it; we do it now for German (Germany), after all....</div>
<p><a id="430297" href="#430297">#</a> <strong>Maurits [MSFT]</strong> on 17 Jun 2005 4:41 PM:</p><div style="margin-left: 1em">This quote is tantalizing:<br>&quot;... Several other letters of the Cyrillic alphabet were originally ligatures but are now considered to be single letters.&quot;<br><br>(The Cyrillic alphabet derives from the Greek alphabet)<br><br><a rel="nofollow" target="_new" href="http://en.wikipedia.org/wiki/Ligature_(typography)#Ligatures_in_other_alphabets">http://en.wikipedia.org/wiki/Ligature_%28typography%29#Ligatures_in_other_alphabets</a><br><br>I wonder if any letter combinations in present-day English are destined to become single letters?  The popularity of digital data over handwritten data might make that impossible in this day and age.</div>
<p><a id="430317" href="#430317">#</a> <strong>Ruben</strong> on 17 Jun 2005 5:37 PM:</p><div style="margin-left: 1em">Well, I guess it's the 'right' thing for the program to not magically recognize i+j as a single unit. How would it know that Dutch words like bijectie and bijouterie&#235;n don't contain a ij? This is demonstrated by their hyphenation points: bi-jec-tie and bi-jou-te-rie-en (note the drop of the diaeresis, or trema in Dutch, when hyphenating). <br><br>These exceptions are extremely rare though, and without exception loan words, so by making these exceptions the rule is probably still not really 'right' for native speakers (or typists).<br><br>Which shows that even sticking to European languages, means you'll meet many weird linguistic spelling rules that matter to natives, but baffle outsiders.</div>
<p><a id="430359" href="#430359">#</a> <strong>Michael S. Kaplan</strong> on 17 Jun 2005 8:47 PM:</p><div style="margin-left: 1em">Hi Ruben --<br><br>Ah, that is not an intractable problem, but luckily one not needed by this program since it is not a palindrome. :-)<br><br>Seriously though, such cases can only happen via dictionaries either with the one case or the other, depending on the frequency and the scenario....</div>
<p><a id="430360" href="#430360">#</a> <strong>Michael S. Kaplan</strong> on 17 Jun 2005 8:49 PM:</p><div style="margin-left: 1em">Maurits, anything is possible -- especially when you consider that fonts would be able to create the ligature as needed, even if they stay encoded as separate characters....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/09/07 <a href="http://archives.miloush.net/michkap/archive/2010/09/07/10058112.html">Refusing to ignore some particular character's width isn't [always] an act of discrimination…</a></p><p>2008/01/13 <a href="http://archives.miloush.net/michkap/archive/2008/01/13/7090976.html">On reversing the irreversible (the introduction)</a></p><p>2007/09/10 <a href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html">A&P of Sort Keys, part 0 (aka The empty string sorts the same in every language)</a></p><p>2006/03/30 <a href="http://archives.miloush.net/michkap/archive/2006/03/30/564598.html">If at first you don't succeed, there's probably still a bug</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/06/16/429667.html" title="What it means to be case insensitive">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/06/14/428797.html" title="Every character has a story #11: U+???? (The Invisible Letter)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-06-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/06/15/429279.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>