<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/15/503493.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The bug you wish you'd caught?</title></head><body>
<h1>The bug you wish you'd caught?</h1>
<p><em>by Michael S. Kaplan, published on 2005/12/15 05:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/12/15/503493.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Back in September I talked about the article Cathy and I had written entitled <a href="http://archives.miloush.net/michkap/archive/2005/09/13/464733.html">Extend Your Code's Global Reach With New Features In The .NET Framework 2.0</A>.</FONT></P>
<P><FONT face=Tahoma>One of the many new globalization features in the .NET Framework that it talked about was "Windows only" cultures.</FONT></P>
<P><FONT face=Tahoma>From the article:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT face="Times New Roman" size=2>The .NET Framework was released at an interesting point in the history of Windows: after Windows XP was released, but before Windows Server™ 2003. As a result, the list of cultures available in the .NET Framework matched the locales included in Windows XP (and provided a superset of the locales included in previous versions of Windows). Developers didn't have to consider the consequences of new locales on Windows. There would be no issue with how these new Windows locales would interact with a version of the .NET Framework that tries to, for example, base its culture settings on the choices available in the operating system. The .NET Framework has always maintained its own data so that it could return the same results on all possible platforms, and until Windows XP SP2, this had never caused any difficulties.</FONT></EM></P>
<P><EM><FONT face="Times New Roman" size=2>The globalization development team had to address this problem, however, after Windows XP SP2 shipped with 25 new locales. For a listing of the new locales for SP2 only, see <U>New Locale and Language Features in Windows XP</U>. Imagine our surprise when one of our testers discovered that you could not even start a managed application when installing an early build of SP2 and using one of those new locales as the default user locale! This was clearly an issue we needed to address immediately in earlier versions of the .NET Framework, and fix more fully in the .NET Framework 2.0.</FONT></EM></P>
<P><EM><FONT face="Times New Roman" size=2>Future Windows service packs may include additional locales. Windows Vista™ (formerly codenamed "Longhorn") is expected to ship with additional locales above and beyond what have been supported to date; so that presents a very possible situation where an installed version of Windows could include locales that are not recognized cultures in the .NET Framework. Therefore, it's imperative that the .NET Framework gracefully handle Windows locales in a managed environment. </FONT></EM><A class=clsFigs href="mk:@MSITStore:C:\Documents%20and%20Settings\michkap\Desktop\docs\MSDNMag0510.chm::/msdnmag/issues/05/10/Globalization/default.htm#fig3"><EM><FONT face="Times New Roman" size=2>Figure 3</FONT></EM></A><EM><FONT face="Times New Roman" size=2> shows Francois Liger's Culture Explorer (available for download from </FONT></EM><A href="http://www.gotdotnet.com/" target=_blank><EM><FONT face="Times New Roman" size=2>www.gotdotnet.com</FONT></EM></A><EM><FONT face="Times New Roman" size=2>), which illustrates how the .NET Framework 2.0 picks up the new locales in Windows Vista through the Windows-only cultures.</FONT></EM></P>
<P><EM><FONT face="Times New Roman" size=2>The .NET Framework can now handle previously unidentified Windows locales by using the Win32® API to synthesize a CultureInfo object any time a locale supported in Windows has no corresponding culture in the .NET Framework. These cultures can be created either by name or by LCID, just like any other culture. The following code illustrates how to create a culture by name (new cultures on Windows XP SP2 include mt-MT, bs-BA-Latn, smn-FI, smj-NO, smj-SE, sms-FI, sma-NO, sma-SE, quz-BO, quz-EC, quz-PE, ml-IN, bn-IN, cy-GB, and more): </FONT></EM></P>
<P><FONT face="Courier New" size=2><STRONG>' Visual Basic <BR>For Each ci As CultureInfo In CultureInfo.GetCultures( _<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureTypes.WindowsOnlyCultures)<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.Name)<BR>Next</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>// C#<BR>foreach(CultureInfo culture in CultureInfo.GetCultures(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureTypes.WindowsOnlyCultures))<BR>{<BR>&nbsp;&nbsp;&nbsp; Console.WriteLine(ci.Name);<BR>}</STRONG></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>This is obviously a break from the typical practice in the .NET Framework of giving the same results independent of the platform. However, given the choice between failing completely and succeeding when there is a way to retrieve the data, the option of handling Windows-only cultures successfully provides a better solution for developers who expect some type of culture data returned by the .NET Framework for these Windows-only locales.</EM></FONT></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>Now although the principle behind these cultures is easy to state, the actual work to support them was quite extensive.</FONT></P>
<P><FONT face=Tahoma>For example -- you know that <a href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html">FindNLSString function</A> that I am always talking about? One of the big reasons for its inclusion was better support for the .NET <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclasstopic.asp">CompareInfo&nbsp;class</A> and its <A title=IsPrefix href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassisprefixtopic.asp" target=_blank>IsPrefix</A>, <A title=IsSuffix href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassissuffixtopic.asp" target=_blank>IsSuffix</A>, <A title=IndexOf href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassindexoftopic.asp" target=_blank>IndexOf</A>, and <A title=LastIndexOf href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclasslastindexoftopic.asp" target=_blank>LastIndexOf</A> methods in Windows only cultures!</FONT></P>
<P><FONT face=Tahoma>Now we get to that bug I was talking about....</FONT></P>
<P><FONT face=Tahoma>The <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassindexoftopic.asp">CompareInfo.IndexOf method</A> (and the more commonly called <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemstringclassindexoftopic.asp">String.IndexOf</A> method that calls it) has several overloads, many of which take a startIndex parameter. Unfortunately, <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassindexoftopic.asp">CompareInfo.IndexOf</A>&nbsp;is not adding that value to the result when the underlying call to <a href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html">FindNLSString</A>&nbsp;succeeds. For example, if a call is done on Windows Vista with the new Occitan (France) locale that helps to support the Occitan (France) Windows only culture:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>int idx = CompareInfo.GetCompareInfo("oc-FR").IndexOf("ABCDEFGHIJ", "J", 5)</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>will return 4 rather than 9, since the startIndex of 5 is not being taken into account after the FindNLSString call returns 4.</FONT></P>
<P><FONT face=Tahoma>Of course the bug will be fixed, and for now it is mentioned here in this blog and maybe it will end up in an MSKB article, too.</FONT></P>
<P><FONT face=Tahoma>Perhaps it could even be considered a useful object lesson in the hazards of writing code that cannot be fully tested when the code is being integrated (.NET 2.0&nbsp;of course had a very different ship cycle from Vista -- the original code could not even be tested until long after it was written!).</FONT></P>
<P><FONT face=Tahoma>But it is still one of those kinds of bugs you wish you'd found. Or to be more accurate, that <STRONG>I</STRONG> wish <STRONG>I'd</STRONG> found.</FONT></P>
<P><FONT face=Tahoma>One thing for sure, it definitely makes you more careful the next time!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT color=#ff1493><FONT face=Tahoma><EM>This post brought to you by</EM> "<FONT size=6>ử</FONT>" (<A href="http://www.fileformat.info/info/unicode/char/1eed">U+1eed</A>, a.k.a. LATIN SMALL LETTER U WITH HORN AND HOOK ABOVE)</FONT></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/12/15/504092.html" title="Handling [Unicode] input in the console">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/12/14/503918.html" title="My first Channel 9 appearance!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/15/503493.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>