<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/12/502463.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Ready... set... Reboot Redux</title></head><body>
<h1>Ready... set... Reboot Redux</h1>
<p><em>by Michael S. Kaplan, published on 2005/12/12 05:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/12/12/502463.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>It was way back in February of 2005 in the <STRONG><a href="http://archives.miloush.net/michkap/archive/2005/02/18/376225.html">Ready... set... Reboot!</A></STRONG> post that I first started talking about the issues surrounding rebooting the OS upon a change of the default system locale.</FONT></P>
<P><FONT face=Tahoma>After Rob Mensching's <a href="http://blogs.msdn.com/robmen/archive/2005/12/10/502351.aspx">In Defense of Windows Vista's Restart Manager</A> this last weekend, I thought it might make sense to talk about it a bit more.</FONT></P>
<P><FONT face=Tahoma>Rob's post (and the Restart Manager) center on the replacament of in-use executable files and the resumption of whatever processes those executable files were doing.</FONT></P>
<P><FONT face=Tahoma>Now certainly that is something that could affect NLS functionality in hot fixes or in service packs -- for our code in kernel32.dll or our *.nls data files, if any are updated.</FONT></P>
<P><FONT face=Tahoma>But the reboots that happen for the default system locale happen for basically two reasons:</FONT></P>
<OL>
<LI><FONT face=Tahoma>To&nbsp;facillitate the update to the CP_ACP and CP_OEMCP values for all non-Unicode conversions, operations, and applications on the machine.</FONT> 
<LI><FONT face=Tahoma>To allow the GDI font linking cache to be updated based on the rules of the chosen language</FONT></LI></OL>
<P><FONT face=Tahoma>In the case of #1, it does affect in-use, memory mapped data files, and shared memory (in Vista this is shared memory across the whole machine; in prior versions it was shared only across WindowStations).</FONT></P>
<P><FONT face=Tahoma>For #2 on the other hand, this is a WindowStation-specific cache that is built upon the creation of a WindowStation (this is why people found that if you changed the default system locale but did not reboot that new Terminal Services&nbsp; sessions (which run in new WindowStations) would pick up some of the updated font linking characteristics.</FONT></P>
<P><FONT face=Tahoma>Now the GDI font cache (where font linking happens, not font fallback, as I described <a href="http://archives.miloush.net/michkap/archive/2005/10/01/476022.html">here</A>), is not completely in a consistent state in this situation of no change in code page but rebuild of the font cache, due to the fact that the console (.FON)&nbsp;fonts are code page based, and therefore kind of depend on the code page&nbsp;update to completely do the font cache update. But if we limit the conversation to the truetype font cache stuff (which is all the good Unicode applications have to worry about), then the font linking will be updated properly (for the most part) even in this non-rebooting case.</FONT></P>
<P><FONT face=Tahoma>There are some additional wrinkles, however.</FONT></P>
<P><FONT face=Tahoma>Now take the post I did about <a href="http://archives.miloush.net/michkap/archive/2005/02/26/380867.html"><STRONG>East Asian Font Names....</STRONG></A>&nbsp;for example. I talked about the work that was done in Windows 2000 to support loading the different names of fonts -- something that is especially important for the East Asian font names like <STRONG>GulimChe</STRONG> versus <FONT face="Times New Roman"><STRONG>굴림체</STRONG></FONT>.</FONT></P>
<P><FONT face=Tahoma>However, the font cache has to deal with more than just the font name -- it must also deal with aditional words like the word "Bold" in the <STRONG>Tahoma Bold</STRONG> font -- which will show up as <STRONG>Tahoma Gras</STRONG> on a machine with a French default system locale. And apparently that support was not done as fully (probably due to not being backed up by the font name resource holding the localized name?).</FONT></P>
<P><FONT face=Tahoma>It turns out that there are many situations that require not just one reboot but TWO reboots in order to completely give the expected results for such cases, due to the complex in way in which the font cache is built up (and even how GDI decides if or when it needs to build up that cache).</FONT></P>
<P><FONT face=Tahoma>Hard to have&nbsp;a goal of eliminating a reboot if you have to worry about needing two reboots, isn't it? :-)</FONT></P>
<P><FONT face=Tahoma>If there was ever a good reason to change the font weight rather than using the font name to pick up the bold/italic/bold-italic variant of the font, then this is it! You may not have heard it here first, but it is very good advice either way.</FONT></P>
<P><FONT face=Tahoma>Somehow, I am doubting that the Windows Vista Restart Manager is going to untangle all of these issues, since there is likely a whole bunch of code that needs to be updated in GDI before the Restart Manager could hope to help out here.</FONT></P>
<P><FONT face=Tahoma>In Rob's post, jws commented about the <a href="http://blogs.msdn.com/robmen/archive/2005/12/10/502351.aspx#502459">continuum of inconvenience</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT size=2>Let's not talk about 'reboots' as such. Whenever possible we should not interrupt the user. There is a continuum of inconvenience that goes- <BR><BR>1. no visable effect <BR>2. close and re-open application <BR>3. log off/log on <BR>4. shutdown/restart</FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>I guess to that we have to add <STRONG>5. shutdown/restart twice</STRONG> to the list, huh? :-(</FONT></P>
<P><FONT face=Tahoma>And that is not even talking about all of the interesting issues with the code pages that I will blog about another day....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by </EM>"<FONT size=6>㊩</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/32a9">U+32a9</A>, a.k.a. CIRCLED IDEOGRAPH MEDICINE)</EM></FONT></P>
<hr/><p><a id="502674" href="#502674">#</a> <strong>Gabe</strong> on 12 Dec 2005 5:52 AM:</p><div style="margin-left: 1em">Kinda makes you wonder why there isn't just some &quot;Update GDI Font cache&quot; operation, huh? It seems a bit ridiculous to have to reboot the whole machine just to be able to update some font information.</div>
<p><a id="502700" href="#502700">#</a> <strong>Michael S. Kaplan</strong> on 12 Dec 2005 8:42 AM:</p><div style="margin-left: 1em">Hey Gabe --<br><br>It is hard to do it inplace since the cache would almost certainly be in use. Though perhaps the way has been shown that it could move to a &quot;level 3&quot; inconvenience if we can figure out the rest of the issues....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/26 <a href="http://archives.miloush.net/michkap/archive/2012/01/26/10260726.html">If font linking doesn't fit the text to a T (or ț!), a Romanian letter may be right but not quite look it</a></p><p>2010/03/30 <a href="http://archives.miloush.net/michkap/archive/2010/03/30/9987288.html">A modest proposal</a></p><p>2008/10/28 <a href="http://archives.miloush.net/michkap/archive/2008/10/28/9020410.html">Ready... set... Reboot Redux, part Deux!</a></p><p>2006/09/19 <a href="http://archives.miloush.net/michkap/archive/2006/09/19/761547.html">Ready... set... Don't Reboot!</a></p><p>2006/03/14 <a href="http://archives.miloush.net/michkap/archive/2006/03/14/551068.html">GDI Font Linking in GDI+</a></p><p>2006/02/13 <a href="http://archives.miloush.net/michkap/archive/2006/02/13/530814.html">Getting all of the localized names of a font</a></p><p>2006/01/22 <a href="http://archives.miloush.net/michkap/archive/2006/01/22/515864.html">Questions about font linking, etc.</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/12/12/502513.html" title="It does not look like Vietnamese to me">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/12/11/502455.html" title="Why does the percent stuff have so many restrictions?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12-12">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/12/502463.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>