<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/19/505309.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Customizing shaping behvior in Uniscribe</title></head><body>
<h1>Customizing shaping behvior in Uniscribe</h1>
<p><em>by Michael S. Kaplan, published on 2005/12/19 05:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/12/19/505309.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>The Uniscribe API set is very powerful, much more powerful than most people need in terms of all the things you can possibly do.</FONT></P>
<P><FONT face=Tahoma>To give an example, the other day James Brown asked the following in the microsoft.public.win32.programmer.internationla newsgroup:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT size=2>Hi,</FONT></EM></P>
<P><EM><FONT size=2>I have the following two Arabic Unicode characters in my "paragraph":<BR><BR>U+0647<BR>U+064a</FONT></EM></P>
<P><EM><FONT size=2>Drawn together as one "run" with the Uniscribe API (i.e ScriptShape/ScriptTextOut etc) they appear fine (i.e. the same that Notepad/Wordpad shows them)</FONT></EM></P>
<P><EM><FONT size=2>However I wish to draw the first character in a different colour to the second. I am building my own "style run" list and merging this with the output from ScriptItemize to create two runs which I then pass to ScriptShape/Place/TextOut.</FONT></EM></P>
<P><EM><FONT size=2>However the two characters are drawn "separately" and don't join together cursively like when they are drawn as "one". I know this must be possible because notepad/wordpad has no problems drawing "joined together" characters side-by-side in different colours....so how to I convince Uniscribe that my two "split runs" really used to be a single run, and to generate the glyphs as if they were still joined together??</FONT></EM></P>
<P><EM><FONT size=2>James </FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>A very good question. Now of course by default ه (U+0647, a.k.a. ARABIC LETTER HEH) and ي (U+064a, a.k.a ARABIC LETTER YEH) would combine and look like the following (YMMV depending on the browser you use):</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma size=6>هي</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>But if you try to display the two parts with two different colors than they&nbsp;may or may&nbsp;not shape the same way:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma size=6><FONT color=#ff0000>ه</FONT><FONT color=#008000>ي</FONT></FONT></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>(note that in IE they seem to shape exactly the same way as I see them in Notepad and many other places. Perhaps James is using different fonts or different product versions?</FONT></P>
<P><FONT face=Tahoma>Let's take another string, like the word Arabic translated into Arabic and give it a try:</FONT></P>
<P><FONT face=Tahoma size=6>العربية&nbsp;&nbsp;&nbsp; --&gt;&nbsp;&nbsp;&nbsp; </FONT><FONT face=Tahoma size=6><FONT color=#ffa500>ا</FONT><FONT color=#ff1493>ل</FONT><FONT color=#800080>ع</FONT><FONT color=#0000ff>ر</FONT><FONT color=#800080>ب</FONT><FONT color=#008000>ي</FONT><FONT color=#a52a2a>ة</FONT></FONT></P>
<P><FONT face=Tahoma>Hmmm.... that works too. I wonder what the HTML looks like? Hmmm:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>&lt;P&gt;&lt;FONT color=#ffa500&gt;ا&lt;/FONT&gt;&lt;FONT color=#ff1493&gt;ل&lt;/FONT&gt;&lt;FONT color=#800080&gt;ع&lt;/FONT&gt;&lt;FONT color=#0000ff&gt;ر&lt;/FONT&gt;&lt;FONT color=#800080&gt;ب&lt;/FONT&gt;&lt;FONT color=#008000&gt;ي&lt;/FONT&gt;&lt;FONT color=#a52a2a&gt;ة&lt;/FONT&gt;&lt;/p&gt;</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Ok, it looks like in a lot of these cases Uniscribe is smart enough to shape independent on those various differences. Makes me wonder what changing the font name would do:</FONT></P>
<P><FONT face=Tahoma><FONT size=6><FONT color=#ffa500>ا</FONT><FONT face="Times New Roman" color=#ff1493>ل</FONT><FONT color=#800080>ع</FONT><FONT face="Times New Roman" color=#0000ff>ر</FONT><FONT color=#800080>ب</FONT><FONT face="Times New Roman" color=#008000>ي</FONT><FONT color=#a52a2a>ة</FONT></FONT></FONT></P>
<P><FONT face=Tahoma>Ok, that breaks things down in IE. I <STRONG>knew</STRONG> I could break the string if I kept trying!&nbsp;Now here is the HTML:</FONT></P>
<P><FONT face=Tahoma>&lt;P&gt;&lt;FONT color=#ffa500&gt;ا&lt;/FONT&gt;&lt;FONT face="Times New Roman" color=#ff1493&gt;ل&lt;/FONT&gt;&lt;FONT color=#800080&gt;ع&lt;/FONT&gt;&lt;FONT face="Times New Roman" color=#0000ff&gt;ر&lt;/FONT&gt;&lt;FONT color=#800080&gt;ب&lt;/FONT&gt;&lt;FONT face="Times New Roman" color=#008000&gt;ي&lt;/FONT&gt;&lt;FONT color=#a52a2a&gt;ة&lt;/FONT&gt;&lt;/P&gt;</FONT></P>
<P><FONT face=Tahoma>But on their own, both fonts can shape with no problems:</FONT></P>
<P><FONT face=Tahoma><FONT size=6><FONT color=#ffa500>ا</FONT><FONT color=#ff1493>ل</FONT><FONT color=#800080>ع</FONT><FONT color=#0000ff>ر</FONT><FONT color=#800080>ب</FONT><FONT color=#008000>ي</FONT><FONT color=#a52a2a>ة&nbsp;&nbsp; <FONT color=#000000>--&gt;</FONT>&nbsp;&nbsp; <FONT face="Times New Roman"><FONT color=#ffa500>ا</FONT><FONT color=#ff1493>ل</FONT><FONT color=#800080>ع</FONT><FONT color=#0000ff>ر</FONT><FONT color=#800080>ب</FONT><FONT color=#008000>ي</FONT><FONT color=#a52a2a>ة</FONT></FONT></FONT></FONT></FONT></P>
<P><FONT face=Tahoma>Now it was a mere 15 minutes later that James posted as possible answer for the problem he was seeing:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>ok I have discovered the fLinkAfter and fLinkBefore members of the SCRIPT_ANALYSIS structure. By modifying these two members to create a "link" between the two runs I can achieve the result that I believe is correct.</P>
<P>So my question is, is this the correct method? Whenever I split a SCRIPT_ITEM in half (due to colour/style attribute merging), can I simply modify the fLinkAfter/fLinkBefore to "rejoin" the two halves the split SCRIPT_ITEM, and safely do this for all scripts I might<BR>encounter??</P>
<P>thanks,<BR>James</P></BLOCKQUOTE>
<P><FONT face=Tahoma>Indeed, looking at these two members of the <A href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_8hgy.asp">SCRIPT_ANALYSIS</A> structure:</FONT></P>
<UL>
<LI><FONT face=Tahoma><EM><STRONG>fLinkBefore</STRONG> - If set, the shaping engine will shape the first character of this item as if it were joining with a previous character. Set by ScriptItemize, it may be overridden before calling ScriptShape. </EM></FONT>
<LI><FONT face=Tahoma><EM><STRONG>fLinkAfter </STRONG>- If set, the shaping engine will shape the last character of this item as if it were joining with a subsequent character. Set by ScriptItemize, it may be overridden before calling ScriptShape.&nbsp; </EM></FONT></LI></UL>
<P><FONT face=Tahoma>they do indeed look like the documented and supported way to make this work when it is not working by default. Now it is not completely clear if it will work every time; in fact I am sure there are some style changes that will either break the shaping behavior no matter how the flags are set or the characters will not completely line up (size changes might cause the latter kind of problem).</FONT></P>
<P><FONT face=Tahoma>These particular settings are not available in GDI+ or in the <A href="http://msdn2.microsoft.com/en-us/library/system.windows.forms.textrenderer.aspx">TextRenderer class</A> (the Uniscribe wrapper in .NET 2.0 I have discussed <a href="http://archives.miloush.net/michkap/archive/2005/06/27/432986.html">previously</A>); for&nbsp;the time being&nbsp;this kind of capability is&nbsp;only in Uniscribe, but it is definitely there when it is possible....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>ي</FONT>"<EM> (<A href="http://www.fileformat.info/info/unicode/char/064a">U+064a</A>, a.k.a ARABIC LETTER YEH)</EM></FONT></FONT></P>
<hr/><p><a id="505393" href="#505393">#</a> <strong>Surge</strong> on 19 Dec 2005 5:33 AM:</p><div style="margin-left: 1em">the coloured characters don't join in firefox 1.5 :)</div>
<p><a id="505401" href="#505401">#</a> <strong>Michael S. Kaplan</strong> on 19 Dec 2005 6:02 AM:</p><div style="margin-left: 1em">Somehow you knew it would end up that way. :-(</div>
<p><a id="505419" href="#505419">#</a> <strong>Michael S. Kaplan</strong> on 19 Dec 2005 7:37 AM:</p><div style="margin-left: 1em">Everything looks as I described on IE6 on XP SP2 and on IE7 on a Vista build from late last week.<br><br>I don't think there is any doubt that the IE behavior is better here (and technically it is making better use of the standard since bidi rendering is supposed to be independent of color-type changes, and not affected negatively by such things!)....</div>
<p><a id="505478" href="#505478">#</a> <strong>silverpie</strong> on 19 Dec 2005 10:51 AM:</p><div style="margin-left: 1em">In theory, adding ZWJ on each side of the color change should also force the characters to link.</div>
<p><a id="505526" href="#505526">#</a> <strong>Mihai</strong> on 19 Dec 2005 12:47 PM:</p><div style="margin-left: 1em">Although it might be easy to blame Firefox on this one, I would not.<br><br>This feels a bit like those &quot;more powerful than most people need&quot;, so why should it document it properly.<br>See also &quot;The lack of Uniscribe samples&quot; (<a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/12/06/500485.html">http://blogs.msdn.com/michkap/archive/2005/12/06/500485.aspx</a>)<br><br>The &quot;Supporting Multilanguage Text Layout and Complex Scripts with Windows 2000&quot; sample has the same problem as Firefox.<br><br>I did not check the code in &quot;I18N with VB&quot;, but I really think we need some decent samples+documents on how to use Uniscribe.<br>It looks that people need a bit more than what is available.<br></div>
<p><a id="505535" href="#505535">#</a> <strong>Maurits</strong> on 19 Dec 2005 1:01 PM:</p><div style="margin-left: 1em">I suppose this is where seperation of content and style breaks down...<br><br>Suppose instead of &lt;font&gt; tags they were &lt;span&gt; tags:<br><br>&lt;span class=&quot;first&quot;&gt;ل&lt;/span&gt;&lt;span class=&quot;second&quot;&gt;ع&lt;/span&gt;<br><br>And let's suppose there was a style sheet:<br>span.first { color: red; }<br>span.second { color: blue; }<br><br>Fine, they should link.<br><br>But what if you changed the style sheet to:<br>span.first { font-size: 14pt; }<br>span.second { font-size: 30pt; }<br><br>That would cause the links to not line up.<br><br>Or what if you did<br><br>span.first { display: none; }<br>span.second { display: block; }<br><br>This would cause the first letter to disappear and the second to have a line break before it...<br><br>In principle the decision to break (or not to break) could be made after the styles have been applied, I suppose.</div>
<p><a id="505537" href="#505537">#</a> <strong>TheMatt</strong> on 19 Dec 2005 1:04 PM:</p><div style="margin-left: 1em">Huh...my Firefox 1.07 on Fedora shows the exact same for both.  I wonder why it isn't joining the letters...</div>
<p><a id="505550" href="#505550">#</a> <strong>Matthew W. Jackson</strong> on 19 Dec 2005 1:45 PM:</p><div style="margin-left: 1em">Firefox for Windows uses Uniscribe, but obviously this is platform-specific code.  I don't know if anybody has written anything similar for Linux yet, but if such a thing exists Firefox is obviously not using it.<br><br>What's really funny is how Firefox on Windows behaves when you highlight one character of the run (it splits into the individual runs, where as Internet Explorer keeps them together).<br><br>I imagine this sort of thing is very difficult to get right, so I'm not completely surprised by the behavior of Firefox.<br><br>I *am* dissapointed that the Uniscribe wrapper in .NET does not provide more options, since I've had nothing but trouble when trying to manually format rich-text in pure managed code, and things still have not improved much in that regard.  Displaying one big string is easy, but anything more than that is a pain.</div>
<p><a id="505638" href="#505638">#</a> <strong>James Brown</strong> on 19 Dec 2005 4:53 PM:</p><div style="margin-left: 1em">Hi Michael,<br>thanks for your efforts on this - its very much appreciated! I'm reposting here what I posted back on usenet as a reply to you:<br><br>The example you give here is exactly the application I had in mind (colourising spans of text). I was a little unclear in my original posting when I said:<br><br>&quot;notepad/wordpad has no problems drawing &quot;joined together&quot; characters side-by-side in different colours.&quot;<br><br>What I meant by this was, when you select one of the characters I mentioned in a regular EDIT/RichEdit control, the characters do not change shape even though the one is being drawn in a different colour to represent<br>the selection. This is the behaviour I am aiming for in my custom editor - I wasn't implying that notepad/ID was doing anything wrong, rather they were doing it right but I couldn't figure out how to emulate their behaviour based on the info in MSDN.<br><br>I have found a solution though:<br><br>The fLinkAfter/fLinkBefore was a red-herring. They are not designed for the purpose I had in mind. Rather, believe they should be used for simulating a &quot;zero-width-joiner&quot; which may not be present in the original text stream. In fact after some experimentation I discovered that using these attributes inappropriately can result in incorrect shaping behaviour. For example, there could be two arabic characters side-by-side which do not normally cursively join, but when split using this method (and the fLinkAfter/Before attributes applied) they do join together, which is of course incorrect. If I could figure out how to put a small HTML sample here I would :-)<br><br>Now here is the basic set of steps for drawing a line of text with Uniscribe (no word-wrapping here for simplicity):<br><br>1. ScriptItemize<br>2. Merge with application-defined &quot;style&quot; runs to produce finer-grained items.<br>3. ScriptLayout<br><br>Then for each item/run:<br><br>4. ScriptShape<br>5. ScriptPlace<br>6. ScriptTextOut<br><br>The MSDN documentation is quite unclear about step#2. It implies that you should merge *any* application-styled runs text with the items produced from ScriptItemize. What the docs really mean by &quot;different styles&quot; is in fact<br>different *fonts*. Splitting/merging colour-information (i.e. for the purpose of selection highlighting/syntax colouring) at this stage is *wrong*<br><br>To apply colouring to the text, the individual items should be *further* split *prior* to calling ScriptTextOut. (i.e. at step #6). So there is an extra &quot;merging/styling&quot; step that is required which is not mentioned in the docs.<br><br>At this point we are working at the glyph-level rather than characters. Instead of passing an entire &quot;run&quot; (SCRIPT_ATTRIBUTE + glyph buffer) to ScriptTextOut, this run should be split into the clusters identified in the SCRIPT_VISATTR array - and each *glyph cluster* passed individually to ScriptTextOut. Some optimization could occur here so that glyph clusters could be kept together if they share the same colour.<br><br>I have also noticed some interesting behaviour in the Script_xx APIs using WinDbg:<br><br>Notepad (or rather the EDIT control) uses the &quot;basic&quot; ScriptString API. This API is really neat because it lets you draw a line/paragraph of text with a range of that text optionally &quot;selected&quot; (i.e. drawn in the system highlight colours). ScriptStringOut achieves this *very* strangely. It draws the whole line of text normally (using the regular Script API). It then draws the exact same text a second time, in the same position, over the original text, but this time in a different colour, with a clipping-rectangle applied so that only the &quot;selected&quot; text gets drawn second time around. This allows a very fine-level of selection (it is working at the pixel <br>level), and is the reason that the selection-highlight + caret can move into the middle of grapheme clusters.  Its a real bodge, and is also the reason why the ScriptString API flickers so horribly. (double-buffering using memory-DCs solves this of course).<br><br>Wordpad on the other hand (or the RichEdit it uses) does things differently. It uses the ScriptTextOut API directly along with ScriptItemize etc, and does things as I have just described - applying colour formatting inbetween calling ScriptPlace and ScriptTextOut, by breaking each run of text into the separate glyph-clusters and drawing them manually with multiple calls to ScriptTextOut. I have my Neatpad editor drawing text this way now and it works very well.<br><br>Note that the InternetExplorer control does the same thing. So does VS.NET IDE editor.<br><br>James<br></div>
<p><a id="505661" href="#505661">#</a> <strong>Dean Harding</strong> on 19 Dec 2005 5:37 PM:</p><div style="margin-left: 1em">Firefox doesn't use Uniscribe on Windows (there's a bugzilla bug that's been open since the dawn of time on it: <a rel="nofollow" target="_new" href="https://bugzilla.mozilla.org/show_bug.cgi?id=218887">https://bugzilla.mozilla.org/show_bug.cgi?id=218887</a>)<br><br>You can get a patched version of Firefox which uses Uniscribe, but they say it's not going to be integrated with Mozilla, since the Mozilla people are planning to re-architect the rendering engine to use Cairo. In the meantime, the patched versions are here: <a rel="nofollow" target="_new" href="http://blacksapphire.com/firefox-rtl/">http://blacksapphire.com/firefox-rtl/</a><br><br>I think it's probably better for the mozilla people to use Cairo/Pango anyway (rather than Uniscribe), since that would increase the user-base of people using those libraries which would in turn increase demand for support for other languages from those libraries, which can only be a good thing.  I mean, Uniscribe is great and all, but there's nothing like a little healthy competition, eh? :)</div>
<p><a id="505726" href="#505726">#</a> <strong>Nick Lamb</strong> on 19 Dec 2005 8:23 PM:</p><div style="margin-left: 1em">Right, the Gecko engine (Firefox, Mozilla etc.) currently does a lot of work that it is poorly equipped for, rather than leaving it to the experts who write OS text rendering code. This is an example where that breaks down visibly. Let's hope Dean Harding is right that Cairo integration improves this aspect of Gecko.<br><br>Παν語 (Pango) can get this right, although I couldn't think of any applications I had which would demonstrate this, so I had to spend a few minutes throwing something together and testing it. I used a basic GTK+ label widget, and set the markup inline, then tried some variations on that theme to check that various sensible approaches work. I tested on a rather battered old Fedora Core 4 machine. Neither Pango markup strings nor externally applied markup which change the color of one or more characters affect the shaper. You get a nice smooth Arabic word, in a rainbow of colors in each case.<br><br>[Disclaimer, I cannot actually read Arabic, but it looks right in so far as I'm qualified to judge]<br><br>OpenOffice.org gets this right on FC4 too, I don't know if it uses Pango or whether the support is independent. But I was able to paste today's blog examples into OO.o 2.0 on the same FC4 system and see them rendered as expected rather than as in Mozilla/ Firefox.<br><br>So, James Brown's desired effect is achieved easily in Pango/Linux. I cannot confirm whether this works with Pango on Win32, but it should, especially since Uniscribe can be selected as a backend for Pango/Win32.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/12/19/505576.html" title="It isn&#39;t a FONTSIGNATURE, darn it!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/12/18/505145.html" title="More on the Unicode 5.0 beta">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12-19">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/19/505309.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>