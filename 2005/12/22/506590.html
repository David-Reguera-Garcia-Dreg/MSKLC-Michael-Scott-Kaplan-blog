<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/22/506590.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>We can't win when it comes to those pesky standards, can we?</title></head><body>
<h1>We can't win when it comes to those pesky standards, can we?</h1>
<p><em>by Michael S. Kaplan, published on 2005/12/22 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/12/22/506590.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>The title of this post is a little tongue-in-cheek; I do not actually think of standards as pesky in a generic sense like that. :-)</FONT></P>
<P><FONT face=Tahoma>But the other day, someone inside Microsoft was having trouble with the XmlSerializer class in the .NET Framework. The problem was something like this:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>I’m serializing a string using the XmlSerializer.&nbsp; It’s serializing this input:</EM></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>"Line\r\nBreak\r\n\tTab" </EM></FONT></P></BLOCKQUOTE>
<P><FONT size=2><EM>And deserializing it into this string:</EM></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>"Line\nBreak\n\tTab\n"</EM></FONT></P></BLOCKQUOTE>
<P><FONT size=2><EM>So when I put it back into my Textbox it loses its linebreaks.</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>This behavior is actually by design for the XmlSerializer though -- and based on the standard!</FONT></P>
<P><FONT face=Tahoma>The behavior is defined in the XML Spec, <A href="http://www.w3.org/TR/2000/REC-xml-20001006#sec-line-ends">right here</A>:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>2.11 End-of-Line Handling</EM></FONT></P>
<P><FONT size=2><EM>XML parsed entities are often stored in computer files which, for editing convenience, are organized into lines. These lines are typically separated by some combination of the characters carriage-return (#xD) and line-feed (#xA).</EM></FONT></P>
<P><FONT size=2><EM>To simplify the tasks of applications, the characters passed to an application by the XML processor must be as if the XML processor normalized all line breaks in external parsed entities (including the document entity) on input, before parsing, by translating both the two-character sequence #xD #xA and any #xD that is not followed by #xA to a single #xA character.</EM></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Funny how a standard only annoys&nbsp;us when the one behavior they choose is what we are using. :-)</FONT></P>
<P><FONT face=Tahoma>Luckily very cool&nbsp;MSFTie Elena Kharitidi (who I met years ago when she was working on the Jet team) pointed out how you can make sure that a serialize/deserialize will roundtrip a little better:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><EM><FONT size=2>Normalizing string values is the default XmlSerializer behavior, but you can override it by configuring your XmlWriter before calling XMlSerialier.Serialize() method.</FONT></EM></P>
<P><EM><FONT size=2>You need to use XmlWriter.Create() with XmlWriterSetting.NewLineHandling = NewLineHandling.Entitize.</FONT></EM></P>
<P><EM><FONT size=2>There are other unfortunate side effects of choosing XML as your persistence format: there are ranges of characters (most notably the ones from 0x0 to 0x1F without TAB, CR, LF) that are considered illegal in XML 1.0.&nbsp;&nbsp; The default XmlWriter will write them, but default XmlReader will throw on read.</FONT></EM></P>
<P><EM><FONT size=2>But if you use XmlTextReader, you can workaround this by setting Normalization=false; on the reader.</FONT></EM></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Okay, so there are ways to get the standards conformant behavior, and ways to get the other behavior when you need it. Of course somebody will still be unhappy with the defaults we choose, which is why we can't seem to win these situations! :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>ඇ</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0d87">U+0d87</A>, a.k.a. SINHALA LETTER AEYANNA)</EM></FONT></FONT></P>
<hr/><p><a id="506675" href="#506675">#</a> <strong>Peter Millard</strong> on 22 Dec 2005 5:19 AM:</p><div style="margin-left: 1em">Nice. Had this exact same problem.</div>
<p><a id="506782" href="#506782">#</a> <strong>Maurits [MSFT]</strong> on 22 Dec 2005 12:34 PM:</p><div style="margin-left: 1em">So... why doesn't the textbox respect the \n's as line breaks?</div>
<p><a id="506787" href="#506787">#</a> <strong>Michael S. Kaplan</strong> on 22 Dec 2005 12:40 PM:</p><div style="margin-left: 1em">You know Maurits, that would make a great blog entry!<br><br>Oh wait, it already did! :-)<br><br><a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/05/22/420890.html">http://blogs.msdn.com/michkap/420890.aspx</a></div>
<p><a id="506807" href="#506807">#</a> <strong>Maurits [MSFT]</strong> on 22 Dec 2005 1:17 PM:</p><div style="margin-left: 1em">All right, I read both your blog post and Raymond's blog post.<br><br>Raymond brought up the interesting point that old standards all specified CRLF.<br><br>Both of you brought up the point that &quot;it's always been that way, and it would take a lot of work to change it, and nobody really cares anyway.&quot;<br><br>Well, now there's a new standard that specifies bare LF, and at least two people who care... so why not change the edit control to honor bare LFs as line endings, the way Wordpad does?</div>
<p><a id="506809" href="#506809">#</a> <strong>Gabe</strong> on 22 Dec 2005 1:26 PM:</p><div style="margin-left: 1em">Forget changing the edit control because there would be too many backcompat issues. I don't see why Notepad can't just fix the file between reading it from disk and adding it to the edit control.</div>
<p><a id="506810" href="#506810">#</a> <strong>Michael S. Kaplan</strong> on 22 Dec 2005 1:33 PM:</p><div style="margin-left: 1em">Maurits -- as Gabe points out, the potentional backsompat issues are too great (as was pointed out in a comment to my older post, where someone pointed out a use of the current support).<br><br>Gabe -- even on my wishlist there are higher priority features I would like to be added to Notepad, and they are not even getting to mine. So such a change does not seem very likely to me.... :-(</div>
<p><a id="506834" href="#506834">#</a> <strong>Jerry Pisk</strong> on 22 Dec 2005 2:20 PM:</p><div style="margin-left: 1em">Adding a new style to the edit control, one that enables \n as a line separator, set to 0 by default, would imo be sufficient not to cause any appcompat issues. It will break apps that assume there will not be any new window styles and use the unused bits for their own purpose but those apps do deserve to be broken.</div>
<p><a id="506839" href="#506839">#</a> <strong>Michael S. Kaplan</strong> on 22 Dec 2005 2:30 PM:</p><div style="margin-left: 1em">Hi Jerry,<br><br>The trouble here is that the real CUSTOMER complaint is not about the EDIT control, it is about Notepad (and people could be depending on the current behavior of Notepad!).<br><br>There are other problems here (like the fact that the EDIT control is code that no one wants to touch at this point), but the backcompat problem is significant....</div>
<p><a id="506840" href="#506840">#</a> <strong>Maurits [MSFT]</strong> on 22 Dec 2005 2:33 PM:</p><div style="margin-left: 1em">Alright, the Edit control is frozen.  But that leaves the standards breach as unsolved.  Standards should be helpful...<br><br>I suppose you could add a property to textboxes that would allow them to accept either Windows line-endings or XML-standard line-endings?  Something like<br><br>class TextBox {<br>__ public LineEnders LineEnder = LineEnders.CRLF;<br>}<br><br>enum LineEnders {<br>__ CRLF, /* show bare CR or bare LF as null glyphs */<br>__ LF, /* show CR as null glyph */<br>__ CR, /* show LF as null glyph */<br>__ CRLF_or_CR, /* show bare LF as null glyph */<br>__ CRLF_or_LF, /* show bare CR as null glyph */<br>__ CR_or_LF, /* CRLF is TWO line breaks */<br>__ CRLF_or_CR_or_LF /* Not quite the same as CR_or_LF */<br>}<br><br>The Edit control behavior would be the default...<br>WordPad behavior could be simulated with CRLF_or_LF...<br>Mac OS 9 SimpleText behavior could be simulated with CR...<br>etc., etc.</div>
<p><a id="506844" href="#506844">#</a> <strong>Michael S. Kaplan</strong> on 22 Dec 2005 2:40 PM:</p><div style="margin-left: 1em">Maurits, Maurits, Maurits,<br><br>The EDIT control *is* the TextBox....<br><br>And of course beyond that there is the fundamental misperception that Notepad is the natural editor to use for XML and other documents that are not plain text! :-)</div>
<p><strong>TheLostBrain</strong> on 24 Apr 2008 4:42 PM:</p><div style="margin-left: 1em"><P>Dude you rock! ;) </P>
<P>You just saved me a ton of time! </P>
<P>Thanks!</P>
<P>-TheLostBrain</P></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/12/22/506595.html" title="New in Windows Vista: OrdinalIgnoreCase for Win32">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/12/21/506427.html" title="New in Windows Vista: updates to clock and calendar">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-12-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/12/22/506590.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>