<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/14/352802.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>CharNext(ch) != ch+1, a lot of the time</title></head><body>
<h1>CharNext(ch) != ch+1, a lot of the time</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/14 00:08 -08:00, original URI: http://blogs.msdn.com/michkap/archive/2005/01/14/352802.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P>Earlier today, <a href="http://blogs.msdn.com/OldNewThing">Raymond Chen</A> sent me a piece of email that mentioned an important point for developers who iterate a string one character at a time. Its a lot more interesting than what I was going to post so I'll do the boring one later or tomorrow (or if I am smart I'll just give it a miss entirely), and I'll do this one now, instead.</P>
<P>It has to do with the <A title=CharNext href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnext.asp" target=_blank>CharNext</A> and <A title=CharPrev href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charprev.asp" target=_blank>CharPrev</A> APIs</P>
<P>The email had a title similar to the one of this posting. Basically he was pointing out that CharNextW(p) != p+1. And he is right, they are not equal, a lot of the time.</P>
<P>The same issue that applies to CharNext(ch) not being the same as ch+1 applies to CharPrev(ch) and ch-1. Put more verbosely, this is because&nbsp;incrementing and decrementing a character pointer within a string is not nearly as functional as these APIs can be.</P>
<P>The reasons for this are many and as&nbsp;I said they apply to both CharPrev and CharNext (and incidentally also <A title=CharNextExA href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnextexa.asp" target=_blank>CharNextExA</A> and <A title=CharPrevExA href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charprevexa.asp" target=_blank>CharPrevExA</A>). They include:</P>
<UL>
<LI>When not dealing with Unicode, strings on CJK (Chinese, Japanese, and Korean) systems have many characters that take up two bytes (including all Han/Kanji/Hanja, all Hangul&nbsp;and all full-width non-Kanji). Using simple byte increments will mean one is moving through half a character with each iteration.<BR>
<LI>When dealing with Unicode, strings that use combining characters like <STRONG>å</STRONG>&nbsp;(<A href="http://www.fileformat.info/info/unicode/char/0061/index.htm">U+0061</A> <A href="http://www.fileformat.info/info/unicode/char/030a/index.htm">U+030a</A>, a plus combing ring) or <STRONG>ü</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/0075/index.htm">U+0075</A> <A href="http://www.fileformat.info/info/unicode/char/0308/index.htm">U+0308</A>, u plus combining umlaut) take up two code points, so once again one will be dealing with moving through half a character with each iteration.<BR>
<LI>Stretching to languages like Vietnamese where double diacritics are commonly seen&nbsp;in characters such as&nbsp;<STRONG>ộ</STRONG> (<A href="http://www.fileformat.info/info/unicode/char/006f/index.htm">U+006f</A> <A href="http://www.fileformat.info/info/unicode/char/0323/index.htm">U+0323</A> <A href="http://www.fileformat.info/info/unicode/char/0302/index.htm">U+0302</A>,&nbsp;o plus combining dot below plus combining circumflex) take up three code points, one is dealing with only a third of a character with each iteration!<BR>
<LI><FONT color=#808080><STRIKE>When one uses Unicode supplementary characters such as <A href="http://www.fileformat.info/info/unicode/char/021532/index.htm">U+21532</A> (an Extension B ideograph) where a Unicode string on Windows will actually be represented by a surrogate pair (U+d845 U+dd32) one will actually once again be dealing with half a character.</STRIKE></FONT></LI></UL>
<P>I crossed that last item off of the list because CharNext and CharPrev do not currently handle surrogate pairs properly, so one will be just as bad off using the APIs as one would be just doing simple pointer arithmetic. </P>
<P>(Never fear, I will be looking into seeing if I can do something about this for the future now that someone reminded me!)<SUP>1</SUP></P>
<P>How does it do this work? Well, CharNextA/CharPrevA use the <A title=IsDBCSLeadByte href="http://msdn.microsoft.com/library/en-us/intl/unicode_0o2t.asp" target=_blank>IsDBCSLeadByte</A> API on appropriate platforms to determine if the byte is a lead byte in a lead byte/trail byte pair, and CharNextW/CharPrevW use the <A title=GetStringTypeW href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/getstringtypew.asp" target=_blank>GetStringTypeW</A> API to figure out if a character is a non-spacing character like a ring or a diaresis.</P>
<P>Other APIs that do an even better job can be found in <A title=Uniscribe href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target=_blank>Uniscribe</A>. The <A title=ScriptBreak href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_1dm3.asp" target=_blank>ScriptBreak</A> API will return an array of <A title=SCRIPT_LOGATTR href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_1gtu.asp" target=_blank>SCRIPT_LOGATTR</A> structs, and that structure's fCharStop member, when set, indicates that this is a valid place for a cursor to jump to. When such a cursor jump is valid, it indicates that you have moved forward by one "character" in the sense that a user might think of a character. And therefore if you use Uniscribe you will be handle this job properly, even for supplementary characters.</P>
<P>Unicribe is a useful enough library that I will talk more about it in a future post, maybe even some sample code for easier operations (like this one). Uniscribe is behind most of the support of international text on Windows.</P>
<P>It was ported to Windows CE 5.0 as well, though it is described in documentation about the <A href="http://msdn.microsoft.com/library/en-us/wceinternational5/html/wce50oricomplexscriptsapplicationdevelopment.asp">CE Platform Builder</A>, which implies (to me) that it might only be included on SKUs that are built with it for shipment to places that require it. Those who know more about Windows CE and Uniscribe should feel free to contact me with more info so I can sound more intelligent the next time I talk about it!</P>
<P>This is a <EM>much</EM> easier task in managed code, whether you can use the <A title=StringInfo href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationstringinfoclasstopic.asp" target=_blank>StringInfo</A> class and its&nbsp;GetTextElementEnumerator&nbsp;and GetTextElement methods, which allow for easy iteration of a string. You can also use its <A title=ParseCombiningCharacters href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationstringinfoclassparsecombiningcharacterstopic.asp" target=_blank>ParseCombiningCharacters</A> method to get an array of integers representing the same character boundaries represented by Uniscribe's SCRIPT_LOGATTR.fCharStop member.</P>
<P>For those of you who are still <STRIKE><FONT color=#808080>awake</FONT></STRIKE>reading, I will point out one annoying issue I discovered while typing in the å, ü, and ộ characters earlier in this post. Problems? Well...</P>
<OL>
<LI>The .Text blog system's editor to type did <EM>not</EM> handle this properly and moved past 1/2 or 1/3 of the character with each arrow keypress. <BR>
<LI>When the character was being selected it either selected the whole character and then appeared to do nothing or appeared to do nothing and then selected the whole character, depending on whether I moved from left-to-right or right-to-left with the cursor.<BR>
<LI>The deletion behavior was just as dismal. I don't even want to talk about it.&nbsp;</LI></OL>
<P>I also saw the same behavior in plain old EDIT text boxes in Internet Explorer, so it looks like <A href="http://scottwater.com/blog">.Text</A> is off the hook. And that even though IE does use Uniscribe, they forgot to implement some of the possible features that library provides<FONT size=1><SUP>2</SUP></FONT>. :-(&nbsp;</P>
<P>If someone wanted to try this in other browsers (cough! FireFox or Opera), I'd be curious about the results; the IE results were pretty disappointing to me. Try selecting the string "åüộåüộåüộåüộ" and pasting into their browser wherever you see an EDIT box to test, or just try putting thr cursor into and running the cursor through the INPUT control text right here:</P>
<P></P>
<P>and let me know what you see (unless you see 20 other people have&nbsp; already responded!). Be sure to mention the browser and version (I am using IE 6.0.3790.0 on Windows Server 2003 with all of the latest updates).</P>
<P>(All that talk about Uniscribe reminds me I want to talk about <A title=MLang href="http://msdn.microsoft.com/workshop/misc/mlang/mlang.asp" target=_blank>MLang</A> at some point too -- I've added&nbsp;MLang and Uniscribe to my list of things to talk about!)</P>
<P><EM><FONT size=1>1 - It first started when I was working on&nbsp;MSLU, but even to this day I have not gotten fully used to being able to say stuff like this. I'll try to write more about it another time, cuz it is kind of cool.<BR>2 - It works fine in Notepad and Word and VS.Net, all of which use Uniscribe.</FONT></EM></P>
<P>&nbsp;</P>
<P><FONT color=#800080><FONT size=4><EM>This post brought to you by </EM>"å"</FONT><EM><FONT size=4> (</FONT><A href="http://www.fileformat.info/info/unicode/char/00e5/index.htm"><FONT size=4>U+00e5</FONT></A><FONT size=4>, a.k.a. LATIN SMALL LETTER A WITH RING ABOVE)</FONT><BR><FONT size=1>A character that is downright snooty about the fact that it has none of the problems mentioned in this article.<BR>Despite the fact that a circle almost bigger than its body&nbsp;is super-glued to its head, something that would make me feel at least a little self-conscious.</FONT></EM></FONT></P>
<hr/><p><a id="352815" href="#352815">#</a> <strong>Serge Wautier</strong> on Friday, January 14, 2005 12:38 AM:</p><div style="margin-left: 1em">Firefox' job is only arguably slightly better:<br><br>- Simple arrow key navigation (left and right arrows) also require being pressed 2 or 3 times to move one char forward/backward but the caret doesn't move at all during the intermediate moves.<br><br>- the back key behaves the same way as IE6.<br><br>- Selection (Ctrl+ left/right) goes through 1/2 or 1/3 of char but the difference is that the (un)selected parts of the characters are moved (half-way) besides the 'main' character to show that they are included or not.<br><br>Version : Ouch... 0.9 :-(</div>
<p><a id="352823" href="#352823">#</a> <strong>Troy</strong> on Friday, January 14, 2005 12:52 AM:</p><div style="margin-left: 1em">Safari 1.2.4 handles it fine (if you are interested in other OSs) - it didn't move half a character etc like IE 6 SP2 on XPSP2 did.</div>
<p><a id="352824" href="#352824">#</a> <strong>Ludvig A. Norin</strong> on Friday, January 14, 2005 12:58 AM:</p><div style="margin-left: 1em">Be nice to the &#229;, Swedes are very affectionate towards this character :-)</div>
<p><a id="352831" href="#352831">#</a> <strong>Michael Kaplan</strong> on Friday, January 14, 2005 1:05 AM:</p><div style="margin-left: 1em">I work with a Swede who told me as much, hopefully my joke under the sponsorship will not be taken as too offensive (if so it will be taken down, I would not want &quot;&#229;&quot; yo retract its sponsorship.<br><br>I guess I could use the combining form as a stunt double for the precomposed form as a way around the problem, then it would be less likely to be offensive to it, since a stunt double rarely worries about the same things as the celebrity....<br><br>Or maybe this whole post is silly, too. Scratch the maybe! :-)</div>
<p><a id="352878" href="#352878">#</a> <strong>Marcel</strong> on Friday, January 14, 2005 3:04 AM:</p><div style="margin-left: 1em">Same problems with Opera 7.54.</div>
<p><a id="352916" href="#352916">#</a> <strong>Mike Dimmick</strong> on Friday, January 14, 2005 5:38 AM:</p><div style="margin-left: 1em">Re: Windows CE:<br><br>Platform Builder is the tool for OEMs to build their own custom platforms. It's entirely up to the OEM to decide what to put in. Evangelism may be required for OEMs producing PDA-like platforms.<br><br>I would expect Microsoft's own Windows Mobile platforms (Pocket PC and Smartphone) to include <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> in future versions. Microsoft dictates which CE components are included in a Windows Mobile platform image. The OEM has responsibility for the OEM Adaptation Layer to adapt the platform to the specific hardware. At least, that's my understanding.</div>
<p><a id="352943" href="#352943">#</a> <strong>Michael Kaplan</strong> on Friday, January 14, 2005 6:48 AM:</p><div style="margin-left: 1em">Thanks Mike,<br><br>Yep, seeing it in the Platform Builder means people have to end up choosing if it is a wothwhile addition to the platform. Getting them to do it can be a challenge since the space on the device is at such a premium....</div>
<p><a id="352973" href="#352973">#</a> <strong>Centaur</strong> on Friday, January 14, 2005 7:49 AM:</p><div style="margin-left: 1em">Firefox 1.0 is no better. First Shift+Right selects the 'a' (displaying the 'a' selected and the ring shifted right and unselected), second Shift+Right selects the ring and it snaps back into place. Deleting is (pardon me) intuitive: first Backspace deletes the circumflex, second the combining dot below, and third the o. One can also delete the letter first, then the combining diacritics move to the previous letter. They, strangely, don’t combine but are positioned left to right.</div>
<p><a id="353004" href="#353004">#</a> <strong>Larry Osterman</strong> on Friday, January 14, 2005 8:26 AM:</p><div style="margin-left: 1em">Btw, the IE address bar (and google's search bar) get it right.  My suspicion is that's because they're standard windows edit controls, while the IE (and firefox) edit controls aren't real windows controls.<br></div>
<p><a id="353023" href="#353023">#</a> <strong>Rick Schaut</strong> on Friday, January 14, 2005 8:44 AM:</p><div style="margin-left: 1em">Well, there goes my even-odd trick for Kanji-backspace :-).<br><br>For what it's worth, the reason Safari, on Mac OS X, gets this right is essentially the same reason the IE address bar gets it right.  Safari uses ATSUI (Apple Text Services for Unicode Imaging).<br><br>Unfortunately, Mac OS X doesn't have a <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> equivalent.  One either eats the whole ATSUI pie, or one has to try and figure out character break points on one's own.<br><br>If I may offer a suggestion, I think some developers might well be interested in how to use Uniscribe to do context-based glyph substitution (e.g. Arabic).<br></div>
<p><a id="353033" href="#353033">#</a> <strong>Michael Kaplan</strong> on Friday, January 14, 2005 8:53 AM:</p><div style="margin-left: 1em">Rick -- check out the &quot;Suggest a topic for me!&quot; link at the top of the page....</div>
<p><a id="353389" href="#353389">#</a> <strong>Mike Dimmick</strong> on Friday, January 14, 2005 4:46 PM:</p><div style="margin-left: 1em">Interesting - at home your example renders correctly, while at work it didn't. I get boxes (the 'missing character' symbol) behind the o rather than the diacritics. Both machines run XP SP2.<br><br>One difference is that I use ClearType on the home machine, but I've just turned that off and it's still OK. I ought to have the same fonts on both...<br><br>Ah! Some stupid program has overwritten Arial with a version from what looks like Win95! Whatever it was has also trashed Times, Times Bold and Symbol.</div>
<p><a id="353516" href="#353516">#</a> <strong>Ryan Myers [MSFT]</strong> on Friday, January 14, 2005 11:29 PM:</p><div style="margin-left: 1em">Does CharNextW only recognize combining characters, or does it use the UAX29 grapheme cluster algorithm, or something else that's locale-specific?<br><br>I've been considering the impact of jamo syllables upon this and debating whether to treat each jamo as a grapheme cluster for my &quot;character-wise iterator&quot;, or treat a syllable cluster according to 3.12 as a cluster.<br><br>And yeah, Firefox 1.0 treats it boneheadedly, both in the input box and in the address bar.<br><br>As Larry alluded to, there are so many elements on any given page that creating a child window for everything would exhaust handle space easily, so IE has its own set of &quot;windowless controls&quot; that it uses for everything inside a rendered page.</div>
<p><a id="353520" href="#353520">#</a> <strong>Michael Kaplan</strong> on Friday, January 14, 2005 11:59 PM:</p><div style="margin-left: 1em">It is not using anything out of Unicode, it is using the <a title="GetStringTypeW" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/getstringtypew.asp" target="_blank">GetStringTypeW</a> API's results to decide what is a non-spacing character. Unicode may choose to respect its elders since GetStringTypeW predates that UAX (and most of the others!).<br><br>Looking at the data, Jamos are not treated as combining characters. They are pretty much treated as:<br><br>CT_CTYPE1:    C1_ALPHA | C1_DEFINED<br>CT_CTYPE2:    C2_LEFTTORIGHT<br>CT_CTYPE3:    C3_ALPHA<br><br>But the CTYPE data comes from Unicode and ha for a while now, and Unicode does not define them as combining either; it calls them Lo (Letter, Other).<br><br>And I do see what IE is doing, but even in their own custom controls they could use <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> to define the cursor/arrow/selection/deletion behavior....</div>
<p><a id="354090" href="#354090">#</a> <strong>Dean Harding</strong> on Sunday, January 16, 2005 2:37 PM:</p><div style="margin-left: 1em">I could perhaps argue that the way it's handled in IE is by design.  When I select the text with the mouse, it selects a whole character at a time (i.e. base char + combining chars) and I can delete the whole thing by just hitting backspace or delete.<br><br>When using the keyboard, it moves through the 1/2 or 1/3 of the character, which basically lets me edit the combining charaters in-place.  Maybe it's just a personal thing, but I think that's not entirely a bad way of doing it.<br><br>You're right in that it's not how Visual Studio does it - once you create the full charater, it treats all two or three bytes as a single character, but I can see how this could be viewed as &quot;by design&quot;.</div>
<p><a id="354114" href="#354114">#</a> <strong>Michael Kaplan</strong> on Sunday, January 16, 2005 3:22 PM:</p><div style="margin-left: 1em">Well, one could argue that, except there is an MS-wide plan that gives the suggested means of dealing with complex scripts, which IE is not following. :-)<br><br>I'll try to talk a bit about complex scripts tonight....</div>
<p><a id="354220" href="#354220">#</a> <strong>Dean Harding</strong> on Sunday, January 16, 2005 8:54 PM:</p><div style="margin-left: 1em">Heh, since when have the IE team been known for following the standards? :p~</div>
<p><a id="363364" href="#363364">#</a> <strong>James</strong> on Sunday, January 30, 2005 6:57 AM:</p><div style="margin-left: 1em">Based on this post, I wrote a snippet to try to iterate through a string using the CharNextW function:<br><br>int main()<br>{<br>  for (wchar_t const * p = L&quot;\x0075\x0308\x006f\x0323\x0302&quot;, * n; *p; p = n)<br>    std::cout &lt;&lt; (n = CharNextW(p)) - p &lt;&lt; '\n';<br>}<br><br>From what you've said, I'd expect '2' and '3' to be printed, corresponding to your &quot;u plus combining umlaut&quot; and &quot;o plus combining dot below plus combining circumflex&quot; examples. Instead, it prints a whole bunch of '1's. What have I misunderstood?</div>
<p><a id="363370" href="#363370">#</a> <strong>Michael Kaplan</strong> on Sunday, January 30, 2005 7:40 AM:</p><div style="margin-left: 1em">What platform are you running on?</div>
<p><a id="363378" href="#363378">#</a> <strong>James</strong> on Sunday, January 30, 2005 7:59 AM:</p><div style="margin-left: 1em">I ran the program above on XP Pro SP2. I had compiled it with Visual C++ 2003 and the current Platform SDK as an otherwise empty console project, adding just includes for Windows.h (for CharNextW) and iostream (to cout the differences). Under the debugger, the string displayed as the two characters I expected, but <a title="CharNext" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnext.asp" target="_blank">CharNext</a> always returned p+1.</div>
<p><a id="363389" href="#363389">#</a> <strong>Michael Kaplan</strong> on Sunday, January 30, 2005 8:46 AM:</p><div style="margin-left: 1em">Hmmm.... weird. I tried to split it out a little to make it a little clearee what was happening zt each step in the debugger;<br><br>int main(int argc, CHAR* argv[])<br>{<br>    wchar_t * p = L&quot;\x0075\x0308\x006f\x0323\x0302&quot;, * n;<br>    for (; *p; p = n) {<br>        n = CharNextW(p);<br>        std::cout &lt;&lt; n - p &lt;&lt; '\n'; <br>    }<br>    return 0;<br>}<br><br>And it is iterating through one wchar_t at a time rather than jumping at the character boundaries. This is definitely not expected.</div>
<p><a id="363421" href="#363421">#</a> <strong>Michael Kaplan</strong> on Sunday, January 30, 2005 11:43 AM:</p><div style="margin-left: 1em">Ok, found the problem James. See <a target="_new" href="http://archives.miloush.net/michkap/archive/2005/01/30/363420.html">http://blogs.msdn.com/michkap/archive/2005/01/30/363420.aspx</a> for the gory details (and thanks for saving me from my own blindness!).</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/06/10 <a href="http://archives.miloush.net/michkap/archive/2009/06/10/9723321.html">UCS-2 to UTF-16, Part 10: Variation[ Selector] on a theme...</a></p><p>2008/12/16 <a href="http://archives.miloush.net/michkap/archive/2008/12/16/9223301.html">UCS-2 to UTF-16, Part 9: The torrents of breaking CharNext/CharPrev</a></p><p>2006/11/10 <a href="http://archives.miloush.net/michkap/archive/2006/11/10/1053925.html">Some people feel really insecure about the size of their [string] members</a></p><p>2005/09/13 <a href="http://archives.miloush.net/michkap/archive/2005/09/13/465228.html">Here is an interview question for you. :-)</a></p><p>2005/01/30 <a href="http://archives.miloush.net/michkap/archive/2005/01/30/363420.html">We broke CharNext/CharPrev (or, bugs found through blogging?)</a></p><p>2005/01/17 <a href="http://archives.miloush.net/michkap/archive/2005/01/17/354279.html">Keeping it simple, with complex scripts</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/14/353216.html" title="Calendars on Win32 -- just there for show....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/13/352001.html" title="MSLU is not &quot;open source&quot; but I think that is really okay">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/14/352802.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>