<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/16/353873.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How [case-]insensitive (apologies to Frank Sinatra)</title></head><body>
<h1>How [case-]insensitive (apologies to Frank Sinatra)</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/16 03:19 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/01/16/353873.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Tor Lillqvist noted that in some of my previous entries on casing (cf: <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2004/12/02/273619.html">Get off my [lower] case! (or: Casing, the 1st)</A>&nbsp;and <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2004/12/03/274288.html">The [Upper]Case of the Turkish İ (or: Casing, the 2nd)</A>) I made some hints about the casing table and NTFS. He goes on to ask:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>The "Get off my [lower] case" entry mentions the issue a bit, but on the other hand from that one gets the impression that the case-insinsitivenes of NTFS would be handled by code in the Windows kernel. <BR><BR>If I have understood correctly, in fact there is this (hidden from casual view) file called $UpCase on *each* NTFS volume that defines the case-insensitivess of file names on *that* volume. The file contains an uppercase mapping from the characters in the BMP to *single-character* uppercase ones. (Thus the German ess-zet in a filename doesn't map to SS, etc.) <BR><BR>This file is created when the volume is formatted, and I guess never modified even if newer Windows versions are installed or whatever? What would be interesting to know is what determines the contents of this file, and how it has changed in various NT versions, whether the mapping depends on the locale of the user (or default locale of the machine) doing the formatting, etc. I tried asking for this in the microsoft.public.win2000.file_system group, but no replies... </EM></FONT></P></BLOCKQUOTE>
<P>Well, the summary of what happen does indeed refer to magical hidden file 10, also known as $UpCase. You can actually find out lots about the internals by searching on Google (having had a chance to look at (a) those resources, (b) available specs on NTFS, and (c) NT source code, I can state pretty definitively that the external&nbsp;resources are easier to understand!).</P>
<P>Anyway, the file ($UpCase) contains a copy of the very same uppercase information that NLS defines, burned into the drive at the time the drive is formatted. </P>
<P>The NLS uppercasing table is only occasionally updated and it is really only updated when new code points are added to Unicode, which is fairly rare for letters that have case mapping.</P>
<P>What Tor notes about the single code point only mapping is true, and it really true for the NLS casing in general (and not just the NTFS casing). </P>
<P>The locale settings on the machine have <STRONG>no</STRONG> affect on this setting, ever.</P>
<P>Looking at the file across many versions (just a quick glance, I could be missing details):</P>
<UL>
<LI>NT 3.51&nbsp;---&gt;&nbsp;&nbsp;&nbsp;Some weird mappings that did not match Unicode were in the file, including&nbsp;a Georgian mapping that roundtrips between upper and lower case 
<LI>NT 4.0&nbsp;&nbsp;---&gt;&nbsp;&nbsp;&nbsp;Some additions, and most weird mappings removed (though only the uppercasing half of the weird Georgian mapping disappeared); <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279942.html">linguistic</A> mappings added for Turkish 
<LI>NT 5.0<SUP><FONT size=1>1</FONT></SUP> ---&gt;&nbsp;&nbsp;&nbsp;No changes, other than additional <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279942.html">linguistic</A> mappings added for Azeri 
<LI>NT 5.1<SUP><FONT size=1>2</FONT></SUP> ---&gt;&nbsp;&nbsp;&nbsp;No changes 
<LI>NT 5.2<SUP><FONT size=1>3</FONT></SUP> ---&gt;&nbsp;&nbsp; No changes</LI></UL>
<P>Looking ahead:</P>
<P>I am a huge proponent of finishing up the Georgian fix (removing the bogus lowercase mapping), which will of course have no effect on the filesystem (which only keeps that uppercase mapping anyway). </P>
<P>I am also a fan of picking up those new characters that have been added to Unicode since the last update to the table (since the apparent partial case sensitivity of NTFS gets more and more visible over time as we miss more and more new letters that do have a case mapping). This would let us get in stuff like <A href="http://www.fileformat.info/info/unicode/char/01bf/index.htm">U+01bf</A> (ƿ, a.k.a.&nbsp;LATIN LETTER WYNN) that is not there now but which ought to be mapped to <A href="http://www.fileformat.info/info/unicode/char/01f7/index.htm">U+01f7</A>&nbsp;(Ƿ, a.k.a.&nbsp;LATIN CAPITAL LETTER WYNN).</P>
<P>Now this last one is pretty much the main reason why NTFS stores the $UpCase table as it does, independent of what the NLS tables does. Because you have to be able to trust that the files you save on a disk will be available tomorrow or when you update your operating system. It still does make the&nbsp;change more controversial, especially with people who do not use the characters in question (since we only look truly stupid to the people who actually use these letters)....</P>
<P>Now on my wish list would be an API that provides the file system casing results -- not just for NTFS but for any file system, even case sensitive ones like CDFS. But it is unclear whether such a function even could exist given all of the differences between file systems. But I guess that's why we call it a wish list. :-)</P>
<P><FONT size=1><EM>1 - Also known as Windows 2000<BR>2 - Also known as Windows XP<BR>3 - Also known as Windows Server 2003</EM></FONT></P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by </EM>"ѝ"<EM> and </EM>"Ѝ"<EM> (<A href="http://www.fileformat.info/info/unicode/char/045d/index.htm">U+045d</A> a.k.a.&nbsp;CYRILLIC SMALL LETTER I WITH GRAVE and <A href="http://www.fileformat.info/info/unicode/char/040d/index.htm">U+040d</A> a.k.a&nbsp;CYRILLIC CAPITAL LETTER I WITH GRAVE)<BR></EM><FONT size=1>Neither of the sponsors are in the NLS casing tables either, and they seem a little bitter about that!</FONT></FONT></P>
<hr/><p><a id="354116" href="#354116">#</a> <strong>Tor Lillqvist</strong> on 16 Jan 2005 3:29 PM:</p><div style="margin-left: 1em">Yes, an API to find out the exact case mapping that would be used for a certain file name in a certain directory would be nice. Unfortunately, I doubt whether it would be feasible to implement it. For local file systems, sure, but donsidering CIFS, it would require CIFS enahncements, wouldn't it?</div>
<p><a id="354141" href="#354141">#</a> <strong>Michael Kaplan</strong> on 16 Jan 2005 4:40 PM:</p><div style="margin-left: 1em">Indeed, that is true.<br><br>Ok, how about a scaled back wish list item -- a casing function that would properly handle the NTFS case, using the $UpCase table on a specified drive? Obviously that exists for code deep down in the NTFS redirector, so exposing it is not impossible....</div>
<p><a id="354309" href="#354309">#</a> <strong>Jonathan Wilson</strong> on 17 Jan 2005 2:04 AM:</p><div style="margin-left: 1em">This begs the question as to why NTFS (and win32 in general including the long filename extentions to FAT) didnt do what just about every unix filesystem since the dawn of time has done and have full case sensativity with filenames.<br>It would store a filename with the exact case that the program making the file I/O call requested.<br>So if the program called the file DoCuMeNt.TxT that is what would be stored to the disk.<br></div>
<p><a id="354356" href="#354356">#</a> <strong>Michael Kaplan</strong> on 17 Jan 2005 4:50 AM:</p><div style="margin-left: 1em">Jonathan, it is, it is. This functionality is just what it used to do the testing. But case is preserved as people type it in for the long file name.</div>
<p><a id="354640" href="#354640">#</a> <strong>Michael Grier</strong> on 17 Jan 2005 1:36 PM:</p><div style="margin-left: 1em">The reason that it's infeasible to make these changes for existing volumes is because it would involve recreating the indices (since they're stored in the canonicalized case as well as the preserved case as Michael points).<br><br>Maybe someone can convince the FS folk to add a command to resync the casing tables with the current OS but then what happens when you take that volume down to an older OS and mount it?<br><br>I've always meant to experiment with a volume that had some wacky case conversions stored in $UpCase to see how much system code broke due to its assumption that the kernel's notion of case insensitive has to match the filesystem's.<br></div>
<p><a id="354665" href="#354665">#</a> <strong>Michael Kaplan</strong> on 17 Jan 2005 2:04 PM:</p><div style="margin-left: 1em">Yes, I would never suggest making these changes for existing volumes.... <br><br>Though the question that comes up is to do with if the NLS tables (which is to say the OS tables) are updated, as they were between NT 3.51 and NT 4.0, then what is the result?<br><br>This is something I would like to see tested out, so we can see what the impact is. Given how different our case tables are from Unicode's, even for characters that can be in common use for customers....</div>
<p><a id="355143" href="#355143">#</a> <strong>Jonathan Wilson</strong> on 18 Jan 2005 5:50 AM:</p><div style="margin-left: 1em">I know NTFS and FAT32 and such do preserve case.<br>But if they were properly case sensitive (such that Document.txt and document.txt were different files like they are on every unix filesystem I have had experience with), there would be no reason to need to worry about case in the filesystem.<br>The filesystem (or its drivers, OS layers etc) wouldnt need to care that U+00C3 and U+00E3 are a matched pair of capital and lowercase letters. It would be up to the application and the user to deal with any issues to do with filename casing.<br><br>I do understand that doing this now after all this time would never be fesable but I am curious as to why win32 is (as far as I am aware) the only OS/filesystem that preserves the case of filenames but is not specifically Case Sensitive where the case of filenames matters to the OS and to the file I/O layers.<br></div>
<p><a id="9383607" href="#9383607">#</a> <strong>Paul Sanders</strong> on 29 Jan 2009 3:17 PM:</p><div style="margin-left: 1em"><p>OS X has a case insensitive filesystem, I notice. &nbsp;Not sure how long this has been the case (sic), but I like it! &nbsp;It's how humans' brains work (well, mine anyway).</p></div>
<p><strong>bobince</strong> on 8 Aug 2009 7:13 PM:</p><div style="margin-left: 1em"><p>Do you know what case tables are used internally for ordering subkeys (and uniqueness) in Registry hives (ie. in the li/ri/lf/lh records)? I've noticed they're always in a case-insensitive order, but there is no NLS data stored in the hive structure as far as I can see, so it's presumably not using the same strategy as NTFS.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2005/01/16 <a href="http://archives.miloush.net/michkap/archive/2005/01/16/354210.html">My apparent obsession with "case" puns</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/16/354210.html" title="My apparent obsession with &quot;case&quot; puns">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/15/353756.html" title="Search here or search for info on Unicode characters!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/16/353873.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>