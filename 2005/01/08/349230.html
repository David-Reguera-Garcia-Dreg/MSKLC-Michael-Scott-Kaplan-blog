<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/08/349230.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How does it detect invalid characters?</title></head><body>
<h1>How does it detect invalid characters?</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/08 14:34 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/01/08/349230.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A few days ago I mentioned <a href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html">the new compiler error C4819</A>&nbsp;for C/C++. When&nbsp;I did so, I quoted the meaning of the error:</P>
<BLOCKQUOTE dir=ltr>
<P><SPAN><FONT size=2>C4819 occurs when an ANSI source file is compiled on a system with a codepage that cannot represent all characters in the file.</FONT></SPAN></P></BLOCKQUOTE>
<P><SPAN>A few people asked me how this was being detected.</SPAN></P>
<P><SPAN>There are many ways to do it, but the easiest is to&nbsp;call the <A title=MultiByteToWideChar href="http://msdn.microsoft.com/library/en-us/intl/unicode_17si.asp" target=_blank>MultiByteToWideChar</A> API,&nbsp;using <a href="http://archives.miloush.net/michkap/archive/2005/01/06/347834.html">CP_ACP</A> as the <EM>CodePage</EM> parameter and the MB_ERR_INVALID_CHARS flag. </SPAN></P>
<P><SPAN>Any time a byte value that is not part of the legal mapping in the codepage is found, the API will fail with a <A title=GetLastError href="http://msdn.microsoft.com/library/en-us/debug/base/getlasterror.asp" target=_blank>GetLastError</A> return value of&nbsp;ERROR_NO_UNICODE_TRANSLATION.</SPAN></P>
<P><SPAN>It is important to note that this functionality is much more akin to that of the spellchecker in Microsoft Word than the thesaurus, in that it has no chance of detecting byte values that are valid for the code page but that make no sense. </SPAN></P>
<P><SPAN>Therefore if one attempts to use the strings L"Ελλάδα" and L"ελληνικά" on a machine with code page 1252 as its default will simply cause the compiler to assume you meant L"ÅëëÜäá" and L"åëëçíéêÜ". </SPAN></P>
<P><SPAN>The only time you will see the error is when a byte value is not&nbsp;a valid one, as per the tables listed at the <A href="http://www.microsoft.com/globaldev/reference/WinCP.mspx">Code Pages Supported by Windows</A> site. Examples are the shaded cell choices, for example 0x8d and 0x8f in code page <A href="http://www.microsoft.com/globaldev/reference/sbcs/1252.htm">1252</A>, 0x8e or 0x90 in code page <A href="http://www.microsoft.com/globaldev/reference/sbcs/1255.htm">1255</A>, or 0x80 in code page <A href="http://www.microsoft.com/globaldev/reference/dbcs/932.htm">932</A>. </SPAN></P>
<P><SPAN>As most of these code page tables are full, it is easily possible to fool the compiler (or more accurately to fool the NLS API; I hate to blame an innocent compiler for an error they could not detect!) into thinking the string is perfectly valid even if it essentially crap like L"éùøàì"&nbsp;/ L"òáøéú" for L"ישראל"&nbsp;/ "עברית" (<A href="http://www.microsoft.com/globaldev/reference/sbcs/1255.htm">cp1255</A>). Or L"ÇáããáßÉ ÇáÚÑÈíÉ ÇáÓÚæÏíÉ" / L"ÇáÚÑÈíÉ" for L"المملكة العربية السعودية" / L"العربية" (<A href="http://www.microsoft.com/globaldev/reference/sbcs/1256.htm">cp1256</A>). </SPAN></P>
<P><SPAN>And all of the examples I gave assumed you had a machine with a CP_ACP value of 1252. The same problems can be seen in any cross-codepage situation, such as returning L"πσρρκθι" when what was meant was L"русский" (<A href="http://www.microsoft.com/globaldev/reference/sbcs/1253.htm">cp1253</A> rather than <A href="http://www.microsoft.com/globaldev/reference/sbcs/1251.htm">cp1251</A>). Or L"¤¤¤å(ÁcÅé)" rather than L"中文(繁體)" (<A href="http://www.microsoft.com/globaldev/reference/sbcs/1254.htm">cp1254</A> rather than <A href="http://www.microsoft.com/globaldev/reference/dbcs/950.htm">cp950</A>). </SPAN></P>
<P><SPAN>I could go on but you probably get the point; one would really have to rely on the invalid sequences, and some code pages (like 1252) do not have very many. Saving the file as a Unicode (meaning UTF-16LE) file might be the best way to avoid the potential bugs that come up later with these nonsense strings being propogated to your application.</SPAN></P>
<P><SPAN></SPAN>&nbsp;</P>
<P><SPAN><FONT color=#800080><EM>This post brought to you by </EM>"€"<EM>&nbsp;(U+20ac, a.k.a. EURO SIGN)<BR><FONT size=2>Note that U+20ac does not exist on code page 932!</FONT></EM></FONT></SPAN></P>
<hr/><p><a id="349555" href="#349555">#</a> <strong>Dean Harding</strong> on 9 Jan 2005 2:54 PM:</p><div style="margin-left: 1em">I'd say you probably shouldn't be putting these characters in there in the first place.  If they're going to be displayed to a user, they should be in a resource file (I can forgive English speaking people for doing it, since we seem to think the whole world should just speak English and be done with all these problems ;).  Of course, they could very well be in comments or the names of identifiers, but then it wouldn't really matter what the compiler saw the text as, as long as it see the same thing each time for identifiers (i.e. it'd be a problem if source file a.cpp was in the local code page and source file b.cpp was in Unicode, and both referenced the same non-ASCII identifier.)</div>
<p><a id="349573" href="#349573">#</a> <strong>Michael Kaplan</strong> on 9 Jan 2005 3:23 PM:</p><div style="margin-left: 1em">Its definitely not only a problem for english speakers -- I seldom have seen code coming out of Japan or Korea or PRC or Taiwan that did not have some ideographs in the comments -- and non-Unicode files cause them to not behave well on non-CJK systems....<br><br>But I agree with you that hardcoded strings are probably a no-no, even though people do them all the time.</div>
<p><a id="463571" href="#463571">#</a> <strong>Anonymous</strong> on 11 Sep 2005 4:19 AM:</p><div style="margin-left: 1em">Yesterday, Buck Hodges was talking about how TFS Version Control determines a file's encoding: ...</div>
<p><a id="8736679" href="#8736679">#</a> <strong>handan</strong> on 15 Jul 2008 11:25 PM:</p><div style="margin-left: 1em"><P>ie6,7 display javascriot error </P>
<P>invalid characters.</P>
<P>why?</P>
<P>can you tell me ?</P>
<P>tks!</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/07/16 <a href="http://archives.miloush.net/michkap/archive/2008/07/16/8737061.html">Google as the window, Windows as the door, the Doors as (never mind, this could take a while)</a></p><p>2008/05/19 <a href="http://archives.miloush.net/michkap/archive/2008/05/19/8518545.html">Everyone seems averse to the BOM these days; Should we blame TSA? :-)</a></p><p>2007/07/25 <a href="http://archives.miloush.net/michkap/archive/2007/07/25/4037646.html">What's up with MB_ERR_INVALID_CHARS?</a></p><p>2005/12/09 <a href="http://archives.miloush.net/michkap/archive/2005/12/09/502290.html">More on the C4819 error</a></p><p>2005/11/23 <a href="http://archives.miloush.net/michkap/archive/2005/11/23/495193.html">100% roundtrip ASCII? 100% roundtrip ANSI?</a></p><p>2005/10/28 <a href="http://archives.miloush.net/michkap/archive/2005/10/28/486019.html">It isn't Unicode, it's Double Secret Unicode!</a></p><p>2005/09/11 <a href="http://archives.miloush.net/michkap/archive/2005/09/11/463437.html">Working hard to detect code pages</a></p><p>2005/05/07 <a href="http://archives.miloush.net/michkap/archive/2005/05/07/415376.html">VB6 isn't using Unicode, most of the time</a></p><p>2005/02/20 <a href="http://archives.miloush.net/michkap/archive/2005/02/20/377116.html">Encoding support can be found in the strangest places....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/08/349248.html" title="Post titles here will not always be relevant">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/07/348944.html" title="Updating the keyboard list in the logon dialog">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/08/349230.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>