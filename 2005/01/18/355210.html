<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/18/355210.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The jury will give this string no weight</title></head><body>
<h1>The jury will give this string no weight</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/18 07:54 -08:00, original URI: http://blogs.msdn.com/michkap/archive/2005/01/18/355210.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P>(the title was inspired by a decade and a half of Law &amp; Order on NBC, then A&amp;E, and now TNT!)</P>
<P>I don't want to knock collation on Windows, because I think it rocks. It covers a lot of territory, and it gets the job done (and done well) in a lot of the world. But every once in a while you may find yourself on the bleeding edge of what is supported, and it is important when you are on the bleeding edge to keep from wounding yourself. Thus I am going to talk about one of those edge cases now....</P>
<P>It starts with the NLS APIs that handle collation. When you use the <A title=CompareString href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp" target=_blank>CompareString</A> API to compare two strings or the <A title=LCMapString href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp" target=_blank>LCMapString</A> API with the MAP_SORTKEY flag to get the sortkey of one string, an important bit of NLS architecture is involved. That bit is the weight tables that these NLS APIs use to make linguistic&nbsp;comparisons.</P>
<P>The weights&nbsp;are something I discussed a bit in a previous post entitled <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2004/12/30/344389.html">How do sort keys work?</A>&nbsp;and this post is going talk a little bit more about those weights. </P>
<P>The main problem is that although the weight tables that are used by Windows and the .NET Framework are great for all of the languages and scripts that Windows support, they are not quite as useful when the weights are not present. </P>
<P>There are many reasons for a code point to have no weight. It may actually not be a valid encoded Unicode code point, in which case it would be expected to have no weight. </P>
<P>Or it may be a code point that was not encoded in Unicode until after the operating system shipped a version (in which case it will have no weight since we do not have clairvoyants on staff!).</P>
<P>Or finally (and this is the one that kind of sucks a bit) it may not have been added to our tables yet. So....</P>
<P>If you try to compare strings containing (for example) <A href="http://www.unicode.org/charts/PDF/U0F00.pdf">Tibetan script</A> on any shipping version of Windows, they will all be considered equal to each other. If you tried to get sort keys for them then you will see that they have no weight. Therefore any kind of linguistic comparison will not return useful results; all strings will be equal. And this&nbsp;will happen&nbsp;even though the strings may not be the same length!</P>
<P>There are probably some developers around right now who are objecting to that last point, but I'll give a counterpoint. Let us say that you are comparing&nbsp; "hello" (U+0068 U+0065 U+006c U+006c U+006f) and "hëllô" (U+0068 U+0065 U+0302 U+006c U+006c U+006f U+030a) using CompareString with the NORM_IGNORENONSPACE flag. You would expect them to be considered equal since you are ignoring diacritics, which means "give the diacritics no weight", even though the length of the two strings is different. So the length is not important -- what is important is that the weights on the two strings are the same.</P>
<P>You'll get the same results if you try to compare strings in other scripts that do not yet have weight (such as <A href="http://www.unicode.org/charts/PDF/UA000.pdf">Yi Syllables</A> or <A href="http://www.unicode.org/charts/PDF/U1780.pdf">Khmer</A>). </P>
<P>It will happen in Windows 2000 and in SQL Server 2000 with <A href="http://www.unicode.org/charts/PDF/U3400.pdf">CJK Unified Ideographs Extension A (1.5MB)</A>&nbsp;or <A href="http://www.unicode.org/charts/PDF/U20000.pdf">CJK Unified Ideographs Extension B (13MB)</A>&nbsp;-- though we addressed this in Windows XP and Windows Server 2003, and there are new collations in SQL Server 2005 that give these ideographs some weight as well.</P>
<P>And in Longhorn we plan to give everything that is defined some type of default weight, at least. </P>
<P>On&nbsp;a side note, the original version of the post included a bunch of Tibetan strings in it, but .Text actually fails to post when that text is there (it probably has trouble with those "weightless" strings in its parsing logic?). This only affected the initial post; I was able to edit after the post and add characters (like the sponsor line). Weird bug....</P>
<P>Because with (a) <A title=MSKLC href="http://www.microsoft.com/globaldev/tools/msklc.mspx" target=_blank>MSKLC</A> available, (b) a publicly defined <A href="http://www.microsoft.com/typography/otspec/default.htm">OpenType spec</A>, and (c) custom cultures coming in the "Whidbey" release of the Visual Studio&nbsp; and the .NET Framework, Microsoft is clearly working to try and "get out of the way" of those who do not want to wait for us to support their language. Such people are right; we <STRONG>should</STRONG> get out of their way,&nbsp;And this is yet another step in that process to help enable them.</P>
<P>And yes, there will be more on these plans in future posts, especially as Beta 2 VS 2005 and Beta 3 of SQL Server 2005 make it out into the world, and then especially as more gets said about the "Longhorn" release of Windows. Stay tuned... because it's gonna keep being interesting. :-)</P>
<P><FONT color=#800080><EM>This post sponsored by</EM> "ག" (</FONT><FONT color=#800080><EM><A href="http://www.fileformat.info/info/unicode/char/0f42/index.htm">U+0f4</A></EM></FONT><FONT color=#800080><EM><A href="http://www.fileformat.info/info/unicode/char/0f42/index.htm">2</A>, a.k.a. TIBETAN LETTER GA)</EM></FONT></P>
<hr/><p><a id="355253" href="#355253">#</a> <strong>Mike Dimmick</strong> on Tuesday, January 18, 2005 9:08 AM:</p><div style="margin-left: 1em">SQL Server 2002? I must have missed that one ;-)<br><br>I take it that SQL Server 2000 on Windows XP or Server 2003 when configured for Windows collation _will_ use the weights for the CJK Unified Ideographs extensions. I'm surprised that SQL Server collations are being extended for SQL Server 2005 - I thought they were deprecated in favour of using the OS support, remaining only for backwards compatibility reasons.<br><br>Collations can be something of a nightmare on SQL Server at times - there have been many occasions where we've developed a system and then discovered in deployment that the end customer has a different default collation. If you've not explicitly specified the collation for columns in temporary tables (which I think we now always do - I've been trying to discourage use of temporary tables), you can get collation mismatch errors. This seems to be a particular problem if one site has a SQL collation selected and the other a Windows collation - even if one is SQL_Latin1_General_CP1_CI_AS and the other Latin1_General.<br><br>I've even seen problems where Setup will select one collation if you use the Default setup options, but offer you a different default if you select a Custom install. I forget which way round it is.</div>
<p><a id="355255" href="#355255">#</a> <strong>Michael Kaplan</strong> on Tuesday, January 18, 2005 9:12 AM:</p><div style="margin-left: 1em">Actually, SQL Server uses a snapshot of data prior to Windows 2000 RTM, even for Windows collations; they do not currentl use the OS.<br><br>So SQL Server 2000 will not ever give these characters weight, unless you use one of the binary collations.<br><br>I'll post more about this and the reasons for it another day.</div>
<p><a id="355259" href="#355259">#</a> <strong>joe</strong> on Tuesday, January 18, 2005 9:20 AM:</p><div style="margin-left: 1em">Could you say more about getting out of the way? <br><br>I see it is in your bio as one of the aspects of your job and I always wondered what it meant. Now you hint here about it, but it seems worth some more description?</div>
<p><a id="355260" href="#355260">#</a> <strong>Michael Kaplan</strong> on Tuesday, January 18, 2005 9:21 AM:</p><div style="margin-left: 1em">That is a great idea for another day, joe!</div>
<p><a id="355262" href="#355262">#</a> <strong>Michael Kaplan</strong> on Tuesday, January 18, 2005 9:23 AM:</p><div style="margin-left: 1em">I was going to include them in the original post as I said, but .Text did not like them. Here they are, just so you have them.<br><br>ཀ་ཅོག་ཞང་གསུམ།<br>ཀ་གཅིག་སྒོ་གཅིག་མ།<br>ཀ་གཅིག་ལྕམ་གང་མ།<br>ཀ་གཅིག་མ།<br>ཀ་ཆ།<br>ཀ་ཆུག།<br>ཀ་ཆེན་བཞི།<br>ཀ་འཇའ་ལ།<br>ཀ་གཉིས་པ།<br><br>:-)</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2013/11/18 <a href="http://archives.miloush.net/michkap/archive/2013/11/18/10468478.html">The price, and more importantly the *cost*, of Social Media can be distracting...</a></p><p>2011/12/12 <a href="http://archives.miloush.net/michkap/archive/2011/12/12/10246749.html">SharePoint and CJK Extensions A, B, C, D, and even E?</a></p><p>2010/11/01 <a href="http://archives.miloush.net/michkap/archive/2010/11/01/10083846.html">The consequences of being unintuitive and nonconformant</a></p><p>2010/06/11 <a href="http://archives.miloush.net/michkap/archive/2010/06/11/10022741.html">Call it Reversible Error, aka Yes it has no weight; it was supposed to have no weight!</a></p><p>2009/02/04 <a href="http://archives.miloush.net/michkap/archive/2009/02/04/9394864.html">The road to hell is paved with attempts at being compatible</a></p><p>2008/04/09 <a href="http://archives.miloush.net/michkap/archive/2008/04/09/8367652.html">Fight the Future? (#11 of ??), aka Microsoft is giving this character nada weight but lotsa importance</a></p><p>2008/03/16 <a href="http://archives.miloush.net/michkap/archive/2008/03/16/8238240.html">On changing the world, or at least the way people order things in it</a></p><p>2007/12/07 <a href="http://archives.miloush.net/michkap/archive/2007/12/07/6671623.html">If it isn't really Tibetan, could it pinch hit for Burmese?</a></p><p>2007/10/08 <a href="http://archives.miloush.net/michkap/archive/2007/10/08/5320425.html">The roadꂸ to the solution starts with identifying the actual problem.NET</a></p><p>2007/09/24 <a href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html">A&P of Sort Keys, part 11 (aka It's not like ideographic sorts were developed idiopathically)</a></p><p>2007/09/14 <a href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html">A&P of Sort Keys, part 4 (aka It isn't a race but let's make an EXCEPTION and cross the Finnish line)</a></p><p>2007/08/28 <a href="http://archives.miloush.net/michkap/archive/2007/08/28/4605786.html">Every character has a story #29: U+1000^H^H^H^H0f40, (TIBETAN or MYANMAR LETTER KA, depending on when you ask)</a></p><p>2007/06/07 <a href="http://archives.miloush.net/michkap/archive/2007/06/07/3146122.html">Putting the camel's nose in Building 24</a></p><p>2007/06/02 <a href="http://archives.miloush.net/michkap/archive/2007/06/02/3050031.html">Objection, managed code! That zero is leading!</a></p><p>2007/05/12 <a href="http://archives.miloush.net/michkap/archive/2007/05/12/2562871.html">The exception that proves the rule that was the exception that proves another rule (aka On the variability of the Invariant)</a></p><p>2007/04/30 <a href="http://archives.miloush.net/michkap/archive/2007/04/30/2335249.html">Giving Yi the weight it deserves</a></p><p>2007/04/19 <a href="http://archives.miloush.net/michkap/archive/2007/04/19/2194275.html">Search and ye shall find, SIAO style!</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2137215.html">Rhymes with Amharic #4 (a.k.a. we're all [sub]set so turning out the lights and going to [em]bed!)</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html">Rhymes with Amharic (a.k.a. How about a little breakfast embed, dear?)</a></p><p>2007/03/04 <a href="http://archives.miloush.net/michkap/archive/2007/03/04/1806219.html">String Indexing?</a></p><p>2007/02/18 <a href="http://archives.miloush.net/michkap/archive/2007/02/18/1709479.html">He had the strength of an OX[IA], I tell you</a></p><p>2007/02/04 <a href="http://archives.miloush.net/michkap/archive/2007/02/04/1600427.html">So how does that Naqittaut keyboard work, exactly?</a></p><p>2007/02/03 <a href="http://archives.miloush.net/michkap/archive/2007/02/03/1592814.html">lo lo lo lo lo-LA</a></p><p>2006/12/27 <a href="http://archives.miloush.net/michkap/archive/2006/12/27/1366186.html">If you decompose those city elders, you might be able to sort them out!</a></p><p>2006/12/26 <a href="http://archives.miloush.net/michkap/archive/2006/12/26/1365492.html">The city elders won't give this string weight, either (aka On being consistently dead wrong, aka Ordinal or bust?)</a></p><p>2006/11/19 <a href="http://archives.miloush.net/michkap/archive/2006/11/19/1104093.html">Even the characters with no weight can be given weight in their own special way</a></p><p>2006/09/25 <a href="http://archives.miloush.net/michkap/archive/2006/09/25/768715.html">Why don't all the half forms sort right?</a></p><p>2006/09/06 <a href="http://archives.miloush.net/michkap/archive/2006/09/06/742073.html">IsSortable() == false? Well, sometimes it may be lying....</a></p><p>2006/08/15 <a href="http://archives.miloush.net/michkap/archive/2006/08/15/700676.html">Did software developers ever learn their ABC's?</a></p><p>2006/05/24 <a href="http://archives.miloush.net/michkap/archive/2006/05/24/605599.html">Invariant vs. Ordinal, the third</a></p><p>2006/03/25 <a href="http://archives.miloush.net/michkap/archive/2006/03/25/560416.html">I need my SPACE, symbolically speaking</a></p><p>2006/03/09 <a href="http://archives.miloush.net/michkap/archive/2006/03/09/546882.html">Don't forget to test the demos</a></p><p>2006/01/18 <a href="http://archives.miloush.net/michkap/archive/2006/01/18/514314.html">What do U+0223 and U+0657 have in common?</a></p><p>2005/11/03 <a href="http://archives.miloush.net/michkap/archive/2005/11/03/484974.html">My own personal thoughts about collation in the Mono project</a></p><p>2005/09/14 <a href="http://archives.miloush.net/michkap/archive/2005/09/14/464780.html">Extending collation support in SQL Server and Jet, Part 1 (the broad strokes)</a></p><p>2005/08/07 <a href="http://archives.miloush.net/michkap/archive/2005/08/07/448924.html">New in Vista Beta 1: giving more strings weight</a></p><p>2005/07/20 <a href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html">More on sort elements</a></p><p>2005/06/28 <a href="http://archives.miloush.net/michkap/archive/2005/06/28/433365.html">The 'grammar' of identifiers</a></p><p>2005/05/05 <a href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html">A few of the gotchas of CompareString</a></p><p>2005/04/26 <a href="http://archives.miloush.net/michkap/archive/2005/04/26/412079.html">Intelligent unmanaged string comparison</a></p><p>2005/04/03 <a href="http://archives.miloush.net/michkap/archive/2005/04/03/405071.html">TechEd Bloggers does not work for this site?</a></p><p>2005/02/03 <a href="http://archives.miloush.net/michkap/archive/2005/02/03/366145.html">What makes a string meaningful?</a></p><p>2005/02/01 <a href="http://archives.miloush.net/michkap/archive/2005/02/01/364376.html">Why that is positively Ethiopic!</a></p><p>2005/01/19 <a href="http://archives.miloush.net/michkap/archive/2005/01/19/356280.html">Not all characters are created equal: take SYMBOLS, for example</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/19/355870.html" title="He&#39;s dead [keys], Jim.">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/17/354279.html" title="Keeping it simple, with complex scripts">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/18/355210.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>