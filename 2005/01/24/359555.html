<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/24/359555.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Challenges behind MSLU: the loader! (Part 1)</title></head><body>
<h1>Challenges behind MSLU: the loader! (Part 1)</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/24 10:34 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/01/24/359555.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P dir=ltr><EM>(This post is based on one that was sent to the microsoft.public.platformsdk.mslayerforunicode newsgroup back in June of 2001)</EM></P>
<P dir=ltr>It all started simply enough: the Windows division decided to fund a project for a Unicode Layer for Win9x to help people be able to fully use the NT functionality that had been around all the time and was getting better each version. Obviously, anything that was going to slow down applications on WinNT/Win2K/WinXP was unacceptable. So there had to be a way to make sure this layer (MSLU) did not slow down a Unicode application running on the NT platform.</P>
<P dir=ltr>We started with the DELAYLOAD technology, introduced in Visual C++ 6.0. The purpose of delay loading is (according to MSDN):</P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><EM>"The Visual C++ linker now supports the delayed loading of DLLs. This relieves you of the need to use the Win32 SDK functions LoadLibrary and GetProcAddress to implement DLL delayed loading."</EM></P></BLOCKQUOTE>
<P dir=ltr>All well and good, right? Well, they quickly found another side effect: if you were never going to call a function at all, then you could delay the loading of the DLL till hell froze over!</P>
<P dir=ltr>And then quickly found yet another cool side effect: if you used their capability to override the loading via a hook function, you could redirect the effort and be sure on the NT platform to call the original API instead of the delayloaded entry point in your other DLL. Cool, right?</P>
<P dir=ltr>Well, we thought so. :-)</P>
<P dir=ltr>Of course, we quickly ran into problems with this approach. Developers might want to use the delayload stuff themselves, for their own DLLs. They might even have custom hooks already! It would not be too friendly to take over a technology and make people choose which functionality they preferred: delay loading or Unicode on Win9x.</P>
<P dir=ltr>Luckily, Microsoft has a lot of smart people in it. After working with one of the long-time devs on the Windows team (Bryan Tuttle) and on the linker team over in VC++ (the "father of the Microsoft linker" and original developer of delay load, Dan Spalding), we had a new solution: the <A title=MSLU href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target=_blank>MSLU</A> loader!</P>
<P dir=ltr><EM>(and for the record, all of the&nbsp;credit goes to Bryan and Dan; everything cool I did with the solution was due to the fact that they provided the solution in the first place!)</EM></P>
<P dir=ltr>Now delay load works by dynamically creating the stubs at compile time that are needed for the program, but we did not need to duplicate *that* functionality since the APIs being wrapped are a static list -- no need for dynamic work here. So the MSLU loader is basically contained in the .LIB file and contains all of the information for every single function that is wrapped or stubbed. That is the reason why a DLL that is less than 200K ended up with a .LIB file that is over 2mb -- because it contains a lot of information (it also contains all of the failure stubs so that if for some reason the API cannot be called due to low memory, etc., the failure case would be handled gracefully).</P>
<P dir=ltr>Of course, the size might freak people out: who wants to add 2mb to their binary's size? Don't worry, thats not a problem, either. Remember that most APIs are pretty much identical as far as the linker is concerned, even in failure stubs: functions that take three parameters and return FALSE look the same whether its AddMonitorW, EnumDateFormatsW, or SetLocaleInfoW. What this means is that your debug build (no optimizations) will be a little bit bigger since you are going to have a lot of data that is identical for separate APIs, but if you do any kind of optimization (either for size or for speed) then all of these identical bits of code will be merged such that even large, complex applications only add a little bit of size.</P>
<P dir=ltr>More MSLU loader trivia -- neither 'dumpbin /imports' nor <A href="http://www.stevemiller.net/">Steve Miller</A>'s <A href="http://www.dependencywalker.com/">Dependency Walker</A> can detect the loader, so you have to look for it indirectly. How's that? Well, it is fairly easy to see if every single Unicode API that takes string parameters suddenly disappears from Dependency Walker's tree. You can even use such a technique to look into incorrect unicows.lib integration -- if those imports <STRONG>are</STRONG> on the list then it means you have your .LIB files out of order.</P>
<P dir=ltr>Does it all sound hideously complex? Well, a lot of work got done in the design so that all of the actual complexity is hidden, and all you have to do is link to the .LIB file, which gives you the MSLU loader free and clear (literally free, since it comes with the downloadable Platform SDK!). It made for a very interesting bit of technology (a custom delay loader) hidden away inside another interesting bit of technology (a Unicode layer for Win9x). </P>
<P dir=ltr>All of it would have been impossible without some of the really smart people in VC++ and Windows. :-)</P>
<hr/><p><a id="359577" href="#359577">#</a> <strong>Serge Wautier</strong> on 24 Jan 2005 9:07 AM:</p><div style="margin-left: 1em">June 91 ? Is the <a title="MSLU" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target="_blank">MSLU</a> Y2K compliant ? :-)</div>
<p><a id="359587" href="#359587">#</a> <strong>Michael Kaplan</strong> on 24 Jan 2005 9:14 AM:</p><div style="margin-left: 1em">Oops! Fixed that typo....</div>
<p><a id="360194" href="#360194">#</a> <strong>Tim Smith</strong> on 25 Jan 2005 7:00 AM:</p><div style="margin-left: 1em">*waves*<br><br>Ah, the memories of <a title="MSLU" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target="_blank">MSLU</a>.  I loved that software since it made moving to Unicode so easy.  (Yeah, I know we probably had a bunch of Unicode related bugs in our software.)<br><br>I am the Tim Smith who supplied you with the WTL/DefWindowProc fix and a few other bugs.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/03/16 <a href="http://archives.miloush.net/michkap/archive/2007/03/16/1895610.html">A way better model for features</a></p><p>2005/10/04 <a href="http://archives.miloush.net/michkap/archive/2005/10/04/476764.html">When MSLU functions fail...</a></p><p>2005/05/11 <a href="http://archives.miloush.net/michkap/archive/2005/05/11/416624.html">Why UnicoWS.dll forwards to the OS on Unicode platforms</a></p><p>2005/05/05 <a href="http://archives.miloush.net/michkap/archive/2005/05/05/414985.html">How can I use MSLU without shipping UnicoWS.dll?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/25/360240.html" title="CAPSLOCK only sometimes equals ShiftLock">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/24/359347.html" title="In Tamil -- sometimes, they are digits; other times, just numbers">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/24/359555.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>