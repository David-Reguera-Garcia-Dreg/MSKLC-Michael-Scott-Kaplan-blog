<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/30/363420.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>We broke CharNext/CharPrev (or, bugs found through blogging?)</title></head><body>
<h1>We broke CharNext/CharPrev (or, bugs found through blogging?)</h1>
<p><em>by Michael S. Kaplan, published on 2005/01/30 13:42 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/01/30/363420.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>(special thanks to <a href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html#363364">James</A> for pointing out this&nbsp;bug)</P>
<P>It is amazing how sometimes one can be so busy trying to make a point that one can miss the point.</P>
<P>A few days ago, I pointed out that <A id=ArchiveMonth href="http://archives.miloush.net/michkap/archive/2005/01/14/352802.html">CharNext(ch) != ch+1, a lot of the time</A>.</P>
<P>That ought to be true. It <STRONG>is</STRONG> true if you are running Windows NT 3.51, Windows NT 4.0, or Windows 2000.</P>
<P>But in XP, things seem to have changed a bit.</P>
<P>It used to be that if one took combining characters like <A href="http://www.fileformat.info/info/unicode/char/0308/index.htm">U+0308</A> (COMBINING DIAERESIS) and passed them to the <A title=GetStringTypeW href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/getstringtypew.asp" target=_blank>GetStringTypeW</A> or <A title=GetStringTypeEx href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/getstringtypeex.asp" target=_blank>GetStringTypeEx</A> APIs with the CT_CTYPE3 dwInfoType, it would return (C3_NONSPACING | C3_DIACRITIC). If you look at the Platform SDK topics for these APIs, the types are defined as follows:</P>
<BLOCKQUOTE dir=ltr>
<P><STRONG>Name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Value&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Meaning </STRONG><BR>C3_NONSPACING&nbsp;&nbsp;&nbsp;&nbsp;0x0001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Nonspacing mark.&nbsp; <BR>C3_DIACRITIC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0002&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Diacritic nonspacing mark.&nbsp; </P></BLOCKQUOTE>
<P>Starting with Windows XP and continuing on with Windows Server 2003, it now just returns C3_DIACRITIC. Looking at the definitions, this makes sense -- C3_DIACRITIC claims it is for nonspacing marks, too. So the relevant part of the change is:</P>
<OL>
<LI>There used to be no characters marked with just C3_DIACRITIC. 
<LI>There are no characters that are marked with just C3_NONSPACING now (there used to be several).</LI></OL>
<P>This would all be fine given the above definitions (well, not really -- but we'll let that lie for a bit). The problem is that the <A title=CharNext href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charnext.asp" target=_blank>CharNext</A> and <A title=CharPrev href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/charprev.asp" target=_blank>CharPrev</A> APIs are relying on that C3_NONSPACING definition to figure out when to skip characters.</P>
<P>I'm not sure what scares me more -- that this bug has been around since October of 2000, or that it was found due to a blog post that I might not have thought to do had not <a href="http://blogs.msdn.com/OldNewThing">someone</A> suggested it to me.</P>
<P>I'll see about making sure this bug gets put in on Monday.</P>
<P>So, between this one and the one I found myself (described in the answer to Guess #3 in <A id=_e354926d062d3156_HomePageDays_DaysList__ctl0_DayItem_DayList__ctl0_TitleUrl href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html">Why I don't like the IsTextUnicode API</A>), two longstanding bugs in Windows have been found through the act of blogging. </P>
<P>This answers the question I posted in <A id=viewpost href="http://archives.miloush.net/michkap/archive/2004/12/27/333134.html">OT -- They taste like chicken, don't they?</A>&nbsp;once and for all. Blogging <STRONG>may</STRONG> annoy me, but its not really relevant anymore. They help me make the product better. So I think I'd better keep doing it....</P>
<P>Scoble, you reading this? :-)</P>
<P>&nbsp;</P>
<P><EM><FONT color=#800080>This post sponsored by all&nbsp;792 of the&nbsp;</FONT></EM><A href="http://www.fileformat.info/info/unicode/category/Mn/index.htm"><EM><FONT color=#800080><STRONG>nonspacing marks</STRONG></FONT></EM></A><EM><FONT color=#800080> in Unicode</FONT></EM></P>
<hr/><p><a id="363425" href="#363425">#</a> <strong>James</strong> on 30 Jan 2005 12:21 PM:</p><div style="margin-left: 1em">Thanks for investigating and sorry it took time from your weekend. I'm also glad you're going to keep blogging - it's a great read!</div>
<p><a id="363427" href="#363427">#</a> <strong>Michael Kaplan</strong> on 30 Jan 2005 12:32 PM:</p><div style="margin-left: 1em">No apology needed -- it is a great find, and you were an important step to finding it. Feel free to read and question any time!</div>
<p><a id="363519" href="#363519">#</a> <strong>Ken Smith</strong> on 30 Jan 2005 6:39 PM:</p><div style="margin-left: 1em">Any chance if a fix for downlevel platforms? :-)</div>
<p><a id="363523" href="#363523">#</a> <strong>Michael Kaplan</strong> on 30 Jan 2005 7:10 PM:</p><div style="margin-left: 1em">Ken -- I honestly don't know, but I'll probably ask.</div>
<p><a id="363528" href="#363528">#</a> <strong>BillG would call me Communist</strong> on 30 Jan 2005 7:49 PM:</p><div style="margin-left: 1em">Yes, how wonderful is open collaboration, it's rather incredible how much better it makes a development process! How much more wonderful still would be freedom of code! &lt;br&gt;&lt;br&gt;Of course, this is why Free Software will inevitably triumph - possibly not organically, but rather by converting unbelievers like yourself, however grudgingly. Here you show yourself taking the first baby steps, and if it were not for your salary clouding your judgements your steps would be quicker and heartier still.&lt;br&gt;&lt;br&gt;Guess what - Free Software is generally far more localis/zed and internationalis/zed and even globalis/zed than your own patheticly Anglocentric offerings. This is as a direct result of the freedom - because of the sense of ownership and community and collaboration that can only come from the trust encircled with code.&lt;br&gt;&lt;br&gt;You are obviously an exceptionally talented man leading an exceptionally talented men and women, probably the best internationalis/zation individuals in the world. It must hurt terribly to be outflanked despite this. Perhaps you should reflect on the reasons why, and start embracing and engaging all those who care at a deeper level.&lt;br&gt;&lt;br&gt;Finally, some humo/ur related to internationalis/zation:&lt;br&gt;Russia Donates Cyrillic Characters To Alleviate Acronym Shortage&lt;br&gt;&lt;a target=&quot;_new&quot; href=&quot;<a rel="nofollow" target="_new" href="http://humorix.org/articles/2005/01/acronym-crisis/">http://humorix.org/articles/2005/01/acronym-crisis/</a>">http://humorix.org/articles/2005/01/acronym-crisis/&quot;&gt;http://humorix.org/articles/2005/01/acronym-crisis/&lt;/a&gt;</a></div>
<p><a id="9229148" href="#9229148">#</a> <strong>Sam</strong> on 16 Dec 2008 6:41 PM:</p><div style="margin-left: 1em"><p>So why does &#252; (U+00FC) return C3_NONSPACING? &nbsp;What does this flag mean if non-spacing characters (U+0308) don't have it, and characters which flow as normal do?</p></div>
<p><a id="9230195" href="#9230195">#</a> <strong>Michael S. Kaplan</strong> on 16 Dec 2008 11:08 PM:</p><div style="margin-left: 1em"><p>Actually, in Vista it returns C3_ALPHA | C3_DIACRITIC | C3_NONSPACING since it is a letter with a diacritic included in it....</p>
<p>U+0308 has C3_DIACRITIC | C3_NONSPACING there.</p>
<p>What full results are you seeing, and on what platform?</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/06/10 <a href="http://archives.miloush.net/michkap/archive/2009/06/10/9723321.html">UCS-2 to UTF-16, Part 10: Variation[ Selector] on a theme...</a></p><p>2008/12/16 <a href="http://archives.miloush.net/michkap/archive/2008/12/16/9223301.html">UCS-2 to UTF-16, Part 9: The torrents of breaking CharNext/CharPrev</a></p><p>2006/11/10 <a href="http://archives.miloush.net/michkap/archive/2006/11/10/1053925.html">Some people feel really insecure about the size of their [string] members</a></p><p>2006/07/17 <a href="http://archives.miloush.net/michkap/archive/2006/07/17/668787.html">'A' and 'W' are sometimes living in two different worlds</a></p><p>2006/06/22 <a href="http://archives.miloush.net/michkap/archive/2006/06/22/643461.html">Things I [don't] like about blogging</a></p><p>2005/09/13 <a href="http://archives.miloush.net/michkap/archive/2005/09/13/465228.html">Here is an interview question for you. :-)</a></p><p>2005/04/29 <a href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">Where did the new StringInfo stuff come from?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/01/31/363007.html" title="Suggest a Topic! (February 2005)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html" title="Why I don&#39;t like the IsTextUnicode API">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-01-30">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/01/30/363420.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>