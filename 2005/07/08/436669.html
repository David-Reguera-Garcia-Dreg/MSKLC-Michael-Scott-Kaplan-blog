<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/07/08/436669.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Real developers use CompareInfo's Compare (Part 1)</title></head><body>
<h1>Real developers use CompareInfo's Compare (Part 1)</h1>
<p><em>by Michael S. Kaplan, published on 2005/07/08 03:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/07/08/436669.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>In the not too distant past, I pointed out that <a href="http://archives.miloush.net/michkap/archive/2005/06/09/427293.html"><STRONG>String.Compare is for sissies (not for people who want SQLCLR consistency)</STRONG></A>. Well, today I am going to start to wrap that functionality I described, so that it can be used without a ton of work being done. Because real developers <STRIKE><FONT color=#a9a9a9>don't eat quiche</FONT></STRIKE>use CompareInfo's Compare. :-)</FONT></P>
<P><FONT face=Tahoma>I will likely take my time with this and talk about other related topics. Never fear, when I am done&nbsp;I will put all of the code together in one place....</FONT></P>
<P><FONT face=Tahoma>Part 1 of our saga has us getting the flag values right. I will add function for both directions. Since my eventual intent will be to call the NLS API funtions (which define the flags as <STRONG>DWORD</STRONG>) I will use&nbsp;<STRONG>System.Uint32</STRONG> and mark them private (the right balance between CLS compliancy and header file accuracy, in my opinion!). They are internal functions, anyway. :-)</FONT></P>
<P><FONT face=Tahoma>As a side note, I once tried to find out why the the values were changed, and no one could really remember. I guess I could start an <STRONG>Every Constant Has a Story</STRONG> category of posts, but I honestly don't think I know enough to sustain a series. I'll bet <a href="http://blogs.msdn.com/OldNewThing">Raymond Chen</A> or <a href="http://blogs.msdn.com/LarryOsterman/">Larry Osterman</A> could do a number of these, though!</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG><BR>using System.Globalization;</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>private const System.UInt32 NORM_IGNORECASE&nbsp;=&nbsp;0x00000001;&nbsp;<FONT color=#008000>// ignore case</FONT><BR>private const System.UInt32 NORM_IGNORENONSPACE&nbsp;=&nbsp;0x00000002;&nbsp;<FONT color=#008000>// ignore nonspacing chars</FONT><BR>private const System.UInt32 NORM_IGNORESYMBOLS&nbsp;=&nbsp;0x00000004;&nbsp;<FONT color=#008000>// ignore symbols</FONT><BR>private const System.UInt32 NORM_IGNOREKANATYPE&nbsp;=&nbsp;0x00010000;&nbsp;<FONT color=#008000>// ignore kanatype</FONT><BR>private const System.UInt32 NORM_IGNOREWIDTH&nbsp;=&nbsp;0x00020000;&nbsp;<FONT color=#008000>// ignore width</FONT><BR><FONT color=#008000>//private const System.UInt32 SORT_STRINGSORT&nbsp;=&nbsp;0x00001000;&nbsp;// use string sort method</FONT></STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>private System.UInt32 NativeCompareFlagsFromManagedCompareOptions(CompareOptions options) {<BR>&nbsp;&nbsp;&nbsp; System.UInt32 flags = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; if ((options &amp; CompareOptions.IgnoreCase)&nbsp;!= 0) { flags |= NORM_IGNORECASE;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((options &amp; CompareOptions.IgnoreNonSpace) != 0) { flags |= NORM_IGNORENONSPACE;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((options &amp; CompareOptions.IgnoreSymbols) != 0) { flags |= NORM_IGNORESYMBOLS;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((options &amp; CompareOptions.IgnoreKanaType)&nbsp;!= 0) { flags |= NORM_IGNOREKANATYPE;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((options &amp; CompareOptions.IgnoreWidth) != 0) { flags |= NORM_IGNOREWIDTH;&nbsp;}<BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; //if ((options &amp; CompareOptions.StringSort) != 0) { flags |= SORT_STRINGSORT; }</FONT></STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp; return flags;<BR>}</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>private CompareOptions ManagedCompareOptionsFromNativeCompareFlags(System.UInt32 flags) {<BR>&nbsp;&nbsp;&nbsp; CompareOptions options = CompareOptions.None;<BR><BR><FONT color=#008000>&nbsp;&nbsp;&nbsp; /*<BR>&nbsp;&nbsp;&nbsp; if((options &amp; (CompareOptions.Ordinal | CompareOptions.OrdinalIgnoreCase)) != 0) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; throw new&nbsp;ArgumentOutOfRangeException("options");<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; */<BR></FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp; if ((flags &amp; NORM_IGNORECASE)&nbsp;!= 0) { options |= CompareOptions.IgnoreCase;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((flags &amp; NORM_IGNORENONSPACE)&nbsp;!= 0) { options |= CompareOptions.IgnoreNonSpace;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((flags &amp; NORM_IGNORESYMBOLS)&nbsp;!= 0) { options |= CompareOptions.IgnoreSymbols;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((flags &amp; NORM_IGNOREKANATYPE)&nbsp;!= 0) { options |= CompareOptions.IgnoreKanaType;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; if ((flags &amp; NORM_IGNOREWIDTH)&nbsp;!= 0) { options |= CompareOptions.IgnoreWidth;&nbsp;}<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008000>//if ((flags &amp; SORT_STRINGSORT)&nbsp;!= 0) { options |= CompareOptions.StringSort;&nbsp;}</FONT></STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>&nbsp;&nbsp;&nbsp; return options;<BR>}<BR></STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>I thought about possibly making NativeCompareFlagsFromManagedCompareOptions throw if CompareOptions.Ordinal or CompareOptions.OrdinalIgnoreCase were passed but for now decided not to bother, and commented that check out. Also, SQL Server never seems to pass SORT_STRINGSORT in its ComparisonStyle data, so that code is commented out, too.</FONT></P>
<P><FONT face=Tahoma>Now about 100 years ago I wrote an article for Smart Access that did a reverse engineering job on mswstr10.dll and sqlsort.dll, the Jet and SQL Server DLLs that gave the ability for these database products to do comparisons independent of the operating system. However:</FONT></P>
<UL>
<LI><FONT face=Tahoma>I wasn't really able to find a copy of the article since I am in Amsterdam right now;</FONT> 
<LI><FONT face=Tahoma>I wanted to point people at the OS functions anyway;</FONT><FONT face=Tahoma> 
<LI><FONT face=Tahoma>sqlsort.dll is not a part of Yukon (it is an internal engine function -- the hazard of playing with undocumented function calls!);</FONT> 
<LI><FONT face=Tahoma>further to the previous point, mswstr10.dll does not have the new SQL Server collations in it;</FONT> 
<LI>further to the previous two points, the whole reason for the wrapper is to act like SQL Server, not Jet, anyway.</FONT></LI></UL>
<P><FONT face=Tahoma>So I decided not to bother with the Jet/SQL Server functions. Like I said, they are horribly out of date, so we are better off with the OS functions here.</FONT></P>
<P><FONT face=Tahoma>I'll post some more tomorrow, as we slowly build up the code for our wrapper objects that gives SQL Server comparison semantics....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff0000><EM>This post brought to you by</EM> "<FONT face="Arial Unicode MS" size=3>Æ©</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/01a9/index.htm">U+01a9</A>, a.k.a. LATIN CAPITAL LETTER ESH)<BR><FONT size=1>A letter that is sometimes confused with its Greek cousin, U+03a3 (GREEK CAPITAL LETTER SIGMA), though I cannot imagine&nbsp;why. :-)</FONT></EM></FONT></P>
<hr/><p><a id="436921" href="#436921">#</a> <strong>A. Skrobov</strong> on 8 Jul 2005 3:08 PM:</p><div style="margin-left: 1em">LATIN CAPITAL LETTER ESH is not U+0a19, it's in fact U+01a9... Also why have you stopped linking the red characters to <a rel="nofollow" target="_new" href="http://www.fileformat.info/info/unicode/char/">http://www.fileformat.info/info/unicode/char/</a> ?</div>
<p><a id="436931" href="#436931">#</a> <strong>Dmitriy Zaslavskiy</strong> on 8 Jul 2005 3:22 PM:</p><div style="margin-left: 1em">In .NET &lt;v2 CompareInfo seems to be the only way to call IndexOf and get Ordinal behaviour</div>
<p><a id="436983" href="#436983">#</a> <strong>Michael S. Kaplan</strong> on 8 Jul 2005 6:30 PM:</p><div style="margin-left: 1em">A. Skrobov  - good catch, as little dyslexic typing on my part. Link also added now...<br><br>Dmitriy -- actually, there are string methods with both ordinal and ordinalignorecase (the latter was mostly added post beta 2, the former hasbeen in for a while now).</div>
<p><a id="437432" href="#437432">#</a> <strong>Richard Mitchell</strong> on 11 Jul 2005 3:51 AM:</p><div style="margin-left: 1em">I've already written some code to change the SQL Server flags to CompareOptions, is there any need to set all of the flags manually as only two actually change location...<br><br>// IgnoreWidth<br>if ((compareOptions &amp; 0x00020000) != 0)<br>  compareOptions ^= 0x00020010;<br><br>// IgnoreKana<br>if ((compareOptions &amp; 0x00010000) != 0)<br>  compareOptions ^= 0x00010008;<br><br>// StringSort (for completeness)<br>if ((compareOptions &amp; 0x00001000) != 0)<br>  compareOptions ^= 0x20001000;<br><br>this.m_compareOptions = (CompareOptions)compareOptions;<br><br>Plus it gave me an excuse to use ^= in anger.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2005/11/29 <a href="http://archives.miloush.net/michkap/archive/2005/11/29/497852.html">SQL Server's cultural sensitivities</a></p><p>2005/09/18 <a href="http://archives.miloush.net/michkap/archive/2005/09/18/470869.html">Extending collation support in SQL Server and Jet, Part 2 (generating sort keys)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/07/08/436701.html" title="Was it or weren&#39;t it? It&#39;s No Myth, either way">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/07/07/436715.html" title="Bottles sometimes talk, they never say the right things though">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-07-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/07/08/436669.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>