<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/07/26/443375.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>All code page architectures are created equal</title></head><body>
<h1>All code page architectures are created equal</h1>
<p><em>by Michael S. Kaplan, published on 2005/07/26 09:30 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/07/26/443375.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Yes, I said it -- all code page architectures are created equal. But in the most Orwellian sense, some are more equal than others....</FONT></P>
<P><FONT face=Tahoma>First I will digress into a favorite Odgen Nash poem of mine, which is very short. I pretty much memorized it:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>Let's talk about eggs:<BR></FONT><FONT face=Tahoma>Eggs have no legs.<BR>Let's talk about chikens:<BR>Chickens <EM>do</EM> have legs.<BR>The plot thickens -- <BR>eggs come from chickens!<BR>But they have no legs under 'em<BR>What a conundrum!</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Why this poem popped into my head may become apparent shortly. If not then it is still a nice poem (Ogden Nash at his finest!).</FONT></P>
<P><FONT face=Tahoma>Anyway....</FONT></P>
<P><FONT face=Tahoma>If you look at the official, sanctioned encoding architectures owned by the GIFT team, there are three of them:</FONT></P>
<UL>
<LI><FONT face=Tahoma>The Win32 NLS API model, used by the unmanaged universe and which sports a very C-focused model;</FONT> 
<LI><FONT face=Tahoma>The MLang model, used by Internet Explorer and which sports a COM-based model;</FONT> 
<LI><FONT face=Tahoma>The .NET Framework model, used by the managed universe and which sports a managed code model.</FONT></LI></UL>
<P><FONT face=Tahoma><EM>(there is a fourth model for Kernel mode and the Rtl* functions that can be used in both kernel and user mode, but I will cover that another day -- for my purposes here just consider it for now like Win32 but more limited!)</EM></FONT></P>
<P><FONT face=Tahoma>If these were three entirely separate models, it all might be easier. However:</FONT></P>
<UL>
<LI><FONT face=Tahoma>for MLang, many code pages call the Win32 code, occasionally in edge cases returning HRESULTS that in many cases exceptions to be thrown</FONT> 
<LI><FONT face=Tahoma>There are several code pages which have bugs in edge cases in Win32 that were fixed in MLang</FONT> 
<LI><FONT face=Tahoma>The 1.0 and 1.1 versions of the .NET Framework code are thin wrappers around the Win32 code (maybe sometimes using MLang to try and work around bugs)</FONT> 
<LI><FONT face=Tahoma>The 2.0 managed code started over and tried to fix many of the problems in the two other models (along the way becoming smaller and dare I say a bit faster!), yet in many ways based on the original work</FONT></LI></UL>
<P><FONT face=Tahoma>Talk about conundrums -- these three models are so interrelated even though there are so many times that their behavior differs that I doubt anyone will ever be able to sort out the behavioral differences.</FONT></P>
<P><FONT face=Tahoma>It represents complex pieces of code in three code bases written across nine versions of Windows, three versions of IE, and three version of the BCL, using unmanged, managed, and COM based code. It is very hard to figure out what is a bug to fix, what is a bug we are stuck with for backcompat reaons, what is an intentional feature that only looks like a bug because the behavior was not documented well enough. You can get a headache trying to figure it out sometimes (and many have!).</FONT></P>
<P><FONT face=Tahoma>So what does it all mean?</FONT></P>
<P><FONT face=Tahoma>Well, as Shawn Steele, the owner of the bulk of this complex set of code bases likes to say, people ought to just be using Unicode. And Shawn is spot on here -- the more complex the code page work you do, the more likely you are to run into problems with the use.</FONT></P>
<P><FONT face=Tahoma>Now I do not include UTF-8 (or even UTF-32 in the .NET Framework) with the rest of those code pages, since it is a Unicode encoding form and all, but just about everything else ought to be a "use if you have to convert something, but then once it is converted stop using!" model.</FONT></P>
<P><FONT face=Tahoma>Bue please just try to use Unicode, like the opersting system and the .NET Framework prefer, and were basically designed for....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff0000><EM>This post brought to you by</EM> "<FONT size=5>à³¡</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0ce1/index.htm">U+0ce1</A>, a.k.a. KANNADA LETTER VOCALIC LL)</EM></FONT></P>
<hr/><p><a id="443410" href="#443410">#</a> <strong>Paul Ballard</strong> on 26 Jul 2005 11:06 AM:</p><div style="margin-left: 1em">My personal favorite Ogden Nash Poem is...<br><br>A cow is of a bovine ilk,<br>One end is moo and the other is milk<br><br>You just can't get finer literature than Ogden Nash! :-)</div>
<p><a id="443513" href="#443513">#</a> <strong>Ivo</strong> on 26 Jul 2005 2:53 PM:</p><div style="margin-left: 1em">There is another one - the CRT functions. Are they wrappers on top of Win32 or Win32 on top of CRT?<br>I was doing some testing with the CRT on XP set to Japanese. GetACP() returns 932 (as expected). But I found that setlocale(LC_CTYPE,&quot;&quot;) or setlocale(LC_CTYPE,&quot;.ACP&quot;) have no effect on the CRT functions. setlocale(LC_CTYPE,&quot;.932&quot;) works fine. According to the help they should produce the same result...<br><br>In another test I found that GetCPInfo recognizes codepages 20949 and 28063, but GetCPInfoEx doesn't. Is that a bug to fix, bug for compatibility reasons, or an intentional feature? :))</div>
<p><a id="443517" href="#443517">#</a> <strong>Michael S. Kaplan</strong> on 26 Jul 2005 3:13 PM:</p><div style="margin-left: 1em">The CRT functions are basically Win32 wrappers. I do not include them since they really add no new functionality (but they do add a little model confusion, as you noted!).<br><br>That code page being recognized issue looks like a bug to fix if you ask me.<br><br>Are there any GIFT testers reading this? :-)</div>
<p><a id="443668" href="#443668">#</a> <strong>HASEGAWA Yosuke</strong> on 26 Jul 2005 10:04 PM:</p><div style="margin-left: 1em">Hi.<br>wiconv program &lt;<a rel="nofollow" target="_new" href="http://openmya.hacker.jp/hasegawa/wiconv/wiconv-0.2.lzh>">http://openmya.hacker.jp/hasegawa/wiconv/wiconv-0.2.lzh&gt;</a> I wrote is the very tiny program Win32 based for convert codepage of strings.<br>This program supports two conversion method - Win32 NLS and MLang.<br><br>And I've noticed when writing this program, EUC-JP (most popular encoding for Japanized UNIX) is<br>defined as Codepage 51932, MLang functions supports CP51932 but Win32 NLS functions not support CP51932. So we use undocumented CP20932 instead CP51932 for Win32 NLS.<br><br>So some programs using Win32 NLS can't handle EUC-JP encoding correctly.<br><br>Sorry for buggy English.<br></div>
<p><a id="443748" href="#443748">#</a> <strong>Michael S. Kaplan</strong> on 27 Jul 2005 2:35 AM:</p><div style="margin-left: 1em">No worries, I think your English is fine. :-)<br><br>Yep, there are all kinds of weirdnesses in the &quot;DLL-based&quot; range (the 5xxxx range)....</div>
<p><a id="448092" href="#448092">#</a> <strong>Michel Lemay</strong> on 5 Aug 2005 10:45 AM:</p><div style="margin-left: 1em">Indeed.. there are lots of strange things happening in that range !<br><br>Here is the current status:<br>- WinXP sp2: using MLANG, it works well with most codepages I don't have a custom conversion routine: 932, 51932, 949, 50220, 50225.<br><br>The problem is: I must support Win2000 installs:<br>- mlang ConvertStringToUnicode fails on some broken chracter within a 932 string (it does well on XP)<br>- Using Win32 NLS MultiByteWoWideChar seems to fix the problem for my 932 issue but fails mysteriously for code pages 5xxxx (IsValidCodePage also returns false)<br><br>Possible solutions:<br>- Redistribute an updated version of Mlang to Win2k users (for what I've seen, this solution seems to do the job but might not be the best way to go because of the WFP feature of the OS, I could try LoadLibrary the dll from my application bin folder and call ConvertInet... manually)<br>- install missing NLS code pages on target computers (not sure how to do this since the Advanced options in Regional Settings does not have the check box for 51932 and also, IsValidCode page returns false for 5022x even if they seems to be enabled in the Regional settings)<br>- write custom conversion routines for all charsets I will ever use!  (seems like a waste of time to me!)<br><br>Whats do you think of the possible solutions?  What would be your horse?<br><br>Michel<br></div>
<p><strong>Yuhong Bao</strong> on 2 Dec 2008 11:10 PM:</p><div style="margin-left: 1em"><p>&quot;(there is a fourth model for Kernel mode and the Rtl* functions that can be used in both kernel and user mode, but I will cover that another day -- for my purposes here just consider it for now like Win32 but more limited!)&quot;</p>
<p>I'd just call it the Native API model.</p></div>
<p><strong>Michael S. Kaplan</strong> on 3 Dec 2008 12:43 AM:</p><div style="margin-left: 1em"><p>Well, that might cause more confusion for some people as &quot;Native&quot; has become the preferred term for the C++ team when referring to code that is not managed code (they prefer &quot;native&quot; to &quot;unmanaged&quot;).</p>
<p>I know kernel mode devs had the term first, but there are fewer of them so they may not win that one. :-)</p>
</div>
<p><strong>Yuhong Bao</strong> on 14 Nov 2010 7:52 PM:</p><div style="margin-left: 1em"><p>&quot;It represents complex pieces of code in three code bases written across nine versions of Windows, three versions of IE, and three version of the BCL, using unmanged, managed, and COM based code. It is very hard to figure out what is a bug to fix, what is a bug we are stuck with for backcompat reaons, what is an intentional feature that only looks like a bug because the behavior was not documented well enough. You can get a headache trying to figure it out sometimes (and many have!).&quot;</p>
<p>Yea, the fundamental flaw is that MLang was originally part of IE and was layered on top of the Win32 codepage model. As such, it had to run on multiple versions of Windows, accounting for changes in the Win32 codepage model underneath between various versions of Windows. Often when the Win32 codepage model changed, MLang had to be changed as well (for example, removing a workaround for a bug that has been fixed in the Win32 codepage model depending on the version of Windows). Eventually MLang became part of Windows itself, but still retains most of the cruft.</p>
</div>
<p><strong>Yuhong Bao</strong> on 14 Nov 2010 8:04 PM:</p><div style="margin-left: 1em"><p>Add the fact that IE (which was what MLang was part of) was updated independently from Windows, so if a bug-fix from Windows interferes with a workaround from MLang, IE would have to be updated at the same time to fix MLang.</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/12/25 <a href="http://archives.miloush.net/michkap/archive/2006/12/25/1362639.html">Anyone out there switching modes in JIS?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/07/26/443394.html" title="Not everyone likes Unicode">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/07/25/443046.html" title="A subkultur iz a shprakh mit an armey un a flot">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-07-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/07/26/443375.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>