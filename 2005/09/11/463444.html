<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/09/11/463444.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>unicodeFFFE... is Microsoft off its rocker?</title></head><body>
<h1>unicodeFFFE... is Microsoft off its rocker?</h1>
<p><em>by Michael S. Kaplan, published on 2005/09/11 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/09/11/463444.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>This is an issue that has been around for a long time.</FONT></P>
<P><FONT face=Tahoma>Back in February (geez, I really have been blogging almost a year now, haven't I?), I explained <a href="http://archives.miloush.net/michkap/archive/2005/02/09/369958.html">the difference between Big Endian and Little Endian Unicode</A>. In January I&nbsp;also talked about the <a href="http://archives.miloush.net/michkap/archive/2005/01/20/357028.html">Byte Order Mark</A>.</FONT></P>
<P><FONT face=Tahoma>Neither of them are what this post is about.</FONT></P>
<P><FONT face=Tahoma>This post is about the <A href="http://msdn.microsoft.com/workshop/author/dhtml/reference/charsets/charset4.asp"><FONT face=Tahoma>Preferred Charset Label</FONT></A>&nbsp;for web pages that are encoded with Big Endian Unicode (or 'Unicode big endian' as Notepad likes to call it).</FONT></P>
<P><FONT face=Tahoma>It is indeed <STRONG>unicodeFFFE</STRONG>.</FONT></P>
<P><FONT face=Tahoma>"<EM>But Michael, that is not a valid Unicode code point!</EM>" cry some.</FONT></P>
<P><FONT face=Tahoma>"<EM>But Michael, that is not what the big endian BOM looks like in memory if one is looking at the bytes!</EM>" cry others.</FONT></P>
<P><FONT face=Tahoma>"<EM>But Michael, that is not what the big endian BOM looks like on Big Endian systems!</EM>" cry some of those remaining.</FONT></P>
<P><FONT face=Tahoma>"<EM>Michael, is Microsoft off its rocker?</EM>" exclaim a few of the rest (their language is at time less polite, but one email used this language so I decided to go with it).</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>And believe it or not, there are actually bugs raised by people on several different product teams over the years, who are unhappy with one or more of the following:</FONT></P>
<UL>
<LI><FONT face=Tahoma>the results in MLang</FONT> 
<LI><FONT face=Tahoma>the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemtextencodingclasswebnametopic.asp">Encoding.BigEndianUnicode.WebName</A></FONT> 
<LI><FONT face=Tahoma>the <A href="http://msdn.microsoft.com/workshop/author/dhtml/reference/charsets/charset4.asp"><FONT face=Tahoma>Preferred Charset Label</FONT></A>&nbsp;in Internet Explorer</FONT> 
<LI>the MSDN documentation that refedreces unicodeFFFE</LI></UL>
<P>And then some the words from people at Microsoft....</FONT></P>
<P><FONT face=Tahoma>"The byte-order mark for big-endian unicode is FEFF, so this should be UnicodeFEFF. This seems like a valid complaint, but I was wondering if it'd break something else to change it." explains <a href="http://blogs.msdn.com/shawnste">Shawn Steele</A>, the development owner of encodings in Windows and the .NET Framework.</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>"I think this a mistake in the original MLang data, but we have to keep it for compatibility." explains&nbsp;the developer who used to own MLang, now the MUI Development Lead.</FONT></P>
<P>"Yes, it was a misnomer that we inherited from MLang.&nbsp; It’s too late to change that." explains the NLS Development Lead.</P>
<P>"Yes, this was wrong in the initial implementation. But now that apps are coded to it, we cannot change anymore." explains Software Architect Chris Lovett on the SQL Server team.</FONT></P>
<P><FONT face=Tahoma>But the original&nbsp;truth about why it was in MLang in the first place is not quite this insidious. Basically, Windows (and Microsoft) are predominantly Little Endian shops (even when platforms that supported BE ran Windows like Alpha, they used LE on the installs). And when someone on a little endian system reads it in as if it were a WCHAR (thinking it to be a UTF-16 LE code unit), they see 0xFFFE, which is of course not a valid Unicode code unit. Thus it is easy it is easy to see it as a big endian file.</FONT></P>
<P><FONT face=Tahoma>The BOM is always <A href="http://www.fileformat.info/info/unicode/char/feff/index.htm">U+FEFF</A>. Always. ALWAYS. But that means that in memory it is (in BYTEs):</FONT></P>
<UL>
<LI><FONT face=Tahoma><STRONG>0xff 0xfe</STRONG> when it is the little endian BOM on any system;</FONT> 
<LI><FONT face=Tahoma><STRONG>0xfe 0xff</STRONG> when it is the big endian BOM on any system.</FONT></LI></UL>
<P><FONT face=Tahoma>This is because big endian sytems take the first (big) byte first, where little endian systems take that seond byte&nbsp;first.&nbsp;Which means that in memory it is (in WORDs):</FONT></P>
<UL>
<LI><FONT face=Tahoma><STRONG>0xfeff</STRONG> when it is the little endian BOM on little endian systems; </FONT>
<LI><FONT face=Tahoma><STRONG>0xfffe</STRONG> when it is the big endian BOM on little endian systems. </FONT>
<LI><FONT size=1><FONT size=3><FONT face=Tahoma><STRONG>0xfffe</STRONG> when it is the little endian BOM on big endian systems; </FONT></FONT>
<LI><FONT size=3><FONT face=Tahoma><STRONG>0xfeff</STRONG> when it is the big endian BOM on&nbsp;big endian systems.</FONT></FONT></LI></UL>
<P><FONT face=Tahoma size=3>Try it yourself on any platform you happen to have handy if you don't believe me. :-)</FONT></FONT></P>
<P><FONT face=Tahoma><FONT size=1><FONT size=3>The semantic is clear and unambiguous, just not documented very well, and perhaps some would call it a rather silly way to think of it. </FONT></FONT></FONT><FONT face=Tahoma>The name is just acting as a somewhat sensible (if somewhat platformily provincial) labelling of what one sees on almost 100% of all Windows platforms.</FONT></P>
<P><FONT face=Tahoma>And as people already pointed out, it is a bit late to be talking about changing it....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><EM><FONT face=Tahoma color=#ff0000>This post brought to you by <A href="http://www.fileformat.info/info/unicode/char/fffe/index.htm">U+fffe</A>, a permanately reserved code unit in Unicode so that BOM determination can remain easier....</FONT></EM></P>
<hr/><p><a id="463612" href="#463612">#</a> <strong>Steven</strong> on 11 Sep 2005 9:22 AM:</p><div style="margin-left: 1em">&gt; 0xffff when it is the little endian BOM on big endian systems;<br><br>Is that right? 0xfffe would make more sense.</div>
<p><a id="463613" href="#463613">#</a> <strong>Michael S. Kaplan</strong> on 11 Sep 2005 9:26 AM:</p><div style="margin-left: 1em">&lt;P&gt;It would again look like 0xFFFE -- that is always what you will see on any system if you look at it as a WORD and it the wrong endian for the platform.&lt;/P&gt;<br>&lt;P&gt;Good catch though -- typo now gone. :-)&lt;/P&gt;</div>
<p><a id="463618" href="#463618">#</a> <strong>CornedBee</strong> on 11 Sep 2005 9:49 AM:</p><div style="margin-left: 1em">Just what is wrong with calling it &quot;bigendian&quot;? That's absolutely unambigous, and thus superior to &quot;fffe&quot; or &quot;feff&quot;, as the confusion over the name has shown.</div>
<p><a id="463619" href="#463619">#</a> <strong>Michael S. Kaplan</strong> on 11 Sep 2005 9:54 AM:</p><div style="margin-left: 1em">Nothing is wrong with it -- but it is too late. The fact is that the old name is now out there -- changing it would break a ton of existing clients.</div>
<p><a id="463691" href="#463691">#</a> <strong>Nick Lamb</strong> on 11 Sep 2005 3:58 PM:</p><div style="margin-left: 1em">I guess I should explain the source of the complaint from us Unix folks, since as usual Microsoft employees have tried to dodge the issue and make us look like idiots (idiots who somehow had Unicode working properly, with backwards compat. and everything while they fumbled around corrupting people's data...).<br><br>Unix has a lot of formatted text files. That is, they're not just a bunch of text which someone happens to be keeping in a file, they have meaning. That meaning is changed (usually to its detriment) if you insert or remove arbitrary data.<br><br>Now codepoint 0xfeff may not /look/ like anything, but that doesn't avoid it having meaning. So when a parser is looking for character 0x23 (#) and it finds 0xfeff that's a non-match. So a file which meant &quot;please execute this non-interactive shell&quot; before is nothing but gibberish after Microsoft's tools insert this 0xfeff &quot;marker&quot; character. If instead we find part of the file where arbitrary text is permitted (e.g. a comment, or a filename) and we insert Unicode text, we see that it works fine.<br><br>We can do a Raymond Chen thought experiment here. What happens if our popular spreadsheet software decides to pull the same dirty &quot;that character is just a marker&quot; trick on Microsoft's Excel XLS files ? There are all those nice character strings in them which we can mark.<br><br>We'll insert the Unicode / ASCII character 0x0 NUL into some of Excel's data strings as a &quot;marker&quot; for our software, and assume that Excel can ignore that (after all, it's a null character, right?). Now we try to load the file back into Excel and... surprise, Excel says it is corrupt and we lose our data.<br><br>Note that all of the above post (about trying to figure out whether you're looking at UTF-16 in big endian or little endian form) would be irrelevant if Microsoft had, like everyone else, simply accepted UTF8 as an on the wire/ on disk storage format. Once again Microsoft's desire to be anything-but-Unix costs their customers a lot of time and money for no gain.</div>
<p><a id="463693" href="#463693">#</a> <strong>Michael S. Kaplan</strong> on 11 Sep 2005 4:15 PM:</p><div style="margin-left: 1em">Hi Nick -- Well, as I mention in the BOM post referenced above, this is not just about Notepad. And it is about dealing with things as they are, not just as we want them to be.<br><br>What Notepad does was not done to specifically break Unix, any more than the Unix refusal to handle something that is legal in text is done specifically to thumb a nose at Microsoft.<br><br>Each platform and application has reasons for how they behave, and maybe instead of taking the oppotunity to slam Microsoft in predictable fashion, I have a suggestion for the affected UNIX people:<br><br>DON'T USE NOTEPAD ON WINDOWS TO EDIT YOUR UNIX SHELL SCRIPTS!<br><br>Then the problem is solved. :-)</div>
<p><a id="463714" href="#463714">#</a> <strong>Mihai</strong> on 11 Sep 2005 5:41 PM:</p><div style="margin-left: 1em">Hitting a bit left and a bit right, to make everyone is angry :-)<br>I am also unhappy with Notepad adding the BOM on UTF-8. Although I can understand why (sometimes) this is a good thing, I don’t agree if it opens a no-BOM UTF-8 file, correctly identify it, then add a BOM when saving.<br>How I would want it:<br>-	if the original had no BOM, then save should add no BOM<br>-	if the original had BOM, then save should keep the BOM<br>-	&quot;Save As&quot; should give me the option to save with or without BOM<br>Ok, everyone happy?<br><br>Now, Unix and Linux: my problem is with these systems being 100% agnostic about encodings. Although convenient for legacy, is 100% bad for a lot of things.<br>Let’s say I get a UTF-8 shell script, no BOM, but my LANG is set to ja_JP.EUC-JP (or Russian with KOI-R if you like :-) What happens? The script is not identified as UTF-8 and I get junk. If the script does a set LANG=ja_JP.UTF-8, this means the full script has to be reloaded as UTF-8 (if already cached)? Or lines are converted one by one? This means I can set the LANG to KOI-R, execute a KOI-R line, then EUC-JP and execute a EUC-JP line, then UTF-8 and execute a UTF-8 line. A multi-code script, with no marker to tell me which is what!<br>Same with the file system: set your locale to ja_JP.EUC-JP, create a file with Japanese name, then set your locale to UTF-8. Now, you cannot open the file, because the EUC-JP sequence of bytes is invalid UTF-8 sequence! Auch!<br><br>&quot;My way is the only way&quot; vs. &quot;You can do whatever you want, even hang yourself&quot;<br>Is one better than the other? Depends. I like it my way. Maybe sometimes I want to hang myself. But usually not :-)<br></div>
<p><a id="463886" href="#463886">#</a> <strong>Jonathan</strong> on 12 Sep 2005 3:09 AM:</p><div style="margin-left: 1em">I think using a byte-order-dependent name for an encoding that's different from another encoding only by byte order is kind of strange. UnicodeBigEndian would be much clearer, as notepad correct uses.<br><br>And who uses UTF16 on web pages anyways? I thought everyone just uses UTF8 or legacy codepages...</div>
<p><a id="8135530" href="#8135530">#</a> <strong>Doncho</strong> on 10 Mar 2008 1:54 PM:</p><div style="margin-left: 1em"><p>It's quite simple, Microsoft messed it up and did absolutely nothing to fix it (not even an deeply hidden option in notepad).</p>
<p>So, most users use Windows, so... if we break text files this way (not help fix the problem in any way) all Unix users will get problems... which is good for us. Sounds convincing, doesn't it?</p></div>
<p><a id="8135795" href="#8135795">#</a> <strong>Michael S. Kaplan</strong> on 10 Mar 2008 2:15 PM:</p><div style="margin-left: 1em"><p>Hmmmm. Not sure what on earth that has to do with Big Endian UTF-16, which UNIX chokes on just as often as little endian UTF-16.</p>
<p>If UNIX wants to claim to have UTF-8 support except for that one character (the BOM) then I have a simple solution: STOP WRITING YOUR UNIX SHELL SCRIPTS IN WINDOWS NOTEPAD AND SAVING THEM AS UTF-8!!!! </p>
</div>
<p><strong>Yuhong Bao</strong> on 11 Mar 2009 5:59 PM:</p><div style="margin-left: 1em"><p>&quot;Note that all of the above post (about trying to figure out whether you're looking at UTF-16 in big endian or little endian form) would be irrelevant if Microsoft had, like everyone else, simply accepted UTF8 as an on the wire/ on disk storage format. Once again Microsoft's desire to be anything-but-Unix costs their customers a lot of time and money for no gain.&quot;</p>
<p>MS was an early Unicode adopter and UTF-8 was created in 1992, by then it was too late, the first NT betas has already come out and NT was released in 1993. </p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/08/22 <a href="http://archives.miloush.net/michkap/archive/2010/08/22/10052904.html">...from the Microsoft point of view</a></p><p>2008/03/11 <a href="http://archives.miloush.net/michkap/archive/2008/03/11/8152232.html">Why are UTF-8 encoded Unix shell scripts *ever* written or edited in Notepad?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/09/11/463670.html" title="I 𐿿 Unicode">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/09/11/463437.html" title="Working hard to detect code pages">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-09-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/09/11/463444.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>