<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/09/18/470869.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Extending collation support in SQL Server and Jet, Part 2 (generating sort keys)</title></head><body>
<h1>Extending collation support in SQL Server and Jet, Part 2 (generating sort keys)</h1>
<p><em>by Michael S. Kaplan, published on 2005/09/18 16:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/09/18/470869.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Prior posts in the series:</FONT></P>
<P><FONT face=Tahoma><a href="http://archives.miloush.net/michkap/archive/2005/09/13/463962.html">Extending collation support in SQL Server and Jet, Part 0 (HISTORY)</A></FONT><FONT face=Tahoma><BR><a href="http://archives.miloush.net/michkap/archive/2005/09/14/464780.html">Extending collation support in SQL Server and Jet, Part 1 (the broad strokes)</A></FONT></P>
<P><FONT face=Tahoma>Okay, let's dig into some details, now. :-)</FONT></P>
<P><FONT face=Tahoma>If you look back to June when I talked about how <a href="http://archives.miloush.net/michkap/archive/2005/06/09/427293.html">string.Compare is for sissies (not for people who want SQLCLR consistency)</A> and July when I went a bit further and talked about how <a href="http://archives.miloush.net/michkap/archive/2005/07/08/436669.html">real developers use CompareInfo's Compare (Part 1)</A>, I really did spend some time talking about how if you want configurable collation in .NET, you have to use the CompareInfo object. Certainly for sort keys, there is no way other than the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassgetcompareinfotopic.asp">CompareInfo.GetSortKey</A>&nbsp;method....</FONT></P>
<P><FONT face=Tahoma>Now the first point is&nbsp;how many&nbsp;of the workarounds I discussed to move collation settings between Win32 and .NET or .NET and SQL Server are needed:</FONT></P>
<P><FONT face=Tahoma><STRONG>NONE.</STRONG></FONT></P>
<P><FONT face=Tahoma>That is right, you don't need to do any of those workarounds. Because the method in .NET will do the work for you of mapping out of .NET and Win32 through the "Windows-only CultureInfo" support. Cool, no? :-)</FONT></P>
<P><FONT face=Tahoma>You do have to decide what you want to do with the various settings you have available to you, basically the members of the <A href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareoptionsclasstopic.asp">CompareOptions enumeration</A>:</FONT></P>
<UL>
<LI><FONT face=Tahoma>CompareOptions.IgnoreCase (setting is analagous to the 'CI' setting in SQL Server collations, rather than the 'CS' setting)</FONT> 
<LI><FONT face=Tahoma>CompareOptions.IgnoreKanaType (setting is analagous to the not having the 'KS' setting in SQL Server collations)</FONT> 
<LI><FONT face=Tahoma>CompareOptions.IgnoreNonSpace (setting is analagous to the 'AI' setting in SQL Server collations, rather than the 'AS' setting)</FONT> 
<LI><FONT face=Tahoma color=#808080>CompareOptions.IgnoreSymbols (no SQL Server analogue)</FONT> 
<LI><FONT face=Tahoma>CompareOptions.IgnoreWidth (setting is analagous to the not having the 'WS' setting in SQL Server collations)</FONT> 
<LI><FONT face=Tahoma color=#808080>CompareOptions.StringSort (no SQL Server analogue)</FONT></LI></UL>
<P><FONT face=Tahoma>For the sake of consistency with other SQL Server collations, I would recommend staying away from IgnoreSymbols and StringSort (though at this point some of you may be thinking about how this method could be used to customize the support for existing collations!).</FONT></P>
<P><FONT face=Tahoma>We will start with our CustomSqlCollation class, which will take a culture name and the comparison options to use (I'll build on this class more, in the future):</FONT></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp;&nbsp; sealed public class CustomSqlCollation {<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>// Private members</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private CultureInfo m_cultureInfo;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private CompareInfo m_compareInfo;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private CompareOptions m_options;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private string m_name;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>//&nbsp;Constructor</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public CustomSqlCollation(string name, CompareOptions options) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.m_cultureInfo =&nbsp;new CultureInfo("mn-CN-Mong", false);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.m_compareInfo = this.m_cultureInfo.CompareInfo;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.m_options =&nbsp;options;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.m_name = name;</STRONG></FONT><FONT face="Courier New"><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>//&nbsp;Method to return an index value</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public byte[] GetSortKey(string input) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return this.m_compreInfo.GetSortKey(input, this.m_options);</STRONG></FONT><FONT face="Courier New"><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>//&nbsp;Compare method -- note that the many&nbsp;other forms of</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#008000>//&nbsp;&nbsp; CompareInfo.Compare can also be&nbsp;done here</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public int Compare(string&nbsp;string1, string&nbsp;string2) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return this.m_compareInfo.Compare(string1, string2,&nbsp;this.m_options);</STRONG></FONT><FONT face="Courier New"><BR><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </STRONG></FONT><FONT face="Courier New"><STRONG>}&nbsp;<BR>&nbsp;&nbsp;&nbsp; }</STRONG></FONT></P>
<P><FONT face=Tahoma>So, lets say that you have decided you want to create a custom collation for one of the new locales in Vista added for the Chinese minority language support -- Mongolian. The name of this culture that you would use to create it is <STRONG>mn-CN-Mong</STRONG> and it will create a CultureInfo object's whose NativeName is something like</FONT></P>
<P><FONT face=Tahoma>&nbsp;<FONT face="Mongolian Baiti,Code2000" size=5><STRONG>ᠮᠣᠩᠭᠤᠯ ᠬᠡᠯᠡ (ᠪᠦᠭᠦᠳᠡ ᠨᠠᠢᠷᠠᠮᠳᠠᠬᠤ ᠳᠤᠮᠳᠠᠳᠤ ᠠᠷᠠᠳ ᠣᠯᠣᠰ)</STRONG></FONT> </FONT></P>
<P><FONT face=Tahoma>and whose EnglishName is something like</FONT></P>
<P><FONT face=Tahoma>&nbsp;<STRONG>Mongolian (Mongolian, People's Republic of China)</STRONG></FONT></P>
<P><FONT face=Tahoma>(That native name will show up much more effectively in Vista, which has the font and rendering engine support!)</FONT></P>
<P><FONT face=Tahoma>On the whole it would likely be best to not ignore any of the weights when the language in question does not have any of those chracteristics (case, non-spacing marks, different Kana types, or different widths). So none of those other flags should be passed in this scenario -- the weights may be leveraged for other purposes in the script.</FONT></P>
<P><FONT face=Tahoma>But now any time you need to create a value for your index (either inserting a row or changing the value in the column), you can call CustomSqlCollation.GetSortKey() to get the value to use -- using an insert trigger and a update trigger&nbsp;to create or regenerate the index value, as needed. And you can sort using that index column at any time.</FONT></P>
<P><FONT face=Tahoma>If anybody told me that SQL Server was going to give good Mongolian script support, I would have been really skeptical -- until I realized it would not be that hard to do the actual work!</FONT></P>
<P><FONT face=Tahoma>Next time, I'll cover those triggers and how to write them, as well as filling out more of the methods of the CustomSqlCollation class....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma><FONT color=#ff0000><EM>This post brought to you by</EM> "<STRONG><FONT face="Mongolian Baiti" size=6>ᠯ</FONT></STRONG>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/182f/index.htm">U+182f</A>, a.k.a. MONGOLIAN LETTER LA)</EM></FONT></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2005/10/21 <a href="http://archives.miloush.net/michkap/archive/2005/10/21/480898.html">Extending collation support in SQL Server and Jet, Part 4 (What about Jet?)</a></p><p>2005/10/09 <a href="http://archives.miloush.net/michkap/archive/2005/10/09/478705.html">Extending collation support in SQL Server and Jet, Part 3 (THAT CLASS)</a></p><p>2005/09/25 <a href="http://archives.miloush.net/michkap/archive/2005/09/25/473686.html">Extending collation support in SQL Server and Jet, Part 2.1 (is this on?)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/09/18/470900.html" title="A shorter &#39;shortest published sentence of the year&#39; ?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/09/17/470709.html" title="A new link category for inactive blogs">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-09-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/09/18/470869.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>