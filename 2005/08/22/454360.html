<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/08/22/454360.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Why I think the thread locale really stinks</title></head><body>
<h1>Why I think the thread locale really stinks</h1>
<p><em>by Michael S. Kaplan, published on 2005/08/22 03:03 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/08/22/454360.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>I do not like the thread locale.</FONT></P>
<P><FONT face=Tahoma>Yes, <A href="http://msdn.microsoft.com/library/en-us/intl/nls_9ko5.asp">GetThreadLocale</A> and <A href="http://msdn.microsoft.com/library/en-us/intl/nls_52lh.asp">SetThreadLocale</A> are two of the many <A href="http://msdn.microsoft.com/library/en-us/intl/nls_8d0z.asp">NLS functions</A> that the GIFT team supports.</FONT></P>
<P><FONT face=Tahoma>And yes, if we are to look at the functions we own as if they are our children then we are supposed to love them all.</FONT></P>
<P><FONT face=Tahoma>But in that case, I guess I am a lousy parent (if you will recall, I think that <a href="http://archives.miloush.net/michkap/archive/2005/04/23/411074.html">SetLocaleInfo really stinks</A>, too).</FONT></P>
<P><FONT face=Tahoma>First of all, there are the weird dependencies in USER32 and SHELL32 that probably ought to be using the user locale but instead use the thread locale and fall back to the system locale if something goes wrong.</FONT></P>
<P><FONT face=Tahoma>Second of all, there is the poor story in <A href="http://msdn.microsoft.com/library/en-us/intl/nls_9ko5.asp">GetThreadLocale</A>:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<H4><FONT face="Times New Roman" size=2><EM>Return Values</EM></FONT></H4>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>The function returns the system's default user locale.</EM></FONT></P></BLOCKQUOTE>
<H4><FONT face="Times New Roman" size=2><EM>Remarks</EM></FONT></H4>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>When a thread is created, it uses the system default user locale. The system reads the system default user locale from the registry when the system boots. This system default can be modified for future process and thread creation using Control Panel's International application.</EM></FONT></P></BLOCKQUOTE></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>Since it always returns the thread locale, which starts its life as the user locale (set in Regional Options) but can be changed by a call to <A href="http://msdn.microsoft.com/library/en-us/intl/nls_52lh.asp">SetThreadLocale</A>, you can make a fair case that both parts of the text are losuy.</FONT></P>
<P><FONT face=Tahoma>Third of all, there is the worse story in <A href="http://msdn.microsoft.com/library/en-us/intl/nls_52lh.asp">SetThreadLocale</A>:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<H4><FONT face="Times New Roman" size=2><EM>Return Values</EM></FONT></H4>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>If the function succeeds, the return value is a nonzero value. </EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>If the function fails, the return value is zero. To get extended error information, call </EM></FONT></FONT><?XML:NAMESPACE PREFIX = MSHelp NS = "http://msdn.microsoft.com/mshelp" /><MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_getlasterror"><EM><FONT size=2>GetLastError</FONT></EM></MSHelp:link><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>. </EM></FONT></P></BLOCKQUOTE>
<H4><FONT face="Times New Roman" size=2><EM>Remarks</EM></FONT></H4>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman" size=2><EM>When a thread is created, it uses the system default thread locale. The system reads the system default thread locale from the registry when the system boots. This system default can be modified for future process and thread creation using Control Panel's International application. </EM></FONT></P>
<P><FONT face="Times New Roman" size=2><EM>The <B>SetThreadLocale</B> function affects the selection of resources that are defined with a <B>LANGUAGE</B> statement. This affects such functio</EM></FONT></FONT><FONT size=2><EM>ns as <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_createdialog">CreateDialog</MSHelp:link>, <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_dialogbox">DialogBox</MSHelp:link>, <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_loadmenu">LoadMenu</MSHelp:link>, <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_loadstring">LoadString</MSHelp:link>, and <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_findresource">FindResource</MSHelp:link>, and sets the code page implied by CP_THREAD_ACP, but does not affect <MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_findresourceex">FindResourceEx</MSHelp:link>. </EM></FONT></P><FONT face=Tahoma>
<P><FONT face="Times New Roman"><FONT size=2><EM><B>Windows 2000/XP:</B> Do not use <B>SetThreadLocale</B> to select a UI language. To select the proper resource that is defined with a <B>LANGUAGE</B> statement, use </EM></FONT></FONT></FONT><EM><MSHelp:link tabIndex=0 errorURL="notopic_0pk4.htm" keywords="_win32_findresourceex"><FONT size=2>FindResourceEx</FONT></MSHelp:link><FONT face=Tahoma><FONT face="Times New Roman"><FONT size=2>.</FONT></FONT></P></BLOCKQUOTE></BLOCKQUOTE></FONT></EM>
<P><FONT face=Tahoma>Where do I start? The function should return an LCID on success -- the previous thread locale! -- not a BOOL. Just like functions like <A href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windowclasses/windowclassreference/windowclassfunctions/setwindowlong.asp">SetWindowLong</A> does. Oh well, I guess that is not the end of the world.</FONT></P>
<P><FONT face=Tahoma>There is that same type of silly text about the 'system default thread locale' which is a beast not found in nature. The notion that it is read from the registry on boot is also crap. it is based on user locale. Always.</FONT></P>
<P><FONT face=Tahoma>Then there is the text about how resource loading is affected -- and a warning sans explanation to not use that functionality on Win2000 and later. Since it is not supported on Win9x, what it is really saying is "good for only NT 3.1, 3.5x, and 4.0". In other words a warning that the function is not useful on modern platforms unless you want to affect the Shell and User subsystem in strange ways. Although it does not bother to say so.</FONT></P>
<P><FONT face=Tahoma>Fourth of all, t</FONT><FONT face=Tahoma>he fact is that resource loading is incredibly complicated, in part because of this questionable functionality. It is not based on the user locale, and it is not in essence based on the thread locale <EM>unless you change it</EM>. In which case it suddenly is based on the thread locale. Unless it is based on the UI language -- which it should always be. I swear you need a spirit dancer and a Ouija board to know what resources load if you start mucking with the various locale&nbsp;settings, and that is mostly because of this weird setting that hovers between UI language and&nbsp;user locale -- the thread locale.</FONT></P><FONT face=Tahoma>
<P><FONT face=Tahoma>On older platforms it is worse -- the system locale is the one that is used except when you set the thread locale (even though the thread locale is initially the user locale). I guess that is about the same as Win2000 and later, just substitute system locale for UI language.</FONT></P>
<P>This is by the way (now that I think about it) the first reasonable explanation for the strange Visual Basic &lt;= 6.0 behavior where in the IDE the user locale is the language used for resource loading, even though in the compiled application that would not work -- VB was setting the the thread locale to the user locale and confusing millions of VB developers with this never-before-now-fully-explained behavior. Geez.</P></FONT>
<P><FONT face=Tahoma>Anyway, we document that developers should use LOCALE_USER_DEFAULT and not GetThreadLocale when they are trying to respect the user's preferences.</FONT></P>
<P><FONT face=Tahoma>If you ask me, we should treat every case where the thread locale is currently used as a <STRONG>bug to be fixed</STRONG> and not as a <STRONG>legacy behavior to be coddled</STRONG>. </FONT><FONT face=Tahoma>We have been slowly breaking the behavior anyway with each version&nbsp;without explaining why since it was already broken, so why not just cut the cord and stop using this dastardly functionality?</FONT></P>
<P><FONT face=Tahoma>The thread locale really stinks, after all!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff0000><EM>This post brought to you by</EM> "×²" <EM>(<A href="http://www.fileformat.info/info/unicode/char/05f2/index.htm">U+05f2</A>, HEBREW LIGATURE YIDDISH DOUBLE YOD)</EM></FONT></P>
<hr/><p><a id="454551" href="#454551">#</a> <strong>Lonnie McCullough</strong> on 22 Aug 2005 12:14 PM:</p><div style="margin-left: 1em">I totally agree with everything you said here.  The whole concept of thread locales makes the system seem more complicated than it has to be.  Its just another concept that is introduced throughout the docs, that make internationalization more impenetrable, even though a properly written app should never have to worry about it.</div>
<p><a id="454829" href="#454829">#</a> <strong>Michael Dunn_</strong> on 22 Aug 2005 7:08 PM:</p><div style="margin-left: 1em">So what's the _right_ way to answer the question &quot;what language should I show resources in?&quot; I'm confused by all the various get-locale and get-language functions and, as you've noted, the SDK wording isn't the best. (My situation is I need to send a language id [any kind of id, doesn't have to be a LCID] to a web page so it knows what language it should show stuff in.)<br>Just going by API names, GetUserDefaultUILanguage looks good but I need something that works on 98 as well.</div>
<p><a id="454881" href="#454881">#</a> <strong>Michael S. Kaplan</strong> on 22 Aug 2005 9:31 PM:</p><div style="margin-left: 1em">Hi Mike -- this sounds like a great topic for a blog post! :-)</div>
<p><a id="8936858" href="#8936858">#</a> <strong>Stephen Whipp</strong> on 9 Sep 2008 11:51 AM:</p><div style="margin-left: 1em"><p>What you say is all well and good, but it doesn;t alter the fact that sometimes it is actually necessary to use ThreadLocale, rather than user locale as we have been forced to do. There are several reasons. If every app hotswapped correctly in response to changes in locale it would be fine, but most do not. </p>
<p>1) We have users who aren't very computer literate and don;t know where to find such settings in control panel etc. Furthermore they need to be able to hot swap them easilly as they need to be able to use the app in more than 1 language. Both for input language and locale settings.</p>
<p>2) Our users may be unable to access Control Panel owing to network restrictions. Certainly be unable to edit them. </p>
<p>3) Programmatically altering the user_locale settings would likely cause problems with other applications if it were not kept strictly local. </p>
<p>Its an odd fact, but there are cases where hotswapping locales is necessary. Input Language can be selected from the language bar... if such is installed. However it doesn;t function correctly in our case. Try intercepting the localechange message from a window which can't take focus sometime. We have to manage such internally, implying the need for thread &nbsp;based locale settings.</p></div>
<p><a id="8936883" href="#8936883">#</a> <strong>Michael S. Kaplan</strong> on 9 Sep 2008 12:00 PM:</p><div style="margin-left: 1em"><p>But the wrong results are returned if you use it, due to the problems.</p>
<p>What locale are you hot-swapping to in this case? If you show UI then why not have one global in your app that stores the value, rather than trying to use malfunctioning thread locale?</p>
<p>I can understand wanting better behavior, but the thread locale cqn't deliver that....</p>
</div>
<p><a id="9132706" href="#9132706">#</a> <strong>serans1</strong> on 22 Nov 2008 4:35 AM:</p><div style="margin-left: 1em"><p>Greate article.</p>
<p>I have searched on th web for a way to get a thread locale - any thread local (by thread ID/process ID) and had no success.</p>
<p>does anyone has any idea of how this can be accomplished ? </p></div>
<p><a id="9132873" href="#9132873">#</a> <strong>Michael S. Kaplan</strong> on 22 Nov 2008 12:38 PM:</p><div style="margin-left: 1em"><p>If you think it is such a great article, then why do you want to get the information on a setting that the article goes to great lengths to explain you shouldn't ever use? :-)</p>
<p>To answer your question, that information is not available by any public function in the Win32 API. You must be in a thread to query its thread locale. Good thing you never really need it!</p></div>
<p><strong>Farproc</strong> on 8 Aug 2010 9:50 AM:</p><div style="margin-left: 1em"><p>So, what are the shell and user effects of this function? Because, readin the docs, the only visible purpose this function has - would be to influence the language selected when calling the resource functions. And then, that exact use, is singled out as the use the function should not be used for. Is there an alternate ((more) legitimate) use of this function?</p>
<p>Being told to use FindResourceEx is a bit disingenuous as SetThreadLocale would allow one to change the language of resources where code could not be re-factored (for example, when invoking a common dialog out a library dll).</p>
<p>There is of course, SetThreadUILanguage but how does that not suffer the same problems as SetThreadLocale (whatever those problems may be).</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 8 Aug 2010 10:15 AM:</p><div style="margin-left: 1em"><p>Shell is guilty of using it to influence many of its functions that would use a locale -- as if it were the user locale (for formatting and sorting). And USER does the same in many cases. It thus has a lot of unintended effects on program behavior and the program stops respecting user preferences....</p>
<p>That is if the fact that it is broken for resource loading in hard to predict ways doesn&#39;t convince you!</p>
</div>
<p><strong>Doug Edey</strong> on 27 Sep 2010 6:57 AM:</p><div style="margin-left: 1em"><p>Hi,</p>
<p>Just out of interest, if we never use SetThreadLocale() would you still recommend against using GetThreadLocale()?</p>
<p>Also, the documentation doesn&#39;t state DON&#39;T use GetThreadLocale().</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 27 Sep 2010 9:46 AM:</p><div style="margin-left: 1em"><p>Well, the real question is &quot;what would you use it for?&quot;, of course....</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/03/19 <a href="http://archives.miloush.net/michkap/archive/2010/03/19/9980203.html">Strange how unsympathetic I was, until I was suddenly quite sympathetic</a></p><p>2007/05/28 <a href="http://archives.miloush.net/michkap/archive/2007/05/28/2960411.html">Nothing stinks worse than the thread locale, other than the thread code page</a></p><p>2006/04/28 <a href="http://archives.miloush.net/michkap/archive/2006/04/28/585735.html">DEFAULT_GUI_FONT really stinks</a></p><p>2005/12/10 <a href="http://archives.miloush.net/michkap/archive/2005/12/10/502415.html">CurrentRegion is not based on the GEOID</a></p><p>2005/10/12 <a href="http://archives.miloush.net/michkap/archive/2005/10/12/479817.html">Some of GetGeoInfo is sorta broken</a></p><p>2005/08/31 <a href="http://archives.miloush.net/michkap/archive/2005/08/31/458266.html">Sometimes it *does* pay to be neutral</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/08/22/454561.html" title="International support as a developer &#39;tax&#39; ?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/08/21/454340.html" title="Unicode text in a VB6 RichTextBox?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-08-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/08/22/454360.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>