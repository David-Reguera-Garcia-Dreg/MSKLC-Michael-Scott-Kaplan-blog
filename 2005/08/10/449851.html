<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/08/10/449851.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Suits you to a _T()</title></head><body>
<h1>Suits you to a _T()</h1>
<p><em>by Michael S. Kaplan, published on 2005/08/10 08:51 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/08/10/449851.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>The other day, Jeremy asked me:</FONT></P><FONT face=Tahoma><FONT size=2>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Times New Roman">I thought that with your wealth of unicode knowledge, you may be able to answer a few questions for me.</FONT></P>
<P><FONT face="Times New Roman">In a C/C++ program, is it necessary to wrap single character conversions in a _T( ) macro?</FONT></P>
<P><FONT face="Times New Roman">For instance...</FONT></P>
<P><FONT face="Times New Roman">TCHAR tch = _T('S');</FONT></P>
<P><FONT face="Times New Roman">The MSVC compiler happly converts the literal 'S' to a double byte '\0''S' for UNICODE builds, so that the following appears to compile fine...</FONT></P>
<P><FONT face="Times New Roman">TCHAR tch = 'S';</FONT></P>
<P><FONT face="Times New Roman">I'm unclear if the compiler is actually substituing L'S' for 'S', or simply promoting the value of 'S' to a double byte.</FONT></P>
<P><FONT face="Times New Roman">Is there any case in which a single-byte character has a unicode representation that is not a simple double byte promotion?</FONT></P></BLOCKQUOTE></FONT></FONT>
<P><FONT face=Tahoma>If you are not dealing with both Unicode and non-Unicode builds of a program, then all of the _T()/TEXT() macro stuff as well as all of the TCHAR stuff is fairly superfluous. As I mentioned a few days ago, new functions NLS adds to Vista are not going to have non-Unicode versions added (a trend started in Server 2003).</FONT></P>
<P><FONT face=Tahoma>To answer the specific question about whether the macros is required (and keeping the last paragraph in mind), I would always suggest using the <STRONG>L</STRONG> prefix on Unicode characters and strings, even though the compiler seems to not feel the need to use it for characters. It is definitely still needed any time you specify a string literal, and the consistency seems like a good thing, doesn't it?</FONT></P>
<P><FONT face=Tahoma>For the ASCII range, you will not find a difference between that "double byte promotion" and a Unicode representation. However, for anything single byte that is outside of ASCII but inside of the default system code page, I would go so far as to say that the "promotion" would usually be wrong, and possibly also subject to different interpretations depending on what the default system code page happens to be. If you are gong to write UNICODE/_UNICODE applications, then it seems best to keep them using Unicode everywhere....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff0000><EM>This post brought to you by</EM> "S" <EM>(U+0053, a.k.a. LATIN CAPITAL LETTER S)</EM></FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<hr/><p><a id="449868" href="#449868">#</a> <strong>Richard</strong> on 10 Aug 2005 10:01 AM:</p><div style="margin-left: 1em">In C++ 's' is a char, in C it is an int. L's' in C++ is a wchar_t (not sure about C).<br><br>However in C wchar_t is a typedef, but in C++ it is a distinct type. But Visual C++ (unless overridden with a command line/IDE option) it is also a typedef; and char-&gt;int is an alloewd conversion.<br><br>I wonder if<br>wchar_t x = 'S'<br>works OK with wchar_t as a distinct type?</div>
<p><a id="450157" href="#450157">#</a> <strong>Dean Harding</strong> on 10 Aug 2005 7:20 PM:</p><div style="margin-left: 1em">I don't have my copy of the beta here, but I'm pretty sure wchar_t is a distinct type by default in VS2005.  It was a typedef by default in VS2003 (though it's easy enough to change - usually the first thing I do when starting a new C++ project is set all those 'Treat wchar_t as a Built-In Type', 'Force Conformance In For Loop Scope', etc options to True).<br><br>And yeah, I agree with just doing away with all that TCHAR, _T() stuff.  It's much simpler to just use wchar_t and S'...' directly, these days.  The macros were good when you were doing separate builds for Windows 9X and NT, and didn't want/need MSLU :)</div>
<p><a id="450262" href="#450262">#</a> <strong>Scott</strong> on 11 Aug 2005 12:29 AM:</p><div style="margin-left: 1em">I figure that the _T for strings and characters is useful for whenever Unicode 12.7 comes and out and we're all using 5 byte characters. Less code to change - assuming the macros are updated.</div>
<p><a id="450879" href="#450879">#</a> <strong>Alexey Logachyov</strong> on 12 Aug 2005 11:24 AM:</p><div style="margin-left: 1em">There's one more thing important. If you use literals from upper half of ASCII table or multibyte characters, be sure to use #pragma setlocale to make compiler convert strings to Unicode using correct code page.<br><br>Just today a guy from office opposite to mine had a problem. His SQL query did not work correctly. The query contained Russian letters and it did not fetch any results.<br><br>It turned out that Visual Studio was setup to use Russian fonts but system locale was set to English. Compiler converted strings using incorrect code page and Russian string became garbage.</div>
<p><a id="451047" href="#451047">#</a> <strong>Michael S. Kaplan</strong> on 12 Aug 2005 5:50 PM:</p><div style="margin-left: 1em">Considering how often people copy/paste code snippets, it might be safer to just use code points (well,code units) in those cases....</div>
<p><a id="451204" href="#451204">#</a> <strong>Alexey Logachyov</strong> on 13 Aug 2005 4:57 AM:</p><div style="margin-left: 1em">You mean writing it like this?<br><br>CHAR StrA = &quot;\xF1\xEB\xEE\xE2\xEE&quot;;<br>WCHAR StrW = L&quot;\x0441\x043B\x043E\x0432\x043E&quot;;<br><br>This is a pain for Russian speaking people (like I am). The following snippet looks so much natural to me.<br><br>#pragma setlocale(&quot;rus&quot;)<br>TCHAR Str = _T(&quot;&quot;);<br></div>
<p><a id="451980" href="#451980">#</a> <strong>Mike Dunn</strong> on 15 Aug 2005 11:15 PM:</p><div style="margin-left: 1em">WCHAR c = 'S';<br> <br>works because char-&gt;wchar_t is a widening conversion akin to BYTE-&gt;WORD or short-&gt;long. If you did this:<br> <br>wcout &lt;&lt; 'S';<br> <br>it won't promote anything.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/08/10/449909.html" title="Double compressions -- Hungarian goulash?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/08/09/449590.html" title="Tysabri still down for the count">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-08">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-08-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/08/10/449851.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:41 GMT -->
</html>