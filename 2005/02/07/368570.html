<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/07/368570.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Normalization as obfuscation in C#</title></head><body>
<h1>Normalization as obfuscation in C#</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/07 12:32 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/07/368570.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Take a look at the following code, let me know what you think of it (compiled with Whidbey Beta 2, note the preview of the exciting new <A title=StringInfo href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationstringinfoclasstopic.asp" target=_blank>StringInfo</A> methods for dealing with text elements!):</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2>namespace àáâãäå {<BR>using System;<BR>using System.Text;<BR>using System.Globalization;</FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp; class àáâãäå <BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;[STAThread]<BR>&nbsp;&nbsp;static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå(); àáâãäå(); àáâãäå();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå(); àáâãäå(); àáâãäå(); àáâãäå();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå(string àáâãäå) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringBuilder àáâãäå = new StringBuilder();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; StringInfo àáâãäå =&nbsp; new StringInfo(àáâãäå);</FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.Append(àáâãäå.Normalize(NormalizationForm.FormC));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.Append(": ");</FONT></P>
<P><FONT face="Courier New" size=2>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for(int àáâãäå=0; àáâãäå &lt; àáâãäå.LengthInTextElements; àáâãäå++) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string àáâãäå = àáâãäå.SubstringByTextElements(àáâãäå, 1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if(àáâãäå.IsNormalized(NormalizationForm.FormC)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.Append("C");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if(àáâãäå.IsNormalized(NormalizationForm.FormD)) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.Append("D");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.Append("_");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(àáâãäå.ToString());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void àáâãäå() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; àáâãäå.àáâãäå("àáâãäå");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>}</FONT></P></BLOCKQUOTE>
<P dir=ltr>It compiles, even though it looks like the namespace, the class name, every procedure (other than main) and every variable looks like the same string.</P>
<P>The wonders of various combinations of the string "<STRONG>àáâãäå</STRONG>".</P>
<P><EM>(Interestingly, due to all the exciting work of someone from the VS team, the cursor moves over the&nbsp;text elements&nbsp;<STRONG>as letters</STRONG> and thus it was an interesting challenge getting&nbsp;this written!)</EM></P>
<P>Do you think it makes the code less readable? :-)</P>
<P>Compile it on the command line:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New"><FONT size=2>c:\temp&gt;csc àáâãäå.cs</FONT></FONT></P></BLOCKQUOTE>
<P>and then run it to see the output:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2>c:\temp&gt;àáâãäå<BR>àáâaäå: CCCCCC<BR>àáâaäå: DDDDDD<BR>àáâaäå: DCCCCC<BR>àáâaäå: DDCCCC<BR>àáâaäå: DDDCCC<BR>àáâaäå: DDDDCC<BR>àáâaäå: DDDDDC</FONT></P></BLOCKQUOTE>
<P>Interesting, no? :-)</P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by</EM> "<STRONG>à</STRONG>", "<STRONG>á</STRONG>", "<STRONG>â</STRONG>", "<STRONG>ã</STRONG>", "<STRONG>ä</STRONG>", and&nbsp;"<STRONG>å</STRONG>" <EM>(<FONT size=2><A href="http://www.fileformat.info/info/unicode/char/00e0/index.htm">U+00e0</A>, <A href="http://www.fileformat.info/info/unicode/char/00e1/index.htm">U+00e1</A>, <A href="http://www.fileformat.info/info/unicode/char/00e2/index.htm">U+00e2</A>, <A href="http://www.fileformat.info/info/unicode/char/00e3/index.htm">U+00e3</A>, <A href="http://www.fileformat.info/info/unicode/char/00e4/index.htm">U+00e4</A>,&nbsp;and&nbsp;<A href="http://www.fileformat.info/info/unicode/char/00e5/index.htm">U+00e5</A>, a.k.a. LATIN SMALL LETTER A WITH GRAVE,&nbsp;LATIN SMALL LETTER A WITH ACUTE,&nbsp; LATIN SMALL LETTER A WITH CIRCUMFLEX,&nbsp;LATIN SMALL LETTER A WITH TILDE,&nbsp;LATIN SMALL LETTER A WITH DIAERESIS, and&nbsp;LATIN SMALL LETTER A WITH RING ABOVE</FONT>)<BR></EM><FONT size=1>Well who did you think would be willing to sponsor this rubbish? :-)</FONT></FONT></P>
<hr/><p><a id="368589" href="#368589">#</a> <strong>Brodie Thiesfield</strong> on 7 Feb 2005 10:57 AM:</p><div style="margin-left: 1em">It should be a compiler error if identifiers are the same after begin normalized to a fixed type. Just to stop the sort of confusing bug where it LOOKS like you're using the correct identifier, but in reality it's a different one. This wouldn't happen when everyone uses the same editor for the code, but if some developers choose to use a different editor which has a different normalization mode to the other developer's editor...</div>
<p><a id="368594" href="#368594">#</a> <strong>Michael Kaplan</strong> on 7 Feb 2005 11:00 AM:</p><div style="margin-left: 1em">Well, I will not disagree with you, but this is not an error in 1.0, 1.1, or 2.0 of .NET as shipped by Microsoft (if you have an application that does not call Whidbey-specific methods), so technically that would be a breaking change.<br><br>Though maybe FxCop can make it a warning. :-)</div>
<p><a id="368657" href="#368657">#</a> <strong>CN</strong> on 7 Feb 2005 12:34 PM:</p><div style="margin-left: 1em">Somehow, it made me thinking of a line in a quite funny Swedish poem. (It's dialectal and a semi-phonetic representation.)<br><br>&#197; i &#229;a &#228; e &#246;.<br><br>Why use anything but vowels if you don't have to?<br><br>(&quot;Och i &#229;n &#228;r en &#246;.&quot; is a &quot;normalized&quot; version of that string. From there on, I leave it as an exercise to the reader.)<br><br>(Did you happen to be inspired by the IDN phishing post on Slashdot et al today? I even saw comments linking back to your blog where you talked about it in general terms.)</div>
<p><a id="368659" href="#368659">#</a> <strong>Michael Kaplan</strong> on 7 Feb 2005 12:37 PM:</p><div style="margin-left: 1em">Nah, I had this one planned a week ago (thats when I originally wrote the code!). Though I would like to stay under *that* radar....</div>
<p><a id="368746" href="#368746">#</a> <strong>Dean Harding</strong> on 7 Feb 2005 2:54 PM:</p><div style="margin-left: 1em">I think firefox is rendering the text incorrectly.  When I first looked at this page in firefox I thought &quot;what do you mean, they all look they same - no they don't&quot;.  Then I switched to IE and had a look, and they all *do* look the same.<br><br>To compare:<br>IE: <a target="_new" href="http://www.codeka.com/tmp/norm/ie.png">http://www.codeka.com/tmp/norm/ie.png</a><br>Firefox: <a target="_new" href="http://www.codeka.com/tmp/norm/firefox.png">http://www.codeka.com/tmp/norm/firefox.png</a><br><br>Notice how firefox doesn't seem to be composing the characters properly?  I wonder why that is... perhaps if I could be bothered, I might submit a bug report (unless there already is one).<br><br>I'm always torn between IE and firefox... I switch to one for a while, but then I'll switch back, and then later switch again...</div>
<p><a id="368748" href="#368748">#</a> <strong>Michael Kaplan</strong> on 7 Feb 2005 2:59 PM:</p><div style="margin-left: 1em">Yikes, poor support for Normalization Form D combining marks seems like a pretty bad bug to me!<br><br>Though even IE will mess it up for some fonts -- using <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> can help but using fonts with good info helps even more....<br><br>Probably worth reporting the bug, though. Better international support is always worthwhile (I pointed out many Extension B bugs in Mozilla back in the day).</div>
<p><a id="368925" href="#368925">#</a> <strong>Adi Oltean</strong> on 8 Feb 2005 12:06 AM:</p><div style="margin-left: 1em">How about using the romanian letter ă or Ă<br> (I hope that IE will get this right :-)</div>
<p><a id="368970" href="#368970">#</a> <strong>Dean Harding</strong> on 8 Feb 2005 2:33 AM:</p><div style="margin-left: 1em">Filed bug report: <a target="_new" href="https://bugzilla.mozilla.org/show_bug.cgi?id=281483">https://bugzilla.mozilla.org/show_bug.cgi?id=281483</a><br><br>If you'll note, I tried it on Mozilla when I got home, and it's even worse there (well, arguably so - at least Mozilla was consistent) because it didn't combine any of the Form D characters!</div>
<p><a id="369044" href="#369044">#</a> <strong>bg</strong> on 8 Feb 2005 5:18 AM:</p><div style="margin-left: 1em">&gt; Interesting, no? :-)<br><br>NO ;]</div>
<p><a id="369126" href="#369126">#</a> <strong>Michael Kaplan</strong> on 8 Feb 2005 7:59 AM:</p><div style="margin-left: 1em">Adi -- worked in IE no problem. :-)  I actually just chose the first bunch I saw, I could have included more (I probably would have to if I were building an obfuscator for a big spplication, as even with a factorial number if possiblities it would be a huge name map!<br><br>Cool on the bug, Dean -- maybe they will even fix it (shame they do not use <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> on Win32, but I guess I understand why they choose not to &quot;sully&quot; themselves that way. At least it works in IE!<br><br>bg -- sorry you didn't like it, but I gave up a long time ago trying to please everybody....</div>
<p><a id="369458" href="#369458">#</a> <strong>Dean Harding</strong> on 8 Feb 2005 2:59 PM:</p><div style="margin-left: 1em">Apparently <a title="Uniscribe" href="http://msdn.microsoft.com/library/en-us/intl/uniscrib_35k5.asp" target="_blank">Uniscribe</a> is in the works.  My bug got attached as a dependency to <a target="_new" href="https://bugzilla.mozilla.org/show_bug.cgi?id=218887">https://bugzilla.mozilla.org/show_bug.cgi?id=218887</a> &quot;Use Uniscribe APIs in GFX:Win and layout/editor&quot; so it looks like that's the plan.  Mind you, that one's over a year old, and not much progress in a while... so I'm not holding my breath for a quick fix.</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/18 <a href="http://archives.miloush.net/michkap/archive/2008/09/18/8956650.html">UCS-2 to UTF-16, Part 3: It starts with cursor movement (where MS simultaneously gets better and worse)</a></p><p>2008/07/24 <a href="http://archives.miloush.net/michkap/archive/2008/07/24/8768909.html">When you assess, you make an...</a></p><p>2007/05/09 <a href="http://archives.miloush.net/michkap/archive/2007/05/09/2497106.html">Sometimes you need more than StringInfo</a></p><p>2006/04/11 <a href="http://archives.miloush.net/michkap/archive/2006/04/11/572838.html">Case sensitive Visual Basic!</a></p><p>2005/10/30 <a href="http://archives.miloush.net/michkap/archive/2005/10/30/486838.html">Getting on people's case</a></p><p>2005/10/17 <a href="http://archives.miloush.net/michkap/archive/2005/10/17/481600.html">Comparing Unicode file names the right way</a></p><p>2005/06/28 <a href="http://archives.miloush.net/michkap/archive/2005/06/28/433365.html">The 'grammar' of identifiers</a></p><p>2005/04/29 <a href="http://archives.miloush.net/michkap/archive/2005/04/29/413366.html">Where did the new StringInfo stuff come from?</a></p><p>2005/04/22 <a href="http://archives.miloush.net/michkap/archive/2005/04/22/410797.html">Exposing custom cultures?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/08/369197.html" title="Why ACP != OEMCP (usually)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/06/368232.html" title="15 million lines of Windows code revealed....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/07/368570.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>