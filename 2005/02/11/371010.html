<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/11/371010.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Surrogate pairs and binary (Ordinal) comparisons</title></head><body>
<h1>Surrogate pairs and binary (Ordinal) comparisons</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/11 08:08 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/11/371010.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>If you look at the description of the Ordinal sort in the <A title=CompareOptions href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareoptionsclasstopic.asp" target=_blank>CompareOptions</A> enumeration in the .NET Framework, it seems pretty clear:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2>Indicates that the string comparison must be done using the Unicode values of each character, which is a fast comparison but is culture-insensitive. A string starting with "U+xxxx" comes before a string starting with "U+yyyy", if xxxx is less than yyyy. This flag cannot be combined with other flags and must be used alone.</FONT></P></BLOCKQUOTE>
<P>Now when looking at Unicode characters on the Basic Multilingual Plane (BMP) this seems straightforward enough -- every character from U+0000 to U+FFFF is included and the binary comparison is done on the actual code point values. But what about the rest of Unicode?</P>
<P>All of the characters in Unicode from U+10000 to U+10FFFF must also be in some kind of order (as I mentioned in <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2004/12/29/344136.html">Comparison confusion: INVARIANT vs. ORDINAL</A>, every code point is given weight in an ordinal comparison, even if it is not yet assigned in the standard. And there are two possible&nbsp;ways to handle these characters:</P>
<UL>
<LI>Characters can be sorted by their absolute Unicode code point even when they are actually two Unicode code points deep down (a surrogate pair), or 
<LI>The code points in UTF-16&nbsp;can be sorted themselves and the two&nbsp;code points that make a surrogate pair can be treated as two code points to sort</LI></UL>
<P>The text in the definition of CompareOptions.Ordinal is not very clear on which would be expected, and the definition seems to suggest that Option #1 is what has in fact been done.How else would one read</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2>A string starting with "U+xxxx" comes before a string starting with "U+yyyy", if xxxx is less than yyyy.</FONT></P></BLOCKQUOTE>
<P>if U+xxxxx and U+yyyyy were not handled the same way?</P>
<P>Unfortunately. this guess is incorrect -- the absolute UTF-16 code point values are used. So if one looks at a list like the following:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><STRONG>A</STRONG>&nbsp; <A href="http://www.fileformat.info/info/unicode/char/0041/index.htm">U+0041</A> (LATIN CAPITAL LETTER A)<BR><STRONG>Ã£</STRONG> <A href="http://www.fileformat.info/info/unicode/char/0323/index.htm">U+0323</A> (COMBINING DOT BELOW)<BR><STRONG>ÔøΩ</STRONG> <A href="http://www.fileformat.info/info/unicode/char/fffd/index.htm">U+fffd</A> (REPLACEMENT CHARACTER)<BR>&nbsp; <A href="http://www.fileformat.info/info/unicode/char/ffff/index.htm">U+ffff</A> (not a character in Unicode)<BR><STRONG>êêÄ</STRONG> <A href="http://www.fileformat.info/info/unicode/char/10400/index.htm">U+10400</A> (DESERET CAPITAL LETTER LONG I)<BR><STRONG>°î≥</STRONG> <A href="http://www.fileformat.info/info/unicode/char/21533/index.htm">U+21533</A> (EXTENSION B IDEOGRAPH)</FONT><FONT size=2></P></FONT></BLOCKQUOTE>
<P>and sorts them using CompareOptions.Ordinal they will be sorted as the UTF-16 code points suggest, thus the order would be:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><STRONG>A</STRONG>&nbsp; <A href="http://www.fileformat.info/info/unicode/char/0041/index.htm">U+0041</A> (LATIN CAPITAL LETTER A)<BR><STRONG>Ã£</STRONG> <A href="http://www.fileformat.info/info/unicode/char/0323/index.htm">U+0323</A> (COMBINING DOT BELOW)<BR><STRONG>êêÄ </STRONG><A href="http://www.fileformat.info/info/unicode/char/d801/index.htm">U+d801</A> <A href="http://www.fileformat.info/info/unicode/char/dc00/index.htm">U+dc00</A> (a.k.a. <A href="http://www.fileformat.info/info/unicode/char/10400/index.htm">U+10400</A>, DESERET CAPITAL LETTER LONG I)<BR><STRONG>°î≥</STRONG> <A href="http://www.fileformat.info/info/unicode/char/d845/index.htm">U+d845</A> <A href="http://www.fileformat.info/info/unicode/char/dd33/index.htm">U+dd33</A> (a.k.a. <A href="http://www.fileformat.info/info/unicode/char/21533/index.htm">U+21533</A>, EXTENSION B IDEOGRAPH)<FONT size=2></FONT><BR><STRONG>ÔøΩ </STRONG><A href="http://www.fileformat.info/info/unicode/char/fffd/index.htm">U+fffd</A> (REPLACEMENT CHARACTER)<BR>&nbsp; <A href="http://www.fileformat.info/info/unicode/char/ffff/index.htm">U+ffff</A> (not a character in Unicode)</FONT><FONT size=2></P></BLOCKQUOTE></FONT>
<P>This probably could be clearer in the documentation, though it is not likely to affect people since an Ordinal comparison is by its very nature not meaningful for its actual ordering as it is for having an unambiguous order....</P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by </EM>"<STRONG><FONT size=2>°î≥</FONT></STRONG>"<EM> (a.k.a. <A href="http://www.fileformat.info/info/unicode/char/21533/index.htm">U+21533</A>, an Extension B ideograph)</EM></FONT></P>
<hr/><p><a id="371026" href="#371026">#</a> <strong>Serge Wautier</strong> on 11 Feb 2005 6:31 AM:</p><div style="margin-left: 1em">It could have been worse: A rough WORD sort breaking the surrogate pairs !<br></div>
<p><a id="372134" href="#372134">#</a> <strong>Dmitry Jemerov</strong> on 13 Feb 2005 11:19 PM:</p><div style="margin-left: 1em">Looks like you found a third bug by your blogging...<br><a target="_new" href="http://blogs.jetbrains.com/yole/archives/000035.html">http://blogs.jetbrains.com/yole/archives/000035.html</a><br><br>If it's really a bug in .NET BCL, could you please send it to the appropriate place?</div>
<p><a id="372135" href="#372135">#</a> <strong>Michael Kaplan</strong> on 13 Feb 2005 11:24 PM:</p><div style="margin-left: 1em">What I reported was not a bug (well, maybe a doc bug!). <br><br>What you report is a different issue, and if true it definitely sounds like  bug -- I will forward it on. :-)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/12/371650.html" title="Why/how MSLU came to be, and more">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/10/370460.html" title="Microsoft, you giving us some LIP?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/11/371010.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>