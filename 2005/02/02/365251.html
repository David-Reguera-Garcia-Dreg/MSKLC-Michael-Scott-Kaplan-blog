<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/02/365251.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>CompareString prefers meaningful strings</title></head><body>
<h1>CompareString prefers meaningful strings</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/02 02:26 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/02/365251.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Another reason why international test is not for amateurs....</P>
<P>Like they say at <A href="http://www.despair.com/demotivators/incompetence.html">despair.com</A>: "<EM>When you earnestly believe you can compensate for a lack of skill by doubling your efforts, there's no end to what you can't do</EM>."</P>
<P>It does not tend to be&nbsp;a problem on <STRONG>this</STRONG> team. But when other teams call our APIs, they somehow get it in their head that they should as&nbsp;a part of testing their component they should test the API. And not understanding how the APIs work, they start building random Unicode strings and passing them to <A title=CompareString href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp" target=_blank>CompareString</A>. </P>
<P>Now CompareString is an API that was built to handle actual linguistically meaningful strings, not whatever random crap is generated. And while I will not claim that such a process cannot find problems, I can claim that this is not the sort of core scenario that causes me to lose sleep at night the way genuine bugs that might affect customers will....</P>
<P>An example of this happened over a year ago, in the newsgroups:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>I've found that with certain Unicode strings, CompareStrin&shy;gW seems to be acting very strangey - you get behavior like this: </EM></FONT></P></BLOCKQUOTE>
<P dir=ltr>Strangely is a relative term, especially in a case where you&shy; are randomly generating strings.... </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>A&nbsp;&lt; B&nbsp;<BR>B &lt; C&nbsp;<BR>C &lt; A </EM></FONT></P>
<P><FONT size=2><EM>or even: </EM></FONT>
<P><FONT size=2><EM>A &lt; B&nbsp;<BR>B &lt; A </EM></FONT></P></BLOCKQUOTE>
<P dir=ltr>I will admit that both are not so great. But you have to understand how t&shy;he collation data is created and what it represents. </P>
<P>The goal is to give a way to sort every part of the Unicode &shy;BMP (basic multilingual plane), according to some particular selected l&shy;ocale. Any time a code point is not usefully defined in the table (e.g. it i&shy;s not defined in Unicode, it is not a language/script that Windows has useful&shy; data for, or it is intentionally not given weight), it will not give useful &shy;linguistic information. 
<P>In other words, comparing random crap can give random crap r&shy;esults. :-) <BR></P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>These strings are randomly generated Unicode strings, so i&shy;t may be that the problematic strings contain characters that are e&shy;ither unused&nbsp;or in certain parts of the Unicode space that are reserved&shy; (something similar to the private use space, maybe). &nbsp;So it may be th&shy;at CompareStringW works fine for all real-world strings that &shy;we'd ever encounter. &nbsp;Still, it's a bit unsettling to see CompareStr&shy;ingW return&nbsp;<BR>values that are so obviously wrong. </EM></FONT></P></BLOCKQUOTE>
<P dir=ltr>See above. But I will plow through the examples too, below. </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>A specific example - all three calls to CompareStringW ret&shy;urn CSTR_LESS_THAN: </EM></FONT></P>
<P><FONT size=2><EM>A = <A href="http://www.fileformat.info/info/unicode/char/1b37/index.htm">1B37</A> <A href="http://www.fileformat.info/info/unicode/char/1d96/index.htm">1D96</A> <A href="http://www.fileformat.info/info/unicode/char/4516/index.htm">4516</A>&nbsp;<BR>B = <A href="http://www.fileformat.info/info/unicode/char/30fe/index.htm">30FE</A> <A href="http://www.fileformat.info/info/unicode/char/4113/index.htm">4113</A> <A href="http://www.fileformat.info/info/unicode/char/67be/index.htm">67BE</A>&nbsp;<BR>C = <A href="http://www.fileformat.info/info/unicode/char/0747/index.htm">0747</A> <A href="http://www.fileformat.info/info/unicode/char/4443/index.htm">4443</A> <A href="http://www.fileformat.info/info/unicode/char/40e6/index.htm">40E6</A> </EM></FONT></P>
<P><FONT size=2><EM>Are there any errors here? &nbsp;From what I can tell, the thre&shy;e strings are all legal (null-terminated) UTF-16 strings - they're n&shy;ot&nbsp;ill-formed. </EM></FONT></P></BLOCKQUOTE>
<P dir=ltr>Well, string A is two code points not in the Unicode (which thus have no weight) and an Extension A ideograph (no weight prior to XP, near the end of the table XP and later).</P>
<P dir=ltr>String B starts with a Katakana iteration mark that affects the character before it and which would never start&nbsp;a string, another Extension A ideograph, and a standard CJK ideograph.</P>
<P dir=ltr>String C is made up of a Syriac letter and two more Extension A ideograph.</P>
<P dir=ltr>SUMMARY: All three are nonsense strings and nothing useful can co&shy;me from testing with them. </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>Another example: </EM></FONT></P>
<P><FONT size=2><EM>A = <A href="http://www.fileformat.info/info/unicode/char/0d42/index.htm">0D42</A> <A href="http://www.fileformat.info/info/unicode/char/65f9/index.htm">65F9</A>&nbsp;<BR>B = <A href="http://www.fileformat.info/info/unicode/char/1111/index.htm">1111</A> <A href="http://www.fileformat.info/info/unicode/char/1b4f/index.htm">1B4F </A></EM></FONT></P></BLOCKQUOTE>
<P dir=ltr>String A is a Malayalam character and a CJK ideograph -- two characters &shy;one would never really expect to be together. </P>
<P dir=ltr>String B&nbsp;is a&nbsp;Hangul character and an undefined codepoint -- again not a&shy; valid test. </P>
<BLOCKQUOTE dir=ltr>
<P><FONT size=2><EM>CompareStringW returns that A&lt;B and B&lt;A if I pass in -1 as&shy; the lengths&nbsp;(the documentation states that "if this parameter is any n&shy;egative value, the string is assumed to be null terminated and the&shy; length is calculated automatically"). &nbsp;But if I calculate the length&shy;s of the strings myself and pass those in, then it works proplerly &shy;(A&gt;B and B&lt;A). &nbsp;Passing in the string lengths does not help the cas&shy;e above, however. </EM></FONT></P></BLOCKQUOTE>
<P>Well, this is a type of situation that really is a bug, some&shy;thing that I have been working to correct for future versions -- there si&shy;mply are many cases where if you pass invalid data we handle it oddly, specifically between the -1 and cch cases (which are basically two differ&shy;ent code paths). </P>
<P>The -1 case is designed to not require a string wallk on the&shy; part of the caller (it literally plows the string one sort element at a &shy;time and stops when it knows the answer, and any time the two calls give different results, it is technically a bug (one that I am charged with trying t&shy;o fix! &lt;grin&gt;). The mitigation for the time being is that invalid input is r&shy;equired to give invalid results.... </P>
<P>Now these ARE bugs. And I will look into them, at some point. But it is fair to say that invalid strings really are the last frontier. All of the meaningful bugs come first, though. Because any day where the only people I frustrate are the testers who do not understand what they are testing, I will have no problems looking in the mirror in the morning....</P>
<P>The key? If you want to test CompareString, do so with actual word lists -- made up of actual useful strings in the target languages. Take an article in&nbsp;a target language and the first 200 or 500 words from it. Or get a list from&nbsp;a dictionary. Or from customers. Never generate random word lists that do not match the rules of the language or of Unicode (thinking about those illegal characters!). Work to pass appropriate flags that make sense for the application and the API itself. Do not pass code points not included in the Unicode standard if you are expecting back meaningful results.</P>
<P>And most importantly know what you are testing. If you need to test what the API does to typical strings in your appliction to understand if it is the right API to call, then that is a good idea. But you do not need to test the API itself, unless Microsoft is paying you to do that. The API works, and the important question is whether or not it works for your scenarios.</P>
<P>Another day I will give a good example of a scenario where it does not return the best possible results, and where another API is best considered....</P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by</EM> "ÃŸ" <EM>(<A href="http://www.fileformat.info/info/unicode/char/00df/index.htm">U+00df</A>, a.k.a. LATIN SMALL LETTER SHARP S)<BR><FONT size=1>(which is treated as equal to "SS" on sll platforms, so that German can use the default table with a ton of other languages....)</FONT></EM></FONT></P>
<hr/><p><a id="365627" href="#365627">#</a> <strong>Mike Dunn</strong> on 2 Feb 2005 10:36 AM:</p><div style="margin-left: 1em">&gt;comparing random crap can give random crap results<br> <br>Also known as &quot;GIGO&quot; :)</div>
<p><a id="365650" href="#365650">#</a> <strong>Larry Osterman</strong> on 2 Feb 2005 10:58 AM:</p><div style="margin-left: 1em">I'd noticed that sharp-s and SS comparison worked in the neutral culture, I'd always wondered about that.  Thanks.<br></div>
<p><a id="365654" href="#365654">#</a> <strong>Michael Kaplan</strong> on 2 Feb 2005 11:03 AM:</p><div style="margin-left: 1em">Heh, I have had three different people ping me about the sharp-s issue *yesterday*, no idea why. :-)<br><br>I'll probably blog about it soon, maybe explain some insight to why things are weighed as they are....</div>
<p><a id="365718" href="#365718">#</a> <strong>Michael Kaplan</strong> on 2 Feb 2005 12:24 PM:</p><div style="margin-left: 1em">I'll talk another day about a helpful function you can use to at least know if a string can be meaningfully compared. It does not handle the linguistic aspccts of mixing scripts strangely, but it does handle the code points not in the sorting tables....</div>
<p><a id="365755" href="#365755">#</a> <strong>Guille</strong> on 2 Feb 2005 12:57 PM:</p><div style="margin-left: 1em">Well... Personaly I think this is a typical documentation issue. My thinking is that if a function is capable of returning unconsistent data due to invalid input, an message should be added to the function's doc, like &quot;if the input data doesn't conform to this and that, the results are undefined&quot;. This, which may seem obvious to you, may not be obvious to everyone, and above all such a sentence draws the attention to the fact that not *any* input data is necessary valid, at least from the function's point of view. It is important to keep in mind that many developers that really need to use the operating system's provided function are not familiar with details or structure of any other language than their (or even aware of how many other languages are out there currently in use), so creating random 'Unicode strings' (while in fact they are only random word arrays) may seem their 'obvious' choice.</div>
<p><a id="365757" href="#365757">#</a> <strong>Michael Kaplan</strong> on 2 Feb 2005 1:00 PM:</p><div style="margin-left: 1em">Yep, I'll talk about that idea as well....</div>
<p><a id="365959" href="#365959">#</a> <strong>Brian</strong> on 2 Feb 2005 5:24 PM:</p><div style="margin-left: 1em">It seems to me that given any input, you should avoid claiming that both A &lt; B and B &lt; A.  That this should return 0 and SetLastError() with an appropriate value.  Otherwise, somebody's Maps or Sets are going to get really hosed up by the lack of total ordering, when what they really should be doing is rejecting the key.  Unless there's a way for me to easily verify that a string is valid.<br><br>(my partially uninformed 2 cents)<br><br>Now flaunting my ignorance, why the heck does <a title="CompareString" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp" target="_blank">CompareString</a> take its string arguments as DWORD's?<br><br>(interesting blog, btw)</div>
<p><a id="365965" href="#365965">#</a> <strong>Michael Kaplan</strong> on 2 Feb 2005 5:31 PM:</p><div style="margin-left: 1em">&gt; It seems to me that given any input, you should avoid claiming that both A &lt; B and B &lt; A. <br><br>Agreed -- and it is a bug. However, since its not a mesningful string, it just has a lower priority.<br><br>&gt; Unless there's a way for me to easily verify that a string is valid. <br><br>There is -- tune in later. :-)<br><br>&gt; why the heck does <a title="CompareString" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp" target="_blank">CompareString</a> take its string arguments as DWORD's<br><br>It does not -- it takes two LPWSTRs for its strings.<br><br>&gt; (interesting blog, btw) <br><br>Thanks!<br></div>
<p><a id="366109" href="#366109">#</a> <strong>Jonathan</strong> on 2 Feb 2005 11:35 PM:</p><div style="margin-left: 1em">From the <a title="CompareString" href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/resources/strings/stringreference/stringfunctions/comparestring.asp" target="_blank">CompareString</a> MSDN link:<br><br>int CompareString(          LCID Locale,<br>    DWORD dwCmpFlags,<br>    DWORD lpString1,<br>    DWORD cchCount1,<br>    DWORD lpString2,<br>    DWORD cchCount2<br>);<br><br>I don't have the actual SDK with me at the moment, so I can't check the actual header.</div>
<p><a id="366144" href="#366144">#</a> <strong>Michael Kaplan</strong> on 3 Feb 2005 1:09 AM:</p><div style="margin-left: 1em">This is a doc bug.<br><br>Both lpString1 and lpString2 should be LPCTSTR, and both cchCount1 and cchCount2 should both be int.<br><br>I'll report this to the appropriate people....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/01/12 <a href="http://archives.miloush.net/michkap/archive/2006/01/12/511884.html">The creation of sort keys does not always make sense</a></p><p>2005/06/28 <a href="http://archives.miloush.net/michkap/archive/2005/06/28/433365.html">The 'grammar' of identifiers</a></p><p>2005/05/05 <a href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html">A few of the gotchas of CompareString</a></p><p>2005/02/03 <a href="http://archives.miloush.net/michkap/archive/2005/02/03/366145.html">What makes a string meaningful?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/02/365993.html" title="Doing a little more in Sri Lanka....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/02/365237.html" title="Handling shortcuts and accelerators in a real world situation">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/02/365251.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>