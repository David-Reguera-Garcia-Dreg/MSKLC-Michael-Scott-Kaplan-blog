<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/18/376225.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Ready... set... Reboot!</title></head><body>
<h1>Ready... set... Reboot!</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/18 13:02 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/18/376225.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>When you change the default system locale (cf: <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279997.html">Windows 2000</A>, <a href="http://archives.miloush.net/michkap/archive/2004/12/11/279998.html">Windows XP/Server 2003</A>), you have to reboot your machine.</P>
<P>"But no, Michael," some say, "if I use the method described in <A href="http://support.microsoft.com/default.aspx?scid=kb;en-us;289125">that KB article</A> I am not prompted to reboot!"</P>
<P>Well, that is true. And I was imprecise. You can&nbsp;<EM>change</EM> the setting at will. You can even say&nbsp;"no" to that reboot dialog that pops up in the user interface of Regional and Language Options.&nbsp;But the default system locale has not changed, either.</P>
<P>The problem has to do with when the data is read from the disk. It is actually read by the NT Boot Loader, in real mode. Now the boot loader does not need the data, but it has to load it early. Because there may be drivers that need to do conversions even before the disk drive is available in virtual mode. </P>
<P>Of course this argument becomes less interesting as time goes on since most drivers are written to use Unicode these days. Because most of the APIs they call are Unicode. No one in a low-level driver wants to take the performance hit of converting their strings to Unicode on a regular basis; its easier to just use Unicode to start with, most of the time. Driver writers are particularly sensitive to performance issues here....</P>
<P>Maybe one day they will cut the cord here and say no to non-Unicode components in kernel mode. But I doubt that would happen any time soon since it is hard to tell people that drivers will not work at all. Especially if they do not ever do anything with strings that need to use any of the benefits of Unicode other than this one performance benefit (in which case the benefit&nbsp;is unfortunately mitigated by doubling the data size requirement).</P>
<P>Plus, changing the default system code page of applications out from under them is pretty problematic anyway, and I would not really want to see all of the potential data corruption bugs <EM>that</EM> could cause.</P>
<P>It is an interesting problem, one that does its best to defy solutions and runs us head-on into battles of backwards compatibility versus best practices. </P>
<P>I'm curious, though. </P>
<P>I realize that my audience may be really biased on the question of <STRONG>Unicodality</STRONG> of drivers and of kernel mode, but what do people out there think?</P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>Brought to you by </EM>"á¿·"<EM> (<A href="http://www.fileformat.info/info/unicode/char/1ff7/index.htm">U+1ff7</A>, a.k.a. GREEK SMALL LETTER OMEGA WITH PERISPOMENI AND YPOGEGRAMMENI)<BR><FONT size=1>One of the over 50,000 graphic characters on the BMP (Basic Multilingual Plane of Unicode) that will not fit into ASCII)</FONT></EM></FONT></P>
<hr/><p><a id="376275" href="#376275">#</a> <strong>Klaus H. Probst</strong> on 18 Feb 2005 12:39 PM:</p><div style="margin-left: 1em">Anything written for NT-class systems should be exclusively Unicode. Anything written for Win 9x should not be written. So you see, it's not so much about encoding but about getting rid of Win9x =)</div>
<p><a id="376325" href="#376325">#</a> <strong>Larry Osterman</strong> on 18 Feb 2005 2:00 PM:</p><div style="margin-left: 1em">How about cutting the cord for Win64 kernel drivers?<br><br>That would provide an incentive for all driver authors....<br><br><br></div>
<p><a id="377314" href="#377314">#</a> <strong>AndyM</strong> on 21 Feb 2005 6:14 AM:</p><div style="margin-left: 1em">Requireing unicode exclusively for drivers is a problem, as you cannot use e.g. DbgPrint() from DISPATCH_LEVEL with Unicode substitutions (the tables are pageable). Pageable code/data cannot be accessed at DISPATCH_LEVEL or above, so using Unicode in DPCs, timers etc gives you a blue screen....</div>
<p><a id="377322" href="#377322">#</a> <strong>Michael Kaplan</strong> on 21 Feb 2005 6:23 AM:</p><div style="margin-left: 1em">Actually, the ACP/OEMCP are currently loaded by the executive in non-paged pool. :-)<br><br>But note that in theory a Unicode driver can still call non-Unicode functions when they want to (povided that the OS will not need to convert what they sednd, eventually).... it just means that by and large they are using Unicode.</div>
<p><a id="377333" href="#377333">#</a> <strong>AndyM</strong> on 21 Feb 2005 6:50 AM:</p><div style="margin-left: 1em">I don't know about ACP/OEMCP stuff - I write drivers.<br>My comment was more that DbgPrint() and friends are not safe to use at elevated IRQL. Until that is fixed, we cannot use Unicode exclusively.<br>Search MSDN or the DDK for DbgPrint() for details.<br></div>
<p><a id="377340" href="#377340">#</a> <strong>Michael Kaplan</strong> on 21 Feb 2005 7:01 AM:</p><div style="margin-left: 1em">The ACP/OEMCP are the code pages that will convert your call to Unicode.<br><br>I think you are referring to topics like <a target="_new" href="http://msdn.microsoft.com/library/en-us/ddtools/hh/ddtools/DebugFns_5e11bbcc-adc2-46c0-b371-0e54c50bb2dc.xml.asp">http://msdn.microsoft.com/library/en-us/ddtools/hh/ddtools/DebugFns_5e11bbcc-adc2-46c0-b371-0e54c50bb2dc.xml.asp</a> :<br><br>&quot;The Format string supports all the printf-style formatting codes. However, the Unicode format codes (%C, %S, %lc, %ls, %wc, %ws, and %wZ) can only be used with IRQL = PASSIVE_LEVEL. &quot;<br><br>But like I said, you can still call DbgPrint without being Unicode otherwise. And when I am debugging code in NTSD or KD or WinDbg it is easier to look at Unicode strings by looking at the data as WORDs anyway. <br><br>The ability to insert Unicode into DbgPrint or KdPrint calls is not nearly as important as making sure the core driver itself uses Unicode.</div>
<p><a id="377343" href="#377343">#</a> <strong>Michael Kaplan</strong> on 21 Feb 2005 7:11 AM:</p><div style="margin-left: 1em">(received this on in email from someone else)<br><br>---------------<br>Of course the real fix here would be a DbgPrintW and KdPrintW -- Unicode inserts are no problem if the string being inserted into is Unicode.<br>---------------<br><br>This is true. <br><br>Now the reason that these functions have nothing to do with the code page tables being pageable (they are not, though some would argue they ought to be).</div>
<p><a id="377494" href="#377494">#</a> <strong>Michael Kaplan</strong> on 21 Feb 2005 11:03 AM:</p><div style="margin-left: 1em">Ok, clarification time!<br><br>Someone from the driver team pointed out to me that although the tables are in NPP, the code itslf is paged. Since the only confirmed user of this comversion code in kernel mode is indeed DbgPrint, et. al., there is not really much of a reason to add the &quot;W&quot; versions.<br><br>Of course everyone *ought* be using WPP rather than DbgPrint anyway, right? :-)</div>
<p><a id="378058" href="#378058">#</a> <strong>AndyM</strong> on 22 Feb 2005 7:55 AM:</p><div style="margin-left: 1em">&quot;Of course everyone *ought* be using WPP rather than DbgPrint anyway, right? :-)&quot;<br><br>Lucky there's a smiley there. To get WPP working you need to jump through a lot of hoops, put up with wildly gratuitous incompatibilities between Win2k and newer OS'es, jump through even more hoops to get it to do anything in NDIS, and then realise that the documentation is minimal to say the least...<br><br>There is the kernel of a good idea in WPP, but it's so much harder work that rolling your own from scratch that needs a fair bit of work before it's useful.<br><br>I'll stop venting now. :-)</div>
<p><a id="6822432" href="#6822432">#</a> <strong>Emma</strong> on 20 Dec 2007 7:47 PM:</p><div style="margin-left: 1em"><p>I'm having problem whenever my system restarts or &quot;reboot&quot; my desktop doesn't show up. &nbsp;All I can do is task manager. &nbsp;I have to log on and off at least 10 times until everything shows up. &nbsp;Most of the time, when my screen boots up.. its just blank.. just my wallpaper. &nbsp;Theres nothing... no START.. nothing.. what should I do? sometimes I wait and leave my computer for an hour to see if it will show up.. but it doesn't. &nbsp;I NEED HELP!</p></div>
<p><a id="6822523" href="#6822523">#</a> <strong>Michael S. Kaplan</strong> on 20 Dec 2007 7:57 PM:</p><div style="margin-left: 1em"><p>Not much to do with international settings in general or the default system locale in particular, right? Not a whole lot I could add (well, other than maybe trying File|Run from Task Manager and running EXPLORER.EXE, I guess). Sorry....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/10/28 <a href="http://archives.miloush.net/michkap/archive/2008/10/28/9020410.html">Ready... set... Reboot Redux, part Deux!</a></p><p>2007/07/29 <a href="http://archives.miloush.net/michkap/archive/2007/07/29/4117994.html">A difference that makes no difference, makes no difference (aka IRQL <= APC_LEVEL vs IRQL < DISPATCH_LEVEL)</a></p><p>2006/09/19 <a href="http://archives.miloush.net/michkap/archive/2006/09/19/761547.html">Ready... set... Don't Reboot!</a></p><p>2005/12/12 <a href="http://archives.miloush.net/michkap/archive/2005/12/12/502463.html">Ready... set... Reboot Redux</a></p><p>2005/11/09 <a href="http://archives.miloush.net/michkap/archive/2005/11/09/490791.html">Getting around the default system locale</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/19/376607.html" title="Challenges behind MSLU: The hardest API to wrap">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/18/376009.html" title="GetHashCode vs. Compare vs. SortKey">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/18/376225.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>