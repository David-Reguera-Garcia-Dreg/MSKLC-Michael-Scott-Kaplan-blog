<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/22/377992.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The ShellExecuteEx wrapper in MSLU</title></head><body>
<h1>The ShellExecuteEx wrapper in MSLU</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/22 08:14 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/22/377992.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The ShellExecuteEx wrapper in <A title=MSLU href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target=_blank>MSLU</A> is a little bit broken.</P>
<P>Recently posted to the microsoft.public.platformsdk.mslayerforunicode:</P>
<BLOCKQUOTE dir=ltr><FONT size=2><EM>
<P><FONT size=2><EM>The code looks a bit like this:</EM></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>TCHAR filename[MAX_PATH];<BR>TCHAR paramStr[MAX_PATH];<BR>_tcscpy (filename, _T("C:\myapp.exe"));<BR>_tcscpy(paramStr, _T("params"));</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>[...]</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>SHELLEXECUTEINFO ShExecInfo;<BR>ShExecInfo.cbSize = sizeof(SHELLEXECUTEINFO);<BR>ShExecInfo.fMask = SEE_MASK_NOCLOSEPROCESS;<BR>ShExecInfo.hwnd = NULL;<BR>ShExecInfo.lpVerb = NULL;<BR>ShExecInfo.lpFile = filename;<BR>ShExecInfo.lpParameters = paramStr;<BR>ShExecInfo.lpDirectory = NULL;<BR>ShExecInfo.nShow = SW_HIDE;<BR>ShExecInfo.hInstApp = NULL;</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>BOOL bExec = ShellExecuteEx(&amp;ShExecInfo);</STRONG></FONT></P>
<P><FONT size=2><EM>And it crashes within the ShellExecuteEx() call. I should also mention that this does not happen with every parameter string. However, I experimented a bit further, and found that the crash goes away if I initialize the SHELLEXECUTEINFO structure to zero, ie:</EM></FONT></P>
<P><FONT size=2>SHELLEXECUTEINFO ShExecInfo = {0};</FONT></P>
<P><FONT size=2><EM>Not really sure why or if this truely fixes the problem, but hopefully it'll prevent the crash.</EM></FONT></EM></FONT></P></BLOCKQUOTE>
<P>Well, his workaround works, and quite well at that. And it is indeed&nbsp;an MSLU bug.</P>
<P>The problem? Well, MSLU is a tad over-eager, converting every string in the struct. Despite the fact that there are flags that one can pass to the API that limit which strings are valid. Obviously the NULL case works well, but the case where it is not NULL due to the memory not being initialized? Not so lucky there -- and the crash happens.</P>
<P>The workaround? Simple, as given above -- just initialize the SHELLEXECUTEINFO struct.</P>
<P>Obviously not a great answer, but so few reports over these past few years and who knows how many downloads? It is on the list as something that could be fixed if there is a future release, but looking at the <A href="http://support.microsoft.com/default.aspx?scid=fh;[ln];LifeWin">Product Life-Cycle Information</A> for Win9x. Obviously given all this and the fact that all Win9x platforms are in paid support phases (or no longer supported), the bar has to go up for MSLU fixes. It was over a year since the release before last (1.0.4018.0) to the most recent release (1.1.3790.0), and there are currently no bugs that meet the bar of <EM>not reasonably fixable by developers using MSLU</EM>. </P>
<P>I'm not expecting this to be the most popular decision with which I have ever been involved, but nearly four years after its release, the bulk of the bugs that have been reported have been fixed, and things have been slowing down for a while now.</P>
<P>So let's take a look at the infomation about overriding MSLU APIs. It is discussed <A href="http://msdn.microsoft.com/msdnmag/issues/01/10/MSLU/">here</A>&nbsp;and <A href="http://msdn.microsoft.com/library/en-us/mslu/winprog/overriding_an_api_in_the_microsoft_layer_for_unicode.asp">here</A>&nbsp;and with samples <A href="http://msdn.microsoft.com/library/en-us/mslu/winprog/sample_code_to_override_an_api_in_the_microsoft_layer_for_unicode.asp">here</A> and <A href="http://www.trigeminal.com/usenet/usenet032.asp">here</A>. Any time one does not like a wrapper provided by MSLU, one can override it. Inside that override, one can even use LoadLibrary/GetProcAddress to call the MSLU API eventually. Such as after making sure to clear out unused fields in a SHELLEXECUTEINFO struct. :-)</P>
<P>I'm still around, I still watch the microsoft.public.platformsdk.mslayerforunicode newsgroup, and I still will post stuff here when it might be of interest....<BR></P>
<P><FONT color=#800080><EM>This post brought to you by</EM> "â‚¯" <EM>(<A href="http://www.fileformat.info/info/unicode/char/20af/index.htm">U+20af</A>, a.k.a. DRACHMA SIGN)</EM></FONT></P>
<hr/><p><a id="378166" href="#378166">#</a> <strong>Mike Dunn</strong> on 22 Feb 2005 10:28 AM:</p><div style="margin-left: 1em">This just reinforces the good practice of always zero-initializing your structs. I often see questions from people who are having trouble with a list or tree control, and many times their code can be fixed by zeroing the structs that are passed to the control (LVITEM, TVINSERTSTRUCT, etc).</div>
<p><a id="378624" href="#378624">#</a> <strong>Michael Kaplan</strong> on 22 Feb 2005 9:43 PM:</p><div style="margin-left: 1em">That is very true -- and a point that people usually do not take into account when looking at the problem. :-)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/22/378523.html" title="The many faces of CultureInfo">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/21/377288.html" title="Give me a [word-]break!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/22/377992.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>