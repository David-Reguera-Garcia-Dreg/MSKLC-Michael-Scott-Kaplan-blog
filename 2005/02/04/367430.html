<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/04/367430.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When MSLU meets ATL or WTL</title></head><body>
<h1>When MSLU meets ATL or WTL</h1>
<p><em>by Michael S. Kaplan, published on 2005/02/04 16:09 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/02/04/367430.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT size=2><EM>(originally posted elsewhere back in March of 2002)</EM></FONT></P>
<P>If you are using the <A title="Microsoft Layer for Unicode" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target=_blank>Microsoft Layer for Unicode</A> on Windows 95/98/Me Systems (MSLU) in a project that uses ATL or WTL, there are some things you need to do to make it work. </P>
<BLOCKQUOTE dir=ltr>
<P>1) Avoid the _ATL_MIN_CRT macro -- this macro appears to be incompatible with <A title=MSLU href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target=_blank>MSLU</A>.</P>
<P>2) Problems with garbage text in window title bars -- It is a problem with the usage of ::DefWindowProc and ::CallWindowProc in ATL and WTL.&nbsp; The way to correct this problem is to at the very start of your program (before any ATL/WTL windowing code is called) add the following code: </P>
<P><FONT face="Courier New">//<BR>// Resolve UNICOWS's thunk (required)<BR>//<BR>::DefWindowProc (NULL, 0, 0, 0);</FONT></P>
<P>Tim Smith explained it best: </P>
<BLOCKQUOTE dir=ltr>
<P><EM><FONT size=2>The problem is that if you create an ATL window prior to ::DefWindowProc being called, then m_pfnSuperWindowProc points to the thunk [in the loader] and not the resolved address.&nbsp; Then when ATL passes m_pfnSuperWindowProc into ::CallWindowProc as part of the WM_SETTEXT message, MSLU doesn't realize that it is being passed [its own] ::DefWindowProc and thus does an extra level of text conversion.&nbsp; By invoking ::DefWindowProc at the start of the program, then when ATL creates a window and stores the address of ::DefWindowProc in m_pfnSuperWindowProc, it is storing the address of the MSLU routine that the MSLU ::CallWindowProc realizes does not need conversion.&nbsp; In general, if you are using ATL/WTL, just add that line of code at the start of your program and be done with it.&nbsp; It also should be added to any DLL that uses ATL windows [which have the same issue].</FONT></EM></P></BLOCKQUOTE>
<P>Please note that the above issue has been addressed in WTL 7.0 and thus only applies to earlier versions of WTL. </P></BLOCKQUOTE>
<P>The preceeding is what was posted back in March of 2002; what follows is new.</P>
<P>Back in July of 2004, a developer at Microsoft was looking around rather frantically for the dev. owner of MSLU (a job not made easier by the fact that all of the references are to my old vendor alias rather than my new FTE one). When he finally found me, he had the following report:</P>
<BLOCKQUOTE dir=ltr>
<P><EM><FONT size=2>Hi there, I’m hitting an a/v in unicows.dll that only happens under win98 (not winME) . Where can I get sources so I can see exactly what’s going on? </FONT></EM></P>
<P><EM><FONT size=2>...this is for the msn installer; we’re using the official release, version 1.0.4018.0.</FONT></EM></P></BLOCKQUOTE>
<P>I knew this was a smart guy<FONT size=1><SUP>1</SUP></FONT> and thought I would try to assist him rather than makr him try to set up source debugging for unicows.dll. I asked for the callstack with the AV, and he quickly got it to me:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=1>unicows.dll!_gwcslen()&nbsp; + 0x11<BR><FONT face="Courier New" size=1>unicows.dll!_GodotToCpgCchOnHeap@20</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x21 <BR></FONT><FONT face="Courier New" size=1>unicows.dll!_GodotTransmitMessage@44</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x1c2 <BR></FONT><FONT face="Courier New" size=1>unicows.dll!_GodotDefWindowProcW@16</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x2d&nbsp; <BR>KERNEL32.DLL!bff958f8()&nbsp;&nbsp; <BR></FONT><FONT face="Courier New" size=1>unicows.dll!_GodotTransmitMessage@44</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x1ed <BR></FONT><FONT face="Courier New" size=1>unicows.dll!_GodotCallWindowProcW@20</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x52 <BR>msninst.dll!ATL::CWindowImplBaseT&lt;ATL::CWindow,ATL::CWinTraits&lt;1442840576,0&gt; &gt;::WindowProc(HWND__ * hWnd=0x01924240, unsigned int uMsg=129, unsigned int wParam=0, long lParam=5889640)&nbsp; Line 3020 + 0x13&nbsp;&nbsp; C++<BR>msninst.dll!ATL::CWindowImplBaseT&lt;ATL::CWindow,ATL::CWinTraits&lt;1442840576,0&gt; &gt;::StartWindowProc(HWND__ * hWnd=0x0000055c, unsigned int uMsg=129, unsigned int wParam=0, long lParam=5889640)&nbsp; Line 2999 + 0xf&nbsp; C++<BR></FONT><FONT face="Courier New" size=1>unicows.dll!_GodotDoCallback@28</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x1a5&nbsp; <BR></FONT><FONT face="Courier New" size=1>unicows.dll!_WindowProc@16</FONT><FONT face="Courier New" size=1>()&nbsp; + 0x2a&nbsp;&nbsp; <BR>KERNEL32.DLL!bff7363b()&nbsp; <BR>KERNEL32.DLL!bff94407()&nbsp; <BR>KERNEL32.DLL!bff719b8()&nbsp; <BR>msninst.dll!ATL::CWindowImplBaseT&lt;ATL::CWindow,ATL::CWinTraits&lt;1442840576,0&gt; &gt;::Create(HWND__ * hWndParent=0x00000000, ATL::_U_RECT rect={...}, const unsigned short * szWindowName=0x27284008, unsigned long dwStyle=2147483648, unsigned long dwExStyle=0, ATL::_U_MENUorID MenuOrID={...}, unsigned short atom=49905, void * lpCreateParam=0x00000000)&nbsp; Line 3063&nbsp; C++<BR>msninst.dll!ATL::CWindowImpl&lt;CMsnInstaller,ATL::CWindow,ATL::CWinTraits&lt;1442840576,0&gt; &gt;::Create(HWND__ * hWndParent=0x00000000, ATL::_U_RECT rect={...}, const unsigned short * szWindowName=0x27284008, unsigned long dwStyle=2147483648, unsigned long dwExStyle=0, ATL::_U_MENUorID MenuOrID={...}, void * lpCreateParam=0x00000000)&nbsp; Line 3135 + 0x1d&nbsp;&nbsp; C++<BR>msninst.dll!CMsnInstaller::FinalConstruct()&nbsp; Line 87&nbsp; C++<BR>msninst.dll!ATL::CComCreator&lt;ATL::CComObject&lt;CMsnInstaller&gt; &gt;::CreateInstance(void * pv=0x00000000, const _GUID &amp; riid={...}, void * * ppv=0x0059e4e0)&nbsp; Line 1764 + 0x7C++<BR>msninst.dll!ATL::CComCreator2&lt;ATL::CComCreator&lt;ATL::CComObject&lt;CMsnInstaller&gt; &gt;,ATL::CComCreator&lt;ATL::CComAggObject&lt;CMsnInstaller&gt; &gt; &gt;::CreateInstance(void * pv=0x00000000, const _GUID &amp; riid={...}, void * * ppv=0x0059e4e0)&nbsp; Line 1833C++<BR>msninst.dll!ATL::CComClassFactory::CreateInstance(IUnknown * pUnkOuter=0x00000000, const _GUID &amp; riid={...}, void * * ppvObj=0x0059e4e0)&nbsp; Line 3183 C++<BR>OLE32.DLL!7ff2cb20()</FONT></FONT></P></BLOCKQUOTE>
<P dir=ltr>Geek that I am, I suddenly knew what the bug was, but was completely wrong. However, after one guess I was right, it was the same bug as above. </P>
<P>Only now instead of messing up window text it was crashing!</P>
<P>He was able to implement the workaround and all was good.</P>
<P>Now I have actually tried in the past to get the ATL folks to make the same change that Nenad Stefanovic agreed to made in WTL 7.0, but they have refused (usually for for two reasons):</P>
<OL>
<LI>Its kind of a messy hack which most people never have to deal with; 
<LI>The Win9x platform is not going to be supported much longer anyway</LI></OL>
<P>Now they do own their library and I would probably resent it if they told me how to write MSLU so we have agreed to disagree. Though if any ATL folks wanted to reconsider the issue now that an internal dev has run into a crash bug caused by it, feel free to ping me offline and I can provide details on issue. :-)</P>
<P>&nbsp;</P>
<P><EM><FONT size=1>1 - It always annoys me a little when people call a crash a "GPF" since we have not really had general protection faults (GPF) for quite some time due to virtual memory. We have AVs (access violations) and IPFs (invalid page faults), but GPFs are pretty hard to come by. I mentally tag people who are more careful about their language a being a bit smarter, perhaps unfairly but at least consistently.</FONT></EM></P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by </EM>"<FONT size=3>℠</FONT>"<EM> (<A href="http://www.fileformat.info/info/unicode/char/2120/index.htm">U+2120</A>, SERVICE MARK)</EM></FONT></P>
<hr/><p><a id="367467" href="#367467">#</a> <strong>Jonathan</strong> on 4 Feb 2005 3:25 PM:</p><div style="margin-left: 1em">Godot? Was that the code name for <a title="MSLU" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target="_blank">MSLU</a>?</div>
<p><a id="367490" href="#367490">#</a> <strong>Samuel Beckett (actually, Michael Kaplan)</strong> on 4 Feb 2005 4:17 PM:</p><div style="margin-left: 1em">Indeed, it was!</div>
<p><strong>Yuhong Bao</strong> on 4 Jan 2008 4:12 PM:</p><div style="margin-left: 1em"><p>Actual GPFs can still happen on x86 and x64 processors, but they are more rare in Win32 and does not exist on any other arch.</p></div>
<p><strong>Michael S. Kaplan</strong> on 4 Jan 2008 4:29 PM:</p><div style="margin-left: 1em"><p>Yes, that is why the footnote says &quot;but GPFs are pretty hard to come by&quot;.</p>
<p>:-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/02/05/367666.html" title="You can&#39;t ignore diacritics when a language does not give them diacritic weight">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/02/04/366922.html" title="GEOID -- The LCIDs maligned little brother....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-02-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/02/04/367430.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>