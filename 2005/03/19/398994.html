<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/19/398994.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Impersonation and NLS</title></head><body>
<h1>Impersonation and NLS</h1>
<p><em>by Michael S. Kaplan, published on 2005/03/19 02:16 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/03/19/398994.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>There are a lot of people who get confused (and then subsequently complain in public fora or to product support or&nbsp;wherever!) about the topic&nbsp;of using impersonation and NLS functionality, so I thought it might be good to explain what is happening.</P>
<P>Common complaints go something like this:</P>
<BLOCKQUOTE dir=ltr>
<P>An application uses IIS to provide an administrative interface to a terminal server. They use impersonation to run with the permission of the user and then they use the <A title=SetLocaleInfo href="http://msdn.microsoft.com/library/en-us/intl/nls_7w1b.asp" target=_blank>SetLocaleInfo</A> API (or they modify the values under the <STRONG>HKCU\Control Panel\International</STRONG> key) to change user locale overrides. Code then run in VB or other languages seems to pick up the settings just fine while they run as the user. Yet the changes never seem to stick for that user and are gone for any subsequent login of them.</P>
<P>The same problems seems to only happen sometimes with the Win32 <A title=CreateProcessAsUser href="http://msdn.microsoft.com/library/en-us/dllproc/base/createprocessasuser.asp" target=_blank>CreateProcessAsUser</A>/<A href="http://msdn.microsoft.com/library/en-us/dllproc/base/createprocesswithlogonw.asp">CreateProcessWithLogonW</A> APIs and .NET WindowsIdentity.Impersonate() method -- sometimes settings changes work, other times they do not. A clear pattern does not seem immediately evident....</P>
<P>The problem never seems to occur when the RunAs utility is used to start a process.</P></BLOCKQUOTE>
<P>Believe it or not, there is a a single, simple explanation that covers all of these behaviors. You might even know what is after looking at all of the above cases, side by side.</P>
<P>The problem has to do with whether the the registry profile of the specified user is loaded and available!</P>
<P>When the profile is loaded and available, then any call to open subkeys under the HKEY_CURRENT_USER registry key will be mapped to the appropriate entry for that user. This is where the locale overrides in the registry referred to above&nbsp;happen to be currently&nbsp;located. These entries are the ones that the SetLocaleInfo API modifies when it is called. Life is easy and everything works.</P>
<P>However, when the profile is not loaded, or if the profile is not available to the impersonated token (due to the impersonation level permissions), then called to open subkeys under the HKEY_CURRENT_USER registry key will actually load the Subkey belonging to the user doing the impersonation. <EM>That</EM> user's settings will then be modified and thus even though you will see NLS functions like <A title=GetDateFormat href="http://msdn.microsoft.com/library/en-us/intl/nls_5w6s.asp" target=_blank>GetDateFormat</A> or <A title=GetLocaleInfo href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp" target=_blank>GetLocaleInfo</A> seem to work with the changes, none of the changes will be persisted under the current user.</P>
<P>The issue is straightforward enough to work around -- just make sure that you have called the <A title=LoadUserProfile href="http://msdn.microsoft.com/library/en-us/policy/policy/loaduserprofile.asp" target=_blank>LoadUserProfile</A> API prior to calling any of those non-RunAs methods. And then make sure that the impersonation method used gives enough permission to&nbsp;look at the registry subkey. </P>
<P>Of course this method comes with a price -- there is&nbsp;a performance hit to doing it. Which is one of the reasons why impersonation, which does not always need the profile to be loaded, does not always go through these extra steps.</P>
<P>Though I hope that one day this is clear enough in the documentation that people will not be so often confused by the results they see....</P>
<P>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post sponsored by</EM> "ï´¿" <EM>(<A href="http://www.fileformat.info/info/unicode/char/fd3f/index.htm">U+fd3f</A>, a.k.a.&nbsp;ORNATE RIGHT PARENTHESIS)</EM></FONT></P>
<hr/><p><a id="399597" href="#399597">#</a> <strong>Pavel Lebedinsky</strong> on 21 Mar 2005 12:27 AM:</p><div style="margin-left: 1em">&gt; or they modify the values under the HKCU\Control Panel\International<br><br>People who are doing these things from a service are usually not aware of the fact that they have to call RegOpenCurrentUser instead of just using HKCU. This can also lead to all kinds of weird problems.</div>
<p><a id="410981" href="#410981">#</a> <strong>Michael S. Kaplan</strong> on 22 Apr 2005 6:55 PM:</p><div style="margin-left: 1em">Pavel, this is an excellent point. People do not realize that this API is needed for the impersonation case (though not for the RunAs case).</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/03/19 <a href="http://archives.miloush.net/michkap/archive/2010/03/19/9980203.html">Strange how unsympathetic I was, until I was suddenly quite sympathetic</a></p><p>2007/08/08 <a href="http://archives.miloush.net/michkap/archive/2007/08/08/4291958.html">The user locale of the system account is not the system locale</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/03/20/399322.html" title="Font substitution and linking #1">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/03/18/398967.html" title="The picture of me is unlikely to change">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03-19">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/19/398994.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>