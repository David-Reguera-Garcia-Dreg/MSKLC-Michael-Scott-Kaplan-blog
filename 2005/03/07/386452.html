<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/07/386452.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A bug with the new oleaut32.dll calendar support and VB, VBA, and VBScript</title></head><body>
<h1>A bug with the new oleaut32.dll calendar support and VB, VBA, and VBScript</h1>
<p><em>by Michael S. Kaplan, published on 2005/03/07 02:02 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/03/07/386452.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT color=#ff0000 size=2>(Recycling some electrons for a fun bug that can still be reproduced in the latest versions and service packs of VB and VBA &lt;= 6.x (despite all the pressure I was able to muster in my position of unimportance!). To see this article in Thai, go to <a href="http://archives.miloush.net/michkap/archive/2005/03/07/386453.html">http://blogs.msdn.com/michkap/archive/2005/03/07/386453.aspx</A>)</FONT></P>
<P><STRONG>A bug with the new oleaut32.dll calendar support and VB, VBA, and VBScript</STRONG> <BR><I>(Originally posted 4/9/2000)</I> </P>
<BLOCKQUOTE>The new version OLEAUT32.DLL (2.40.4512.1) that ships with Windows 2000 has added support for the Thai calendar (previously it had only supported Gregorian and Hijri dates, which is all VB supports). There is an initial problem that although the DLL contains the support and MSDN documents the new capability, the platform SDK does not contain the latest header files, so you can't actually use the feature. Here are those values (which should be there for the next platform SDK in July 2000): <FONT color=#000099><PRE>#define VARIANT_CALENDAR_THAI 0x20 // SOUTHASIA calendar support <BR>#define VARIANT_CALENDAR_GREGORIAN 0x40 // SOUTHASIA calendar support</FONT></PRE>
<P>Ok, you can use the feature! Now for the bug: </P>
<P>When you have this new oleaut32.dll on either a Thai Win95/Win98/NT4 machine or a US Windows 2000 machine with Thai regional settings, COM will recognize that the Thai calander is the one to use. Unfortunately, VBA and VBScript do not understand the concept of Thai dates, so they will both assume that dates like 9/4/2543 (the Thai equivalent of April 9th, 2000) is simply a very futuristic Gregorian date. Suddenly, any code you have to display dates is going to look like everything is 543 years in the future! And if your users do not type in dates that 543 years ahead, the incorrect date will then be used by your application. 
<P>The problem is slightly worse if you use Hijri dates, which are approximately 600 years prior to Gregorian dates. Everything will seem to be way off. I am not sure how VBA is actually calculating Hijri dates, but if they are asking COM to do it, they are not properly identifying the source date as being in Thai, since it seems to think that the date is 5/1/1964 rather than the proper Hijri date, 1/5/1421. There is even more potential for corruption here, since the date does not correspond to any date that a user would understand (as opposed to the Thai date, which presumably a user who has Thai regional settings would understand). 
<P>The real fix is obviously for VBA to have a mechanism for its date handling that uses whatever COM has available to it, rather than being hardcoded to accept only two date types when COM will now support three. To workaround this bug, you need to call the VariantChangeTypeEx function to convert a date to a Gregorian date string and a Gregorian date string back into a date. The declaration of that function and relevant constants are: <FONT color=#000099><PRE>Private Const VARIANT_NOUSEROVERRIDE = &amp;H4 <BR>Private Const VARIANT_CALENDAR_HIJRI = &amp;H8 <BR>Private Const VARIANT_CALENDAR_THAI = &amp;H20 <BR>Private Const VARIANT_CALENDAR_GREGORIAN = &amp;H40 <BR>Declare Function VariantChangeTypeEx _<BR> Lib "oleaut32.dll" _<BR> (ByRef pvargDest As Variant, _<BR> ByRef pvarSrc As Variant, _<BR> ByVal lcid As Long, _<BR> ByVal wFlags As Integer, _<BR> ByVal vt As VbVarType) As Long</FONT></PRE>
<P>and you can use the following procedure (<I><B>if you have the new oleaut32.dll only!</B></I>) to test this out: <FONT color=#000099></P><PRE>Sub TestDateFormats()<BR> Dim vSrc As Variant<BR> Dim vDst As Variant<BR><BR> vSrc = Date <BR> Call VariantChangeTypeEx(vDst, vSrc, 1033, VARIANT_CALENDAR_GREGORIAN, vbString)<BR> Debug.Print "Gregorian date: " &amp; vDst<BR> Call VariantChangeTypeEx(vDst, vSrc, 1025, VARIANT_CALENDAR_HIJRI, vbString)<BR> Debug.Print "Hijri date: " &amp; vDst<BR> Call VariantChangeTypeEx(vDst, vSrc, 1054, VARIANT_CALENDAR_THAI, vbString)<BR> Debug.Print "Thai date: " &amp; vDst <BR>End Sub</FONT></PRE>
<P>The output will look like this: <FONT color=#000099></P><PRE>Gregorian date: 4/9/2000 <BR>Hijri date: 05/01/1421 <BR>Thai date: 9/4/2543</PRE></FONT>
<P>To convert from a string to a date, simply specify vbDate in that fifth parameter instead of vbString. You can use this same code under more pleasant circumstances to help interpret dates from different locales. </P>
<P>The bug is obviously pretty bad for existing applications running on Thai machines since their behavior will be changed. I hope Microsoft addresses this one quickly. </P></BLOCKQUOTE>
<P><EM><FONT color=#ff0000></FONT></EM>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post and its localized Thai cousin brought to you by </EM>"ภ"<EM> (</EM><A href="http://www.fileformat.info/info/unicode/char/0e20/index.htm"><EM>U+0e20</EM></A><EM>, a.k.a. THAI CHARACTER PHO SAMPHAO)</EM></FONT></P>
<hr/><p><a id="386458" href="#386458">#</a> <strong>AC</strong> on 7 Mar 2005 12:16 AM:</p><div style="margin-left: 1em">How does one easily reproduce the bug?</div>
<p><a id="386471" href="#386471">#</a> <strong>Michael Kaplan</strong> on 7 Mar 2005 1:13 AM:</p><div style="margin-left: 1em">Just go to the immediate window and try the following:<br><br>VBA.Calendar = vbCalGreg : ? Date(): VBA.Calendar = vbCalHijri: ? Date()<br><br>Now try the same thing after switch your default user locale to Thai. The non-Gregorian and non-Hijri dates are easy to spot (unfortunately).</div>
<p><strong>Yuhong Bao</strong> on 2 May 2010 9:28 PM:</p><div style="margin-left: 1em"><p>&quot;Recycling some electrons for a fun bug that can still be reproduced in the latest versions and service packs of VB and VBA &lt;= 6.x&quot;</p>
<p>What about VBA 7.0?</p></div>
<p><strong>Michael S. Kaplan</strong> on 2 May 2010 9:36 PM:</p><div style="margin-left: 1em"><P>You can try it, of course. No such version existed when I wrote this over half a decade ago!</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2005/03/07 <a href="http://archives.miloush.net/michkap/archive/2005/03/07/389218.html">Successful experiment</a></p><p>2005/03/07 <a href="http://archives.miloush.net/michkap/archive/2005/03/07/386453.html">บั๊กที่สนับสนุนระบบปฏิทิน oleaut32.dll รุ่นใหม่ รวมถึง VB, VBA, และ VBScript</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/03/07/386453.html" title="บั๊กที่สนับสนุนระบบปฏิทิน oleaut32.dll รุ่นใหม่ รวมถึง VB, VBA, และ VBScript">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/03/06/386194.html" title="Backcompat is the father of the NLS APIs">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/07/386452.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>