<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/11/394359.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When good SQL queries have trouble....</title></head><body>
<h1>When good SQL queries have trouble....</h1>
<p><em>by Michael S. Kaplan, published on 2005/03/11 22:33 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/03/11/394359.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>SQL Server uses the same linguistic data as that which ships in Windows, and has done so for many versions.</P>
<P>They do not actually call our APIs, they instead took a snapshot of them and they use that to give each SQL Server install consistent&nbsp;behavior&nbsp;no matter what version of Windows they are running on. </P>
<P>It also means they run a little behind us in terms of language support, but there are always downsides to snapshots (on the upside, they sometimes have data that is newer than the operating system upon which it is running, assuming you are on an old enough OS).</P>
<P><FONT size=2><EM>Trivia: Versions of the Microsoft Jet Engine prior to 4.0 (the one used by Access 2.0, 95, and 97, for example) depended on Windows for their sorting data for East Asian locales -- which could lead to interesting results if databases crossed versions of Windows. This is why both Jet and SQL Server wanted a better solution going foward! :-)</EM></FONT></P>
<P>I thought I'd preface this column with that information. :-)</P>
<P>Anyway, there was a customer who was running queries similar to the following in SQL Server:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face=Arial size=6>if&nbsp; N'เหม' like N'%ม%' select 'true' else select 'false'</FONT></P>
<P><FONT face=Arial size=6>if&nbsp; N'เม' like N'%ม%' select 'true' else select 'false'</FONT></P></BLOCKQUOTE>
<P>&nbsp;(I made the text bigger so that even if you cannot read Thai you can see the visual differences between the Thai characters)</P>
<P>The strings in question:</P>
<P><FONT face="Courier New">เหม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT size=2><A href="http://www.fileformat.info/info/unicode/char/0e40/index.htm">U+0e40</A> <A href="http://www.fileformat.info/info/unicode/char/0e2b/index.htm">U+0e2b</A> <A href="http://www.fileformat.info/info/unicode/char/0e21/index.htm">U+0e21</A>&nbsp;&nbsp;(THAI CHARACTER SARA E +&nbsp;THAI CHARACTER HO HIP +&nbsp;THAI CHARACTER MO MA)</FONT></FONT></P>
<P><FONT face="Courier New">เม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT size=2><A href="http://www.fileformat.info/info/unicode/char/0e40/index.htm">U+0e40</A> <A href="http://www.fileformat.info/info/unicode/char/0e21/index.htm">U+0e21</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (THAI CHARACTER SARA E&nbsp;+ THAI CHARACTER MO MA)</FONT></FONT></P>
<P><FONT face="Courier New">ม&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT size=2><A href="http://www.fileformat.info/info/unicode/char/0e21/index.htm">U+0e21</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (THAI CHARACTER MO MA)</FONT></FONT></P>
<P>The SQL Server 2000 database, being one that contains lots of Thai data, uses the Thai_CS_AS collation. Looking at the queries, they are basically an attempt to see if the third string can be found within the first two. Should be very straightforward since the character in question is there, right?</P>
<P>Well, it turns out that the first query returns true and the&nbsp;second one does not. </P>
<P>But everyone can see the character right there, so "why can't SQL Server?" is a question that comes to mind pretty quickly.</P>
<P>For a hint to the answer, do you recall the post I made entitled <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2004/12/30/344389.html">How do sort keys work?</A>&nbsp;</P>
<P>SQL Server builds indexes using sort keys just like the ones you can create yourself using the <A title=LCMapString href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp" target=_blank>LCMapString</A> API in Windows and the <A title=SortKey href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationsortkeyclasstopic.asp" target=_blank>SortKey</A> class in the .NET Framework. That binary representation removes all of the information in the string other than what is needed to get identical results to a string comparison. In the case of Thai that sometimes includes combinations of letters that are treated as if they are a single unique sort element -- in this case the combination of the SARA E and the MO MA. </P>
<P>Suddenly, database developers are scrambling to their applications, since they might have just such querying functionality in applications. </P>
<P>Also, the developers who use the .NET Framework (who ran out in a panic at the same time as those database developers!) were thinking of all of their calls to the <A title=IsPrefix href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassisprefixtopic.asp" target=_blank>IsPrefix</A>, <A title=IsSuffix href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassissuffixtopic.asp" target=_blank>IsSuffix</A>, <A title=IndexOf href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclassindexoftopic.asp" target=_blank>IndexOf</A>, and <A title=LastIndexOf href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclasslastindexoftopic.asp" target=_blank>LastIndexOf</A> methods off of the <A title=CompareInfo href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareinfoclasstopic.asp" target=_blank>CompareInfo</A> object. Do they have the same problem? They frantically write the test code to check:</P>
<P><FONT face="Courier New">&nbsp;&nbsp;&nbsp;string string1 = "เม";<BR>&nbsp;&nbsp;&nbsp;string string2 = "ม";</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp;&nbsp;CompareInfo ci = CompareInfo.GetCompareInfo("th-TH");</FONT></P>
<P><FONT face="Courier New">&nbsp;&nbsp;&nbsp;Console.WriteLine(ci.IndexOf(string1, string2));</FONT></P>
<P>After running back, ready to post their flame at me, since the code worked fine and found <FONT face="Courier New">string1</FONT> inside of <FONT face="Courier New">string2</FONT>&nbsp;(returning 1),&nbsp;they get to the words I am about to type.&nbsp;:-)</P>
<P>CompareInfo's IsPrefix, IsSuffix, IndexOf, and LastIndexOf methods in the.NET Framework do not have the same problem, because they are using the original strings, not the sort keys. So the information is still there for them to use. Slightly slower than using sort keys, but in this case more functional.</P>
<P>Now hopefully the database developers are still reading, so I can let them know they do not have to worry. People who use these languages understand why certain groupings of characters behave a particular way. This sort of thing mainly is a problem with developers and testers who do not fully understand the area, which is <A id=CategoryEntryList href="http://archives.miloush.net/michkap/archive/2005/01/04/346116.html">Why international test is an art (and why there are few fine artists)</A>.</P>
<P>Think of it another way -- if you build indexes that are case insensitive, how do you then distinguish between upper and lower case in queries? You can use a binary collation for the comparison, or some collation other than Thai so that you will have not have these linguistically appropriate combinations of characters. </P>
<P>Just don't feel the need to do this for your customers who use these languages -- they will always be happier with linguistically appropriate results. Use this to keep that persistent tester happy. :-)</P>
<P>&nbsp;</P>
<P><FONT color=#ff0000><EM>This post brought to you by who else but</EM>&nbsp;"<FONT size=5>ม</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/0e21/index.htm">U+0e21</A>, a.k.a. THAI&nbsp; CHARACTER MO MA)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/09/18 <a href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html">A&P of Sort Keys, part 8 (aka You can often think of ignoring weights as a form of ignorance)</a></p><p>2006/10/04 <a href="http://archives.miloush.net/michkap/archive/2006/10/04/788429.html">Wild[card] thing, You make my CHAR sing</a></p><p>2006/01/23 <a href="http://archives.miloush.net/michkap/archive/2006/01/23/515987.html">It is not just the good SQL queries that have trouble, sometimes</a></p><p>2005/05/11 <a href="http://archives.miloush.net/michkap/archive/2005/05/11/416290.html">Achieving case insensitivity</a></p><p>2005/03/16 <a href="http://archives.miloush.net/michkap/archive/2005/03/16/396704.html">Reversing sort keys?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/03/12/394417.html" title="If you are sick, stay home please!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/03/10/392145.html" title="Another speaking gig (near Cleveland, OH)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03-11">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/11/394359.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>