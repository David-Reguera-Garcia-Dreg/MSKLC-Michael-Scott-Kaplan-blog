<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/16/396704.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Reversing sort keys?</title></head><body>
<h1>Reversing sort keys?</h1>
<p><em>by Michael S. Kaplan, published on 2005/03/16 09:25 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/03/16/396704.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Joe Petersen asked:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT size=2><EM>I read your post at </EM></FONT><A href="http://archives.miloush.net/michkap/archive/2005/03/11/394359.html" target=_new mce_href="http://archives.miloush.net/michkap/archive/2005/03/11/394359.html"><FONT size=2><EM>http://blogs.msdn.com/michkap/archive/2005/03/11/394359.aspx</EM></FONT></A><FONT size=2><EM> and it made me start thinking. If I have a sort key and I am looking to get back the original string, is there a way do do that? <BR><BR>In other words, is sort key generation a reversible algorithm?</EM></FONT></P></BLOCKQUOTE>
<P>An interesting question! The kind of question that would almost make a good interview&nbsp;question (I say almost because there would likely not&nbsp;enough time to set up the complexity of the sort keys themselves and that would be important if someone was to be thinking about reversing them).</P>
<P>For admittedly geeky reasons I wish I could say something like, "well yes, just use <A title=LCMapString href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp" target=_blank mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A> with the LCMAP_RECOVERSTRING flag or maybe use the .NET Framework's sister class to <A title=SortKey href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationsortkeyclasstopic.asp" target=_blank mce_href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationsortkeyclasstopic.asp">SortKey</A>, the SortKeyReversi class." But obviously the documentation will not find such a class. :-(</P>
<P>To see why, let's take&nbsp;a closer look at a sort key. The (hideously contrived) string we will use is: "Mötley ¡Crüe! Chugß". using the Traditional Spanish LCID (0x040a), the sort key on Server 2003 is:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>UW:&nbsp;&nbsp;&nbsp;0E 51 0E 7C 0E 99 0E 48 0E 21 0E A7 07 02 07 51 0E 0A 0E 8A 0E 9F 0E 21 07 1C 07 02 0E 0D 0E 9F 0E 25 0E 91 0E 91 01 <BR>DW:&nbsp;&nbsp;&nbsp;02 13 02 02 02 02 02 02 02 02 13 01&nbsp;<BR>CW:&nbsp;&nbsp;&nbsp;12 02 02 02 02 02 02 02 12 02 02 02 02 02 12 01 <BR>SW:&nbsp;&nbsp;&nbsp;01 00</FONT></P></BLOCKQUOTE>
<P>The Unicode Weight portion of the string is 38 bytes long, the diacritic weight is 12 bytes long, the case weight is 15 bytes long, and there are no special weights. So given the problem of reconstructing the string of the weight meets its first challenge -- there seems to be no pattern!</P>
<P>Well, wait a minute. The string is 19 characters long and there are 38 bytes in the Unicode weight -- that is a sort of a pattern, right? Kind of. Except in Traditional Spanish an instance of the letters "Ch" is treated as a single character, so that would mean we expect that it would be only 36 bytes. Ah, but wait -- the Sharp S at the end there,&nbsp;as we learned from earlier posts, gets treated like an "ss", so that would mean we are back up to 38. So we are back in business. Right?</P>
<P>Well, not so much -- as the diacritic and case weights do not seem to line up with those Unicode weights in an intuitive way.</P>
<P>Clearly we would also need the exact LCID and the flags -- after all, the same string with NORM_IGNORECASE&nbsp;| NORM_IGNORENONSPACE | NORM_IGNORESYMBOLS, you will get back:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>UW:&nbsp;&nbsp;&nbsp;0E 51 0E 7C 0E 99 0E 48 0E 21 0E A7 0E 0A 0E 8A 0E 9F 0E 21 0E 0D 0E 9F 0E 25 0E 91 0E 91 01 <BR>DW:&nbsp;&nbsp;&nbsp;01 <BR>CW:&nbsp;&nbsp;&nbsp;01 <BR>SW:&nbsp;&nbsp;&nbsp;01 00</FONT></P></BLOCKQUOTE>
<P>and obviously trying to pass some of the flags but not all of them will return some amount of sort key between these two extremes.</P>
<P>So every single call would require behind it a reverse lookup table with every weight and the character it maps to.</P>
<P>And then there are things like Old Hangul, Japanese Kana, Extension A ideographs, double compressions (used in Hungarian), and more that are not entirely table based, requiring code to reverse the operations on demand.</P>
<P>There are the obvious problems of trying to appropriately combine all of the weights together, and knowing how they fit.</P>
<P>Lets look at a string that will use some of these other weights, with the hideously contrived "Ḡrēăşėď いなずま" (the Hiragana word is for lightning). The sort key:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>UW:&nbsp;&nbsp;&nbsp;0E 25 0E 8A 0E 21 0E 02 0E 91 0E 21 0E 1A 07 02 22 03 22 22 22 14 22 32 01 <BR>DW:&nbsp;&nbsp;&nbsp;17 02 17 15 1C 10 14 02 02 02 03 01 <BR>CW:&nbsp;&nbsp;&nbsp;12 01 <BR>SW:&nbsp;&nbsp;&nbsp;FF 02 FF FF 01 00</FONT></P></BLOCKQUOTE>
<P>Trying to map the diacritic and case weight are the&nbsp; same hard problem as before, and the special weights are in this case very hard to place other than by knowing where in the alphabetic weights they might come from. In this case note that the sort key does not have to know the position in the string of the Japanese Hiragana since the UW values will properly sort the string against times that you put the same Hiragana string in a different position. Thus "いなずま Ḡrēăşėď" is:</P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>UW:&nbsp;&nbsp;&nbsp;22 03 22 22 22 14 22 32 07 02 0E 25 0E 8A 0E 21 0E 02 0E 91 0E 21 0E 1A 01 <BR>DW:&nbsp;&nbsp;&nbsp;02 02 03 02 02 17 02 17 15 1C 10 14 01 <BR>CW:&nbsp;&nbsp;&nbsp;02 02 02 02 02 12 01 <BR>SW:&nbsp;&nbsp;&nbsp;FF 02 FF FF 01 00</FONT></P></BLOCKQUOTE>
<P>Identical special weights, but you have to know what the Hiragana looks like. This is in contrast to the diacritic weights, which <EM>are</EM> sort of positional yet seemingingly not entirely so (wait until you add reverse diacritics in French or double compressions in Hungarian!). Or even the positional notion of case.</P>
<P>So, a proper GetStringFromSortKey would have&nbsp;to be able to handle all of these cases, and properly return the string with less imformation when flags were passed to filter out weights. It ould have to be able to properly hook up these different sections of vaying sizes, with enough specific knowledge of the various Unicode weights to know what script each belonged to so any special rules can be handled. Finally, it must be able to handle all of those ligature expansions and contractions of characters. And code to handle all of the cases where code was used to get the strings there in the first place. </P>
<P>A very non-trivial operation, to be sure! Without even a clear need (for example in a database, if you need the string you have it right there, so trying to reconstruct it from the index will never be as efficient or lossless as just using it directly).</P>
<P>So it does appeal on the level of the inner "geek" child&nbsp;inside me, but not so much on the practical "what is the user scenario we solve?" adult....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff0000><EM>This post sponsored by</EM> "ß" <EM>(<A href="http://www.fileformat.info/info/unicode/char/00df/index.htm" mce_href="http://www.fileformat.info/info/unicode/char/00df/index.htm">U+00df</A>, LATIN SMALL LETTER SHARP S)</EM></FONT></P>
<hr/><p><a id="396718" href="#396718">#</a> <strong>Joseph Petersen</strong> on 16 Mar 2005 6:54 AM:</p><div style="margin-left: 1em">Oh well. It was just a thought. I did not really have a user scenario in mind. Maybe I am the same kind of geek.</div>
<p><a id="397232" href="#397232">#</a> <strong>Michael Kaplan</strong> on 16 Mar 2005 7:32 PM:</p><div style="margin-left: 1em">It is an interesting problem, FWIW. It is one of those kinds of problems that starts off really easy and then just keeps getting harder as you notice other issues start piling up....<br><br></div>
<p><strong>Gaspar Sinai</strong> on 11 Aug 2008 9:53 PM:</p><div style="margin-left: 1em"><p>I am glad that your are thinking about reversability.</p>
<p>Is there any update on this somewhere?</p></div>
<p><strong>Michael S. Kaplan</strong> on 11 Aug 2008 10:10 PM:</p><div style="margin-left: 1em"><p>If you follow the comment before yours, you will see a series about it.</p>
<p>Remember though that I am not on the team that owns the technology, so me thinking about it is not the same as them adding this as a feature....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/01/13 <a href="http://archives.miloush.net/michkap/archive/2008/01/13/7090976.html">On reversing the irreversible (the introduction)</a></p><p>2007/07/08 <a href="http://archives.miloush.net/michkap/archive/2007/07/08/3747992.html">UnLCMapString or LCUnMapString?</a></p><p>2005/06/15 <a href="http://archives.miloush.net/michkap/archive/2005/06/15/429279.html">Once more into the palindrome</a></p><p>2005/03/17 <a href="http://archives.miloush.net/michkap/archive/2005/03/17/397689.html">The offline address book (OAB) in Exchange....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/03/17/397689.html" title="The offline address book (OAB) in Exchange....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/03/16/396704.html" title="Reversing sort keys?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-03-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/03/16/396704.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>