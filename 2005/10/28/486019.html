<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/28/486019.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It isn't Unicode, it's Double Secret Unicode!</title></head><body>
<h1>It isn't Unicode, it's Double Secret Unicode!</h1>
<p><em>by Michael S. Kaplan, published on 2005/10/28 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/10/28/486019.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Visual Basic ≤ 6.0 has Unicode strings. But as I point out in <A href="http://i18nwithvb.com/chapters/">Chapter 6</A> of my book, it converts out of Unicode to the default system code page any time you do just about anything to those strings.</FONT></P>
<P><FONT face=Tahoma>Lots of people try to avoid this by calling the <A href="http://msdn.microsoft.com/library/en-us/vbenlr98/html/vafctstrconv.asp">StrConv function</A> with the vbUnicode parameter first,&nbsp;figuring they convert the string to Unicode, VB converts it back out, and all is well.</FONT></P>
<P><FONT face=Tahoma>Ugh.</FONT></P>
<P><FONT face=Tahoma>Remember how&nbsp;I said that VB strings were already Unicode strings?</FONT></P>
<P><FONT face=Tahoma>Well, calling StrConv to convert a Unicode string to Unicode is not a no-op; it actually converts the string to <STRONG>Double Secret Unicode</STRONG>, an encoding not found in nature.</FONT></P>
<P><FONT face=Tahoma>So your string:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>My name is Michael.</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>which is laid out as follows:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px"><FONT face="Courier New" size=1><STRONG>004d 0079 0020 006e 0061 006d 0065 0020 0069 0073 0020 004d 0069 0063 0068 0061 0065 006c 002e</STRONG></FONT></BLOCKQUOTE>
<P><FONT face=Tahoma>will be converted by VB (which thinks it is not Unicode since you are converting it) to:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=1>0000 004d 0000 0079 0000 0020 0000 006e 0000 0061 0000 006d 0000 0065 0000 0020 0000 0069 0000 0073 0000 0020 0000 004d 0000 0069 0000 0063 0000 0068 0000 0061 0000 0065 0000 006c 0000 002e</FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>and this "Double Secret Unicode" is basically meaningless.</FONT></P>
<P><FONT face=Tahoma>Luckily when VB converts it out of Unicode you will get what you are looking for. So maybe you converted twice for no reason. No need to worry, right?</FONT></P>
<P><FONT face=Tahoma>Wrong.</FONT></P>
<P><FONT face=Tahoma>If you look to my posts <a href="http://archives.miloush.net/michkap/archive/2005/01/05/347394.html"><STRONG>The new compiler error C4819</STRONG></A> and <a href="http://archives.miloush.net/michkap/archive/2005/01/08/349230.html"><STRONG>How does it detect invalid characters?</STRONG></A>&nbsp;then you'll start&nbsp;to get a glimmer of&nbsp;where this method gets into trouble. </FONT></P>
<P><FONT face=Tahoma>Because for most strings in Unicode you do do not have those things that look like NULL values. </FONT><FONT face=Tahoma>And because any time you are on a machine whose default system code page does not contain all of the characters in question (and as those posts indicated this is not unheard of), the conversion back from Double Secret Unicode will not perfectly round trip back to the original string. And once you get into Chinese, Japanese, and Korean, the exacting requirements of particular lead bytes and trail bytes can cause you to lose ideographs in all kinds of unexpected ways.</FONT></P>
<P><FONT face=Tahoma>In summary, you will lose information.</FONT></P>
<P><FONT face=Tahoma>The way around this is really quite simple. Any time you are going to pass a string to an external function, declare it <FONT face="Courier New"><STRONG>ByVal As Long</STRONG></FONT> rather than <FONT face="Courier New"><STRONG>ByVal As String</STRONG></FONT>, and then pass StrPtr(&lt;your string&gt;) to that Long. For example:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New" size=2><STRONG>Public Declare Function CompareStringW Lib "kernel32" ( _<BR>&nbsp; ByVal Locale As Long, _<BR>&nbsp; ByVal dwCmpFlags As Long, _<BR>&nbsp; ByVal lpString1 As Long, _<BR>&nbsp; ByVal cchCount1 As Long, _<BR>&nbsp; ByVal lpString1 As Long, _<BR>&nbsp; ByVal cchCount1 As Long) As Long</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>Public Enum CmpFlags<BR>&nbsp;&nbsp;&nbsp; STRINGSORT =&nbsp;&amp;H1000&amp;<BR>&nbsp;&nbsp;&nbsp; IGNORECASE =&nbsp;&amp;H1&amp;<BR>&nbsp;&nbsp;&nbsp; IGNORENONSPACE =&nbsp;&amp;H2&amp;<BR>&nbsp;&nbsp;&nbsp; IGNORESYMBOLS =&nbsp;&amp;H4&amp;<BR>&nbsp;&nbsp;&nbsp; IGNOREKANATYPE =&nbsp;&amp;H10000<BR>&nbsp;&nbsp;&nbsp; IGNOREWIDTH = &amp;H20000<BR>End Enum</STRONG></FONT></P>
<P><FONT face="Courier New" size=2><STRONG>Public Enum CSTR_<BR>&nbsp;&nbsp;&nbsp; LESS_THAN = 1 'string 1 less than string 2<BR>&nbsp;&nbsp;&nbsp; EQUAL = 2 ' string 1 equal to string 2<BR>&nbsp;&nbsp;&nbsp; GREATER_THAN = 3 ' string 1 greater than string 2<BR>End Enum</STRONG></FONT></P>
<P><FONT face=Tahoma><FONT face="Courier New" size=2><STRONG>Public Function CompareString(ByVal lcid As Long, ByVal flags As CmpFlags, ByVal st1 As String, ByVal st2 As String) As CSTR_<BR>&nbsp;&nbsp;&nbsp; CompareString = CompareStringW(lcid, flags, StrPtr(st1), Len(st1), StrPtr(st2), Len(st2))<BR>End Function</STRONG></FONT></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>And if you use this technique, the call will be faster (you avoid two extraneous conversions) and you will never lose data from conversion mistakes.</FONT></P>
<P><FONT face=Tahoma>Best of all, you avoid the evil <STRONG>Double Secret Unicode</STRONG>!</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>٭</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/066d">U+066d</A>, a.k.a. ARABIC FIVE POINTED STAR)</EM></FONT></P>
<hr/><p><a id="486078" href="#486078">#</a> <strong>Gabe</strong> on 28 Oct 2005 3:13 AM:</p><div style="margin-left: 1em">This Double Secret Unicode looks a bit too similar to UTF-32. And that Arabic 5-pointed star looks like it has 8 points. I definitely think there's some sort of conspiracy at Microsoft.</div>
<p><a id="486079" href="#486079">#</a> <strong>Vorn</strong> on 28 Oct 2005 3:15 AM:</p><div style="margin-left: 1em">Linked image shows what I see on my Mac for your sponsoring character.  this one's particularly silly.<br><br>Vorn</div>
<p><a id="486082" href="#486082">#</a> <strong>Michael S. Kaplan</strong> on 28 Oct 2005 3:26 AM:</p><div style="margin-left: 1em">Gabe -- it is not UTF-32, trust me. It will shred anything not English....</div>
<p><a id="486184" href="#486184">#</a> <strong>Nick Lamb</strong> on 28 Oct 2005 9:33 AM:</p><div style="margin-left: 1em">Well, U+066d is cross-referenced to U+002a (asterisk) and it's arguable that in most cases asterisk is a suitable fallback character if your system has no glyph at all for U+066d... it's certainly better than the more or less arbitrary &quot;fallback&quot; glyphs Apple provide.<br><br>So, Vorn, do you have any (probably Arabic) fonts with a five pointed star on your Mac? If not this result is arguably correct.<br><br>On the other hand some systems seem to get this stuff right more than others. By default the renderer should prefer U+066d from an Arabic font over U+002a from the programmer's / user's first choice font, not least because it's likely to be surrounded by other Arabic for which no such substitute is possible and a latin asterisk will spoil the flow. Fileformat.info gets this wrong (they obviously have an Arabic font, but it isn't used for this character). The Pango renderer I'm using gets it right in my web browser and other apps, but the renderer used in xterm doesn't do fallback (and of course there's no fixed pitch Arabic font), so you get the infamous dotted box. Does IE get it right on Windows, with Arabic fonts installed but not set as first choice?</div>
<p><a id="486191" href="#486191">#</a> <strong>Mike</strong> on 28 Oct 2005 9:53 AM:</p><div style="margin-left: 1em">Funny, I was re-reading your VB book (page 166-167) about that exact topic so I could reply in the newsgroups - thanks for that expanded answer.</div>
<p><a id="486363" href="#486363">#</a> <strong>Vorn</strong> on 28 Oct 2005 3:26 PM:</p><div style="margin-left: 1em">I have 11 fonts installed with U+066d installed, plus three font variants, for a total of 14.  Three of them have eight-pointed stars (Al Bayan, Al Bayan Bold, DecoType Naskh), six of them have six-pointed stars (Baghdad, Geeza Pro, Geeza Pro Bold, Geezah, KufiStandardGK, Nadeem), and five have five-pointed stars (STFangsong, STHeiti, STHeiti Light, STKaiti, STSong).  I appear to get my version of the arabic five-pointed star from Baghdad.<br><br>Vorn</div>
<p><a id="486834" href="#486834">#</a> <strong>robert</strong> on 29 Oct 2005 4:12 PM:</p><div style="margin-left: 1em">I tried StrPtr and pass the original VB string pointer to a C program, but c program doesn't recognize it as LPWSTR, instead, just treat it as one wchar. No idea why? The vb string should be terminated by null, then the VB string char array should be a perfect LPWSTR, but why it's not recognized by C?</div>
<p><a id="486840" href="#486840">#</a> <strong>Michael S. Kaplan</strong> on 29 Oct 2005 4:34 PM:</p><div style="margin-left: 1em">Well, it would actually be a WCHAR array. and if it is English then it will look like one byte (char) followed by a NULL. This trick is for when you want a Unicode string.... :-)</div>
<p><a id="486998" href="#486998">#</a> <strong>robert</strong> on 30 Oct 2005 11:23 AM:</p><div style="margin-left: 1em">Just the update for my post regarding strptr and LPWSTR. finally I figured out that VC6 did work with the pointer passed by strptr, only thing is the IDE itself will not show the string content when you debug (it only show one char instead of whole string for the pointer content). If we check the memory, all string content are there and the code itself will treat the content as string and all string functions work fine.<br><br>My issue actually is when you do post in wininet. If you post the unicode string to ASP.net page, looks like the post data willl not be recognized, even I set the charset in post as unicode, and set asp.net request contentencoding as unicode.<br><br>Now the issue may be beyond the original discussion, but I would like to share what I learned form the issue: sometimes we have to convert unicode back to ANSI --- but it will be the MBCS using utf-8 encoding. Many cases utf-8 encoded ANSI (I mean single byte string) instead of unicode is what we really need. The concept of MBCS may be important for those who are using unicode for multi-language development.<br><br></div>
<p><a id="487028" href="#487028">#</a> <strong>Michael S. Kaplan</strong> on 30 Oct 2005 2:32 PM:</p><div style="margin-left: 1em">UTF-8 is indeed important in many cases, but it is never ANSI (only the 'misnamed' ANSI code pages in Windows are that!).</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/05/19 <a href="http://archives.miloush.net/michkap/archive/2008/05/19/8518545.html">Everyone seems averse to the BOM these days; Should we blame TSA? :-)</a></p><p>2006/10/08 <a href="http://archives.miloush.net/michkap/archive/2006/10/08/806138.html">The return of double secret Unicode!</a></p><p>2006/06/08 <a href="http://archives.miloush.net/michkap/archive/2006/06/08/621213.html">DEP is not affected by locale settings</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/10/28/486034.html" title="What is wrong with that web page?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/10/27/485478.html" title="Not every bit of the printer dialogs support MUI 100% of the time">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10-28">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/28/486019.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>