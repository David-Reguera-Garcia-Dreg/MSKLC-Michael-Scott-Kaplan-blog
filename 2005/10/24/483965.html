<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/24/483965.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Searching for supplementary characters</title></head><body>
<h1>Searching for supplementary characters</h1>
<p><em>by Michael S. Kaplan, published on 2005/10/24 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/10/24/483965.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Bruce Rusk asked in the microsoft.public.word.international.features newsgroup:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>I seem to have stumbled across a bug in Word's (I have 2003 on XP Pro English) handling of certain Unicode ranges in searches.</EM></FONT></FONT></P>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>I have the extended Chinese font SimSun (Founder Extended) installed&nbsp;from&nbsp;the Proofing Tools, and it contains a number of characters from the CJK&nbsp;Unified Ideographs Extension (codepoints U+20000 and up). I can do a&nbsp;normal&nbsp;find, either from the UI or with VBA manipulation of the Find object,&nbsp;for&nbsp;characters in this range without a problem. But Word doesn't seem to be able to handle wildcard searches (in the format [A-Z] for a range of&nbsp;characters from this part of Unicode. A little experimentation suggests that it&nbsp;can't&nbsp;handle anything from U+10000 up.</EM></FONT></FONT></P>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>To replicate the problem, open the Find dialog, check "Use Wildcards,"&nbsp;and enter the following:</EM></FONT></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>"[10000"</EM></FONT></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>then click Alt-X to insert the character, then a dash ("-"), then</EM></FONT></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>"10001"</EM></FONT></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>then Alt-X again, then "]"</EM></FONT></FONT></P>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>Two boxes should replace the characters (unless you have a font&nbsp;installed that shows Linear B). When I perform the search, I get the following&nbsp;error message:</EM></FONT></FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>"The Find What text contains a range that is not valid."</EM></FONT></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>Word should be able to handle this, since:</EM></FONT></FONT></P>
<UL>
<LI><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>You can do the the search in this way for any character range below U+10000</EM></FONT></FONT> 
<LI><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>You can search individually for characters U+10000 and above (try inserting one and searching for it)</EM></FONT></FONT></LI></UL>
<P><FONT face=Tahoma><FONT face="Times New Roman" size=2><EM>Can anyone else replicate this problem? And if anyone is beta-testing&nbsp;Word 12, can you test if the same problem persists there (and if so, fire&nbsp;off a bug report?).</EM></FONT></P></BLOCKQUOTE></FONT>
<P><FONT face=Tahoma>What is happening here is obvious if you consider that for most purposes 'Unicode' in Microsoft applications is UTF-16LE. This means that a supplementary character, thus <A href="http://www.fileformat.info/info/unicode/char/10000">U+10000</A> and <A href="http://www.fileformat.info/info/unicode/char/10001">U+10001</A> are actually <A href="http://www.fileformat.info/info/unicode/char/d800">U+d800</A> <A href="http://www.fileformat.info/info/unicode/char/dc00">U+dc00</A> and <A href="http://www.fileformat.info/info/unicode/char/d800">U+d800</A> <A href="http://www.fileformat.info/info/unicode/char/dc01">U+dc01</A>, which if you tried to use in a range or with one character wildcards, would most certainly always fail since the notion of a 'single character' is not met by these multiple character entities.</FONT></P>
<P><FONT face=Tahoma>Now this does not mean that it isn't a bug; if not a bug, then it is at least a design limitation since other parts of the system work so hard to act like it is a single character. The fix would involve extending the underlying range checking to allow multiple characters when surrogate pairs are used and treating a 'single character&nbsp;replace' as applying to one UTF-16 code point or a supplementary character. This is not impossible, but is certainly a differnt class of solution and the performance hit may or may not be worth the trouble.</FONT></P>
<P><FONT face=Tahoma>One thing that is certain -- it is not supporting combining characters -- thus searching for <A href="http://www.fileformat.info/info/unicode/char/00e5">U+00e5</A> (our good friend&nbsp;'a Ring') does not find <A href="http://www.fileformat.info/info/unicode/char/006a">U+006a</A> <A href="http://www.fileformat.info/info/unicode/char/030a">U+030a</A> ('a plus combining ring'), which is just as reasonable of an extension here. It actually helps put the problem in context, as clearly Word is not using the user notion of&nbsp;a character, it is using the term to mean individual code points.</FONT></P>
<P><FONT face=Tahoma>Though maybe that sort of thing will change if <a href="http://archives.miloush.net/michkap/archive/2005/07/31/445819.html">FindNLSString</A> starts to see wider usage in applications after it has been out there for a while. It allows the user's notion of a character to have more control here. Although some may balk at how the behavior will change with user settings rather than being consistent across all situations, I think the behavior makes sense and is certainly explainable.</FONT></P>
<P><FONT face=Tahoma>In the meantime, search in Word is not using the user notion of a 'character', and that is that. If enough people start finding this blog entry, it may reach the point of being a 'known limitation' but a KB article might serve that purpose more effectively. :-)</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>êÄÅ</FONT>" <EM>(<A href="http://www.fileformat.info/info/unicode/char/10001">U+10001</A>, a.k.a. LINEAR B SYLLABLE B038 E)</EM></FONT></P>
<hr/><p><a id="484080" href="#484080">#</a> <strong>Nick Lamb</strong> on 24 Oct 2005 5:18 AM:</p><div style="margin-left: 1em">The fileformat.info pages for U+10001 are broken by the way, they contain meaningless byte sequences such as EDA080 and EDB081 which are an encoding of the surrogate codepoints used only by UTF-16, the correct UTF-8 encoding is FO908081.<br><br>On a system with a Linear B font available you'll see that the &quot;browser test page&quot; shows the HTML escaped versions correctly but the inline UTF-8 encoding is wrong in both places that it is used.<br><br>I've sent feedback telling the owner about this problem, meanwhile you might want to consider linking elsewhere for characters outside the BMP.<br><br>Office is obviously very difficult to fix, the last time I looked it didn't really seem to know what a character was, everything appeared to either be hard coded or reliant on font encodings. The result is that the meaning and appearance of an Office document is specific to the context (locale, installed fonts etc.) of the system that created it. What a headache.<br></div>
<p><a id="484088" href="#484088">#</a> <strong>Nick Lamb</strong> on 24 Oct 2005 5:53 AM:</p><div style="margin-left: 1em">Also, I wonder if collation order is available for these characters anyway? The original questioner seems to assume, perhaps rather naively, that the range U+10000 to U+10001 means exactly those two characters, but the users of Linear B were they around to tell us, might be of the opinion that &quot;of course&quot; anyone who specified such a range intended to include the as-yet unexplained symbol B018 aka U+10050, just as a French user would expect to find &#233; when searching for a-z. I presume Word gets the acute accent example right?<br><br>If Windows doesn't include collation for the CJK extension then it's sort-of meaningless to specify that you want a &quot;range&quot; of such characters, you're implicitly peering beneath the surface of the system to look at codepoints.</div>
<p><a id="484128" href="#484128">#</a> <strong>Michael S. Kaplan</strong> on 24 Oct 2005 9:59 AM:</p><div style="margin-left: 1em">All supplementary characters do have a code point ordering that is actually good enough for many purposes, and have had this since Windows XP (before that they had no weight). Range checking certainly would be a useful feature if it were available....<br><br>The fileformat.info page contains some valid info including valid UTF-16 data, which is the one of primary interest on Windows anyway, so I do not have plans to change the mapping, especislly since it is still the best all around way to find images for lots of these characters!</div>
<p><a id="484193" href="#484193">#</a> <strong>Bruce Rusk</strong> on 24 Oct 2005 12:55 PM:</p><div style="margin-left: 1em">In reply to Nick's second comment, it does work that way on my English (XP Pro, Off 2K3) system. But exactly HOW isn't documented in the Office help.<br><br>A search for [a-z] finds both accented and unaccented lower-case letters, as well as &#231;.<br><br>Searching for [e-f] will find e, &#233;, &#234;, &#232; and f.<br><br>A search for [e-&#233;] will find e or &#233; but not &#234; or &#232;. A search for [e-&#234;] will find e, &#233;, &#234; and also &#232;. Similarly, a search for [c] alone won't find &#231;, but a search for [c-d] will.<br><br>So it appears to a naive (sorry, na&#239;ve) end-user like me that accented characters are &quot;between&quot; the regular form of the letter and the next letter‚Äîthat &#233;, &#234; and &#232; are after e and before f, though it's hard to figure out that order.<br><br>Of course it doesn't work that way. Word won't let you search for the range [&#234;-z], complaining that &quot;The Find What text contains a range that is not valid.&quot; I assume that is because &#234; comes after z in Unicode order.<br><br>So when Word looks at such a range, it seems to be guessing what kind of collation to use, and there doesn't seem to be a way for the end-user to control it, or even to know what is going on.<br><br>Which raises, for me, a lot of questions about how consistent a search operation is going to be. This behavior is consistent with what a French user would expect, but might not be what users from another locale would want (and we know well from this blog how often such expectations collide).<br><br>In Word there's the added complication that all text is tagged with a Language; does this mean that a range will have a different meaning for different parts of a document, according to the language it's in (I doubt it)?<br><br>Here's why this is troubling to me:<br><br>‚Ä¢ It's hard to know beforehand what's going to happen when your search for a range, because it isn't well-documented (bad)<br><br>‚Ä¢ I can't be sure that the same search will work the same way on other people's systems (very bad, especially if I'm distributing VBA code)<br><br>And I haven't even started to play around with the search order for CJK ranges!</div>
<p><a id="484309" href="#484309">#</a> <strong>Michael S. Kaplan</strong> on 24 Oct 2005 5:11 PM:</p><div style="margin-left: 1em">Hi Bruce -- &quot;Works&quot; is a relative term, since different normalization forms tend to break it pretty easily, in addition to the problems you have noted. On the whole, I would consider the range stuff to be fairly broken for many/most international scenarios.</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/10/24/484388.html" title="Another new blog to check out">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/10/23/483911.html" title="Keyboards as security blankets">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/24/483965.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>