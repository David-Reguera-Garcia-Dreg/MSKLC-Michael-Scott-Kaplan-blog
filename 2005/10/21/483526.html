<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/21/483526.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Parameter confusion #2</title></head><body>
<h1>Parameter confusion #2</h1>
<p><em>by Michael S. Kaplan, published on 2005/10/21 14:10 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/10/21/483526.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>It seems like it was just&nbsp;ages ago&nbsp;that I talked about <a href="http://archives.miloush.net/michkap/archive/2005/10/20/482926.html">Parameter Confusion</A>&nbsp;in regard to the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp">LCMapString</A> function when used for sort keys.</FONT></P>
<P><FONT face=Tahoma>Oh wait, it was just yesterday. :-)</FONT></P>
<P><FONT face=Tahoma>There is another direction in which the confusion can exist, though -- this time not with the difference but with the consistency.</FONT></P>
<P><FONT face=Tahoma>Let's take a look at the <A href="http://msdn.microsoft.com/library/en-us/intl/nls_34rz.asp">GetLocaleInfo</A> function. its prototype is simple enough:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>int GetLocaleInfo(<BR>&nbsp; LCID Locale,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // locale identifier<BR>&nbsp; LCTYPE LCType,&nbsp;&nbsp;&nbsp; // information type<BR>&nbsp; LPTSTR lpLCData,&nbsp; // information buffer<BR>&nbsp; int cchData&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // size of buffer<BR>);</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>Simple enough, right? That cchData has a simple set of rules that it goes by:</FONT></P><FONT face=Tahoma>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P dir=ltr>cchData </P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P>[in] Specifies the size, in TCHARs, of the lpLCData buffer. If cchData is zero, the function returns the number of TCHARs required to hold the information, including the terminating null character, and the buffer pointed to by lpLCData is not used.</P></BLOCKQUOTE></FONT></BLOCKQUOTE>
<P dir=ltr><FONT face=Tahoma>Well, not completely simple, but close enough. Since you are passing a string, it is just saying to use the count of characters and not the count of bytes.</FONT></P>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>Of course, when you include the LOCALE_RETURN_NUMBER flag in with your <A href="http://msdn.microsoft.com/library/en-us/intl/nls_8rse.asp">LCType</A>, is when things get a bit more complicated:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma>LOCALE_RETURN_NUMBER </FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face=Tahoma><EM>Windows 98/Me, Windows NT 4.0 and later</EM>: This causes the function to return the value as a number instead of as a string. The buffer that receives the value must be at least the length of a DWORD. This flag can be combined with any specifier beginning with LOCALE_I by using the binary-OR operator.</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>Yikes, now that certainly does put a cat among the pigeons. What should the value in cchData be now, with this buffer that must be the length of&nbsp;a DWORD?</FONT></P>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>The answer is deceptively simple -- it should be the same value -- the size in TCHARs. The easiest way to do this is to generically pass <FONT face="Courier New"><STRONG>sizeof(DWORD) / sizeof(TCHAR)</STRONG></FONT> any time you are using the LOCALE_RETURN_NUMBER flag on any of the LOCALE_I* <A href="http://msdn.microsoft.com/library/en-us/intl/nls_8rse.asp">LCType</A> values.</FONT></P>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>You can be a little fancier in cases where the number is typed as something different -- like with LOCALE_ICALENDARTYPE (which returns a CALID). But then if you look at the definition of CALID in winnls.h you will see why I am not too concerned about the need pass <FONT face="Courier New"><STRONG>sizeof(CALID) / sizeof(TCHAR)</STRONG></FONT> for that case:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>//<BR>//&nbsp; Calendar ID.<BR>//<BR>typedef DWORD CALID;</STRONG></FONT></P></BLOCKQUOTE>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma>Ok, perhaps this ends up being kind of simple, after this part about LOCALE_RETURN_NUMBER is explained. Lots of people still find it to be kind of confusing....</FONT></P>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma></FONT>&nbsp;</P>
<P dir=ltr style="MARGIN-RIGHT: 0px"><FONT face=Tahoma><FONT color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>ﬁù</FONT>" </FONT><EM><FONT color=#ff1493>(</FONT><A href="http://www.fileformat.info/info/unicode/char/079d">U+079d</A><FONT color=#ff1493>, a.k.a. THAANA LETTER SHEENU)</FONT></EM></FONT></P>
<hr/><p><a id="483738" href="#483738">#</a> <strong>Gabe</strong> on 22 Oct 2005 3:27 AM:</p><div style="margin-left: 1em">Wow, I don't think reading an MSDN article has ever made me feel so ill as the one for GetLocaleInfo.<br><br>For example, &quot;the values in Win.ini take precedence over the database settings when getting values for the current system default locale.&quot; Does it really get values from Win.ini, or is this an entry that should have been updated 10 years ago?<br><br>Why is the default to return integers encoded as strings? Are we to assume that they're localized?<br><br>And what's with taking a character count? I can't think of any situation where that's really warranted instead of an actual byte count. To me this is just asking for buffer overflow bugs.<br><br>No wonder people get confused!</div>
<p><a id="483798" href="#483798">#</a> <strong>Michael S. Kaplan</strong> on 22 Oct 2005 1:39 PM:</p><div style="margin-left: 1em">Well, what used to be in win.ini is what is now in the registry -- that is being updated now.<br><br>The default is stringd because when the function was originally introdued the LOCALE_RETURN_NUMBER option was not available. Changing the default would have broken all existing code.<br><br>The character count/byte count issue is a valid one to consider, though honestly the registry API are the only notable example that went that way versus cch values for strings; almost everything in kernel32, user32, and gdi32 followed a different model.</div>
<p><a id="485374" href="#485374">#</a> <strong>Gabe</strong> on 26 Oct 2005 6:01 PM:</p><div style="margin-left: 1em">It think it is a valid question to ask why on earth did anybody (i.e. the original author of the function) think that it would be a good idea to return integers as strings. Was this API originally written in COBOL?</div>
<p><a id="485377" href="#485377">#</a> <strong>Michael S. Kaplan</strong> on 26 Oct 2005 6:07 PM:</p><div style="margin-left: 1em">No Gabe, it is written in C. But like I said the values for overrides used to be in places where they were strings, so it just sort of happened that way.<br><br>Was it a bad idea to go that way? Probably, which is why a few years later a flag was added to return numbers. But we could not break the old behavior, so we were stuck with it -- the hazard of having code bases that stick around this long....</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2006/01/12 <a href="http://archives.miloush.net/michkap/archive/2006/01/12/511884.html">The creation of sort keys does not always make sense</a></p><p>2005/10/22 <a href="http://archives.miloush.net/michkap/archive/2005/10/22/483573.html">Parameter confusion #2a</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/10/22/483573.html" title="Parameter confusion #2a">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/10/21/483315.html" title="It is our most modest receptacle....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/21/483526.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>