<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/21/480898.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Extending collation support in SQL Server and Jet, Part 4 (What about Jet?)</title></head><body>
<h1>Extending collation support in SQL Server and Jet, Part 4 (What about Jet?)</h1>
<p><em>by Michael S. Kaplan, published on 2005/10/21 03:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2005/10/21/480898.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT face=Tahoma>Prior posts in this series:</FONT></P>
<P><a href="http://archives.miloush.net/michkap/archive/2005/09/13/463962.html"><FONT face=Tahoma>Extending collation support in SQL Server and Jet, Part 0 (HISTORY)</FONT></A><BR><a href="http://archives.miloush.net/michkap/archive/2005/09/14/464780.html"><FONT face=Tahoma>Extending collation support in SQL Server and Jet, Part 1 (the broad strokes)</FONT></A><BR><a href="http://archives.miloush.net/michkap/archive/2005/09/18/470869.html"><FONT face=Tahoma>Extending collation support in SQL Server and Jet, Part 2 (generating sort keys)</FONT></A><BR><a href="http://archives.miloush.net/michkap/archive/2005/09/25/473686.html"><FONT face=Tahoma>Extending collation support in SQL Server and Jet, Part 2.1 (is this on?)</FONT></A><BR><FONT face=Tahoma><a href="http://archives.miloush.net/michkap/archive/2005/10/09/478705.html">Extending collation support in SQL Server and Jet, Part 3 (THAT CLASS)</A></FONT></P>
<P><FONT face=Tahoma>Okay, we have covered a lot of ground here, without ever actually talking about Microsoft Jet (even though it is in the title).</FONT></P>
<P><FONT face=Tahoma>Jet has been around for a long time. I believe it stands for Joint Engine Technology, and in this story there are two pills you can take the red one and the blue one.</FONT></P>
<P><FONT face=Tahoma>Swallow the blue&nbsp;pill and you will find you have moved off to handle Active Directory, etc.. Any day now one of my personal development heroes <a href="http://blogs.msdn.com/brettsh/">Brett Shirley</A> is going to be blogging about it. :-)</FONT></P>
<P><FONT face=Tahoma>If you swallow the red pill, then you go down the rabbit hole into the world of Access and dozens of other technologies that have used it over the years (including Windows!) and now according to <a href="http://blogs.msdn.com/access/">Erik Rucker</A>&nbsp;was an inspiration for the <a href="http://blogs.msdn.com/access/archive/2005/10/13/480870.aspx">new Access Data Engine</A> in Access 12.</FONT></P>
<P><FONT face=Tahoma>I am not running Access 12 yet to test with, so none of this is about Access&nbsp;12; I'll talk about the new version when (a) I am allowed to and (b) I have actually tried it. For now, we will concentrate on the Jet 4.0 that is in Access&nbsp;2000/2002/2003.</FONT></P>
<P><FONT face=Tahoma>You may recall that Jet 4.0 has those collation tables from Windows 2000 post beta 1, pre beta 2 that I mentioned in <a href="http://archives.miloush.net/michkap/archive/2005/09/13/463962.html"><FONT face=Tahoma>Part 0</FONT></A>. So the support of custom collations is important if you wanted to support some of the new languages from Windows 2000, XP/Server 2003, XP SP2, or Vista, especially since there is no built-in support for binary collations like there is in SQL Server.</FONT></P>
<P><FONT face=Tahoma>So we start by knowing that we have VBA to work with, as a coding language. Building those sort keys is straightforward, but requires some thought. We start with the Declare statement and a wrapper function to hide the weirdnesses of VB/VBA 6.x's non-Unicodality:</FONT></P>
<BLOCKQUOTE dir=ltr style="MARGIN-RIGHT: 0px">
<P><FONT face="Courier New"><STRONG>Private Declare Function LCMapStringW Lib "kernel32" ( _<BR>&nbsp;&nbsp;&nbsp; ByVal Locale As Long, ByVal dwMapFlags As Long, _<BR>&nbsp;&nbsp;&nbsp;&nbsp;ByVal lpSrcStr As Long, ByVal cchSrc As Long, _<BR>&nbsp;&nbsp;&nbsp; ByVal lpDestStr As Long, ByVal cchDest As Long) As Long</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG></STRONG></FONT>&nbsp;</P>
<P><FONT face="Courier New"><STRONG>Private Const SORT_WORDSORT = &amp;H0&amp;<BR>Private Const SORT_STRINGSORT = &amp;H1000&amp;<BR>Private Const LCMAP_SORTKEY = &amp;H400<BR>Private Const LCMAP_LOWERCASE = &amp;H100&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' lower case letters<BR>Private Const LCMAP_UPPERCASE = &amp;H200&amp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' upper case letters<BR>Private Const NORM_IGNORECASE = &amp;H1&amp;<BR>Private Const NORM_IGNORENONSPACE = &amp;H2&amp;<BR>Private Const NORM_IGNORESYMBOLS = &amp;H4&amp;<BR>Private Const NORM_IGNOREKANATYPE = &amp;H10000<BR>Private Const NORM_IGNOREWIDTH = &amp;H20000</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>Public Enum SortKeyFlags<BR>&nbsp;&nbsp;&nbsp; STRINGSORT = SORT_STRINGSORT<BR>&nbsp;&nbsp;&nbsp; IGNORECASE = NORM_IGNORECASE<BR>&nbsp;&nbsp;&nbsp; IGNORENONSPACE = NORM_IGNORENONSPACE<BR>&nbsp;&nbsp;&nbsp; IGNORESYMBOLS = NORM_IGNORESYMBOLS<BR>&nbsp;&nbsp;&nbsp; IGNOREKANATYPE = NORM_IGNOREKANATYPE<BR>&nbsp;&nbsp;&nbsp; IGNOREWIDTH = NORM_IGNOREWIDTH<BR>End Enum</STRONG></FONT></P>
<P><FONT face="Courier New"><STRONG>Public Function GetSortKey(ByVal lcid As Long, ByVal lpSrcStr As String, ByVal flags As SortKeyFlags) As Variant<BR>&nbsp;&nbsp;&nbsp; Dim rgbyt() As Byte<BR>&nbsp;&nbsp;&nbsp; Dim stBuff As String<BR>&nbsp;&nbsp;&nbsp; Dim cbReturn As String<BR>&nbsp;&nbsp;&nbsp; Dim cbBuff As Long<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; stBuff = String$(255, vbNullChar)<BR>&nbsp;&nbsp;&nbsp; cbBuff = LenB(stBuff)<BR>&nbsp;&nbsp;&nbsp; cbReturn = LCMapStringW(Locale, _<BR>&nbsp;&nbsp;&nbsp; LCMAP_SORTKEY, StrPtr(stIn), _<BR>&nbsp;&nbsp;&nbsp; LenB(stIn), StrPtr(stBuff), cbBuff)<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; If cbReturn &gt; 0 Then<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rgbyt = LeftB(stBuff, cbReturn)<BR>&nbsp;&nbsp;&nbsp; Else<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' not a supported language, so at least return the<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' same string that was sent in so some sort can happen<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rgbyt = stIn<BR>&nbsp;&nbsp;&nbsp; End If<BR>&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp; GetSortKey = rgbyt<BR>End Function</STRONG></FONT></P></BLOCKQUOTE>
<P><FONT face=Tahoma>To create a binary field to store that sort key value is a bit of extra work, and I will cover that in a post tomorrow.</FONT></P>
<P><FONT face=Tahoma>Tonight (Friday night) I am heading to a ship party, so we'll see how much work it will take to put myself back together after that, Saturday morning....</FONT></P>
<P><FONT face=Tahoma></FONT>&nbsp;</P>
<P><FONT face=Tahoma color=#ff1493><EM>This post brought to you by</EM> "<FONT size=6>à½œ</FONT>" <EM>(U+0f5c, a.k.a. TIBETAN LETTER DZHA)</EM></FONT></P>
<P><FONT face=Tahoma color=#ff1493><EM><FONT size=1>One of the many letters that are unsortable in Jet 4.0 but using this new method will find themselves sortable!</FONT></EM></FONT></P>
<hr/><p><a id="483393" href="#483393">#</a> <strong>James</strong> on 21 Oct 2005 6:12 AM:</p><div style="margin-left: 1em">Nothing to do with Jet or Collation I'm afraid, but are you taking topic suggestions? &quot;Add a comment&quot; on the latest &quot;Suggest a Topic&quot; page seems to have expired.</div>
<p><a id="483395" href="#483395">#</a> <strong>Michael S. Kaplan</strong> on 21 Oct 2005 6:26 AM:</p><div style="margin-left: 1em">The suggestion page (&lt;A HREF=&quot;/482609.aspx&quot;&gt;<a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2005/10/19/482609.html</A>">http://blogs.msdn.com/482609.aspx&lt;/A&gt;</a>) has been updated.... :-)</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2005/10/21/483315.html" title="It is our most modest receptacle....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2005/10/20/482926.html" title="Parameter confusion">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2005-10-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2005/10/21/480898.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:40 GMT -->
</html>