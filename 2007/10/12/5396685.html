<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/12/5396685.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>That function is always faster! (well, except for that one case when it can actually be slower...)</title></head><body>
<h1>That function is always faster! (well, except for that one case when it can actually be slower...)</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/12 10:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/12/5396685.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM><FONT color=#ff0000><STRONG>Warning</STRONG>: this post discusses an undocumented side effect of the shipping implementation of a&nbsp;few functions in the NLS API.&nbsp;The advice given is sound and is unlikely to ever become unsound, but relying on the side effect itself as a permanent state of affairs is probably not in your best interest, in case it ever is deemed&nbsp;a bug to fix by the team that owns it....</FONT></EM></P>
<P>Yesterday,&nbsp;I&nbsp;was asked about some performance results that were a bit puzzling.</P>
<P>It indirectly relates to what I was talking about in <A class="" href="http://archives.miloush.net/michkap/archive/2006/05/24/605599.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/24/605599.html"><STRONG>Invariant vs. Ordinal, the third</STRONG></A>. I did, in my list of reasons to call <A class="" href="http://archives.miloush.net/michkap/archive/2005/12/22/506595.html" mce_href="http://archives.miloush.net/michkap/archive/2005/12/22/506595.html"><STRONG>CompareStringOrdinal</STRONG></A>, point out that it was faster than <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A> (and in this case, the <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A> function that is essentially just a wrapper around <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>).</P>
<P>Now interestingly, there is a case in Vista and Server 2008&nbsp;where that is not always true....</P>
<P>It is an interesting side effect of the way both functions are written.</P>
<P>As I pointed out in <A class="" href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html" mce_href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html"><STRONG>A&amp;P of Sort Keys, part 13</STRONG></A>,&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A> both try to exit as soon as they can. Even though they have made mistakes at times (the main point of that post), it is often a good thing that it is as fast as possible. Everyone wants good performance, after all.</P>
<P>In fact, if your default user locale is not one with compressions in it and the strings are not at all similar, a call to <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>&nbsp;on two null-terminated strings will return after comparing that very first character in each string!</P>
<P>Now when you look at <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>, it is no slouch in the performance department -- and it has no changing behavior based on locale settings like <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>. It too will return with results of comparing those two dissimilar strings after comparing a single character. It does not even have to look up a weight, it just compares the code points directly. </P>
<P>However, now we get to the interesting side case -- as a wrapper around a funtion like&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms804321.aspx" mce_href="http://msdn2.microsoft.com/library/ms804321.aspx">RtlCompareUnicodeString</A>, the <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>&nbsp;function has to know the length of the strings (structures like <A class="" href="http://msdn2.microsoft.com/library/aa492030.aspx" mce_href="http://msdn2.microsoft.com/library/aa492030.aspx">UNICODE_STRING</A> have the length in them, after all!).</P>
<P>So if you call <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>&nbsp;and pass -1 to indicate the strings are NULL-terminated, then <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>&nbsp;has to walk&nbsp;each string an additional time to get the length.&nbsp; Not by any means a lengthy operation -- and compared to strings that are alike or close to it even a small amount of the time, not&nbsp;a big enough detail to make it look bad compared to <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>. But if you have a ton of strings that are nothing like each other most of the time, you'll see the difference that extra string walk adds to the elapsed time....</P>
<P>The actual performance difference is not huge, and as Gene Apperson once <A class="" href="http://archives.miloush.net/michkap/archive/2005/11/03/484974.html" mce_href="http://archives.miloush.net/michkap/archive/2005/11/03/484974.html"><STRONG>pointed out</STRONG></A>, "<EM>It doesn’t matter how fast your code is if it doesn’t work</EM>." So if it is the right function to call, then it is the right function to call, even if it were always slower.</P>
<P>In the future, the&nbsp;implementation&nbsp;could even change as long&nbsp;as the underlying behavior never did, in all sorts of&nbsp;ways.</P>
<P>One of the "strengths" in the argument to add this function was that it was just wrapping a function that has been around almost since the beginning of 32-bit Windows (<A class="" href="http://msdn2.microsoft.com/library/ms804321.aspx" mce_href="http://msdn2.microsoft.com/library/ms804321.aspx">RtlCompareUnicodeString</A>). Hoe very zen that one's strength turns out to be one's weakness? :-)</P>
<P>It is&nbsp;also interesting since in the case of <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>, passing -1 for both lengths (which is what <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>&nbsp;does)&nbsp;is more likely to be the most optimized case rather than passing the length when you know it by intentional design, yet in <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>&nbsp;(due to this side effect of the implementation) it is the other way around&nbsp;in Vista and Server 2008!</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>⼢</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/2f22" mce_href="http://www.fileformat.info/info/unicode/char/2f22">U+2f22</A>, a.k.a. KANGXI RADICAL GO SLOWLY)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/12/06 <a href="http://archives.miloush.net/michkap/archive/2011/12/06/10244626.html">CompareString != CompareStringOrdinal. Even if we want it to be.</a></p><p>2008/02/22 <a href="http://archives.miloush.net/michkap/archive/2008/02/22/7846597.html">Optimized for English (oh, and also Invariant, and NOTHING ELSE) Redux</a></p><p>2007/10/15 <a href="http://archives.miloush.net/michkap/archive/2007/10/15/5462057.html">We're Lost. Maybe the map is wrong. Maybe all maps are wrong?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/12/5396849.html" title="It isn&#39;t really PenIsland/PenisLand all over again">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/11/5398306.html" title="Unicode [prematurely?] posts the rules of how to handle the display of what you do not (in fact) support the display of">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-12">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/12/5396685.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>