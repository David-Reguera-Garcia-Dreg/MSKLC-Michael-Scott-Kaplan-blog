<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/09/5375754.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</title></head><body>
<h1>A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/09 10:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/09/5375754.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous posts in this series:</P>
<UL>
<LI>Part 0: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html">The empty string sorts the same in every language</A></STRONG> 
<LI>Part 1: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html">The law of the letter -- e.g. Latin &lt; Greek &lt; Cyrillic</A></STRONG> 
<LI>Part 2: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html"><STRONG>The string that won? Didn't have a mark on him!</STRONG></A> 
<LI>Part 3: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html"><STRONG>Should you let a string make it's case? If so, Y?</STRONG></A> 
<LI>Part 4: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html"><STRONG>It isn't a race but let's make an EXCEPTION and cross the Finnish line</STRONG></A> 
<LI>Part 5: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html"><STRONG>EXPANSIONing your horizons</STRONG></A> 
<LI>Part 6: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/16/4937196.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/16/4937196.html"><STRONG>Relax, be calm, and deCOMPRESS if you are feeling out of sorts</STRONG></A> 
<LI>Part 7: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/17/4950008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/17/4950008.html"><STRONG>You're very thin now, but I can still recognize you</STRONG></A> 
<LI>Part 8: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html"><STRONG>You can often think of ignoring weights as a form of ignorance</STRONG></A> 
<LI>Part 9: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html"><STRONG>Not always transitive, but punctual and punctuating</STRONG></A> 
<LI>Part 10: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/21/5027338.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/21/5027338.html"><STRONG>I've kana wanted to start talking about Japanese</STRONG></A> 
<LI>Part 11: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html"><STRONG>It's not like ideographic sorts were developed idiopathically</STRONG></A></LI>
<LI>Part 12: <A class="" href="http://archives.miloush.net/michkap/archive/2007/10/08/5270854.html" mce_href="http://archives.miloush.net/michkap/archive/2007/10/08/5270854.html"><STRONG>Han sorts first!</STRONG></A></LI></UL>
<P>Up until now I have been mainly talking about sortkey values and the underlying sort weights in Windows that are the source of them.</P>
<P>But this post is going to talk about something&nbsp;other than&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms776290.aspx" mce_href="http://msdn2.microsoft.com/library/ms776290.aspx">LCMapString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms776387.aspx" mce_href="http://msdn2.microsoft.com/library/ms776387.aspx">LCMapStringEx</A> with the LCMAP_SORTKEY flag, that wonderful function that will take any string and based on the modifying flags you pass will return a deterministic binary value that can be used to represent it any time you want to compare it against other binary value created the same way.</P>
<P>Because as cool as all of that is, it takes time!</P>
<P>I am not even done describing all of the different factors that impact sort key creation and it is already quite obvious that it is involved.</P>
<P>There are clearly times when you are comparing two strings where even though you might want all of the data that sits behind the process to be brought to bear that you really don't want to have to do quite so much work.</P>
<P>Isn't there some lazier version of the process that won't be all anal retentive staying until the bitter end, that will cut and run as soon as it knows the answer?</P>
<P>Yes, in fact there is!</P>
<P mce_keep="true">And we call it <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>!</P>
<P mce_keep="true">Their job is to work for as long as they to have to to get you the answer to the "Which Comes First?" question, <STRONG>and no longer</STRONG>.</P>
<P mce_keep="true">So you can think of it as a real lazybones, cutting corners at every step it can get away with.</P>
<P mce_keep="true">You may have met people like this before in your life; I wonder what your opinion of them was?</P>
<P mce_keep="true">I mean, <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>&nbsp;and <A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>&nbsp;are not the kids who used to sit in the front of the bus, report you for not having a hall pass, and getting you in trouble.</P>
<P mce_keep="true">But they are clearly the kids who used to get away with stuff without always putting in the time that you did, following the rules....</P>
<P mce_keep="true">We thought they were <A class="" href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html" mce_href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html"><STRONG>so very cool</STRONG></A>&nbsp;growing up, and maybe we were right.</P>
<P mce_keep="true">Of course, as I approach my 20th high school reunion next year, curious as to how everyone is doing (perhaps even curious enough to attend!), I can't help but wonder about the price one pays for going through life, always taking the shortest way out of getting the work done.</P>
<P mce_keep="true">What happens is that mistakes are sometimes made. </P>
<P mce_keep="true">Forgetting to tag second base, omitting the dot on the <STRONG>i</STRONG> or the cross on the <STRONG>t</STRONG>, however you want to think if it. It maybe wasn't intentional, but when you get called out, you have to take your licks and try to do better next time.</P>
<P mce_keep="true">And to be honest, it happens here too!</P>
<P mce_keep="true">There are times that the results of comparing the sort keys returned&nbsp;on two strings run through&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms776290.aspx" mce_href="http://msdn2.microsoft.com/library/ms776290.aspx">LCMapString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms776387.aspx" mce_href="http://msdn2.microsoft.com/library/ms776387.aspx">LCMapStringEx</A> with the LCMAP_SORTKEY flag returns different results than <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>&nbsp;looking at the same two strings (#12 from <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html"><STRONG>How to track down collation bugs</STRONG></A>).</P>
<P mce_keep="true">And in almost every case (in fact, offhand the only exception I can recall is <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/30/564598.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/30/564598.html"><STRONG>this bug</STRONG></A>) an objective analysis of the results tends to consistently show that when the results between these two methodologies are different, it is <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>&nbsp;that is wrong.</P>
<P mce_keep="true">Kind of ironic&nbsp;(when you consider the importance that&nbsp;SQL Server places on quality of results) that SQL Server's collation is really based on their CompareString snapshot's results! :-(</P>
<P mce_keep="true">I wonder at times if one were going to take a step back and implement a brand new function from scratch (something on my mind <A class="" href="http://archives.miloush.net/michkap/archive/2007/10/08/5320425.html" mce_href="http://archives.miloush.net/michkap/archive/2007/10/08/5320425.html"><STRONG>these days</STRONG></A>, at least in theory)&nbsp;what one would do differently to keep the whole "take the easy way out" mentality from hurting the goal of correct results....</P>
<P mce_keep="true">Imagine if such a&nbsp;function had a design goal of 100% compatibility with the <A class="" href="http://msdn2.microsoft.com/library/ms776290.aspx" mce_href="http://msdn2.microsoft.com/library/ms776290.aspx">LCMapString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms776387.aspx" mce_href="http://msdn2.microsoft.com/library/ms776387.aspx">LCMapStringEx</A> with the LCMAP_SORTKEY flag comparison results....</P>
<P mce_keep="true"><EM>Never mind, it won't happen (though it would an interesting design to architect); I am trying to fix model flaws here that deny the 100% compatibility goal. Sorry!</EM></P>
<P mce_keep="true">The other occasional kinds of bugs that are <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>-specific are #4, #6, and #7 from <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html"><STRONG>How to track down collation bugs</STRONG></A>&nbsp;and again represent cases where the "do it fast" methodology around <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647477.aspx" mce_href="http://msdn2.microsoft.com/library/ms647477.aspx">CompareStringEx</A>&nbsp;can lead to problems (though #6 type bugs are never found by SQL Server since they always pass the length and thus never even touch the (technically even faster) code that the -1 lengths can sometimes give).</P>
<P mce_keep="true">In another stounding burst of irony, there is an even quicker version of the string comparison function found in the .NET Framework which, due to a bug that I only accidently found in the beginning of the Whidbey (2.0) product cycle, was never even called in versions 1.0 or 1.1. Subsequent to the decision to fix the bug by enabling the superfast function<FONT size=1><SUP>1</SUP></FONT>, no fewer than five bugs were found by testers in the logic of this attempt to capture optimizable calls to <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>-like code, due not only to the probelm above but an unrelated obsession with&nbsp;making English faster even if it makes the more complicated languages a bit slower<SUP><FONT size=1>2</FONT></SUP>....</P>
<P mce_keep="true">Maybe I am feeling kind of philosophical here (and I a bit too much of a geek to get all into the karma of code here!), but would this represent some kind of proof that taking the approach of cutting corners is itself inherently more likely to cause problems?</P>
<P mce_keep="true">TWIST: In truth, #4, #6, #7, and #12 of <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html"><STRONG>How to track down collation bugs</STRONG></A>&nbsp;are only responsible for half the bugs I worked on in Vista in these functions. I'll talk about the other half in an upcoming post<SUP><FONT size=1>3</FONT></SUP>. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT size=1>1 - My recommendation to yank it out since it we never called anyway was denied, but I was overruled given the universal reluctance to remove an intentional opimization from the code, even one that was never used.<BR>2 - An occupational hazard of a US-based software company. :-(<BR>3 - Foreshadowing -- truly a sign of quality literature.</FONT></P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>⑬</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/246c" mce_href="http://www.fileformat.info/info/unicode/char/246c">U+246c</A>, a.k.a. CIRCLED NUMBER THIRTEEN)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/09/07 <a href="http://archives.miloush.net/michkap/archive/2010/09/07/10058112.html">Refusing to ignore some particular character's width isn't [always] an act of discrimination…</a></p><p>2008/08/21 <a href="http://archives.miloush.net/michkap/archive/2008/08/21/8883467.html">A&P of Sort Keys, part 14: The Hangul is really getting OLD</a></p><p>2008/02/22 <a href="http://archives.miloush.net/michkap/archive/2008/02/22/7846597.html">Optimized for English (oh, and also Invariant, and NOTHING ELSE) Redux</a></p><p>2007/10/12 <a href="http://archives.miloush.net/michkap/archive/2007/10/12/5396685.html">That function is always faster! (well, except for that one case when it can actually be slower...)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/10/5391832.html" title="Core XP user interface languages are not free as in beer, or speech">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/09/5375024.html" title="If you are going to take it so literally, you may want to give &#39;em a quote or two">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-09">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/09/5375754.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>