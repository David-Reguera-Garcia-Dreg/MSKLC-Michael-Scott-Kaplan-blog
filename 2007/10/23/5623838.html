<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/23/5623838.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If you would wait till I *FINISHED* what I was trying to say, you punk... (aka Premature validation)</title></head><body>
<h1>If you would wait till I *FINISHED* what I was trying to say, you punk... (aka Premature validation)</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/23 10:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/23/5623838.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>This&nbsp;may have happened to you&nbsp;before.&nbsp;</P>
<P>Sometimes&nbsp;I am trying to have a conversation with someone.</P>
<P>And&nbsp;then when I start to say something, they interrupt me because they hear the first thing I said and decide to react to that thing before I have finished the thought.</P>
<P>There was a clear and unmistakable indication that I was not done, but this person who is so sure that he knows better just interrupts anyway.</P>
<P>This person is an insensitive&nbsp;jerk, right?</P>
<P>Well, in this particular case, the person is not, in fact,&nbsp;a person. It is a computer program. :-)</P>
<P>Maybe it is a managed WinForms application, responding to a TextBox control's <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.control.textchanged.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.control.textchanged.aspx">TextChanged&nbsp;Event</A> that indicates the contents of the control have changed.</P>
<P>Or maybe it is an unmanaged Unicode Win32 program, responding to each <A class="" href="http://msdn2.microsoft.com/library/ms646276.aspx" mce_href="http://msdn2.microsoft.com/library/ms646276.aspx">WM_CHAR Notification</A> that indicates a character has&nbsp;been added to a control.</P>
<P>Perhaps these programs are trying really had to validate the content of the control to keep the "bad characters" (whatever they may be) from being entered. Or some equally reasonable process may be taking place. But it honestly does not matter -- because these programs, like the&nbsp;utter boob of an antisocial little weasel I talked about earlier in the post,&nbsp;are being insensitive jerks....</P>
<P>Because if the character one sees is a <STRONG>high surrogate code point</STRONG>&nbsp;(<A class="" href="http://www.fileformat.info/info/unicode/char/d800" mce_href="http://www.fileformat.info/info/unicode/char/d800">U+d800</A> to <A class="" href="http://www.fileformat.info/info/unicode/char/dbff" mce_href="http://www.fileformat.info/info/unicode/char/dbff">U+dbff</A>), then responding to the&nbsp;<U><FONT color=#0000ff>event</FONT></U> or the <U><FONT color=#800080>notification</FONT></U> at that moment is premature -- since a <STRONG>low surrogate code point</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/dc00" mce_href="http://www.fileformat.info/info/unicode/char/dc00">U+dc00</A> to <A class="" href="http://www.fileformat.info/info/unicode/char/dfff" mce_href="http://www.fileformat.info/info/unicode/char/dfff">U+dfff</A>) is expected to follow shortly, as&nbsp;the very next <U><FONT color=#0000ff>event</FONT></U> fired/<U><FONT color=#800080>notification</FONT></U> received.</P>
<P>Any validation one does such as the&nbsp;program in the bug I looked at recently that they decided not to fix in some <EM>Advanced Settings for Services</EM> dialog that was throwing an exception (whose message&nbsp;is <A class="" href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html"><STRONG>mistakenly</STRONG></A> (i.e. <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/27/444101.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/27/444101.html"><STRONG>dumbly</STRONG></A>) referring to surrogate code points as <STRONG>surrogate characters</STRONG>!):</P>
<BLOCKQUOTE>
<DIR><FONT size=1>
<P>System.ArgumentException occurred<BR>Message="The surrogate pair (0xD840, 0xD840) is invalid. A high surrogate character (0xD800 - 0xDBFF) must always be paired with a low surrogate character (0xDC00 - 0xDFFF)."<BR>Source="System.Xml"<BR>StackTrace:<BR>&nbsp;&nbsp;&nbsp; at System.Xml.XmlTextEncoder.Write(String text)</P></DIR></FONT></BLOCKQUOTE>
<P>Now at least with the person one can try to lecture&nbsp;him a bit, and tell him "Look, you wanker! If you'd let me finish what I was saying you'd see you were about to get that low surrogate. Why are you for freaking impatient? Are you like this with your wife? Maybe that's why she's off shagging the pool-boy ya freakin' idiot!"</P>
<P>But with a program throwing an exception, what can one say? All one can do is just&nbsp;console&nbsp;oneself with the knowledge&nbsp;that a program can (in essence) be as much of a wanker as a person, if you give it a chance....</P>
<P>And what the hell kind of program is so insecure about people entering invalid data that it has to be validating as it goes?</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>⧜</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/29dc" mce_href="http://www.fileformat.info/info/unicode/char/29dc">U+29dc</A>, a.k.a. INCOMPLETE INFINITY)</EM></FONT></P>
<hr/><p><a id="5627462" href="#5627462">#</a> <strong>Serge Wautier</strong> on 23 Oct 2007 12:37 PM:</p><div style="margin-left: 1em"><p>Isn't it some kind of design bug when events are sent for each half code point ?</p></div>
<p><a id="5627497" href="#5627497">#</a> <strong>Michael S. Kaplan</strong> on 23 Oct 2007 12:38 PM:</p><div style="margin-left: 1em"><P>Nope -- because the documentation is clearly suggesting UTF-16, not Unicode Scalar Values (which might imply UTF-32).</P></div>
<p><a id="5629616" href="#5629616">#</a> <strong>Centaur</strong> on 23 Oct 2007 2:25 PM:</p><div style="margin-left: 1em"><p>A simpler example of such premature validation is when an application expects an integer and tries to parse the entered string as an integer at every change. Then, the user starts to enter a negative integer, presses '-', gets a validation error “'-' is not a valid integer”. Stupid program, I’ve just started.</p>
<p>Another case is two edits for a range of integers. User enters the low end, starts entering the high end, gets a validation error, “the high end must be greater than the low end”.</p>
<p>Validation should almost always done only in response to an OK or Apply button, not on every change. Validating on focus loss is not much better.</p>
</div>
<p><a id="5630016" href="#5630016">#</a> <strong>Michael S. Kaplan</strong> on 23 Oct 2007 2:47 PM:</p><div style="margin-left: 1em"><p>Excellent point -- of course that one everybody would agree with, while the surrigate pair case, many developers argue against (and they did decide not to fix that bug in their upcoming release!).</p>
</div>
<p><a id="5633120" href="#5633120">#</a> <strong>Serge Wautier</strong> on 23 Oct 2007 5:25 PM:</p><div style="margin-left: 1em"><p>&gt; because the documentation is clearly suggesting UTF-16</p>
<p>You mean documenting a bug makes it a feature? ;-)</p></div>
<p><a id="5633669" href="#5633669">#</a> <strong>Jeffrey L. Whitledge</strong> on 23 Oct 2007 5:54 PM:</p><div style="margin-left: 1em"><p>I once had to deal with a masked edit date control that validated on every date-part. So to get from 2008-10-31 to 2008-02-01 you had to change the day of month before you could change the month, since Feb 31 is invalid. It was a stupid pain every time.</p>
<p>Masked edit controls are evil, and I am glad that nobody uses them anymore!</p></div>
<p><a id="5637378" href="#5637378">#</a> <strong>Mihai</strong> on 23 Oct 2007 8:50 PM:</p><div style="margin-left: 1em"><p>I can only see two acceptable options (nothing to do with i18n, just good user experience):</p>
<p> - in the Ok/Apply (especially if you have to correlate between several fields, for instance if the country is U.S., then state becomes mandatory)</p>
<p> - in the change notification but non-blocking (i.e. make the field background red)</p>
<p>But in general I am against any validation, if you cannot make it smart enough. Things like &quot;zip code should be digits only&quot; (not if I am outside US), or &quot;you can only use letters and digits in the street name&quot; (not if my street name has accents), etc.</p></div>
<p><a id="5646340" href="#5646340">#</a> <strong>Mike Dimmick</strong> on 24 Oct 2007 6:06 AM:</p><div style="margin-left: 1em"><p>So you're basically saying that WM_CHAR can send you surrogates in the case of typing characters in the supplementary planes, and therefore the naive implementation of appending the typed character to your current string, then updating the display with that string, is flawed? It depends rather on what GDI (or other drawing API) will do with a string containing just a high surrogate followed by an ordinary character.</p>
<p>Should we all be handling WM_UNICHAR instead/as well?</p>
<p>What the documentation does not appear to say is when you get a WM_UNICHAR message. Well, it says that the message is posted to the window when TranslateMessage processes a WM_KEYDOWN message. Spy++ doesn't show this but then the version I have (8.00.50727, came with VS2005) seems a little faulty - maybe it is itself hooking using an ANSI function? - as when I type ỳ (U+1EF3, not on Windows-1252) on my UK extended keyboard layout it's coming through to Spy++ as 0x3F = '?'.</p></div>
<p><a id="5646774" href="#5646774">#</a> <strong>Mike Dimmick</strong> on 24 Oct 2007 6:27 AM:</p><div style="margin-left: 1em"><p>In the 'excess validation' case I have continuing problems where a business or government service is using Royal Mail's Postcode Address File database (<a rel="nofollow" target="_new" href="http://www.royalmail.com/portal/rm/jump2?catId=400084&amp;mediaId=400085">http://www.royalmail.com/portal/rm/jump2?catId=400084&amp;mediaId=400085</a>) to validate addresses and rejecting anything not found in that database. Here's the joke - my valid address is not in PAF. I've asked Royal Mail, and they won't change the record.</p>
<p>I live in a house that was divided into two flats, but the two flats share a single front door. The local council, for tax purposes, considers the two flats as separate properties (and therefore are taxed separately), but Royal Mail consider it one address. The house number was 17, my landlady who did the conversion calls my flat 17A, and the council calls it First Floor Flat, 17. When I moved my bank accounts and credit cards I wasn't aware of the council's designation so used '17A'.</p>
<p>Here comes the fun. I paid for a TV licence (here in the UK, the public service broadcaster, the BBC, is funded mainly through compulsory licences to operate a TV set) using 17A as the address. However, I didn't notice that they 'validated' the address by removing the A. When you buy TV equipment, the retailer is obligated to inform the TV Licensing Authority of the address to ensure it's licensed. Because I bought a new TV online, I had the delivery address the same as the credit card address. TV Licensing did a lookup and found no licence for 17A. I try to modify the licence address online, I can't change it because it 'validates' it back to 17 again. I went through a lot of unanswered emails and phone calls before they finally responded and have accepted that this is a separate address.</p>
<p>Royal Mail won't change the address on PAF because of the shared mailbox (it's just a flap on the shared front door).</p>
<p>I think there is some part of the documentation for PAF which tells users that it shouldn't be considered authoritative, but when did developers read the documentation? &lt;g&gt;</p></div>
<p><a id="5665039" href="#5665039">#</a> <strong>Michiel</strong> on 25 Oct 2007 7:16 AM:</p><div style="margin-left: 1em"><p>Validation of a string in such cases has three results: illegal, legal string and legal prefix. The specific case is a good example of a legal prefix. It's possible to add a low surrogate to make it a legal string.</p>
<p>With this concept you can show an error message when an invalid string is entered and show the apply button if a legal string is validated. In the legal prefix state you can provide more input.</p></div>
<p><a id="5696054" href="#5696054">#</a> <strong>Maurits [MSFT]</strong> on 26 Oct 2007 5:47 PM:</p><div style="margin-left: 1em"><p>I remember a post on thedailywtf.com a long time ago where someone wrote a slightly insecure user authentication system:</p>
<p>This was the web page:</p>
<p>Username [ _______ ]</p>
<p>Password [ _______ ]</p>
<p>After the user typed in the username, and while the user was typing in the password, the site would use AJAX to see if the password *so far* was correct (that is, whether it was a prefix of the correct password.)</p>
<p>When the first wrong character was typed, the page would display an &quot;Incorrect password!&quot; message.</p>
<p>How convenient.</p>
<p>The code reviewer responded by calling the developer over, entering the developer's username, and beginning the incredibly easy task of figuring out the developer's password, one character at a time...</p>
</div>
<p><strong>Jan Kučera</strong> on 12 Nov 2007 7:02 AM:</p><div style="margin-left: 1em"><p>A fledgling question here.. I just wonder.. how could one enter these surrogate characters? I did not find mentioned range in the Character Map...</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/11/12 <a href="http://archives.miloush.net/michkap/archive/2007/11/12/6139309.html">I'm simply saying that life^H^H^H^Hcharacters, uh... find a way</a></p><p>2007/10/26 <a href="http://archives.miloush.net/michkap/archive/2007/10/26/5677876.html">I agree, the best way to process Unicode input is indeed to make somebody else do it</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/24/5634778.html" title="Blog: 1; Blogger: 0 (aka You must think carefully before devoting yourself to a lifetime of blogging)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/23/5617352.html" title="If working above U+FFFF is a problem n your program, then so is the basic stuff, too">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/23/5623838.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>