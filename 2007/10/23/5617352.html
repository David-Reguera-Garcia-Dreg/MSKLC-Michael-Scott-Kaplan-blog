<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/23/5617352.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If working above U+FFFF is a problem n your program, then so is the basic stuff, too</title></head><body>
<h1>If working above U+FFFF is a problem n your program, then so is the basic stuff, too</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/23 10:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/23/5617352.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>So yesterday, the question asked on a Win3 programming alias inside Microsoft was:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>I am looking for some document on Windows support for Unicode characters above 0xFFFF. How well does Windows support these code points?<BR><BR>Since each character can no longer be represented by one wchar_t, does the programmer need to do something special?<BR><BR>Does WideCharToMultiByte with CP_UTF8 work with these code points?&nbsp; (Are we going to see UTF-8 encoded character of more than 3 bytes?)</EM></FONT></P></BLOCKQUOTE>
<P>I really get nervous when questions like this get asked. :-)</P>
<P>Mainly because generally speaking, everything should work just&nbsp;fine -- any app that can support <A class="" href="http://www.fileformat.info/info/unicode/char/006f" mce_href="http://www.fileformat.info/info/unicode/char/006f">U+006f</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0308" mce_href="http://www.fileformat.info/info/unicode/char/0308">U+0308</A> (ö -- o with combining umlaut) properly can support <A class="" href="http://www.fileformat.info/info/unicode/char/d840" mce_href="http://www.fileformat.info/info/unicode/char/d840">U+d840</A> <A class="" href="http://www.fileformat.info/info/unicode/char/dc00" mce_href="http://www.fileformat.info/info/unicode/char/dc00">U+dc00</A> (𠀀, the first Extension B ideograph).</P>
<P>Of course there are applicatuions that are screwing up that simple Latin script cae, though such applications have bigger problems than supplementary characters!</P>
<P>Most developers don't need to care, since the level they work at is buffer allocations and size parameters -- which deals with literal WCHAR caloues, not what the user thinks of as a character....</P>
<P>But one of the most important points about supplementary characters I did not mention in <A class="" href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/24/472543.html"><STRONG>The basics of supplementary</STRONG></A> is that since the high surrogates and low surrogates are each in their own unique ranges that do not overlap with themselves or any other character, they are much easier to work with than all of the olf lead byte/trail byte stuff in MBCS where some trail bytes were also lead bytes, etc. It makes all of these things much easier to handle....</P>
<P>Dave then added another bit to the question:</P>
<BLOCKQUOTE>
<P><EM>What if the application does simple parsing for ‘ANSI’ type characters?&nbsp; Examples: ‘/’, ‘.’, etc.&nbsp; Ones commonly used in paths or command lines.&nbsp; Unaware WCHAR parsing could accidentally pick up those characters in the 2nd half of a 4 byte character.&nbsp; Is there an easy way to avoid this problem?<BR><BR>It seems that this could be a problem if UTF-8 characters can be in a filename. Or anything that can be interpreted as a path.<BR><BR>This would be avoided if UTF-8 is designed to exclude the “zero-extended ANSI characters” (for lack of a shorter name) from the 2nd half of a 4 byte character.</EM></P></BLOCKQUOTE>
<P>If this were true it would be more of a worry, but then it is hard to know why UTF-8 has to be included if you are on Windows where all the file paths are in UTF-16, not UTF-8...</P>
<P>In fact, given the issues I raised in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/17/4950277.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/17/4950277.html"><STRONG>The torrents of U+fffd (aka When security and conformance trump compatibility and reality)</STRONG></A>, it is fair to say that UTF-8 is entirely inappropriate as an encoding to store file paths in (since there are a great many sequences that are legal in file paths but are illegal in Unicode and will be replaced with � (<A class="" href="http://www.fileformat.info/info/unicode/char/fffd" mce_href="http://www.fileformat.info/info/unicode/char/fffd">U+fffd</A>, REPLACEMENT CHARACTER) and thus will be unreachable by any technology that uses the NLS or .NET code page/encoding conversion mechanisms.</P>
<P>Though if we ignore that for a moment and go to Dave's concern more directly, the byte layout for UTF-8 is very predictable (I discuss it a bit in posts like <A class="" href="http://archives.miloush.net/michkap/archive/2006/12/10/1252776.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/10/1252776.html"><STRONG>Don't want to convert all at once? Well, maybe you could just nibble?</STRONG></A> and <A class="" href="http://archives.miloush.net/michkap/archive/2005/05/21/420708.html" mce_href="http://archives.miloush.net/michkap/archive/2005/05/21/420708.html"><STRONG>Getting exactly ONE Unicode code point out of UTF-8</STRONG></A>). Things would actually be quite safe in UTF-8, were it not for the fact that so many valid file paths could never make it there in the first place....</P>
<P>So use "W" Win32 API functions and keep it in UTF-16 if you want things to work right here. Every attempt to convert out of it to UTF-8&nbsp;(this may be a common operation in .NET? Need to check on this) can be disatrous for real world data. :-(</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> 𠀀 <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/20000" mce_href="http://www.fileformat.info/info/unicode/char/20000">U+20000</A>, the first CJK EXTENSION B ideograph)</EM></FONT></P>
<hr/><p><a id="5628401" href="#5628401">#</a> <strong>jmdesp</strong> on 23 Oct 2007 1:28 PM:</p><div style="margin-left: 1em"><p>UTF-16 does not protect you from invalid sequences. If you have garbage inside your file path, you might as well encounter isolated surrogate that will be invalide in UTF-16 just as well as in UTF-8. It's just that the probability being lower it takes more character until you meet one.</p></div>
<p><a id="5628930" href="#5628930">#</a> <strong>Michael S. Kaplan</strong> on 23 Oct 2007 1:53 PM:</p><div style="margin-left: 1em"><p>I agree 100% that it was always invalid -- but it looked just fine on disk and it worked (it was only after the conversion that its invalidity was exposed).</p>
</div>
<p><a id="5633411" href="#5633411">#</a> <strong>Andrew West</strong> on 23 Oct 2007 5:39 PM:</p><div style="margin-left: 1em"><p>&quot;any app that can support U+006f U+0308 (ö -- o with combining umlaut) properly can support U+d840 U+dc00 (𠀀, the first Extension B ideograph).&quot;</p>
<p>Any app except Google Reader apparently, where your post ends abruptly with:</p>
<p>Mainly because generally speaking, everything should work just fine -- any app that can support U+006f U+0308 (ö -- o with combining umlaut) properly can support U+d840 U+dc00 (</p></div>
<p><a id="5637221" href="#5637221">#</a> <strong>Mihai</strong> on 23 Oct 2007 8:41 PM:</p><div style="margin-left: 1em"><p>Not to mention that looking for ASCII (not ANSI) in UTF-8 is not a problem. If you find it, then it is really what you where looking for (due to the structure of the UTF-8, which overlaps 100% with plain ASCII). No problems with / \ | . ? etc.</p>
<p>This is (probably) what pleases the advocates of UTF-8: they never had to handle anything beyond ASCII, or simple buffer manipulations.</p>
<p>Once you try going beyond that, they will have the same problems that UTF-16 users have with combining character or surrogates (not many).</p>
<p>But thing is: if you do that kind of advanced processing, UTF-16 users will have problems with surrogates and combining characters, while UTF-8 users will have problems with everything above 127. </p>
<p>Now, you tell me who has the advantage?</p>
<p>:-)</p></div>
<p><a id="5656258" href="#5656258">#</a> <strong>mlippert</strong> on 24 Oct 2007 4:00 PM:</p><div style="margin-left: 1em"><p>Michael,</p>
<p>I looked at the various links, but I'm still unclear as to what &quot;characters&quot; are legal in a file path, but aren't legal Unicode?</p>
<p>The only things I can think of would be surrogates out of order or alone, or perhaps undefined codepoints? But I can't imagine quite how they used to get created.</p>
<p>The bug that was linked to seemed to mention &#225; ('a' with an acute accent) but I'm not sure why that would be an illegal character.</p>
<p>Mike L.</p>
</div>
<p><a id="5656890" href="#5656890">#</a> <strong>Michael S. Kaplan</strong> on 24 Oct 2007 5:19 PM:</p><div style="margin-left: 1em"><p>Unpaied surrogates, permanently reserved characters, all of these things are stripped in conversion and replaced with U+fffd.</p>
</div>
<p><a id="5678366" href="#5678366">#</a> <strong>mlippert</strong> on 25 Oct 2007 4:24 PM:</p><div style="margin-left: 1em"><p>Thanks.</p>
<p>So what you're saying is that those things (unpaired surrogates etc) are legal to NTFS because it accepts *any* value as valid, not treating the given path/filename string as a sequence of unicode characters but instead as a sequence of 16-bit words?</p>
<p>Well that would explain the issue you've been discussing.</p>
</div>
<p><a id="5678644" href="#5678644">#</a> <strong>Michael S. Kaplan</strong> on 25 Oct 2007 4:38 PM:</p><div style="margin-left: 1em"><p>Exactly -- a clear engineer's solution to the problem! :-)</p>
</div>
<p><a id="5714294" href="#5714294">#</a> <strong>Nick Lamb</strong> on 27 Oct 2007 12:22 PM:</p><div style="margin-left: 1em"><p>Here's a fun thought Michael, how many Windows programs do you think realise that valid filenames presented to them as an array of wchar_t are not actually guaranteed to be Unicode strings ?</p>
<p>As with any other failed expectation this has security implications. Do the relevant APIs warn about that ?</p></div>
<p><a id="5714366" href="#5714366">#</a> <strong>Michael S. Kaplan</strong> on 27 Oct 2007 12:29 PM:</p><div style="margin-left: 1em"><p>Not sure that has to do with THIS post, given that it is talking about valid input. Did you mean for this comment to go to a different post (like the one on UTF-8, maybe)?</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/23/5623838.html" title="If you would wait till I *FINISHED* what I was trying to say, you punk... (aka Premature validation)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/23/5615433.html" title="I&#39;m not screaming though it seems I may be the only one...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/23/5617352.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>