<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/08/5347670.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Wanna take a look at the collation bug Kim pointed out? You're in for a hell of a Tripp!</title></head><body>
<h1>Wanna take a look at the collation bug Kim pointed out? You're in for a hell of a Tripp!</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/08 10:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/08/5347670.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Over on the side is that list of blogs I read, in various categories, one of them is Kimberly L. Tripp's, who I once had like an hour-long conversation with, incredibly impressed by her for what she was saying before being even more impressed after realizing who she is and connecting her to all the stuff she has said in the past.</P>
<P>I think the last time I linked to her was back in May 2006 (<A class="" href="http://archives.miloush.net/michkap/archive/2006/05/30/610889.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/30/610889.html"><STRONG>Avoiding SQL Server collation woes in the TempDB</STRONG></A>), but it was a great tip since I was doing it the hard[er] way when I really didn't need to....</P>
<P>The fact is, she is a hell of a Tripp. :-)</P>
<P>Late last week when she posted <A class="" href="http://www.sqlskills.com/blogs/kimberly/CommentView.aspx?guid=4189dda3-2eeb-4152-8711-2cb973c0c025" mce_href="http://www.sqlskills.com/blogs/kimberly/CommentView.aspx?guid=4189dda3-2eeb-4152-8711-2cb973c0c025">The perils of case-insensitive data (and our life in tangent-land)</A> I was captivated once again by the words.</P>
<P>Not for the two problems the post was nominally posing solutions for (both of which had good solutions suggested) but one of the tangents, quoted in part here:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P><FONT color=#008000>-- First, I'll create a test database. Without a collation specified, <BR>-- it will use the server's default collation.</FONT></P><FONT color=#0000ff size=2>
<P>CREATE</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>DATABASE</FONT><FONT size=2><FONT color=#000000> TestAdventureWorks<BR></FONT>go</P></FONT><FONT color=#008000 size=2>
<P>-- Verify the database collation<BR></FONT><FONT color=#0000ff size=2>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff00ff size=2>DATABASEPROPERTYEX</FONT><FONT color=#808080 size=2>(</FONT><FONT color=#ff0000 size=2>'TestAdventureWorks'</FONT><FONT color=#808080 size=2>,</FONT><FONT color=#000000 size=2> </FONT><FONT color=#ff0000 size=2>'Collation'</FONT><FONT color=#808080 size=2>)<BR></FONT><FONT size=2>go</P></FONT><FONT color=#008000 size=2>
<P>-- database is set to SQL_Latin1_General_CP1_CI_AS as expected<BR>-- this is a case-insensitive database</P></FONT><FONT color=#0000ff size=2>
<P>USE</FONT><FONT size=2><FONT color=#000000> TestAdventureWorks<BR></FONT>go</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> LastName </FONT><FONT color=#0000ff size=2>collate</FONT><FONT color=#000000 size=2> database_default </FONT><FONT color=#0000ff size=2>AS</FONT><FONT size=2><FONT color=#000000> LastName<BR></FONT></FONT><FONT color=#808080 size=2>,</FONT><FONT size=2> FirstName </FONT><FONT color=#0000ff size=2>collate</FONT><FONT size=2> database_default </FONT><FONT color=#0000ff size=2>AS</FONT><FONT size=2> FirstName<BR></FONT><FONT color=#808080 size=2>,</FONT><FONT size=2> MiddleName </FONT><FONT color=#0000ff size=2>collate</FONT><FONT size=2> database_default </FONT><FONT color=#0000ff size=2>AS</FONT><FONT size=2> MiddleName<BR></FONT><FONT color=#0000ff size=2>INTO</FONT><FONT size=2><FONT color=#000000> MyTestContacts<BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT color=#000000 size=2> Adventureworks</FONT><FONT color=#808080 size=2>.</FONT><FONT color=#000000 size=2>Person</FONT><FONT color=#808080 size=2>.</FONT><FONT size=2><FONT color=#000000>Contact<BR></FONT>go</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> MyTestContacts <BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> Lastname </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'Adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (86 row(s) affected)</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> MyTestContacts <BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> Lastname </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (86 row(s) affected)</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> MyTestContacts <BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> Lastname </FONT><FONT color=#0000ff size=2>COLLATE</FONT><FONT color=#000000 size=2> Latin1_General_CS_AS_KS_WS </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'Adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (86 row(s) affected)</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> MyTestContacts <BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> Lastname </FONT><FONT color=#0000ff size=2>COLLATE</FONT><FONT color=#000000 size=2> Latin1_General_CS_AS_KS_WS </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (0 row(s) affected)</P>
<P>-- Next, create a view:<BR></FONT><FONT color=#0000ff size=2>CREATE</FONT><FONT color=#000000 size=2> </FONT><FONT color=#0000ff size=2>VIEW</FONT><FONT size=2><FONT color=#000000> ContactLastNameCaseSensitive<BR></FONT></FONT><FONT color=#0000ff size=2>AS<BR>SELECT</FONT><FONT color=#000000 size=2> LastName </FONT><FONT color=#0000ff size=2>COLLATE</FONT><FONT color=#000000 size=2> Latin1_General_CS_AS_KS_WS </FONT><FONT color=#0000ff size=2>AS</FONT><FONT size=2><FONT color=#000000> CSName<BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> MyTestContacts<BR></FONT>go</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> ContactLastNameCaseSensitive<BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> CSName </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'Adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (86 row(s) affected)</P></FONT><FONT color=#0000ff size=2>
<P>SELECT</FONT><FONT color=#000000 size=2> </FONT><FONT color=#808080 size=2>*</FONT><FONT size=2><FONT color=#000000> <BR></FONT></FONT><FONT color=#0000ff size=2>FROM</FONT><FONT size=2><FONT color=#000000> ContactLastNameCaseSensitive<BR></FONT></FONT><FONT color=#0000ff size=2>WHERE</FONT><FONT color=#000000 size=2> CSName </FONT><FONT color=#808080 size=2>=</FONT><FONT color=#000000 size=2> N</FONT><FONT color=#ff0000 size=2>'adams'<BR></FONT><FONT size=2>go </FONT><FONT color=#008000 size=2>-- (0 row(s) affected)</P></FONT>
<P>And, everything works... in TestAdventureworks. In&nbsp;the *real*&nbsp;AdventureWorks, I get an error when I try to create the view:<BR><FONT color=#ff0000 size=2>Msg 2791, Level 16, State 5, Procedure ContactLastNameCaseSensitive, Line 3<BR>Could not resolve expression for schemabound object or constraint.</P></FONT>
<P>So, this is the first issue. It seems as though you can't create the view if your database has a different collation than the server collation. Well, (again), I haven't spent all that much time on this one but I did repro what the chain on the forum seemed to have found.</P></BLOCKQUOTE></BLOCKQUOTE>
<P mce_keep="true">This does indeed seem like a bug, but one that is easy to imagine in a world where collations that will return identical results (e.g. Unicode data in LATIN1_GENERAL_CI_AS and GREEK_CI_AS) yet they will be considered incompatible for the purposes of trying to compare columns using each of them.</P>
<P mce_keep="true">Those errors all tend to fall under the "<EM>Columns in this expression have incompatible collations</EM>" or "<EM>The collation properties of columns &lt;Columnname&gt; and &lt;Columnname&gt; do not match</EM>" type of categories, which if trapped during the view creation process I can easily imagine being re-thrown under the more generic "<EM>Could not resolve expression</EM>" category.</P>
<P mce_keep="true">Which does not mean it wouldn't still be a bug, it is just easy to see how (given the generic (documented) limitation where an indexed view definition cannot contain the collation clause, it is easy to imagine running into this kind of problem in view creation any time the collations do not match, even when they are complete subsets of on another and should be able to do better, as I pointed out in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html"><STRONG>A&amp;P of Sort Keys, part 8 (aka You can often think of ignoring weights as a form of ignorance)</STRONG></A> only worse since it leads to not just a performance problem but a bug.</P>
<P mce_keep="true">It is hard to say which looks worse:</P>
<UL>
<LI>
<DIV mce_keep="true">Collations that are literally identical (Unicode data, LATIN1_GENERAL_CI_AS&nbsp;vs. GREEK_CI_AS) being incompatible under any circumstances, or</DIV></LI>
<LI>
<DIV mce_keep="true">Collations that are literal subsets (LATIN1_GENERAL_CI_AS vs. LATIN1_GENERAL_CS_AS) being incompatible under any circumstances.</DIV></LI></UL>
<P mce_keep="true">The former is clearly stupider from the standpoint of a Windows collation purist who views the arbitrary separation of these identical collations as a flaw in the SQL Server collation design, sure.</P>
<P mce_keep="true">(That would be me, Mondays, Wednesdays, and Fridays!)</P>
<P mce_keep="true">But the latter is much more likely to come up in real world customer situations, as it did here for Kim.</P>
<P mce_keep="true">(That would be me Tuesdays, Thursdays, and Saturdays!)</P>
<P mce_keep="true">I'm going to ask some people over on the SQL Server side about this issue, in any case -- it is certainly not a documented limitation if there is no way to address it, but whether it can be fixed o not I'd at least like to make sure it is tracked somehow....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>ⓚ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/24da" mce_href="http://www.fileformat.info/info/unicode/char/24da">U+24da</A>, a.k.a. CIRCLED LATIN SMALL LETTER K)</EM></FONT></P>
<hr/><p><strong>Vindalou</strong> on 9 Oct 2007 8:46 PM:</p><div style="margin-left: 1em"><p>I have taken a couple of classes from Ms. Tripp - one of the finest instructors I have ever had. At the end of the week my brain was stuffy and I was worn out, but happy. She has an incredible knowledge of the database world. </p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/08/5351763.html" title="Clarification on my concerns with gratuitous moves....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/08/5320425.html" title="The roadꂸ to the solution starts with identifying the actual problem.NET">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/08/5347670.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>