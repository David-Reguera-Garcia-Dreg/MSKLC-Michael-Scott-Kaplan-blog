<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/03/5259246.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If it ain't UTF-16 then it ain't having no surrogate pairs, baby!</title></head><body>
<h1>If it ain't UTF-16 then it ain't having no surrogate pairs, baby!</h1>
<p><em>by Michael S. Kaplan, published on 2007/10/03 10:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/10/03/5259246.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The other day, Ramanathan asked:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hi,<BR><BR>I have the following surrogate character&nbsp; 𠄃&nbsp; that can be encoded as &amp;#55360;&amp;#56579; or as &amp;#x20103;If its encoded as &amp;#55360;&amp;#56579; it fails to parse using .NET XmlReader class. It also does <BR>not work in the ActiveXObject("Msxml2.DOMDocument"). However it works with the .NET XmlDocument class. (code snippet and error shown below)<BR><BR>However the &amp;#x20103; encoding works well with all the Xml parsers. Is there something wrong with the &amp;#55360;&amp;#56579; encoding. Is the &amp;#x20103; style of encoding the recommended way to encode surrogate characters ?<BR><BR>-------------<BR><BR>Code:<BR></EM></FONT><FONT face="consolas,lucida console,courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string s = "&lt;ROOT&gt;" + AntiXss.XmlEncode("abc 𠄃 def") + "&lt;/ROOT&gt;";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XmlDocument xmlDoc = new XmlDocument();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xmlDoc.LoadXml(s);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string text = xmlDoc.FirstChild.InnerText;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Console.WriteLine("Element data using XmlDom: {0}", text);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; XmlReader reader = XmlReader.Create(new StringReader(s));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool b = reader.Read();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; text = reader.ReadElementContentAsString();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; System.Console.WriteLine("Element data using XmlReader: {0}", text);</STRONG></FONT></P>
<P><FONT face="times new roman,times"><EM>Output:</EM><BR></FONT><FONT face="consolas,lucida console,courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp; Element data using XmlDom: abc ?? def<BR><BR>Unhandled Exception: System.Xml.XmlException: '?', hexadecimal value 0xD840, is an invalid character. Line 1, position 9.<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.Throw(Exception e)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.Throw(String res, String[] args)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ThrowInvalidChar(Int32 pos, Char invChar)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ParseNumericCharRefInline(Int32 startPos, Boolean expand, BufferBuilder internalSubsetBuilder, Int32&amp; charCount, EntityType&amp;entityType)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ParseCharRefInline(Int32 startPos, Int32&amp; charCount, EntityType&amp; entityType)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ParseText(Int32&amp; startPos, Int32&amp; endPos, Int32&amp; outOrChars)<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ParseText()<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.ParseElementContent()<BR>&nbsp;&nbsp; at System.Xml.XmlTextReaderImpl.Read()<BR>&nbsp;&nbsp; at System.Xml.XmlReader.SetupReadElementContentAsXxx(String methodName)<BR>&nbsp;&nbsp; at System.Xml.XmlReader.ReadElementContentAsString()<BR>&nbsp;&nbsp; at xss.XmlReaderIssue() in c:\ramu\code\cs\xss.cs:line 70<BR>&nbsp;&nbsp; at xss.Main(String[] args) in c:\ramu\code\cs\xss.cs:line 16</STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Regular readers might know what is going on here from that very first part if they keep in mind that the default encoding for XmlDocument is UTF-8....</P>
<P mce_keep="true">Well, that and they look at the character in question:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="courier new,courier">&amp;#55360;&amp;#56579; or &amp;#x20103;</FONT></P></BLOCKQUOTE>
<P mce_keep="true">or the piece of the exception text:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="courier new,courier">'?', hexadecimal value 0xD840, is an invalid character.</FONT></P></BLOCKQUOTE>
<P mce_keep="true">In UTF-8, you cannot use surrogate pairs as they are illegal everywhere other than UTF-16. </P>
<P mce_keep="true">You have either use the UTF-32 NCR (<STRONG><FONT face="courier new,courier">&amp;#x20103;</FONT></STRONG>) or the UTF-8 byte sequence for the character (<FONT face="courier new,courier"><STRONG>F0 A0 84 83</STRONG></FONT>).</P>
<P mce_keep="true">Looking at past posts like <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/27/444101.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/27/444101.html"><STRONG>There is no such thing as a surrogate character (dammit!)</STRONG></A> you can get more info on supplementary characters like <A class="" href="http://www.fileformat.info/info/unicode/char/20103" mce_href="http://www.fileformat.info/info/unicode/char/20103">U+20103</A>. And definitely be sure to keep surrogate pairs like <A class="" href="http://www.fileformat.info/info/unicode/char/d840" mce_href="http://www.fileformat.info/info/unicode/char/d840">U+d840</A> <A class="" href="http://www.fileformat.info/info/unicode/char/dd03" mce_href="http://www.fileformat.info/info/unicode/char/dd03">U+dd03</A> as a UTF-16 only thing....</P>
<P mce_keep="true">But one important issue to not lose sight of here is that the original bug is in the page creation. The line of code was:</P>
<P mce_keep="true"><STRONG><FONT face=Consolas>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string s = "&lt;ROOT&gt;" + AntiXss.XmlEncode("abc 𠄃 def") + "&lt;/ROOT&gt;";</FONT></STRONG></P>
<P mce_keep="true">And if that is saved to a file then whatever saves it needs to do the proper encoding. The fact that it was put into a surrogate pair if the page is UTF-8 is&nbsp;the bug; using an NCR value is a workaround....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>𠄃</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/20103" mce_href="http://www.fileformat.info/info/unicode/char/20103">U+20103</A>, a.k.a. <A class="" href="http://www.fileformat.info/info/unicode/char/d840" mce_href="http://www.fileformat.info/info/unicode/char/d840">U+d840</A> <A class="" href="http://www.fileformat.info/info/unicode/char/dd03" mce_href="http://www.fileformat.info/info/unicode/char/dd03">U+dd03</A>, a CJK Extension B ideograph)</EM></FONT></P>
<hr/><p><a id="5269959" href="#5269959">#</a> <strong>John Cowan</strong> on 3 Oct 2007 9:29 PM:</p><div style="margin-left: 1em"><p>You've conflated two issues here. &nbsp;On the one hand, XML character references never permit surrogates in *any* character encoding: they match up with Unicode code points, and &amp;#xD800; to &amp;#DFFF; are illegal, period, even if the encoding is UTF-16.</p>
<p>On the other hand, actual surrogate code units (as distinct from references) are as you say permitted in the UTF-16 encoding family only; they are not allowed in UTF-8 or the UTF-32 family.</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/10/03/5260996.html" title="How soon was then?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/10/02/5237783.html" title="Track Update">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-10-03">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/10/03/5259246.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>