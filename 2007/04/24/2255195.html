<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/24/2255195.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Sometimes, the shortcuts give better AND faster results</title></head><body>
<h1>Sometimes, the shortcuts give better AND faster results</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/24 06:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/24/2255195.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Just because you build up a huge architecture plan for a software plan doesn't mean that you can't use a sensible shortcut or optimization from time to time.</P>
<P>Like for example, <A class="" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" mce_href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx">MSLU</A> was set up to "speak Unicode" with its callers and "speak ANSI" with the Win9x&nbsp;operating system. This was a guiding architectural principal of the whole project.</P>
<P>But that wasn't going to mean that when calling a function that could sometimes accept Unicode that unicows.dll wouldn't just take&nbsp;a little shortcut and leave it as Unicode. I mean, why go through all the trouble to convert it on the way in and then maybe even back on the way out, taking up the time and allocating the space, all to be a little bit <EM>less</EM> functional, right?</P>
<P>Of course other times, people get so bogged down in the architecture plan that the shortcut doesn't occur to anyone. </P>
<P>Or maybe they just didn't know about it. :-)</P>
<P><A class="" href="http://blogs.msdn.com/shawnste/" mce_href="http://blogs.msdn.com/shawnste/">Shawn</A> asked me a question about someone else's bug that made me think about all this (just because I am on another team doesn't mean I don't answer questions!):</P>
<BLOCKQUOTE>
<P><EM>I learned that </EM>弌訲<EM> in a file name shows up OK if you do a dir in a cmd window, however those characters aren’t in CP950, so if you do a dir &gt; out.txt, then they turn into ??.&nbsp; How does the CMD window render these in the first place if they aren’t in CP950?&nbsp; <BR><BR>So could I do a wprintf or something and see these?&nbsp; (Like how does dir write them to the console?)<BR><BR></EM><EM>This is because of a .Net bug report.&nbsp; .Net effectively does the conversion and writes that to the console.</EM></P></BLOCKQUOTE>
<P>This all&nbsp;kind of made sense to me. </P>
<P>I mean, sure if you weren't using a TrueType font then things might not work right. </P>
<P>But Windows 2000 and XP and Server 2003 and Vista are all Unicode platforms. So it makes sense in those cases where it wouldn't hurt anything that just sending Unicode text right to a Unicode console (after all,&nbsp;even when CMD.EXE is started in ANSI mode, it was still compiled as a Unicode application!).</P>
<P>So I wrote a little managed console application to test out this little thought experiment:</P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,courier new,courier"><STRONG>using System;<BR>using System.Runtime.InteropServices;<BR><BR>public class Test {<BR>&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll", EntryPoint="WriteConsoleW", CharSet=CharSet.Unicode, ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp; internal static extern bool WriteConsole(IntPtr hConsoleOutput,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string lpBuffer,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int nNumberOfCharsToWrite,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; out uint lpNumberOfCharsWritten,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr lpReserved);<BR><BR>&nbsp;&nbsp;&nbsp; [DllImport("Kernel32.DLL", EntryPoint="GetStdHandle", CharSet=CharSet.Unicode, ExactSpelling=true)]<BR>&nbsp;&nbsp;&nbsp; internal static extern IntPtr GetStdHandle(int nStdHandle);<BR><BR>&nbsp;&nbsp;&nbsp; internal const int STD_OUTPUT_HANDLE = -11; // Handle to the standard output device.<BR><BR>&nbsp;&nbsp;&nbsp; public static void Main() {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string st = "\u5f0c\u8a32";<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint NumberOfCharsWritten;<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(st);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WriteConsole(GetStdHandle(STD_OUTPUT_HANDLE), st, st.Length, out NumberOfCharsWritten, IntPtr.Zero);<BR>&nbsp;&nbsp;&nbsp; }<BR>}</STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Sure enough, if you run it with any system locale and default console, the return will be:</P>
<BLOCKQUOTE><FONT face="consolas,lucida console,courier new,courier"><STRONG>
<P mce_keep="true">??<BR>弌訲</P></STRONG></FONT></BLOCKQUOTE>
<P mce_keep="true">(well, you may see square boxes for the second string but you'll never see them converted to question marks!)</P>
<P mce_keep="true">And then if you first run chcp 65001 and run it again, you'll see:</P>
<BLOCKQUOTE><FONT face="consolas,lucida console,courier new,courier"><STRONG>
<P mce_keep="true"><STRONG>弌訲<BR>弌訲</STRONG></P></STRONG></FONT></BLOCKQUOTE>
<P mce_keep="true">Maybe .NET should try directly calling WriteConsoleW once in a while instead of so aggressively converting to the console output codepage. Extension A would thank them for it!</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=6>弌</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/5f0c" mce_href="http://www.fileformat.info/info/unicode/char/5f0c">U+5f0c</A>, a Unicode&nbsp;Extension A Ideograph)</EM></FONT></P>
<hr/><p><a id="2260050" href="#2260050">#</a> <strong>Mike Dimmick</strong> on 24 Apr 2007 8:46 AM:</p><div style="margin-left: 1em"><p>Digging around in Reflector and the Shared Source CLI 2.0 shows that .NET 2.0 is creating a StreamWriter using the Encoding corresponding to the console output codepage to wrap a special Stream (__ConsoleStream). That __ConsoleStream writes to the console using WriteFile, not WriteConsole. WriteFile takes void pointers, of course: there is no WriteFileW/WriteFileA pair as no conversion is done.</p>
<p>You could bump the task up to a special class derived from StreamWriter/TextWriter, but you'd have to take account of redirected handles because I don't think WriteConsole works on ordinary file handles (and you'd want your redirected output to be converted to the appropriate codepage, I think, so that pipelines still work properly).</p>
<p>It seems bizarre that the .NET Framework still runs on Windows 9x and that it doesn't make use of Unicode even where that works on Windows 9x.</p>
</div>
<p><a id="2260073" href="#2260073">#</a> <strong>Michael S. Kaplan</strong> on 24 Apr 2007 8:54 AM:</p><div style="margin-left: 1em"><P>In the end, all one has to do is detect the additional redirection and decide whether to optimize this case or not.... which in a weird way is how the unmanaged console handles this particular scenario, itself....</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/19 <a href="http://archives.miloush.net/michkap/archive/2008/03/19/8321717.html">Before you say "What's next?" you have to figure out the action items</a></p><p>2007/11/22 <a href="http://archives.miloush.net/michkap/archive/2007/11/22/6463359.html">If it does [best] fit, it may be off a bit! (aka Parlez-ゔ japonais?)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/24/2256377.html" title="Popping the stack on the problem with using ordinal type comparisons?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/23/2250029.html" title="How long is it in the console?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/24/2255195.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>