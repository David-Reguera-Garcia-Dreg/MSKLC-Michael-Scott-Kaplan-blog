<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/29/2330455.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A way better model for features, part 3 (a.k.a. downlevel LoadMUILibrary)</title></head><body>
<h1>A way better model for features, part 3 (a.k.a. downlevel LoadMUILibrary)</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/29 17:59 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/29/2330455.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>You may have seen <A class="" href="http://archives.miloush.net/michkap/archive/2007/03/16/1895610.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/16/1895610.html"><STRONG>part&nbsp;1</STRONG></A> and <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/03/19/1912171.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/19/1912171.html">part 2</A></STRONG> of this&nbsp;series.&nbsp;Here we are with part 3!</P>
<P>Pavel S. Tsarevskiy asked last month over in the microsoft.public.win32.prograsmmer.international newsgroup:&nbsp;</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">I have a problem with using LoadMUILibrary() function and MUI technology under Windows XP.<BR><BR>I tried to use Vista&nbsp; MUI technology which is supposed to work under previous version of Microsoft OS.<BR><BR>I want to solve the problems with&nbsp; localization my application.<BR><BR>I want to make one project which contain neutral resources for example icons, bitmaps, etc. And projects which contain language specified resources for each language. So, The main benefit, we can use LoadMUILibrary which make HMODULE which contain handle to both neutral and language specified resources. Then we change default resource handle using AfxSetResourcesHandle(). There're no resources in exe module. And therefore it's not necessary to indicate HMODULE for some load resource functions which load neutral resources. Otherwise, it's not necessary to duplicate all neutral resources in each language dll library. So, for all load functions resource handles would be clear.<BR><BR>But, when I did test version of my application I saw that It's working under Windows Vista, but under Windows XP, HModule didn't indicate neutral resources, so it's impossible to load both neutral and language specified resources using one HModule under WinXP.<BR><BR>Does anybody know about it?<BR><BR>Microsoft says that this technology is working under XP.</FONT></EM></P></BLOCKQUOTE>
<P>Pavel is correct here-- the <A class="" href="http://msdn2.microsoft.com/library/ms776214.aspx" mce_href="http://msdn2.microsoft.com/library/ms776214.aspx">LoadMUILibrary</A> documentation does imply that it will properly redirect a needed to pick up resources in either the language neutral or appropriate language specific directory.</P>
<P>Unfortunately, in downlevel situations, it does not provide an HINSTANCE that will magically find the resource when it is used in other, later resource function calls. In the words of MUI tester Mike McAdams:</P>
<BLOCKQUOTE>
<P><EM>I agree with the person's post.&nbsp; You can not expect to get at both the LN and LD using LoadMUILibrary on down-level (meaning pre-Vista).&nbsp; You can however get at resources in both binaries using that API on Vista.&nbsp; ...this is because of the resource redirection being done by the RL [Resource Loader].</EM></P></BLOCKQUOTE>
<P>This particular "by design" is one that I consider to be rather unfortunate -- there is very little point (in my opinion) to doing all the work to&nbsp;provide a function downlevel that nevertheless behaves differently between the &gt;= Vista and the downlevel case.</P>
<P>The goal here&nbsp;was clearly&nbsp;to make sure that no special case code is needed, but if you want to use <A class="" href="http://msdn2.microsoft.com/library/ms776214.aspx" mce_href="http://msdn2.microsoft.com/library/ms776214.aspx">LoadMUILibrary</A> downlevel, you end up having to use it differently....</P>
<P>Given that, there is very little point to including the function downlevel!</P>
<P>In my opinion, they should have found a way in the downlevel case and done the extra work here to make sure that DLLs loaded via <A class="" href="http://msdn2.microsoft.com/library/ms776214.aspx" mce_href="http://msdn2.microsoft.com/library/ms776214.aspx">LoadMUILibrary</A> can behave the same way they do in Vista. Like by hooking the low level Resource Loader functions and redirecting as needed. </P>
<P>Of course, only a team that owns the resource loader would really have a fair chance to accomplish such a thing, but as luck would have it, the MUI team owns the Resource Loader. :-)</P>
<P>I think they should try to address this -- in an effort to make the suggested "best practices" more accessible to developers. </P>
<P>It&nbsp;would be&nbsp;a much better model for supporting the pleanned feature, in any case!</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> à¬Š <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0b0a" mce_href="http://www.fileformat.info/info/unicode/char/0b0a">U+0b0a</A>, a.k.a. ORIYA LETTER UU)</EM></FONT></P>
<hr/><p><a id="2340878" href="#2340878">#</a> <strong>KJK::Hyperion</strong> on 30 Apr 2007 11:42 AM:</p><div style="margin-left: 1em"><p>Ha! The funny thing is, the downlevel loader *does* have MUI hooks (see: LdrLoadAlternateResourceModule) - you know, to support the older &quot;flavor&quot; of MUI; don't know if it could support this scenario, though.</p>
<p>Or they could just have hooked one, maybe two functions, that are only accessed through DLL exports, hence fairly trivial to hook</p>
<p>[runtime hooking is a non-trivial issue in general, and you end up depending on either a statically linked library like Detours, or system facilities like Shim Layer that aren't as downlevel as some would like (Windows 2000 SP2 and later, I think?); there's also the issue of hooking &quot;early enough&quot; - Shim Layer has the luxury of doing its thing inside the loader's startup sequence - and hairy multithreading issues you *don't* want to hear about]</p>
</div>
<p><strong>Ted.</strong> on 5 Jan 2011 12:05 PM:</p><div style="margin-left: 1em"><p>The one thing I discovered about the &quot;old way&quot; on XP is that it only gets triggered if your UI language is different from your main (system OS) language. &nbsp;So the old way assumes your main language resources are stored in your main (non .mui) DLL. &nbsp;Another thing that&#39;s annoying is that XP only has support for application MUI if MUI is actually installed (a completely separate installer from MSDN that is 5 CDs). &nbsp;For non-MUI XP, it doesn&#39;t even take into account your MUI files even if you have them in the right location (e.g. .\mui\040c\mydll.dll.mui)</p>
<p>So the old way is basically a non-starter for 3rd party apps, that coupled with no way to set the thread&#39;s preferred UI language, kills this approach dead on XP. &nbsp;So MUI is basically useless for those wanting to still support XP since you have to write all your own resource loading whereas on Vista+ it just works magically.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/30/2333104.html" title="When moving to from XslTransform to XslCompiledTransform...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/29/2328012.html" title="_wsetlocale doesn&#39;t support Unicode-only locales">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-29">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/29/2330455.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>