<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/14/2134278.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Rhymes with Amharic #3 (a.k.a. Read and write a language w/o even getting out of my [em]bed? Kewl!)</title></head><body>
<h1>Rhymes with Amharic #3 (a.k.a. Read and write a language w/o even getting out of my [em]bed? Kewl!)</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/14 17:26 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/14/2134278.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>(see also the <A class="" href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html" mce_href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html"><STRONG>first</STRONG></A> part and the <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/04/14/2133650.html" mce_href="http://archives.miloush.net/michkap/archive/2007/04/14/2133650.html">second</A></STRONG> part)</P>
<P>We now have that binary chunk that needs to be loaded, so let's go ahead and load it!</P>
<P>The core bit of the code for this should have been:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P mce_keep="true">if (File.Exists(FONTNAME)) {<BR>&nbsp;&nbsp;&nbsp; <FONT color=#009900>// We are reading in the embed file info if the file exists (we may have just created it!)</FONT><BR>&nbsp;&nbsp;&nbsp; TTLOAD ulStatusRead = 0;<BR>&nbsp;&nbsp;&nbsp; FileStream fsRead = new FileStream(FONTNAME, FileMode.Open);<BR>&nbsp;&nbsp;&nbsp; READEMBEDPROC rep = new READEMBEDPROC(this.ReadEmbedProc);<BR>&nbsp;&nbsp;&nbsp; TTLOADINFO ttli = new TTLOADINFO();<BR><BR>&nbsp;&nbsp;&nbsp; ttli.usStructSize = Convert.ToUInt16(Marshal.SizeOf(ttli));<BR>&nbsp;&nbsp;&nbsp; ttli.usRefStrSize = 0;<BR>&nbsp;&nbsp;&nbsp; ttli.pusRefStr = IntPtr.Zero;<BR>&nbsp;&nbsp;&nbsp; ulPrivStatus = 0;<BR><BR>&nbsp;&nbsp;&nbsp; rc = TTLoadEmbeddedFont(out this.m_hFontReference, TTLOAD.PRIVATE,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; out ulPrivStatus,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LICENSE.EDITABLE, out ulStatusRead,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rep, fsRead,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "NyalaSIAO", "NyalaSIAO",<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ttli);<BR>&nbsp;&nbsp;&nbsp; fsRead.Flush();<BR>&nbsp;&nbsp;&nbsp; fsRead.Close();<BR><BR>&nbsp;&nbsp;&nbsp; this.tb1.Font = new Font("NyalaSIAO", siz);<BR>&nbsp;&nbsp;&nbsp; if (this.tb1.Font.Name != "NyalaSIAO") {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>// We had everything but embedding failed anyway.</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.lbl1.Text = "Embedding failed, font is: " + this.tb1.Font.Name;<BR>&nbsp;&nbsp;&nbsp; }<BR>}</P></B></FONT></BLOCKQUOTE>
<P>And of course the ReadEmbedProc (note the similarities and more importantly the differences when comparing to the WriteEmbedProc mentioned <A class="" href="http://archives.miloush.net/michkap/archive/2007/04/14/2133650.html" mce_href="http://archives.miloush.net/michkap/archive/2007/04/14/2133650.html"><STRONG>earlier</STRONG></A>, a ripe potential source of copy/paste codewriting errors!)</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P>[UnmanagedFunctionPointerAttribute(CallingConvention.Cdecl, CharSet=CharSet.Unicode)]<BR>internal delegate uint READEMBEDPROC(FileStream lpvReadStream, IntPtr lpvBuffer, uint cbBuffer);<BR><BR>internal uint ReadEmbedProc(FileStream lpvReadStream, IntPtr lpvBuffer, uint cbBuffer)<BR>{<BR>&nbsp;&nbsp;&nbsp; byte[] rgbyt = new byte[cbBuffer];<BR>&nbsp;&nbsp;&nbsp; lpvReadStream.Read(rgbyt, 0, (int)cbBuffer);<BR>&nbsp;&nbsp;&nbsp; Marshal.Copy(rgbyt, 0, lpvBuffer, (int)cbBuffer);<BR>&nbsp;&nbsp;&nbsp; return cbBuffer;<BR>}</P></B></FONT></BLOCKQUOTE>
<P>However, in the end&nbsp;it actually proved to be a lot harder than it should have been due to the way that GDI+/WinForms handles the work of fonts, refusing to recognize any font that was not available at application boot time. So even though there is a font available in the process, GDI+ is unwilling to believe it.</P>
<P>The next thing&nbsp;I tried&nbsp;here was to just create it the old fashioned way and stick it into the device&nbsp;context, but that also failed because after all this is not plain old GDI doing the work here, this is either GDI+ using it's notion of the font to use or the WinForms concept of the font to send to Uniscribe (via <A class="" href="http://archives.miloush.net/michkap/archive/2005/06/27/432986.html" mce_href="http://archives.miloush.net/michkap/archive/2005/06/27/432986.html">TextRenderer</A>).Doesn't anyone respect a device context any more? :-)</P>
<P>The solution was to add this last bit of code after succeeding in the call to <A class="" href="http://msdn2.microsoft.com/library/ms536775.aspx" mce_href="http://msdn2.microsoft.com/library/ms536775.aspx">TTLoadEmbeddedFont</A>:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P>&nbsp;&nbsp;&nbsp; IntPtr hdc = GetDC(this.tb1.Handle);<BR><BR>&nbsp;&nbsp;&nbsp; this.m_hFontEmbedded = CreateFont(MulDiv(Convert.ToInt16(siz), GetDeviceCaps(hdc, LOGPIXELSY), 72),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, "NyalaSIAO");<BR>&nbsp;&nbsp;&nbsp; if (this.m_hFontEmbedded != IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint cb = GetFontData(hdc, 0, 0, IntPtr.Zero, 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cb != GDI_ERROR) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; byte[] rgbyt = new byte[cb];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GetFontData(hdc, 0, 0, rgbyt, cb);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.m_pfc = new PrivateFontCollection();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr pbyt = Marshal.AllocCoTaskMem(rgbyt.Length);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Marshal.Copy(rgbyt, 0, pbyt, rgbyt.Length);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.m_pfc.AddMemoryFont(pbyt, rgbyt.Length);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Marshal.FreeCoTaskMem(pbyt);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.tb1.Font = new Font(this.m_pfc.Families[0], siz);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR>}</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">What this code does is load the font that <A class="" href="http://msdn2.microsoft.com/library/ms536775.aspx" mce_href="http://msdn2.microsoft.com/library/ms536775.aspx">TTLoadEmbeddedFont</A> has (if you think about it) reconstituted into an actual font and then put it into a memory font via the <A class="" href="http://msdn2.microsoft.com/library/system.drawing.text.privatefontcollection.aspx" mce_href="http://msdn2.microsoft.com/library/system.drawing.text.privatefontcollection.aspx">PrivateFontCollection</A> class, just like what happened in the code from <A href="http://archives.miloush.net/michkap/archive/2005/11/20/494829.html"><STRONG>Private fonts: for members only</STRONG></A>.</P>
<P mce_keep="true">When I tested with subsetted font binaries it worked as well, which means that <A class="" href="http://msdn2.microsoft.com/library/ms536775.aspx" mce_href="http://msdn2.microsoft.com/library/ms536775.aspx">TTLoadEmbeddedFont</A> really is doing a good job here at making what it puts together look like a font. :-)</P>
<P mce_keep="true">Now some of the things this code is ignoring include the license info that <A class="" href="http://msdn2.microsoft.com/library/ms536775.aspx" mce_href="http://msdn2.microsoft.com/library/ms536775.aspx">TTLoadEmbeddedFont</A> returns, as well as the return value. And more importantly, right now the code is assuming that the call succeeds and then just trying to use the results, a strategy which is fine in the constrained situation here but if it is expanded to other fonts then you might want to consider altering that strategy since the CreateFont call will succeed even if it does not recognize the font name and you may specifically <EM>not</EM> like the font it gives instead....</P>
<P mce_keep="true">Next up, some other interesting issues to consider about embedding, and what happens when you are done....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>á‹®</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/12ee" mce_href="http://www.fileformat.info/info/unicode/char/12ee">U+12ee</A>, a.k.a. ETHIOPIC SYLLABLE YO)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2013/10/23 <a href="http://archives.miloush.net/michkap/archive/2013/10/23/10459401.html">I finally got to meet ali eteraz in person...</a></p><p>2007/12/12 <a href="http://archives.miloush.net/michkap/archive/2007/12/12/6742301.html">SiaO as The Red Carpet (aka Characters just want to be seen)</a></p><p>2007/04/15 <a href="http://archives.miloush.net/michkap/archive/2007/04/15/2145619.html">Rhymes with Amharic #5 (a.k.a. [Sub]setting up this code where it can do the most good?)</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2137215.html">Rhymes with Amharic #4 (a.k.a. we're all [sub]set so turning out the lights and going to [em]bed!)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/14/2137215.html" title="Rhymes with Amharic #4 (a.k.a. we&#39;re all [sub]set so turning out the lights and going to [em]bed!)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/14/2133650.html" title="Rhymes with Amharic #2 (a.k.a. Before you embed, you have build something to embed)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/14/2134278.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>