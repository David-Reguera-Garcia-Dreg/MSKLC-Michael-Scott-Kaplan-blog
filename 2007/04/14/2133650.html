<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/14/2133650.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Rhymes with Amharic #2 (a.k.a. Before you embed, you have build something to embed)</title></head><body>
<h1>Rhymes with Amharic #2 (a.k.a. Before you embed, you have build something to embed)</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/14 12:22 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/14/2133650.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>(see <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html" mce_href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html">here</A></STRONG> for the first part)&nbsp;</P>
<P>The first part of the code centers around a call to <A class="" href="http://msdn2.microsoft.com/library/ms536748.aspx" mce_href="http://msdn2.microsoft.com/library/ms536748.aspx">TTEmbedFont</A>. It only runs on Vista and above&nbsp;(since no one else should have the font on their machine!):</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P>IntPtr hDC = CreateDC("DISPLAY", IntPtr.Zero, IntPtr.Zero, IntPtr.Zero);<BR>if (hDC != IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp; IntPtr hFont = CreateFont(MulDiv(Convert.ToInt16(siz), GetDeviceCaps(hDC, LOGPIXELSY), 72),<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, "Nyala");<BR>&nbsp;&nbsp;&nbsp; if (hFont != IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr hFontOld = SelectObject(hDC, hFont);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (hFontOld != IntPtr.Zero) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>// We are writing out the embed file info for the font if the file doesn't exist.</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; uint ulStatus = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileStream fsWrite = new FileStream(FONTNAME, FileMode.CreateNew);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WRITEEMBEDPROC wep = new WRITEEMBEDPROC(this.WriteEmbedProc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TTEMBEDINFO ttie = new TTEMBEDINFO();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ttie.usStructSize = Convert.ToUInt16(Marshal.SizeOf(ttie));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ttie.usRootStrSize = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ttie.pusRootStr = IntPtr.Zero;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulPrivStatus = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ulStatus = 0;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rc = TTEmbedFont(hDC,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; TTEMBED.RAW | TTEMBED.TTCOMPRESSED, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CHARSET.UNICODE,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; out ulPrivStatus, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; out ulStatus,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wep, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsWrite,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; IntPtr.Zero,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ttie);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsWrite.Flush();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fsWrite.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (rc != E.NONE) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>// Since creation of the file ultimately failed, delete whatever</FONT> <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>// interim bits might have been written.</FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; File.Delete(FONTNAME);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SelectObject(hDC, hFontOld);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DeleteObject(hFont);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; DeleteDC(hDC);<BR>}</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">You'll notice that I am passing the flags to include&nbsp;the raw font and not a subset of it. My initial reason for that was the suggestion from some people that the subsetting would not pick up any of the different forms of glyphs that&nbsp;might be&nbsp;available.&nbsp;But Sergey actually told me that the code is rather generous at including all of the alternate forms and glyphs that could potentially derived from the ones that are specified, so in the situation where the text is static, subsetting the font may be worthwhile (and will certainly make for a smaller file!).</P>
<P mce_keep="true">If one was going to subset, putting all the text in a string and then changing that IntPtr in the pinvoke declare of pusCharCodeSet to a string and then passing it (after all, what else is a string but an array of ushort values?). :-)</P>
<P mce_keep="true">The key piece of code that does this part of &nbsp;work is that WriteEmbedProc. To be honest, I am not entirely happy with it. You may see why if you look it:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P mce_keep="true">[UnmanagedFunctionPointerAttribute(CallingConvention.Cdecl, CharSet=CharSet.Unicode)]<BR>internal delegate uint WRITEEMBEDPROC(FileStream lpvWriteStream, IntPtr lpvBuffer, uint cbBuffer);<BR><BR>internal uint WriteEmbedProc(FileStream lpvWriteStream, IntPtr lpvBuffer, uint cbBuffer) {<BR>&nbsp;&nbsp;&nbsp; byte[] rgbyt = new byte[cbBuffer];<BR>&nbsp;&nbsp;&nbsp; Marshal.Copy(lpvBuffer, rgbyt, 0, (int)cbBuffer);<BR>&nbsp;&nbsp;&nbsp; lpvWriteStream.Write(rgbyt, 0, (int)cbBuffer);<BR>&nbsp;&nbsp;&nbsp; return cbBuffer;<BR>}</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">Okay, so because I am using the .NET FileStream class to do the writing, I am forced to do that extra bit of copying into a byte array that I'd rather avoid. You know, just something to write from that lpvBuffer pointer directly to the file. But the actual hit is small (it is a small file, after all!), so I just kind of thought it would be worth earmarking as an area to&nbsp;potentially revisit if performance became a problem. In the meantime, it does get the job done....</P>
<P mce_keep="true">I also chose not to get involved with the whole TTEMBEDINFO structure and its link checking, though people looking at the sample might see it as worthwhile to look into (this is why I bothered to define the struct rather than just making it an IntPtr and passing IntPtr.Zero in this case).</P>
<P mce_keep="true">Anyway, when everything is done you end up with a nice little binary file that can be used in your application that needs to display text that may not be available....</P>
<P mce_keep="true">In the next post I'll talk about the harder bit, which is actually loading that file....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> á‰µ <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/1275" mce_href="http://www.fileformat.info/info/unicode/char/1275">U+1275</A>, a.k.a. ETHIOPIC SYLLABLE TE)</EM></FONT></P>
<hr/><p><a id="2137335" href="#2137335">#</a> <strong>Jason Truesdell</strong> on 14 Apr 2007 7:11 PM:</p><div style="margin-left: 1em"><p>Ack! You've succumbed to the bizarre dialect of Group Program Manager/Vice President English!</p>
<p>I'm not usually not so much of a language purist, but one of the things adequately beaten into my little head during a a class with my university's most dedicated professor of literature was this: geometrically speaking, a center is a single point. Therefore, things do not center around anything; they center upon something. It's just like focus: you can only focus upon one point, you can't focus around something.</p>
<p>Examples of misuse are widespread, but &quot;to center around&quot; seems particularly pervasive in corporate jargon.</p>
<p>My own writing is still full of language barbarisms and mishaps, but that one mistake I can never make again. Once, I was listening to a &nbsp;a GPM at Microsoft talking about our product strategy, and I bit my tongue and clenched my teeth as he used the phrase repeatedly.</p></div>
<p><a id="2157276" href="#2157276">#</a> <strong>Mihai</strong> on 16 Apr 2007 5:03 PM:</p><div style="margin-left: 1em"><p>&lt;&lt;If one was going to subset, putting all the text in a string and then changing that IntPtr in the pinvoke declare of pusCharCodeSet to a string&gt;&gt;</p>
<p>Trap here!</p>
<p>Do not try collecting all the characters that are used in a string, use the real text.</p>
<p>So don't use &quot;: Cadefhiklnost&quot; for &quot;delete all the files on disk C:,&quot; because it will not include the ligatures glyphs (ie &quot;fi&quot; in file) and will mess contextual shaping, which might be needed.</p></div>
<p><strong>Alemayehu</strong> on 8 Feb 2010 6:16 PM:</p><div style="margin-left: 1em"><p>Well done. &nbsp;I have no words to appreciate your efforts. </p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2013/10/23 <a href="http://archives.miloush.net/michkap/archive/2013/10/23/10459401.html">I finally got to meet ali eteraz in person...</a></p><p>2007/12/12 <a href="http://archives.miloush.net/michkap/archive/2007/12/12/6742301.html">SiaO as The Red Carpet (aka Characters just want to be seen)</a></p><p>2007/04/15 <a href="http://archives.miloush.net/michkap/archive/2007/04/15/2145619.html">Rhymes with Amharic #5 (a.k.a. [Sub]setting up this code where it can do the most good?)</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2137215.html">Rhymes with Amharic #4 (a.k.a. we're all [sub]set so turning out the lights and going to [em]bed!)</a></p><p>2007/04/14 <a href="http://archives.miloush.net/michkap/archive/2007/04/14/2134278.html">Rhymes with Amharic #3 (a.k.a. Read and write a language w/o even getting out of my [em]bed? Kewl!)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/14/2134278.html" title="Rhymes with Amharic #3 (a.k.a. Read and write a language w/o even getting out of my [em]bed? Kewl!)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/14/2128198.html" title="Rhymes with Amharic (a.k.a. How about a little breakfast embed, dear?)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/14/2133650.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>