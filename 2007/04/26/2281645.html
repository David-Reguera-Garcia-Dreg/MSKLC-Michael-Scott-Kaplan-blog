<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/26/2281645.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Sprechen Sie IME?</title></head><body>
<h1>Sprechen Sie IME?</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/26 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/26/2281645.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The other day, Keith asked in the Suggestion Box:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>In creating an on screen keyboard for Korean, I began to notice that the Korean IME seems to do things differently than, say, the Japanese IME. &nbsp;In Japanese, to get the characters from the ToUnicodeEx function is as simple as setting the VK_KANA virtual key to the on state when you pass in the Keyboard State array parameter. &nbsp;However, in Korean it does not seem to behave in this simple a way. &nbsp;More confusing, the Japanese IME has a Kana status button that turns this virtual key 'on' in the keyboard state to switch character sets. &nbsp;However, the Han/Eng toggle seems to make no change to the keyboard state. &nbsp;What happens internally when this button is clicked? &nbsp;How would I get the correct Korean characters from the ToUnicodeEx function? &nbsp;Why is this so confusing?</EM></FONT></P></BLOCKQUOTE>
<P>He also hedged his bets in the microsoft.public.win32.programmer.international newsgroup:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>I am currently enhancing an on-screen keyboard adding the ability to enter Korean.&nbsp; I am having problems getting the Korean characters to be displayed on the keyboard keys.&nbsp; The code which does it correctly for other languages but doesn't work for Korean makes a call to the function ToUnicodeEx.&nbsp; Further, I just noticed an old post on the newsgroups that said this method was problematic for Korean or other IMEs using TSF.&nbsp; That being the case, how would I go about doing this then?&nbsp; And why does ToUnicodeEx not work for certain IMEs?<BR><BR>Thanks for any assistance, Keith.</EM></FONT></P></BLOCKQUOTE>
<P><EM>(I take no offense, there is definitely no promise of immediate response or anything!)</EM></P>
<P>Then a couple of months ago, ibon asked in that same newsgroup:</P>
<BLOCKQUOTE>
<P>HWND hWnd = GetForegroundWindow( );<BR>HIMC himc = ImmGetContext( hWnd );<BR><BR><EM>But "himc" always returns "NULL".<BR><BR>If MS has blocked this, is there other ways to access info about the input&nbsp;language on a common IME?<BR><BR>Sincerely,</EM></P></BLOCKQUOTE>
<P>And a few months ago, Matthias asked in that same newsgroup:</P>
<BLOCKQUOTE>
<P><EM>Hello<BR><BR>&nbsp; i have a problem with korean. For a touch screen application we use a virtual keyboard to enter data. Unfortunatly does the driver generats a mouse click event when the user presses on the screen.<BR>&nbsp; If the input is korean, the IME interprets such a click as something as a cancel event and stops the composition. Can someone tell me how to surpress this so that a mouse click does NOT interrupts the composition?<BR><BR>Thanky you<BR>Matthias</EM></P></BLOCKQUOTE>
<P>Then there was another post on that same newsgroup early last month from Digital Ice:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>I try to retrieve the ime candidate list of Microsoft Pinyin IME.<BR>This code is working fine with Windows XP but not Windows Vista.<BR></EM><BR>if (msg-&gt;message == WM_IME_NOTIFY)<BR>{<BR>&nbsp;&nbsp;&nbsp; if (msg-&gt;wParam == IMN_OPENCANDIDATE || msg-&gt;wParam == IMN_CHANGECANDIDATE)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HWND hFocus = msg-&gt;hwnd;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; HIMC hImc = ImmGetContext(hFocus);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ASSERT(hImc);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DWORD dwSize = ImmGetCandidateList(hImc,0,NULL,0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (dwSize)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ..........leave out here.<BR><BR></FONT><EM><FONT face="times new roman,times">ImmGetCandidateList always returns zero when it wotrks with Windows Vista.<BR>ImmGetCandidateList should returns the size of CANDIDATELIST required.<BR>Why the behavior is different?</FONT></EM></P></BLOCKQUOTE>
<P>On the whole, if you look into these problems deeply enough, you will find they have&nbsp;a few&nbsp;things in common:</P>
<OL>
<LI>They all have to do with IMEs</LI>
<LI>All of the IMEs in question are actually Text Services Framework (TSF) Text Input Processors (TIPs)</LI>
<LI>In each case, there are one of two causes to the problem being reported, either:</LI>
<UL>
<LI>The compatibility layer between TSF and the original Input Method Manager (IMM) API within imm32.dll&nbsp;has a bug, sdomewhat akin to&nbsp;<STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/05/16/598980.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/16/598980.html">What broke the input language messages?</A></STRONG> but without as good of a justification, or</LI>
<LI>The IME's own interaction with the keyboard handling API within user32.dll is not as full as it is with some other IME.</LI></UL></OL>
<P>Now obviously of those two cases the second one is the one for which there is no specific solution that will allow the code to work -- in those cases, you have to work more directly with the IME rather than the keyboard handling functions, as they simply do not provide the information where it is being requested. Every IME is made up of code and data and if they handle the situation differently then that is what they do -- how many times would you expect to see code written by different developers within different countries supporting the input of different languages where they all worked the same way?</P>
<P>The first case is a bit less forgivable, though to honest after working with the IMM API in the past, I can understand why the legacy support to have TSF support the IMM&nbsp;programming interface would be incomplete --&nbsp;it is not a terribly easy API to use.</P>
<P>In the bulk of these cases, the answer is to look at the Text Services Framework and its myriad of classes, interfaces, methods, and properties to work with the IMEs. Starting in XP where some of them were converted up until Vista where just about all of them were, it really is the only answer that is going to avoid frustration that does not have a chance of leading to success....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by </EM>&nbsp;<FONT size=6>áŸ€</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/17c0" mce_href="http://www.fileformat.info/info/unicode/char/17c0">U+17c0</A>, a.k.a. KHMER VOWEL SIGN IE)</EM></FONT></P>
<hr/><p><a id="2302812" href="#2302812">#</a> <strong>Eric C Brown</strong> on 27 Apr 2007 4:08 PM:</p><div style="margin-left: 1em"><p>Michael - I'm a developer in Windows who has spent a lot of time working with TSF and Text Services (primarily the Speech TIP). &nbsp;Anyway, I have started a blog about TSF (<a rel="nofollow" target="_new" href="http://blogs.msdn.com/tsfaware">http://blogs.msdn.com/tsfaware</a>), and I'm more than willing to answer questions.</p>
</div>
<p><a id="2305251" href="#2305251">#</a> <strong>Michael S. Kaplan</strong> on 27 Apr 2007 7:16 PM:</p><div style="margin-left: 1em"><p>Very cool -- I'll add that link to the list of blogs I read!</p>
</div>
<p><strong>Goonstah</strong> on 3 Sep 2009 11:03 AM:</p><div style="margin-left: 1em"><p>While looking through some DirectX examples, I found this workaround for the bug on Vista that makes ImmGetCandidateList() fail.</p>
<p>This works for me:</p>
<ul><li>Create your own context (ImmCreateContext)</li><li>Associate it with your window (ImmAssociateContext)</li><li>When receiving a WM_IME_SETCONTEXT, pass it on to DefWindowProc with lParam = 0</li></ul></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/12/04 <a href="http://archives.miloush.net/michkap/archive/2008/12/04/9173920.html">ImmGetDescription: another casualty of the IMM to TSF migration</a></p><p>2008/07/27 <a href="http://archives.miloush.net/michkap/archive/2008/07/27/8781762.html">And you think finding presidential candidates is hard? Try getting the Vista IME candidate list!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/26/2286153.html" title="No Regex in the Unicode room! (and no sex in the champagne room, either!)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/25/2273289.html" title="The nature of OrdinalIgnoreCase vs. intuitive expectations">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/26/2281645.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>