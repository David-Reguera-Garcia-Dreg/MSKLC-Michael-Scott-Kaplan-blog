<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/22/2239345.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The Notepad encoding detection issues keep coming up</title></head><body>
<h1>The Notepad encoding detection issues keep coming up</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/22 21:59 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/22/2239345.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A few days ago, Raymond was talking about <A class="" href="http://blogs.msdn.com/oldnewthing/archive/2007/04/17/2158334.aspx" mce_href="http://blogs.msdn.com/oldnewthing/archive/2007/04/17/2158334.aspx">the Notepad file encoding problem</A>, again. And the comments were pretty funny, like watching a traffic accident as people started going off the rails in all kinds of directions.</P>
<P>For the record, here is the official, UNDOCUMENTED, Notepad encoding detection story, only mildly changed between&nbsp;Windows 2000 Beta 2 through now (into&nbsp;Longhorn Server thast hasn't shipped yet):</P>
<OL>
<LI>Check the first two bytes;</LI>
<OL>
<LI>If there is a UTF-16 LE BOM, then treat it (and load it) as a "Unicode" file;</LI>
<LI>If there is a UTF-16 BE BOM, then treat it (and load it) as a "Unicode (Big Endian)" file;</LI>
<LI>If the first two bytes look like the start of a UTF-8 BOM, then check the next byte and if we have a UTF-8 BOM, then treat it (and load it) as a "UTF-8" file;</LI></OL>
<LI>Check with <A class="" href="http://msdn2.microsoft.com/library/ms776445.aspx" mce_href="http://msdn2.microsoft.com/library/ms776445.aspx">IsTextUnicode</A> to see if that function think it is BOM-less UTF-16 LE, if so, then treat it (and load it) as a "Unicode" file;</LI>
<LI>Check to see if it UTF-8 using <A class="" href="http://www.ietf.org/rfc/rfc2279.txt?number=2279" mce_href="http://www.ietf.org/rfc/rfc2279.txt?number=2279">the original RFC 2279 definition&nbsp; from 1998</A>&nbsp;and if it then treat it (and load it) as a "UTF-8" file;</LI>
<LI>Assume an ANSI file using the default system code page of the machine.</LI></OL>
<P>Now note that there are some holes here, like the fact that step&nbsp;2 does not do quite as good with BOM-less UTF-16 BE (there may even be a bug here, I'm not sure -- if so it's a bug in Notepad beyond any bug in <A class="" href="http://msdn2.microsoft.com/library/ms776445.aspx" mce_href="http://msdn2.microsoft.com/library/ms776445.aspx">IsTextUnicode</A>).</P>
<P>And frankly if people were happy with the <A class="" href="http://msdn2.microsoft.com/library/ms776445.aspx" mce_href="http://msdn2.microsoft.com/library/ms776445.aspx">IsTextUnicode</A> behavior in general or with small files in particular then the big hub-hub I mentioned <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html" mce_href="http://archives.miloush.net/michkap/archive/2006/06/14/631016.html">here</A></STRONG> and <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/07/11/662342.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/11/662342.html">here</A></STRONG> wouldn't have been such a mini-phenomenon (like as if people needed Notepad to comment on whether Bush hid the facts or not!).</P>
<P>But then again I already mentioned <A class="" href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html"><STRONG>I don't like IsTextUnicode</STRONG></A>, for roughly some&nbsp;the same reasons that the whole Notepad "detection"&nbsp;thing is a pain.</P>
<P>I also don't like step 3 above, either -- the code may be fast but it also is way behind the current algorithm used by <A class="" href="http://msdn2.microsoft.com/library/ms776413.aspx" mce_href="http://msdn2.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</A>, which has one a pretty good job keeping up with the ever changing Unicode conformance guidelines. I still haven't gotten my head around what it means for a file that meets the 1998 guidelines but not the latest&nbsp;UTF-8 conformance rules. Probably a lot of U+FFFD characters in the future, UTF-8 style (EF BF BD).</P>
<P>But in the end I think it is unfair to pick on Notepad here. <A class="" href="http://msdn2.microsoft.com/library/ms776445.aspx" mce_href="http://msdn2.microsoft.com/library/ms776445.aspx">IsTextUnicode</A> needs to be updated as I said over two years ago <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/30/363308.html">here</A></STRONG> and then after that is done someone needs to go update Notepad to use the new detection stuff that is added.</P>
<P>In the meantime folks should not be so busy complaining about stuff before they understand it; as the above makes clear there is plenty of&nbsp;material to complain about&nbsp;accurately, later. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=6>ï¿½</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/fffd" mce_href="http://www.fileformat.info/info/unicode/char/fffd">U+fffd</A>, a.k.a. REPLACEMENT CHARACTER)</EM></FONT></P>
<hr/><p><a id="2243511" href="#2243511">#</a> <strong>Brian</strong> on 23 Apr 2007 4:54 AM:</p><div style="margin-left: 1em"><p>I would really like to see the Unicode names that Notepad uses clarified in an future version. Particularly confusing is &quot;Unicode&quot;. At the very least, I suggest renaming this to &quot;Unicode (Little Endian)&quot;; however, &quot;UTF-16 LE&quot; would be better. Same for &quot;Unicode big endian&quot;. UTF-16 BE or UTF-32 BE? I know the answer, but not from looking at that dialog. It already lists &quot;UTF-8&quot;, so it would make things more consistent as well. These are very minor changes and should not affect any code.</p></div>
<p><a id="2245124" href="#2245124">#</a> <strong>Ben Bryant</strong> on 23 Apr 2007 7:27 AM:</p><div style="margin-left: 1em"><p>Do you know if step 3 is done against the whole file or the first 256 chars or something like that?</p></div>
<p><a id="2246109" href="#2246109">#</a> <strong>Michael S. Kaplan</strong> on 23 Apr 2007 9:17 AM:</p><div style="margin-left: 1em"><P>Hi Ben, </P>
<P>I believe step #3 is done against the entire file, which is not what happens with step #2 since the function itself limits how many bytes it looks at....</P>
<P>CORRECTION -- I looked at the code a little closer -- it reads the first 1024 bytes to try to make the determination.</P></div>
<p><a id="2246130" href="#2246130">#</a> <strong>Michael S. Kaplan</strong> on 23 Apr 2007 9:21 AM:</p><div style="margin-left: 1em"><p>Hi Brian, </p>
<p>Although this would be better for people who understand things about Unicode, it is actually worse, and less understandable, for the majority of people. And its not like the first group can't easily see what each one means just by process of elimination (or by looking in help!), which makes change even less likely.</p>
</div>
<p><strong>Shailesh</strong> on 7 Jun 2010 7:41 AM:</p><div style="margin-left: 1em"><p>I couldnt understand you statement related toEF BF BD.</p>
<p>Post .net 2.0, I have seen that StreamReader converts all invalid characters into EF BF BD sequence. (I couldnt find any official documention about this though)</p>
<p>Are you talking about this?</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/08/20 <a href="http://archives.miloush.net/michkap/archive/2010/08/20/10052314.html">The song^H^H^H^Hbug remains the same</a></p><p>2010/08/14 <a href="http://archives.miloush.net/michkap/archive/2010/08/14/10050078.html">(It wasn't me)</a></p><p>2008/03/25 <a href="http://archives.miloush.net/michkap/archive/2008/03/25/8334796.html">Bush might've still hid the facts, but he can't hide them from Vista SP1/Server 2008 Notepad!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/23/2248563.html" title="EUDC does not require ADMIN">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/21/2222812.html" title="A geek can&#39;t always get a date, but the date statement sure can get to a geek">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/22/2239345.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>