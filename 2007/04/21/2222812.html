<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/21/2222812.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A geek can't always get a date, but the date statement sure can get to a geek</title></head><body>
<h1>A geek can't always get a date, but the date statement sure can get to a geek</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/21 03:43 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/21/2222812.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The question that was asked to the popular alias about Win32 development:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">We’ve got a stubborn machine on which a CMD window opened by the user emits date /t as “Thu 04/19/2007” whereas when Visual Studio 2005 runs a .cmd file from a build-step, date /t emits “04/19/2007 Thu”.&nbsp; The displaced tokens interfere with the parsing rules in the .cmd.<BR><BR>I’m looking for some kind of “mode cp” command or something that we can push/pop in the .cmd file to ensure date/time is presented in a known, fixed format.&nbsp; <BR><BR>We’re also wondering why the Control Panel Regional Settings applet does not seem to be effecting the DOS-box (perhaps we just don’t realize when a reboot is required or something)?&nbsp; And why does VS2k5 use a different cmd environment than the interactive user (who launched VS2k5)?<BR><BR>Thanks</FONT></EM></P></BLOCKQUOTE>
<P>Funny story about this one....</P>
<P>Well, actually, not so much a story as several longstanding behaviors, each of which when taken on its own might be okay but then when you combine them all together turn into something really hard to do much more than shake one's head, let alone fathom.</P>
<P>We start with the day names -- these are loaded when CMD starts, along with some other&nbsp;trivia about separators and such. Those day names are the ones that get inserted somewhere in the string later with that <STRONG>date</STRONG> command. Well, sometimes.</P>
<P>Then we'll talk about how it gets the date format to use. It calls <A class="" href="http://msdn2.microsoft.com/library/ms776293.aspx" mce_href="http://msdn2.microsoft.com/library/ms776293.aspx">GetDateFormat</A>, using as an LCID... wait for it... LOCALE_USER_DEFAULT. </P>
<P>Each time.</P>
<P>Yes, that means that if you change your user locale, it will pick up the changes in regard to your preferred short date format, even though the day name it uses may well not match that locale....</P>
<P>Luckily it is just a short date, but the fact that there are no month names in there is more a convention in the data than a rule. If you are unlucky enough, you might find some very odd results with mixed languages in the string....</P>
<P>But wait, it gets better.</P>
<P>You see, starting in Vista it actually doesn't use LOCALE_USER_DEFAULT; it uses a wrapper around <A class="" href="http://msdn2.microsoft.com/library/ms776244.aspx" mce_href="http://msdn2.microsoft.com/library/ms776244.aspx">GetUserDefaultLCID</A> to make sure that if you are using a complex script locale as your default user locale that it can give you&nbsp;a fallback that will work in the console.</P>
<P>Unfortunately, the wrapper is not using the new LOCALE_SCONSOLEFALLBACKNAME of <A class="" href="http://msdn2.microsoft.com/library/ms776365.aspx" mce_href="http://msdn2.microsoft.com/library/ms776365.aspx">GetLocaleInfoEx</A>, also added in Vista, for this very situation.</P>
<P>Instead, it is just checking if <A class="" href="http://msdn2.microsoft.com/library/ms776329.aspx" mce_href="http://msdn2.microsoft.com/library/ms776329.aspx">PRIMARYLANGID</A>(<A class="" href="http://msdn2.microsoft.com/library/ms776244.aspx" mce_href="http://msdn2.microsoft.com/library/ms776244.aspx">GetUserDefaultLCID</A>) returns LANG_ARABIC, LANG_HEBREW, LANG_THAI, LANG_HINDI, LANG_TAMIL, or LANG_FARSI. </P>
<P>Unfortunately this ignores the possibility of it being LANG_DIVEHI, LANG_GUJARATI, LANG_KANNADA, LANG_KHMER, LANG_LAO, LANG_MALAYALAM, LANG_MARATHI, LANG_NEPALI, LANG_ORIYA, LANG_PASHTO, LANG_PUNJABI, LANG_SANSKRIT, LANG_SINHALESE, LANG_SYRIAC, LANG_TELUGU, LANG_TIBETAN, LANG_UIGHUR, LANG_URDU, or any of the others I may have forgotten.</P>
<P>Even more unfortunately, it ignores the possibility of it being a custom locale supporting any of these or indeed any other complex script locale.</P>
<P>But wait, it gets worse.</P>
<P>The way that the determination is made for whether the day name comes before or after the date is essentially taking a look at the return of&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms683169.aspx" mce_href="http://msdn2.microsoft.com/library/ms683169.aspx">GetConsoleOutputCP</A> and whether it returns 932, 936, 949, or 950. In other words whether it is a CJK double-byte code page. This is another setting that can be changed with a chcp call....</P>
<P>(there is some other trivia involved in the decision like whether the day name is in the string already and such, to avoid the potentially embarrassing stutter of repeating the name, I guess.</P>
<P>Because I'm sure that is the only possible behavior in all that I have described that folks might find embarrassing? :-)</P>
<P>In any case, I am not entirely sure what VS 2005 is doing here, but it is clear that relying on the hard-coded nature of <STRONG>date</STRONG> is going to be a pretty bug mistake. Much safer if you want a date that is going to vary to generate it yourself with your own tool.</P>
<P>I'll talk to some people 'bout the clean-up the CMD behavior for the next version of Windows. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by </EM>&nbsp;<FONT face=Lashio size=6>၎</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/104e" mce_href="http://www.fileformat.info/info/unicode/char/104e">U+104e</A>, a.k.a. MYANMAR SYMBOL AFOREMENTIONED)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/22/2239345.html" title="The Notepad encoding detection issues keep coming up">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/20/2209323.html" title="Those keyboard layout DLLs are *not* the hardware">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/21/2222812.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>