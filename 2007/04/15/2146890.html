<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/15/2146890.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>If you find that GetLocaleInfo is driving you crazy, it may not be the right function to use</title></head><body>
<h1>If you find that GetLocaleInfo is driving you crazy, it may not be the right function to use</h1>
<p><em>by Michael S. Kaplan, published on 2007/04/16 00:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/04/15/2146890.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Aaron asks (via the Contact link):</P>
<BLOCKQUOTE><FONT size=2>
<P><EM><FONT face="times new roman,times">I apologize for this totally unsolicited email, but I'm starting to wonder if I'm crazy or </FONT></EM></FONT><EM><FONT face="times new roman,times">not.&nbsp; I'm using GetLocaleInfo to determine what language the user wants their UI strings displayed in.&nbsp; I'm using LOCALE_SISO639LANGNAME and LOCALE_SISO3166CTRYNAME to get a string such as en-US.&nbsp; <BR><BR>The part where I'm confused is where GetLocaleInfo is grabbing that information from.&nbsp; In the XP regions and languages control panel, there's a strangely worded option in the "Advanced" tab called "Language for non-Unicode programs."&nbsp; When I set that to something like "French (france)", I still get en-US instead of fr-FR. <BR><BR>The reason I'm doing this is because we have a custom localization scheme for our application, which runs on Windows 98 through Vista.&nbsp; So we are not technically a Unicode application (we don't #define UNICODE), but we support Unicode in that we dynamically load the W version of every API we come across and prefer that to the A version (and our strings are encoded accordingly).&nbsp; So does that option in the Advanced tab even apply to our application?&nbsp; If it does, how would I get that information?<BR><BR>How far gone is my misunderstanding of things?&nbsp; ;-)&nbsp; <BR><BR>Thanks for your time!</FONT></EM></P></BLOCKQUOTE>
<P><A class="" href="http://msdn2.microsoft.com/library/ms776270.aspx" mce_href="http://msdn2.microsoft.com/library/ms776270.aspx">GetLocaleInfo</A>&nbsp;does not grab its information from any setting in Regional Options. It grabs its info from its own internal database of information, based on the locale you pass it.</P>
<P>The "Language for non-Unicode Programs" is also known as the "Default System Locale" and really if not a good setting upon which to base a localization strategy, for way too many reasons to enumerate fully (but the fact that the intent is to provide the locale to use for conversions between Unicode and "ANSI" ought to be reason enough on its own).</P>
<P>If you really wanted to get the information from this setting via <A class="" href="http://msdn2.microsoft.com/library/ms776270.aspx" mce_href="http://msdn2.microsoft.com/library/ms776270.aspx">GetLocaleInfo</A>, you could just pass LOCALE_SYSTEM_DEFAULT as the LCID. But like I said, you do not want to use that setting (you claimed to want to support Windows 98, Aaron -- this setting is not changeable in Windows 98).</P>
<P>Now you could in theory use the "Standards and Formats" setting, also known a the default user locale (you would use LOCALE_USER_DEFAULT in that <A class="" href="http://msdn2.microsoft.com/library/ms776270.aspx" mce_href="http://msdn2.microsoft.com/library/ms776270.aspx">GetLocaleInfo</A> call). It has the advantage of being settable on all platforms, if nothing else.</P>
<P>Clearly though, it is not intended to drive the UI language, and thus if you made it drive UI language in your application you would be providing confusing UI to the user.</P>
<P>But if you think about that locale list for a moment, the odds that it will match your list of UI languages for your application are probably pretty close to nil. So you do not miss much by not using that setting.</P>
<P>Now I could claim that you should use the results of the user interface language functions provided by MUI, but to be honest even though it has the advantage of being an accurate setting, it really isn't likely to be able to match your UI languages of your application either.</P>
<P>(Look on the right side of the page and expand the one that says <STRONG>Regional Options</STRONG> for more information on what each setting there is generally for.)</P>
<P>And also, not every version of Windows supports the two-letter ISO codes (and LOCALE_SISO639LANGNAME and LOCALE_SISO639CTRYNAME are often the three letter codes from which you cannot deterministically derive the two letter codes), not to mention the fact that from time to time some of them have been wrong. So using Win32 NLS API functions to call at runtime to get the language tags to use on any version of Windows from Win98 to Vista just seems like a bad idea.</P>
<P>If you are providing a localized copy of your application then you can default to the UI language of the operating system and then you should honestly provide your own user interface to let them change it, based on the list of localized versions of your application that you support. The various lists that Windows provides aren't actually good ways to choose your UI language (beyond that possible idea of the initial one you might choose via <A class="" href="http://msdn2.microsoft.com/library/ms776286.aspx" mce_href="http://msdn2.microsoft.com/library/ms776286.aspx">GetUserDefaultUILanguage</A> when it is available -- that function is included in almost every version you need other than Win98; it even is there on WinME).</P>
<P>Thus my guess in the title of this post, Aaron -- the reason <A class="" href="http://msdn2.microsoft.com/library/ms776270.aspx" mce_href="http://msdn2.microsoft.com/library/ms776270.aspx">GetLocaleInfo</A>&nbsp;is driving you crazy is that it is really not&nbsp;the function your application should be using here. It is driving you crazy for the same reason that a pair of pliers would drive you crazy for fixing a hangnail....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> áƒ¯ <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/10ef" mce_href="http://www.fileformat.info/info/unicode/char/10ef">U+10ef</A>, a.k.a. GEORGIAN LETTER JHAN)</EM></FONT></P>
<hr/><p><a id="2154396" href="#2154396">#</a> <strong>Aaron Ballman</strong> on 16 Apr 2007 10:56 AM:</p><div style="margin-left: 1em"><p>Thank you very much for the excellent post! &nbsp;You bring up some points which I hadn't thought of before (such as the three letter codes).</p>
<p>The trouble is -- this localization isn't just for my product (which is an IDE and programming language). &nbsp;It's for my user's products (which they make with said IDE). &nbsp;So the idea of using a list to pick from simply isn't viable.</p>
<p>Ideally, I'd like to be using string resources with the localized language ID directories so that calls to LoadString can figure out what string to grab for me. &nbsp;But that solution is still a ways off, so I'm looking for a band-aid in the meantime. &nbsp;It seems to me that the band-aid should be to use the LANGID as the filename on disk instead of what we're working on currently.</p>
<p>Thanks again!</p>
</div>
<p><a id="2157205" href="#2157205">#</a> <strong>Mihai</strong> on 16 Apr 2007 4:48 PM:</p><div style="margin-left: 1em"><p>&lt;&lt;use the LANGID as the filename on disk&gt;&gt;</p>
<p>I would recommend folder names, not file names. A folder can be used to store not only UI, but also samples, templates, help, etc.</p></div>
<p><strong>Jacob Sch&#228;ffer</strong> on 3 Aug 2011 10:48 AM:</p><div style="margin-left: 1em"><p>Hello Michael,</p>
<p>I forgot to mention that the Moldov language LCID variants appear to be the only variants I can find that fail with the GetLocaleInfoW API.</p>
<p>If Windows cannot return the &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; pattern for the Moldov variants via the GetLocaleInfoW API, how can one get access to the pattern for these variants?</p>
<p>All the best / Jacob (jas@skabelondesign.dk)</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 3 Aug 2011 11:17 AM:</p><div style="margin-left: 1em"><p>This assumes there is support for a locale on Windows -- is there, in this case?</p>
</div>
<p><strong>Jacob Sch&#228;ffer</strong> on 3 Aug 2011 2:01 PM:</p><div style="margin-left: 1em"><p>Hello Michael,</p>
<p>It seem that my first comment failed to reach you. Here it comes again:</p>
<p>I&#39;m using the GetLocaleInfoW function to return the &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; pattern for a specific LCID using the LOCALE_SNAME constant (in VB6 and Office VBA). While doing so I found that looking up LCID&#39;s 2072 (&amp;H818) for Moldov Romanian and 2073 (&amp;H819) for Moldov Russian fail, while any other LCID I try returns the expected pattern. </p>
<p>The same thing happens when I use the LOCALE_SISO639LANGNAME and LOCALE_SISO3166CTRYNAME instead of LOCALE_SNAME.</p>
<p>I cannot find the LCID&#39;s 2072 (&amp;H818) and 2073 (&amp;H819) in the &quot;Language Identifier Constants and Strings&quot; table at <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/dd318693(v=VS.85).aspx">msdn.microsoft.com/.../dd318693(v=VS.85).aspx</a>, so I suppose Windows (tested on Windows 7) cannot properly deal with these Moldov language variants. Can this really be true?</p>
<p>Surprisingly, MS Office 2010 declare the constants wdRomanianMoldova (2072) and wdRussianMoldova (2073) in the WdLanguageID enum, and similarly in the MsoLanguageID enum.</p>
<p>Is it possible that MS Office supports languages for both document editing and the Office GUI that doesn&#39;t exist in Windows, or do I need to use another function to get access to the complete locale info database (I need support back to Windows XP)?</p>
<p>I&#39;m using the &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; pattern to identify which language file (not standard ressource files, but external UTF-16LE encoded XML documents) to load strings from. Although I might never run into the need for a Moldov Romanian setup I&#39;d prefer to have a generic and reliable function that returns meaningful &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; patterns for all MS Office declared LCID&#39;s.</p>
<p>Finally, I also need the reverse functionality. I&#39;ve been looking for an API function or a constant for GetLocaleInfoW that returns the LCID based on the input string pattern &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt;. I may have become blind and overlooked something during my searches, but I didn&#39;t find any API method for this. Does such a beast exist or do I have to build my own table (which is a highly undesirable thing to do)?</p>
<p>All the best / Jacob (jas@skabelondesign.dk)</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 3 Aug 2011 3:33 PM:</p><div style="margin-left: 1em"><p>This locale is not supported by Windows; you should discuss the issue with Office and whatever functions they might provide if you want the solution for this....</p>
</div>
<p><strong>Jacob Sch&#228;ffer</strong> on 3 Aug 2011 5:43 PM:</p><div style="margin-left: 1em"><p>Thanks. If these locales aren&#39;t supported by Windows there is nothing generally wrong with the function I use. I&#39;ll just add these LCID&#39;s to an exception list so I can deal with this situation separately.</p>
<p>The reverse function, however, which takes the &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; pattern for input (supported locales only, of course), might be built upon the GetLocaleInfoEx() API and then calculate the LCID from some return values, I believe. However this function isn&#39;t available on Windows XP, which is essential for me to support. Is there any way to build a &lt;language&gt;-&lt;Script&gt;-&lt;REGION&gt; pattern -&gt; LCID conversion function on XP via API functions?</p>
<p>All the best /Jacob</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 4 Aug 2011 12:31 AM:</p><div style="margin-left: 1em"><p>The actual function does not construct the LOCALE_SNAME values from pieces; it has the full names and LCIDs in the locale data....</p></div>
<p><strong>Jacob Sch&#228;ffer</strong> on 4 Aug 2011 8:09 AM:</p><div style="margin-left: 1em"><p>Ahhh ... In that case it&#39;s definitely most interesting to build lookup functions that use the Windows locale database - in both directions. As far as I can see this can easily be done on Vista and later Windows versions, but not on Windows XP.</p>
<p>Is there ANY way on Windows XP to provide eg. &quot;da-DK&quot; for input to an API function and have &quot;1030&quot; (or the hex variant) returned? I can easily do it with GetLocaleInfoEx() with the LOCALE_ILANGUAGE flag on Vista+, but since GetLocaleInfoEx() is not available on XP I need another route on XP.</p>
<p>Is there any other way on XP than building a private lookup table, that maps eg. &quot;da-DK&quot; to &quot;1030&quot;?</p>
<p>Thanks again /Jacob</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 4 Aug 2011 8:53 AM:</p><div style="margin-left: 1em"><p>The Downlevel NLS Support library will help with some of these tasks. Have you tried it out?</p>
</div>
<p><strong>Jacob Sch&#228;ffer</strong> on 8 Aug 2011 12:34 AM:</p><div style="margin-left: 1em"><p>Excellent tip. The DownlevelLCIDToLocaleName() and DownlevelLocaleNameToLCID() does what I want.</p>
<p>But &quot;Nobody likes change&quot;, you know (<a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2006/07/16/667622.html">blogs.msdn.com/.../667622.aspx</a>), so I have to have backward-looking customers accept to install a static, additional library that back-ports the functionality to XP from Vista+. This could be a problem at certain customers running Citrix on Server 2003 :-)</p>
<p>Would it make any sense to resolve anything from the keys in HKEY_CLASSES_ROOT\MIME\Database\Rfc1766 as an alternative in those cases?</p>
<p>Thanks again / Jacob</p>
</div>
<p><strong>Jacob Sch&#228;ffer</strong> on 8 Aug 2011 1:16 AM:</p><div style="margin-left: 1em"><p>Perhaps the best way on XP would be to build and cache an internal lookup table with EnumSystemLocales() using the LCID_SUPPORTED flag, and for each returned locale identifier fetch the locale name via GetLocaleInfo() with LOCALE_SNAME.</p>
<p>This would eliminate any need for adding the Downlevel NLS functions for XP, and should work as far back as Windows 2000 (if I read MSDN correctly).</p>
<p>Would this method be too nonsensical?</p>
<p>All the best /Jacob</p>
</div>
<p><strong>Jacob Sch&#228;ffer</strong> on 8 Aug 2011 4:35 AM:</p><div style="margin-left: 1em"><p>Hmmm ... while enumerating with EnumSystemLocales() and fetching the Locale Names with GetLocaleInfo() I can see that Microsoft doesn&#39;t seem to follow the two-letter ISO naming convention for languages (which I thought MS actually did).</p>
<p>In fact, neither the &lt;language&gt; part nor the &lt;REGION&gt; part of the Locale Names is guaranteed to follow the two-letter convention. For example, the Locale Name for Caribbean English is returned as &quot;en-029&quot; and Russian Yakut is returned as &quot;sah-RU&quot;, which both break the convention.</p>
<p>Interesting, but scrutiny unveil that it&#39;s documented and very simple to deal with as long as one don&#39;t conjecture about abbreviations.</p>
<p>GetLocaleInfo() certainly WAS driving me crazy, but in cooperation with EnumSystemLocales() it definitely IS the right function to use. In this case, at least :-)</p>
<p>All the best /Jacob</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 8 Aug 2011 9:06 PM:</p><div style="margin-left: 1em"><p>See <a rel="nofollow" target="_new" href="http://archives.miloush.net/michkap/archive/2006/09/06/742245.html">blogs.msdn.com/.../742245.aspx</a> for the size mismatch issue, described....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/08/05 <a href="http://archives.miloush.net/michkap/archive/2011/08/05/10193046.html">Windows isn't Office (and vice versa)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/04/16/2152451.html" title="Which one has the astigmatism?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/04/15/2145619.html" title="Rhymes with Amharic #5 (a.k.a. [Sub]setting up this code where it can do the most good?)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-04-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/04/15/2146890.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>