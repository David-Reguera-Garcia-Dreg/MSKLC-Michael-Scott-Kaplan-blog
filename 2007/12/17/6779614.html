<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/12/17/6779614.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>No good way to get one's Jalalis playing with calendars in Windows or .NET, really</title></head><body>
<h1>No good way to get one's Jalalis playing with calendars in Windows or .NET, really</h1>
<p><em>by Michael S. Kaplan, published on 2007/12/17 10:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/12/17/6779614.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The question I received via the Contact link was:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Dear Michael,<BR><BR>we have a huge issues with Persian (Jalali) Calendar on WSS 3.0. We will appreciate if you can provide us with your input in this regard. it looks all Microsoft applications are getting the culture information from the Windows &amp; .NET. We have just figured out some new things for Persian Calendar and specially correcting a Culture for Windows based on .NET.<BR><BR>the fact is that the default Calendar for this culture is "Gregorian" and either we have to override that or add a new one. Adding a new one is impossible (mscorlib.dll is locked and can not be edited) and also overriding is was not possible because even we overridden it (a code example is as below), we couldn't even return a simple string (No idea why it was so).<BR><BR></EM><FONT face="consolas,lucida console,courier new,courier"><STRONG>&nbsp; &nbsp; Public Class MyNewCalendar<BR>&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; Inherits GregorianCalendar<BR>&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Public Overrides Function GetYear(ByVal time As Date) As Integer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Dim p As New PersianCalendar<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 'Return p.GetYear(time)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return 1386<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ' Return MyBase.GetYear(time)<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Function<BR>&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; Public Overrides Function ToFourDigitYear(ByVal year As Integer) As Integer<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return 1386<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; 'Return MyBase.ToFourDigitYear(year)<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End&nbsp;Function<BR>&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; Public Overrides Function ToString() As String<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Return "1386"<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; ' Return MyBase.ToString()<BR>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; End Function<BR>&nbsp; &nbsp; End Class</STRONG></FONT><BR><BR><EM>We will appreciate your help and resources.</EM></FONT></P></BLOCKQUOTE>
<P mce_keep="true">The history of pieces of System.Globalization that are and are not able to be overridden is pretty sordid to say the least.</P>
<P mce_keep="true">There are two consistent&nbsp;principles that&nbsp;developers&nbsp;should keep in mind&nbsp;if they is developing against any of them:</P>
<UL>
<LI>
<DIV mce_keep="true">The bulk of the things marked as&nbsp;<STRONG>sealed</STRONG> probably could have been made able to be overridden but for whatever reason it was not done;</DIV></LI>
<LI>
<DIV mce_keep="true">The bulk of the things marked as&nbsp;<STRONG>able to be overridden</STRONG> has internal dependencies in the base class that will cause the code to not work in many cases.</DIV></LI></UL>
<P mce_keep="true">Thus I was perhaps inaccurate (or at&nbsp;the very least misleading)&nbsp;to say that developers could count on these principles, as by definition counting on them means that you cannot count on the ability to override any of these classes in the long run....</P>
<P mce_keep="true">So to start, the reason that you can't effectively override the Calendar class or any of its children is that the implementation has too many dependencies out side of the class that depend on internal/private members within it.</P>
<P mce_keep="true">Also,&nbsp;remembering that calendars are irretrievably horked and broken in both managed (ref: <A class="" href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html"><STRONG>here</STRONG></A>) and unmanaged (ref: <A class="" href="http://archives.miloush.net/michkap/archive/2005/01/14/353347.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/353347.html"><STRONG>here</STRONG></A> and <A class="" href="http://archives.miloush.net/michkap/archive/2005/01/14/353216.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/353216.html"><STRONG>here</STRONG></A>)&nbsp;code&nbsp;will also help here (note the "able to be overridden" issues were brought up in that post about managed code).</P>
<P mce_keep="true">Now as a rule, the universal truth about the backassward and lame implementations of calendars in both unmanaged and managed code us very well understood. though people are hesitant to even try to plan all of the work to fix them as the sheer scale of the effort (and how it ties to date formatting, custom cultures, and date parsing) is quite daunting -- and every version thinking about the issues seems to happen too late to plan out all of the work that would be involved, let along do the work.</P>
<P mce_keep="true">So people around these parts consider the fact that most of the major calendars that Microsoft wants to support are there and the few that are left are cheaper to just add to the list implemented by MS than to provide custom calendar mechanisms which would also require the aforementioned re-architecting.</P>
<P mce_keep="true">Iranian/Farsi/Persian has its own issues here for <A class="" href="http://en.wikipedia.org/wiki/Wassenaar_Arrangement" mce_href="http://en.wikipedia.org/wiki/Wassenaar_Arrangement">Wassenaar Arrangement</A> reasons and the various <A class="" href="http://en.wikipedia.org/wiki/Iran_and_copyright_issues" mce_href="http://en.wikipedia.org/wiki/Iran_and_copyright_issues">patent/copyright</A> issues don't make it any easier either.</P>
<P mce_keep="true">Are we having fun yet?</P>
<P mce_keep="true">Okay, in that case I'll point out a potential&nbsp;workaround for the specific case of this calendar in managed applications -- discussed previously <A class="" href="http://archives.miloush.net/michkap/archive/2005/10/20/482896.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/20/482896.html"><STRONG>here</STRONG></A> and <A class="" href="http://archives.miloush.net/michkap/archive/2007/06/26/3559309.html" mce_href="http://archives.miloush.net/michkap/archive/2007/06/26/3559309.html"><STRONG>here</STRONG></A> -- the <A class="" href="http://msdn2.microsoft.com/library/system.globalization.persiancalendar.aspx" mce_href="http://msdn2.microsoft.com/library/system.globalization.persiancalendar.aspx">PersianCalendar class</A> (renamed from the JalaliCalendar class, as it was called originally).</P>
<P mce_keep="true">This won't work in unmanaged code as the calendar isn't supported there, and it cannot work as the default calendar for any of the cultures in .NET, as is explained in the topic:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>Your application should not use a PersianCalendar object as the default calendar for a culture. The default calendar is specified by the CultureInfo.Calendar property and must be one of the calendars returned by the CultureInfo.OptionalCalendars property. Currently, the PersianCalendar class is not an optional calendar for any culture supported by the CultureInfo class and consequently cannot be a default calendar.</EM></P></BLOCKQUOTE>
<P mce_keep="true">The reason for this limit is in theory simple enough -- because any culture can be the basis for a custom culture, and any custom culture can be&nbsp;a custom locale on Vista and Server 2008 -- which does not have this calendar. And therefore you can't put a calendar in that the system would not recognize.</P>
<P mce_keep="true">In practice, I think this is a bad limitation -- in my opinion a more sensible one (considered, but&nbsp;eventually rejected) would have been&nbsp;to simply require that <STRONG>at least one</STRONG> calendar in the culture (i.e. some member of the CultureInfo.OptionalCalendars array) to be supported. who cares if the top of the list doesn't work, as long as one of the alternates do? :-)</P>
<P mce_keep="true">As workarounds go the available one is fairly lame given all the limitations, though so far that has not been a significant enough limitation to lead to support for the calendar in unmanaged code. So until and unless&nbsp;that work happens, there is no good answer for how to have integrated support of the calendar in both managed and unmanaged code....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> ÿç </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/060d" mce_href="http://www.fileformat.info/info/unicode/char/060d">U+060d</A>, aka ARABIC DATE SEPARATOR)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/12/17/6784443.html" title="What&#39;s the difference between running a localized version of Windows and running Windows with that user interface language?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/12/16/6781863.html" title="On doing the gimp thing with no wingman^H^H^Hperson">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12-17">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/12/17/6779614.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>