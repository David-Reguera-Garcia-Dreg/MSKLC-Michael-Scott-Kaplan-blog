<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/12/27/6875879.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>No upproblems with $UpCase when you do a upVista upgrade</title></head><body>
<h1>No upproblems with $UpCase when you do a upVista upgrade</h1>
<p><em>by Michael S. Kaplan, published on 2007/12/27 10:16 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/12/27/6875879.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>One of the interesting consequences&nbsp;I have noted when it comes to dealing with having a Blog with &gt;2200 blogs in it, such as what happens when somebody comes across the Blog as it is and start randomly reading posts from it.</P>
<P>When combined with the fact that I no longer tend to shut down comments in damn near any of them, another interesting consequence emerges: some people will start randomly commenting in posts, treating the ones from three years ago no differently than the ones written three days ago. :-)</P>
<P>One such person is <A class="" href="http://tanveerbadar.wordpress.com/" mce_href="http://tanveerbadar.wordpress.com/">Tanveer Badar</A>, who has been commenting in many different posts recently....</P>
<P>Though one fact became obvious -- no response was usually expected, since when a response was desired, the question shows up in the Suggestion Box:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">You wrote ages ago (in August 2005)<BR><BR></FONT></EM><A class="" href="http://archives.miloush.net/michkap/archive/2005/08/20/454071.html" mce_href="http://archives.miloush.net/michkap/archive/2005/08/20/454071.html"><EM><FONT face="times new roman,times"><STRONG>New in Vista Beta 1: Updated OS casing tables</STRONG></FONT></EM></A><BR><BR><EM><FONT face="times new roman,times">This mentions of $UpCase, the file containing upper case conversion table(s).<BR><BR>Now consider, I have Windows XP installed on an NTFS partition. Then, I install Windows Vista. Will $upcase on Windows XP partition be upgraded too or I have to reformat a volume from Windows Vista to upgrade $upcase?<BR><BR>If it does get upgraded, are there any problems associated with it? If not upgraded, why not?</FONT></EM></P></BLOCKQUOTE>
<P>A very good question, that!</P>
<P>Thankfully, the answers are:</P>
<UL>
<LI>No, the table is not automatically updated on the XP partition;</LI>
<LI>No you do not have to reformat the drive;</LI>
<LI>No, by and large there are very few problems you will hit, whether you upgrade the table or not!</LI></UL>
<P>It is something I covered a little bit recently in <A class="" href="http://archives.miloush.net/michkap/archive/2007/10/24/5641619.html" mce_href="http://archives.miloush.net/michkap/archive/2007/10/24/5641619.html"><STRONG>In Case you have problems that you might think are ǸȦȘȚȲ</STRONG></A>, where admittedly the issue is smaller since a jump drive is a bit easier to deal with than a full partition, especially the main partition of the Windows install potentially being upgraded. :-)</P>
<P>Basically, since <STRONG>case</STRONG> is preserved but not changed, the definition of case changing is not an issue as long as you always ask for items using the proper case, or if nothing else you are willing to live with the file you get when you have more than one available and you don't ask for the right case potentially getting the "wrong" item back....</P>
<P>Just like I showed in the&nbsp;<STRONG><U><FONT color=#810081>ǸȦȘȚȲ</FONT></U></STRONG> post. :-)</P>
<P>Now with that said, there is an interesting side effect that is covered in the following article from the MS knowledge base:</P>
<P><A class="" href="http://support.microsoft.com/kb/940830" mce_href="http://support.microsoft.com/kb/940830">940830: Error message when you run Chkdsk.exe on a Windows XP-based or on a Windows Server 2003-based computer: “Correcting errors in the uppercase file”</A></P>
<P>Basically, if you dual boot between an XP and a Vista partition you will occasionally see chkdsk being run at boot time (you can also request this be done if you request that&nbsp;chkdsk be run and it cannot when you ask due to the drive being locked).</P>
<P>During that run, you will get the message <STRONG>Correcting errors in the uppercase file</STRONG> when that run happens on XP at boot time, even if you do not pass the /F flag to "fix" errors. If you do pass the /F flag then the drive will be "fixed" by which I mean the UpCase table in the drive will be updated (or in this case <STRONG>down</STRONG>dated) to the XP table, though there is no problem with files on the drive violating those rules as long as functions dealing with the files preserve case (and you don't try to move or copy files that would conflict on the tables update/downdated!)....</P>
<P>The error does not happen when you run in Vista since the updated chkdsk does not treat the situation as an error and thus does not report it as such. There was originally going to be an update to the older versions of chkdsk,exe but that update was not triaged as being important enough (since other than the possibly mildly&nbsp;unclear error message there is really no error here).</P>
<P>So in the end whether to do the update is up to you and there is no need to reformat or even change anything....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM><FONT size=5> ഗ </FONT><EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0d17" mce_href="http://www.fileformat.info/info/unicode/char/0d17">U+0d17</A>, aka MALAYALAM LETTER GA)</EM></FONT></P>
<hr/><p><a id="6889710" href="#6889710">#</a> <strong>Tanveer Badar</strong> on 28 Dec 2007 6:23 PM:</p><div style="margin-left: 1em"><p>Hi, perhaps I should prefix my name with &quot;Not the random </p>
<p>reader”. : -) </p>
<p>The reason you are seeing comments on old posts is because I always read a blog back to front when I find one that is interesting. I must say that I am having trouble keeping up with the backlog of all those posts. </p>
<p>Hopefully, I will catch up with your (exceedingly high) posting rate in the next month and you won’t see any more “some people will start randomly commenting in posts, treating the ones from three years ago no differently than the ones written three days ago&quot;.</p>
</div>
<p><a id="6891274" href="#6891274">#</a> <strong>Michael S. Kaplan</strong> on 28 Dec 2007 8:55 PM:</p><div style="margin-left: 1em"><p>I don't mind it all -- it is quite enjoyable. :-)</p>
</div>
<p><a id="6895308" href="#6895308">#</a> <strong>Tanveer Badar</strong> on 29 Dec 2007 4:43 AM:</p><div style="margin-left: 1em"><p>Nor did I. However, as of this post I wanted to clarify things as they seemed horribly misunderstood. :)</p>
</div>
<p><a id="6900320" href="#6900320">#</a> <strong>Random Reader</strong> on 29 Dec 2007 3:37 PM:</p><div style="margin-left: 1em"><p>There is only one me!</p>
<p>I've always thought the NTFS $UpCase mechanism was a very smart bit of forethought in the design. Since it is essentially a database, and there is a specific set of conversion semantics that are required for operational consistency, it makes sense to store those semantics in the database itself. Protection from external changes.</p>
<p>I don't understand the chkdsk thing, though. What is modifying the $UpCase table in the first place, that requires chkdsk to fix it?</p>
<p>Preserving case in requests might actually be harder than it seems. You can pass FILE_FLAG_POSIX_SEMANTICS to things like CreateFile(), or use the Nt* functions directly without passing the case-insensitive flag, but newer versions of Windows have the object manager force case-insensitivity by default, and there's nothing you can do at an API level to override that. (Unless you're in-kernel, like a driver.)</p>
<p>If you end up with two directories having the same name that differs only in case, you'll have an amazingly hard time getting into the non-favored one via normal means, even if you preserve the case in your request. (Differs according to $UpCase, not NLS.)</p>
<p>It's difficult to see a situation where this would come up in normal usage, but just the idea that chkdsk and something else are making changes to $UpCase raises a red flag for me...</p></div>
<p><a id="6929087" href="#6929087">#</a> <strong>Yuhong Bao</strong> on 31 Dec 2007 10:12 PM:</p><div style="margin-left: 1em"><p>&quot;newer versions of Windows have the object manager force case-insensitivity by default, and there's nothing you can do at an API level to override that. (Unless you're in-kernel, like a driver.)&quot;</p>
<p>Install Service for Unix and you can change that.</p></div>
<p><a id="6941543" href="#6941543">#</a> <strong>Random Reader</strong> on 1 Jan 2008 3:02 PM:</p><div style="margin-left: 1em"><p>Yeah, I probably should have mentioned, it's a simple registry key to change that behavior. There's mention of it in <a rel="nofollow" target="_new" href="http://support.microsoft.com/kb/929110">http://support.microsoft.com/kb/929110</a></p>
<p>The problem here though is that it's an administrative setting, not a programmatic one.</p>
<p>I missed it last time around, but KB940830 says the chkdsk thing happens when you run an earlier chkdsk (XP/2003) on an NTFS volume formatted by a later OS (Vista). It doesn't mention whether Vista's chkdsk does the same thing though.</p>
<p>In any case, the problem scenario I was thinking of should only occur if you put conflicting files on the drive using XP rules, $UpCase is changed to use Vista rules, and then try to access them using the new rules -- similar to the post about the experiment with the jump drive. If Vista's chdksk doesn't screw with $UpCase the way XP's does, this would probably never happen.</p></div>
<p><a id="6943207" href="#6943207">#</a> <strong>Michael S. Kaplan</strong> on 1 Jan 2008 5:29 PM:</p><div style="margin-left: 1em"><p>The thing you're missing here is that whether one has the case sensitive or case insensitive setting, one has CASE PRESERVATION. And that means if your $UpCase table does not match your OS table and you have &quot;duplicates&quot; thereby, then everything will will work if you ask with the right case.</p>
<p>It works, truly.</p>
<p>As for the chkdsk thing, Vista does the same thing, it just does it silently (that is the &quot;fix&quot; they decided not to port downlevel)....</p>
</div>
<p><a id="6945195" href="#6945195">#</a> <strong>Random Reader</strong> on 1 Jan 2008 7:54 PM:</p><div style="margin-left: 1em"><P>I don't think we're talking about the same scenario. Consider a situation where XP says "Filename" and "filename" are different, because it does not know about case differences for the letter 'F'. So, under XP, you can create both "Filename" and "filename" in the same directory, perhaps by accident, with no problems.</P>
<P>Now Vista comes along and adds a table entry that says 'F' and 'f' are the same if you ignore case. Both files still exist in that directory, but given the default object manager settings, it is impossible for you to access one of those files via normal APIs.</P>
<P>Sample program with many assumptions and a horrid lack of error checking:</P>
<P>------------------------------------<BR>#include &lt;stdio.h&gt;<BR>#include &lt;windows.h&gt;<BR>int main(void)&nbsp;&nbsp;&nbsp; {<BR>&nbsp; HANDLE fh;<BR>&nbsp; DWORD count;<BR>&nbsp; char buffer[32] = {0};<BR>&nbsp; fh = CreateFile("FILENAME.txt", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_FLAG_POSIX_SEMANTICS, NULL);<BR>&nbsp; WriteFile(fh, "UPPERCASE FILE CONTENTS", 23, &amp;count, NULL);<BR>&nbsp; CloseHandle(fh);<BR><BR>&nbsp; fh = CreateFile("filename.txt", GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_FLAG_POSIX_SEMANTICS, NULL);<BR>&nbsp; WriteFile(fh, "lowercase file contents", 23, &amp;count, NULL);<BR>&nbsp; CloseHandle(fh);<BR><BR>&nbsp; printf("files created\n");<BR>&nbsp; getchar();<BR>&nbsp; printf("opening uppercase filename... ");<BR><BR>&nbsp; fh = CreateFile("FILENAME.txt", GENERIC_READ, 0, NULL, OPEN_EXISTING, 0, NULL);<BR>&nbsp; ReadFile(fh, buffer, sizeof(buffer), &amp;count, NULL);<BR>&nbsp; printf("got %s\n", buffer);<BR>&nbsp; CloseHandle(fh);<BR>&nbsp; printf("opening lowercase filename... ");<BR>&nbsp; fh = CreateFile("filename.txt", GENERIC_READ, 0, NULL, OPEN_EXISTING, 0, NULL);<BR>&nbsp; ReadFile(fh, buffer, sizeof(buffer), &amp;count, NULL);<BR>&nbsp; printf("got %s\n", buffer);<BR>&nbsp; CloseHandle(fh);<BR>&nbsp; return 0;<BR>}</P>
<P>------------------------------------</P>
<P>When I test that on a 2003 box with the registry key set appropriately per KB929110 so I can distinguish case, both files are successfully created. &nbsp;However, it only reads the contents of FILENAME.txt, despite the fact that I explicitly asked for the other file in the second request.</P>
<P>That's the problem I'm talking about. IOW, a lookup in case-insensitive mode finds first match, not best match.</P>
<P>(On the same box I could just use FILE_FLAG_POSIX_SEMANTICS to access the other file anyway. On a box without the object manager change, and without administrative access to change the setting, I'm SOL.)</P>
<P>Since it sounds like Vista and XP will keep changing $UpCase back and forth in a dual-boot situation, this kind of thing could happen by accident (although it still seems rather unlikely). The correct fix, AFAICT, would be to have chkdsk stop messing with the table. OTOH, if the table got corrupted, chkdsk wouldn't be able to help you. Such are the tradeoffs I guess.</P></div>
<p><a id="6945590" href="#6945590">#</a> <strong>Michael S. Kaplan</strong> on 1 Jan 2008 8:21 PM:</p><div style="margin-left: 1em"><p>Since it was a bug for .NET to ever set those values and in my opinion is a bug that they ever did (something I will blog about at some point), I have to reject the test as invalid, sorry! :-)</p>
<p>Instead, try doing what I did with the jump drive, and delete one of the files after running chkdsk on it (which will update $UpCase). You will see it deleted the correct file, not the first one....</p>
</div>
<p><a id="6946169" href="#6946169">#</a> <strong>Random Reader</strong> on 1 Jan 2008 9:04 PM:</p><div style="margin-left: 1em"><p>Hehe! That KB was just one I had handy that mentions the key. It's the same one changed by the SFU/SUA installer if you choose the appropriate option. KB817921 might be more appropriate. (I'd love to hear the story behind how the .NET bug happened!)</p>
<p>Unfortunately I don't have a Vista machine to run tests on at the moment, so I'll have to come back to this.</p></div>
<p><strong>LarryBrown</strong> on 14 Aug 2009 6:35 AM:</p><div style="margin-left: 1em"><p>It annoys me badly when discussion threads get closed because of age or anyone complains about resurrecting an old thread. I can see the logic in that if it's a personal discussion between two friends and it doesn't make sense to talk about it anymore, but in the case of a programming discussion people should continue to add to the thread for all eternity until the topic naturally passes out of relevance to the world. By adding to the thread we continue to impart more and more knowledge to the topic. </p>
<p>Regarding this discussion of the $UPCASE file on NTFS, the situation is this: Vista's format tool write the $UPCASE file differently than does the XP and earlier tools, I think Vista is writing it incorrectly, actually. So to the poster that asked &quot;Who is changing the $UPCASE file,&quot; there's your answer, the Vista format tool that formatted the disk when Vista was installed. The Vista chkdsk program has been patched so that it takes no action on the problem, that's why running chkdsk in Vista neither reports nor fixes the problem. </p></div>
<p><strong>LarryBrown</strong> on 14 Aug 2009 6:36 AM:</p><div style="margin-left: 1em"><p>The XP CHKDSK program, however, both reports and fixes the problem when run on a disk that contains Vista, another way the $UPCASE file could get changed. Apparently Vista runs equally well against the XP style $UPCASE file or the Vista style file, or maybe you guys were discussing the finer points of that above but I just tuned out because I'm not interested right now. If the file is wrong as I suspect, that Vista CHKDSK has been patched to ignore it is either a sign of negligence (M$ didn't bother to investigate the matter but instead just swept it under the rug by commenting out a check in CHKDSK), or malice (M$ intentionally planted this problem in Vista and then paid hush money to a CHKDSK programmer), or it could be good old plain incompetence of a coordinated nature: FORMAT &amp; CHKDSK both incompetent.</p>
<p>However there is a problem that hasn't been mentioned, and that is that the incorrect Vista style $UPCASE file breaks PowerQuest's (or Symantec's) Partition Magic (PM) program. Since that program is useful that makes this $UPCASE issue a problem for me. PM will issue an error 4444 if it encounters this problem and will refuse to proceed with its work. The solution is to run the XP CHKDSK program on the Vista partition so that it will fix the $UPCASE file and then PM can proceed. I have to wonder if this bug was planted maliciously by Microsoft to kill this excellent program. They've done it plenty of times before.</p>
<p>I hope that no one here will object that the Vista disk management tool has obsoleted Partition Magic. People that say that obviously don't edit many partitions. To put it briefly, a full featured partition management tool offers many many more functions than does the anemic management tool provided by Vista. One quick example is the ability to grow a partition into free space to its left, a very useful function. Partition Magic does that easily in about 2 minutes, Vista can't do that at all.</p></div>
<p><strong>Michael S. Kaplan</strong> on 14 Aug 2009 7:56 AM:</p><div style="margin-left: 1em"><p>One of the other reasons to ask for no more updates is when updates get into untruths, conspiracy theories, and other swill that the blog owner feels are beneath the dignity of the topic.</p>
<p><font color="#ff0000"><b><i>Consider yourself warned, Larry Brown!</i></b></font></p>
<p>The only change that was made was to the situation leading to an error msg claiming corruption in the case of a known change that chkdsk was unaware of. The Vista change was not wrong; neither is the Win7 change.</p>
<p>When one formats USB jump drives in XP and plugs them into Vista or Win7, one gets the warning to update for the same problem; it is not due to the casing table being wrong or hush money or negligence or any other crap like that....</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/01/12 <a href="http://archives.miloush.net/michkap/archive/2008/01/12/7062458.html">Blitzkrieging the landscape.NET (aka in this case, two) (aka When is obcaseinsensitive not ObCaseInsensitive?)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/12/28/6883105.html" title="Getting grouping&#39;s number right...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/12/27/6873622.html" title="Even The O.C. reruns have jumped the shark, for me (and I blame this on SoapNet)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-12-27">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/12/27/6875879.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:36 GMT -->
</html>