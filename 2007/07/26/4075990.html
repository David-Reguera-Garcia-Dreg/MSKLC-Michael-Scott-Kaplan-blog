<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/26/4075990.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>No UTF-8 in a VARCHAR column</title></head><body>
<h1>No UTF-8 in a VARCHAR column</h1>
<p><em>by Michael S. Kaplan, published on 2007/07/27 02:51 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/07/26/4075990.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Francisco Moraes asks in the Suggestion Box:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Mike,<BR><BR>Is it possible on MS SQL Server to have columns defined as CHAR (or VARCHAR) and actually store the data in UTF-8 without corruption due to code page convertions? <BR><BR>I know there is the NCHAR/NVARCHAR type but we'd like to avoid the 2-bytes per character used to store them.<BR><BR>Francisco</EM></FONT></P></BLOCKQUOTE>
<P mce_keep="true">This is actually quite&nbsp;a common request but the answer is not one that will make Francisco happy -- there isn't such a way.</P>
<P mce_keep="true">UTF-16 via the "N" data types is really the only way things will work here.</P>
<P mce_keep="true">I will forward the feedback on to folks on the SQL Server team (or they might just read about the request here since I think some of them are regulars now!), though it is worth pointing some things out:</P>
<P mce_keep="true">First of all, for pure ASCII text, UTF-8 will always be smaller, but for any other text in Unicode it will be the same size or bigger, which really hurts the size argument.</P>
<P mce_keep="true">I discuss this point a bit in <A class="" href="http://archives.miloush.net/michkap/archive/2005/05/20/420317.html" mce_href="http://archives.miloush.net/michkap/archive/2005/05/20/420317.html"><STRONG>You may want to rethink your choice of UTF, #1 (if the size matters)</STRONG></A>, and I gave the distribution:</P>
<LI><FONT face="Courier New"><STRONG>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0000/index.htm">U+0000</A> -&nbsp;&nbsp; <A href="http://www.fileformat.info/info/unicode/char/007f/index.htm">U+007f</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 byte&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (128 code values)</STRONG></FONT> 
<LI><FONT face="Courier New"><STRONG>&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0080/index.htm">U+0080</A> -&nbsp;&nbsp; <A href="http://www.fileformat.info/info/unicode/char/07ff/index.htm">U+07ff</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (1919 code values)</STRONG></FONT> 
<LI><STRONG><FONT face="Courier New">&nbsp;<A href="http://www.fileformat.info/info/unicode/char/0800/index.htm">U+0800</A> -&nbsp;&nbsp; <A href="http://www.fileformat.info/info/unicode/char/ffff/index.htm">U+ffff</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3 bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(63,487 code values)</FONT></STRONG> 
<LI><STRONG><FONT face="Courier New"><A href="http://www.fileformat.info/info/unicode/char/10000/index.htm">U+10000</A> - <A href="http://www.fileformat.info/info/unicode/char/10ffff/index.htm">U+10ffff</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 4 bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (1,048,575 code values)</FONT></STRONG></LI>
<P mce_keep="true">The&nbsp;above&nbsp;is&nbsp;imperfect&nbsp;since&nbsp;it includes unassigned code values and it also includes high/low surrogates in the three byte group when they are not legal there, but you get the point that UTF-8 is not much of a space&nbsp;saver unless you stay in ASCII, and if you do stay in ASCII then any old code page&nbsp;would work....&nbsp;</P>
<P mce_keep="true">Second of all, even if there were a way to make UTF-8 text work, it would not be free since the underlying engine and collation tables use UTF-16 for Unicode, there would be an associated performance hit due to the conversions. Now conversion is optimized as much as it can be, but it is still a non-zero cost.</P>
<P mce_keep="true">And finally, though we do not change code pages, there have really on a regular basis been updates to UTF-8 to conform to the latest Unicode Standard guidelines around conformant UTF-8 conversion, which means that if such a feature existed there would be worries about index corruption if faulty, non-conformant UTF-8 was being stored. This would have to be a real concern, enough to make sure that invalid data was never stored in the database (suggesting a validation pass, which means additional work that would have to happen).</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>！</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/ff01" mce_href="http://www.fileformat.info/info/unicode/char/ff01">U+ff01</A>, a.k.a. FULLWIDTH EXCLAMATION MARK)</EM></FONT></P>
<hr/><p><a id="4076949" href="#4076949">#</a> <strong>Koby Kahane</strong> on 27 Jul 2007 4:16 AM:</p><div style="margin-left: 1em"><p>It is a common scenario to have most of the data in the ASCII range, while only having Unicode occasionally. In such cases, UTF-8 has a significant size advantage over UTF-16.</p>
<p>This is the reason many prefer UTF-8 as the Unicode serialization format. Consider the waste of space if everyone saved their .txt files in UTF-16 - most text is plain ASCII.</p>
<p>UTF-8 is compelling when you only have non-ASCII characters occasionally and you don't want to deal with code pages and the like - that's so 80's :)</p>
</div>
<p><a id="4077213" href="#4077213">#</a> <strong>Michiel</strong> on 27 Jul 2007 4:48 AM:</p><div style="margin-left: 1em"><p>Indeed, UTF-8 is the natural choice for Europe. We've got Latin-1, Latin-2 and the Euro sign €, but 90% of a random text will be &lt; U+0080. For your typical XML, the choice is even more obvious. They always contain a lot of ASCII characters, and often tons of whitespace.</p>
<p>Free tip: Be green and strip useless whitespace from XML. You save on storage, bandwidth and processing. Profile it if you don't believe me, we were suprised.</p></div>
<p><a id="4077299" href="#4077299">#</a> <strong>Dean Harding</strong> on 27 Jul 2007 4:57 AM:</p><div style="margin-left: 1em"><p>&gt; This is the reason many prefer UTF-8 as the Unicode serialization format.</p>
<p>But a database is not usually the place for &quot;serialization&quot; -- a database usually contains *raw* text. When you're talking XML or HTML then, sure, most of that is actual markup and hence pure ASCII. But for raw textual data, you're only going to have &quot;mostly ASCII&quot; when your primary language is English. And if your primary language is English, then you don't need Unicode anyway.</p>
</div>
<p><a id="4078035" href="#4078035">#</a> <strong>Koby Kahane</strong> on 27 Jul 2007 6:00 AM:</p><div style="margin-left: 1em"><p>&gt;&gt; But for raw textual data, you're only going to have &quot;mostly ASCII&quot; when your primary language is English. And if your primary language is English, then you don't need Unicode anyway.</p>
<p>Dean, this is not strictly true.</p>
<p>Consider a directory listing of drive C: on the computer of a Hebrew speaking user. The vast majority of files are system files and the characters in their filenames are expected to be in the ASCII range, while a minority of files (those under My Documents, etc.) would be in Hebrew characters. It is clear that it is compelling to store such a listing in UTF-8 encoding.</p>
<p>This is not an example of something you'd put in a database, but there might be other things that you would that would have the same characteristic - the fact the user's native language is not English does not have to mean most of the data won't be ASCII.</p>
</div>
<p><a id="4078134" href="#4078134">#</a> <strong>Joe</strong> on 27 Jul 2007 6:10 AM:</p><div style="margin-left: 1em"><p>&gt; &nbsp;But for raw textual data, you're only going to have &quot;mostly ASCII&quot; when your primary language is English</p>
<p>No, you will have mostly ASCII for all Western European languages. &nbsp; </p></div>
<p><a id="4079658" href="#4079658">#</a> <strong>Michael S. Kaplan</strong> on 27 Jul 2007 8:05 AM:</p><div style="margin-left: 1em"><p>None of these points addresses the performance and reliability issues that are also important here -- a blind &quot;save some bytes&quot; approach that sacrifices either is not a good long term strategy (this is why the bulk of the device drivers in the OS are Unicode UTF-16 now even if they only ever use ASCII!).</p>
</div>
<p><a id="4079902" href="#4079902">#</a> <strong>Nick Lamb</strong> on 27 Jul 2007 8:25 AM:</p><div style="margin-left: 1em"><p>Dean, the real world just doesn't work like that.</p>
<p>Here's a simple example, a test corpus I'm very familiar with, the US census TIGER data. It's primarily English, in that it's a survey of the (mostly man-made) geography of the US. However since it includes Puerto Rico it is not &quot;pure ASCII&quot; and any attempt to store it in SQL Server as ASCII is hopelessly ill-conceived.</p>
<p>The &quot;regular basis&quot; that Michael's talking about consists of one update brought about by a change in policy from Unicode itself, arbitrarily limiting the range of valid characters forever to those that can be expressed in UTF-16, and an earlier update to prohibit behaviour that had previously been implementation specific and was now considered unacceptable as a result of security considerations. Neither changed the meaning of any existing non-test data, and neither should have required any changes to well written software, for much the same reason that no-one loses sleep about the &quot;Hangul mess&quot;. Whether SQL Server is in fact &quot;well written&quot; is an exercise for the reader.</p>
<p>Microsoft's own UTF-8 implementations have changed a lot more than the description above would imply, not because the standard is unclear or incomplete, but just because their original attempts diverged so much from the actual standard. Until relatively recently Internet Explorer would fail trivial UTF-8 test suites because whoever implemented the decoding not only failed to pay attention to the section labelled &quot;Security Considerations&quot; but apparently didn't even read the original napkin sketch algorithm for decoding UTF-8. Did this really have security implications for IE users? Probably, but finding serious security bugs in a web browser is like shooting fish in a barrel, the more serious issue is that this implementation never obeyed the standard, and no-one cared enough to even test it.</p>
<p>So in a way maybe the lack of UTF-8 in SQL Server is a blessing in disguise, if they did implement it, would you trust them to have got it right ?</p></div>
<p><a id="9931153" href="#9931153">#</a> <strong>Anthony</strong> on 1 Dec 2009 3:39 PM:</p><div style="margin-left: 1em"><p>Should only support UTF-8. &nbsp;Direct mapping to UTF-16. &nbsp; Always more efficient, except for some obscure Indian languages. &nbsp;</p>
<p>Cost of storing and retrieving nulls dwafs cost of conversion. &nbsp;In any case, to be correct conversion needs to be done to UTF-32, not UTF-16 -- there are much more than 64K characters. &nbsp;UTF-16 should die. &nbsp;Varchar with code pages should definitely die.</p>
<p>Postgresql gets this right.</p>
<p>I just use varchar for performance, and loose I18N.</p></div>
<p><a id="9931568" href="#9931568">#</a> <strong>Michael S. Kaplan</strong> on 2 Dec 2009 11:27 AM:</p><div style="margin-left: 1em"><p>Back on planet earth, backcompat breaks of the scale this would cause are unprecedented and in light of the SQL Server team's feelings on this matter highly improbable.</p>
<p>Also, 3-byte characters in UTF-8 is a lot more than just &quot;obscure Indian languages&quot;, so you must not be doing very much language stuff....</p>
<p>On an OS that uses UTF-16 LE for everything, the most efficient is NEVER going to be UTF-8.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/07/27/4075592.html" title="Boot Camp 1.3 and MSKLC (also 1.3) -- excitement, enjoyment, and a wrinkle or three">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/07/26/4057259.html" title="Report of blank previews of unknown etiology">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/26/4075990.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>