<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/22/3998892.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>In a much better position to handle inserts</title></head><body>
<h1>In a much better position to handle inserts</h1>
<p><em>by Michael S. Kaplan, published on 2007/07/22 09:51 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/07/22/3998892.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>One of the common complaints that&nbsp;localizers have when it comes to localizability of software projects comes into play when developers have strings with inserts that they run through the C runtime.</P>
<P><EM>(I'll assume that Unicode is being used but that is often a bad assumption; a topic for another day, I'm sure!)</EM></P>
<P>Whether it is <A class="" href="http://msdn2.microsoft.com/library/wc7014hz.aspx" mce_href="http://msdn2.microsoft.com/library/wc7014hz.aspx">wprintf</A>, <A class="" href="http://msdn2.microsoft.com/library/ybk95axf.aspx" mce_href="http://msdn2.microsoft.com/library/ybk95axf.aspx">swprintf</A>, <A class="" href="http://msdn2.microsoft.com/library/7ax4dbdt.aspx" mce_href="http://msdn2.microsoft.com/library/7ax4dbdt.aspx">_cwprintf</A>, <A class="" href="http://msdn2.microsoft.com/library/xkh07fe2.aspx" mce_href="http://msdn2.microsoft.com/library/xkh07fe2.aspx">fwprintf</A>, <A class="" href="http://msdn2.microsoft.com/library/fzs40tkz.aspx" mce_href="http://msdn2.microsoft.com/library/fzs40tkz.aspx">vwprintf</A>, <A class="" href="http://msdn2.microsoft.com/library/we9107a3.aspx" mce_href="http://msdn2.microsoft.com/library/we9107a3.aspx">vfwprintf</A>, or <A class="" href="http://msdn2.microsoft.com/library/28d5ce15.aspx" mce_href="http://msdn2.microsoft.com/library/28d5ce15.aspx">vswprintf</A>, the problem is the same.</P>
<P>If you have a string with more than one "fill in at runtime"&nbsp;insert in it, and that string has to be localized, then there is almost certainly going to be at least one language (and usually several) where the word order of the target language is different enough that there is no way to produce the properly localized string without sounding like one is retarded or does not know the language.</P>
<P>I had&nbsp;a localizer&nbsp;complaining to me about this just the other day, in fact.</P>
<P>But luckily I got to point out to that localizer that there was a fix for this limitation available as of the VS 2005 version of the C Runtime -- positional insert parameters!</P>
<P>Thus for the above functions there are now <STRONG>_p</STRONG>&nbsp;versions and we now have <A class="" href="http://msdn2.microsoft.com/library/s3a5ky4x.aspx" mce_href="http://msdn2.microsoft.com/library/s3a5ky4x.aspx">_wprintf_p</A>, <A class="" href="http://msdn2.microsoft.com/library/02y7cdtk.aspx" mce_href="http://msdn2.microsoft.com/library/02y7cdtk.aspx">_swprintf_p</A>, <A class="" href="http://msdn2.microsoft.com/library/hy4t91t7.aspx" mce_href="http://msdn2.microsoft.com/library/hy4t91t7.aspx">_cwprintf_p</A>, <A class="" href="http://msdn2.microsoft.com/library/35tfd78h.aspx" mce_href="http://msdn2.microsoft.com/library/35tfd78h.aspx">_fwprintf_p</A>, <A class="" href="http://msdn2.microsoft.com/library/h72hc3e0.aspx" mce_href="http://msdn2.microsoft.com/library/h72hc3e0.aspx">_vwprintf_p</A>, <A class="" href="http://msdn2.microsoft.com/library/38hz5f36.aspx" mce_href="http://msdn2.microsoft.com/library/38hz5f36.aspx">_vfwprintf_p</A>,&nbsp;and <A class="" href="http://msdn2.microsoft.com/library/c8c2ax31.aspx" mce_href="http://msdn2.microsoft.com/library/c8c2ax31.aspx">_vswprintf_p</A>. And each one uses the <A class="" href="http://msdn2.microsoft.com/library/bt7tawza.aspx" mce_href="http://msdn2.microsoft.com/library/bt7tawza.aspx">positional input parameter syntax</A> but is otherwise identical to the non-_p call.</P>
<P>Which means that most of the developers work replacing one set of functions with the other set requires minimal thought, and since the old functions had an express input parameter ordering, it is a trivial (and entirely automatable!) operation to update the format strings.</P>
<P>As a fun bonus, you are allowed to re-use parameters by just repeating their insert numbers&nbsp;(previously you'd have to pass the same parameter more than once), which is also quite trivial and automatable. This last part is entirely optional but is kind of a cool extra feature that one gets for free when you are allowed to specify the order of parameters....</P>
<P>I wanted to quickly show a bit of the <A class="" href="http://msdn2.microsoft.com/library/bt7tawza.aspx" mce_href="http://msdn2.microsoft.com/library/bt7tawza.aspx">positional input parameter syntax</A>&nbsp;so you could see what I mean about the easy part.</P>
<BLOCKQUOTE>
<P><EM>By default the positional functions behave identically to the non position ones, if no positional formatting is present. Positional parameters are specified using the format "<SPAN class=parameter>%m$x</SPAN>", where <SPAN class=parameter>m</SPAN> denotes a numeric ordinal number indicating the position of the parameter in the list of parameters, preceding the format string and<SPAN class=parameter> x</SPAN> denotes the type field character type specified in the <B>printf</B> function. The parameters in the list are indexed starting at the value 1 for the first element in the list and so forth. For additional information concerning type field characters, see <SPAN class=linkTerms><A onclick="javascript:Track('ctl00_LibFrame_ctl21|ctl00_LibFrame_ctl22',this);" href="http://msdn2.microsoft.com/en-us/library/hf4y5e3w(VS.80).aspx">printf Type Field Characters</A></SPAN>.</EM></P></BLOCKQUOTE>
<P>The one surprise for me was the 1-based indexes,&nbsp;but that is akin to the Win32 <A class="" href="http://msdn2.microsoft.com/library/ms679351.aspx" mce_href="http://msdn2.microsoft.com/library/ms679351.aspx">FormatMessage</A> function (previously the only way to do this sort of thing). The syntax of the inserts is also slightly different than <A class="" href="http://msdn2.microsoft.com/library/ms679351.aspx" mce_href="http://msdn2.microsoft.com/library/ms679351.aspx">FormatMessage</A> but I think I can live with that since so much effort&nbsp;to stay compatible with the existing functions was going on. :-)</P>
<P>So, let's shout it from the roof tops so all of the developers using the CRT can hear -- they can now be in the position to have localizable string inserts!</P>
<P>Now the next step might be to suggest this change to the C standard folks so that this code can be more portable (which is always important), but for now I'll just be very happy with the fix to this long-standing limitation in Microsoft's CRT....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>p</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0070" mce_href="http://www.fileformat.info/info/unicode/char/0070">U+0070</A>, a.k.a. LATIN SMALL LETTER P)</EM></FONT></P>
<hr/><p><a id="4000233" href="#4000233">#</a> <strong>Centaur</strong> on 22 Jul 2007 1:13 PM:</p><div style="margin-left: 1em"><p>In any language where verbs or adjectives are inflected for gender, number and/or tense, the translated phrase will sound or seem retarded.</p>
<p>Example: English has two grammatical numbers, singular and plural. The first, quick-and-dirty prototype version sidesteps this by displaying “42 file(s)”. Then, as the core functionality is complete, the well-intentioned but grossly misguided developer says, “This ‘(s)’ is retarded. No reason I wouldn’t be able to distinguish singular from plural.”</p>
<p>He then writes some code, finds out that singular does not mean exactly one but also any number 10*k+1 except for 100*m+11, for all non-negative integer k and m; then, that not all plurals go with just -s but some go with -es and a few rare ones have completely unrelated words for plural (sock/soxen, mouse/meeces, comma/commata, mongoose/polygoose etc.); and then that zero is a special case that looks better as “No files found” rather than “0 files found”.</p>
<p>All that should alert the more seasoned developer that he is missing something, but “well, it’s no rocker science”, right?</p>
<p>Then someone proposes to translate the UI into Japanese. Japanese has one grammatical number. “This two localizable string, what for is?”* — “You see, English has two forms, one used when referring to a single object, another when talking of multiple objects.” — “Ah, understood. Same text let’s put.”* Problem solved — but in a way that introduces a duplication which should also alert one that something is wrong.</p>
<p>Afterwards, a Russian localization is started. Russian pretends to have two grammatical numbers, singular and plural, but actually also has dual, which is used for 10*k+{2, 3, 4} except for 100*m+{12, 13, 14}. Now, if the localizer is a native speaker, he/she asks, “And why only two strings for numbers, and not three? How we will express 2, 3 and 4?”* Problem solved, by adding more linguistic knowledge into the code.</p>
<p>Or, if the localizer is lazy and ignorant, users get the plural where the dual should be, as in “42 fajlov” instead of “42 fajla”. Or if the localizer is not so ignorant, we get “42 fajla(ov). Problem solved, by reintroducing the original problem. Same balls, flank view.</p>
<p>Further complications arise when the correct phrasing is gender-specific and no gender knowledge is available in the application context. Let’s take for example the attribution line in an email reply template:</p>
<p>&gt; On (date/time), John Smith** wrote:</p>
<p>&gt; On (date/time), Jane Johnson** wrote:</p>
<p>English has no gender inflection for verbs. No problem, let’s hardcode the template, just leave three inserts for the date, two for the time and one for AM/PM, and maybe one for the day of the week, and two for their first and last name.</p>
<p>Japanese has no gender inflection at all. No problem. Right?</p>
<p>Bzzzt! Wrong on two accounts. First, Japanese use the logical order for date components, YYYY-MM-DD, as opposed to the American MM/DD/YYYY and European DD.MM.YYYY. Second, they write the last name first, again putting the primary sort key before the secondary one. So, let’s switch to positional inserts.</p>
<p>Now here go the real problems. Russian has gender for verbs (but only in the past tense) and adjectives and most everything else. So, “(date/time) Ivan Kuznetsov** pisal”, but “(date/time) Marija Petrova** pisala”. Now we have to add a gender field to our address book, and face the problem of what gender to use when the person being quoted is not in it. Also, the months, when written as part of the date, are in the genitive case. Luckily, Windows has a special flag that allows us to get month names in genitive. And, while we are at it, in formal speech, it is customary to address those above you by name and patronymic, and refer to them by name, patronymic and surname. Good luck explaining to your American- or European-centered client what the hell patronymic is, when and where to use it. (Japanese have it easy: In mail, address everyone as -sama, even if personally you are on “you bastard” terms.)</p>
<p>All in all, localization of strings that are outside the scope of menus and dialog controls is a problem which requires more linguistic knowledge to be added to the code, wants more input from the user (is someone by the nick of Angel whom you’ve never met a male or a female (if any)?), looks retarded (“Alexander Sidorov** pisal(a)”), or any non-empty combination of the above.</p>
<p>___</p>
<p>* Localizers’ phrases are intentionally distorted to mimic the grammar of their respective languages.</p>
<p>** Names are chosen to look like typical names in their respective cultures, but are otherwise fictional. No relation to any people, living or dead, is intended.</p>
</div>
<p><a id="4000400" href="#4000400">#</a> <strong>Adam</strong> on 22 Jul 2007 1:45 PM:</p><div style="margin-left: 1em"><p>Why introduce printf_p()? Why not just make printf() work with positional parameters?</p></div>
<p><a id="4000621" href="#4000621">#</a> <strong>Kemp</strong> on 22 Jul 2007 2:28 PM:</p><div style="margin-left: 1em"><p>&quot;He then writes some code, finds out that singular does not mean exactly one but also any number 10*k+1&quot;</p>
<p>The definition of a singular requires it to mean 1 =P In your example 21 would take the singular, and &quot;21 file&quot; sounds, as was mentioned, retarded.</p></div>
<p><a id="4001328" href="#4001328">#</a> <strong>Michael S. Kaplan</strong> on 22 Jul 2007 3:34 PM:</p><div style="margin-left: 1em"><p>Plenty of other examples exist, like &quot;File XXXXX was copied to directory YYYYY&quot; and so forth....</p>
<p>Adam, the reason is that printf is in the standard with specific defined behavior....</p>
</div>
<p><a id="4001437" href="#4001437">#</a> <strong>G&#252;nther</strong> on 22 Jul 2007 3:51 PM:</p><div style="margin-left: 1em"><p>&gt; Now the next step might be to suggest this change to the C standard folks so that this code can be more portable</p>
<p>The Single UNIX &#174; Specification apparently uses the same format. I guess the people implementing this for VS knew that, so there is a very good chance that there are no subtle differences. UNIX uses this format in plain old printf, but that is easily mitigated by a #define.</p>
<p><a rel="nofollow" target="_new" href="http://opengroup.org/onlinepubs/007908799/xsh/fprintf.html">http://opengroup.org/onlinepubs/007908799/xsh/fprintf.html</a></p></div>
<p><a id="4011219" href="#4011219">#</a> <strong>Centaur</strong> on 23 Jul 2007 11:53 AM:</p><div style="margin-left: 1em"><p>@Kemp</p>
<p>Okay, so in English singular is only used for exactly 1. This demonstrates my point even better.</p>
<p>First, you hardcode &quot;wcout &lt;&lt; n &lt;&lt; (n == 1 ? singular : plural)&quot; into your numbered-objects-output function.</p>
<p>Then, when it’s time to localize for Russia, your language experts say that, despite all the common sense, in Russian all of {21, 31, …, 91, 101, 121, … } go with singular. Do you rewrite the function to &quot;wcout &lt;&lt; n &lt;&lt; (n == 1 || language == LANG_RUSSIAN &amp;&amp; n % 10 == 1 &amp;&amp; n % 100 != 11) ? singular : plural&quot;?</p>
<p>Then there is this strange dual number that goes with numbers ending in 2, 3 or 4. Except for any numbers in ranges 100*k+11 through 100*k+14, which are always plural no matter what. What do you do? Do you rewrite the function to read &quot;wcout &lt;&lt; n &lt;&lt; (n % 100 between 11 and 14 ? plural : n % 10 == 1 ? singular : n % 10 in (2, 3, 4) ? dual : plural)&quot;, adding a new parameter to the function? What if later you have another language that also has trial number (used for quantities of exactly 3 or maybe b*k+3, where b is the number base primarily used in that language)?</p>
<p>I hereby posit that, in order to allow for non-retarded localization, the localization module must include an interpreter of a scripting language such as ECMAScript or Common LISP, that would be constrained enough that malicious localizers couldn’t take over your computer, but expressive enough to implement the declination rules for any given language. This way, all the language-specific knowledge can be isolated in the localization add-on for that language.</p>
</div>
<p><a id="4011291" href="#4011291">#</a> <strong>Michael S. Kaplan</strong> on 23 Jul 2007 11:58 AM:</p><div style="margin-left: 1em"><P>Hmmmm... methinks Centaur needs to cut down on the coffee. :-)</P>
<P>The principle of inserts in strings is not dependent on pluralization, in any way whatsoever -- and word order of inserts is a very real issue in localization that I really hate to see trivialized, so....</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/05/22 <a href="http://archives.miloush.net/michkap/archive/2008/05/22/8521124.html">It's a known fact (disputed but not disproven) that Clippy's removal from Office was due to Earl knocking up Scribble</a></p><p>2007/07/24 <a href="http://archives.miloush.net/michkap/archive/2007/07/24/4022881.html">Pluralization(s) can be singularly difficult</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/07/22/3999147.html" title="Clarification on the official Uniscribe redist story still pending, but...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/07/21/3995389.html" title="She typed in &#39;God damn clippy&#39;">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/22/3998892.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>