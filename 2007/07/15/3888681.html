<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/15/3888681.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Neutral? I do not think that word means what you think it means!</title></head><body>
<h1>Neutral? I do not think that word means what you think it means!</h1>
<p><em>by Michael S. Kaplan, published on 2007/07/15 22:36 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/07/15/3888681.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>It can be hard to act in a neutral manner.</P>
<P>As an example, you may recall how I talked about neutral locales and how they are automatically converted into full locales by NLS functions in Windows in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2004/12/29/343557.html" mce_href="http://archives.miloush.net/michkap/archive/2004/12/29/343557.html">this post</A></STRONG>. Using the same logic, if you pass LOCALE_NEUTRAL (which is to say, <STRONG>0</STRONG>), it will handily be converted to 0x0400, which is to say, LOCALE_USER_DEFAULT.</P>
<P>In other words, no chance of 100% neutrality in NLS.</P>
<P>But it does not end there.</P>
<P>In the world of the resources, you can tag resources with a 0 to indicate that they are LANG_NEUTRAL or LOCALE_NEUTRAL. In fact, someone was just asking me the other day about how these neutral resources are used:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">I am trying to build an application which has a .rc which will contain both English[US] dialogs/menus etc and also a similar set of copies of neutral resources. In my English[US] OS and locale, I expect loading of English resources, whereas, i find neutral resources being loaded.<BR><BR>I found from the link below that, when user locale and thread locale are same, the system resource loader will use language ID 0<BR><BR></FONT></EM><A href="http://www.microsoft.com/globaldev/handson/dev/muiapp.mspx"><EM><FONT face="times new roman,times">http://www.microsoft.com/globaldev/handson/dev/muiapp.mspx</FONT></EM></A><BR><BR><EM><FONT face="times new roman,times">Though such a requirement of using English as well as Neutral resources is weird, I am looking for some solutions/suggestions/learnings to the problem without removal of either resource (not even to dlls). Also I am using Visual Studio 2003 - VC++</FONT></EM></P></BLOCKQUOTE>
<P mce_keep="true">The text of that topic is indeed quite confusing. Here is the part that may make your head explode if you read it too many times:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P mce_keep="true"><EM>To access the resources at run time, the resource DLL is loaded through the LoadLibrary API. EnumResourceLanguages can then be used to find the list of available languages for a given control/resource, and FindResourceEx to determine the location of the resource with the specified type, name, and language. Displaying a given language is then just a matter of selecting the right resources within the DLL. Language switching can be implemented by re-loading the newly selected resources and refreshing the client area. <BR><BR>It’s important to note that the Windows resource loader always defaults to the current user locale (the thread locale gets inherited from the currently logged in user's user locale - see Figure 1). GetThreadLocale allows querying of thread locale. In this method, predefined resource loading APIs (LoadIcon, LoadString, LoadCursor…) always return resources associated with this locale. For example, in the resource sample above, the French resources cannot be loaded by using LoadString if the system locale is set to English (0x0409). Actually this is not entirely true: a thread locale, once inherited – upon thread creation – is independent from the user locale, which means in this case the thread locale can be changed to French (0x040C) by using SetThreadLocale and calling LoadString to get the French string back. <BR></EM><BR><FONT face="courier new,courier"><STRONG>// if our thread locale is English to start with…<BR>g_hInst = LoadLibrary(_TEXT(“intl_res.dll”));<BR>LoadString(g_hInst, IDS_ENUMSTRTEST,g_szTemp, MAX_STR);<BR>// g_szTemp would then point to the English resources<BR>// changing our thread locale to French. X<BR>// Always make sure that French is in fact one of the<BR>// valid languages returned by EnumResourceLanguages() <BR>// Save a copy of the current thread-locale to set back later <BR>Lcid = GetThreadLocale();<BR>SetThreadLocale(MAKELCID(0x040c, SORT_DEFAULT));<BR>LoadString(g_hInst, IDS_ENUMSTRTEST, g_szTemp, MAX_STR);<BR>// g_szTemp would then point to the French resources</STRONG></FONT><BR><BR><EM>The catch here is that if the thread locale is the same as the currently selected user locale, system’s resource loader will by default use the language ID 0 (neutral). If the desired resource is defined as a neutral language, then this value will be returned. Otherwise, all of the language resources will be enumerated (in language ID order) and the first matching resource ID – regardless of its language – will be returned. <BR><BR>To clarify, consider an example (using our English – US and French – France resources) in which the user locale is set to Japanese, then: our original thread locale is Japanese (0x0411). The first call to LoadString will return English resources since 0x0411 version if our string ID cannot be found and English (0x0409) is enumerated before French (0x40C). Now, if the user locale to start with is French: our original thread locale is French (0x040C). Since the user locale and thread locale match, the system resource loader will use language ID 0 and will start enumerating resources and will once again return the English version! <BR><BR>The best way around this is to give up changing the thread locale in the first place. Resources can be manually loaded from within multilingual resource files by making calls to FindResourceEx . Another workaround is to define the resources within an owner-defined language tag. In the RC example above, the English section was defined as: <BR></EM><BR><STRONG><FONT face="courier new,courier">LANGUAGE LANG_ENGLISH, SUBLANG_ENGLISH_US</FONT></STRONG><BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR><EM>This prevents the thread locale from being switched back to English US. However, defining the resources as:<BR></EM><BR><FONT face="courier new,courier"><STRONG>LANGUAGE LANG_ENGLISH, SUBLANG_NEUTRAL</STRONG></FONT><BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR><EM>will guarantee the success of the SetThreadLocale call since there is no matching user locale for this language ID and the predefined resource loader APIs can still be used. </EM></P></BLOCKQUOTE></BLOCKQUOTE>
<P mce_keep="true">Again, your head may explode trying to parse what this text is saying. </P>
<P mce_keep="true">Thankfully, however, the text is slightly&nbsp;incorrect&nbsp;in its assumption, or at least misleading in its language.</P>
<P mce_keep="true">You see,&nbsp;the&nbsp;actual behavior&nbsp;boils down to the difference between <A class="" href="http://msdn2.microsoft.com/library/ms648042.aspx" mce_href="http://msdn2.microsoft.com/library/ms648042.aspx">FindResource</A> and <A class="" href="http://msdn2.microsoft.com/library/ms648043.aspx" mce_href="http://msdn2.microsoft.com/library/ms648043.aspx">FindResourceEx</A>.</P>
<P mce_keep="true">Ignoring my Ex claims <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/10/31/486870.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/31/486870.html">here</A></STRONG>,&nbsp;the only difference between the two is that the former calls the latter with a wLanguage value of 0.</P>
<P mce_keep="true">But the meaning of a <A class="" href="http://msdn2.microsoft.com/library/ms648042.aspx" mce_href="http://msdn2.microsoft.com/library/ms648042.aspx">FindResource</A>&nbsp;call (or the essentially identical <A class="" href="http://msdn2.microsoft.com/library/ms648043.aspx" mce_href="http://msdn2.microsoft.com/library/ms648043.aspx">FindResourceEx</A>&nbsp;call with a wLanguage of 0) is, when the docs refer to the thread language, is not in any way at all guaranteed to be either the return of the dreaded <A class="" href="http://msdn2.microsoft.com/library/ms776331.aspx" mce_href="http://msdn2.microsoft.com/library/ms776331.aspx">GetThreadLocale</A> or what that quoted resource page calls "language ID 0 (neutral)". That 0 to the world of MUI and the UI language means the default user UI language!</P>
<P mce_keep="true">The behavioral interaction between thread locale and user locale can be made much clearer than above, with two simple statements:</P>
<UL>
<LI>
<DIV mce_keep="true">If they are the same, then&nbsp;start with&nbsp;the UI language;</DIV></LI>
<LI>
<DIV mce_keep="true">If they are not the same, then start with the thread locale.</DIV></LI></UL>
<P mce_keep="true">And hopefully no head explosions. :-)</P>
<P mce_keep="true">This behavior almost kind of makes sense in terms of keeping the balance between the old and new behaviors, and really only breaks the case where you wanted to use <A class="" href="http://msdn2.microsoft.com/library/ms776285.aspx" mce_href="http://msdn2.microsoft.com/library/ms776285.aspx">SetThreadLocale</A> to change the UI language to be one that matches the user locale....</P>
<P mce_keep="true">And how else could MUI have been bolted on to the existing <A class="" href="http://msdn2.microsoft.com/library/ms648042.aspx" mce_href="http://msdn2.microsoft.com/library/ms648042.aspx">FindResource</A> and <A class="" href="http://msdn2.microsoft.com/library/ms648043.aspx" mce_href="http://msdn2.microsoft.com/library/ms648043.aspx">FindResourceEx</A>&nbsp;with minimal code change way back in Windows 2000?</P>
<P mce_keep="true"><EM>(Please pretend that is rhetorical; given the benefits of hindsight I can actually think of several designs that would probably have been better here; but this is the model we have!)</EM></P>
<P mce_keep="true">So where do the resources that are actually marked with LANG_NEUTRAL&nbsp;fit in?</P>
<P mce_keep="true">Well, if the resource loader has its way, then they will show up somewhere on the list prior to simply giving up. But they cannot ever be directly loaded and will never be the first choice for what the resource loader tries to use, even when you ask for it (since the resource loader gives 0&nbsp;this special meaning)....</P>
<P mce_keep="true">So once again, we find that neutral has a different meaning that is not actually neutral!</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>⚲</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/26b2" mce_href="http://www.fileformat.info/info/unicode/char/26b2">U+26b2</A>, a.k.a. NEUTER)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/03/16 <a href="http://archives.miloush.net/michkap/archive/2011/03/16/10141835.html">Reporting one casualty in the operation; luckily it was the stupidest member of the unit</a></p><p>2008/11/12 <a href="http://archives.miloush.net/michkap/archive/2008/11/12/9061211.html">You can either be intuitive and completely inconsistent, or consistent and completely unintuitive!</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/07/15/3890144.html" title="Arial Unicode MS effectively [bites|sucks|blows]">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/07/14/3873217.html" title="Code pages don&#39;t overlap all that much">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/15/3888681.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>