<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/25/4037646.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>What's up with MB_ERR_INVALID_CHARS?</title></head><body>
<h1>What's up with MB_ERR_INVALID_CHARS?</h1>
<p><em>by Michael S. Kaplan, published on 2007/07/25 03:11 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/07/25/4037646.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>It seems like it was just yesterday that I posted about how <A class="" href="http://archives.miloush.net/michkap/archive/2007/07/24/4031609.html" mce_href="http://archives.miloush.net/michkap/archive/2007/07/24/4031609.html"><STRONG>TAV is in the public use area</STRONG></A>. </P>
<P>Admittedly the reason is that it <STRONG>was</STRONG> only yesterday.... :-)</P>
<P>Now there is one issue that has never been discussed and which frankly has never been described well&nbsp;in the docs anywhere -- the way that these unmapped characters in the code pages are being mapped to the Private Use Area (for the sake of EUDC if you want to believe the comments!), or elsewhere.</P>
<P>Now I have talked about MB_ERR_INVALID_CHARS before, like in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html">A few of the gotchas of MultiByteToWideChar</A></STRONG>&nbsp;and <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/01/08/349230.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/08/349230.html">How does it detect invalid characters?</A></STRONG>, and believe you me I will be rethinking that flag's usefulness a bit from here on!</P>
<P>Anyway....</P>
<P>Here are the "strange" characters in each code page, both the weirdly mapped and the ones mapped to the PUA, all of which are documented in the <A class="" href="http://www.microsoft.com/globaldev/reference/WinCP.mspx" mce_href="http://www.microsoft.com/globaldev/reference/WinCP.mspx">original tables</A> as having no mapping:</P>
<BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/874.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/874.mspx">Code page 874</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit874.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit874.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081 <BR>0x82 0x0082 <BR>0x83 0x0083 <BR>0x84 0x0084 <BR>0x86 0x0086 <BR>0x87 0x0087 <BR>0x88 0x0088 <BR>0x89 0x0089 <BR>0x8a 0x008a <BR>0x8b 0x008b <BR>0x8c 0x008c <BR>0x8d 0x008d <BR>0x8e 0x008e <BR>0x8f 0x008f <BR>0x90 0x0090 <BR>0x98 0x0098 <BR>0x99 0x0099 <BR>0x9a 0x009a <BR>0x9b 0x009b <BR>0x9c 0x009c <BR>0x9d 0x009d <BR>0x9e 0x009e <BR>0x9f 0x009f <BR><STRONG><FONT color=#009900>0xdb 0xf8c1 ;Undefined -&gt; EUDC<BR>0xdc 0xf8c2 ;Undefined -&gt; EUDC<BR>0xdd 0xf8c3 ;Undefined -&gt; EUDC<BR>0xde 0xf8c4 ;Undefined -&gt; EUDC<BR>0xfc 0xf8c5 ;Undefined -&gt; EUDC<BR>0xfd 0xf8c6 ;Undefined -&gt; EUDC<BR>0xfe 0xf8c7 ;Undefined -&gt; EUDC<BR>0xff 0xf8c8 ;Undefined -&gt; EUDC</FONT></STRONG></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/dbcs/932.mspx" mce_href="http://www.microsoft.com/globaldev/reference/dbcs/932.mspx">Code page 932</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit932.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit932.txt">best fit table</A>) -- SBCS only:</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x80 0x0080&nbsp; ;Control<BR><FONT color=#009900><STRONG>0xa0 0xf8f0 ;Undefined -&gt; EUDC<BR>0xfd 0xf8f1 ;Undefined -&gt; EUDC<BR>0xfe 0xf8f2 ;Undefined -&gt; EUDC<BR>0xff 0xf8f3 ;Undefined -&gt; EUDC</STRONG></FONT></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/dbcs/936.mspx" mce_href="http://www.microsoft.com/globaldev/reference/dbcs/936.mspx">Code page 936</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit936.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit936.txt">best fit table</A>) -- SBCS only:</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier" color=#009900><STRONG>0xff 0xf8f3 ;?</STRONG></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/dbcs/949.mspx" mce_href="http://www.microsoft.com/globaldev/reference/dbcs/949.mspx">Code page 949</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit949.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit949.txt">best fit table</A>) -- SBCS only:</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x80&nbsp;0x0080&nbsp;;Undefined -&gt; Control<BR><FONT color=#009900><STRONG>0xff&nbsp;0xf8f7&nbsp;;Undefined -&gt; EUDC</STRONG></FONT></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/dbcs/950.mspx" mce_href="http://www.microsoft.com/globaldev/reference/dbcs/950.mspx">Code page 950</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit950.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit950.txt">best fit table</A>) -- SBCS only:</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x80&nbsp;0x0080&nbsp;;Undefined -&gt; Control<BR><STRONG><FONT color=#009900>0xff&nbsp;0xf8f8&nbsp;;Undefined -&gt; EUDC</FONT></STRONG></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1250.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1250.mspx">Code page 1250</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1250.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1250.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081<BR>0x83 0x0083<BR>0x88 0x0088<BR>0x90 0x0090<BR>0x98 0x0098</FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1251.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1251.mspx">Code page 1251</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1251.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1251.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x98 0x0098</FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1252.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1252.mspx">Code page 1252</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1252.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1252.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081<BR>0x8d 0x008d<BR>0x8f 0x008f<BR>0x90 0x0090<BR>0x9d 0x009d</FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1253.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1253.mspx">Code page 1253</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1253.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1253.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081<BR>0x88 0x0088<BR>0x8a 0x008a<BR>0x8c 0x008c<BR>0x8d 0x008d<BR>0x8e 0x008e<BR>0x8f 0x008f<BR>0x90 0x0090<BR>0x98 0x0098<BR>0x9a 0x009a<BR>0x9c 0x009c<BR>0x9d 0x009d<BR>0x9e 0x009e<BR>0x9f 0x009f<BR><STRONG><FONT color=#009900>0xaa 0xf8f9 ;Undefined -&gt; EUDC<BR>0xd2 0xf8fa ;Undefined -&gt; EUDC<BR>0xff 0xf8fb ;Undefined -&gt; EUDC</FONT></STRONG></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1254.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1254.mspx">Code page 1254</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1254.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1254.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081<BR>0x8d 0x008d<BR>0x8e 0x008e<BR>0x8f 0x008f<BR>0x90 0x0090<BR>0x9d 0x009d<BR>0x9e 0x009e</FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1255.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1255.mspx">Code page 1255</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1255.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1255.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081 ;Undefined -&gt; Control<BR>0x8a 0x008a ;Undefined -&gt; Control<BR>0x8c 0x008c ;Undefined -&gt; Control<BR>0x8d 0x008d ;Undefined -&gt; Control<BR>0x8e 0x008e ;Undefined -&gt; Control<BR>0x8f 0x008f ;Undefined -&gt; Control<BR>0x90 0x0090 ;Undefined -&gt; Control<BR>0x9a 0x009a ;Undefined -&gt; Control<BR>0x9c 0x009c ;Undefined -&gt; Control<BR>0x9d 0x009d ;Undefined -&gt; Control<BR>0x9e 0x009e ;Undefined -&gt; Control<BR>0x9f 0x009f ;Undefined -&gt; Control<BR><STRONG><FONT color=#009900>0xd9 0xf88d ;Undefined -&gt; EUDC<BR>0xda 0xf88e ;Undefined -&gt; EUDC<BR>0xdb 0xf88f ;Undefined -&gt; EUDC<BR>0xdc 0xf890 ;Undefined -&gt; EUDC<BR>0xdd 0xf891 ;Undefined -&gt; EUDC<BR>0xde 0xf892 ;Undefined -&gt; EUDC<BR>0xdf 0xf893 ;Undefined -&gt; EUDC<BR>0xfb 0xf894 ;Undefined -&gt; EUDC<BR>0xfc 0xf895 ;Undefined -&gt; EUDC<BR>0xff 0xf896 ;Undefined -&gt; EUDC</FONT></STRONG></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1256.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1256.mspx">Code page 1256</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1256.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1256.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">None (I talked about this previously <STRONG>here</STRONG>.)</FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1257.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1257.mspx">Code page 1257</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1257.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1257.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081<BR>0x88 0x0088<BR>0x8a 0x008a<BR>0x8c 0x008c<BR>0x90 0x0090<BR>0x98 0x0098 ;Not Used<BR>0x9a 0x009a<BR>0x9c 0x009c<BR>0x9f 0x009f<BR><FONT color=#009900><STRONG>0xa1 0xf8fc ;Undefined -&gt; EUDC<BR>0xa5 0xf8fd ;Undefined -&gt; EUDC</STRONG></FONT></FONT></P></BLOCKQUOTE>
<P><A class="" href="http://www.microsoft.com/globaldev/reference/sbcs/1258.mspx" mce_href="http://www.microsoft.com/globaldev/reference/sbcs/1258.mspx">Code page 1258</A> (<A class="" href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1258.txt" mce_href="http://www.unicode.org/Public/MAPPINGS/VENDORS/MICSFT/WindowsBestFit/bestfit1258.txt">best fit table</A>):</P>
<BLOCKQUOTE>
<P><FONT face="courier new,courier">0x81 0x0081 ;Undefined -&gt; Control<BR>0x8a 0x008a ;Undefined -&gt; Control<BR>0x8d 0x008d ;Undefined -&gt; Control<BR>0x8e 0x008e ;Undefined -&gt; Control<BR>0x8f 0x008f ;Undefined -&gt; Control<BR>0x90 0x0090 ;Undefined -&gt; Control<BR>0x9a 0x009a ;Undefined -&gt; Control<BR>0x9d 0x009d ;Undefined -&gt; Control<BR>0x9e 0x009e ;Undefined -&gt; Control</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P>So in the end, every single code point from 0x00 to 0xFF is accounted for in the database, and the MB_ERR_INVALID_CHARS flag functions only by detecting the characters that map to the PUA (the green entries above) -- all of the ones that map to control characters are NOT considered invalid.</P>
<P>Further, if you don't pass MB_ERR_INVALID_CHARS, then none of them will be replaced by the default character -- they map as indicated here.</P>
<P>Now as I said at the beginning of this post, very little of this is currently documented. I'll make sure that the doc folks get to hear about this to address the problem at some point....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp; </FONT><EM><FONT color=#ff00ff>(</FONT><A class="" href="http://www.fileformat.info/info/unicode/char/05ea" mce_href="http://www.fileformat.info/info/unicode/char/05ea">U+05ea</A><FONT color=#ff00ff>, a.k.a. HEBREW LETTER TAV)</FONT></EM></P>
<hr/><p><a id="4151536" href="#4151536">#</a> <strong>ctate</strong> on 31 Jul 2007 2:34 PM:</p><div style="margin-left: 1em"><p>I'm afraid this is only tangentially related to the topic here, but it's similar and I am coming up with dead zero information about it, so here goes...</p>
<p>Take an application built without /DUNICODE, i.e. one using straight ASCII and code pages and so on. &nbsp;Let's also assume for now that we're using the default US locale and code page set, with no jiggery-pokery.</p>
<p>If that application, running on Windows XP [or 98 or 95 or...] calls ExtTextOut() to write the character 0x7f, a solid block is drawn on the screen.</p>
<p>In Vista, nothing is drawn. &nbsp;In fact, nothing is drawn in Vista when calling ExtTextOut() in this application with any extended ASCII character.</p>
<p>This is a problem... how is a non-Unicode application running in Vista supposed to draw a solid block, or diacritics, or...? &nbsp;I realize that MS is trying to push people towards using Unicode, but for legacy apps this is major engineering, especially when those apps' source is shared across platforms.</p>
<p>Do you at least know of any documentation on this Vista change and how to work with it?</p></div>
<p><a id="4152798" href="#4152798">#</a> <strong>Michael S. Kaplan</strong> on 31 Jul 2007 5:11 PM:</p><div style="margin-left: 1em"><p>0x7f is not a character - it is the delete code. There are all kinds of wonky things that code can do, this would be one of them....</p>
</div>
<p><a id="4620067" href="#4620067">#</a> <strong>Yossi</strong> on 28 Aug 2007 7:36 PM:</p><div style="margin-left: 1em"><p>This inconsistency is pretty bad (the difference between how the actual Code page and best fit tables treat invalid characters). It renders MultiByteToWideChar pretty much useless in certain cases where these invalid characters are finding themselves into the output stream. </p>
<p>I'm using MSXML2 to read an XML file which was produced after converting MBSC character stream to Unicode. Since the following characters:</p>
<p>0x81 0x0081</p>
<p>0x8d 0x008d</p>
<p>0x8f 0x008f</p>
<p>0x90 0x0090</p>
<p>0x9d 0x009d</p>
<p>in the 1252 best fit appears to be &quot;OK&quot;, the MSXML2 just fails to parse the file.</p>
<p>Is there a way to resolve this problem (other than to scan the stream in a for-loop and replacing this invalid characters?</p>
<p>Is there a version of MSXML2 that is consistent with the behavior of MultiByteToWideChar?</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/02/20 <a href="http://archives.miloush.net/michkap/archive/2012/02/20/10269748.html">Where short file names can fail</a></p><p>2009/09/04 <a href="http://archives.miloush.net/michkap/archive/2009/09/04/9890852.html">When conversions ignore the errors...</a></p><p>2008/05/08 <a href="http://archives.miloush.net/michkap/archive/2008/05/08/8466991.html">In hindsight, they may have BEST FIT these files where the sun never shines</a></p><p>2007/08/29 <a href="http://archives.miloush.net/michkap/archive/2007/08/29/4624037.html">If the data is invalid, the results can be invalid too</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/07/25/4037989.html" title="Not a YES man, but maybe a YEH man">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/07/24/4034548.html" title="Product [Un]fair?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-07-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/07/25/4037646.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>