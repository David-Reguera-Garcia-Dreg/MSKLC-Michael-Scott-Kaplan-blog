<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/26/3558548.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The MB_PRECOMPOSED flag is stupid, and the MB_COMPOSITE ain't no genius either</title></head><body>
<h1>The MB_PRECOMPOSED flag is stupid, and the MB_COMPOSITE ain't no genius either</h1>
<p><em>by Michael S. Kaplan, published on 2007/06/27 00:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/06/26/3558548.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The other day when I suggested that if <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/06/22/3466480.html" mce_href="http://archives.miloush.net/michkap/archive/2007/06/22/3466480.html">Your VC++ files don't support Unicode identifiers? Drop a BOM on them!</A></STRONG>,&nbsp;John Bates <A class="" href="http://archives.miloush.net/michkap/archive/2007/06/22/3466480.html#3509179" mce_href="http://archives.miloush.net/michkap/archive/2007/06/22/3466480.html#3509179">commented</A>:</P>
<BLOCKQUOTE>
<P><EM>RC.exe can properly compile .rc files saved as UTF-16LE (strangely not UTF8-with-BOM though)...</EM></P></BLOCKQUOTE>
<P>&nbsp;The reason UTF-8 is not supported here is not due to any brilliant technical issue, though.</P>
<P>Basically, with the exception of UTF-16, code page support is via a simple command line switch, as described in <A class="" href="http://msdn2.microsoft.com/library/aa381055.aspx" mce_href="http://msdn2.microsoft.com/library/aa381055.aspx">Using RC (The RC Command Line)</A>:</P>
<BLOCKQUOTE>
<P><STRONG>/c<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp; Defines a code page used by NLS conversion. </STRONG></P></BLOCKQUOTE>
<P>Take this doc at its word -- this switch literally tells the Resource Compiler what code page value to feed to a <A class="" href="http://msdn2.microsoft.com/library/ms776413.aspx" mce_href="http://msdn2.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</A> call. </P>
<P><EM>(FYI, this is also why you cannot pass 1200 or 1201 for UTF-16 LE/BE -- because </EM><A class="" href="http://msdn2.microsoft.com/library/ms776413.aspx" mce_href="http://msdn2.microsoft.com/library/ms776413.aspx"><EM>MultiByteToWideChar</EM></A><EM> does not support these code pages!)</EM></P>
<P>A call which, unfortunately, is done with the MB_PRECOMPOSED flag. The flag that briefly came up in my post <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/19/409566.html">A few of the gotchas of MultiByteToWideChar</A></STRONG>.</P>
<P>I say unfortunately because of that note in the <A class="" href="http://msdn2.microsoft.com/library/ms776413.aspx" mce_href="http://msdn2.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</A> topic:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P>For the code pages listed below, dwFlags must be set to 0. Otherwise, the function fails with ERROR_INVALID_FLAGS. </P>
<P>50220&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50227&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 57002 through 57011<BR>50221&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 50229&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 65000 (UTF-7)<BR>50222&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 52936&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 42 (Symbol)<BR>50225&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;54936</P>
<P>Note: For UTF-8, dwFlags must be set to either 0 or MB_ERR_INVALID_CHARS. Otherwise, the function fails with ERROR_INVALID_FLAGS. </P></BLOCKQUOTE></BLOCKQUOTE>
<P>Aha, so UTF-8 is failing in the Resource Compiler because it is always including a flag that is documented as not working with UTF-8 (or a bunch of other code pages).</P>
<P>Now as the title of this post indicates, the MB_PRECOMPOSED flag is stupid.</P>
<P>To do their work, MB_PRECOMPOSED and MB_COMPOSITE actually use the lame tables that <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A> used&nbsp;to suppose MAP_PRECOMPOSED and MAP_COMPOSITE prior to Vista (when it started using normalization). I cal;l these tables lame since they are incomplete. But no one wanted to slow down <A class="" href="http://msdn2.microsoft.com/library/ms776413.aspx" mce_href="http://msdn2.microsoft.com/library/ms776413.aspx">MultiByteToWideChar</A> by making it normalize text, and no one wanted to update this lame set of tables, so&nbsp;everything was left as is. They are just dumb flags to use, ever. You should just normalize if you want to get into Form C or Form D, and call it a day.</P>
<P>Anyway, I am sure that the UTF-8 issue in the Resource Compiler will see itself fixed in some upcoming version, given how easy it is to either (a) never pass a stupid flag or at least to do the minimal change and (b) never pass a stupid flag if it makes the function fail on a code page you do not want it to.</P>
<P><EM>(In an ideal world it would also recognize the UTF-8 BOM just like it recognizes the UTF-16 BOM, but again the whole minimal change thing would probably have a lot of influence here!)</EM></P>
<P mce_keep="true">&nbsp;</P>
<P><EM><FONT color=#ff00ff>This post is sponsored by <A class="" href="http://www.fileformat.info/info/unicode/char/fffe" mce_href="http://www.fileformat.info/info/unicode/char/fffe">U+feff</A> (ZERO WIDTH NO-BREAK SPACE)</FONT></EM></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/01/12 <a href="http://archives.miloush.net/michkap/archive/2010/01/12/9946880.html">On my "Vietnamese Plus" and "pseudo-Form V" constructs</a></p><p>2008/09/25 <a href="http://archives.miloush.net/michkap/archive/2008/09/25/8964094.html">When to make a change, when to stay the same</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/06/26/3559309.html" title="Behold the [non-fa-IR default] PersianCalendar class">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/06/25/3537065.html" title="Sometimes you drop the BOM, and sometimes the BOM drops you!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06-26">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/26/3558548.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>