<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/21/3431070.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>RTF is a terrible, horrible, no good, very bad file format</title></head><body>
<h1>RTF is a terrible, horrible, no good, very bad file format</h1>
<p><em>by Michael S. Kaplan, published on 2007/06/21 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/06/21/3431070.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM>(Apologies to Judith Viorst!)</EM></P>
<P>The other day Michael Michael asked me:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times"><I>
<P>My team has been caught in a situation that is affecting our globalization plans. Basically, we have the following scenario:</P>
<UL>
<LI>We are using richtextbox’s in several places in our GUI (we are coding in C# using Whidbey and winforms in our GUI).</LI>
<LI>because of some of our formatting restrictions (need to bold, underline, etc our content), we need to use the RTF property of the richtextbox control to add the data</LI></UL>
<P>Now comes the problem. In English, all this works fine. However, in Chinese for example, we get a bunch of ???’s in our UI. We have identified the problem to be the character set and the font for each language. I am thinking, this is a problem that other teams at Microsoft must have faced and solved. Are you aware of any solutions?</P></I></FONT></BLOCKQUOTE>
<P mce_keep="true">There are really two different ways to approach this problem.</P>
<P mce_keep="true">The "easy" way is to add the text as text (i.e. setting the <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.text.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.text.aspx">RichTextBox.Text</A> property for managed code) and then apply the formatting after the fact by using the <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.textboxbase.selectionstart.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.textboxbase.selectionstart.aspx">RichTextBox.SelectionStart</A> and <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.selectionlength.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.selectionlength.aspx">RichTextBox.SelectedLength</A>&nbsp;properties to select sections of it and the <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.selectionfont.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.richtextbox.selectionfont.aspx">RichTextBox.SelectionFont</A> and related properties to do the formatting.</P>
<P mce_keep="true">Now I called this way easy, but it can get hard pretty quickly, especially when one considers that the RTF you get back when yout take this approach is really bad.</P>
<P mce_keep="true">I mean horrible.</P>
<P mce_keep="true">Like lock up your daughters, break out the food rations, move to Australia just to get away from it all terrible.... basically putting everything in byte-based data that you cannot read (and which bloats up very quickly if you try to o that editing work on it....</P>
<P mce_keep="true"><A class="" href="http://blogs.msdn.com/murrays/" mce_href="http://blogs.msdn.com/murrays/">Murray</A> then weighed in with&nbsp;some info:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="times new roman,times"><EM>For Chinese even the old RichEdit 3.0 in RichEdit.dll on XP or Vista should handle both (CHS/CHT) writing systems okay without resorting to \uN control words. Such words are necessary for Unicode-only writing systens, but not for the principal East Asian writing systems. So if you manage to get the desired Chinese text into a RichEdit control, it should be able to generate valid RTF. But if you’re generating the RTF, then you need to worry about making it valid and that’s not so easy. Using the \uN approach is probably the easiest way. If you use \uc1, then follow each \uN entry with a ? so that you don’t have to figure out the corresponding codepage values. RichEdit uses WCTMB to convert Unicode to the CHS or CHT codepage for use in RTF and only resorts to \uN when the codepage doesn’t have the character...</P>
<P mce_keep="true">...It’s true that the spec says that the N for \uN is a signed 16-bit number, but RichEdit and Word accept larger values. The parameter is treated as a LONG internally and I figured early on (back in the 1990’s) that higher-plane characters would be written using (slightly) more readable UTF-32 values rather than surrogate pairs. So RichEdit supports both signed 16 and 32-bit values. UTF-32 hex values would be best, but oh well! Word does handle things like \insrsid3623724, which clearly doesn’t have a signed 16-bit number. But I believe Word requires surrogate pairs for higher-plane characters.</EM></FONT></P></BLOCKQUOTE>
<P mce_keep="true">And colleague developer Stephan (who I remembered from my Office daysand whose words I&nbsp;was as always glad to see)&nbsp;stepped in with some very good info about the format, whether UTF-16 code points were&nbsp;always required,&nbsp;and why the terminating question mark would be needed at the end of each code point:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>RTF keyword numeric arguments are supposed to be 16-bit signed integers, yes.&nbsp; So, Unicode codepoints &gt;32K should be written as negative numbers.<BR><BR>Note that there are exceptions to the signed short rule – I think (it’s been a few years since I wrote anything, or for that matter read anything, in the RTF spec) that the \bin keyword for example, takes 32-bit integers.&nbsp; In my own parser, rather than insist on only 16-bit signed values, I simply accepted 32-bit values everywhere.&nbsp; I can imagine this being a common approach, and so, who knows how close typical real-world readers are to the spec in this and other respects.<BR><BR>Another thing that may be relevant is how parsers handle the “single character fallback” \uc1 refers to.&nbsp; This is the ? Murray mentions.&nbsp; is it “the next single byte”?&nbsp; What if that byte is a \ -- is it that control word started by that \ ? What about a space (recall that RTF keywords may be optionally followed by a space, so it’s not obvious whether a space should be considered the fallback character instead of the optional terminator).&nbsp; What about { or } ?&nbsp; I think the spec is now clear on this (I remember getting such answers clarified in the Unicode RTF spec before too many people saw it), but that doesn’t mean&nbsp; all readers agree on this subtlety.<BR><BR>From just the most recent reply in this thread, I can imagine that the reader in question is interpreting \u22914\u26524&nbsp; as Unicode codepoint 22914, followed by one ‘character’ of fallback; where the character is the whole RTF keyword and argument \u26524 (even though the character represented isn’t ASCII – the kind of thing you’d expect in the fallback representation).&nbsp; A little later, there’s \u20316\b0&nbsp; which seems to bear out the theory: the fallback for \u20316 is the \b0 sequence – not a reasonable fallback character at all, but consumed by the reader nonetheless.&nbsp; Near the end is \u12290\par\par\par} in which the wrong \par is highlighted.&nbsp; It’s the first \par that is the inappropriately consumed fallback for \u12290, and the second and third one are faithfully preserved.<BR><BR>Because the reader is capable of handling the Unicode, it ignores the fallback(which is how it gets lost, and why the meaninglessness of \b0 “bold off” as a fallback isn’t a problem).&nbsp; Meanwhile, when the control returns the text, it emits its own, much more reasonable, fallback for each of \u22914, etc. – a simple ?.<BR><BR>stephan();</EM></P></BLOCKQUOTE>
<P mce_keep="true">and Greg (test guru&nbsp;who&nbsp;I sometimes think has&nbsp;probably investigated more RTF bugs than most other testers&nbsp;combined!) reminded me of something he hd pointed out when the issue of thse \u escapes came up previously:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="times new roman,times">Speaking of bugs, just a couple of words of caution – be careful how much stuff you encode with \u####. Older versions of RichEdit and some other RTF parsers have some bugs with picking the right font for these from RTF stream. The RTF spec suggest that if you can use the \’ encoding to do so (or obviously putting ANSI latin as latin and not the u escapes). Also, I have seen several folks run try to encode everything with \u, including font names. Don’t do that. Some RTF readers can’t handle \u#### in font tables.</FONT></P></BLOCKQUOTE>
<P mce_keep="true">I still don't mind encoding the RTF&nbsp;with the \u&nbsp;escapes, though I try to keep ASCII and actual formatting metadata out of it when&nbsp;I can because of this....</P>
<P mce_keep="true">So if you are&nbsp;handling&nbsp;almost every&nbsp;character as a decimal Unicode&nbsp;number and putting it in a question&nbsp;mark at the end of each character, then your RTF will be&nbsp;almost as&nbsp;compact as you can allow it to be (the RTF stiill won't be readable, but least least you can see the code points.</P>
<P mce_keep="true">It is really terrible that RTF has all of these crufty requirements that are handles so much better by HTML and by XML with specific XSL as needed. That is what I am recommending more and more.</P>
<P mce_keep="true">Because in my opinion, RTF is a terrible, horrible, no good, very bad file format, and I think it should be sent to Australia. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> ᙀ <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/1640" mce_href="http://www.fileformat.info/info/unicode/char/1640">U+1640</A>, a.k.a. CANADIAN SYLLABICS CARRIER ZU)</EM></FONT></P>
<hr/><p><a id="3441797" href="#3441797">#</a> <strong>Dean Harding</strong> on 21 Jun 2007 6:45 AM:</p><div style="margin-left: 1em"><p>&gt; I think it should be sent to Australia.</p>
<p>We don't want it, either :p</p>
</div>
<p><a id="3442606" href="#3442606">#</a> <strong>Michael S. Kaplan</strong> on 21 Jun 2007 8:10 AM:</p><div style="margin-left: 1em"><p>That part was always Judith Viorst's idea. Though I always wondered if the children's book was popular *in* Australia. :-)</p>
</div>
<p><a id="3446105" href="#3446105">#</a> <strong>Robert</strong> on 21 Jun 2007 1:39 PM:</p><div style="margin-left: 1em"><p>&gt;It is really terrible that RTF has all of these crufty requirements that are handles so much better by HTML and by XML with specific XSL as needed.</p>
<p>The rich edit control also offers UTF-8 RTF which might provide a better solution for including Unicode in RTF. It is much easier to parse than those \u... expressions with complex fallback characters. There doesn't seem to be much support for this elsewhere, though.</p></div>
<p><a id="3448693" href="#3448693">#</a> <strong>Michael S. Kaplan</strong> on 21 Jun 2007 5:51 PM:</p><div style="margin-left: 1em"><p>Most richedit parsers cannot handle it very well. :-(</p>
<p>But you are right that it can be better than the escaped sequence stuff....</p>
</div>
<p><a id="3469456" href="#3469456">#</a> <strong>Eric C Brown</strong> on 22 Jun 2007 7:15 PM:</p><div style="margin-left: 1em"><p>As someone who used to own the RTF spec back in the late '80s to early '90s, I'd like to say that RTF is a perfectly good file format, so long as you don't expect it to use Unicode. &nbsp;RTF was defined in the early '80s, long before Unicode came along - why would you expect it to work well? &nbsp;</p>
</div>
<p><a id="3469834" href="#3469834">#</a> <strong>Michael S. Kaplan</strong> on 22 Jun 2007 7:31 PM:</p><div style="margin-left: 1em"><p>And now that pretty much everything is Unicode, RTF becomes much less than perfectly good....</p>
<p>I could easily imagine better ways they could have made it work (both HTML and XML are examples of markup languages that made a smoother transition than RTF did). :-)</p>
</div>
<p><a id="3528099" href="#3528099">#</a> <strong>Erik</strong> on 25 Jun 2007 5:01 PM:</p><div style="margin-left: 1em"><p>Some file formats are like that. &nbsp; Even in Australia.</p>
<p>-- Erik</p></div>
<p><a id="3790855" href="#3790855">#</a> <strong>iansane</strong> on 9 Jul 2007 10:35 PM:</p><div style="margin-left: 1em"><P>where do I go to school to learn what you guys are talking about? All I can learn in Georgia is how to swap a drive.</P></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/06/21/3438416.html" title="Oops! Somebody did broken it!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/06/20/3424633.html" title="Overheard recently">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06-21">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/21/3431070.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>