<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/16/3330810.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Apparently the [DataGridView] train might sometimes skip a [FULL] STOP</title></head><body>
<h1>Apparently the [DataGridView] train might sometimes skip a [FULL] STOP</h1>
<p><em>by Michael S. Kaplan, published on 2007/06/16 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/06/16/3330810.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM>(HR would probably&nbsp;</EM><EM>recommend against any&nbsp;more clever of a </EM><EM>title for this blog post than the one with which it is currently </EM><EM>saddled)</EM></P>
<P>I have mentioned <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html">previously</A></STRONG> that I hate the <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx">Keys enumeration</A> in the .NET Framework. And I even have explained a bit about why.</P>
<P>One&nbsp;reason I don't like it is that it encourages code to be written than confuses VIRTUAL KEY values on keys with the character assignments on those keys.</P>
<P>Even though they are sometimes not the same.</P>
<P>Just the other Dave ran into a problem caused by someone else hitting just such a misunderstanding. Someone working for Microsoft who wrote the code which has subsequently shipped in a version of the framework or two (maybe three or four!). His question went as follows:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM><FONT face="times new roman,times">I am investigating a problem where the text box created by a DataGridView when editing a field is dropping the period character when using the handwriting tip on an XPSP2 Tablet PC. For example, writing 4.1 in the tip is entered as 41 in the DataGridViewâ€™s text box. Running Spy++ on the process that owns the DataGridView, I can see that the control is receiving the correct sequence of WM_CHAR messages as if I typed 4.1 on the keyboard. Entering the same value in Notepad or other application that uses an edit control does not exhibit this problem. Additionally, I am unable to reproduce the problem with a text box that is on the same form as the DataGridView.<BR><BR>I am in the process of installing VS on the Tablet PC to try to determine where the WM_CHAR for the period character is being handled. In the meantime, I am curious if this is a known issue with the DataGridView.<BR><BR>Thanks,<BR><BR>Dave</FONT></EM></P></BLOCKQUOTE>
<P mce_keep="true">The problem turns out to be that when one types that particular character whose Unicode code point is <A class="" href="http://www.fileformat.info/info/unicode/char/002e" mce_href="http://www.fileformat.info/info/unicode/char/002e">U+002e</A>, that it shares an identity with a constant from winuser.h:</P>
<BLOCKQUOTE>
<P mce_keep="true"><STRONG><FONT face="courier new,courier">#define VK_DELETE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x2E</FONT></STRONG></P></BLOCKQUOTE>
<P mce_keep="true">And of course the code in DataGridView.ProcessKeyPreview is returning <STRONG>true</STRONG> and thus not processing several different values, including in this case <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx">Keys</A>.Delete. And we skip right over that character, thinking it is one of those VK values that needs special handling rather than a character (all lost through a cast to that enumeration&nbsp;from a WPARAM of a window message where no one checked whether it was the right message to make that assumption with).</P>
<P mce_keep="true">And if&nbsp;you take a value like 4.1 and skip over that FULL STOP then you are left with 41. And the bitter knowledge that someone forgot to do more homework on the meaning and [mis]usage of the <A class="" href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx" mce_href="http://msdn2.microsoft.com/library/system.windows.forms.keys.aspx">Keys enumeration</A>....</P>
<P mce_keep="true">Now I don't just want to pick on the WinForms folks here. </P>
<P mce_keep="true">I mean, sure, they screwed this one up.</P>
<P mce_keep="true">And&nbsp;sure,&nbsp;they screw it up over and over when they try to use it.</P>
<P mce_keep="true">But the original Windows side of this is just as bad with the set of VK_* values that are the same as the letters side by side with the ones that are not that got people started down this road, as I have pointed out <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/23/558658.html"><STRONG>previously</STRONG></A>&nbsp;(at the bottom of the post). </P>
<P mce_keep="true">Pound for pound, introducing a long standing design flaw is worse than either extending it or making people more susceptible to it. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=6>.</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/002e" mce_href="http://www.fileformat.info/info/unicode/char/002e">U+002e</A>, a.k.a. FULL STOP)</EM></FONT></P>
<hr/><p><strong>Andy Kackle</strong> on 11 Mar 2009 11:00 AM:</p><div style="margin-left: 1em"><p>So how do you get the period to show up in the DataGridView?</p></div>
<p><strong>Christopher Poe AKA Triforce</strong> on 21 Feb 2011 4:50 PM:</p><div style="margin-left: 1em"><p>Here is my solution to this, in a derived DataGridView:</p>
<p>&nbsp; &nbsp;&lt;SecurityPermission(SecurityAction.LinkDemand, Flags:=SecurityPermissionFlag.UnmanagedCode)&gt; _<br />&nbsp;&nbsp;&nbsp;Protected Overrides Function ProcessKeyPreview(ByRef m As System.Windows.Forms.Message) As Boolean</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;&#39; This is a workaround for a bug in the base DataGridView key processing.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; See MSDN Blog: <a target="_new" rel="nofollow" href="http://archives.miloush.net/michkap/archive/2007/06/16/3330810.html">blogs.msdn.com/.../3330810.aspx</a><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Const WM_CHAR As Integer = &amp;H102<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim pKey As Keys<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dim pProcessed As Boolean</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;&#39; Map character to key - same way as done in base method, note that both the period and delete keys both map to Keys.Delete!<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pKey = DirectCast(CInt(m.WParam), Keys) Or ModifierKeys<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If (m.Msg = WM_CHAR) AndAlso (pKey = Keys.Delete) Then<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; If it&#39;s a keypress message (WM_CHAR) and it gets mapped to the delete key, do not process it.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; The actual delete key should never generate a keypress anyhow, so this is a good workaround.<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pProcessed = False<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Else<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39; Process normally<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pProcessed = MyBase.ProcessKeyPreview(m)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End If</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;Return pProcessed<br />&nbsp;&nbsp;&nbsp;End Function</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/06/16/3345079.html" title="You don&#39;t have to trust Microsoft&#39;s choices about fonts">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/06/15/3328206.html" title="+1 on what he said (and some girl&#39;s ones are bigger than other girl&#39;s ones)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/16/3330810.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>