<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/23/3474350.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Marshaling your resistance</title></head><body>
<h1>Marshaling your resistance</h1>
<p><em>by Michael S. Kaplan, published on 2007/06/23 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/06/23/3474350.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>I was recently involved in one of those interesting email discussions where I had the opportunity to both help and hinder my reputation.</P>
<P>And at the same time the conversation got to make something in the design of a programming language look like it both a bug and an inconsistent (or maybe I should say <STRONG>impure</STRONG>) design.</P>
<P>(It also hurt at least a little bit the reputation of a developer who gave me advice about the same issue months before, but their advice was not attributed so it only hurt their reputation with me, in this case!).</P>
<P>Anyway, let me explain what I am talking about.</P>
<P>There are some functions that accept or return buffers that are arrays of strings, and they are laid out like the following:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier">
<P>string1<STRONG><FONT color=#ff0000 size=4>\0</FONT></STRONG>string2<STRONG><FONT color=#ff0000 size=4>\0</FONT></STRONG>string3<STRONG><FONT color=#ff0000 size=4>\0</FONT></STRONG>string4<FONT color=#ff0000 size=4><STRONG>\0\0</STRONG></FONT></P></FONT></BLOCKQUOTE>
<P>This is the&nbsp;pattern you see in functions like <A class="" href="http://msdn2.microsoft.com/library/ms724363.aspx" mce_href="http://msdn2.microsoft.com/library/ms724363.aspx">GetProfileSection</A> and <A class="" href="http://msdn2.microsoft.com/library/ms725500.aspx" mce_href="http://msdn2.microsoft.com/library/ms725500.aspx">WritePrivateProfileSection</A>. It is not the most common kind of design pattern, but if you are using C/C++ it might be mildly convenient (though from C or C++ a <A class="" href="http://msdn2.microsoft.com/library/kb57fad8.aspx" mce_href="http://msdn2.microsoft.com/library/kb57fad8.aspx">va_list</A> might be a bit easier to use).</P>
<P>Now one problem that this pattern has is that it is much harder to use from languages like VB or C# (though truth be told a <A class="" href="http://msdn2.microsoft.com/library/kb57fad8.aspx" mce_href="http://msdn2.microsoft.com/library/kb57fad8.aspx">va_list</A>&nbsp;is <STRONG>much</STRONG> harder to use in that case so it is probably not so bad that this harder to use but still in theory available method exists!).</P>
<P>Anyway, some&nbsp;other functions that uses this pattern are <A href="http://msdn2.microsoft.com/library/ms776237.aspx" mce_href="http://msdn2.microsoft.com/library/ms776237.aspx">SetThreadPreferredUILanguages</A> and <A href="http://msdn2.microsoft.com/library/ms776211.aspx" mce_href="http://msdn2.microsoft.com/library/ms776211.aspx">GetThreadPreferredUILanguages</A>. I covered a way to call them from C# in the post <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/12/16/1300320.html" mce_href="http://archives.miloush.net/michkap/archive/2006/12/16/1300320.html">Thinking about MUI is making me bipolar</A></STRONG>, and one of the people who had an earlier look at the post suggested that instead of using the following pinvoke declaration:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [DllImport("kernel32.dll", CharSet=CharSet.Unicode, ExactSpelling=true, CallingConvention=CallingConvention.StdCall, SetLastError=true)]<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static extern bool GetThreadPreferredUILanguages(<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;uint dwFlags, ref int pulNumLanguages, [MarshalAs(UnmanagedType.LPWStr)] string pwszLanguagesBuffer, ref int pcchLanguagesBuffer);</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">that I might want to use StringBuilder instead (then converting the final results to a string using the <A class="" href="http://msdn2.microsoft.com/library/aa904335.aspx" mce_href="http://msdn2.microsoft.com/library/aa904335.aspx">StringBuilder.ToString(int,int)</A> overload. But I thought about it and realized that this would perhaps allocate the string twice, and the code I had already worked (and I was much more worried about the actual bugs -- convincing the MUI folks that bugs&nbsp;existed --&nbsp;by that point) so I let it go.</P>
<P mce_keep="true">Anyway, a few months later someone else was calling a similar function and they were having trouble. Suggestions ranged from using byte arrays and converting to strings via the <A class="" href="http://msdn2.microsoft.com/library/system.text.encoding.aspx" mce_href="http://msdn2.microsoft.com/library/system.text.encoding.aspx">Encoding class</A> to using <A class="" href="http://msdn2.microsoft.com/library/system.runtime.interopservices.marshal.ptrtostringuni.aspx" mce_href="http://msdn2.microsoft.com/library/system.runtime.interopservices.marshal.ptrtostringuni.aspx">Marshal.PtrToStringUni</A>, and I figured I'd trot out that blog entry with the <STRONG>[MarshalAs(UnmanagedType.LPWStr)]</STRONG> code that works and then also suggest the <A class="" href="http://msdn2.microsoft.com/library/aa904335.aspx" mce_href="http://msdn2.microsoft.com/library/aa904335.aspx">StringBuilder.ToString(int,int)</A>&nbsp;solution for people bothered by the voodoo of treating a System.String as a buffer for a function,&nbsp; violating the whole immutability thing.</P>
<P mce_keep="true">After not too long someone turned around and proved that the StringBuilder method did not work -- that the marshaller for the StringBuilder appeared to be truncating after the first NULL long before the ToString() method was even involved. Insane!</P>
<P mce_keep="true">Okay, so I was wrong about that. It isn't like I actually tried that code; I just had a random developer wonder why I chose the method I did when there was a more conventional one available.</P>
<P mce_keep="true">At least I had that answer that worked to fall back on. :-)</P>
<P mce_keep="true">Not to mention the fact the actual StringBuilder behavior here is hard to argue as anything other than a bug fat bug that probably deserves consideration of a fix on its merits....</P>
<P mce_keep="true">Even if the method is not "pure" and would not exist in a perfect NGWS/.Net world, I could make a strong case that the truncation at NULL bug in StringBuilder wouldn't exist in a perfect world, either (and both the <A class="" href="http://msdn2.microsoft.com/library/system.text.encoding.aspx" mce_href="http://msdn2.microsoft.com/library/system.text.encoding.aspx">Encoding class</A>&nbsp;and <A class="" href="http://msdn2.microsoft.com/library/system.runtime.interopservices.marshal.ptrtostringuni.aspx" mce_href="http://msdn2.microsoft.com/library/system.runtime.interopservices.marshal.ptrtostringuni.aspx">Marshal.PtrToStringUni</A>&nbsp;solutions involved extra allocations and potential conversion bugs, which would also be pretty impure....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>Ç¤</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/01e4" mce_href="http://www.fileformat.info/info/unicode/char/01e4">U+01e4</A>, a.k.a. LATIN CAPITAL LETTER G WITH STROKE)</EM></FONT></P>
<hr/><p><a id="3513486" href="#3513486">#</a> <strong>Wilhelm Svenselius</strong> on 25 Jun 2007 2:01 AM:</p><div style="margin-left: 1em"><p>I'd probably go for the byte[]/System.Encoding solution if I was faced with this, unless there is some magical way to do it in less code. Using byte[] and Encoding makes it obvious to whoever reads the code that we are parsing a binary blob that contains some strings, rather than something which itself is a string, as using StringBuilder would imply.</p></div>
<p><a id="3518940" href="#3518940">#</a> <strong>Michael S. Kaplan</strong> on 25 Jun 2007 8:13 AM:</p><div style="margin-left: 1em"><p>Doesn't &nbsp;[MarshalAs(UnmanagedType.LPWStr)] &nbsp;make for less code here? :-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/06/25/3521939.html" title="Sometimes when you say &#39;the fix is in&#39; you mean it in a good way">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/06/22/3468109.html" title="Same time, bigger station">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-06-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/06/23/3474350.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>