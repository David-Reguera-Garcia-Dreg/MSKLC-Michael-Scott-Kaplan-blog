<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/03/1395788.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Converting a Project to Unicode: Part 7 (What does it mean to fit things to a 'T', anyway?)</title></head><body>
<h1>Converting a Project to Unicode: Part 7 (What does it mean to fit things to a 'T', anyway?)</h1>
<p><em>by Michael S. Kaplan, published on 2007/01/03 03:01 -08:00, original URI: /web/20080229133725/http://blogs.msdn.com/michkap/archive/2007/01/03/1395788.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P>Previous posts in this series (including today's!): 
<UL>
<LI><A href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/27/1368334.aspx" mce_href="http://archives.miloush.net/michkap/archive/2006/12/27/1368334.html">Part 0 (The introduction)</A> 
<LI><A href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/28/1372747.aspx" mce_href="http://archives.miloush.net/michkap/archive/2006/12/28/1372747.html">Part 1 (Business before pleasure)</A> 
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/29/1377788.aspx" mce_href="http://archives.miloush.net/michkap/archive/2006/12/29/1377788.html">Part 2 ('Sorry, you're not my type.' 'Um,&nbsp;maybe&nbsp;I could change that?)</A> 
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/30/1382886.aspx" mce_href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html">Part 3 (Can I quote you on that?)</A> 
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/31/1386486.aspx" mce_href="http://archives.miloush.net/michkap/archive/2006/12/31/1386486.html">Part 4 (/Delightful, /Delicious, /DUnicode!)</A> 
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2007/12/01/1391798.aspx" mce_href="http://archives.miloush.net/michkap/archive/2007/12/01/1391798.html">Part 5 (Are we there yet? Well, not just yet)</A></LI>
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2007/01/02/1395703.aspx" mce_href="http://archives.miloush.net/michkap/archive/2007/01/02/1395703.html">Part 6 (Upon&nbsp;the road not traveled)</A></LI>
<LI><A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2007/01/02/1395788.aspx" mce_href="http://archives.miloush.net/michkap/archive/2007/01/02/1395788.html">Part&nbsp;7 (What does it mean to fit things to a 'T', anyway?)</A></LI></UL>
<P>(If you are&nbsp;just tuning&nbsp;in and want to start&nbsp;now you can grab the current source from <A class="" href="http://blogs.msdn.com/web/20080229133725/http://www.trigeminal.com/samples/SETUP_SOURCE/part05.zip" mce_href="http://www.trigeminal.com/samples/SETUP_SOURCE/part05.zip">here</A>&nbsp;-- no changes since it was posted the day before yesterday)</P>
<P>Like I said yesterday,&nbsp;if you have read Parts 2-5 then you know how we went from a purely ANSI application to a purely Unicode one.</P>
<P>The binary itself has been tested with the MSKLC update and it resolves the bug I talked about back in Part 0. And the Unicode Bootstrap EXE works for the scenarios in which it will be used.</P>
<P>Now for a moment I wanted to talk about the myth of applications compiled as both Unicode and ANSI. We say TCHAR but the truth is that most of the time the dev has just one in mind. For me it is Unicode (which leads to problems like the one Mihai pointed out <A class="" href="http://blogs.msdn.com/web/20080229133725/http://blogs.msdn.com/michkap/archive/2006/12/30/1382886.aspx#1386466" mce_href="http://archives.miloush.net/michkap/archive/2006/12/30/1382886.html#1386466"><STRONG>here</STRONG></A>) and to be honest most developers think of it as ANSI, even when they talk about Unicode, which is why you get problems like those in <A class="" href="http://blogs.msdn.com/web/20080229133725/http://msdn2.microsoft.com/en-us/library/ms649914.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms649914.aspx">the DrawThemeText function</A>. Ignore the weird text for a moment:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM><FONT face="times new roman,times">DrawThemeText uses parameters similar to the Microsoft Win32 DrawText function, but with a few differences. One of the most notable is support for wide-character strings. Therefore, non-wide strings must be converted to wide strings, as in the following example. </FONT></EM></P></BLOCKQUOTE>
<P>You know, text&nbsp;handled by&nbsp;people who were not aware&nbsp;that <A class="" href="http://blogs.msdn.com/web/20080229133725/http://msdn.microsoft.com/library/en-us/gdi/fontext_0odw.asp" mce_href="http://msdn.microsoft.com/library/en-us/gdi/fontext_0odw.asp">DrawText</A> has a Unicode version.&nbsp;And just look at the code sample:</P>
<BLOCKQUOTE>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P>INT cchText = GetWindowTextLength(_hwnd);<BR>if (cchText &gt; 0)<BR>{<BR>&nbsp; TCHAR *pszText = new TCHAR[cchText+1];<BR>&nbsp; if (pszText)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; if (GetWindowText(_hwnd, pszText, cchText+1))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int widelen = MultiByteToWideChar(CP_ACP, 0, pszText, cchText+1, NULL, 0);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; WCHAR *pszWideText = new WCHAR[widelen+1];<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MultiByteToWideChar(CP_ACP, 0, pszText, cchText, pszWideText, widelen);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SetBkMode(hdcPaint, TRANSPARENT);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DrawThemeText(_hTheme,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hdcPaint,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BP_PUSHBUTTON,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _iStateId,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pszWideText,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cchText,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DT_CENTER | DT_VCENTER | DT_SINGLELINE,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NULL,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &amp;rcContent);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delete [] pszWideText;<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; delete [] pszText;<BR>&nbsp; }<BR>}</P></B></FONT></BLOCKQUOTE></BLOCKQUOTE>
<P mce_keep="true">This is code that won't even compile if you try to compile it as UNICODE! </P>
<P mce_keep="true">Clearly, there&nbsp;are times where&nbsp;even the people who are moving forward and only providing&nbsp;Unicode versions to their functions are not necessarily thinking of a TCHAR as a type that could be either a CHAR or a WCHAR.</P>
<P mce_keep="true">And I am not casting stones here or anything (after all, I made the same kind of mistake in the other direction -- one I may never have noticed since I was only ever going to probably compile and run the code with UNICODE/_UNICODE (just as I suppose people are anticipating those samples will be written by people who don't).</P>
<P mce_keep="true">It makes the whole "T" thing really a myth most of the time, you know? :-)</P>
<P mce_keep="true">So I think we should go ahead and make sure it will compile both ways, and do the work in the makefile to make sure it happens. let's break the myth, at least for this particular sample at this particular moment....</P>
<P mce_keep="true">One way that some Platform SDK samples do this (like the <A class="" href="http://blogs.msdn.com/web/20080229133725/http://msdn.microsoft.com/library/en-us/vcsample98/html/vcsmpstrout.asp" mce_href="http://msdn.microsoft.com/library/en-us/vcsample98/html/vcsmpstrout.asp">StrOut sample</A>, for example) is in addition to the makefile, having a makefile.uni that looks something like this (this is the StrOut one):</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P mce_keep="true">#*************************************************************#<BR>#**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Microsoft RPC Samples&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strout Application&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Copyright(c) Microsoft Corp. 1992-1996&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#**&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#** This is the makefile used when compiling for UNICODE.&nbsp;&nbsp; **#<BR>#** It sets the flags it needs, and then call the regular&nbsp;&nbsp; **#<BR>#** makefile.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#** To compile for ANSI type nmake at the command line&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **#<BR>#*************************************************************#<BR># FILE : MAKEFILE.UNI<BR><BR>!include &lt;ntwin32.mak&gt;<BR><BR>#include support for unicode<BR>cflags = $(cflags) -D_UNICODE -DUNICODE<BR>midlflags = -D _UNICODE<BR><BR>#include library for CommandLineToArgvW function<BR>conlibsdll = $(conlibsdll) shell32.lib<BR><BR>!include &lt;makefile&gt;</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">Well, no COM and we don't use <A class="" href="http://blogs.msdn.com/web/20080229133725/http://msdn2.microsoft.com/library/ms647232.aspx" mce_href="http://msdn2.microsoft.com/library/ms647232.aspx">CommandLineToArgvW</A>, so we don't need exactly this. But it gives one example of how samples are doing this. We'll just go with it. :-)</P>
<P mce_keep="true">The cynical side of me believes that if this does end up in the Platform SDK that&nbsp;this will work up until the next time it is updated for some other particular feature, since the whole "dual compiling system" doesn't exactly fit us to a 'T'.....</P>
<P mce_keep="true">(other techniques here might include different config settings in the same makefile or environment variable dependencies, but&nbsp;I am aiming for the Platform SDK so doing it the way they seem to my work in my favor!)</P>
<P mce_keep="true">But in any case, the next source code drop will include an updated makefile and a new makefile.uni and instructions about using them.</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought you to</EM>&nbsp;<FONT size=6>ཅ</FONT> <EM>(<A class="" href="http://blogs.msdn.com/web/20080229133725/http://www.fileformat.info/info/unicode/char/0f45" mce_href="http://www.fileformat.info/info/unicode/char/0f45">U+0f45</A>, a.k.a. TIBETAN LETTER CA)</EM></FONT></P>
<hr/><p><a id="1404510" href="#1404510">#</a> <strong>Bart</strong> on Wednesday, January 03, 2007 7:48 AM:</p><div style="margin-left: 1em"><p>Is supporting both unicode and ansi worth the trouble ?</p></div>
<p><a id="1405090" href="#1405090">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, January 03, 2007 10:54 AM:</p><div style="margin-left: 1em"><p>Depends on who you mean to be asking for and in what context!</p></div>
<p><a id="1410731" href="#1410731">#</a> <strong>Mike Dimmick</strong> on Thursday, January 04, 2007 7:52 AM:</p><div style="margin-left: 1em"><p>Bart: that depends on whether you still need the resulting binary to work on Windows 9x. If you do, you have two options: you can either build for ANSI and use that build on both Win9x and NT-based systems, or you can build for Unicode and link to MSLU (unicows.lib). If you support both, you can change this decision relatively quickly.</p>
<p>You should be aware that running ANSI programs on NT-based systems causes all strings passed to ANSI Win32 APIs to be converted to Unicode at runtime, then those strings are passed to the equivalent Unicode API. On return, any modified strings have to be converted back. These conversions are pretty fast but still cost a little CPU time and memory. There are some scripts which do not have an ANSI encoding, and therefore ANSI programs will not work very well on Windows XP if one of these scripts is selected.</p>
<p>You could take the approach of building both an ANSI version and a Unicode version. This has been used by Windows Installer, which provides InstMsiA.exe and InstMsiW.exe installers (at least in version 2.0), while ATL.DLL (for ATL 3.0) comes in both versions, the installer installing the appropriate version depending on which OS it is installed on.</p>
<p>For this setup.exe, it's still possible that users of the sample will want to compile it to run on Windows 9x (even if only to provide a nice error message, rather than the unfriendly error that results from a missing export). However, in general I would expect to see Windows 9x support die out quite soon - aggregated web server statistics (e.g. at <a rel="nofollow" target="_new" href="http://blogs.msdn.com/web/20080229133725/http://marketshare.hitslink.com/report.aspx?qprid=5">http://marketshare.hitslink.com/report.aspx?qprid=5</a>) show Windows 98 with less than 2% usage share and declining. Obviously you should consider your own market to decide whether to support Windows 9x.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/12/24 <a href="http://archives.miloush.net/michkap/archive/2007/12/24/6843995.html">VS just got served!, aka The ??? Shift, aka 'Converting a project to Unicode???' No, it's 'Converting a project??? ToUnicode!!!'</a></p><p>2007/01/05 <a href="http://archives.miloush.net/michkap/archive/2007/01/05/1413001.html">Converting a project to Unicode: Part 9 (The project's postpartum postmortem)</a></p><p>2007/01/04 <a href="http://archives.miloush.net/michkap/archive/2007/01/04/1409380.html">Converting a project to Unicode: Part 8 (Fitting MSLU into the mix)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/01/04/1392691.html" title="Whither intl.inf in Vista?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/01/03/1392379.html" title="UTF-8 and GB18030 are both &#39;NT&#39; code pages, they just aren&#39;t &#39;ANSI&#39; code pages">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01-03">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/03/1395788.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>