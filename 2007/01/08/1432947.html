<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/08/1432947.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Using without registering [the source code]</title></head><body>
<h1>Using without registering [the source code]</h1>
<p><em>by Michael S. Kaplan, published on 2007/01/08 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/01/08/1432947.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM>(Boy, take out the bracketed piece of the title and it sounds&nbsp;almost sordid!)&nbsp;</EM></P>
<P>I believe I have mentioned the <A class="" href="http://msdn2.microsoft.com/library/system.globalization.cultureandregioninfobuilder.aspx" mce_href="http://msdn2.microsoft.com/library/system.globalization.cultureandregioninfobuilder.aspx">CultureAndRegionInfoBuilder class</A> before. It is the programmatic way to create custom cultures in the &gt;= 2.0 version of the .NET Framework, and also custom locales in Vista.</P>
<P>It has&nbsp;a very cool <A class="" href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.register.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.register.aspx">Register method</A> that will create the binary file containing that culture/locale information, put it in the right location, and add the registry keys so that it will be used.</P>
<P>However, this was not a good answer for <A class="" href="http://archives.miloush.net/michkap/archive/2006/02/21/535813.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/21/535813.html"><STRONG>Microsoft Locale Builder</STRONG></A>, which has to create install packages for people to be able to put their custom locales on other people's machines. They needed a way to create the file so they could register it on some other machine later (sometimes much later), in a setup that was not running managed code.</P>
<P>Now obviously&nbsp;the tool&nbsp;could have been written to call the <A class="" href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.register.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.register.aspx">Register method</A>, copy the file, and then quickly call the <A class="" href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.unregister.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/system.globalization.cultureandregioninfobuilder.unregister.aspx">Unregister method</A>, but this is pretty unwieldy, and also would require the user to be an administrator on the machine to even make use of the tool. All things considered, this is pretty ugly.</P>
<P>So the wise decision was made to have it use reflection to call an internal method to create the file in an arbitrary location for packaging. And because it would quite obnoxious to do this without telling potential tool writers who wanted to create their own "Locale Builder" type tools, so how to do it was described in a documented topic that <A class="" href="http://blogs.msdn.com/shawnste/" mce_href="http://blogs.msdn.com/shawnste/">Shawn</A> pointed to <A class="" href="http://blogs.msdn.com/shawnste/archive/2006/08/07/691257.aspx" mce_href="http://blogs.msdn.com/shawnste/archive/2006/08/07/691257.aspx">several months ago</A> entitled <A class="" href="http://msdn2.microsoft.com/library/ms404375.aspx" mce_href="http://msdn2.microsoft.com/library/ms404375.aspx">How to Save Custom Cultures Without Administrative Privileges</A>.</P>
<P>The biggest problem with the MSDN topic is that it isn't an example or a snippet or a sample; it is just a description of a technique. That's good enough for the parts that say "write this registry key" and such, but not so much when it is about using reflection to call internal methods....</P>
<P>I talked to Tarek about it and he agreed there was something missing here. It's not like reflection is ever easy without <EM>some</EM> assistance....</P>
<P>So anyway, here is a sample of how one can do&nbsp;the heard part of this&nbsp;-- creating the binary file that goes in the globalization subdirectory. Note that as the MSDN topic points out, if you don't add the registry keys it won't completely work right. But creating the registry keys, that part is easy, right?&nbsp;:-)</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P>using System;<BR>using System.IO;<BR>using System.Collections;<BR>using System.Reflection;<BR>using System.Globalization;<BR>using System.Text;<BR>using System.Runtime.Serialization;<BR>using System.Runtime.Serialization.Formatters.Binary;<BR><BR>class CaribReflection<BR>{<BR>&nbsp;&nbsp;&nbsp; private static void CreateNlpFile()<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CultureAndRegionInfoBuilder carib&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= new CultureAndRegionInfoBuilder("en-US", CultureAndRegionModifiers.Replacement);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Assembly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; assembly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= Assembly.GetAssembly(carib.GetType());<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cultureDefinitionType = assembly.GetType("System.Globalization.CultureDefinition");<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (cultureDefinitionType == null) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("System.Globalization.CultureDefinition.");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Environment.Exit(1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; BindingFlags&nbsp;&nbsp;&nbsp;&nbsp;bf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = BindingFlags.NonPublic |&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingFlags.Static |&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingFlags.Instance |&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BindingFlags.InvokeMethod;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ConstructorInfo cultureDefinitionCtr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; = cultureDefinitionType.GetConstructor((bf &amp; ~BindingFlags.Static), null, new Type[0], null);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; object&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cultureDefinitionObj&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= cultureDefinitionCtr.Invoke(bf, null, null, CultureInfo.InvariantCulture);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getDataFromCaribMethod&nbsp;&nbsp;&nbsp; = cultureDefinitionType.GetMethod("GetDataFromCultureAndRegionInfoBuilder", bf);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (getDataFromCaribMethod == null) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Couldn't get the method GetDataFromCultureAndRegionInfoBuilder from CultureDefinition class");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Environment.Exit(1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Object [] parameters = new Object[1] { carib };<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; getDataFromCaribMethod.Invoke(cultureDefinitionObj, bf, null, parameters, CultureInfo.InvariantCulture);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MethodInfo buildBinaryFileMethod&nbsp;= cultureDefinitionType.GetMethod("BuildBinaryFile", bf);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (buildBinaryFileMethod == null) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("Couldn't get the method BuildBinaryFile from CultureDefinition class");<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Environment.Exit(1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tempfile&nbsp;= Path.GetTempFileName();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FileStream&nbsp;fs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= new FileStream(tempfile,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileMode.Create,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileAccess.ReadWrite,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileShare.ReadWrite);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parameters = new Object[1] { fs };<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; buildBinaryFileMethod.Invoke(cultureDefinitionObj, bf, null, parameters, CultureInfo.InvariantCulture);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Flush();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fs.Close();<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine("The created Nlp file is: "+ tempfile);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (Exception e) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(e.Message);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Environment.Exit(1);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; static void Main(string[] args) {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(Environment.Version);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CreateNlpFile();<BR>&nbsp;&nbsp;&nbsp; }<BR>}</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">Now like I said, don't forget those registry keys. And <A class="" href="http://blogs.msdn.com/shawnste/archive/2006/08/07/691257.aspx" mce_href="http://blogs.msdn.com/shawnste/archive/2006/08/07/691257.aspx">Shawn's post</A> has some other really good advice you'll want to read.</P>
<P mce_keep="true">Otherwise, that's all you need.</P>
<P mce_keep="true">Though if you are writing your own "Locale Builder" tool, then I am a member of a team that would love to hear about it (some of us might even might love to try it out?). :-)</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=4>ᢞ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/189e" mce_href="http://www.fileformat.info/info/unicode/char/189e">U+189e</A>, a.k.a. MONGOLIAN LETTER MANCHU ALI GALI TTA)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/05/17 <a href="http://archives.miloush.net/michkap/archive/2007/05/17/2696800.html">A private CultureAndRegionInfoBuilder does not imply a private CultureInfo</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/01/08/1433251.html" title="Oceania doesn&#39;t document LOCALE_ITIMEMARKERUSE; Oceania has *never* documented LOCALE_ITIMEMARKERUSE">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/01/07/1431731.html" title="Buraian boitano nara dousuru?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/08/1432947.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>