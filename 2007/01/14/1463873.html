<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/14/1463873.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The 'in' process for out of process keyboard work</title></head><body>
<h1>The 'in' process for out of process keyboard work</h1>
<p><em>by Michael S. Kaplan, published on 2007/01/14 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/01/14/1463873.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>The question that came in from zafer was:</P>
<BLOCKQUOTE><FONT face="times new roman,times" size=2>
<P><EM>i have a problem to switch e.g. "notepad" keyboard layout with C# and interop WinAPI. If i used "ActiveKeyboardLayout" this switch only my application keyboard layout. I have writen a virtualkeyboard. In this program i switch the keyboard input over "SetForegroundWindow" with the handle of active window for example "notepad". What should i do for switching keyboard layout on other process. Can you help me. Thanks for this issue.</EM></P></FONT></BLOCKQUOTE>
<P>This question actually comes up quite often, but the answer is probably not going to make the person asking happy.</P>
<P>There is no way to change the active keyboard layout in another process or thread. This is why apps like the Language Bar have to have a presence in every thread in order to be able to get enough information to display the current layout as one moves among the various threads and processes.</P>
<P>Which sort of suggests the solution -- a <A class="" href="http://msdn2.microsoft.com/library/ms644990.aspx" mce_href="http://msdn2.microsoft.com/library/ms644990.aspx">SetWindowsHookEx</A> call and so on, to inject code into the thread so that you can have code&nbsp; running where it will have the right context. </P>
<P>But I would really recommend thinking quite carefully before going down that road since it certainly brings your code to a whole new level in terms of exposure and risk. Like making an unintended security bug into your code into something with system-wide availability? Or at a minimum putting a bit of managed code into every thread and process? Scary!</P>
<P>If you really wanted to go down that road, I would highly recommend creating a minimally sized DLL in C or C++&nbsp;with as few dependencies as possible, one that has no job except to communicate specific changes back and forth with the larger managed application that is acting as the virtual keyboard. Less to go wrong, less to burden all of the other processes with, and so on. If your final DLL is more than 10-20k then you should go back and try again....</P>
<P>And for the sake of everyone on the Internet, try to be at least 1000 times more careful than you would usually be, from a security standpoint. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>ÔºÅ</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/ff01" mce_href="http://www.fileformat.info/info/unicode/char/ff01">U+ff01</A>, a.k.a. FULLWIDTH EXCLAMATION MARK)</EM></FONT></P>
<hr/><p><a id="1465524" href="#1465524">#</a> <strong>Skip</strong> on 14 Jan 2007 9:53 AM:</p><div style="margin-left: 1em"><p>You definitely shouldn't use c# for anything you inject into another process. &nbsp;Since only one version of the CLR can be loaded per process this can cause all sorts of bad dependencies.</p>
<p>Old New Thing had a post on it awhile back, in the context of managed code for shell extensions, but the same warnings should apply here.</p></div>
<p><a id="1465632" href="#1465632">#</a> <strong>Haali</strong> on 14 Jan 2007 10:51 AM:</p><div style="margin-left: 1em"><p>Actually you can (ab)use WM_INPUTLANGCHANGEREQUEST. The documentation for that message says that DefWindowProc will do the needed changes, and indeed it works fine most of the time (I know it doesn't work for some input fields in Outlook).</p></div>
<p><a id="1466635" href="#1466635">#</a> <strong>Michael S. Kaplan</strong> on 14 Jan 2007 4:46 PM:</p><div style="margin-left: 1em"><P>Ah, problems with that message, though (like the fact that it is <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/05/16/598980.html">kind of broken now</A></STRONG> and not all apps will respect it anyway, as you pointed out). A globally (in the scope sense) relevant app/tool like a virtual keyboard can'r afford to only work sometimes....</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/10/11 <a href="http://archives.miloush.net/michkap/archive/2007/10/11/5397051.html">Rumor as prophecy in Win32</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/01/14/1464038.html" title="&#39;Where is the dictionary?&#39; you might ask">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/01/13/1460724.html" title="Output on customer input on MSLU&#39;s ReadConsoleInputW">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-01-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/01/14/1463873.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>