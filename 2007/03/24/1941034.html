<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/24/1941034.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It was déjà vu, man. Pure déjà vu....</title></head><body>
<h1>It was déjà vu, man. Pure déjà vu....</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/24 03:47 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/24/1941034.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>It happened some time ago. Right after the Community Server update on the blog, in fact.</P>
<P>I was bothered by the way that the links over on the right hand side were displayed in the order they were added, even though in the design interface they were sorted alphabetically.</P>
<P>This drove me nuts since the re-ordering buttons were gone and it was now a huge pain to sort them in the order you wanted given that the interface for adding them would never show the order they were going to be displayed in. I kind of gave up on ordering them, mostly -- too much of a pain in the ass.</P>
<P>But let me tell you, It was like déjà vu for me.</P>
<P>The whole problem --&nbsp;a user interface for modifying a list being in one order while the actual order it was an interface for being something else? I had definitely been there before....</P>
<P>The first time was a while back. </P>
<P>Long before Vista shipped, in fact.</P>
<P>Mike and I were going over to talk to a man named Dragos. </P>
<P>We were looking for some ideas on the best way to optimize an HKCU registry story that we couldn't get out of just yet, and if anyone could help us figure out how to make things go faster, everyone said it would be Dragos.</P>
<P>It was a great meeting, and one of the reasons that working at a place like Microsoft can be a lot of fun<FONT size=1><SUP>1</SUP></FONT>.</P>
<P>A bunch of good old fashioned developer geek brainstorming happened in that meeting, as we laid out what we were doing and what we had tried, and he suggested some things for us to try out that just might make things better.</P>
<P>One of the things he suggested had to do with the way registry values (i.e. the ones you would get from <A class="" href="http://msdn2.microsoft.com/library/ms724865.aspx" mce_href="http://msdn2.microsoft.com/library/ms724865.aspx">RegEnumValue</A>) were stored.</P>
<P>Turns out that the order you see in RegEdit is just a fluffy sort done in the tool, the actual order happens to be a FIFO kind of thing, with them stored in the order they are added. Changing a name keeps the position as it was, but renaming would delete and re-add and the value would be at the end of the list. And when you read values in from a function like <A class="" href="http://msdn2.microsoft.com/library/ms724911.aspx" mce_href="http://msdn2.microsoft.com/library/ms724911.aspx">RegQueryValueEx</A> or the new <A class="" href="http://msdn2.microsoft.com/library/ms724868.aspx" mce_href="http://msdn2.microsoft.com/library/ms724868.aspx">RegGetValue</A> (<A class="" href="http://blogs.msdn.com/larryosterman/" mce_href="http://blogs.msdn.com/larryosterman/">Larry Osterman</A>'s <A class="" href="http://blogs.msdn.com/larryosterman/archive/2006/01/12/512115.aspx" mce_href="http://blogs.msdn.com/larryosterman/archive/2006/01/12/512115.aspx">"favorite" Win32 API function</A> from last January), the OS scrolls through the values until it reaches the one you wanted (kinda what you'd have to do yourself if you were doing it yourself by calling good old <A class="" href="http://msdn2.microsoft.com/library/ms724865.aspx" mce_href="http://msdn2.microsoft.com/library/ms724865.aspx">RegEnumValue</A>, which is not a coincidence).</P>
<P>"Would it always be this way?" I wondered later in mail to Dragos, thinking about the comments in <A class="" href="http://blogs.msdn.com/oldnewthing/archive/2003/12/25/45926.aspx" mce_href="http://blogs.msdn.com/oldnewthing/archive/2003/12/25/45926.aspx">this</A> post of <A class="" href="http://blogs.msdn.com/oldnewthing/" mce_href="http://blogs.msdn.com/oldnewthing/">Raymond Chen</A>'s, where he <A class="" href="http://blogs.msdn.com/oldnewthing/archive/2003/12/25/45926.aspx#45972" mce_href="http://blogs.msdn.com/oldnewthing/archive/2003/12/25/45926.aspx#45972">warned</A>:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">There is no guarantee that the order of RegEnumValue will be "in order of creation". The registry code was tweaked for performance in Windows XP and I suspect it will be tweaked for performance in the future. One of these tweaks may change the order of enumeration, since that is unspecified.</FONT></EM></P></BLOCKQUOTE>
<P>and the Platform SDK documentation about the order in <A class="" href="http://msdn2.microsoft.com/library/ms724865.aspx" mce_href="http://msdn2.microsoft.com/library/ms724865.aspx">RegEnumValue</A>:</P>
<BLOCKQUOTE>
<P><EM><STRONG>dwIndex</STRONG><BR></EM>The index of the value to be retrieved. This parameter should be zero for the first call to the <B>RegEnumValue</B> function and then be incremented for subsequent calls. <BR><BR><EM><FONT color=#ff0000>Because values are not ordered, any new value will have an arbitrary index. This means that the function may return values in any order.</FONT></EM></P></BLOCKQUOTE>
<P>I was encouraged not to worry in our case, since </P>
<UL>
<LI>in the first place the docs here are pretty much just plain wrong. But since there is no UI that shows the actual order, so from a user's point of view, it really is kind of arbitrary, so it is not quite so wrong;</LI>
<LI>in the second place even if it did ever change,&nbsp;it would not happen in&nbsp;a service pack -- that would be a pretty&nbsp;big re-architecting;</LI>
<LI>in the third place,&nbsp;something like that&nbsp;would obviously be communicated widely to developers working on Windows in a future version.</LI></UL>
<P>So as long as we were willing to not cry foul later if we ended up having to rethink our optimization (due to the registry having had its architecture&nbsp;rethought), then there was no reason to worry (note that most people are not willing to do that, which is why Raymond's specific warnings in this case about undocumented behavior are completely true -- the unclear doc story tells people plain as day that they can really only rely on bubkes in the long run!).</P>
<P>I only mention it here because I know the people who read this blog are really smart. Like <A class="" href="http://dilbert.com/comics/dilbert/dnrc/" mce_href="http://dilbert.com/comics/dilbert/dnrc/">DNRC</A> smart. Never the kind of people who would only read the first half a paragraph while ignoring the warnings in the second half. </P>
<P>(Plus if somebody wanders in after a Google search who isn't as smart, someone can make them feel plenty foolish for not reading the whole thing, so it all works out!).</P>
<P>Now you may be wondering, if the original incident happened years ago and the one that inspired the deja vu happened a while go too, why I am taking about this now. Especially since neither story has much to do with the internationalization kind of posts I usually do.</P>
<P>The answer is that it is all a kind of a foundation sort of thing, one that I will be using as the basis for my next post.</P>
<P>Plus it makes for a good story, don't it? :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><EM><FONT size=1>1 - It is actually one of the things I like about <A class="" href="http://archives.miloush.net/michkap/archive/2007/03/13/1850613.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/13/1850613.html">my new job</A> -- I get to spend time&nbsp;in the same sort of meeting, and even get to be the person who is pointing out the best way to do things!</FONT></EM></P>
<P><EM><FONT color=#ff00ff></FONT></EM>&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> Й <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0419" mce_href="http://www.fileformat.info/info/unicode/char/0419">U+0419</A>, a.k.a. CYRILLIC CAPITAL LETTER SHORT I)</EM></FONT><FONT color=#ff00ff></FONT></P>
<hr/><p><a id="1949047" href="#1949047">#</a> <strong>Dean Harding</strong> on 25 Mar 2007 8:14 PM:</p><div style="margin-left: 1em"><p>I assume that the difference between your situation, though, and the warnings that people like Raymond give about assuming that undocumented or &quot;undefined&quot; behaviour will stay the same is that people write code that actually BREAKS when the change occurs. From what you've described, the only &quot;breakage&quot; would be that performance would suffer -- it'd still actually &quot;work&quot;...</p>
</div>
<p><a id="1949163" href="#1949163">#</a> <strong>Michael S. Kaplan</strong> on 25 Mar 2007 8:49 PM:</p><div style="margin-left: 1em"><P>Well, maybe - but one never knows what a new version will bring when you rely on such things.... and since performance regressions in this area historically lead to QFEs that we end up having to do, those <EM>are</EM> breaking from our point of view. :-)</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/03/13 <a href="http://archives.miloush.net/michkap/archive/2008/03/13/8174202.html">More than one kind of "alphabetical" order</a></p><p>2007/03/24 <a href="http://archives.miloush.net/michkap/archive/2007/03/24/1943944.html">It was déjà vu all over again, this time in quite an oymoronic way</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/24/1943944.html" title="It was déjà vu all over again, this time in quite an oymoronic way">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/23/1937085.html" title="Having a &#39;c09&#39; container clearly implies that one can contain an Aussie">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/24/1941034.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>