<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/20/1917161.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</title></head><body>
<h1>Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/20 03:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/20/1917161.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>So when I first posted <A class="" href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html"><STRONG>Double Secret ANSI, part 1 (Somewhere between ANSI and Unicode)</STRONG></A>, I was only a little bit surprised when regular reader Mihai knew where I was heading....</P>
<P><EM>(Mihai works for a company that produces some of those <STRONG>Double Secret ANSI applications</STRONG> I was talking about!)</EM></P>
<P>You see, we kind of broke some of those Double Secret ANSI applications in Vista.&nbsp;</P>
<P>I was a bit slow posting the follow-up as I waiting to see what the plans were. And Shawn has just posted about that in <A class="" href="http://blogs.msdn.com/shawnste/archive/2007/03/19/some-keyboards-fail-with-ansi-applications-on-windows-vista-rtm.aspx" mce_href="http://blogs.msdn.com/shawnste/archive/2007/03/19/some-keyboards-fail-with-ansi-applications-on-windows-vista-rtm.aspx">Some Keyboards fail with ANSI applications on Windows Vista RTM</A>, and about how a fix is being planned.</P>
<P>This is very cool, and I am sure we'll both be posting about the fix when it is available. It is a pretty bad bug.</P>
<P>How the bug happens is interesting though, so I thought I'd talk about that for a bit....</P>
<P>You see, at the point where a keyboard layout is loaded, the kernel mode keyboarding code thunks to a function that uses <A class="" href="http://msdn.microsoft.com/library/en-us/intl/unicode_2ovj.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/unicode_2ovj.asp">TranslateCharsetInfo</A> and the LANGID that is inside of the KLID (Keyboard Layout Identifier) of the keyboard. It gets the lsCsbDefault piece of the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A> and uses it for three purposes:</P>
<UL>
<LI>To decide whether to pass INPUTLANGCHANGE_SYSCHARSET in the WPARAM of the <A class="" href="http://msdn2.microsoft.com/library/ms632630.aspx" mce_href="http://msdn2.microsoft.com/library/ms632630.aspx">WM_INPUTLANGCHANGEREQUEST</A> notification<FONT size=1><SUP>1</SUP></FONT>;</LI>
<LI>To choose what goes in the WPARAM of the&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms632629.aspx" mce_href="http://msdn2.microsoft.com/library/ms632629.aspx">WM_INPUTLANGCHANGE</A> notification;</LI>
<LI>To have the code page to use for all ANSI/Unicode conversions that are needed for all non-Unicode applications.</LI></UL>
<P>&nbsp;It is that last bullet point that is where the power of <STRONG>double secret ANSI applications</STRONG> comes from. :-)</P>
<P>And it is that bug in a bunch of the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A> data in Vista that leads to the problems in those same applications for some keyboards :-(</P>
<P>Which is not to say that there aren't analogous bugs in the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/unicode_5ppu.asp">LOCALESIGNATURE</A> data in prior versions.</P>
<P>Because there are. Remember <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/28/728336.html">this post</A></STRONG>?</P>
<P>It is just that the values are much more broken in Vista. <EM>Did I mention that I am glad we are working to get this fixed?</EM></P>
<P>Though to be&nbsp;honest, in&nbsp;a future version I am going to try to look into simplifying this&nbsp;work a bit. I mean, rather than having user/k&nbsp;thunk to uer mode to call&nbsp;gdi32.dll&nbsp;so it can&nbsp;call&nbsp;kernel32.dll&nbsp;to retrieve&nbsp;what was originally loaded in kernel mode anyway&nbsp;to retrieve&nbsp;what has (historically speaking)&nbsp;been the single least&nbsp;reliable piece&nbsp;of&nbsp;locale data we ship, there are several links there that are simply not needed.</P>
<P>Talk about needless dependencies!</P>
<P>Especially when you consider the fact that it is incredibly difficult to ever retrieve the code page value that is being used in the keyboarding&nbsp;code&nbsp;at any later point in the use of the keyboard layout. I mean, what's a nice, honest <STRONG>double plus ANSI application</STRONG> supposed to do? :-)</P>
<P>There is probably a whole bunch more here that I can&nbsp;talk about&nbsp;another time, so if the topic is interesting to you then stay tuned....</P>
<P>About the only mildly reassuring point here is that most apps that don't support Unicode never do much beyond the default system code page. Which is not saying much.</P>
<P>For all of those <STRONG>double plus ANSI applications</STRONG>, sorry about that. This was not some kind of stunt to get people to write Unicode applications.</P>
<P mce_keep="true">&nbsp;</P>
<P><EM><FONT size=1>1 - More on the weirdnesses here beyond&nbsp;</FONT></EM><A class="" href="http://archives.miloush.net/michkap/archive/2006/05/16/598980.html" mce_href="http://archives.miloush.net/michkap/archive/2006/05/16/598980.html"><EM><FONT size=1><STRONG>these ones</STRONG></FONT></EM></A><EM><FONT size=1>&nbsp;another day.</FONT></EM></P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=3>–ê</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0410" mce_href="http://www.fileformat.info/info/unicode/char/0410">U+0410</A>, a.k.a. CYRILLIC CAPITAL LETTER A)</EM></FONT></P>
<hr/><p><a id="1918051" href="#1918051">#</a> <strong>ANSI is the bug</strong> on 20 Mar 2007 4:27 AM:</p><div style="margin-left: 1em"><p>It's always nice to fix bugs.</p>
<p>However, for this one in particular I almost feel it serves them (ANSI developers) right. While initially painful, I think a lot of good could come from depreciating ANSI in a very visual way. Whenever an ANSI application is executed, put up a really annoying message box saying something like &quot;This is an ANSI application. Some functionality will be reduced. Strongly suggest to the manufacturer to get in touch with the last decade.&quot;</p>
<p>Of course some applications can not be updated anymore. So leave the existing support. I think the with a significant user base complaining about this many companies would eventually upgrade to Unicode.</p></div>
<p><a id="1918970" href="#1918970">#</a> <strong>Michael S. Kaplan</strong> on 20 Mar 2007 7:16 AM:</p><div style="margin-left: 1em"><p>Well, it's one thing to make decisions that make a feature like &quot;ANSI&quot; support &nbsp;less desirable (e.g. Unicode-only locales, new functions that are Unicode only), but it is quite another to literally break something that used to work. That's just a line that I can't get comfortable crossing....</p>
</div>
<p><strong>Yuhong Bao</strong> on 31 Mar 2012 2:44 PM:</p><div style="margin-left: 1em"><p>&quot;Though to be honest, in a future version I am going to try to look into simplifying this work a bit. I mean, rather than having user/k thunk to uer mode to call gdi32.dll so it can call kernel32.dll to retrieve what was originally loaded in kernel mode anyway to retrieve what has (historically speaking) been the single least reliable piece of locale data we ship, there are several links there that are simply not needed.&quot;</p>
<p>There was a use-after-free in this code (see Keyboard Layout Object Use-After-Free (CVE-2011-1241)):</p>
<p><a rel="nofollow" target="_new" href="http://www.mista.nu/research/mandt-win32k-paper.pdf">www.mista.nu/.../mandt-win32k-paper.pdf</a></p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/01/16 <a href="http://archives.miloush.net/michkap/archive/2012/01/16/10256752.html">I'm reasonably certain that those who disagree with me here are wrong!</a></p><p>2011/04/04 <a href="http://archives.miloush.net/michkap/archive/2011/04/04/10149502.html">UXTheme in the non-Unicode world isn't "Double Secret ANSI"</a></p><p>2010/08/25 <a href="http://archives.miloush.net/michkap/archive/2010/08/25/10053944.html">Yet another cost to not supporting Unicode?</a></p><p>2008/10/15 <a href="http://archives.miloush.net/michkap/archive/2008/10/15/9000666.html">What is the freaking point of LOCALE_USE_CP_ACP?</a></p><p>2008/10/01 <a href="http://archives.miloush.net/michkap/archive/2008/10/01/8971160.html">What do you get when you put a Hebrew on top of a Russian? (aka What lies beneath can bite you on the ass)</a></p><p>2008/08/15 <a href="http://archives.miloush.net/michkap/archive/2008/08/15/8869343.html">Yet another time that UTF-8 can't be the ACP</a></p><p>2008/06/19 <a href="http://archives.miloush.net/michkap/archive/2008/06/19/8620349.html">How do[es what] the common controls [call ]convert between ANSI and Unicode?</a></p><p>2007/11/21 <a href="http://archives.miloush.net/michkap/archive/2007/11/21/6456609.html">Abobe knows, but someone needs to tell Skype....</a></p><p>2007/10/18 <a href="http://archives.miloush.net/michkap/archive/2007/10/18/5512709.html">Trying to get people to use Unicode? Lock and load, baby!</a></p><p>2007/08/13 <a href="http://archives.miloush.net/michkap/archive/2007/08/13/4376409.html">The font cold war?</a></p><p>2007/06/25 <a href="http://archives.miloush.net/michkap/archive/2007/06/25/3521939.html">Sometimes when you say 'the fix is in' you mean it in a good way</a></p><p>2007/05/07 <a href="http://archives.miloush.net/michkap/archive/2007/05/07/2464778.html">The Unicode train? It left the station....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/20/1917602.html" title="The lazy yet foxy jackdaw I love jumped over my quick brown sphinx dog of quartz">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/19/1912171.html" title="A way better model for features, part 2">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-20">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/20/1917161.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>