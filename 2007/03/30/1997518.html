<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/30/1997518.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Determining if a font is gonna get it done</title></head><body>
<h1>Determining if a font is gonna get it done</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/30 23:59 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/30/1997518.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Stuart asks:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2><I>
<P>I don't really know who else to ask this question so I'm hoping you know the answer or could find an answer for it. Uniscribe docs are somewhat lacking :(<BR><BR>We (Mozilla/Firefox) are using Uniscribe for text rendering now and everything works pretty well except in one case where we're trying to determine if a font had all the glyphs to render the string or not.<BR><BR>Certain fonts are giving us trouble. Constantia being a good offender. <BR><BR>We do something like:</P></I>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>
<P>HFONT hfont = CreateFontW(-12, 0, 0, 0, FW_NORMAL, FALSE, FALSE, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0, DEFAULT_CHARSET, OUT_SCREEN_OUTLINE_PRECIS, <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; CLIP_DEFAULT_PRECIS, DEFAULT_QUALITY, DEFAULT_PITCH,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; L"Constantia");<BR><BR>SelectObject(hdc,hfont);<BR><BR>SCRIPT_CACHE sc = NULL;<BR>SCRIPT_FONTPROPERTIES sfp;<BR><BR>sfp.cBytes = sizeof(sfp);<BR><BR>ScriptGetFontProperties(hdc, &amp;sc, &amp;sfp);<BR><BR>SCRIPT_ITEM *items;<BR>SCRIPT_CONTROL control;<BR>SCRIPT_STATE state;<BR>int nitems;<BR>WORD *glyphs;<BR>WORD *clusters;<BR>SCRIPT_VISATTR *attr;<BR><BR>memset(&amp;control, 0, sizeof(SCRIPT_CONTROL)); <BR>memset(&amp;state, 0, sizeof(SCRIPT_STATE)); <BR>state.uBidiLevel = 0; <BR>state.fOverrideDirection = 1;<BR><BR>int maxItems = 5;<BR>int nglyphs;<BR>WCHAR string[3] = { 0x20, // space -- is supported by font<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0x27c0, // three dimensioanl angle -- not supported<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0 };<BR><BR>items = (SCRIPT_ITEM *)malloc(10 * sizeof(SCRIPT_ITEM)); <BR><BR>ScriptItemize(string, 1, maxItems, &amp;control, &amp;state, items, &amp;nitems);<BR><BR>glyphs = (WORD *)malloc(10 * sizeof(WORD)); <BR>clusters = (WORD *)malloc(10 * sizeof(WORD)); <BR>attr = (SCRIPT_VISATTR*)malloc(10 * sizeof(SCRIPT_VISATTR)); <BR><BR>ScriptShape(hdc, &amp;sc, string, 2, 10, &amp;items[0].a, glyphs, clusters, attr, &amp;nglyphs);</P></B></FONT></BLOCKQUOTE><I>
<P>You end up with glyphs[0] and glyphs[1] both being 3.<BR><BR>&nbsp;&nbsp;&nbsp; wgBlank 3<BR>&nbsp;&nbsp;&nbsp; wgDefault 0<BR>&nbsp;&nbsp;&nbsp; wgInvalid 3<BR><BR>How do you tell that one is missing the one glyph and not the other one? I would expect glyphs[1] to be 0 here. Is there some flag I can set somewhere?<BR><BR>Maybe there is a much better way to tell if glyphs are missing.&nbsp; Something like GetGlyphIndicies's GCI_MARK_NONEXISTING_GLYPHS.&nbsp; That sure would be nice!<BR><BR>stuart</P></I></FONT></BLOCKQUOTE>
<P mce_keep="true">Well, I won't disagree that Uniscribe samples are <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/12/06/500485.html" mce_href="http://archives.miloush.net/michkap/archive/2005/12/06/500485.html">somewhat lacking</A></STRONG>, with <A class="" href="http://archives.miloush.net/michkap/archive/2006/03/11/549657.html" mce_href="http://archives.miloush.net/michkap/archive/2006/03/11/549657.html"><STRONG>some exceptions</STRONG></A>. </P>
<P mce_keep="true">Let's see if we can rehabilitate the above sample to make it work properly! :-)</P>
<P mce_keep="true">Luckily for me, I am right down the hall from the Typography team, so I was able to scoot down and talk to some people. And in this case I did not&nbsp;even have to scoot anywhere, as Sergey happened to be walking right by my office! :-)</P>
<P mce_keep="true">He took the sample above and was quickly able to determine what was going on:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM><FONT face="times new roman,times">This is an old code, that is controlled by psa-&gt;s.fDisplayZWG flag, that hides control characters. This font works like you describe because it does not contain ZWJ/ZWNJ. I do not know why this code is there, it precedes my time. With ScriptShape, workaround would be to set this flag to TRUE.<BR><BR>There are some problems if you use ScriptShape for checking if glyph is present in the font. It will show you if <STRONG>this combination of characters</STRONG> does not generate missing glyphs. But this may not be true for certain scripts, e.g. surrogates or Hangul. Have you considered ScriptGetCMap? It is less powerful (do not understand surrogates or advanced shaping), but will show you default glyphs without doing any "tricks".<BR><BR>Thanks,<BR>Sergey</FONT></EM></P></BLOCKQUOTE>
<P mce_keep="true">So, the workaround for the above code would be to add the following line after the <A class="" href="http://msdn2.microsoft.com/library/ms776521.aspx" mce_href="http://msdn2.microsoft.com/library/ms776521.aspx">ScriptItemize</A> call and before the <A class="" href="http://msdn2.microsoft.com/library/ms776517.aspx" mce_href="http://msdn2.microsoft.com/library/ms776517.aspx">ScriptShape</A> call:</P>
<BLOCKQUOTE>
<P mce_keep="true"><STRONG><FONT face="Consolas,Lucida Console,Courier New,Courier">items[0].a-&gt;s.fDisplayZWG = TRUE;</FONT></STRONG></P></BLOCKQUOTE>
<P mce_keep="true">Now taking a minute to talk about Sergey's other suggestion to consider -- using <A class="" href="http://msdn2.microsoft.com/library/ms776482.aspx" mce_href="http://msdn2.microsoft.com/library/ms776482.aspx">ScriptGetCMap</A> rather than <A class="" href="http://msdn2.microsoft.com/library/ms776517.aspx" mce_href="http://msdn2.microsoft.com/library/ms776517.aspx">ScriptShape</A>....</P>
<P mce_keep="true">The real problem is that (as Sergey mentioned)&nbsp;it is indeed less powerful.&nbsp;In addition to not being able to understand supplementary characters (which may or may not be a problem, depending), not being able to understand any of the cases where characters can be represented but not through a direct one-to-one connection between characters and glyphs can be blocking over large parts of Unicode. So one does give up a lot of functionality by going that route.</P>
<P mce_keep="true">In any case, setting the fDisplayZWG flag of the specific <A class="" href="http://msdn2.microsoft.com/library/ms776530.aspx" mce_href="http://msdn2.microsoft.com/library/ms776530.aspx">SCRIPT_STATE</A> struct will help the case in question work better, though keep in kind the intent of fDisplayZWG:</P>
<BLOCKQUOTE>
<P mce_keep="true"><EM>TRUE if control characters are shaped as representational glyphs. Typically, control characters are shaped to the blank glyph and given a width of 0.</EM></P></BLOCKQUOTE>
<P mce_keep="true">Note that this flag can have some unintended consequences if one is doing the actual rendering, especially if a font actually contains representational glyphs (which is usually not going to be the case). But for the requested purpose (checking for strings that can or cannot be represented by the font) it can actually do quite well....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> âŸ€ <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/27c0" mce_href="http://www.fileformat.info/info/unicode/char/27c0">U+27c0</A>, a.k.a. THREE DIMENSIONAL ANGLE)</EM></FONT></P></FONT>
<hr/><p><a id="2000755" href="#2000755">#</a> <strong>Lionel</strong> on 31 Mar 2007 12:01 PM:</p><div style="margin-left: 1em"><p>Time for some cleanup? Maybe this old code is not correct any more.</p></div>
<p><a id="2000803" href="#2000803">#</a> <strong>Michael S. Kaplan</strong> on 31 Mar 2007 12:20 PM:</p><div style="margin-left: 1em"><p>What makes you say that, Lionel?</p>
</div>
<p><a id="2002200" href="#2002200">#</a> <strong>KJK::Hyperion</strong> on 31 Mar 2007 8:34 PM:</p><div style="margin-left: 1em"><p>Ah-HA! that explains why, after installing Uniscribe, unpaired CRs and LFs don't generate a null glyph in notepad anymore!</p>
</div>
<p><a id="2021889" href="#2021889">#</a> <strong>Nobody Important</strong> on 3 Apr 2007 7:51 PM:</p><div style="margin-left: 1em"><p>This appears to be the bug:</p>
<p><a rel="nofollow" target="_new" href="https://bugzilla.mozilla.org/show_bug.cgi?id=376300">https://bugzilla.mozilla.org/show_bug.cgi?id=376300</a></p>
<p>Now fixed, thanked to Michael.</p></div>
<p><a id="2024653" href="#2024653">#</a> <strong>Michael S. Kaplan</strong> on 4 Apr 2007 5:33 AM:</p><div style="margin-left: 1em"><p>Well, like I said Sergey provided the actual info to fix it, I just facillitated things. :-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/31/1997869.html" title="There are no words">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/30/1995343.html" title="When a font looks like crap....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-30">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/30/1997518.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>