<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/25/1945659.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Will the real Unicode character message please stand up?</title></head><body>
<h1>Will the real Unicode character message please stand up?</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/25 03:05 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/25/1945659.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Over in the microsoft.public.win32.programmer.international newsgroup, Norman Diamond asks:</P>
<BLOCKQUOTE>
<P><A href="http://msdn2.microsoft.com/en-us/library/ms646288.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms646288.aspx"><FONT face="Times New Roman">http://msdn2.microsoft.com/en-us/library/ms646288.aspx</FONT></A><BR><FONT face="Times New Roman">*&nbsp; The WM_UNICHAR message is equivalent to WM_CHAR, but it uses Unicode<BR>*&nbsp; Transformation Format (UTF)-32, whereas WM_CHAR uses UTF-16. It is<BR>*&nbsp; designed to send or post Unicode characters to ANSI windows<BR><BR><EM>So both WM_UNICHAR and WM_CHAR use Unicode (though different varieties), but only one of these posts Unicode characters to ANSI windows?&nbsp; The other one posts a non-Unicode Unicode, or what?</EM><BR><BR>*&nbsp; If wParam is not UNICODE_NOCHAR, return FALSE. The Unicode DefWindowProc<BR>*&nbsp; posts a WM_CHAR message with the same parameters and the ANSI<BR>*&nbsp; DefWindowProc function posts either one or two WM_CHAR messages with the<BR>*&nbsp; corresponding ANSI character(s).<BR><BR><EM>So maybe the non-Unicode Unicode is one or two WM_CHAR messages with ANSI character(s) instead of UTF-16?<BR></EM><BR></FONT><A href="http://msdn2.microsoft.com/en-us/library/ms646276.aspx" mce_href="http://msdn2.microsoft.com/en-us/library/ms646276.aspx"><FONT face="Times New Roman">http://msdn2.microsoft.com/en-us/library/ms646276.aspx</FONT></A><BR><FONT face="Times New Roman">*&nbsp; The WM_CHAR message uses Unicode Transformation Format (UTF)-16.<BR><BR><EM>So the WM_CHAR message doesn't use ANSI.&nbsp; Or applications aren't supposed to expect ANSI from WM_CHAR, they're only supposed to get surprised if WM_UNICHAR was handled by DefWindowProc and resulted in ANSI?</EM></FONT></P></BLOCKQUOTE>
<P>I'll admit the documentation could be clearer here, but the behavior Norman was most confused about&nbsp;is not too hard to unravel:</P>
<UL>
<LI><STRONG>WM_UNICHAR</STRONG> is always sent as UTF-32 any time a WNDPROC gets it as a message -- so in the case where you are being sent a Unicode code point value representing a supplementary character, you will get just one of these messages<FONT size=1><SUP>1</SUP></FONT>; 
<LI><STRONG>WM_CHAR</STRONG> to a Unicode WNDPROC is always sent as UTF-16; 
<LI><STRONG>WM_CHAR</STRONG> to an ANSI WNDPROC is always sent in the code page associated with the KLID, not the HKL, as discussed in <A href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html" mce_href="http://archives.miloush.net/michkap/archive/2007/03/08/1838231.html"><STRONG>this post</STRONG></A>.</LI></UL>
<P>However, the text here around the wParam&nbsp;has some real problems too, though in defense of the doc writers for this case, the BEHAVIOR is quite confusing here. The full text is:</P>
<BLOCKQUOTE>
<P><I>wParam<BR><BR></I>Specifies the character code of the key. <BR><BR>If <I>wParam</I> is UNICODE_NOCHAR and the application processes this message, then return TRUE. The <A href="http://msdn2.microsoft.com/ms633572.aspx" mce_href="http://msdn2.microsoft.com/ms633572.aspx">DefWindowProc</A> function will return FALSE (the default). <BR><BR>If <I>wParam</I> is not UNICODE_NOCHAR, return FALSE. The Unicode&nbsp;<B>DefWindowProc</B> posts a <B>WM_CHAR</B> message with the same parameters and the ANSI&nbsp;<B>DefWindowProc</B> function posts either one or two <B>WM_CHAR</B> messages with the corresponding ANSI character(s). </P></BLOCKQUOTE>
<P>&nbsp;And the return value info is:</P>
<BLOCKQUOTE>
<P>An application should return zero if it processes this message.</P></BLOCKQUOTE>
<P>Now all of this resembles English but it is a bit more complicated. :-)</P>
<P>First of all, the wParam info talks about returning FALSE or TRUE when the return value info keeps you focused on the fact that the return is going to be 0 or not.</P>
<P>Second of all, if it is a supplementary character, a Unicode WNDPROC will get <STRONG>two</STRONG> WM_CHAR message, not one.</P>
<P>But what is the point of the rest of the text?</P>
<P>What is is <STRONG>really</STRONG> trying to say is that the only time it is okay to&nbsp;return 0 (FALSE) is when what was passed was not a character (wParam is UNICODE_NOCHAR). Otherwise, you should always&nbsp;return TRUE for this function.</P>
<P>But how easy is it to glean that from the text given? Not very....</P>
<P><FONT size=1><EM>1 - To be perfectly honest, it is unclear to me how often this will be true for non-CJK supplementary characters, since the text that goes through user/userk keyboard layout dlls is using two UTF-16 code points in the form of a "keyboard ligature" and whether it is smart enough to make those two UTF-16s into one UTF-32 is an unknown....</EM></FONT></P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff0080><EM>This post brought to you by</EM> ê†Å <EM>(<A href="http://www.fileformat.info/info/unicode/char/10801" mce_href="http://www.fileformat.info/info/unicode/char/10801">U+10801</A>, a.k.a. CYPRIOT SYLLABLE E)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/05/21 <a href="http://archives.miloush.net/michkap/archive/2012/05/21/10308135.html">Whither WM_UNICHAR in Windows 7 (and 8!)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/25/1948887.html" title="What&#39;s the problem with MapVirtualKey[Ex], on CE and otherwise?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/24/1943944.html" title="It was d√©j√† vu all over again, this time in quite an oymoronic way">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-25">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/25/1945659.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>