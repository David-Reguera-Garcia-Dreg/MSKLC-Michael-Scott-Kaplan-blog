<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/05/1810677.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>It's not just returning 1; it's returning -1</title></head><body>
<h1>It's not just returning 1; it's returning -1</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/05 11:25 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/05/1810677.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A not-so-uncommon question people ask is why <A class="" href="http://msdn2.microsoft.com/library/ms646320.aspx" mce_href="http://msdn2.microsoft.com/library/ms646320.aspx">ToUnicode</A> and <A class="" href="http://msdn2.microsoft.com/library/ms646322.aspx" mce_href="http://msdn2.microsoft.com/library/ms646322.aspx">ToUnicodeEx</A> return -1 when the string that they return is a dead key.</P>
<P>I mean, especially since the return value in&nbsp;all other&nbsp;cases gives you an actual size of the buffer that is returned. Doesn't it seem kind of weird or unsafe to not do <STRONG>that</STRONG> correctly?</P>
<P>Well, not so much. It is okay.</P>
<P>The problem is the same one that causes <A class="" href="http://msdn2.microsoft.com/library/ms646276.aspx" mce_href="http://msdn2.microsoft.com/library/ms646276.aspx">WM_CHAR</A> and <A class="" href="http://msdn2.microsoft.com/library/ms646277.aspx" mce_href="http://msdn2.microsoft.com/library/ms646277.aspx">WM_DEADCHAR</A> to be two different messages -- the fact that they mean two very different things.</P>
<P>When a dead key has been pressed, no actual input is really ready for entry anywhere -- on Windows you see nothing at all when you press the dead key, so you really want whatever might tell you about the input to differentiate it from the times that there is something that should be showing up.</P>
<P>I always thought of the negative value as meaning that there is ONE character, but it is NOT visible. And in the current implementation there is only one WCHAR returned. Though the text is a bit optimistic in the documentation:</P>
<BLOCKQUOTE>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">The specified virtual key is a dead-key character (accent or diacritic). This value is returned regardless of the keyboard layout, even if several characters have been typed and are stored in the keyboard state. If possible, even with Unicode keyboard layouts, the function has written a spacing version of the dead-key character to the buffer specified by <I>pwszBuff</I>. For example, the function writes the character SPACING ACUTE (0x00B4), rather than the character NON_SPACING ACUTE (0x0301).</FONT></P></BLOCKQUOTE></BLOCKQUOTE>
<P>Notice that claim in the last sentence? While completely true of most Microsoft-provided keyboards, it is not something that is enforced; it is not even currently a validation warning in MSKLC (though now that I think about it maybe it should be in a future version, if for no other reason than the documentation is making such a bold claim about the matter).</P>
<P>Now imagine one day there was some kind of attempt to address that whole limitation on chained dead keys I talked about <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/11/15/492200.html" mce_href="http://archives.miloush.net/michkap/archive/2005/11/15/492200.html">previously</A></STRONG>. Maybe you would want <A class="" href="http://msdn2.microsoft.com/library/ms646320.aspx" mce_href="http://msdn2.microsoft.com/library/ms646320.aspx">ToUnicode</A> and <A class="" href="http://msdn2.microsoft.com/library/ms646322.aspx" mce_href="http://msdn2.microsoft.com/library/ms646322.aspx">ToUnicodeEx</A>&nbsp;to return everything in the "state buffer" that was pending, in which case it could sometimes need to return -2 or -3 or whatever.</P>
<P>On the other hand that would probably break everyone using the function, right?</P>
<P>Well, unless some special wFlag value was passed to indicate the behavior change was wanted of course....</P>
<P>For now, we'll assume that no one in a position to accomplish the impossible is actually going to attempt to do so, and just live with that -1. And not try to come up with a changed model definition of why it work the way it does, We'll just shake our heads at the weird wFlag description that is worded as if there was a plan to extend the function some day and move along.</P>
<P>Now if we could just get a "don't muck with the state" flag so that calling the function could be optionally used to probe the contents without actually affecting the buffer. :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5> Ì›</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/031b" mce_href="http://www.fileformat.info/info/unicode/char/031b">U+031b</A>, a.k.a. COMBINING HORN)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/04/16 <a href="http://archives.miloush.net/michkap/archive/2011/04/16/10154700.html">Chain Chain Chain, Chain of Dead Keys</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/06/1812744.html" title="The T&#39;s are crossed, but not all of the I&#39;s are dotted...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/05/1807683.html" title="You&#39;re not the one out of sequence, and that&#39;s the Word">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/05/1810677.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>