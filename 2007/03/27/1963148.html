<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/27/1963148.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>GPOS w/o GSUB in a TTF on XP SP2 can be FUBAR</title></head><body>
<h1>GPOS w/o GSUB in a TTF on XP SP2 can be FUBAR</h1>
<p><em>by Michael S. Kaplan, published on 2007/03/27 08:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/03/27/1963148.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM>(This post might win an award for&nbsp;strangest&nbsp;title, unless you deal with&nbsp;OpenType!)&nbsp;</EM></P>
<P>The <A class="" href="http://msdn2.microsoft.com/library/ms534004.aspx" mce_href="http://msdn2.microsoft.com/library/ms534004.aspx">GetCharacterPlacement</A> function in GDI has been around since Windows 95/NT 4.0, and the truth is that the number of people who use it probably outnumber the number of people who have read my <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/09/23/472656.html" mce_href="http://archives.miloush.net/michkap/archive/2005/09/23/472656.html">Stick a fork in GetCharacterPlacement</A></STRONG> post from the Fall of 2005.</P>
<P>In fact, it is likely that the number of people who use it probably also outnumber the number of people who bothered to read the Platform SDK topic thast points out:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Although this function was once adequate for working with character strings, a need to work with an increasing number of languages and scripts has rendered it obsolete. It has been superseded by the functionality of the Uniscribe module. For more information, see Uniscribe.</FONT></P></BLOCKQUOTE>
<P>and</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Note that GetCharacterPlacement does not produce the same results for Kashida and justification on Windows 98/Me as it does on Windows NT/2000/XP. To achieve consistency across all operating systems, use Uniscribe. </FONT></P></BLOCKQUOTE>
<P mce_keep="true">So even though it is mostly superceded and it cab often return less than ideal results, people still use it, and people still want to use it.</P>
<P mce_keep="true">Why just the other day, Dave asked a question to the UniScribe gurus:</P>
<BLOCKQUOTE>
<P mce_keep="true">Hi all,<BR><BR>We have a customer reporting that GetCharacterPlacementW started failing when he upgraded to XPSP2 (from XPSP1) when it was used with certain fonts.&nbsp; Further examination shows the failing fonts to contain Postscript outlines, but I’m not sure if that’s the cause.<BR><BR>GetCharacterPlacement works with these fonts fine in Vista and, as noted above, worked fine in XPSP1.<BR><BR>GetLastError doesn’t report anything, but the problem looks to be in USP10!ScriptStringAnalyse…</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="courier new,courier"><STRONG>0:000&gt; kb<BR><BR>ChildEBP RetAddr&nbsp; Args to Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <BR>0012fb90 629c48f2 be010a7e 0044526c 00000006 USP10!ScriptStringAnalyse+0x264 [d:\xpsprtm\windows\core\cslpk\usp\api.cxx @ 3556]<BR>0012fbdc 629c3a41 be010a7e 0044526c 00000006 LPK!LpkStringAnalyse+0xfd [d:\xpsprtm\windows\core\cslpk\lpk\lpk_usp.cxx @ 168]<BR>0012fc4c 77f3dd0f be010a7e 0044526c 00000006 LPK!LpkGetCharacterPlacement+0x1c7 [d:\xpsprtm\windows\core\cslpk\lpk\lpk_gdi.cxx @ 980]<BR>0012fc80 004012b4 be010a7e 0044526c 00000006 GDI32!GetCharacterPlacementW+0x76 [d:\nt\windows\core\ntgdi\client\dcquery.c @ 1334]<BR>0012ff54 00405213 00000001 008c35f8 008c3680 GetCharacterPlacement!main+0x1f4 [c:\repro\getcharacterplacement\getcharacterplacement.c @ 109]<BR>0012ffb8 00404fdd 0012fff0 7c816fd7 0121f6f2 GetCharacterPlacement!__tmainCRTStartup+0x233 [f:\sp\vctools\crt_bld\self_x86\crt\src\crt0.c @ 327]<BR>0012ffc0 7c816fd7 0121f6f2 0121f78a 7ffdc000 GetCharacterPlacement!mainCRTStartup+0xd [f:\sp\vctools\crt_bld\self_x86\crt\src\crt0.c @ 196]<BR>0012fff0 00000000 00404fd0 00000000 78746341 kernel32!BaseProcessStart+0x23 [d:\nt\base\win32\client\support.c @ 576]<BR><BR>0:000&gt; r<BR>eax=80004005 (E_FAIL) ebx=00000200 ecx=74dd5030 edx=00000001 esi=80004005 edi=be010a7e<BR>eip=74da42b7 esp=0012fb84 ebp=0012fb90 iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nv up ei pl zr na pe nc<BR>cs=001b&nbsp; ss=0023&nbsp; ds=0023&nbsp; es=0023&nbsp; fs=003b&nbsp; gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; efl=00000246<BR>USP10!ScriptStringAnalyse+0x264:<BR>74da42b7 5b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pop&nbsp;&nbsp;&nbsp;&nbsp; ebx</STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Is anybody familiar with what may have changed around SP2 to effect this (a security fix perhaps)?&nbsp;&nbsp;&nbsp;&nbsp; Is this our bug (i.e. should this always return success with Postscript fonts if the fonts/parameters are valid)?<BR><BR>Thanks!<BR><BR>Dave</P></BLOCKQUOTE>
<P mce_keep="true">Well, both Dave and the customer are correct, there was a change here. Sergey&nbsp;was quick to point out the issue:</P>
<BLOCKQUOTE>
<P mce_keep="true"><FONT face="times new roman,times"><EM>In XPSP2 we started applying standard OpenType features in Uniscribe. There is known problem with fonts that have GPOS table, but not GSUB. This has nothing to do with font outline type. If this is their own font or they can work with font vendor, this is enough to add dummy GSUB table with Latin script without any features.<BR><BR>This bug is fixed in Vista.</EM></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Now this is not just a&nbsp;<A class="" href="http://msdn2.microsoft.com/library/ms534004.aspx" mce_href="http://msdn2.microsoft.com/library/ms534004.aspx">GetCharacterPlacement</A> issue, but just like a person with a busted tail light is more likely to be someone without a license or other problems (a fact vlidated by police officers every day!), it is someone who is not using the latest rendering technologies is more likely to be using a font without all of the OpenType tables in it. :-)</P>
<P mce_keep="true"><EM>(I apologize for that truly ridiculous analogy, it really was beneath me!)</EM></P>
<P mce_keep="true">For some, the moral of the story is that if you are using XP, SP2 or later, then be careful about having a GPOS (Glyph Positioning)&nbsp;table without a GSUB (Glyph Substitution)&nbsp;table!</P>
<P mce_keep="true">Maybe for&nbsp;others the moral of the story is to upgrade to Vista? :-)</P>
<P mce_keep="true">But for me, the moral of the story is simple -- please move on past <A class="" href="http://msdn2.microsoft.com/library/ms534004.aspx" mce_href="http://msdn2.microsoft.com/library/ms534004.aspx">GetCharacterPlacement</A>. As much as can be done to try to keep it up to date a more work is done in text rendering, it will still have problems doing everything. And the gap is onloy going to get wider....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> ䷲ <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/4df2" mce_href="http://www.fileformat.info/info/unicode/char/4df2">U+4df2</A>, a.k.a. HEXAGRAM FOR THE AROUSING THUNDER)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/03/28/1972239.html" title="A yen for Yen may be left unsatiated">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/03/27/1962027.html" title="Another post about providing font samples">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-03-27">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/03/27/1963148.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>