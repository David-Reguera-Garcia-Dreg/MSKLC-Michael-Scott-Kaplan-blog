<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/16/4937196.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A&P of Sort Keys, part 6 (aka Relax, be calm, and deCOMPRESS if you are feeling out of sorts)</title></head><body>
<h1>A&P of Sort Keys, part 6 (aka Relax, be calm, and deCOMPRESS if you are feeling out of sorts)</h1>
<p><em>by Michael S. Kaplan, published on 2007/09/16 03:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/09/16/4937196.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous posts in this series:</P>
<UL>
<LI>Part 0: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html">The empty string sorts the same in every language</A></STRONG> 
<LI>Part 1: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html">The law of the letter -- e.g. Latin &lt; Greek &lt; Cyrillic</A></STRONG> 
<LI>Part 2: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html"><STRONG>The string that won? Didn't have a mark on him!</STRONG></A> 
<LI>Part 3: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html"><STRONG>Should you let a string make it's case? If so, Y?</STRONG></A> 
<LI>Part 4: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html"><STRONG>It isn't a race but let's make an EXCEPTION and cross the Finnish line</STRONG></A></LI>
<LI>Part 5: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html"><STRONG>EXPANSIONing your horizons</STRONG></A></LI></UL>
<P>In that most recently posted <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html"><STRONG>Part 5</STRONG></A>, the core idea was a feature that allowed one code point to be treated as two (or effectively more) sort elements -- what normal people think of as <STRONG>characters</STRONG>.</P>
<P>This post is going to take things in the opposite direction, and talk about the way to get two or more code points to be thought of as a single element.</P>
<P>At Microsoft we call this feature compressions, and we basically keep per&nbsp;unique sort&nbsp;<STRONG>COMPRESSION</STRONG> tables.</P>
<P>As names go, this one is kind of unfortunate; in the <A class="" href="http://www.unicode.org/reports/tr10/" mce_href="http://www.unicode.org/reports/tr10/">Unicode Collation Algorithm</A> they are instead called contractions, which in my opinion is a better name -- since if there is anything one wants to be able to do with sort keys, it is usually to compress them so they take up less space!</P>
<P>On the other hand we don't provide any functionality or documentation or even hints on how one might compress sort keys, so perhaps the terminological overlap is not too much of a worry. :-)</P>
<P mce_keep="true">Now as I mentioned yesterday, COMPRESSIONS and EXPANSIONS are mutually exclusive -- if you are in the code path of one, you won't be in the code path of another. This is an unfortunate side effect of the implementation that is being tracked as a bug since it would help a few interesting side cases get fixed if it was not true....</P>
<P mce_keep="true">Also, as long as we are collecting COMPRESSION factoids, we have specific convention for how they work with casing, as I mentioned in <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/17/439742.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/17/439742.html"><STRONG>A Microsoft convention for compressions in sorting</STRONG></A>&nbsp;-- they can be UU, LL, or UL, but not LU....</P>
<P mce_keep="true">Oh, and there is also the fact that we have no "default table" compressions. Now&nbsp;the reason for this is performance -- the code path that uses compressions is slightly slower, so making people whose languages do not have any of these things work a little slower just so languages they don't use sort more intuitively for people who aren't them. :-)</P>
<P mce_keep="true">Though as I think about, it would be cool to have an option for a "DEFAULT PLUS" table that included all of the language-specific compressions that did not conflict with each other. With that option most of the locale-specific compressions would go away!</P>
<P mce_keep="true">But anyway, let's look at some examples, shall we?</P>
<P mce_keep="true">Looking first at the default table:</P>
<BLOCKQUOTE><FONT face="consolas,lucida console,courier new,courier"><B>
<P mce_keep="true">en-US a&nbsp; <FONT color=#009900>0e 02</FONT> 01 01 01 01 00<BR>en-US aa <FONT color=#009900>0e 02</FONT> <FONT color=#009900>0e 02</FONT> 01 01 01 01 00<BR>en-US&nbsp;å&nbsp;&nbsp;<FONT color=#009900>0e 02</FONT> 01 <FONT color=#ff0000>1a</FONT> 01 01 01 00<BR>en-US b&nbsp; <FONT color=#009900>0e 09</FONT> 01 01 01 01 00<BR>en-US z&nbsp; <FONT color=#009900>0e a9</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">And then compare it to Danish (but not Norwegian, due to <A class="" href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html" mce_href="http://archives.miloush.net/michkap/archive/2006/04/27/584439.html"><STRONG>The disunification of Norwegian and Danish sorting</STRONG></A>!):</P>
<BLOCKQUOTE><FONT face="consolas,lucida console,courier new,courier"><B>
<P mce_keep="true">da-DK a&nbsp; <FONT color=#009900>0e 02</FONT> 01 01 01 01 00<BR>da-DK aa <FONT color=#009900>0e b1</FONT> 01 <FONT color=#ff0000>03</FONT> 01 01 01 00<BR>da-DK å&nbsp;&nbsp;<FONT color=#009900>0e b1</FONT> 01 01 01 01 00<BR>da-DK b&nbsp; <FONT color=#009900>0e 09</FONT> 01 01 01 01 00<BR>da-DK z&nbsp; <FONT color=#009900>0e a9</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">See how <STRONG>aa</STRONG> is being put over at the end of the alphabet, after <STRONG>z</STRONG>? And how it is almost identical to <STRONG>å</STRONG> but with a little extra diacritic weight?</P>
<P mce_keep="true">Which I guess points out another factoid -- you can include all of the appropriate case and diacritic weights&nbsp; you want to as well, in the COMPRESSION table entries.</P>
<P mce_keep="true">Sometimes, the compression table entries can get quite complicated -- such as some of the Indic scripts, which have at times 4-to-1 or even 5-to-1 compressions. Or Tibetan, which even has some 8-to-1 compressions in it. Though in most languages there are not too many of them.</P>
<P mce_keep="true">Another interesting thing you can do is one that we use for languages like Tamil that have a Virama that they use to suppress the inherent vowel, when they consider the letter with the Virama to sort before the letter without it (as I discuss in <A class="" href="http://archives.miloush.net/michkap/archive/2005/04/09/406765.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/09/406765.html"><STRONG>And then there is the Virama....</STRONG></A>). You can treat the letter + Virama as one letter, and make it come before the letter without the virama. Like so (in Vista):</P>
<BLOCKQUOTE><FONT face="consolas,lucida console,courier new,courier"><B>
<P mce_keep="true">ta-IN க் U+0b95 U+0bcd <FONT color=#009900>37 26</FONT> 01 01 01 01 00<BR>ta-IN க U+0b95&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<FONT color=#009900>37 28</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">With the COMPRESSION feature, such support is easy to deliver (the opposite case where they combine is also easy, but there are other ways that could be made to work).</P>
<P>Which reminds me, I have to point out where we are on the size front:</P>
<UL>
<LI>
<DIV mce_keep="true">As described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html"><STRONG>Part 0</STRONG></A>, every sort key has a fixed overhead of five bytes per sort key;</DIV>
<LI>
<DIV mce_keep="true">According to <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html"><STRONG>Part 1</STRONG></A>, most of Unicode will give you two bytes of primary weight per character;</DIV>
<LI>
<DIV mce_keep="true">As described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html"><STRONG>Part 2</STRONG></A>, no matter how many diacritics you pile on a character, it will never add more than one byte per character;</DIV>
<LI>
<DIV mce_keep="true">As also described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html"><STRONG>Part 2</STRONG></A>, the need to pad in order to have the diacritic weights line up can actually add one additional byte per character preceding one with a diacritic.</DIV></LI>
<LI>
<DIV mce_keep="true">As described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html"><STRONG>Part 3</STRONG></A>, case can work the same way as the last point -- needing padding to let the case weights line up.</DIV></LI>
<LI>
<DIV mce_keep="true">As described in <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html"><STRONG>Part 4</STRONG></A>, EXPANSIONS cause the size of a Unicode weight to be between 2 and 3 times bigger (thus 4 or 6 bytes instead of 2 per letter).</DIV></LI>
<LI>
<DIV mce_keep="true">As described in this part, COMPRESSIONS can actually shrink the sort key from any of the previous discussions -- in the most extreme cases treating eight code point as if they were a single letter.</DIV></LI></UL>
<P mce_keep="true">And there you have it. Stay tuned for the next exciting collation feature....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>5</FONT> </FONT><EM><FONT color=#ff00ff>(</FONT><A class="" href="http://www.fileformat.info/info/unicode/char/0035" mce_href="http://www.fileformat.info/info/unicode/char/0035">U+0035</A><FONT color=#ff00ff>, DIGIT FIVE)</FONT></EM></P>
<hr/><p><a id="4942132" href="#4942132">#</a> <strong>kevinowen</strong> on 16 Sep 2007 11:07 AM:</p><div style="margin-left: 1em"><p>Is it intentional that this post isn’t sponsored by U+0036?</p>
</div>
<p><a id="4942876" href="#4942876">#</a> <strong>Michael S. Kaplan</strong> on 16 Sep 2007 11:42 AM:</p><div style="margin-left: 1em"><p>I wanted to see if anyone would notice. :-)</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/09/13 <a href="http://archives.miloush.net/michkap/archive/2010/09/13/10060986.html">Olive, the other reindeer, gets to Sort it all Out too....</a></p><p>2009/09/14 <a href="http://archives.miloush.net/michkap/archive/2009/09/14/9894607.html">What is impossible for Microsoft can be simply undesireable for Unicode</a></p><p>2008/08/21 <a href="http://archives.miloush.net/michkap/archive/2008/08/21/8883467.html">A&P of Sort Keys, part 14: The Hangul is really getting OLD</a></p><p>2008/01/25 <a href="http://archives.miloush.net/michkap/archive/2008/01/25/7228941.html">On reversing the irreversible (grabbing the data, part I)</a></p><p>2007/10/09 <a href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html">A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</a></p><p>2007/10/08 <a href="http://archives.miloush.net/michkap/archive/2007/10/08/5270854.html">A&P of Sort Keys, part 12 (aka Han sorts first!)</a></p><p>2007/09/24 <a href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html">A&P of Sort Keys, part 11 (aka It's not like ideographic sorts were developed idiopathically)</a></p><p>2007/09/21 <a href="http://archives.miloush.net/michkap/archive/2007/09/21/5027338.html">A&P of Sort Keys, part 10 (aka I've kana wanted to start talking about Japanese)</a></p><p>2007/09/20 <a href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html">A&P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)</a></p><p>2007/09/18 <a href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html">A&P of Sort Keys, part 8 (aka You can often think of ignoring weights as a form of ignorance)</a></p><p>2007/09/17 <a href="http://archives.miloush.net/michkap/archive/2007/09/17/4950008.html">A&P of Sort Keys, part 7 (aka You're very thin now, but I can still recognize you)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/09/16/4937355.html" title="Becoming part of the ANTI-social?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/09/16/4934342.html" title="Perhaps they don&#39;t quite get it just yet, #2">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/16/4937196.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>