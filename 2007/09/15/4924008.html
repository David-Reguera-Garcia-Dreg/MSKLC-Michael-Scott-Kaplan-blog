<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/15/4924008.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A&P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</title></head><body>
<h1>A&P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</h1>
<p><em>by Michael S. Kaplan, published on 2007/09/15 03:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/09/15/4924008.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Previous posts in this series:</P>
<UL>
<LI>Part 0: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html">The empty string sorts the same in every language</A></STRONG> 
<LI>Part 1: <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/11/4861436.html">The law of the letter -- e.g. Latin &lt; Greek &lt; Cyrillic</A></STRONG> 
<LI>Part 2: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/12/4875560.html"><STRONG>The string that won? Didn't have a mark on him!</STRONG></A> 
<LI>Part 3: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/13/4889199.html"><STRONG>Should you let a string make it's case? If so, Y?</STRONG></A></LI>
<LI>Part 4: <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html"><STRONG>It isn't a race but let's make an EXCEPTION and cross the Finnish line</STRONG></A></LI></UL>
<P>In older posts in the blog here (such as <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/19/440320.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/19/440320.html"><STRONG>these</STRONG></A> <A class="" href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/20/440842.html"><STRONG>two</STRONG></A>) I have talked about SORT ELEMENTS, even going so far a to define them:</P>
<BLOCKQUOTE>
<P><FONT face=Tahoma><EM>A sort element is a code point or combination of code points that a user thinks of as a character.</EM></FONT></P></BLOCKQUOTE>
<P>Now in this series the definition has not yet been all that relevant since with the exception of&nbsp;<STRONG><U><FONT color=#800080>Part 2</FONT></U></STRONG> each WCHAR in the string was really a letter in the user's mind, and even in <STRONG><U><FONT color=#800080>Part 2</FONT></U></STRONG>&nbsp;I was clearly talking about combining characters that were diacritic marks, and showed how they were equal to&nbsp;some precomposed characters anyway.</P>
<P>Well now we are doing to change all that, and talk about EXPANSIONS, where a single code point can map to up to three different letters (in the underlying implementation it is only two, but some of them are nested so the net effect&nbsp;for collation is that it can be three)<SUP><FONT size=1>1</FONT></SUP>.</P>
<P>In theory the code could support even bigger nested expansions, however&nbsp;the nesting rules in the code are:</P>
<UL>
<LI>Each step must also be a ligature, thus <STRONG>ﬄ</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/fb04" mce_href="http://www.fileformat.info/info/unicode/char/fb04">U+fb04</A>, a.k.a. LATIN SMALL LIGATURE FFL) can be expanded to <STRONG>f</STRONG> + <STRONG>ﬂ</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/fb02" mce_href="http://www.fileformat.info/info/unicode/char/fb02">U+fb02</A>, a.k.a. LATIN SMALL LIGATURE FL), which can be expanded to <STRONG>ffl</STRONG>;</LI>
<LI>Currently, <A class="" href="http://msdn2.microsoft.com/library/ms776290.aspx" mce_href="http://msdn2.microsoft.com/library/ms776290.aspx">LCMapString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms776387.aspx" mce_href="http://msdn2.microsoft.com/library/ms776387.aspx">LCMapStringEx</A> with the LCMAP_SORTKEY flag only allocate the space assuming one level of nesting, so if bigger ligatures were added, someone would have to modify some code there;</LI>
<LI>EXPANSION entries cannot overlap with COMPRESSION entries (which I'll be talking about tomorrow).</LI></UL>
<P>Okay, so let's dig in now.&nbsp;Here we go....</P>
<P>Starting with <STRONG>ﬃ</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/fb03" mce_href="http://www.fileformat.info/info/unicode/char/fb03">U+fb03</A>, a.k.a. LATIN SMALL LIGATURE FFI), compared against the string <STRONG>ffi</STRONG> using the default table:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>
<P>en-US <A class="" href="http://www.fileformat.info/info/unicode/char/fb03" mce_href="http://www.fileformat.info/info/unicode/char/fb03">U+fb03</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e 23 0e 23 0e 32</FONT> 01 01 01 01 00<BR>en-US <A class="" href="http://www.fileformat.info/info/unicode/char/0066" mce_href="http://www.fileformat.info/info/unicode/char/0066">U+0066</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0066" mce_href="http://www.fileformat.info/info/unicode/char/0066">U+0066</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0069" mce_href="http://www.fileformat.info/info/unicode/char/0069">U+0069</A> <FONT color=#009900>0e 23 0e 23 0e 32</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">See how they are identical? And how the UNICODE WEIGHT piece&nbsp;(discussed in <STRONG><U><FONT color=#800080>Part 1</FONT></U></STRONG>)&nbsp;is six bytes in size, meaning that we are looking at three sort elements?</P>
<P mce_keep="true">At some binary level you may not want LATIN SMALL LIGATURE FFI to be considered the same as <STRONG>ffi</STRONG>, but any normal user looking at them would expect them to be treated like they were kind of the same....</P>
<P mce_keep="true">Now let's muddy the waters a bit, and look at <STRONG>æ</STRONG> (<A class="" href="http://www.fileformat.info/info/unicode/char/00e6" mce_href="http://www.fileformat.info/info/unicode/char/00e6">U+00e6</A>, a.k.a. LATIN SMALL LETTER AE). Now in many languages it makes sense to treat it like <STRONG>ae</STRONG> so that words like <STRONG>Cæsars</STRONG> and&nbsp;<STRONG>Caesars</STRONG> can be treated the same, thus in the default table:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>
<P mce_keep="true">en-US a&nbsp; <A class="" href="http://www.fileformat.info/info/unicode/char/0061" mce_href="http://www.fileformat.info/info/unicode/char/0061">U+0061</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e 02</FONT> 01 01 01 01 00<BR>en-US ae <A class="" href="http://www.fileformat.info/info/unicode/char/0061" mce_href="http://www.fileformat.info/info/unicode/char/0061">U+0061</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0065" mce_href="http://www.fileformat.info/info/unicode/char/0065">U+0065</A> <FONT color=#009900>0e 02 0e 21</FONT>&nbsp;01 01 01 01 00<BR>en-US æ&nbsp; <A class="" href="http://www.fileformat.info/info/unicode/char/00e6" mce_href="http://www.fileformat.info/info/unicode/char/00e6">U+00e6</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e 02 0e 21</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">This is all well and good, and the folks running Windows over at <A class="" href="http://caesars.com/Caesars/LasVegas/" mce_href="http://caesars.com/Caesars/LasVegas/">Cæsars Palace</A> probably appreciate that (though as far as I know they have not offered to fly anyone from Window International down there yet!), but in the beautiful country of Iceland, this is not acceptable.</P>
<P mce_keep="true">Because in Icelandic, <STRONG>æ</STRONG> is a little different, and thusly&nbsp;the weights look a little different:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>
<P mce_keep="true">is-IS a&nbsp; <A class="" href="http://www.fileformat.info/info/unicode/char/0061" mce_href="http://www.fileformat.info/info/unicode/char/0061">U+0061</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e 02</FONT> 01 01 01 01 00<BR>is-IS ae <A class="" href="http://www.fileformat.info/info/unicode/char/0061" mce_href="http://www.fileformat.info/info/unicode/char/0061">U+0061</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0065" mce_href="http://www.fileformat.info/info/unicode/char/0065">U+0065</A> <FONT color=#009900>0e 02 0e 21</FONT> 01 01 01 01 00<BR>is-IS z&nbsp; <A class="" href="http://www.fileformat.info/info/unicode/char/0079" mce_href="http://www.fileformat.info/info/unicode/char/0079">U+0079</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e a9</FONT> 01 01 01 01 00<BR>is-IS æ &nbsp;<A class="" href="http://www.fileformat.info/info/unicode/char/00e6" mce_href="http://www.fileformat.info/info/unicode/char/00e6">U+00e6</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#009900>0e ac</FONT> 01 01 01 01 00</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">As you can see, <STRONG>æ</STRONG> is its own letter that comes right after <STRONG>z</STRONG> and it just one sort element -- and is thus not an EXPANSION there (although in most locales it is).</P>
<P mce_keep="true">Now as I pointed out in <A class="" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430272.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/05/2430272.html"><STRONG>these</STRONG></A> <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html">three</A></STRONG> <A class="" href="http://archives.miloush.net/michkap/archive/2007/09/08/4831056.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/08/4831056.html"><STRONG>posts</STRONG></A>:</P>
<UL>
<LI>
<DIV mce_keep="true">It is also possible to add EXPANSION entries for a specific language only;</DIV></LI>
<LI>
<DIV mce_keep="true">Everyone forgot about that fact for a long time;</DIV></LI>
<LI>
<DIV mce_keep="true">The problem that was thereby caused is one that will be fixed in Windows Server 2008.</DIV></LI></UL>
<P mce_keep="true">But in any case, that kind of explains the EXPANSION functionality in collation<FONT size=1><SUP>2</SUP></FONT>.</P>
<P mce_keep="true">&nbsp;</P><FONT size=1><EM>
<P><STRONG>1</STRONG> - I even mentioned once (in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html">Why doesn't FoldString take an LCID?</A></STRONG>) how you can use <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A> with the MAP_EXPAND_LIGATURES flag to access the default table's take on these EXPANSION entries (while bemoaning the fact that the locale-specific entries were unavailable since <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A> itself doesn't accept any kind locale parameter (name or LCID)<FONT size=1><SUP>3</SUP></FONT>.<BR>2 - And even in ligature expansion, via <A class="" href="http://msdn2.microsoft.com/library/ms647478.aspx" mce_href="http://msdn2.microsoft.com/library/ms647478.aspx">FoldString</A>, though there are limitations there.<BR><STRONG>3</STRONG>&nbsp;- I did recommend that a FoldStringEx that would take a locale name be added to the next version of Windows before I moved from NLS to the International Fundamentals group, but I have no idea what the plans are here for the future....</EM></FONT></P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=5>5</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0035" mce_href="http://www.fileformat.info/info/unicode/char/0035">U+0035</A>, a.k.a. DIGIT FIVE)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2009/02/04 <a href="http://archives.miloush.net/michkap/archive/2009/02/04/9394864.html">The road to hell is paved with attempts at being compatible</a></p><p>2008/08/21 <a href="http://archives.miloush.net/michkap/archive/2008/08/21/8883467.html">A&P of Sort Keys, part 14: The Hangul is really getting OLD</a></p><p>2008/01/25 <a href="http://archives.miloush.net/michkap/archive/2008/01/25/7228941.html">On reversing the irreversible (grabbing the data, part I)</a></p><p>2007/10/09 <a href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html">A&P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)</a></p><p>2007/10/08 <a href="http://archives.miloush.net/michkap/archive/2007/10/08/5270854.html">A&P of Sort Keys, part 12 (aka Han sorts first!)</a></p><p>2007/09/24 <a href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html">A&P of Sort Keys, part 11 (aka It's not like ideographic sorts were developed idiopathically)</a></p><p>2007/09/21 <a href="http://archives.miloush.net/michkap/archive/2007/09/21/5027338.html">A&P of Sort Keys, part 10 (aka I've kana wanted to start talking about Japanese)</a></p><p>2007/09/20 <a href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html">A&P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)</a></p><p>2007/09/18 <a href="http://archives.miloush.net/michkap/archive/2007/09/18/4971376.html">A&P of Sort Keys, part 8 (aka You can often think of ignoring weights as a form of ignorance)</a></p><p>2007/09/17 <a href="http://archives.miloush.net/michkap/archive/2007/09/17/4950008.html">A&P of Sort Keys, part 7 (aka You're very thin now, but I can still recognize you)</a></p><p>2007/09/16 <a href="http://archives.miloush.net/michkap/archive/2007/09/16/4937196.html">A&P of Sort Keys, part 6 (aka Relax, be calm, and deCOMPRESS if you are feeling out of sorts)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/09/15/4924525.html" title="I&#39;ll feel better after I eat something? Well, maybe... or maybe not!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/09/14/4905625.html" title="A&amp;P of Sort Keys, part 4 (aka It isn&#39;t a race but let&#39;s make an EXCEPTION and cross the Finnish line)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09-15">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/15/4924008.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>