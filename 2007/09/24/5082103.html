<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/24/5082103.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Documented, schmockumented! It's still kind of cool....</title></head><body>
<h1>Documented, schmockumented! It's still kind of cool....</h1>
<p><em>by Michael S. Kaplan, published on 2007/09/24 03:31 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/09/24/5082103.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><FONT color=#ff0000><EM>(No, this post is not about my social life or anything related to it, though I suppose there may have been times the title might have been partially descriptive<FONT size=1><SUP>1</SUP></FONT>; this is a technical post and also a world premiere discussion of an obscure but accidentally not-yet-documented-but-nevertheless-included-in-the-SDK flag</EM> for two of the most important GDI functions for rendering text!)</FONT></P>
<P>I still have a few posts left in that series I've been working on, though being out of town has caused a minor break in the rhythm there. It will be resuming soon.</P>
<P>Meanwhile over in the Suggestion Box, posts have been building up, and I figured I should pick a few of them off....</P>
<P>Fer<FONT size=1><SUP>2</SUP></FONT> instance, there's Tihiy's question:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hello Michael!<BR><BR>Can you suggest me a way to covert font character glyphs string back to Unicode string? I'm intercepting ExtTextOut to be able to read word under the cursor and i want to have human-readable string when ETO_GLYPH_INDEX is passed!</EM></FONT></P></BLOCKQUOTE>
<P>Funny question there, one that just came up almost in the end game of Vista before it shipped.</P>
<P>The answer won't exactly be a direct&nbsp;answer to Tihiy's question, but it will supply the method and go from there....</P>
<P>Regular readers may&nbsp;remember when I was talking about device fonts in posts like <A href="http://archives.miloush.net/michkap/archive/2006/07/11/661966.html"><STRONG>Printing TrueType as graphics</STRONG></A> and <A class="" href="http://archives.miloush.net/michkap/archive/2006/07/12/662739.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/12/662739.html"><STRONG>Device fonts are people too</STRONG></A>.</P>
<P>Well, one of the things that happened in Vista is that a lot more printing via glyph ID values was happening, a factor which (among other things) forces device fonts to not be used.</P>
<P>Glyph ID values are strongly tied to specific fonts, you see -- so device fonts were being taken out of the running.</P>
<P>Now while this is all well and good for Uniscribe and especially complex scripts, it is not so good for many of the East Asian scripts that I was talking about in <A class="" href="http://archives.miloush.net/michkap/archive/2006/07/12/662739.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/12/662739.html"><STRONG>that second post</STRONG></A>, where people were relying on device fonts that were fully loaded (containing all the glyphs that were needed) and were more performant than the system that had now become the default in so many circumstances.</P>
<P>The difference in performance for some cases was bad enough to be considered a legitimate regression, and therefore something had to be done.</P>
<P>I took a look in the Vista SDK header files and saw that the constant being used to trigger this effort was not documented, and so with the permission of the folks behind the code<SUP><FONT size=1>3</FONT></SUP> in Uniscribe and GDI, I am going to break the news here -- I am sure it will be in some future update to the SDK docs.</P>
<P>The constant is in WinGdi.h, circa line 185:</P>
<BLOCKQUOTE>
<P><FONT face="Consolas,Lucida Console,Courier New,Courier"><B>#if (_WIN32_WINNT &gt;= _WIN32_WINNT_LONGHORN)<BR>#define ETO_REVERSE_INDEX_MAP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x10000<BR>#endif</B></FONT></P></BLOCKQUOTE>
<P mce_keep="true">This new in Vista constant, ETO_REVERSE_INDEX_MAP,&nbsp;will basically (in a <A class="" href="http://msdn2.microsoft.com/library/ms534019.aspx" mce_href="http://msdn2.microsoft.com/library/ms534019.aspx">TextOut</A>/<A class="" href="http://msdn2.microsoft.com/library/ms533949.aspx" mce_href="http://msdn2.microsoft.com/library/ms533949.aspx">ExtTextOut</A> call to a device like a printer) try and convert a bunch of glyph ID values back to characters again, using a map that it builds up from the font's "Format 4" Microsoft/Unicode subtable of the <A class="" href="http://www.microsoft.com/typography/OTSPEC/cmap.htm" mce_href="http://www.microsoft.com/typography/OTSPEC/cmap.htm">CMAP</A>.</P>
<P mce_keep="true">This code works great with simple fonts that don't do other mappings -- because </P>
<UL>
<LI>
<DIV mce_keep="true">any time a string you pass has no such simple mapping back to a character for every glyph ID, the code will just cut out and use the glyph ID values;</DIV></LI>
<LI>
<DIV mce_keep="true">any time a string you pass has multiple characters mapping to the same glyph ID<FONT size=1><SUP>4</SUP></FONT>, the code will detect this ambiguous case and again use the glyph ID values as they are;</DIV></LI>
<LI>
<DIV mce_keep="true">any time the glyph ID values would actually have been obtained via other means (like the <A class="" href="http://www.microsoft.com/typography/OTSPEC/gsub.htm" mce_href="http://www.microsoft.com/typography/OTSPEC/gsub.htm">GSUB</A> glyph substitution table or via <A class="" href="http://www.microsoft.com/typography/otspec/features_uz.htm" mce_href="http://www.microsoft.com/typography/otspec/features_uz.htm">more advanced features</A> like VERT for vertical writing), no characters will be found.</DIV></LI></UL>
<P mce_keep="true">Of course for the specific scenarios that inspired the work to be done, the feature is sufficient, but for even mildly complex cases involving ligatures or glyph substitutions or complex scripts in general, it will not assist at all, really.</P>
<P mce_keep="true">And of course Tihiy's question of how obtain the results of the mapping are not helped at all (unless one is a printer driver!).</P>
<P mce_keep="true">But for all the limitations here, it certainly does provide a roadmap to how one might do the work to try to reverse the process and convert glyph ID values to characters if one wanted to handle more complex cases, whether the ones I suggested above or more complex ones like digit substitution based on settings, reordering found in some Indic scripts, or even accepting ambiguous mappings and taking the first mapping as it is, etc.</P>
<P mce_keep="true">One would have to dig into OpenType a bit, but a few <A class="" href="http://msdn2.microsoft.com/library/ms534211.aspx" mce_href="http://msdn2.microsoft.com/library/ms534211.aspx">GetFontData</A> calls and some code that starts as a reverse to the code in <A class="" href="http://support.microsoft.com/kb/241020" mce_href="http://support.microsoft.com/kb/241020">KB241020</A>, opening up additional OpenType tables and subtables as desired for the text in question, and one is in business!</P>
<P mce_keep="true">Now in the long run, this is the kind of thing I would love see built in, but obviously features can't be decided solely on the basis of what people like me (or maybe people like you!) think is cool; there have to be real scenarios like measurable performance issue found with Japanese device fonts not being utilized. Until then, this could be an exciting project for some ISV to work on, or maybe a sample I could try to and put together at some point (my last bit of digging into OpenType stuff was over 18 months ago in <A class="" href="http://archives.miloush.net/michkap/archive/2006/02/13/530814.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/13/530814.html"><STRONG>Getting all of the localized names of a font</STRONG></A>, I think I might be due at some point!).</P>
<P mce_keep="true">Also, keep the&nbsp;concepts behind the post in mind, they will provide assistance in a quite unrelated feature I will be posting about over the next few weeks sometime....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT size=1>1 - Perhaps fodder for future, non-technical&nbsp;blog posts if there is sufficient interest!<BR>2&nbsp;- Intentionally misspelled to try to give the illusion of SiaO being "jus country"<SUP>5,6</SUP>!<BR></FONT><FONT size=1>3 - Thanks, Sergey and Mike!<BR>4&nbsp;- An exception to this rule is some specific characters commonly mapped to the same glyph, like <A class="" href="http://www.fileformat.info/info/unicode/char/0020" mce_href="http://www.fileformat.info/info/unicode/char/0020">U+0020</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/00a0" mce_href="http://www.fileformat.info/info/unicode/char/00a0">U+00a0</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/2002" mce_href="http://www.fileformat.info/info/unicode/char/2002">U+2002</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/2003" mce_href="http://www.fileformat.info/info/unicode/char/2003">U+2003</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/3000" mce_href="http://www.fileformat.info/info/unicode/char/3000">U+3000</A> mapping to the space and <A class="" href="http://www.fileformat.info/info/unicode/char/002d" mce_href="http://www.fileformat.info/info/unicode/char/002d">U+002d</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/00ad" mce_href="http://www.fileformat.info/info/unicode/char/00ad">U+00ad</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/2010" mce_href="http://www.fileformat.info/info/unicode/char/2010">U+2010</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/2011" mce_href="http://www.fileformat.info/info/unicode/char/2011">U+2011</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/2012" mce_href="http://www.fileformat.info/info/unicode/char/2012">U+2012</A> for the hyphen; in such cases, the mappings will not be considered ambiguous, even though the text mapped may or may not match the original code points that were converted to glyph ID values.<BR>5&nbsp;- Another intentional misspelling.<BR>6&nbsp;- Also, an unintentional misuse of the idiom due to lack of knowledge of how to represent it and spell it!</FONT></P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>‒</FONT> <EM>(</EM><A class="" href="http://www.fileformat.info/info/unicode/char/2012" mce_href="http://www.fileformat.info/info/unicode/char/2012"><EM>U+2012</EM></A><EM>, a.k.a. FIGURE DASH)</EM></FONT></P>
<hr/><p><a id="5099567" href="#5099567">#</a> <strong>Tihiy</strong> on 24 Sep 2007 11:19 AM:</p><div style="margin-left: 1em"><p>I've managed to solve my task by using GetGlyphIndices on whole Unicode range and reverse-looking up character.</p></div>
<p><a id="5099857" href="#5099857">#</a> <strong>Michael S. Kaplan</strong> on 24 Sep 2007 11:37 AM:</p><div style="margin-left: 1em"><p>That's cool -- as long as you recognize the similar limitation that &quot;reverse lookup map&quot; will have. But otherwise it is not an unlike solution, at all. :-)</p>
</div>
<p><a id="5100448" href="#5100448">#</a> <strong>Mihai</strong> on 24 Sep 2007 12:14 PM:</p><div style="margin-left: 1em"><p>&lt;&lt;I've managed to solve my task by using GetGlyphIndices on whole Unicode range&gt;&gt;</p>
<p>Except that GetGlyphIndices does not work outside BMP, so the Unicode range it is not quite whole :-)</p></div>
<p><a id="5101791" href="#5101791">#</a> <strong>Mike</strong> on 24 Sep 2007 12:59 PM:</p><div style="margin-left: 1em"><p>I really want to stress that if you are required to get characters back out of a glyph index string your first effort should be to change your design, not to start writing code to do the reverse mapping. &nbsp;It's completely impossible to do in general because there is a many-to-many mapping between characters and indexes. &nbsp;You can get it to mostly-sorta-work-on-occasion but it will never be fully reliable.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/01/05 <a href="http://archives.miloush.net/michkap/archive/2011/01/05/10111348.html">Short-sighted text processing #5: PU[A]! That pad THAI is pretty spicy....</a></p><p>2010/09/16 <a href="http://archives.miloush.net/michkap/archive/2010/09/16/10062966.html">Providing more information is the best way to assure correct information is received</a></p><p>2010/09/06 <a href="http://archives.miloush.net/michkap/archive/2010/09/06/10057561.html">Acrobat PDF: the Yugo vs. the BMW vs. the Ferrari</a></p><p>2008/01/13 <a href="http://archives.miloush.net/michkap/archive/2008/01/13/7090976.html">On reversing the irreversible (the introduction)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/09/24/5085893.html" title="A&amp;P of Sort Keys, part 11 (aka It&#39;s not like ideographic sorts were developed idiopathically)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/09/23/5086819.html" title="The lasting effects of interns, aka Can you fix my Vista install, aka Can they blow the Shofar, aka I should have split up this post!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09-24">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/24/5082103.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>