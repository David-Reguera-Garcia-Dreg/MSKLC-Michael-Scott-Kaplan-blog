<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/14/4900107.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How do I feel about lstrcmpi? I think it blows....</title></head><body>
<h1>How do I feel about lstrcmpi? I think it blows....</h1>
<p><em>by Michael S. Kaplan, published on 2007/09/14 03:16 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/09/14/4900107.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P><EM>(Negative assessment word (<STRONG>blows</STRONG>) chosen via a <A class="" href="http://8ball.ofb.net/" mce_href="http://8ball.ofb.net/">magic eight ball</A> and the info in </EM><A class="" href="http://archives.miloush.net/michkap/archive/2007/09/05/4756822.html" mce_href="http://archives.miloush.net/michkap/archive/2007/09/05/4756822.html"><EM>this post</EM></A><EM>)&nbsp;</EM></P>
<P>Benski asked: </P>
<BLOCKQUOTE><FONT face="times new roman,times" size=2>
<P><EM>Michael -<BR><BR>Ran into a weird problem in our product. I have no idea about what caused it, but I found the solution. In a lot of places in a cross-platform area of our code, we have a function that maps to lstrcmpiW on Win32, wcscasecmp on Unix, and some CFString functions on Mac OS X.<BR><BR>Changing lstrcmpiW back to wcsicmp resolved our problem. This particular part of the code is doing mostly string table lookups, so locale-aware comparisons were probably inappropriate (a better function to call might be CompareStringW with a "neutral" LCID. wcsicmp is probably just working because it's using the default "C" locale).<BR><BR>Any idea what actual caused the problem? The code is too massive for me to trace what's going on. I realize that you have no context to work from at all here :) But I thought maybe you'd have some insight on any "gotchas" that are particular to these locales but not others.<BR><BR>-Benski</EM></P></FONT></BLOCKQUOTE>
<P>Indeed, that old <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A> function which has been around for a long time -- in the past (like in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/04/11/407107.html" mce_href="http://archives.miloush.net/michkap/archive/2005/04/11/407107.html">this post</A></STRONG>), I have praised the fact that it takes the position of making the default function that people are likely to call respect the user's defaults.</P>
<P>I have decided that I was (to put it quite simply)<STRONG> completely and utterly wrong</STRONG>.</P>
<P>Not because respecting user preferences isn't a good thing; it is, truly.</P>
<P>But the most common ways people use this function basically amount to cases like Benski's, where what was being looked for was a C-runtime like function. And since they get one with locale-specific behavior, they can run into problems.</P>
<P>You want to know why we never fixed the <STRONG>Turkic I bug</STRONG> by default in <A class="" href="http://msdn2.microsoft.com/library/ms647476.aspx" mce_href="http://msdn2.microsoft.com/library/ms647476.aspx">CompareString</A>/<A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>? Simple! Because to this day you can find code like this hanging around in our docs and unfortunately in our own internal codebase, far too often for me to be comfortable (example from the <A class="" href="http://msdn2.microsoft.com/library/ms724429.aspx" mce_href="http://msdn2.microsoft.com/library/ms724429.aspx">Getting the System Version (Windows)</A> topic):</P>
<BLOCKQUOTE>
<P><FONT face="consolas,lucida console,courier new,courier"><STRONG>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( lstrcmpi( TEXT("WINNT"), szProductType) == 0 )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( "Workstation " );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( lstrcmpi( TEXT("LANMANNT"), szProductType) == 0 )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( "Server " );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ( lstrcmpi( TEXT("SERVERNT"), szProductType) == 0 )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( "Advanced Server " );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printf( "%d.%d ", osvi.dwMajorVersion, osvi.dwMinorVersion );<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Display service pack (if any) and build number.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if( osvi.dwMajorVersion == 4 &amp;&amp; <BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; lstrcmpi( osvi.szCSDVersion, TEXT("Service Pack 6") ) == 0 )<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { </STRONG></FONT></P></BLOCKQUOTE>
<P mce_keep="true">Now the calls themselves may be fine here (though some of it isn't since who knows what will be gotten from the registry to fill in szProductType) but even if were okay in this case, it remains an example that will encourage people as they&nbsp;copy and paste solutions just propagates the behavior.</P>
<P mce_keep="true">Now some people do misuse the invariant locale for what should be ordinal comparisons, but by and large the people who call <A class="" href="http://msdn2.microsoft.com/library/ms647489.aspx" mce_href="http://msdn2.microsoft.com/library/ms647489.aspx">lstrcmpi</A>&nbsp;seem <STRONG>way more likely</STRONG> to be making a mistake. Given that, I think it easier to just say it blows and move on. :-)</P>
<P mce_keep="true">Remember that when checking for equality, especially on an item like a registry value where OS semantics are involved, the best answer is <A class="" href="http://msdn2.microsoft.com/library/ms776340.aspx" mce_href="http://msdn2.microsoft.com/library/ms776340.aspx">CompareStringOrdinal</A>, with a fallback to <A href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_ddeef320-7510-446b-af6f-756c3999bec1.xml.asp"><FONT face=Tahoma>RtlCompareUnicodeString</FONT></A>&nbsp;or even better <A href="http://msdn.microsoft.com/library/en-us/Kernel_r/hh/Kernel_r/k109_59d7c507-968a-4cf5-b1f0-91c8cd7ccb64.xml.asp"><FONT face=Tahoma>RtlEqualUnicodeString</FONT></A><FONT face=Tahoma>&nbsp;or if you absolutely must </FONT><A class="" href="http://msdn2.microsoft.com/library/k59z8dwe.aspx" mce_href="http://msdn2.microsoft.com/library/k59z8dwe.aspx">wcsicmp</A>&nbsp;(with awareness&nbsp;that&nbsp;<A class="" href="http://archives.miloush.net/michkap/archive/2005/05/26/421987.html" mce_href="http://archives.miloush.net/michkap/archive/2005/05/26/421987.html">there is one character&nbsp;it can be wrong about</A>)&nbsp;for anything that has to run pre-Vista.</P>
<P mce_keep="true">(more on why RtlEqualUnicodeString is best <A class="" href="http://archives.miloush.net/michkap/archive/2006/02/09/528297.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/09/528297.html">here</A>)</P>
<P mce_keep="true">Noe when Benski mentioned the <A class="" href="http://developer.apple.com/documentation/CoreFoundation/Reference/CFStringRef/Reference/reference.html" mce_href="http://developer.apple.com/documentation/CoreFoundation/Reference/CFStringRef/Reference/reference.html">CFString</A> stuff on the Mac, I have to admit I took a quick look and found some of it fascinating. I'll share my thoughts on this soon....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT face=Tahoma><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>Ï‚</FONT> </FONT><EM><FONT color=#ff00ff>(</FONT><A href="http://www.fileformat.info/info/unicode/char/03c2/index.htm">U+03c2</A><FONT color=#ff00ff>, a.k.a. GREEK SMALL LETTER FINAL SIGMA)</FONT></EM></FONT></P>
<hr/><p><a id="4916388" href="#4916388">#</a> <strong>DavRis</strong> on 14 Sep 2007 3:57 PM:</p><div style="margin-left: 1em"><p>Very useful post -- thanks! &nbsp;I was just last week considering submitting a question of which string comparison to use pre-Vista for registry and file-system-like case insensitive string comparisons.</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/08/05 <a href="http://archives.miloush.net/michkap/archive/2008/08/05/8833203.html">On describing poorly (and on not listening)</a></p><p>2008/03/07 <a href="http://archives.miloush.net/michkap/archive/2008/03/07/8086758.html">Some armchair root cause analysis of the suckage of lstrcmpi</a></p><p>2007/10/15 <a href="http://archives.miloush.net/michkap/archive/2007/10/15/5462057.html">We're Lost. Maybe the map is wrong. Maybe all maps are wrong?</a></p><p>2007/09/23 <a href="http://archives.miloush.net/michkap/archive/2007/09/23/5071210.html">Docs can whet SiaO's appetite, but where's the blog?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/09/14/4904644.html" title="Look at the shiny happy people laughing -- push and pull aside, they&#39;re beautiful">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/09/13/4889299.html" title="Dr. Seuss does Unicode, aka HOP on POP [DIRECTIONAL FORMATTING]">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/14/4900107.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>