<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/08/4831056.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>2001, a Correctness Odyssey (aka What's the matter with Ü?)</title></head><body>
<h1>2001, a Correctness Odyssey (aka What's the matter with Ü?)</h1>
<p><em>by Michael S. Kaplan, published on 2007/09/08 08:28 -07:00, original URI: http://blogs.msdn.com/michkap/archive/2007/09/08/4831056.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostOld -->
<P>Yes, as the title indicates this is post # 2001 of Sorting it all Out!</P>
<P>There have&nbsp;over the last few years on this blog and in the many years&nbsp;prior been&nbsp;recurrent themes related to the&nbsp;work I do, and the things that I care about. Today I am going to talk about one of those themes in particular.</P>
<P>You see, for several years now I have been both an observer and a fighter in the ongoing and never-ending battle between consistency/compatibility and correctness -- the desire to return the same results as previously even if they may be wrong and the desire to return the right results.</P>
<P>The&nbsp;struggle has been behind posts like <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/10/15/829978.html" mce_href="http://archives.miloush.net/michkap/archive/2006/10/15/829978.html">Compatibility is inconsistent; consistency is not compatible...</A></STRONG>,&nbsp;<STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/03/25/402444.html" mce_href="http://archives.miloush.net/michkap/archive/2005/03/25/402444.html">Consistency and correctness are both four letter words</A></STRONG> and many others.</P>
<P>While I understand the reasons for both, I am usually more convinced by the arguments of correctness, as I shudder to think about <STRONG>fighting for the right to be wrong</STRONG>....</P>
<P>I am not, however, a zealot about this (despite opinions you may have heard to the contrary), and there are many times that I have worked to make sure that consistent/compatible solutions are made available.</P>
<P>The real problem in that <STRONG>C/C vs. C</STRONG> battle is that one never knows to draw the line.</P>
<P>Until now, I mean....</P>
<P>You may recall when I pointed out in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430272.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/05/2430272.html">All right, mistakes were made #1</A></STRONG> and <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html">All right, mistakes were made #2</A></STRONG> how&nbsp;<STRONG>Ü</STRONG> and <STRONG>ü</STRONG> were being improperly expanded into <STRONG>UE</STRONG> and <STRONG>ue</STRONG>, respectively, in all locales in Vista.</P>
<P>This is obviously a very serious, customer reported issue. Although there has never yet been a release of Windows where changes that would fall in the major version category I talk about <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/07/30/4143574.html" mce_href="http://archives.miloush.net/michkap/archive/2007/07/30/4143574.html">here</A></STRONG> and elsewhere&nbsp;have been made in a service pack, the fact that the results were so obviously <STRONG>in</STRONG>correct and so obviously <STRONG>in</STRONG>compatible with the results with every prior version of Windows, it seemed obvious at the time to me and to the various folks triaging issues that this might be the time to make an exception to this rule.</P>
<P>In fact, as I mentioned in <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html" mce_href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html">All right, mistakes were made #2 (What the %#$* is wrong with German Phonebook sorting?)</A></STRONG>, the fix was put into SP1 of Vista, as well as in Longhorn Server (now called Windows Server 2008).</P>
<P>However, while it is usually the case that compatibility and consistency are put in the same category, it is crucial to decide what one needs to be consistent&nbsp;and compatible with. And after some pretty bad application compatibility issues were found with applications that were not using <A class="" href="http://msdn2.microsoft.com/library/ms776287.aspx" mce_href="http://msdn2.microsoft.com/library/ms776287.aspx">GetNLSVersion</A>/<A class="" href="http://msdn2.microsoft.com/library/ms776253.aspx" mce_href="http://msdn2.microsoft.com/library/ms776253.aspx">IsNLSDefinedString</A> to look out for a major version change<FONT size=1><SUP>1</SUP></FONT> (you may have seen some of this across the web -- the problems with Zune and Vista SP1 were pretty widely reported), it was clear that something had to be done.</P>
<P>After a great deal of investigation and effort,&nbsp;the fix is being backed out for this change in SP1 but kept in Server 2008 (we have a nice long history of being willing to make such changes in client versus server releases, and other&nbsp;changes that were required for some server-based products outweighed the passive desire to keep client and server releases exactly the same).</P>
<P>And thus the model which had previously been infomally architected is now confirmed and formally codified -- new versions are for correctness; service packs are for consistency and compatibility.</P>
<P>At every stage people involved in the debate have acted professionally, and trying to do the best thing for the customer, and his particular decision is one that I think people will be able to live with in the end. It is at some level unfortunate that we managed to lose something as basic as the correct alphabetical order for all of the languages that have <STRONG>Ü</STRONG> and <STRONG>ü</STRONG> in them<FONT size=1><SUP>2</SUP></FONT> (plus the ones like English that have a specific place where it "ought" to intuitively go). But applications breaking completely is clearly worse and&nbsp;it is only for this one version, which can now&nbsp;if nothing else&nbsp;make the claim that it is consistent with itself....</P>
<P mce_keep="true">&nbsp;</P>
<P><EM><FONT size=1>1 - In fairness the functions&nbsp;were not added in Server 2003 but ironically it was actually applications that did not even exist until after that which swayed opinions the most!<BR>2 - In another burst of irony, someone from the Zune team also reported the&nbsp;incorrect way that Ü and ü were sorting in Vista, and asked when we planned to fix that!</FONT></EM></P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> Ü <EM>and</EM> ü <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/00dc" mce_href="http://www.fileformat.info/info/unicode/char/00dc">U+00dc</A> and <A class="" href="http://www.fileformat.info/info/unicode/char/00fc" mce_href="http://www.fileformat.info/info/unicode/char/00fc">U+00fc</A>, a.k.a. LATIN CAPITAL LETTER U WITH DIAERESIS and LATIN SMALL LETTER U WITH DIAERESIS)</EM></FONT></P>
<hr/><p><a id="4837343" href="#4837343">#</a> <strong>Jonathan Wilson</strong> on Saturday, September 08, 2007 9:45 PM:</p><div style="margin-left: 1em"><p>Is there any info out there about what enabling this change in Vista SP1 would actually do to an app? (a google search didnt find anything) Are there really apps out there that are going to break because they expect that &#220; = UE on Vista?</p></div>
<p><a id="4837865" href="#4837865">#</a> <strong>Michael S. Kaplan</strong> on Saturday, September 08, 2007 10:51 PM:</p><div style="margin-left: 1em"><p>If one assumes that the results of a CompareString or LCMapString/sort key call within a version will not change, asnd they do, then it could lead to index corruption, which would lead to being unable to find results and other problems.</p>
<p>In this case there actually was an example (Zune) and anyone making that same assumption could have the same problems or worse....</p></div>
<p><a id="4851766" href="#4851766">#</a> <strong>Sven Harazim</strong> on Monday, September 10, 2007 3:19 AM:</p><div style="margin-left: 1em"><p>I wait for SP1 ;-)</p></div>
<p><a id="6855538" href="#6855538">#</a> <strong>Rolf Frei</strong> on Monday, December 24, 2007 4:49 PM:</p><div style="margin-left: 1em"><p>Seriously I can't understand that move to remove it from SP1!!! </p>
<p>Fact is that my DB-application doesn't anymore correctly work under Vista, as it did under an old Windows versions. So the point here ist that the change in Vista DID break the backward compatibility of old applications. The Databse System I use, uses the Windows language drivers for sorting, filtering etc. &nbsp;Now the comlete german language driver in Vista is broken and if I understand you correctly, this will not be fixed at all?! </p>
<p>I can change the Language fo my DB tables to ANSI and everything works, but not anymore in an way my customers expect it, as now the sorting and filtering doenst anymore work as expecetd be any german user.</p></div>
<p><a id="6855703" href="#6855703">#</a> <strong>Michael S. Kaplan</strong> on Monday, December 24, 2007 5:14 PM:</p><div style="margin-left: 1em"><P>I am not going to disagree with you, Rolf. That was my call too -- I originally pushed for the fix, got it approved in triage and war, and checked it in. It was only later that forces more powerful than I set the bar higher (also slightly differently) and the fix had to be backed out.</P>
<P>But FWIW the fix IS in Server 2008, and if nothing else the German phone book sort does still happen to work even in Vista. Not exactly perfect, but that is where it is....</P></div>
<p><a id="6855772" href="#6855772">#</a> <strong>Michael S. Kaplan</strong> on Monday, December 24, 2007 5:28 PM:</p><div style="margin-left: 1em"><P>One workaround -- you can use U/u + combing diaresis (<A class="" href="http://www.fileformat.info/info/unicode/char/0055">U+0055</A>/<A class="" href="http://www.fileformat.info/info/unicode/char/0075">U+0075</A> + <A class="" href="http://www.fileformat.info/info/unicode/char/0308">U+0308</A>) and they will both sort properly (in every collation <STRONG>except for</STRONG> the German phonebook sort)....</P></div>
<p><a id="6862196" href="#6862196">#</a> <strong>Rolf Frei</strong> on Tuesday, December 25, 2007 9:55 AM:</p><div style="margin-left: 1em"><p>As my application is non Unicode this isn't an option at all. </p>
<p>Whatever guy has decidet to remove that fix from SP1 is an idiot! Sorry for that words, but I think he hasn't realy checked the problem at all. The Vista behaviour breaks old applications and that fix will make it work again. &nbsp;</p>
<p>To say it will not be inlcuded to not break applications is absolutly stupid, as Vista does now already break applications and a fix will fix the broken application and not break new applications. Any new application under Vista ist already broken, as it doesn't behave as it should for any german users.</p>
<p>Whatever person has removed that fix from SP1 should jumpin here to check what the problem realy is.</p>
<p>In additon I have written a small routine with CompareStrings, which does sort all caracters under XP and under Vista and I was just suprised how much the sorting has changed under Vista. Specially the lowest sortorder char (ASCII 179) which gets sortet below ASCII 0?!</p>
<p>On the following Links you can see the orderd list of the german ASCII table on XP and on Vista and how differetn they are:</p>
<p><a rel="nofollow" target="_new" href="http://www.eicom.ch/rolf/Charmap_XP.png">http://www.eicom.ch/rolf/Charmap_XP.png</a></p>
<p><a rel="nofollow" target="_new" href="http://www.eicom.ch/rolf/Charmap_Vista.png">http://www.eicom.ch/rolf/Charmap_Vista.png</a></p></div>
<p><a id="6862910" href="#6862910">#</a> <strong>Michael S. Kaplan</strong> on Tuesday, December 25, 2007 11:55 AM:</p><div style="margin-left: 1em"><p>The major version of sorting was changed for for Vista, which means that applications should be checking for this fact and re-indexing as needed.</p>
<p>And there are different degrees of broken that we are talking about here -- the types of bugs that were hanging in the balance were index corruption, file list corruption, and applications being unable to boot. In the end it is hard to sustain a claim that such applications should be punished simply because they were not checking the sort version in a service pack when we have never made such a change in a service pack ever, just to make sure that &#220;/&#252; sort properly.</p>
<p>By taking out the &#220;/&#252; fix, these more serious problems have been averted.</p></div>
<p><a id="6870090" href="#6870090">#</a> <strong>Rolf Frei</strong> on Wednesday, December 26, 2007 9:31 AM:</p><div style="margin-left: 1em"><p>The main prob&#246;em is that CompareString under Vista doesn now handle u &lt;&gt; &#252; (and the same for the other Umlauts) and &#252; = ue which both is wrong.</p>
<p>On german rules it must be u=&#252; (or o=&#246;, a=&#228;,...) and &#252;&lt;&gt;ue (or &#246;&lt;oe, &#228;&lt;&gt;ae,...). Vista violates this german language rules and produces wrong results. Sorry but this is a classical BUG and must be fixed. </p>
<p>I'm right sure if this is someting in the english language system and you Amis are affected by this, MS will release a fix imediatly, but as you are not directly affected by this bug, it is not that important for you (MS). That's a shame and I'm so frustrated now, that we germans are now lost alone and MS is not willing to fix the fault they have done!!! </p>
<p>That the Server version of Vista will get the fix but Vista itself not is another strange thing I can't understand.... </p></div>
<p><a id="6871150" href="#6871150">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, December 26, 2007 12:03 PM:</p><div style="margin-left: 1em"><P>You are preaching to the choir here, you really are about the overall issue. </P>
<P>But there is no German sort that says that u==ü, o==ö, a==ä on any version of Windows since there is at least a diacritic difference there....</P></div>
<p><a id="7902433" href="#7902433">#</a> <strong>Ralf</strong> on Tuesday, February 26, 2008 6:42 AM:</p><div style="margin-left: 1em"><p>I tested it with the RTM Vista SP 1 and I think it did not change !</p>
<p>Do you know something about it ?</p></div>
<p><a id="7903889" href="#7903889">#</a> <strong>Michael S. Kaplan</strong> on Tuesday, February 26, 2008 8:31 AM:</p><div style="margin-left: 1em"><p>Ralf,</p>
<p>The whole point of this post was to explain why the fix was backed out of SP1 (it was originally there but was removed, though it was left in Server 2008).</p></div>
<p><a id="8055188" href="#8055188">#</a> <strong>Kirill M&#252;ller</strong> on Wednesday, March 05, 2008 4:02 PM:</p><div style="margin-left: 1em"><p>Michael,</p>
<p>is there any chance that a hotfix for this problem will be published or available on request?</p>
<p>Our database system uses client-generated index data (using CompareString(NORM_IGNORECASE | SORT_STRINGSORT)) that can be accessed from clients running different operating systems (or different NLS versions, if you like). There is no central server, only file I/O. If I get the point (from your post &quot;What makes a string meaningful?&quot;), the correct approach would be to maintain separate indexes for each NLS version that has access to the database. A little bit of overkill, it kind of doubles (triples? quadruples?) index space consumption for our system. Is it ever possible that the sorting order of two meaningful strings changes between NLS versions?</p>
<p>You mentioned a workaround: &quot;... you can use U/u + combing diaresis (U+0055/U+0075 + U+0308) and they will both sort properly (in every collation except for the German phonebook sort)....&quot; So would this pseudo-code work?</p>
<p>'''''''''''''''''''''''</p>
<p>If IsWindowsVista() And lcid &lt;&gt; 0x10407</p>
<p> &nbsp; s1 = Replace(s1, &quot;&#252;&quot;, &quot;u&quot; + combing_diaresis)</p>
<p> &nbsp; s1 = Replace(s1, &quot;&#220;&quot;, &quot;&#220;&quot; + combing_diaresis)</p>
<p> &nbsp; s2 = Replace(s2, &quot;&#252;&quot;, &quot;u&quot; + combing_diaresis)</p>
<p> &nbsp; s2 = Replace(s2, &quot;&#220;&quot;, &quot;&#220;&quot; + combing_diaresis)</p>
<p>EndIf</p>
<p>Compare(s1, s2)</p>
<p>'''''''''''''''''''''''</p>
<p>Why does setting the application compatibility mode to XPSP2 not fix the problem? This seems to enable the &quot;EmulateSorting&quot; shim which sounded quite promising to me...</p>
<p><a rel="nofollow" target="_new" href="http://technet2.microsoft.com/WindowsVista/en/library/ac42bd59-3bd8-4b7d-b3ee-a4ec608d86181033.mspx?mfr=true">http://technet2.microsoft.com/WindowsVista/en/library/ac42bd59-3bd8-4b7d-b3ee-a4ec608d86181033.mspx?mfr=true</a></p>
<p>Thanks in advance for any advice on this. Your blog was the only source of information I found for this, as I would call it, show-stopper. Pity. This might be a minor issue for the vast majority of users, but still worth to be commented on officially.</p>
<p>Best regards,</p>
<p>Kirill</p></div>
<p><a id="8056349" href="#8056349">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, March 05, 2008 4:53 PM:</p><div style="margin-left: 1em"><p>There is know way as far as I know to get a hotfix here (the original fix was rejected for Vista SP1 and had to backed out, though it was accepted for Server 2008).</p>
<p>But the workaround should work here -- if you denormalize the string so U Umlaut becomes U + Combining Umlaut then you shouldn't run into this problem....</p>
<p>The shim would have been a good place tp get something in, but it was not done though in retropect it probably should have been....</p></div>
<p><a id="8056421" href="#8056421">#</a> <strong>Michael S. Kaplan</strong> on Wednesday, March 05, 2008 4:56 PM:</p><div style="margin-left: 1em"><p>FWIW, I agree on the 'official comments&quot; would be nice though I don't have any control over that at all these days. I generally put stuff here when I have no idea when/if it will be put somewhere official...</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/03/06 <a href="http://archives.miloush.net/michkap/archive/2010/03/06/9972239.html">Burn Windows Burn (aka If we want to unsay *this* one, we cannot say "Mu")</a></p><p>2008/03/26 <a href="http://archives.miloush.net/michkap/archive/2008/03/26/8337198.html">Vietnamese still ain't quite right</a></p><p>2008/02/19 <a href="http://archives.miloush.net/michkap/archive/2008/02/19/7785815.html">Insanity defined: In the real world -0 == 0, in Vista -0 < 0, and in Windows Server 2008 -0 ≮ 0</a></p><p>2008/01/05 <a href="http://archives.miloush.net/michkap/archive/2008/01/05/6866927.html">Zune 2.0 software is able to support Greek + Cyrillic + more Latin</a></p><p>2007/09/15 <a href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html">A&P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/09/09/4839909.html" title="Amazing what a difference a preposition makes (aka Boy with stick, gets no chick)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/09/08/4825659.html" title="Detecting ALTGR can only hope to work when AlTGR is in fact there....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-09-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/09/08/4831056.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:37 GMT -->
</html>