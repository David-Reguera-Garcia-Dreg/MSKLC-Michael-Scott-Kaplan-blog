<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/02/06/1609072.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>MLang and GDI and Uniscribe, oh my!</title></head><body>
<h1>MLang and GDI and Uniscribe, oh my!</h1>
<p><em>by Michael S. Kaplan, published on 2007/02/06 06:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/02/06/1609072.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Viktor's question not only captured the problem but it also showed that he had been digging into the problem some:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2><I>
<P>My problem:<BR><BR>GDI uses font linking to render CJK characters in a text box or when I call DrawText to output a mixed-script domain name. On the other hand if I use GetGlyphIndices, ScriptShape or ScriptGetCMap to query a font for missing glyphs the above mentioned functions do not take font linking into account. So I am getting missing glyphs reported, although they are correctly rendered by the GDI.<BR><BR>Interestingly, ScriptStringAnalyse provides SSA_FALLBACK and SSA_LINK flags to take font linking into account, but there is no interface to query the glyphs after a ScriptStringAnalyse call.<BR><BR>How can I find out whether GDI can render a character (string) correctly taking font linking into account?<BR><BR>Using MLang for font linking is inconsistent with the GDI font linking behavior, i.e. characters rendered correctly by an MLang linked font are not correctly rendered by GDI, for example.<BR><BR>Even ScriptStringAnalyse with SSA_FALLBACK|SSA_LINK set is not always consistent with GDI depending whether Windows support for East Asian scripts is installed or not.<BR><BR>I would be very grateful if you could help me solving my font linking issue or if you could write about it in a future blog post.<BR><BR>Thanks<BR><BR>Viktor</P></I></FONT></BLOCKQUOTE>
<P>The problem here has no one stop solution -- the fact is that MLang's font linking&nbsp;and Uniscribe's font fallback&nbsp;are pretty much mutually exclusive as I pointed out in (<STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/02/15/531653.html" mce_href="http://archives.miloush.net/michkap/archive/2006/02/15/531653.html">this post</A></STRONG>), and GDI's font linking&nbsp;and Uniscribe's font fallback are also pretty much mutually exclusive as I pointed out in (<STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2005/10/01/476022.html" mce_href="http://archives.miloush.net/michkap/archive/2005/10/01/476022.html">this post</A></STRONG>). </P>
<P>Well, "mutually exclusive" is perhaps not the right term, since these technologies all co-exist and each has its own situation where it helps provide something useful. </P>
<P>But I guess what I am saying is that there is no one easy way to get the answer you might want here.</P>
<P>However, if you use the <A class="" href="http://msdn2.microsoft.com/library/ms776510.aspx" mce_href="http://msdn2.microsoft.com/library/ms776510.aspx">ScriptIsComplex</A> function to figure out whether Uniscribe is going to be used or not (after using the <A class="" href="http://msdn.microsoft.com/library/en-us/intl/nls_74dh.asp" mce_href="http://msdn.microsoft.com/library/en-us/intl/nls_74dh.asp">IsValidLocale</A> function to see about whether East Asian and/or complex script support is installed as I described <STRONG><A class="" href="http://archives.miloush.net/michkap/archive/2006/07/25/677592.html" mce_href="http://archives.miloush.net/michkap/archive/2006/07/25/677592.html">here</A></STRONG>), then you are on your way!</P>
<P>You can decide whether you need to go through the Uniscribe method for figuring this out (which Viktor discusses above) or the&nbsp;GDI way, which involves checking the fonts in the font linking chain to see if between them all you can get support for each character in the string (in fact you can use the <A class="" href="http://msdn2.microsoft.com/library/ms776482.aspx" mce_href="http://msdn2.microsoft.com/library/ms776482.aspx">ScriptGetCMap</A> function to do the specific GDI lookups for each of the fonts in the font link chain -- all you need is each character to be covered by at least one of the fonts)....</P>
<P>Figuring the most efficient algorithm for the above detection operation might even make an interesting interview question, with a particular eye to optimization....</P>
<P>(If people wanted to suggest either the algorithm or some specific optimizastions that come to mind, the comments should be open!)</P>
<P>Although, taking a step back, a better answer might be to reject the mixed script domain entirely as something of a phishing/security risk? :-)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>àª¸</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/0ab8" mce_href="http://www.fileformat.info/info/unicode/char/0ab8">U+0ab8</A>, a.k.a. GUJARATI LETTER SA)</EM></FONT></P>
<hr/><p><a id="1612943" href="#1612943">#</a> <strong>Mike</strong> on 6 Feb 2007 12:59 PM:</p><div style="margin-left: 1em"><p>I just wanted to point out that GDI *can't* apply font linking when dealing with glyph indexes directly. &nbsp;Glyph indexes are relative to a given font file - 'A' might be glyph #37 in one font and #983 in another.</p>
<p>I also wanted to pick a nit and point out that DrawText is not a GDI function - it's a USER function.</p></div>
<p><a id="1612960" href="#1612960">#</a> <strong>Michael S. Kaplan</strong> on 6 Feb 2007 1:07 PM:</p><div style="margin-left: 1em"><p>A User function that relies on GDI, as opposed to GDI+/WPF/MLang/Psychic HotLine, etc. :-)</p>
<p>For the other nit, my recommended action was to look in each font that is the chain individually and see if it HAD a glyph. It does not matter what the glyph is, since the test would just be for existence. The relativity of glyph indices is really not an issue here?</p>
</div>
<p><a id="1614944" href="#1614944">#</a> <strong>mlippert</strong> on 6 Feb 2007 7:05 PM:</p><div style="margin-left: 1em"><p>Michael,</p>
<p>What API function do you call to find out the GDI font-linking chain?</p>
<p>I've never figured out how to get that information.</p>
</div>
<p><a id="1615002" href="#1615002">#</a> <strong>Michael S. Kaplan</strong> on 6 Feb 2007 7:08 PM:</p><div style="margin-left: 1em"><p>There is no function; you have to dig into the registry for this.</p>
</div>
<p><a id="1615015" href="#1615015">#</a> <strong>mlippert</strong> on 6 Feb 2007 7:10 PM:</p><div style="margin-left: 1em"><p>Oh, and BTW this post is near and dear to my heart.</p>
<p>I've implemented the mlang font-linking in our app, but there were enough places it wasn't really working as I expected, eg with unicode character not in any codepage) that I had to implement a override to some other font for specific character ranges. It's possible that Uniscribe might have worked, but I never found any good documentation on it, and I didn't have the time to piece it together from code samples.</p>
<p>Thanks once again for your blog!</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/02/07/1612335.html" title="Info on the new Mongolian keyboard layout?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/02/06/1607855.html" title="What are the fonts in Vista?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-02-06">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/02/06/1609072.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>