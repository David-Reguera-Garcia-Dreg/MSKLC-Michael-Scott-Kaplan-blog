<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/02/10/1640807.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Could you say that again? I am having trouble parsing it...</title></head><body>
<h1>Could you say that again? I am having trouble parsing it...</h1>
<p><em>by Michael S. Kaplan, published on 2007/02/10 03:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/02/10/1640807.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>As a good principle to follow (if not a downright rule), you should always try to match up the methods you use to convert values both into and back out of strings.</P>
<P>(I am assuming that matching methods to perform both operations are of course available; this is of course not always the case!)</P>
<P>I was reminded of this principle again the other day when Venkat asked me:</P>
<BLOCKQUOTE><FONT face="Times New Roman,Times" size=2><I>
<P>Hi,<BR><BR>I am working on Internationalization of my current project. <BR><BR>I have taken care most of the aspects like externalizing strings to resources, message file and formating date using COleDateTime::Format(). One scenario I have is I have to handle user input float/double values based on current Locale. ie When current Locale is German then I have to support value 3.000,67 (or) 300.000,4. I have gone through article CRTSynch from code project. Which ensures both C-runtime routine and current Thread locale context are in Sync. I need suggestion for handling float numbers based on current Locale as explained in example. Even if I use setLocale() still I am not getting expected result . eg: _tcstod( _T("3.000,6", NULL) should give me double value of 3000.6 instead it gives me 3.000 ie it is handling decimal symbol not the digit Grouping symbol.<BR><BR>Any type of suggestion is welcome.<BR><BR>Thanks,<BR><BR>Venkat.</P></I></FONT></BLOCKQUOTE>
<P mce_keep="true">Well, if one is using COM (which usually takes an LCID)&nbsp;to format the values into strings, then one should also use COM to parse them out of the string. In this case, <A class="" href="http://msdn2.microsoft.com/library/ms221634.aspx" mce_href="http://msdn2.microsoft.com/library/ms221634.aspx">VariantChangeTypeEx</A> will do a nice job taking a&nbsp;Variant containing a BSTR and converting it to a Variant containing a Double -- just pass the right LCID and the parsing will simply work in strings like the one Venkat provided.</P>
<P mce_keep="true">The code might look something like this (I am assuming COM has already been initialized since there were other COM calls going on!):</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier" size=2><B>
<P mce_keep="true">VARIANT vDouble, vString;<BR>BSTR string = SysAllocString(L"3.000,6");<BR><BR>VariantInit(&amp;vDouble);<BR>VariantInit(&amp;vString);<BR><BR>vString.vt = VT_BSTR;<BR>vString.bstrVal = string;<BR>VariantChangeType(&amp;vDouble, &amp;vString, 0, VT_R8);<BR><BR>VariantClear(&amp;vString);<BR>VariantClear(&amp;vDouble);</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">You get the idea. The value in vDouble will be <STRONG>3000.6</STRONG>, not <STRONG>3.000</STRONG>.&nbsp;Behind the scenes it is doing a whole bunch of potential work here (well, actually I guess it is "undoing" some work in this case!)&nbsp;-- about as much as COM will do to format, in fact.</P>
<P mce_keep="true">Interestingly, there is even an old 1999 <A class="" href="http://msdn.microsoft.com/archive/default.asp?url=/archive/en-us/dnarguion/html/drgui032999.asp" mce_href="http://msdn.microsoft.com/archive/default.asp?url=/archive/en-us/dnarguion/html/drgui032999.asp">Dr. GUI article</A> that talks about using that function for the locale-specific parsing. :-)</P>
<P mce_keep="true">The C Runtime does not have a function that will do full service parsing here, though since the string was not produced by the CRT anyway, it makes sense that the CRT would not know much about how to parse it later....</P>
<P mce_keep="true">&nbsp;</P>
<P mce_keep="true"><FONT color=#ff00ff><EM>This post brought to you by</EM>&nbsp;<FONT size=5>Ã–</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/00d6" mce_href="http://www.fileformat.info/info/unicode/char/00d6">U+00d6</A>, a.k.a. LATIN CAPITAL LETTER O WITH DIARESIS)</EM></FONT></P>
<hr/><p><a id="1641648" href="#1641648">#</a> <strong>Haali</strong> on 10 Feb 2007 3:14 AM:</p><div style="margin-left: 1em"><p>There is no need to call SysFreeString, VariantClear frees the BSTR itself.</p></div>
<p><a id="1642980" href="#1642980">#</a> <strong>Michael S. Kaplan</strong> on 10 Feb 2007 8:05 AM:</p><div style="margin-left: 1em"><p>Good point, Haali! :-)</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/02/11/1657463.html" title="MSKLC can&#39;t do everything, even in the 1.4 version">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/02/09/1632443.html" title="From URI to IRI, in just one version">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-02-10">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/02/10/1640807.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>