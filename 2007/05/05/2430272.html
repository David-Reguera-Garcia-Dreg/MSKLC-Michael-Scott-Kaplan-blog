<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/05/05/2430272.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>All right, mistakes were made #1 (a.k.a. Expanding the EXPANSION table)</title></head><body>
<h1>All right, mistakes were made #1 (a.k.a. Expanding the EXPANSION table)</h1>
<p><em>by Michael S. Kaplan, published on 2007/05/05 12:36 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/05/05/2430272.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>(Apologies for the Dogma/Carlin allusion in the title)</P>
<P>It was funny how it all happened.</P>
<P>Not funny Ha-Ha, more like funny interesting.</P>
<P>It is about a bug.</P>
<P>Maybe I should explain.</P>
<P>I have mentioned EXPANSIONS in the past, and how you can access them directly, at least the ones in&nbsp;DEFAULT collation&nbsp;table (ref: <A href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html" mce_href="http://archives.miloush.net/michkap/archive/2005/07/09/437071.html"><STRONG>Why doesn't FoldString take an LCID?</STRONG></A>).</P>
<P>The way it works? Well, the DEFAULT collation table entry for these characters has a pointer to the special EXPANSIONS table. So the&nbsp;DEFAULT table would look something like this:</P>
<BLOCKQUOTE>
<P><FONT face="Courier New"><STRONG>0x00c6&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 0<BR>...<BR>0x00e6&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 1<BR>...<BR>0x0152&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 2<BR>0x0153&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 3<BR>...<BR>0x01c4&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 4<BR>0x01c5&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 5<BR>0x01c6&nbsp;&nbsp; 2&nbsp;&nbsp; 0&nbsp;&nbsp; 0&nbsp;&nbsp; 6<BR>...</STRONG></FONT></P></BLOCKQUOTE>
<P>and so on, and the EXPANSION table would look something like this (note the order&nbsp;of the entries below&nbsp;corresponding to that last number in each entry above):</P>
<BLOCKQUOTE>
<P><FONT face="Courier New"><STRONG>0x00c6&nbsp;&nbsp;&nbsp; 0x0041&nbsp;&nbsp;&nbsp; 0x0045&nbsp;&nbsp;&nbsp; ; Æ --&gt; A + E<BR>0x00e6&nbsp;&nbsp;&nbsp; 0x0061&nbsp;&nbsp;&nbsp; 0x0065&nbsp;&nbsp;&nbsp; ; æ --&gt; a + e<BR>0x0152&nbsp;&nbsp;&nbsp; 0x004f&nbsp;&nbsp;&nbsp; 0x0045&nbsp;&nbsp;&nbsp; ; Œ --&gt; O + E<BR>0x0153&nbsp;&nbsp;&nbsp; 0x006f&nbsp;&nbsp;&nbsp; 0x0065&nbsp;&nbsp;&nbsp; ; œ --&gt; o + e<BR>0x01c4&nbsp;&nbsp;&nbsp; 0x0044&nbsp;&nbsp;&nbsp; 0x017d&nbsp;&nbsp;&nbsp; ; <FONT face=T>Ǆ</FONT> --&gt; D + Ž<BR>0x01c5&nbsp;&nbsp;&nbsp; 0x0044&nbsp;&nbsp;&nbsp; 0x017e&nbsp;&nbsp;&nbsp; ; ǅ --&gt; D + ž<BR>0x01c6&nbsp;&nbsp;&nbsp; 0x0064&nbsp;&nbsp;&nbsp; 0x017e&nbsp;&nbsp;&nbsp; ; ǆ --&gt; d + ž<BR>...</STRONG></FONT></P></BLOCKQUOTE>
<P>and so on. Easy, right?</P>
<P>Now turning it off in particular locales is&nbsp;quite important --&nbsp;after all, in Icelandic, Æ/æ do not expand to AE/ae. At all. One may as well claim that the letter <STRONG>b</STRONG> in English should expand to <STRONG>l</STRONG> and <STRONG>o</STRONG> or something!</P>
<P>Luckily it is also easy -- just add an EXCEPTION entry for the locale that replaces the pointer to the EXPANSION table with the appropriate weight for the code point.</P>
<P>It was maybe&nbsp;six months before that post, I was trying to figure out if future versions might require the ability to do more than just remove EXPANSIONS but maybe even add them for a particular locale. </P>
<P>Julie didn't remember it coming up, and Cathy didn't either. <A href="http://blogs.msdn.com/kierans" mce_href="http://blogs.msdn.com/kierans">Kieran</A> thought it might be needed some day (though she couldn't think of any, offhand). So the idea was filed away in one of those various explanatory documents that had been popping up, in case it was needed.</P>
<P><EM>(Intuitive folks might see at this point (especially with the hint that there is something to see here!)&nbsp;what Julie and Cathy had pretty much forgotten about and what didn't occur to Kieran or I or anyone else who was thinking about the issue.)</EM></P>
<P>Now in the meantime,&nbsp;as a feature the EXPANSION table had grown a lot in Vista.</P>
<P>In prior versions it had only 37 entries in it, but there were a whole lot of languages using characters across Unicode that could benefit, so many were added to the table (711 in all). Since no one really wanted to have to maintain both this bigger EXPANSION table and the 711 pointers to the items in it from the DEFAULT table, some work was done to take this derived data and&nbsp;simply derive it -- generate those 711 pointers when the data is being built.</P>
<P>I recall being a bit nervous about the idea,&nbsp;but after talking to the former development and PM owners (who actually remembered times that this kind of derived data has fallen out of sync in the past) and some others from the team, the decision was made to proceed with the plan -- and the 711 pointers to the EXPANSION table were now added at build time, and removed from the source. They weren't needed anyway, right?</P>
<P>Coming soon in post #2, how&nbsp;mistaken we all were (but especially how&nbsp;mistaken I was)</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff0080><EM>This post brought to you by</EM> œ <EM>(<A href="http://www.fileformat.info/info/unicode/char/0153" mce_href="http://www.fileformat.info/info/unicode/char/0153">U+0153</A>, a.k.a. LATIN SMALL LIGATURE OE)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2007/09/15 <a href="http://archives.miloush.net/michkap/archive/2007/09/15/4924008.html">A&P of Sort Keys, part 5 (aka EXPANSIONing your horizons)</a></p><p>2007/09/08 <a href="http://archives.miloush.net/michkap/archive/2007/09/08/4831056.html">2001, a Correctness Odyssey (aka What's the matter with Ü?)</a></p><p>2007/05/05 <a href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html">All right, mistakes were made #2 (What the %#$* is wrong with German Phonebook sorting?)</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/05/05/2430935.html" title="All right, mistakes were made #2 (What the %#$* is wrong with German Phonebook sorting?)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/05/04/2407782.html" title="The limitations of keyboard layouts (again)">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-05-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/05/05/2430272.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>