<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/05/18/2710448.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Not spacing out on spacing forms of characters</title></head><body>
<h1>Not spacing out on spacing forms of characters</h1>
<p><em>by Michael S. Kaplan, published on 2007/05/18 09:43 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2007/05/18/2710448.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Chris asks:</P>
<BLOCKQUOTE><FONT face="times new roman,times" size=2>
<P><EM>I have a question about ToUnicodeEx and its behavior when detecting dead-keys. It wants to put the spacing-version of the accent into the string buffer, but I am looking for a way to get the non-spacing equivalent. Is there system call somewhere that I missed, or some mapping table that maps the spacing accents to their non-spacing equivalents?<BR><BR>Thanks in advance,<BR><BR>Chris</EM></P></FONT></BLOCKQUOTE>
<P>This question is an interesting one because the answer involves data that is for the most part not included in the actual dead keys. </P>
<P>Both <A class="" href="http://msdn2.microsoft.com/library/ms646320.aspx" mce_href="http://msdn2.microsoft.com/library/ms646320.aspx">ToUnicode</A> and <A class="" href="http://msdn2.microsoft.com/library/ms646322.aspx" mce_href="http://msdn2.microsoft.com/library/ms646322.aspx">ToUnicodeEx</A> work off the data that is in the keyboard layout. So when the docs say that a return value of -1 means</P>
<BLOCKQUOTE>
<P><EM>The specified virtual key is a dead-key character (accent or diacritic). This value is returned regardless of the keyboard layout, even if several characters have been typed and are stored in the keyboard state. If possible, even with Unicode keyboard layouts, the function has written a spacing version of the dead-key character to the buffer specified by pwszBuff. For example, the function writes the character SPACING ACUTE (0x00B4), rather than the character NON_SPACING ACUTE (0x0301).</EM></P></BLOCKQUOTE>
<P>the fact is that the reason&nbsp;that the statement about spacing characters is true is that this is the only data that is&nbsp;actually in the dead key chain.&nbsp;</P>
<P><EM>(Of course this sentence has other weird things it is saying about the keyboard state that I'll talk about another day!)</EM></P>
<P>All hope is not lost, however.</P>
<P>Chris&nbsp;can actually use Unicode normalization to get the right answer.</P>
<P>You see, <A class="" href="http://www.fileformat.info/info/unicode/char/00b4" mce_href="http://www.fileformat.info/info/unicode/char/00b4">U+00b4</A> has a compatibility decomposition, which means that normalizing to either Form KC or KD will return <A class="" href="http://www.fileformat.info/info/unicode/char/0020" mce_href="http://www.fileformat.info/info/unicode/char/0020">U+0020</A> <A class="" href="http://www.fileformat.info/info/unicode/char/0301" mce_href="http://www.fileformat.info/info/unicode/char/0301">U+0301</A>. </P>
<P>So all you have to do is take the dead key value that is returned in the buffer when -1 is returned and call <A class="" href="http://msdn2.microsoft.com/library/ms776395.aspx" mce_href="http://msdn2.microsoft.com/library/ms776395.aspx">NormalizeString</A> (or <A class="" href="http://msdn2.microsoft.com/library/ebza6ck1.aspx" mce_href="http://msdn2.microsoft.com/library/ebza6ck1.aspx">string.Normalize</A> if you are in managed code), and if it returns a space and a character, then that character is the non-spacing version....</P>
<P>Now there are some cases where the dead key table (which by convention would usually be based on the spacing version like <A class="" href="http://www.fileformat.info/info/unicode/char/00b4" mce_href="http://www.fileformat.info/info/unicode/char/00b4">U+00b4</A>), is instead based on the non-spacing character from the start. This could either be a mistake in the keyboard layout authoring or it could be that no spacing version actually exists.</P>
<P>In a case like that, the normalizing call will return the original string --&nbsp;so when the call does not appear to succeed, it may have in fact succeeded in its task of giving the non-spacing version.</P>
<P>And either way you end up with the non-spacing version....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT color=#ff00ff><EM>This post brought to you by</EM> <FONT size=6>Â´</FONT> <EM>(<A class="" href="http://www.fileformat.info/info/unicode/char/00b4" mce_href="http://www.fileformat.info/info/unicode/char/00b4">U+00b4</A>, a.k.a. ACUTE ACCENT)</EM></FONT></P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/04/16 <a href="http://archives.miloush.net/michkap/archive/2011/04/16/10154700.html">Chain Chain Chain, Chain of Dead Keys</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2007/05/18/2724714.html" title="Farther in the future could I accept it being sung as Further Down?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2007/05/17/2696800.html" title="A private CultureAndRegionInfoBuilder does not imply a private CultureInfo">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2007-05-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2007/05/18/2710448.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:38 GMT -->
</html>