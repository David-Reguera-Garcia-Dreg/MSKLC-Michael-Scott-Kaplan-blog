<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/16/318271.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Thursday morning wrestling: LCID vs. HKL</title></head><body>
<h1>Thursday morning wrestling: LCID vs. HKL</h1>
<p><em>by Michael S. Kaplan, published on 2004/12/16 12:11 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2004/12/16/318271.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Time to take a look at two very important datatypes, the LCID (locale identifier) and the HKL (the handle to an input method). They have several things in common, and more importantly several crucial differences. I'll let you decide which one is better....</P>
<P>First the LCID -- its defined in (among other places) winnt.h, as follows:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New"><STRONG>typedef DWORD LCID;</STRONG></FONT></P></BLOCKQUOTE>
<P dir=ltr>Being a DWORD means it is a 32-bit value. There is&nbsp;a great diagram of how the LCID is laid out in the winnt.h header file:</P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><FONT face="Courier New"><STRONG>//<BR>//&nbsp; A locale ID is a 32 bit value which is the combination of a<BR>//&nbsp; language ID, a sort ID, and a reserved area.&nbsp; The bits are<BR>//&nbsp; allocated as follows:<BR>//<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +-------------+---------+-------------------------+<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp; Reserved&nbsp; | Sort ID |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Language ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +-------------+---------+-------------------------+<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 20 19&nbsp;&nbsp;&nbsp;&nbsp; 16 15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; bit<BR>//</STRONG></FONT><BR></P></BLOCKQUOTE>
<P dir=ltr>(The diagram was never updated to include the sort version information that now takes up some of that reserved space. But there are not yet any different sort versions so its probably not too important.)</P>
<P dir=ltr>Now the Language ID includes all of the information on language, region, and script. And LCIDs are taken as parameters in almost every single <A href="http://msdn.microsoft.com/library/en-us/intl/nls_8d0z.asp">NLS function</A>&nbsp;since they all need some locale-specific context, but almost all of them use the LANGID portion only.</P>
<P dir=ltr>Ok, now we'll look at the HKL. It is defined in (among other places) the wtypes.h header file:</P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><FONT face="Courier New"><STRONG>typedef void *HKL;</STRONG></FONT></P></BLOCKQUOTE>
<P dir=ltr>On 32-bit platforms, a void pointer is the same size as a DWORD. But not all platforms are 32-bit (more on this in a moment).</P>
<P dir=ltr>There is no great diagram of how the HKL is laid out, but if there were it would something like this on 32bit platforms:</P>
<BLOCKQUOTE dir=ltr>
<P dir=ltr><STRONG><FONT face="Courier New">//<BR>//&nbsp; An HKL&nbsp;is a pointer which is the combination of a<BR>//&nbsp; language ID and device-specific information.&nbsp; The bits are<BR>//&nbsp; allocated as follows:<BR>//<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +-----------------------+-------------------------+<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;Handle-specific info&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Language ID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; +-----------------------+-------------------------+<BR>//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp; 16 15&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; bit<BR>//</FONT></STRONG></P></BLOCKQUOTE>
<P dir=ltr>Obviously this is not a traditional sort of Windows handle value, since it has documented meaning (most handles have <EM>some</EM> meaning but it is seldom documented and the directions always say to treat them as opaque, unparseable&nbsp;values).</P>
<P dir=ltr>Now what happens when you run on a 64-bit platform? Well, nothing really. The extra 32 bits that the HKL now contains are not used. Seems like a waste, huh?</P>
<P dir=ltr>Well, not entirely. And in the long run I wish that LCIDs had been done the same way since one never knows how that data could have been used. Imagine if we had wanted the NLs functions to take the string "0409" or "0x0409" or maybe even "en-US" rather than the plain old number -- had this been a handle then it would be easy to set up a semantic where it would be a string pointer, but since it was not then it cannot be a string since there are 64-bit platforms.</P>
<P dir=ltr>Of course HKLs do not really have such a need, so for them it is just wasted space. But haven't we all been in the situation where&nbsp;a friend has something that they do not really need but that we probably could have found a use for? Thats definitely the case here -- they do have it and don't need it, we don't have it and do need it!</P>
<P dir=ltr>A little more information about HKLs -- they are not the same as keyboard layout identifiers (KLIDs). Though both contain a LANGID in the bottom WORD of the low DWORD, the top WORD of the low DWORD contains handle-specific info in one case and device-specific info in the other. </P>
<P dir=ltr>Also, there is no rule that the two LANGID values in the KLID and the HKL have to match. Since the "Add a keyboard layout" UI in Windows allows one to add a keyboard under an arbitrary language, the important distinction is that the KLID's LANGID is the intended language of the input method and the HKL's LANGID is the user-selected language of the input method. This feature can be put to use by putting (for example) one of the English (US) keyboards under the UK English language in order to give hints to Word about the language to use for spelling checks. And I'm sure you can imagine it being put to bad use by putting a keyboard under a language that has nothing to do with it and then watching programs like Word act very confused about how to use the language.</P>
<P dir=ltr>If I had to choose which I thought was more useful and&nbsp;scalable, I'd have to pick the HKL. But I guess the grass is always greener on the other side of the SDK....</P>
<hr/><div style="margin-left: 1em"><em>no comments</em></div><hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/29 <a href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html">What a tangled web we weave when a KLID from an HKL we must receive</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2004/12/17/323257.html" title="Dead keys are not intuitive">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2004/12/16/316644.html" title="Sorry to say it, but MS sucks">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12-16">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/16/318271.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>