<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/12/280196.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>(Not to alarm anyone, but) ATL can be stupid, sometimes</title></head><body>
<h1>(Not to alarm anyone, but) ATL can be stupid, sometimes</h1>
<p><em>by Michael S. Kaplan, published on 2004/12/12 10:08 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2004/12/12/280196.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Let me start by saying I think ATL is cool. It kicks ass, it takes names. But even the most incredible technology can do things that do not achieve brilliance 100% of the time....</P>
<P>This bit of code had been buried in ATL for&nbsp;a long time (the part I am calling stupid is marked in <STRONG><FONT color=#ff0000>red</FONT></STRONG>).</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" color=#000000><STRONG>static LRESULT CALLBACK StartWindowProc(HWND hWnd, UINT uMsg,&nbsp;WPARAM wParam, LPARAM lParam)<BR>{<BR>&nbsp;&nbsp;&nbsp; CContainedWindowT&lt; TBase &gt;* pThis = (CContainedWindowT&lt; TBase &gt;*)_AtlWinModule.ExtractCreateWndData();<BR>&nbsp;&nbsp;&nbsp; ATLASSERT(pThis != NULL);<BR>&nbsp;&nbsp;&nbsp; pThis-&gt;m_hWnd = hWnd;</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000000><STRONG>&nbsp;&nbsp;&nbsp; // Initialize the thunk. This was allocated in CContainedWindowT::Create,<BR>&nbsp;&nbsp;&nbsp;&nbsp;// so failure is unexpected here.</STRONG></FONT></P>
<P><FONT face="Courier New" color=#000000><STRONG>&nbsp;&nbsp;&nbsp; pThis-&gt;m_thunk.Init(WindowProc, pThis);<BR>&nbsp;&nbsp;&nbsp; WNDPROC pProc = pThis-&gt;m_thunk.GetWNDPROC();<BR>&nbsp;&nbsp;&nbsp; WNDPROC pOldProc = (WNDPROC)::SetWindowLongPtr(hWnd, GWLP_WNDPROC, (LONG_PTR)pProc);<BR>#ifdef _DEBUG<BR><FONT color=#ff0000>&nbsp;&nbsp;&nbsp; // check if somebody has subclassed us already since we discard it<BR>&nbsp;&nbsp;&nbsp; if(pOldProc != StartWindowProc)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ATLTRACE(atlTraceWindowing, 0, _T("Subclassing through a hook discarded.\n"));<BR></FONT>#else<BR>&nbsp;&nbsp;&nbsp; pOldProc;&nbsp;// avoid unused warning<BR>#endif<BR>&nbsp;&nbsp;&nbsp; return pProc(hWnd, uMsg, wParam, lParam);<BR>&nbsp;}</STRONG></FONT><BR></P></BLOCKQUOTE>
<P>I think WTL <EM>might </EM>have the same assert but I am hoping it does not. :-)</P>
<P>This StartWindowProc function is the initial WNDPROC, which is quickly replaced by the actual WNDPROC, right here in this code. After that, it is never called again. I guess the assert is there to check for when the developer has been subclassing it themselves (to warn them that they did an oopsie).</P>
<P>But its still pretty weird from my point of view. After all, the StartWindowProc WNDPROC is assigned to the window class and clearly since we are <EM>in</EM> StartWindowProc the message is getting through. So who cares if it was subclassed? Well clearly&nbsp;<EM>ATL</EM> does. But if ATL wants to have an architecture that throws away their initial WNDPROC and want to warn the developer that their subclass may never get messages, then they should stick that in their documentation, not throw asserts.&nbsp;</P>
<P>From my point of view, the point of view of the developer who wrote <A title=MSLU href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target=_blank>MSLU</A> (which has the job of wrapping all of the WNDPROCs and DLGPROCs&nbsp;that are created so that it can convert to and from Unicode not only when the application send messages but when messages are sent to the application), this is truly a bad assert. In fact, if you are using MSLU and the debug version of ATL, then you are guaranteed to have this assert fire once for each window created. Of course since (a) every call is properly routed by MSLU and (b) its never going to be called again, the fact that the vaue returned is not the same doesn't seem to matter. </P>
<P>In the MSLU case, if ATL bothered to check whether GetWindowLongPtr would return the same WNDPROC just assigned to it, they would get back a different values again. Because MSLU has to wrap this WNDPROC, too. I guess I should be glad that they do not bother to do this, or else there would be twice as many asserts. <EM>Maybe they could use that fact as a debug technique to decide whether they even should assert at all here?</EM></P>
<P>Anyway, I regularly get email and <A href="http://msdn.microsoft.com/newsgroups/default.aspx?query=mslayerforunicode">newsgroup</A> postings from people using MSLU who hit the assert and wonder what they might be doing wrong (or alternately, why MSLU appears to be so damn broken -- depending on the personality, mood, and temperment&nbsp;of the one asking the question).</P>
<P>Which indirectly points to what may be one of the&nbsp;key definitions of stupidity I have -- something responsible for wasting my time, needlessly. :-)</P>
<hr/><p><a id="280230" href="#280230">#</a> <strong>.</strong> on 12 Dec 2004 10:46 AM:</p><div style="margin-left: 1em">Why do people still use crap technologies like this on &quot;NEW&quot; applications?  Especially having eggs in one basket when its not cross platform either.</div>
<p><a id="280232" href="#280232">#</a> <strong>michkap</strong> on 12 Dec 2004 10:50 AM:</p><div style="margin-left: 1em">Not sure which technology you mean here (MSLU or ATL).<br><br><a title="MSLU" href="http://www.microsoft.com/globaldev/handson/dev/mslu_announce.mspx" target="_blank">MSLU</a> does not require application changes, it just lets your apps support Unicode, even if you have customers who refuse to upgrade from Win9x.<br><br>ATL is getting bigger all the time, but there is still a lot of use to it.<br><br>People spend a lot of time talking about cross-platform, but the number of people who actually &lt;b&gt;do&lt;/b&gt; cross platform work is pretty small. Most people write for one, using the skills and tools they know....</div>
<p><a id="323763" href="#323763">#</a> <strong>Michael Kaplan</strong> on 17 Dec 2004 1:39 PM:</p><div style="margin-left: 1em">That updated assert would look something like: <br><br><br>// check if somebody has subclassed us already since we discard it <br>if(pOldProc != StartWindowProc) <br>{ <br>if(pProc == (WNDPROC)GetWindowLongPtr(hWnd, GWLP_WNDPROC)) <br>{ <br>ATLTRACE(atlTraceWindowing, 0, _T(&quot;Subclassing through a hook discarded.\n&quot;)); <br>} <br>}</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2004/12/13/281187.html" title="Regional Options is not intuitive (Duh!)">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2004/12/11/280129.html" title="I guess BIOS.NET may be on the way?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12-12">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/12/280196.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>