<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/05/275231.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How do I get the @!#$% name of the keyboard?</title></head><body>
<h1>How do I get the @!#$% name of the keyboard?</h1>
<p><em>by Michael S. Kaplan, published on 2004/12/05 02:02 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2004/12/05/275231.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>I hinted at some of the problems with the HKL concept in my <a href="http://archives.miloush.net/michkap/archive/2004/11/27/270931.html">list of keyboarding terms</A>. But I do have several ex-girlfriends who have in common the fact that they all think I suck at the subtle thing and should stop trying to do it. So here follows the formal discussion of the problems with terminology and meaning regarding the HKL in Windows.</P>
<P>Much of what follows is stuff I learned&nbsp;during the time that&nbsp;MSKLC was being developed -- I had to dig down deep into keyboard layouts, and I got the chance to see how complicated some parts of it are (not to mention how convoluted).</P>
<P>The problem starts as a&nbsp;terminology thing. HKL [obviously] originally meant "handle to a keyboard layout" but in recognition of the fact that there are all sorts of things beyond keyboards, they are now defined vaguely in the Platform SDK as the input locale identifier (ignore the fact that they are not identifiers and they are certainly not locales).&nbsp;Also, according to the <A title=GetKeyboardLayout href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/getkeyboardlayout.asp" target=_blank>GetKeyboardLayout</A> topic (and I think <EM>this</EM> is a longstanding definition), the "...low word contains a language identifier&nbsp;for the input language and the high word contains a device handle for the physical layout of the keyboard. </P>
<P>Obviously this can be wrong since on some platforms that handle is 64 bits&nbsp;and what they really mean is the high word of the low dword. It is also kind of misleading anyway since if I have a single US-English keyboard loaded and I call GetKeyboardLayout then it will return 0x409, meaning that the high word is 0x0000 -- an invalid value for a handle by almost anyone's definition.</P>
<P>Then we get to usefulness problems. Notice that there is no real information about the keyboard layout itself there? There is language information, but its not the language of the keyboard layout itself, its the language that the user put it under after choosing the language/layout pair in the "add keyboard layout" UI.</P>
<P>So what do I do if I want to find out what the layout actually <STRONG>is</STRONG>? You know, say I wanted to (for example) load it again some day for the user, or even just get the name they see when they added the keyboard? Well, <STRONG>if its the currently selected layout</STRONG> in a thread then you can call the <A title=GetKeyboardLayoutName href="http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/userinput/keyboardinput/keyboardinputreference/keyboardinputfunctions/getkeyboardlayoutname.asp" target=_blank>GetKeyboardLayoutName</A> API, which claims it "retrieves the name of the active input locale identifier (formerly called the keyboard layout). Only it doesn't. It returns an 8-character string that contains the KLID, which is not really much of a name unless you speak a language that has words like "00030409" in its vocubulary. </P>
<P>The rest of the people in the world (including me) want the actual <EM>name</EM> and expect to get back "United States-Dvorak for left hand". To get that, I now have to go to HKLM\SYSTEM\CurrentControlSet\Control\Keyboard Layouts\00030409 and look for the "Layout Text" value. Or maybe I have an MUI copy of Windows and have changed my language and am on Windows &gt;= XP that string will not be translated appropriately, so I have to look at&nbsp;the "Layout Display Name" value, which has the helpful string "@%SystemRoot%\system32\input.dll,-5027" in it -- which thankfully can be sent to SHLWAPI's <A title=SHLoadIndirectString href="http://msdn.microsoft.com/library/en-us/shellcc/platform/shell/reference/shlwapi/string/shloadindirectstring.asp" target=_blank>SHLoadIndirectString</A> to get the name. In the back of my mind I have to remember that its all subject to change since none of it is documented.</P>
<P>Now what about if its not the&nbsp;currently selected layout? Well, in that case, yuck. Because there is not currently a GetKeyboardLayoutNameEx that takes an HKL. Given&nbsp;the indirect nature of these handle-esque things, I would have to spend a bunch of time in the undocumented values under the HKCU\Keyboard Layout\Preload and HKCU\Keyboard Layout\Substitutes keys. Again, in the back of my mind I have to remember that its all subject to change since none of it is documented. Which makes it even less appealing to figure out the Preload and Substitutes mappings (in case I were enough of a masochist that I found it appealing up until that point)....</P>
<P>Now its a little expensive, but I can't help wondering whether it would be easier to just create a new thread and switch the layout <EM>there</EM>, after which a call to GetKeyboardLayoutName would work just fine. No one would get any special notifications, and there is no dependency on undocumented registry cruft.</P>
<P>Or maybe I should send&nbsp;a plea for GetKeyboardLayoutNameEx&nbsp;somewhere? :-)</P>
<hr/><p><a id="275247" href="#275247">#</a> <strong>Uwe Keim</strong> on 5 Dec 2004 2:41 AM:</p><div style="margin-left: 1em">Functions ending on &quot;...Ex()&quot; always seem strange to me. Kind of &quot;botchiness&quot; (if my german-english translator gave me the correct word for this... :-)</div>
<p><a id="275253" href="#275253">#</a> <strong>michkap</strong> on 5 Dec 2004 4:08 AM:</p><div style="margin-left: 1em">It is interesting, but the reasons seem different for each area of the Win32 API where they have happened. In NLS, the -Ex versions of functions add stuff that was not thought of. This is of course the most common usage, and it kind of sloppy but better than the alterntives (whole new API names for extensions, or simply not shipping new functionality).<br><br>In the keyboarding section of USER, on the other hand, every -Ex version is the same as the non-Ex version except it adds an HKL parameter to extend the API beyond the current user-selected HKL. In their case, I see a consistency that is kind of comforting....</div>
<p><a id="275305" href="#275305">#</a> <strong>.</strong> on 5 Dec 2004 9:34 AM:</p><div style="margin-left: 1em">Ahh the beauty of overloading or versioning, why bother with flat C and so on with all these problems, flat C and C++ is NOT an APPLICATION language and never was designed to be such. ITs a system language. You chose the wrong language if you use it as an app language.</div>
<p><a id="275379" href="#275379">#</a> <strong>michkap</strong> on 5 Dec 2004 3:13 PM:</p><div style="margin-left: 1em">Ah, this is an interesting thought -- I started to answer and then I realized that the topic deserves its very own posting. Look for it some time this week! :-)</div>
<p><a id="6717722" href="#6717722">#</a> <strong>Eli Golovinsky</strong> on 9 Dec 2007 7:37 PM:</p><div style="margin-left: 1em"><P>I found this post looking for a way to generate a list of installed keyboard layouts like the one that the Language Bar shows when you click on it. After much digging, I found out that it doesn't display the name of the keyboard, but the name of the currently chosen language. </P>
<P>That is apparently much easier to discover, although not less contrived.</P>
<P>&nbsp; &nbsp;char name[MAXLEN];<BR>&nbsp;&nbsp;&nbsp;HKL hkls[256];<BR>&nbsp;&nbsp;&nbsp;count = GetKeyboardLayoutList(MAX_LAYOUTS, hkls);<BR><BR>&nbsp;&nbsp;&nbsp;for(int i = 0; i &lt; info-&gt;count; i++)<BR>&nbsp;&nbsp;&nbsp;{<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LANGID language = (LANGID)(((UINT)hkls[i]) &amp; 0x0000FFFF); // bottom 16 bit of HKL is LANGID<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LCID locale = MAKELCID(language, SORT_DEFAULT);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetLocaleInfo(locale, LOCALE_SLANGUAGE, name, MAXLEN);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString(name);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OutputDebugString("\n");<BR>&nbsp;&nbsp;&nbsp;}<BR><BR>Hope this helps someone someday.</P></div>
<p><a id="6718430" href="#6718430">#</a> <strong>Michael S. Kaplan</strong> on 9 Dec 2007 9:02 PM:</p><div style="margin-left: 1em"><p>Hi Eli,</p>
<p>Not sure I understand here -- the topic is about getting keyboard names, not locale names (which is what LOCALE_SLANGUAGE will return). </p>
<p>Though the locale names are fine too, &nbsp;what will you do when more than one is under the same locale (much more common than the same keyboard under two different locales!)....</p>
</div>
<p><a id="6718440" href="#6718440">#</a> <strong>Michael S. Kaplan</strong> on 9 Dec 2007 9:03 PM:</p><div style="margin-left: 1em"><P>And if course it won't work so well for custom locales and custom keyboard languages....</P></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2008/09/29 <a href="http://archives.miloush.net/michkap/archive/2008/09/29/8968315.html">What a tangled web we weave when a KLID from an HKL we must receive</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2004/12/05/275412.html" title="Editorial Policy...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2004/12/04/274926.html" title="Machine translation is not EASY">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12-05">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/05/275231.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>