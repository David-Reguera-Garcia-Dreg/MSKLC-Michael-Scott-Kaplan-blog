<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/30/344389.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>How do sort keys work?</title></head><body>
<h1>How do sort keys work?</h1>
<p><em>by Michael S. Kaplan, published on 2004/12/30 12:04 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2004/12/30/344389.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>A Sort key&nbsp;is&nbsp;basically an array of bytes. The intention of the sort key is to make for faster comparisons of strings, so that if you compare the sort key values for two strings you will get the same results as comparing the strings themselves. They abstract out all of the irrelevant data (for example if you use NORM_IGNORECASE or <A title=CompareOptions href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationcompareoptionsclasstopic.asp" target=_blank>CompareOptions</A>.IgnoreCase) then the binary sort key for "AAAA", "AaAa", and &nbsp;"aaaa" will all be identical. As such, sort keys make a great basis for an index of string values, like you would have in a database engine.</P>
<P>But how are they structured to allow this to happen?</P>
<P>They have the same architecture in both managed code (via the <A title=SortKey href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationsortkeyclasstopic.asp" target=_blank>SortKey</A> class) and unmanaged code (via <A title=LCMapString href="http://msdn.microsoft.com/library/en-us/intl/nls_5s2v.asp" target=_blank>LCMapString</A> with the LCMAP_SORTKEY flag). The structure is described in the LCMapString topic in the Platform SDK:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New" size=2><STRONG><FONT color=#0000ff>[all Unicode sort weights] 0x01 [all Diacritic weights] 0x01 [all Case weights] 0x01 [all Special weights] 0x00</FONT> </STRONG></FONT></P>
<P><FONT color=#0000ff size=2>Note that the sort key is null-terminated. This is true regardless of the value of cchSrc. Also note that, even if some of the sort weights are absent from the sort key, due to the presence of one or more ignore flags in dwMapFlags, the 0x01 separators and the 0x00 terminator are still present.</FONT></P></BLOCKQUOTE>
<P>The reason for this structure is that the primary weights (called the Unicode weights, above) need to take priority over secondary weights (called Diacritic weights, above), which themselves have to take priority over the tertiary weights (called Case weights, above), and so&nbsp;forth.&nbsp;In this way, all of the following examples are true when using the invariant locale/culture, as described in the <a href="http://archives.miloush.net/michkap/archive/2004/12/29/344136.html">last post</A>:</P>
<BLOCKQUOTE dir=ltr>
<P><FONT face="Courier New">AAA<FONT color=#ff0000>A</FONT>&nbsp;&nbsp;&nbsp;&lt;&nbsp;&nbsp;&nbsp;AAA<FONT color=#ff0000>B</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(primary difference)<BR>A<FONT color=#ff0000>A</FONT>AA&nbsp;&nbsp;&nbsp;&lt;&nbsp;&nbsp;&nbsp;A<FONT color=#ff0000>Ã</FONT>AA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(secondary difference)<BR><FONT color=#ff0000>a</FONT>aaa&nbsp;&nbsp;&nbsp;&lt;&nbsp;&nbsp;&nbsp;<FONT color=#ff0000>A</FONT>AAA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(tertiary difference)<BR>AÃA<FONT color=#ff0000>A</FONT>&nbsp;&nbsp;&nbsp;&lt;&nbsp;&nbsp;&nbsp;AAA<FONT color=#ff0000>B</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(primary difference, secondary difference ignored)<BR>AAA<FONT color=#ff0000>A</FONT>&nbsp;&nbsp;&nbsp;&lt;&nbsp;&nbsp;&nbsp;aaa<FONT color=#ff0000>B</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(primary difference, tertiary difference ignored)<BR>aaa<FONT color=#ff0000>a</FONT>ab &lt;&nbsp;&nbsp;&nbsp;aaa<FONT color=#ff0000>b</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(primary difference, length and tertiary difference ignored)<BR>ＡＡＡ&nbsp; &lt;&nbsp;&nbsp;&nbsp;aa<FONT color=#ff0000>Ã</FONT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (secondary difference, special width and tertiary difference ignored)</FONT></P></BLOCKQUOTE>
<P>And so forth. For that to work, the four different categories need to be kept separate and each one needs to be put in the sort key in its entirety, and if any type of weight is ignored then that whole section will be empty.</P>
<P>You can take the sort key, this structured array of bytes, and use it as an index for the string. Comparisons of two byte arrays will always be faster than comparing the string themselves.</P>
<P>This of course assumes that the sort keys are pre-calculated, like in an index. If they are not and you are looking at the difference between caculating then comparing the sort key values for two strings versus comparing the strings themselves, the string comparison will almost certainly be faster. The reason for that is that the sort key calculation involves analyzing the information of the entire string (and still does not include the actual comparison) whereas string comparisons will exit as soon as they can come up with an answer to the question of which one comes first. </P>
<P>I was doing a presentation a few years ago and it occurred to me that looking at direct string comparison versus sort key calculation/comparison was like looking at the "retail" version of collation vs. the "Wholesale" one. Only some people in the crowd felt it was an illuminating analogy, and I once again learned that I should not blurt out "good ideas thst suddenly occur to me" when I am in the middle of a presentation. :-)</P>
<P>One last thought --&nbsp;no, there is not an Ordinal type of sort key. Because Ordinal comparisons are already done in a binary manner!</P>
<P>&nbsp;</P>
<P><FONT color=#800080><EM>This post brought to you by</EM> "р" <EM>(U+0440, a.k.a. CYRILLIC SMALL LETTER ER)</EM></FONT></P>
<hr/><p><a id="346634" href="#346634">#</a> <strong>Norman Diamond</strong> on 4 Jan 2005 5:25 PM:</p><div style="margin-left: 1em">I don't know of any language with an &quot;A with tilde&quot; letter, so would like to ask about languages with an &quot;n with tilde&quot; letter.  Notice that I misdescribed the letter, it is more appropriate to call it &quot;enye&quot;.  (As an analogy, in languages that have an &quot;O with bottom tilde&quot; letter, it is appropriate to call that letter &quot;queue&quot;.)<br><br>To the best of my understanding, in languages that have an enye, it is a different letter from an en.  It is not a secondary difference in the way that you described for a diacritic on an A, it is a primary difference (just as queue is a different letter from oh).  Does Windows consider the locale in deciding whether to recognize a difference as primary or as secondary?<br><br>I'm not sure whether to ask further about how the array of bytes is treated under different locales.  For example in some languages &quot;ng&quot; is a single letter even though it looks exactly the same as the pair of letters &quot;n&quot; and &quot;g&quot;.  In some languages &quot;ch&quot; is a letter.<br><br>In the Library of Congress locale, I'm not sure if a leading &quot;Mc&quot; or &quot;Mac&quot; on a name is treated as a single letter or not, but have read that they are treated as identical (&quot;McDonald&quot; comes before &quot;MacHenry&quot; because both start with that identical prefix, one followed by a D and one followed by an H).  OK, the Library of Congress locale probably doesn't have sort keys treated as arrays of bytes, it's probably somewhere on the road to being a phonebook sort.  But my other questions still hold.</div>
<p><a id="346643" href="#346643">#</a> <strong>Michael Kaplan</strong> on 4 Jan 2005 5:36 PM:</p><div style="margin-left: 1em">The point is that not all languages DO have such a letter -- ENGLISH does not. If I sort data using the English LCID, it is an N with a squiggle on it, and nothing more.<br><br>Think of it as &quot;all of Unicode, according to a particular language&quot; and then you will see what is being done here.<br><br>Given that fact, it becomes clear that the sort keys will vary depending on the locale that is passed to the API. It has to, since the meaning and the way things sort changes with each locale.<br><br>On languages that treat 'ch' as a unique sort element that sorts have 'c' but before 'd', there will obviously be differences in the sort key -- there has to be.<br><br>There is no &quot;library of congress&quot; locale on Windows and I do not work for the library of congress so I cannot comment on how they would implement such a sort. I have ideas how we might, but we do not have it as a request right now.</div>
<p><a id="346749" href="#346749">#</a> <strong>Norman Diamond</strong> on 4 Jan 2005 11:00 PM:</p><div style="margin-left: 1em">&gt; If I sort data using the English LCID,<br><br>Sure, but I was asking a more general question.  To me the base note appeared to be more general, but was that just me?  I guess that it's necessary to read your postings with an assumed context of &quot;Unicode US English&quot; unless you say otherwise?<br><br>&gt; There is no &quot;library of congress&quot; locale on<br>&gt; Windows<br><br>Yeah I know, and I doubt that there is in most OSes.  Nonetheless their sort ordering has enough arcane rules that there used to be printed instructions near card catalogs in libraries.  In ancient history, card catalogs were made from bits of dead trees with physical markings on them.  In order to obtain full search results, it was not sufficient to depend on the card catalog being consistent with its own ordering, users also had to make themselves consistent with it.  In modern times it wouldn't even matter if the invariant locale were used, because it doesn't matter what sort ordering the computer uses internally in its database, as long as searches find all matches.</div>
<p><a id="346775" href="#346775">#</a> <strong>Michael Kaplan</strong> on 5 Jan 2005 12:09 AM:</p><div style="margin-left: 1em">Hardly, dude. What I said also applies to Thai. Or to Russian. Or to any number of languages that do not recognize as a unique letter with prfimary weight N with a tilde.<br><br>To them, it is a N with a smudge on it.<br><br>Their opinion is valid and measningful, and we work to make it happen for them as they expect.<br><br>Lets drop the card catalog stuff, it really has very little to do with the topic here.</div>
<p><a id="347146" href="#347146">#</a> <strong>Arjen Poutsma</strong> on 5 Jan 2005 1:42 PM:</p><div style="margin-left: 1em">I don't know if you have anything to do with it, but I consider .NET class <a title="SortKey" href="http://msdn.microsoft.com/library/en-us/cpref/html/frlrfsystemglobalizationsortkeyclasstopic.asp" target="_blank">SortKey</a> as one ugliest kludges of the entire .NET framework, especially if you compare it with the Java CollationKey class. Why? <br><br>First, there is the static Compare method, but the SortKey does not implement IComparable, nor IComparer. This makes it pretty hard to store them in sortable collections as the ArrayList.<br><br>Second, the Equals and GetHashCode() of SortKey operate on both the byte array _and_ the original string. Imagine a scenario where you have a set of localized strings, and you want to check whether the set contains a certain word in various spellings. So the list might contain the German &quot;wei&#223;&quot;, which means it also contains &quot;weiss&quot;.<br>One would think that the fastest ways to implement this using .NET is to create a Hashtable with SortKeys as keys, and to check whether the table contains a certain key. However, since the Equals and GetHashcode also operate on the original string, it will not work. The byte arrays might be equal for wei&#223; and weiss, but the original strings are not.<br><br>Both of these issues can be resolved (the first by writing a custom IComparer which uses SortKey.Compare; the second by a custom IHashCodeProvider which only relies on the byte array), but kludges they remain.</div>
<p><a id="347331" href="#347331">#</a> <strong>Norman Diamond</strong> on 5 Jan 2005 4:34 PM:</p><div style="margin-left: 1em">&gt; What I said also applies to Thai. Or to<br>&gt; Russian. Or to any number of languages that<br>&gt; do not recognize as a unique letter with<br>&gt; prfimary weight N with a tilde.<br><br>OK, this time wording &quot;implies&quot; (in a human manner, not mathematical manner, of implying) that for languages that do have enye as a unique letter, Microsoft's sort keys will recognize their primary weight.  Let's hope they do.<br><br>(Learn to do the same for the yen sign in Japanese and maybe you'll get fewer complaints from Japanese customers.)</div>
<p><a id="347349" href="#347349">#</a> <strong>Michael Kaplan</strong> on 5 Jan 2005 5:06 PM:</p><div style="margin-left: 1em">I do not need to hope -- I know it works.<br><br>As for the Yen, you are the only one complaining. Everyone else has expressed either nothing lor joy that we take two things that look the same and say they are equivalent. :-)</div>
<p><strong>bhushan</strong> on 5 Apr 2011 2:40 AM:</p><div style="margin-left: 1em"><p>thanks a lot ... </p>
<p>Nice explaination....</p></div>
<p><strong>Alexander Savin</strong> on 1 Dec 2011 5:06 PM:</p><div style="margin-left: 1em"><p>If I need to generate a sort key for the string I have to call LCMapString twice:</p>
<p>bufferSize = LCMapStringW(..., 0);</p>
<p>...Allocate buffer...</p>
<p>LCMapStringW(..., bufferSize);</p>
<p>Is there a performance flaw in this approach? Doesn&#39;t this imply that LCMapString does a double work? Does LCMapString need to scan an input string to determine the sort key size?</p>
<p>If it does, I would very much prefer having an ability to pass, in a single call, the pre-allocated buffer size and having LCMapString return the required buffer size if the input one appears to be not large enough.</p>
<p>What about the following approach (if I don&#39;t need a sort key itself but only its hash code)?</p>
<p>...Allocate 512 bytes on stack...</p>
<p>sortKeySize = LCMapStringW(..., 512);</p>
<p>if (sortKeySize == 0)</p>
<p>{</p>
<p> &nbsp; &nbsp;sortKeySize = LCMapStringW(..., 0);</p>
<p> &nbsp; &nbsp;...Allocate buffer...</p>
<p> &nbsp; &nbsp;LCMapStringW(..., sortKeySize);</p>
<p>}</p>
<p>...Calc hash...</p>
<p>It does a triple work in the worst case but should work faster in most cases. Shouldn&#39;t it?</p>
<p>Also, having to estimate the worst sort key size, considering an input string has the length of N, is it true that its sort key is no longer than (2*N + 1)*4?</p>
<p>And if IgnoreCase is specified, for example, will the [all Case weights] section be empty?</p>
<p>Michael, it would be very helpful if you could clarify all this? Thanks.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 8 Dec 2011 7:20 AM:</p><div style="margin-left: 1em"><p>Answers <strong><a href="http://archives.miloush.net/michkap/archive/2011/12/08/10245601.html">here</a></strong>....</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/12/08 <a href="http://archives.miloush.net/michkap/archive/2011/12/08/10245601.html">Sort keys - answers to several questions</a></p><p>2007/09/10 <a href="http://archives.miloush.net/michkap/archive/2007/09/10/4847780.html">A&P of Sort Keys, part 0 (aka The empty string sorts the same in every language)</a></p><p>2006/11/25 <a href="http://archives.miloush.net/michkap/archive/2006/11/25/1151550.html">Punctuation... now, isn't that SPECIAL [weights] ?</a></p><p>2006/06/02 <a href="http://archives.miloush.net/michkap/archive/2006/06/02/615571.html">What the @!#$% is the TERTIARY_WEIGHTS() function for?</a></p><p>2006/06/02 <a href="http://archives.miloush.net/michkap/archive/2006/06/02/615509.html">It is only of SECONDARY importance</a></p><p>2006/01/12 <a href="http://archives.miloush.net/michkap/archive/2006/01/12/511884.html">The creation of sort keys does not always make sense</a></p><p>2005/03/11 <a href="http://archives.miloush.net/michkap/archive/2005/03/11/394359.html">When good SQL queries have trouble....</a></p><p>2005/01/18 <a href="http://archives.miloush.net/michkap/archive/2005/01/18/355210.html">The jury will give this string no weight</a></p><p>2005/01/05 <a href="http://archives.miloush.net/michkap/archive/2005/01/05/346933.html">What is up with number sorting?</a></p><p>2005/01/01 <a href="http://archives.miloush.net/michkap/archive/2005/01/01/345190.html">That is not actually a bug in sort keys....</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2004/12/30/344714.html" title="Accessible crap advertising">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2004/12/29/344136.html" title="Comparison confusion: INVARIANT vs. ORDINAL">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2004-12-30">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2004/12/30/344389.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:42 GMT -->
</html>