<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/07/22/10033828.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When I say Graphics.MeasureString can hang with you, I mean it in a bad way!</title></head><body>
<h1>When I say Graphics.MeasureString can hang with you, I mean it in a bad way!</h1>
<p><em>by Michael S. Kaplan, published on 2010/07/22 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/07/22/10033828.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>I'm not up on the latest slang the kids today are using, you know?</p>
<p>I do have some of the most awesome cousins in the whole world and I am friends with them on Facebook and I can see what they say. Occasionally I can follow along, but usually I just accept that this is a dialect I cannot master....</p>
<p>It was just recently (in <a href="http://archives.miloush.net/michkap/archive/2010/07/10/10031197.html" title="It's a bug, it's always been a bug. In either direction...."><strong>It's a bug, it's always been a bug. In either direction....</strong></a>) that I was talking about some specific issues that worked the way a user moight expect in Word and WordPad and RichEdit but did not behave in such a way&nbsp;when GDI+ was used.</p>
<p>The behavior is one requested/demanded in the current version of the Unicode Bidi algoroithm, so that really was not a bug!</p>
<p>This is not an issue like that.</p>
<p>No sir.</p>
<p>This is a bug</p>
<p>Everyone would call it such.</p>
<p>The description:</p>
<p class="MsoNormal"><span style="font-family: Calibri; font-size: small;">Hi all,</span><o:p><span style="font-family: Calibri; font-size: small;">&nbsp;</span></o:p></p>
<p class="MsoNormal"><span style="font-size: small;"><span style="font-family: Calibri;">I&rsquo;m working on a bug complaining that Graphics.MeasureString hangs with a long right-to left string. If the number of </span><span lang="AR-SA" dir="rtl" style="font-family: 'Times New Roman','serif'; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri;">ุด</span><span dir="ltr"></span><span dir="ltr"></span><span style="font-family: Calibri;"> &nbsp;in a string is greater than 2046, it will hang. My question is: Is it a known issue that there is a length limitation in GdipMeasureString? Is there a workaround approach available for us? Your suggestions will be sincerely appreciated. </span></span></p>
<p class="MsoNormal"><o:p><span style="font-family: Calibri; font-size: small;"></span></o:p></p>
<p class="MsoNormal"><span style="font-family: Calibri; font-size: small;">We can repro it with the following code:</span><o:p><span style="font-family: Calibri; font-size: small;">&nbsp;</span></o:p></p>
<p class="MsoNormal"><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp; <span style="color: blue;">class</span> <span style="color: #2b91af;">Program&nbsp;</span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">{<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">static</span> <span style="color: blue;">void</span> Main(<span style="color: blue;">string</span>[] args)</span><span style="font-family: 'Courier New'; font-size: 9.5pt;">{<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Bitmap</span> b = <span style="color: blue;">new</span> <span style="color: #2b91af;">Bitmap</span>(10, 10);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Graphics</span> g = <span style="color: #2b91af;">Graphics</span>.FromImage(b);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Font</span> objFont = <span style="color: blue;">new</span> <span style="color: #2b91af;">Font</span>(<span style="color: #a31515;">"Arial"</span>, 10);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green;">//Notice: i == 2046 works well.<br /></span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green;">//Notice: i == 2047 hangs.<br /></span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">for</span> (<span style="color: blue;">int</span> i = 2000; i &lt; 2500; i++) </span><span style="font-family: 'Courier New'; font-size: 9.5pt;">{<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green;">// Create a string with a repetition of right-to-left characters. <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // If works well if use a normal char like 'a'.<br /></span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green;">// string ss = new string('a', i);&nbsp; //this one works fine<br /></span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: green;">// but it hangs when the length of <span lang="AR-SA" dir="rtl">ุด</span><span dir="ltr"></span><span dir="ltr"></span> is greater than 2047<br /></span></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: blue;">string</span> ss = <span style="color: blue;">new</span> <span style="color: blue;">string</span>(<span style="color: #a31515;">'<span lang="AR-SA" dir="rtl">ุด</span><span dir="ltr"></span><span dir="ltr"></span>'</span>, i);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #2b91af;">Console</span>.WriteLine(<span style="color: #a31515;">"Testing "</span> + i.ToString());<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">SizeF</span> oSize = g.MeasureString(ss, objFont);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Console</span>.WriteLine(<span style="color: #a31515;">"Size = "</span> + oSize.Width);<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Console</span>.WriteLine();<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Console</span>.WriteLine();<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br /></span><span style="font-family: 'Courier New'; font-size: 9.5pt;">&nbsp;&nbsp;&nbsp; }<o:p></o:p></span></p>
<p>That sounds like a bug, right?</p>
<p>You can see the original report on the Connect site, <a href="http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=559572">right here</a>.</p>
<p>You can see there the resolution, too:</p>
<div></div>
<p><span style="font-family: times new roman,times;">Windows team has confirmed that it's a regression, but they decide not to fix in Win7 since a string with more than 2046 characters is a corner case. However, they would evaluate it for Win8.<br /><br />Addtionally, we have a workaround, using Graphics.MeasureCharacterRanges. Thefore, I'm going to close this issue.<br /><br />Thanks and keep the feedback coming.<br />UIFx Team</span> </p>
<p>
<p>Kind of says it all, I guess. Right?</p>
<p>I'll be honest, they are making a pretty optimistic assessment as far as being willing to look at it in the future given how little GDI+ work is happening, but perhaps the hang elevates the status a bit.</p>
<p>Besides, who cares what <a href="http://msdn.microsoft.com/library/system.drawing.graphics.measurestring.aspx" title="Graphics.MeasureString">Graphics.MeasureString</a> is doing wrong as long as <a href="http://msdn.microsoft.com/library/system.drawing.graphics.measurecharacterranges.aspx" title="Graphics.MeasureCharacterRanges">Graphics.MeasureCharacterRanges</a> is around to pick up the slack.</p>
<p>In any case, when I explain how <a href="http://msdn.microsoft.com/library/system.drawing.graphics.measurestring.aspx" title="Graphics.MeasureString">Graphics.MeasureString</a>&nbsp;may hang with you, don't assume it's a good thing!</p>
</p>
<hr/><p><strong>Maurice Bonne</strong> on 26 Jul 2010 10:39 PM:</p><div style="margin-left: 1em"><p>Hello Michael, What i do not understand: in my original reprot i state clearly that also the MeasureChacterRanges does NOT work (atleast on my system). But still this is mentioned as a workaround. Did anybody actual test it?</p>
<p>PS: I do not knwon much about arabic languanges (only that we have customers there). the bug is realy a corner case because as soon as there are other charaters involved (point, comma, (i think left to right chars)) the methods work correrct. And i think that it is very unlikely that there is a onc sentence of 2047 characrters.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 26 Jul 2010 10:49 PM:</p><div style="margin-left: 1em"><p>For other people, it apparently did work (or maybe they misunderstood you). Though even if it did not, the support opf GDI+ issue is a real one, and the best answer at this point is to NOT ever use GDI+ at all....</p>
</div>
<p><strong>Ian Boyd</strong> on 7 Nov 2010 4:01 AM:</p><div style="margin-left: 1em"><p>Are there any alternatives to GDI+ for text rendering? The only ones i can think of are GDI and DirectWrite.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 7 Nov 2010 4:49 AM:</p><div style="margin-left: 1em"><p>Indeed -- GDI/Uniscribe (and stuff that uses it like TextRenderer), and DirectWrite are the big options....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/11/06 <a href="http://archives.miloush.net/michkap/archive/2010/11/06/10085213.html">Please stop using this turd. And if you are an MS employee: stop using this turd. Now.</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/07/23/10041679.html" title="It used to be Windows doing it right, and Office following. But now...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/07/21/10036699.html" title="It is easy (and obnoxious) to claim &quot;size doesn&#39;t matter&quot; if one has the size everyone wants">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-07">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-07-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/07/22/10033828.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>