<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/12/27/10109107.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>You have to deal with Hebrew periods where they come up</title></head><body>
<h1>You have to deal with Hebrew periods where they come up</h1>
<p><em>by Michael S. Kaplan, published on 2010/12/27 07:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/12/27/10109107.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Over in the Suggestion Box, Maurice asked:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">Hi Michael,</span></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">while working on sending key input via scan codes to a different process (with possibly different keyboard layout) I found two behaviors I can't really explain. Maybe you can shed some light on these.</span></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">First, if the target window uses a Hebrew keyboad layout and I want to enter a '.' I get a ? (Final Tsadi). I've looked at the keyboard layout with MSKLC and found that the key with this character is assigned to VK_OEM_PERIOD and the '.' is actually VK_OEM_2. If I use VkKeyScanEx('.', hkl) I get VK_OEM_PERIOD which is the wrong value. Is there any way to get the correct value or do I have to handle this case myself?</span></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">The second problem I've encountered is that I can't seem to release the right shift key with SendInput when it's pressed on the physical keyboard. All characters will still be upper case but GetKeyState says neither shift key is pressed. Releasing the left shift, both control or alt keys works however. So what's so special about the right shift key?</span></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">Thanks,</span></p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">Maurice</span></p>
<p>Interesting couple of questions there....</p>
<p>If you look at the Hebrew keyboard layout, you'll see Maurice appears to be right:</p>
<p><img src="http://trigeminal.fmsinc.com/images/HebrewSGCaps01.jpg" border="0" />&nbsp;&nbsp;&nbsp; <img src="http://trigeminal.fmsinc.com/images/HebrewSGCaps02.jpg" border="0" /></p>
<p>Clearly U+002e, aka FULL STOP, aka PERIOD, is on VK_OEM_2.</p>
<p>So what is going on here?</p>
<p>Well, the important thing to keep in mind is that the Hebrew keyboard layout has SGCAPS support, so the CAPS LOCK changes everything.</p>
<p>MSKLC lets you look at this, so if you click on that CAPS LOCK checkbox and look at the layout:</p>
<p><img src="http://trigeminal.fmsinc.com/images/HebrewSGCaps03.jpg" border="0" />&nbsp;&nbsp;&nbsp; <img src="http://trigeminal.fmsinc.com/images/HebrewSGCaps04.jpg" border="0" /></p>
<p>So there are multiple places that the keyboard layout has U+002e in it, and one of them is indeed VK_OEM_PERIOD.</p>
<p>And as I originally said back in 2006 in <a href="http://archives.miloush.net/michkap/archive/2006/03/26/560595.html" title="What the %$#!* is wrong with VkKeyScan[Ex]?"><strong>What the %$#!* is wrong with VkKeyScan[Ex]?</strong></a>, when a character is on the keyboard more than once, <a href="http://msdn.microsoft.com/library/ms646329">VkKeyScan</a> and <a href="http://msdn.microsoft.com/library/ms646332">VkKeyScanEx</a>&nbsp;will grab the first one it finds based on the way the keyboard layout's data tables are organized/enumerated, and there iws no way to control if from those functions....</p>
<p>These two function just continue to suck and I know of no plans to fix them in any way that would make them suck less, unfortunately.</p>
<p>This also points to a general limitation in the architecture of the basic keyboards created by MSKLC/kbdutool/kbdtool -- you can't change the VK values when you move to alternate shift states, which is very inconvenient for cases like this when you will have a VK_OEM_PERIOD that may or may not be a period.</p>
<p>Now Maurice's second question is something I am not entirely sure about the repro scenario, but when calling <a href="http://msdn.microsoft.com/library/ms646310.aspx">SendInput</a> with anything even remotely complicated (like left vs. right keys, etc.), you have to know when to |= in the KEYEVENTF_EXTENDEDKEY flag so it knows that it an extended scan key (for almost every real world case you would only use VK_SHIFT and you would not specify the right or left key).</p>
<p>I suspect that is what is going on here, though if that does not solve the problem then perhaps Maurice can provide more info on his repro scenario....</p>
<hr/><p><strong>Maurice</strong> on 3 Jan 2011 1:48 AM:</p><div style="margin-left: 1em"><p>Thanks for the clarification about VkKeyScan. Should have thought about checking the caps lock state. That also explains why I get the wrong key for &#39;]&#39;.</p>
<p>Now for my the second question. I&#39;m working on a remote support software for which any local keypress should be translated to a similar key on the remote side if that key is available. It should also distinguish between left and right modifier keys because some programs may need that. Now there are two problems with this. If I want to, for example, enter a &#39;#&#39; and I have US layout on the local and German layout on the remote side the following happens: local: I press the right shift key, remote: the app does a SendInput for the right shift key, local: I press VK_3, remote: should send a VK_OEM_2 (or more precisely the scan code of that key), but first the right shift key has to be released which the app does. This works perfectly fine but I noticed that when I press the physical right shift key on the remote side releasing it via SendInput doesn&#39;t work. This is of course not a very likely scenario but I was curious if there&#39;s a reason behind it. I&#39;ve checked if adding the extended flag changes anything but that doesn&#39;t seem to be the case. But I think I&#39;ve found a solution to it. I was using MapVirtualKey to get the scan code of most keys, including the rshift key. If I change that to use the vkey code however it seems to work. Still don&#39;t know why though...</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 3 Jan 2011 2:50 AM:</p><div style="margin-left: 1em"><p>Unfortunately there are not simple 1-to-1 mappings between all scan codes and virtual keys; the interactions between extended scan codes vs. non extended ones and also between function that strip those bits and those that do not make it impossible to assume you will be able to do a simple mapping that will catch all cases....</p></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/12/28/10108950.html" title="On disliking Emoji, disrespecting code pages, and not looking past dogma">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/12/26/10108989.html" title="I don&#39;t see any scripture claiming 413835 is the number of the beast, but...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-12">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-12-27">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/12/27/10109107.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>