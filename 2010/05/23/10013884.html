<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/05/23/10013884.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Drowning one's sorrows in the ThreadPool</title></head><body>
<h1>Drowning one's sorrows in the ThreadPool</h1>
<p><em>by Michael S. Kaplan, published on 2010/05/23 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/05/23/10013884.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Web developer Matt's question was to my way of thinking a very reasonable one:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times"><EM>Hi all…</EM></FONT></P>
<P><FONT face="times new roman,times"><EM>Is there any way to automatically change the UI culture for every background thread that .NET creates?</EM></FONT></P>
<P><FONT face="times new roman,times"><EM>At application startup we force the UI culture on the main thread since our application is localized independently of the OS.&nbsp; This works fine for exceptions that we throw from the UI thread – we’ve already forced the culture and so we look up the resource strings in the application language, instead of the OS/.NET language.&nbsp; However, we’ve added a bunch of multithreading this release and noticed that all of the exceptions on the background threads aren’t getting localized since we haven’t forced the culture on those threads.</EM></FONT></P>
<P><FONT face="times new roman,times"><EM>It would be a LOT of work to go force the thread culture EVERYTIME we create a thread.&nbsp; We’re also using the TPL extensively so it’s not even clear when threads are being created since we’re not explicitly creating them ourselves – the TPL is!</EM></FONT></P>
<P><FONT face="times new roman,times"><EM>With the move to more parallel applications, this seems like something that other applications must have run into, so I’m wondering if there’s any way to hook into the framework to override the default culture for all new threads?</EM></FONT></P>
<P><EM><FONT face="Times New Roman">One&nbsp;response:</FONT></EM></P>
<P><FONT face="Times New Roman">No. There is currently no way to make this happen. Your option will be store the culture in a static variable and use that culture to load resources on the background thread.<EM>&nbsp;</EM></FONT></P>
<P><EM><FONT face="Times New Roman">Right – except that once the TPL comes into play I don’t even KNOW when I’m on a background thread or not, or if the culture has already been forced on said thread.&nbsp; It also requires driving knowledge of the application’s localization strategy into EVERY single piece of code that runs in the application – I now have to pepper calls to force the culture like spaghetti all over the place into every single piece of code that could conceivably run on a background thread, which just seems like a terrible, terrible mess.</FONT></EM></P>
<P><EM><FONT face="Times New Roman">With the advent of much more parallel programming, this sounds like it could be a nice scenario for the framework to help with by providing me with some way to tell the framework how to force the culture for all new threads.</FONT></EM></P></BLOCKQUOTE>
<P>This is a question that is asked fairly often.</P>
<P>And although I have mentioned in blogs like <A href="http://archives.miloush.net/michkap/archive/2010/04/29/10003565.html" mce_href="http://archives.miloush.net/michkap/archive/2010/04/29/10003565.html"><STRONG>New for Windows 7: The PROCESS to keep MUI from being THREADbare....</STRONG></A> how .Net really could and in fact ought to be doing something better here, another question comes to mind, one that is perhaps due to my Win32 grounding and the straightforward nature of the web applications and sites I have been tasked to design.</P>
<P>In Win32, the UI is by its nature meant to be very single threaded even in the most complex multi-threaded applications. And any time something must be done in another thread complex interactions have to be done for the application to behave reliably.</P>
<P>Thus as big of a fan as I am of the process default user interface language, I hardly need for every thread in a threadpool to be updated since most of those worker threads are probably doing nothing where the user interface language is even relevant.</P>
<P>Now I may be missing something in the web scenario, or perhaps there is some sort of nut-job object oriented purity objection to an object like thread having to know more about some external setting to do its work, but is its really that common for so many worker threads to be doing things that need the UI language, and that retrieving the value is such a bad idea technically?</P>
<P>I mean, I will be happy when they solve the problem, but my happiness is based on a scenario that seems much more defensible to me.</P>
<P>In Matt's scenario, are the errant threads all popping up their own UI every time? I think I have seen those kinds of web sites, the ones that pop up random alerts one on top of the next, without waiting for me to respond. My rule is to avoid those kind of sites, but maybe that is just me....</P>
<P>In the world of a complex web application that spans multiple servers and has thousands or tens of thousands of clients, each client's settings that are relevant to work done for the client will have to obtain whatever settings they need -- and language is just another of these settings that a lowly threadpool thread will have to obtain to do its work.</P>
<P>Is there some other scenario I am unaware of?</P>
<P>What am I missing here?</P>
<hr/><p><strong>Cheong</strong> on 24 May 2010 11:21 PM:</p><div style="margin-left: 1em"><p>For web applications, it&#39;s not uncommon to have culture related routine poping around everywhere (especially true if the pages are ported from PHP/ASP)</p>
<p>It&#39;s fairly uncommon for web applications written in languages with no MVC like framework (i.e.: that includes .NET v1.x sites... Oh memories of those home-grown AJAX before AJAX frameworks are available...) to have clean seperation of logic and presentation related stuffs.</p>
<p>P.S.: Seems the size of &quot;post&quot; button is wrong. The button now is broken into 3 parts.</p>
</div>
<p><strong>David Kean</strong> on 24 May 2010 11:55 PM:</p><div style="margin-left: 1em"><p>Even though you may not be showing UI on other threads, you might be generating messages to be displayed on the UI thread. For example, let&#39;s say you&#39;re opening a file on a background thread, you probably going to be pushing any errors from System.IO back to the UI thread. You will want these in the same locale that your UI is running under.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 25 May 2010 7:34 AM:</p><div style="margin-left: 1em"><p>I have yet to a single exception error message that I would want to show as is to a user in ANY language -- which suggests that I would be unhappy with any application that was not handling the exception and if required throwing one&#39;s own &quot;translated into something understandable&quot; one, instead....</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 25 May 2010 9:42 AM:</p><div style="margin-left: 1em"><p>I&#39;ve discussed the similar issue in the context of .NET and SQL Server in blogs like <a href="http://archives.miloush.net/michkap/archive/2005/06/16/429759.html">More on locales in SQL Server</a>. And pretty much come to the same conclusion....</p></div>
<p><strong>dbacher</strong> on 25 May 2010 1:14 PM:</p><div style="margin-left: 1em"><p>Are you sure this is a web application? &nbsp;.NET is used for a lot else, and ThreadPool would be typical of WinForms, WPF, Services, or a Console App -- it would be unusual to use ThreadPool in ASP.NET (although not impossible).</p>
<p>Anyway -- if it is ASP.NET, there is not one line of user code that runs before ThreadPool is initialized and threads are already created and running. &nbsp;ASP.NET uses thread pools, and they are active before any piece of user code in an ASP.NET app runs.</p>
<p>If it is the other technologies, static/shared initializers and constructors run before user code gets a chance to do anything, as well, and can conceptually queue items on the thread pool.</p>
<p>Additionally, you borrow the thread from the ThreadPool -- your work item does not own the thread, and it is not re-initialized when you return it. &nbsp;Windows, COM, .NET and even other processes (Visual Studio, for example) can and do borrow threads from your process&#39; pool, and can leave the thread in an unknown state. &nbsp;Since the whole point of ThreadPool is to avoid unnecessary initialization or teardown, you&#39;re responsible for intiializing and tearing down anything you need to be.</p>
<p>Ideally, you encapsulate (using a closure, class, or global-equivalent) your state separately from the thread, and leave the thread global state alone. &nbsp;Ideally, since you don&#39;t own the thread, you don&#39;t do anything to it. &nbsp;</p>
<p>Also, ideally, you don&#39;t use ThreadPool if you are CPU bound. &nbsp;If you&#39;re wanting to leverage all 4 cores, you are much better off writing your own threading code than using ThreadPool in almost all CPU-bound cases. &nbsp;(that&#39;s because of how ThreadPool is designed).</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/05/24/10013991.html" title="&quot;Donesian&quot;…just east of &quot;Variant&quot; and just north of &quot;Cognito&quot;, right?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/05/22/10006058.html" title="&quot;Intuitive&quot; in one language may (at best) be &quot;understandable&quot; in another. Please plan accordingly....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-05-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/05/23/10013884.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>