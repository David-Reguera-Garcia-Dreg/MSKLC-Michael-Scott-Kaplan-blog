<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/05/04/10003033.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>The wacky world of WOW64 keyoards, un-leashed, un-locked, un-something-or-other</title></head><body>
<h1>The wacky world of WOW64 keyoards, un-leashed, un-locked, un-something-or-other</h1>
<p><em>by Michael S. Kaplan, published on 2010/05/04 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/05/04/10003033.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Back in the end of February, A2 asked via the Contact link:</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">Hi Michael.</FONT></P>
<P><FONT face="times new roman,times">(I already posted this message one or two months ago and can't find if you published it or if you even received it! I wanted to answer to this thread : </FONT><A href="http://archives.miloush.net/michkap/archive/2007/01/30/1557184.html"><FONT face="times new roman,times">http://blogs.msdn.com/michkap/archive/2007/01/30/1557184.aspx</FONT></A><FONT face="times new roman,times"> at the beginning. I prefer now using the contact form system. Sorry if my message bother you, I won't send it again.)</FONT></P>
<P><FONT face="times new roman,times">So I'm wondering how to have a WOW64 keyboard layout dll using WDK7 (if it's really needed…)</FONT></P>
<P><FONT face="times new roman,times">I'm on Win7 (x64 machine) with MSKLC 1.4 and WDK 7.0. I'm building Windows drivers for french keyboard layout bepo (</FONT><A href="http://bepo.fr/"><FONT face="times new roman,times">http://bepo.fr</FONT></A><FONT face="times new roman,times">). Here is where I am with all this. Please correct me if I'm wrong.</FONT></P>
<P><FONT face="times new roman,times">MSKLC 1.4 generate a .exe, three .msi and four .dll. The .exe only choose the good .msi depending of the computer architecture. Installation or uninstallation only need the good .msi (and one or two .dll for installation). For example, on x86 machines, i386.msi copy \i386\ .dll to \windows\system32\ dir (and add some lines to windows registry).</FONT></P>
<P><FONT face="times new roman,times">On my x64 machine, the amd64.msi requests two dlls : the one in \amd64\ is copied to \system32\ and the other in \wow64\ to \sysWOW64\. (I read above that the i386 dll was needed for sys32 dir, this is wrong, at last under win7.)</FONT></P>
<P><FONT face="times new roman,times">I began using kbdutool.exe to build the four .dll in order to bypass one of the MSKLC guy error (can't add underscore in AltGr+space). These dlls can be used with the MSKLC generated .exe/.msi files to have user friendly setup files (overwriting MSKLC dlls).</FONT></P>
<P><FONT face="times new roman,times">I started to look at the Neo2 german layout (</FONT><A href="http://www.neo-layout.org/"><FONT face="times new roman,times">http://www.neo-layout.org/</FONT></A><FONT face="times new roman,times">) wich works with WDK and source files. This layout is kindly innovating (using six layers and having a compose-like deadkey) and I wanted to adapt this for our french bepo.</FONT></P>
<P><FONT face="times new roman,times">I can't find how to build the WOW64 dll to be able to still use older .exe/.msi :<BR>*ia64 build environnement builds the ia64 dll;<BR>*x64 build environnement builds the amd64 dll;<BR>*x86 build environnement builds the i386 dll.</FONT></P>
<P><FONT face="times new roman,times">I don't have Itanium machine (IA64), I imagine ia64.msi from MSKLC needs at last the \ia64\ dll and probably the \wow64\ one too.</FONT></P>
<P><FONT face="times new roman,times">If I use the amd64 dll in wow64 dir, the installation fail. The contrary works, it seems logic.</FONT></P>
<P><FONT face="times new roman,times">For the moment I'm copying the amd64 dll manualy in sys32/64 dirs to have the layout working, adding the good registry entries. The problem being that I'd like to have a clean installer for lambda users.</FONT></P>
<P><FONT face="times new roman,times">So my questions are :<BR>* is there a way to build the wow64 dll with WDK?<BR>* where to look in order to have a Windows installer for my WDK dll otherwise?</FONT></P>
<P><FONT face="times new roman,times">Quickly, another thing I don't understand : it seems that the the file formats needed for .klc files in kbdutool.exe is different then those used by MSKLC? Do you have recommandations about that? (I must convert my .klc to little endian (perhaps something else is better) to be able to use kbdutool.exe -u).</FONT></P>
<P><FONT face="times new roman,times">— A2</FONT></P></BLOCKQUOTE>
<P>It was Igor Levicki who figured&nbsp;out how to get the WOW64 version of the files built.</P>
<P>It is in <A href="http://archives.miloush.net/michkap/archive/2006/09/28/774957.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/28/774957.html"><STRONG>If you just don't think you can hold it (64-bit style!)</STRONG></A>, in <A href="http://archives.miloush.net/michkap/archive/2006/09/28/774957.html#777008" mce_href="http://archives.miloush.net/michkap/archive/2006/09/28/774957.html#777008">this</A> comment:</P>
<BLOCKQUOTE>
<P><EM><FONT face="times new roman,times">Well, because I hate to leave things half-finished I dug out the right way to deal with that issue during compilation :) <BR><BR>It is just a matter of compiling using 32-bit compiler with -DBUILD_WOW6432. <BR><BR>So now I have the complete solution. </FONT></EM></P></BLOCKQUOTE>
<P>He integrated it into his full page with instructions, which used to be at <A href="http://levicki.blogspot.com/2006/09/how-to-build-keyboard-layouts-for.html">http://levicki.blogspot.com/2006/09/how-to-build-keyboard-layouts-for.html</A>&nbsp;but now is on his new site, at <A href="http://levicki.net/articles/tips/2006/09/29/HOWTO_Build_keyboard_layouts_for_Windows_x64.php">http://levicki.net/articles/tips/2006/09/29/HOWTO_Build_keyboard_layouts_for_Windows_x64.php</A>&nbsp;and I am glad as the full story is worth having. :-)</P>
<P>Anyway, as Igor determined, the WOW64 file is built with:</P>
<UL>
<LI>the 32-bit (x86) compiler, and</LI>
<LI>the BUILD_WOW6432 define (-DBUILD_WOW6432 from the command line)</LI></UL>
<P>You can look to Igor's site for the other details.</P>
<P>For those who want to understand the BUILD_WOW6432 issue, it is relatively simple.</P>
<P>Almost all of the files you will find in the SYSWOW64 directory of a 64-bit machine are actually the 32-bit files that exist on a 32-bit i386 machine.</P>
<P>Because just the same way that your 32-bit apps can run on 64-bit hardware, most of the system's files do as well.</P>
<P><STRONG>HOWEVER</STRONG>, there are a small number of files that are 32-bit files that have to deal with 64-bit pointers because of the nature of the work they do on 64-bit systems (where those pointers have to do 64-bit thunks)&nbsp;that requires a different pointer size to be used for exported functions that have pointers in their parameter and/or return values. </P>
<P>This includes <STRONG>kernel32.dll</STRONG>, <STRONG>user32.dll</STRONG>, all of the keyboard layout DLL files, and other core system files.</P>
<P>Some but not all of the system files would have to be built this way for the SYSWOW64 subdirectory, but the&nbsp;bulk of these files are not built in the WDK or by anyone outside of the Windows team, which is why this is not documented better. </P>
<P>In fact in the Windows 7 RTM build, there are&nbsp;fewer than&nbsp;200&nbsp;such files out of the ~2500 files in the syswow64 directory, and almost all of those (like ~95%) are keyboard DLLs!</P>
<P><EM>(If you build Windows, you can check these out in the WOW6432 subdirectory)</EM></P>
<P>The actual utility of all this may be <EM>somewhat</EM> questionable given the fact that the pointers in question are really just sign-extended 32-bit pointers (as discussed in <A href="http://archives.miloush.net/michkap/archive/2006/08/01/684909.html" mce_href="http://archives.miloush.net/michkap/archive/2006/08/01/684909.html"><STRONG>32 bit vs. 62 bit HKLs?</STRONG></A>), but as an arcane build issue that no one really understands it is unclear whether it would be worth doing anything different about, in the long run. I suspect there are a few oldtimers who might be able to explain why this makes the whole thing easier....</P>
<P>During Vista, it certainly caused me (as the dev owner of the keyboard layout DLLs) some interesting extra work as the problem of building setup manifests to handle these files was very complicated since the new setup didn't really support the idea at first and the ways that various experts instructed me to author the files tended to break the validation scripts that the same team kept building to improve setup quality. Thank goodness for Perl scripts is all I'm going to say!</P>
<P>Gerardo on the test team was the person to find out directly how the first two of the five setup manifest iteratons (authored by the instructions of the setup team)&nbsp;actually led to the wrong versions of keyboard layout files being put in the SYSWOW64 directory of 64-bit machines. Though those manifests were the only ones that never failed validation routines like te next two versions that did. Kind of ironic that only the invalid manifests were validaing properly (as the valid manifests kept failing validation), huh?</P>
<P>As a bizarre final twist, after Vista shipped and shortly after I changed teams, yet another set of setup manifest validation tools declared all of the keyboard manifests&nbsp;were incorrecrly authored (and CompCentral declared me to be the owner of these many wayward binaries), but at that point the work had been transitioned to someone else so I gaqve the bugs to them with instructions and&nbsp;avoided having to do the work yet again.</P>
<P>Igor <EM>may</EM> be the first non-internal Microsoft person to ever figure it out. Internally most don't figure it out either, they just build the files using scripts written ages ago and never pay attention to the details. I certainly never knew about it&nbsp;until doing the 64-bit work for MSKLC 1.4, despite having built the keyboards hundreds of times and kernel32.dll thousands of times; when I finally did it,&nbsp;it was&nbsp;by reverse engineering the keyboard layout DLLs being built by Windows....</P>
<P>I believe that covers most of the question, though a few more bits to add:</P>
<P><STRONG>I suppose IA64 is not really so important anymore</STRONG>. I won't say anything else on this subject, other than to (not for nothing) mention that <EM>if software tech companies were run entirely by women</EM> there are certain types of strategies that probably would never happen. Intel's IA64 plan is one of them and the Compaq plan for Alpha 64 and Alpha 32 are two others, in my opinion. I won't explain further; either you understand what I mean or you don't (and if you don't you might be offended once you do; if you do then you&nbsp;may agree!). So I'll just leave it there.</P>
<P><STRONG>Microsoft does not, AFAIK,&nbsp;document any way to get the keyboard layout DLLs running other than MSKLC.</STRONG> Though obviously there are WDK samples for the DLLs, there is real dearth of info on how to get them installed on systems. The setup MSKLC creates takes care of all of the details, and I highly recommend taking that approach for building setups.</P>
<P><STRONG>The files MSKLC creates are the very ones it passes to kbdutool.exe itself for building.</STRONG> It should already be little endian Unicode, for example. Not sure what kind of errors are being hit, but if MSKLC and kbdutool were not compatible then (looking at the latest download statistics) there would be up to half a million unhappy keyboard authors out there! So I am not sure what problems were appening but there shouldn't be.</P>
<P>Hopefully that takes care of all the issues for A2, if not then let me know; I'm around. :-)</P>
<hr/><p><a id="10007302" href="#10007302">#</a> <strong>Yuhong Bao</strong> on 4 May 2010 12:01 PM:</p><div style="margin-left: 1em"><p>On other stuff like this, KK figured out from the WDK how MS internally build it's own software using the system MSVCRT.DLL:</p>
<p><a rel="nofollow" target="_new" href="http://kobyk.wordpress.com/2007/07/20/dynamically-linking-with-msvcrtdll-using-visual-c-2005/">http://kobyk.wordpress.com/2007/07/20/dynamically-linking-with-msvcrtdll-using-visual-c-2005/</a></p>
</div>
<p><a id="10007439" href="#10007439">#</a> <strong>Michael S. Kaplan</strong> on 4 May 2010 4:35 PM:</p><div style="margin-left: 1em"><P>I suspect the BUILD_WOW6432 issue's lack of documentation has mostly to do with lack of applicability to the majority of the world (as opposed to the CRT issue, which is slightly mischaracterized in his blog but the facts are straight enough to get the job done)....</P></div>
<p><a id="10007556" href="#10007556">#</a> <strong>Yuhong Bao</strong> on 4 May 2010 10:35 PM:</p><div style="margin-left: 1em"><p>BTW, back before VC2005 was released you could request a VC 7.1 compatible version of the 64-bit CRT, MFC, and ATL by sending email to libs7164@microsoft.com. Which CRT DLL did that use?</p></div>
<p><a id="10007594" href="#10007594">#</a> <strong>Michael S. Kaplan</strong> on 5 May 2010 12:06 AM:</p><div style="margin-left: 1em"><p>Dude, I have no idea. I am on Windows, not the Developer Division, which is where that was coming from.</p>
</div>
<p><a id="10008454" href="#10008454">#</a> <strong>Random832</strong> on 6 May 2010 6:11 AM:</p><div style="margin-left: 1em"><p>kbdutool that ships with MSKLC version &quot;1.4.6000.2&quot; appears to have a -o option to build for WOW64.</p></div>
<p><a id="10008470" href="#10008470">#</a> <strong>Michael S. Kaplan</strong> on 6 May 2010 6:34 AM:</p><div style="margin-left: 1em"><P>It does, yes. But the question here was how to build with the WDK....</P>
<P>kbutool, from its /? help:</P>
<BLOCKQUOTE>
<P>KbdTool v3.40 - convert keyboard text file to C file or a keyboard layout DLL</P>
<P>Usage: KbdUTool [-v] [-n] [-w] [-k] [-n] [-u|a] [-i|x|m|o|s] FILE</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-?] display this message<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-n] no logo or normal build information displayed</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-a] Uses non-Unicode source files (default)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-u] Uses Unicode source files</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-v] Verbose diagnostics (and warnings, with -w)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-w] display extended Warnings</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-x] Builds for x86 (default)<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-i] Builds for IA64<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-m] Builds for AMD64<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-o] Builds for WOW64<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [-s] Generate Source files (no build)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; FILE The source keyboard file (required)</P>
<P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -u/-a are mutually exclusive; kbdutool will use the last one if you specify more than one.<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -i/-x/-m/-o-s will exhibit the same behavior when than one of them is specified.</P></BLOCKQUOTE></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2012/08/16 <a href="http://archives.miloush.net/michkap/archive/2012/08/16/10340297.html">In the land of the unsupported, previous blogs and tools can be king</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/05/05/10007589.html" title="Are MALAYALAM KA &amp; TAMIL KA confusable? Only if you think &quot;all those Dravidians look alike&quot; !">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/05/03/10002241.html" title="One product&#39;s (or person&#39;s) intended design is another product&#39;s (or person&#39;s) bug. And vice versa.">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-05">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-05-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/05/04/10003033.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>