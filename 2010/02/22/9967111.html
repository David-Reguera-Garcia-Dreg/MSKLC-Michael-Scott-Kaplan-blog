<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/02/22/9967111.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Will someone take up the job of Calendar support in .Net, please?</title></head><body>
<h1>Will someone take up the job of Calendar support in .Net, please?</h1>
<p><em>by Michael S. Kaplan, published on 2010/02/22 07:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/02/22/9967111.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>Calendar support in Microsoft products.</P>
<P>Sigh....</P>
<P>Within the first few months of this Blog, I wrote <A href="http://archives.miloush.net/michkap/archive/2005/01/14/353347.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/353347.html"><STRONG>Calendars on Win32 -- Not all there yet</STRONG></A> and <A href="http://archives.miloush.net/michkap/archive/2005/01/14/353216.html" mce_href="http://archives.miloush.net/michkap/archive/2005/01/14/353216.html"><STRONG>Calendars on Win32 -- just there for show....</STRONG></A>, followed just 8 days later by the first managed foray into the topic (<A href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html"><STRONG>Calendars.NET -- new platform, new issues</STRONG></A>).</P>
<P>Occasionally there was good news for Saudi Arabia or for <FONT color=#999999><STRIKE>Iran</STRIKE></FONT>expatriate Iranians or India or whatever.</P>
<P>But by and large the&nbsp;question I first posed to my very first manager in Windows almost a decade ago ("When can we make calendar support not stink?") remains largely unanswered.</P>
<P>Whether one targets the native side or the managed side, the fix would involve a hell of a lot of work - largely a rewrite for the former, largely a new class and a major refactoring for the latter (with the&nbsp;even larger&nbsp;question of how to support custom calendars that would have to somehow work in both environments left aside for another day).</P>
<P>Obviously I can't describe what the rewrite would need on the Windows side all that effectively since I can't really describes too much about the internals as they stand. So we'll table that one for now; I tend to doubt that there is much hope for that work being done, to be honest.</P>
<P><EM>The former paragraph is my personal opinion about a kind of political situation, not at all a real technical issue.</EM></P>
<P>But the managed world, I hold out more hope since there is a team over in the Developer Division that occasionally does some major work in this area.</P>
<P>The biggest piece of the work would be the refactoring - the current organization between DateTimeFormat, the various Calendar classes,&nbsp;and the parsing and formatting arms of DateTime is very poorly organized for the job of adding new calendars (you can use .Net Reflector to see some of this, you can probably just take it as read the huge dependency each class has on internal knowledge of the fixed tables in Microsoft's data that makes this such a Herculean task.</P>
<P>Here is my humble suggestion for someone who wanted to tackle the Calendar issue for .Net, as a step by step task-list:</P>
<OL>
<LI>Come up with a new name for the new Calendar class; surprisingly, coming up with an acceptable name might be the hardest part of this entire exercise!</LI>
<LI>Make sure you have the complete&nbsp;understanding of&nbsp;your calendar figured out - how to convert any date between it and the Gregorian calendar, from soup to nuts. You'll need this.</LI>
<LI>Decide if you want to support more than one language to express the dates/times in, and if you do then add a UICulture name sort of thing to support it. This part is <STRONG>optional</STRONG>.</LI>
<LI>Write a&nbsp;method that will take a DateTime and a <A href="http://msdn.microsoft.com/library/az4se3k1.aspx" mce_href="http://msdn.microsoft.com/library/az4se3k1.aspx">standard</A> or <A href="http://msdn.microsoft.com/library/8kb3ddd4.aspx" mce_href="http://msdn.microsoft.com/library/8kb3ddd4.aspx">custom</A> date/time format string, and format it into a string using your calendar's logic. This will be used by a <STRONG>ToString</STRONG> method later.</LI>
<LI>Write a method that will take a a) string and b) a <A href="http://msdn.microsoft.com/library/az4se3k1.aspx" mce_href="http://msdn.microsoft.com/library/az4se3k1.aspx">standard</A> or <A href="http://msdn.microsoft.com/library/8kb3ddd4.aspx" mce_href="http://msdn.microsoft.com/library/8kb3ddd4.aspx">custom</A> date/time format string and do an exact, literal parse into a DateTime using your calendar's logic. This will be used by a <STRONG>ParseExact</STRONG> method later.</LI>
<LI>Write&nbsp;a method that will take a string and do a "parse under any circumstances if it is in any way possible" into a DateTime using your calendar's logic. This will be used by a <STRONG>Parse</STRONG> method later.</LI>
<LI><EM>If your calendar has other day names/month names and so forth then fill out all the information for a DateTimeFormat kind of thing that has those names in it.</EM></LI>
<LI>What to do here depends on whether you are internal to Microsoft with the authority to change the BCL (Base Class Libraries) of .Net or not:</LI>
<OL type=a>
<LI>If you can make the changes in .Net, make sure that the existing DateTime, DateTimeOffset, CultureInfo, and other classes are modified to be able to consume your new calendar class with the new cool name figured out in step 1. <STRONG><FONT color=#ff0000>Call me if you need any help with this!</FONT></STRONG></LI>
<LI>If you cannot make the changes in .Net, then make sure the methods in steps 4-6 above are easy to call and release it as is. You are done. <STRONG><FONT color=#ff0000>Call me if you want someone to help try it out when you're done for an interesting calendar!</FONT></STRONG></LI></OL></OL>
<P>Now this also "solves" the custom calendar issue for managed code, one way or the other. It leaves the Win32 case broken but that would definitely require resources elsewhere (I would love to see it but I'm not going to rely on it).</P>
<P>For the record this process above is just a more fully fleshed out version of the thing I first suggested almost five years ago in <A href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html" mce_href="http://archives.miloush.net/michkap/archive/2005/02/23/378804.html"><STRONG>Calendars.NET -- new platform, new issues</STRONG></A>, but I'm hoping that the expanded information will inspire someone (or multiple someones!) to do the work and tell other people once it's done.</P>
<P>Plus note that if you do the Ethiopic calendar I mentioned the other day in <A href="http://archives.miloush.net/michkap/archive/2010/02/20/9966698.html" mce_href="http://archives.miloush.net/michkap/archive/2010/02/20/9966698.html"><STRONG>The road not traveled (or, more to the point, the road not built) for Amharic</STRONG></A>, you can use the Ethiopic number system since you are the one doing all the parsing and formatting anyway - try exposing those Parse and Format methods too and help prove how easy it would have been for them to do it!</P>
<P>As I said above, let me know if you start doing all this, I'd love to see someone pick up the torch on this one since no one seems to be dong it yet and my former call to passion (<STRONG>opening it all up and getting out the way</STRONG>) is really wishing more could be done here, by someone. By anyone....</P>
<hr/><p><strong>Peter Ibbotson</strong> on 22 Feb 2010 8:48 AM:</p><div style="margin-left: 1em"><p>Sounds like you need to have a chat with Jon Skeet about noda time.</p>
<p><a rel="nofollow" target="_new" href="http://code.google.com/p/noda-time/">http://code.google.com/p/noda-time/</a></p></div>
<p><strong>Michael S. Kaplan</strong> on 22 Feb 2010 9:46 AM:</p><div style="margin-left: 1em"><p>Well it might be a little more complicated in that case, but I'd look over the specs (Neither Noda or Joda does the Amharic numbers!)....</p>
</div>
<p><strong>John Cowan</strong> on 22 Feb 2010 10:02 AM:</p><div style="margin-left: 1em"><p>Or you could just give the developers of NodaTime, an &quot;idiomatic port&quot; of JodaTime to .NET, a little boost.</p></div>
<p><strong>Kemp</strong> on 22 Feb 2010 10:14 AM:</p><div style="margin-left: 1em"><p>You seem to have a reference to footnote 1, but no footnote 1. My mind threw a parsing error ;-)</p></div>
<p><strong>Michael S. Kaplan</strong> on 22 Feb 2010 11:27 AM:</p><div style="margin-left: 1em"><p>I decided not to do that, but did not remove the footnote. Hope this helps with your parsing error!:-)</p>
</div>
<p><strong>Jon Skeet</strong> on 22 Feb 2010 11:54 AM:</p><div style="margin-left: 1em"><p>Michael: This is the first I've heard of Amharic numbers, but Joda Time does support the Ethiopic calendar:</p>
<p><a rel="nofollow" target="_new" href="http://joda-time.sourceforge.net/api-release/org/joda/time/chrono/EthiopicChronology.html">http://joda-time.sourceforge.net/api-release/org/joda/time/chrono/EthiopicChronology.html</a></p>
<p>So Noda Time will eventually support that calendar too.</p>
<p>I doubt that we're up to coping with a new number system, but we could certainly talk about it.</p>
<p>If the BCL team wanted to take Noda Time into the BCL in some way, that could provide some, er, interesting challenges. I think for the moment it's best on its own as an open source project - that doesn't seem to have hurt Joda Time much. While we won't be able to change DateTime/DateTimeOffset themselves, we'll have our own *much* better types - which will of course have conversions to DateTime/DateTimeOffset if you really want...</p>
<p>Mail me (or the mailing list) if you're interested in finding out more...</p></div>
<p><strong>Michael S. Kaplan</strong> on 22 Feb 2010 12:25 PM:</p><div style="margin-left: 1em"><p>I'm guessing the BCL won't be picking up Noda Time any time soon. :-)</p>
<p>The numbering system is something that there is a true generation gap about but not doing it shouldn't mean not doing the calendar, so I'm glad you'll do it.</p>
<p>If folks here don't want to do it or can't then I'm happy to recommend someone who will do it, especially if it is easy enough to use with existing mechanisms (haven't looked at it yet or anything so can't say for sure)....</p>
</div>
<p><strong>Brian</strong> on 23 Feb 2010 2:15 PM:</p><div style="margin-left: 1em"><p>How about you get your management to commit Bala's team to do this feature?</p></div>
<p><strong>Michael S. Kaplan</strong> on 23 Feb 2010 4:02 PM:</p><div style="margin-left: 1em"><p>My management can't control their resources, thus my plea here. This was easy back in 2005 when I first suggested it too....</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/06/21 <a href="http://archives.miloush.net/michkap/archive/2011/06/21/10177222.html">The downside of managing to go native...</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/02/23/9967789.html" title="The game is over, people!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/02/21/9966915.html" title="If you ask the average person &quot;Which comes first, &#39;=&#39; or &#39;_&#39; ?&quot; they will stare at you blankly. With good reason.">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-02-22">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/02/22/9967111.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>