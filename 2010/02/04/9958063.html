<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/02/04/9958063.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Being in the zone may not be the best way to get the time right</title></head><body>
<h1>Being in the zone may not be the best way to get the time right</h1>
<p><em>by Michael S. Kaplan, published on 2010/02/04 07:11 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/02/04/9958063.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<P>So the other day a developer at Microsoft who was doing a ton of grabbing of UTC SYSTEMTIME values and logging them in the local time of the user<SMALL><SUP>1</SUP></SMALL> noticed some significant performance regressions between Windows Server 2003 and Windows Server 2008 R2.</P>
<P>After doing some work to isolate where the extra time was being spent, he found that s ton of the time was spent around the following key:</P>
<P>HKLM\Software\Microsoft\Windows NT\CurrentVersion\Time Zones\Pacific Standard Time\Dynamic</P>
<P>Luckily, the original "Father Time" Geoff Pease<SMALL><SUP>2</SUP></SMALL> was around to describe what was going on here in some detail....</P>
<BLOCKQUOTE>
<P><FONT face="times new roman,times">You are hitting this because of Dynamic Time Zone support that was added.<BR>&nbsp;<BR>Everything you need is NOT in a TIME_ZONE_INFORMATION structure. The structure only has room for the “current” time zone and not historical ones.<BR>&nbsp;<BR>In 2007, the US changed the start and end dates for Daylight Savings time. Any date BEFORE the transition needs to use a different set of rules than those AFTER the transition.<BR>&nbsp;<BR>Because of historical applications that have no clue about this change and to keep them displaying the historically accurate time stamps (meaning then do not change whichever side of the transition you are on), the system hast to play some games.<BR>&nbsp;<BR>To get around this, the system has to play some games in matching a “current time zone” to lookup as needed historical time zone data about the year.&nbsp;<BR>&nbsp;<BR>If you want the entire server to disable historical lookups, turn off Daylight Savings Time (which you’ve already tried and hated) OR do what you did – call GetTimeZoneInformation() to get the TZI and pass it in… but then add zero’ing out the Standard and Daylight names. This will cause a time zone comparison to fail where the legacy API is trying to determine if the “current time zone” is the same time zone you just past it (and if true, the do the historical lookups which hits the registry where these tables are stored). By failing this comparison, the historical comparison’s do not kick in and the registry accesses go away. <BR>&nbsp;<BR>This technique comes with a down side – since you are in essence “making your own TZI,” you’ll need to refresh the TZI structure once a year or once a day or whatever you like (less often, the better but not enough to make you uncomfortable <FONT face="wingdings,zapf dingbats">J</FONT>). You also need to make sure that the timestamps you are passing in are match the TZI that you pass in. Converting times from different years using this technique will generate “bad times” during the area where DST change from year to year. If you are using this for “current time logging,” this should work pretty well for you.</FONT></P></BLOCKQUOTE>
<P mce_keep="true">Now as it turns out, the developer&nbsp;stumbled across&nbsp;another workaround as well (one that also avoids the dynamic support that was added) -- basically changing code depending on <A href="http://msdn.microsoft.com/library/ms724949.aspx" mce_href="http://msdn.microsoft.com/library/ms724949.aspx">SystemTimeToTzSpecificLocalTime</A> like this:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier,Fixed"><B>
<P mce_keep="true">FILETIME ftUtc;<BR>::GetSystemTimeAsFileTime( &amp;ftUtc );<BR>//<BR>// code to perform elapsed time calcs would go here...<BR>//<BR>SYSTEMTIME stUtc, stLocal;<BR>::FileTimeToSystemTime( &amp;ftUtc, &amp;stUtc );<BR>::SystemTimeToTzSpecificLocalTime( NULL, &amp;stUtc, &amp;stLocal );<BR>// log away using the nicely structured stLocal...</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">and instead do code more like this:</P>
<BLOCKQUOTE><FONT face="Consolas,Lucida Console,Courier New,Courier,Fixed"><B>
<P mce_keep="true">FILETIME ftUtc, ftLocal;<BR>::GetSystemTimeAsFileTime( &amp;ftUtc );<BR>//<BR>// code to perform elapsed time calcs would go here...<BR>//<BR>::FileTimeToLocalFileTime( &amp;ftUtc, &amp;ftLocal );<BR>SYSTEMTIME stLocal;<BR>::FileTimeToSystemTime( &amp;ftlocal, &amp;stLocal );<BR>// log away using the nicely structured stLocal...</P></B></FONT></BLOCKQUOTE>
<P mce_keep="true">Since <A href="http://msdn.microsoft.com/library/ms724277.aspx" mce_href="http://msdn.microsoft.com/library/ms724277.aspx">FileTimeToLocalFileTime</A> never does any of the dynamic time zone lookup work (it just uses the current time) you will get performance behavior analogous to the Server 2003 code before dynamic time zones existed.</P>
<P mce_keep="true">Now both still do the static lookup and whether the extra several conversions is faster or slower than the one missed registry key hit for the non-existent time zone is probably too small to be measured in most cases....</P>
<P mce_keep="true">The scenario and the solution raise two problems for me:</P>
<OL>
<LI>
<DIV mce_keep="true">The dynamic time zone stuff was added for a reason, so there is potentially a chance to be off by an hour if one is dealing with historical dates rather than the current time<DMALL><SUP>3</SUP></SMALL>.</DIV></LI>
<LI>
<DIV mce_keep="true">Taking the time to convert and log the times causes all of the logs to be in the local time, which makes both looking at the logs by people in other time zones and comparing values across the possible range of&nbsp;values of successive years harder to do with complete accuracy since the original source is now lost without going back with dynamic time zone information later; leaving all times in UTC and only converting for display purposes in an event log if and when it is ever needed<SMALL><SUP>4</SUP></SMALL> is really always going to be faster.</DIV></LI></OL>
<P mce_keep="true">Similar to that time that Opera was calling SetLocaleInfo tons of times before they fixed the problem (discussed <A href="http://archives.miloush.net/michkap/archive/2008/03/21/8328509.html" mce_href="http://archives.miloush.net/michkap/archive/2008/03/21/8328509.html"><STRONG>here</STRONG></A>), any time one is doing something repeatedly, asking honest questions about how much work one has to with each iteration is not an unreasonable approach to optimization....</P>
<P mce_keep="true">&nbsp;</P>
<P><FONT size=1>1 - Actually, what he was doing/why he was doing it was a bit more complicated than this but the details are not entirely relevant to this blog; the description above is close enough!<BR><BR></FONT><FONT size=1>2 - Title explained previously in <A href="http://archives.miloush.net/michkap/archive/2006/09/16/755152.html" mce_href="http://archives.miloush.net/michkap/archive/2006/09/16/755152.html">You want to change the time zone? Eto Akta Gamat!</A><BR></FONT><FONT size=1><BR>3 - This may not be relevant if only the current time at the time the value is converted is being logged, i.e. the data is never historical when it is being converted.<BR><BR>4 - And no offense, but&nbsp;to be perfectly honest I doubt this is ever needed; the number of people who read event log details that are uncomfortable with UTC can all fit into one minivan and still have room for the cooler full of beer they would be taking along with them!</P></FONT></SUP>
<hr/><p><strong>Jim DeLaHunt</strong> on 4 Feb 2010 9:38 AM:</p><div style="margin-left: 1em"><p>Interesting. I wrote a bit about the philosophy behind this problem on my blog, in a post &quot;Times Change, or, We Live In Complex Times&quot; at <a rel="nofollow" target="_new" href="http://blog.jdlh.com/en/2008/03/24/times-change/">http://blog.jdlh.com/en/2008/03/24/times-change/</a>. &nbsp;It's tempting to have simple abstractions for things like time zones, but that conflicts with the messy reality of how humans measure and name times. </p>
<p>While it's great that Windows now can handle the complexity of time zone rules that change over time, there are execution-time costs, and not every user is willing to pay those. &nbsp;</p></div>
<p><strong>parkrrrr</strong> on 4 Feb 2010 10:33 AM:</p><div style="margin-left: 1em"><p>As I read this and Jim DeLaHunt's post on time zones, I suddenly came to the realization that my computer is probably set to the wrong time zone, so I went and checked. And I think I may have found something that slipped through the cracks.</p>
<p>You see, I live in Indiana, where we (stupidly, in my opinion) started observing DST in 2006. Before then, we did not observe DST. So, when I set up my new Windows 7 machine, I set it to the Eastern (UTC-05:00) time zone. Reading this post made me question whether I should actually be in the &quot;Indiana (East)&quot; time zone, since setting myself to the Eastern time zone loses that historical information and causes times before 2006 to potentially be wrong by an hour.</p>
<p>However, it appears that the Indiana (East) time zone, as included with Windows 7, still doesn't observe DST! So, as near as I can tell, there simply isn't a &quot;right&quot; time zone for most of this state included with Windows.</p>
</div>
<p><strong>parkrrrr</strong> on 4 Feb 2010 10:37 AM:</p><div style="margin-left: 1em"><p>Also, more in line with your usual post, what's that PUA character in Geoff Pease's quoted text supposed to be?</p>
</div>
<p><strong>John Cowan</strong> on 4 Feb 2010 11:01 AM:</p><div style="margin-left: 1em"><p>It's certainly better to keep logs and other records in UTC for consistency, but it's also often necessary to discover what local time corresponded to a given past UTC time at a specified location, because of the possible legal consequences &nbsp;-- was the stock market open or closed, was an event after the close of business, and so on. &nbsp;You can't in principle map future UTC times to local times, because you do not know how the politicians will change the time-zone mappings in the future, so you should store those as local times with an indication of the time zone (as is done in things like option exercise, where you are told that the option must be exercised by &quot;5 PM New York time&quot; or the like).</p>
<p>Sensible folks, therefore (including the maintainers of every OS other than Windows, and of Java and PHP even on Windows) use the zoneinfo time package, which contains very full and regularly maintained historical time-zone information, reflecting not only changes in DST but also secular changes in time zone. &nbsp;For example, different parts of Alaska used to observer UTC-8, UTC-9, UTC-10, and UTC-11, but as of 1983 it all became UTC-9 except for some of the Aleutians, which went to UTC-10. &nbsp;(This has some odd consequences: on the shortest day of the year in Nome, the sun actually rises in the afternoon!) &nbsp;Similarly, Hawaii switched from UTC-10:30 to UTC-10 in 1947.</p>
<p>You can get the current C source for the library and the historical TZ data at <a rel="nofollow" target="_new">ftp://elsie.nci.nih.gov/pub</a> .</p></div>
<p><strong>parkrrrr</strong> on 4 Feb 2010 11:08 AM:</p><div style="margin-left: 1em"><p>(Never mind; figured it out for myself. It's a Wingdings smiley face. Smiley faces, of course, have their own codepoint but this one is encoded as PUA because Wingdings is a symbol font.)</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 4 Feb 2010 2:59 PM:</p><div style="margin-left: 1em"><P>Okay, I just converted it to <A href="http://archives.miloush.net/michkap/archive/2005/11/08/490495.html">the other</A> (non-PUA) Wingdings smiley face!</P></div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/02/05/9958665.html" title="Adding the requisite number of mistakes to the code">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/02/04/9957398.html" title="Those missing TSF samples?">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-02">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-02-04">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/02/04/9958063.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>