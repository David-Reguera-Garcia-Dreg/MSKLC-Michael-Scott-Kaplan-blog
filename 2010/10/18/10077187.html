<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/10/18/10077187.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>When Moses was in GDI+ land, "Let my font memory go!"</title></head><body>
<h1>When Moses was in GDI+ land, "Let my font memory go!"</h1>
<p><em>by Michael S. Kaplan, published on 2010/10/18 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/10/18/10077187.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>The question was (as many of these questions) are, entirely reasonable.</p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;"><em>I tried to write a simple program to open a lot of fonts and dispose them. I am not seeing the GDI+ memory itself getting freed. Am I doing something wrong in this code? My code is written in C#, as shown below:</em></span></p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; static void Main(string[] args)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int i = 0;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (FontFamily fontfamily in FontFamily.Families)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i++;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Font f = new Font(fontfamily, (float)8.0, FontStyle.Bold);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine("Created Font #{0} {1} ", i, f.Name);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f.Dispose();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f = null;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} catch (Exception ex) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine("Exception while creating Font {0} {1}", fontfamily.Name, ex.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Console.ReadLine();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fontfamily.Dispose();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.WriteLine("Finished");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Console.ReadLine();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</strong></span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;"><em>My questions are: When exactly does the GDI+ memory that corresponds to a Font get freed? And how can we free the memory? Any suggestions will be sincerely appreciated.</em></span></p>
<p>Like I said, quite reasonable!</p>
<p>However, there is no guaranteed symmetry of reasonableness between question and answer. And this&nbsp;case is no exception....</p>
<p>The answer that came back from some of the GDI+ experts was a surprise to some.</p>
<p>It would have been a surprise to me if I weren't so numb to shock in things in GDI+ that didn't work the way I wanted and/or expected them to:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">To optimize performance, GDI+ retains some resources throughout the lifetime of the invoking process.&nbsp; These resources are not freed by the call to dispose.&nbsp; The only supported way to free these resources is to end the process.</span></p>
<p>Ouch.</p>
<p>And then one of my favorite people knowledgeable about details in WinForms that few people know about, <a href="http://blogs.msdn.com/b/jfoscoding/">Jessica Fosler</a>, added:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;"><em>There&rsquo;s some caveats about HFonts as well &ndash; if you&rsquo;ve called ToHFont at all (maybe to pass out to a p/invoke call) you need to call DeleteObject yourself.<br />(ref <a href="http://msdn.microsoft.com/en-us/library/system.drawing.font.tohfont.aspx">Font.ToHfont Method</a>)</em></span><span style="font-family: times new roman,times;"><em>&nbsp;<br /><br />But yes, if I remember - if you Delete a font that&rsquo;s still in use your control will be majorly unhappy and revert back to a really ugly system font.&nbsp; If you&rsquo;re disposing the font, you need to make sure it&rsquo;s not in use anywhere still.</em></span></p>
<p>Looks like there isn't&nbsp;any way to free that memory up, in that case. </p>
<p>Seems like a[nother] good reason to not use GDI+ if you can skip using it, just in case the myriad of other problems don't manage to dissuade....</p>
<hr/><p><strong>Zooba</strong> on 18 Oct 2010 10:15 PM:</p><div style="margin-left: 1em"><p>Surely that&#39;s only a good reason to not mis-use it, since keeping a font loaded for the length of a process would fit most uses. In fact, with the hatred of global variables at the level it often is (based on [AU]university/[US]college-level courses I have seen, and completely irrational), the likelihood of code creating and deleting a font each use is probably high enough to justify pretending to delete it.</p>
</div>
<p><strong>Mike Dimmick</strong> on 19 Oct 2010 8:26 AM:</p><div style="margin-left: 1em"><p>The commentary in the available source code (thanks to John Robbins for his .NET Mass Downloader) for .NET 2.0 SP1 indicates that GDI+ caches (the native equivalent of) *FontFamily* objects, not Font objects, and that the family objects are ref-counted. Of course fonts themselves could be cached and ref-counted, but I actually can&#39;t see a reason to do this - the variety of fonts is too great.</p>
<p>For .NET 4.0 ResourceConsumption and ResourceExposure attributes have been added, but as far as I can tell this is for a static analysis tool to investigate the closure of resource consumption and doesn&#39;t necessarily relate to caching inside an unmanaged library. The attributes are conditional, requiring RESOURCE_ANNOTATION_WORK to be defined when compiling the Framework to end up in the compiled assemblies.</p>
<p>If the unmanaged objects live on the default Windows heap, of course, and they&#39;re not too large, when they&#39;re freed they wind up on the lookaside lists designed to speed allocation and reduce fragmentation. Even if they don&#39;t the heap might well not free the segment (let&#39;s be honest, here, the program doesn&#39;t even exhaust its initial unmanaged heap segment), so the virtual size and probably working set wouldn&#39;t shrink. Monitoring the Virtual Bytes performance counter really only reveals gross leakage. Monitoring Working Set is nearly pointless as it depends so much on the pressure from other processes and subsystems in Windows.</p>
<p>My understanding was that HFONTs are reference-counted like other GDI objects, though this may be an implementation detail (and I ran out of brushes on Windows CE after calling DeleteObject on a brush that was still selected in a DC that was itself subsequently deleted, without deselecting the brush!) However, the HFONT you give to a control to draw itself doesn&#39;t, typically, remain selected in a DC: the control selects it into the DC that BeginPaint gives it. If the HFONT isn&#39;t valid, SelectObject fails and you get the default font for the DC, which is the System font.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/10/20/10078247.html" title="Khmer and let me tell you about a LIP....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/10/17/10076947.html" title="No one knows what it&#39;s like to be the sad man, to be the bad man, with blue filtered sight!">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-10">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-10-18">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/10/18/10077187.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>