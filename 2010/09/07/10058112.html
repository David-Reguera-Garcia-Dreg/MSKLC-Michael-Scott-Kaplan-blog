<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/07/10058112.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Refusing to ignore some particular character's width isn't [always] an act of discrimination…</title></head><body>
<h1>Refusing to ignore some particular character's width isn't [always] an act of discrimination…</h1>
<p><em>by Michael S. Kaplan, published on 2010/09/07 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/09/07/10058112.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><span style="color: #ff0000;"><em>Despite what the title may suggest to anyone, this blog is not about the Kevin Smith/Southwest Airlines debacle in any way. Though now that I've mentioned it and since the title may make an inappropriate suggestion of my opinion on <strong>that</strong> matter, I'll say that in my opinion Kevin was totally right and Southwest Airlines was totally wrong, and still is totally wrong. As someone who is regularly allowed to violate the baggage maximums on all airlines with neither fee nor penalty charged due to what can only be described as reverse discrimination, I'd say the treatment of Kevin was arbitrarily obnoxious and I wouldn't want to fly them again either. </em></span></p>
<p><span style="color: #ff0000;"><em>But as i said, the blog is not about that.</em></span></p>
<p>In the past, in blogs such as <a href="http://archives.miloush.net/michkap/archive/2005/05/05/414845.html" title="A few of the gotchas of CompareString"><strong>A few of the gotchas of CompareString</strong></a> and <a href="http://archives.miloush.net/michkap/archive/2006/05/04/589656.html" title="Sort the words, sort the strings"><strong>Sort the words, sort the strings</strong></a> and <a href="http://archives.miloush.net/michkap/archive/2006/11/16/1086283.html" title="The problem of string comparisons, WORD sorts, and the minus that is treated like the hyphen"><strong>The problem of string comparisons, WORD sorts, and the minus that is treated like the hyphen</strong></a> and especially <a href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html" title="A&amp;P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)"><strong>A&amp;P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)</strong></a>, I have taken the issue of <strong>string sort</strong> vs. <strong>word sort</strong> and beaten it to death, practically.</p>
<p>I felt like I had to, really. Because this feature (the WORD sort) is the default in the linguistic collation functions, but is not very well understood.</p>
<p>By anyone.</p>
<p>Now another point I have made in the past like in #11 of <a href="http://archives.miloush.net/michkap/archive/2005/10/05/477108.html" title="How to track down collation bugs"><strong>How to track down collation bugs</strong></a> is that&nbsp; as a general principle any time behavior is different between <a href="http://msdn2.microsoft.com/library/ms647476.aspx"><strong><span style="color: #006bad;">CompareString</span></strong></a>/<a href="http://msdn2.microsoft.com/library/ms647477.aspx"><strong><span style="color: #006bad;">CompareStringEx</span></strong></a> and <a href="http://msdn2.microsoft.com/library/ms776290.aspx"><strong><span style="color: #006bad;">LCMapString</span></strong></a>/<a href="http://msdn2.microsoft.com/library/ms776387.aspx"><strong><span style="color: #006bad;">LCMapStringEx</span></strong></a> with LCMAP_SORTKEY, while deciding which one is wrong can vary, in practice it is almost never the sort keys -- thus they make the best baseline for us, functionally<span style="font-size: xx-small;"><sup></sup></span></p>
<p>The few exceptions to that (e.g. <a href="http://archives.miloush.net/michkap/archive/2006/03/07/545097.html"><strong><span style="font-family: Tahoma; color: #006bad;">Everybody's doing the wraparound....</span></strong></a>&nbsp;and <span style="font-family: Tahoma;">the bug Atsushi Enomoto </span><a href="http://archives.miloush.net/michkap/archive/2005/06/15/429279.html#429337"><strong><span style="font-family: Tahoma; color: #006bad;">reported</span></strong></a>) are quite rare; the underlying point of <a href="http://archives.miloush.net/michkap/archive/2007/10/09/5375754.html" title="A&amp;P of Sort Keys, part 13 (About the function that is too lazy to get it right every time)"><strong>A&amp;P of Sort Keys, part 13 (About the function that is too lazy to get it right every time</strong>)</a> is that the core nature of these functions results in that particular truth.</p>
<p>And sort key bugs are just pretty damn rare.</p>
<p>Now as if to try and prove that the difference been NEVER happens and SELDOM happen, a sort key bug happened in Windows 7 and .Net 4.0.</p>
<p>You can see the public report of that bug on the Connect site, in <a href="https://connect.microsoft.com/VisualStudio/feedback/details/588533/">SortKey.Compare returns different results on .NET 4 than .NET 2, does not match CompareOptions.Compare</a>:</p>
<p style="padding-left: 60px;">string a = "－";<br />string b = "-";<br /><br />CompareInfo compareInfo = CultureInfo.GetCultureInfo(1033).CompareInfo;<br />CompareOptions compareOptions = CompareOptions.IgnoreCase | CompareOptions.IgnoreKanaType | CompareOptions.IgnoreWidth;<br />Console.WriteLine(compareInfo.Compare(a, b, compareOptions));<br /><br />SortKey sortKeyA = compareInfo.GetSortKey(a, compareOptions);<br />SortKey sortKeyB = compareInfo.GetSortKey(b, compareOptions);<br />Console.WriteLine(System.Globalization.SortKey.Compare(sortKeyA, sortKeyB));<br /><br />ACTUAL RESULTS:<br />0<br />1<br /><br />EXPECTED RESULTS:<br />0<br />0<br /><br />Same output as .NET Framework 2</p>
<p>The problem?</p>
<p>I can reproduce the same reported issue in Windows 7 (passing NORM_IGNORECASE | NORM_IGNOREKANATYPE | NORM_IGNOREWIDTH); weirdly, it is a genuine sort key bug. Basically you get the exact same sort key whether you pass the flags or not &ndash; it is not ignoring the width, essentially -- even when you ask it to. You simply always get the width included now, in this case.</p>
<p>The sort keys:</p>
<p style="padding-left: 60px;"><span style="font-family: courier new,courier;"><strong>U+ff0d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">13</span> 00<br />U+002d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">12</span> 00</strong></span></p>
<p>The keys will be the same, you pass NORM_IGNOREWIDTH or CompareOptions.IgnoreWidth to the native function or managed method, respectively.</p>
<p>Initially I had hoped that setting the compatibility flag on an EXE with the code would fix the behavior, but this seems&nbsp;to perhaps not be the case. :-(</p>
<p>The minimal repro is to just pass NORM_IGNOREWIDTH and don&rsquo;t worry so much about the string comparison; it is the sort key generation that is broken.</p>
<p>Now although "－" (U+ff0D) vs. "-" (U+002d) have this problem where NORM_IGNOREWIDTH doesn't ignore the width, you don't see the same results looking at "ＡＢＣＤ" vs. "ABCD" (U+ff21 U+ff22 U+ff23 U+ff24 vs. U+0041 U+0042 U+0043 U+0044).</p>
<p>It really is just in the word sorting -- those characters&nbsp;in that table in&nbsp;<a href="http://archives.miloush.net/michkap/archive/2007/09/20/5008305.html" title="A&amp;P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)"><strong>A&amp;P of Sort Keys, part 9 (aka Not always transitive, but punctual and punctuating)</strong></a>.</p>
<p>Of course one can&nbsp;"workround" the&nbsp;problem -- you can just use STRING sorting (i.e. SORT_STRINGSORT and CompareOptions.StringSort), since it is only the special case code for WORD sorting that has broken sort keys being created.</p>
<p>Here are the sort keys in these various cases:</p>
<p style="padding-left: 60px;"><span style="font-family: courier new,courier;"><strong>U+ff0d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">13</span> 00&nbsp;&nbsp; // (No flags)<br />U+002d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">12</span> 00&nbsp;&nbsp; // (No flags)<br /></strong><span style="font-family: courier new,courier;"><strong>U+ff0d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">13</span> 00&nbsp;&nbsp; // NORM_IGNOREWIDTH<br />U+002d 01 01 01 01 ff ff 82 <span style="color: #ff0000;">12</span> 00&nbsp;&nbsp; // NORM_IGNOREWIDTH<br /></strong></span></span><span style="font-family: courier new,courier;"><strong>U+ff0d 06 82 01 01 <span style="color: #ff0000;">03</span> 01 01 00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // SORT_STRINGSORT<br />U+002d 06 82 01 01 01 01 00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // SORT_STRINGSORT<br />U+ff0d 06 82 01 01 01 01 00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // NORM_IGNOREWIDTH&nbsp;| SORT_STRINGSORT<br />U+002d 06 82 01 01 01 01 00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // NORM_IGNOREWIDTH&nbsp;| SORT_STRINGSORT</strong></span></p>
<p>Now this is a pretty core regression in behavior that has existed for as long as the functionality has.</p>
<p>I&nbsp;wouldn't tend to be too excited about the workaround, myself (it works, but WORD SORTING is there for a reason). I would instead prefer to look forward to it being fixed in some future version, though....</p>
<p><span style="color: #ff0000;">But in any case, and just to leave no loose ends: although I am not a lawyer, I am reasonably certain that this bug, and the fact that in its default configuration Microsoft Windows 7 refuses to ignore the width of certain "wider" characters does not constitute discrimination on its part, in any way. It's just a bug that it all likelihood came out of a huge re-factoring that took place, and no one caught it prior to ship. If it bothers you, then keep in mind that you hadn't found it/reported it yet,&nbsp;either. :-)</span></p>
<hr/><p><strong>John Cowan</strong> on 7 Sep 2010 7:45 AM:</p><div style="margin-left: 1em"><p>Refactoring without testing? &nbsp;Shame, shame.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 7 Sep 2010 8:49 AM:</p><div style="margin-left: 1em"><p>Agree. There is always a risk in refactoring old code, when every feature and the interactions between them aren&#39;t completely understood. The risk of those missing edge cases....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/09/08/10059151.html" title="64 bits of awesomesauce, delivered!">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/09/06/10057561.html" title="Acrobat PDF: the Yugo vs. the BMW vs. the Ferrari">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09-07">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/07/10058112.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>