<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/14/10061557.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Using a culture's format, without using that culture to format?</title></head><body>
<h1>Using a culture's format, without using that culture to format?</h1>
<p><em>by Michael S. Kaplan, published on 2010/09/14 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/09/14/10061557.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>The title&nbsp;almost sounds like a riddle. </p>
<p>Though not quite.</p>
<p>Read it a couple of times, it will make sense....</p>
<p>As often happens, it started with a question:</p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">...an interesting bug.<br />According to </span><a href="http://msdn.microsoft.com/en-us/library/k494fzbf.aspx"><span style="font-family: times new roman,times;">http://msdn.microsoft.com/en-us/library/k494fzbf.aspx</span></a><span style="font-family: times new roman,times;">The value of the current DateTime object is formatted using the general date and time format specifier ('G').. <br />But we have a report where calling DateTime.MinValue.ToString(&ldquo;G&rdquo;) is throwing an exception. It&rsquo;s happening when the UmAlQuraCalendar is the calendar.<br />You can repro this in PowerShell by calling [DateTime]::MinValue.ToString("G", [System.Globalization.CultureInfo]::CreateSpecificCulture("ar&rdquo;)).</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">Something I&rsquo;m confused by is that an exception isn&rsquo;t thrown when &ldquo;G&rdquo; isn&rsquo;t specified. [DateTime]::MinValue.ToString([System.Globalization.CultureInfo]::CreateSpecificCulture("ar"))</span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">Why the difference in behavior?</span></p>
<p>Okay, let's look at a simple repro of this.</p>
<p>Simple repro:</p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;"><strong>&nbsp;&nbsp;&nbsp; public static void Main() {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(DateTime.MinValue.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(DateTime.MinValue.ToString(CultureInfo.CreateSpecificCulture("ar")));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Thread.CurrentThread.CurrentCulture = CultureInfo.CreateSpecificCulture("ar");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(DateTime.MinValue.ToString());<br /><span style="color: #ff0000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(DateTime.MinValue.ToString("G"));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Console.WriteLine(DateTime.MinValue.ToString("G", CultureInfo.CreateSpecificCulture("ar")));<br /></span>&nbsp;&nbsp;&nbsp;&nbsp; }</strong></span></p>
<p>Either of those last two lines in red will throw:</p>
<p style="padding-left: 90px;"><span style="font-family: courier new,courier;">Unhandled Exception: System.ArgumentOutOfRangeException: Specified time is not supported in this calendar. It should be between 04/30/1900 00:00:00 (Gregorian date) and 05/13/2029 23:59:59 (Gregorian date), inclusive.<br />Parameter name: time<br />&nbsp;&nbsp; at System.Globalization.UmAlQuraCalendar.CheckTicksRange(Int64 ticks)<br />&nbsp;&nbsp; at System.Globalization.UmAlQuraCalendar.GetDatePart(DateTime time, Int32 part)<br />&nbsp;&nbsp; at System.DateTimeFormat.FormatCustomized(DateTime dateTime, String format, DateTimeFormatInfo dtfi, TimeSpan offset)<br />&nbsp;&nbsp; at System.DateTimeFormat.Format(DateTime dateTime, String format, DateTimeFormatInfo dtfi, TimeSpan offset)<br />&nbsp;&nbsp; at System.DateTime.ToString(String format)<br />&nbsp;&nbsp; at Test.Main()</span></p>
<p>Now this question is specifically made interesting by the doc topic quoted, which mentions:</p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">The value of the current DateTime object is formatted using the general date and time format specifier ('G'). </span></p>
<p style="padding-left: 30px;"><span style="font-family: times new roman,times;">This method uses formatting information derived from the current culture. In particular, it combines the custom format strings returned by the ShortDatePattern and LongTimePattern properties of the DateTimeFormatInfo object returned by the Thread.CurrentThread.CurrentCulture.DateTimeFormat property. For more information, see CultureInfo.CurrentCulture. Other overloads of the ToString method enable you to specify the culture whose formatting to use and to define the output pattern of the DateTime value.</span></p>
<p>Perhaps if I gave the output of that code above an additional clue would come out of it all, interspersed with the code that caused it:</p>
<p style="padding-left: 30px;">Console.WriteLine(DateTime.MinValue.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1/1/0001 12:00:00 AM<br /><br />Console.WriteLine(DateTime.MinValue.ToString(CultureInfo.CreateSpecificCulture("ar")));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0001-01-01T00:00:00<br /><br />Thread.CurrentThread.CurrentCulture = CultureInfo.CreateSpecificCulture("ar");<br />Console.WriteLine(DateTime.MinValue.ToString());<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0001-01-01T00:00:00<br /><br />Console.WriteLine(DateTime.MinValue.ToString("G"));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {{EXCEPTION}}<br /><br />Console.WriteLine(DateTime.MinValue.ToString("G", CultureInfo.CreateSpecificCulture("ar")));<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {{EXCEPTION}}</p>
<p>Okay, so the doc claims related to the current culture are very misleading here, as are the claims that the "G" format is used by default (since it does "G"-like things but does not throw in a case where an explicit "G" does.</p>
<p>In the first three, it has a clear idea of what the MinValue is, and even though it is using the specified culture's (and current culture's when no culture is specified) format, it is not using the culture in question to do the actual formatting.</p>
<p>Let's just call it a bug. :-)</p>
<p>Now this is the kind of bug that starts as an oversight.</p>
<p>But once it is shipped, fixing it would basically break a person's code, any way you look at it.</p>
<p>To bwe honest I'd rather they fixed it anyway, but I can understand why they would not want to do that in this case given the nature of what kind of code might get broken.</p>
<p>This leads to one last question for some:</p>
<p><strong>Why not fix the documentation?</strong></p>
<p>It would be interesting to see proposals to doing the fix. I mean how do you document a bug like this, exactly? </p>
<p>I mean how, in an easy succinct way, do you document that the default way to do something in the simplest overload doesn't behave correctly?</p>
<p>Personally, I find the whole DateTime.MinValue concept to be kind of lame anyway, since it never makes sense as a value, even ignoring the <a href="http://archives.miloush.net/michkap/archive/2006/10/25/868025.html" title="Out of [implied] range"><strong>Out of [implied] range</strong></a> issues.</p>
<p>It is the <a href="http://archives.miloush.net/michkap/archive/2007/07/21/3991927.html" title="Theory vs. practice in software development"><strong>Theory vs. practice in software development</strong></a>&nbsp;issues, which point out that even though DateTime.MinValue doe not throw in the Gregorian calendar, that date is meaningless in that calendar. Supporting DateTime.MinValue for that calendar is incorrect too!</p>
<p>This whole section of .Net is slightly flawed conceptually, though really its only flaw was caused by the fact that it tried to formalize&nbsp;something that was going on in Windows. Perhaps, given that model decision, the choice of throwing on any of these dates in any calendar is the real flaw.</p>
<p>I mean, is it more impressive to throw when a standard (the Saudi calndar) sets a limit than when one is out of the bounds of a calendar's known range?</p>
<p>Somehow I doubt this one will ever be seriously taken&nbsp;up. Though it makes me miss Kim and Katy&nbsp;to think about it....</p>
<hr/><p><strong>Alex Cohn</strong> on 14 Sep 2010 1:59 PM:</p><div style="margin-left: 1em"><p>I understand the date range is limited for many calendars, and Arabic too. But I thought it should go back 1400 years or so. What is special about 04/30/1900?</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 14 Sep 2010 4:56 PM:</p><div style="margin-left: 1em"><p>The Saudi standard that the UmAlQuraCalendar class follows has that as a start date; dates before that are undefined.</p>
</div>
<p><strong>Doug Ewell</strong> on 15 Sep 2010 8:32 AM:</p><div style="margin-left: 1em"><p>&gt; But once it is shipped, fixing it would basically break a person&#39;s code, any way you look at it.</p>
<p>Developers rely on this exception being thrown?</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 15 Sep 2010 8:35 AM:</p><div style="margin-left: 1em"><p>Actually, I was thinking of the other direction -- the throw is arguably the &quot;right&quot; behavior, so you would be adding a throw....</p></div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2011/06/15 <a href="http://archives.miloush.net/michkap/archive/2011/06/15/10174716.html">Does your code avoid the [government sanctioned] Y1.45K bug?</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/09/15/10062047.html" title="How to format? What locale?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/09/13/10060986.html" title="Olive, the other reindeer, gets to Sort it all Out too....">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09-14">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/14/10061557.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>