<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/23/10066660.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>A confluence of circumstances leaves a stone unturned...</title></head><body>
<h1>A confluence of circumstances leaves a stone unturned...</h1>
<p><em>by Michael S. Kaplan, published on 2010/09/23 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/09/23/10066660.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>Thinking back to blog posts from earlier this year, like </p>
<ul>
<li><a href="http://archives.miloush.net/michkap/archive/2010/02/15/9963784.html" title="The real problem(s) with all of these console &quot;fallback&quot; discussions"><strong>The real problem(s) with all of these console "fallback" discussions</strong></a></li>
<li><a href="http://archives.miloush.net/michkap/archive/2010/04/07/9989346.html" title="Anyone who says the console can't do Unicode isn't as smart as they think they are"><strong>Anyone who says the console can't do Unicode isn't as smart as they think they are</strong></a></li>
<li><a href="http://archives.miloush.net/michkap/archive/2010/05/07/10008232.html" title="Cunningly conquering communicated console caveats. Comprende, mon Capit&amp;aacute;n?"><strong>Cunningly conquering communicated console caveats. Comprende, mon Capit&aacute;n?</strong></a>, </li>
</ul>
<p>&nbsp;It can be important to think back to an earlier&nbsp;one, <a href="http://archives.miloush.net/michkap/archive/2008/03/18/8306597.html" title="Conventional wisdom is retarded, aka What the @#%&amp;amp;* is _O_U16TEXT?"><strong>Conventional wisdom is retarded, aka What the @#%&amp;* is _O_U16TEXT?</strong></a>.</p>
<p>In it, I talked about how I was meeting with&nbsp;<a href="http://nuwen.net/stl.html">STL</a>. What I didn't mention at at the time was that we were meeting to talk about what were the features in the CRT that were broken in regards to Unicode support.</p>
<p>There was a bunch that was broken like the locale data only having a non-Unicode backing store, and all of these items were fixed in version of the CRT that came out most recently.</p>
<p>However, as that blog points out, when STL was looking at one of my other complaints (the Unicode input/output problems), he found that someone had already done the work to add things like <strong>_O_U16TEXT</strong> and the like to get the right behavior when dealing with Unicode.</p>
<p>So he left that stuff alone (since it worked) and focused on the stuff that was insanely broken (like the locale stuff; considering all the conversion code he had to remove he&nbsp;might have had negative LOC numbers during that time!).</p>
<p>Now all of the blogs I list above do the work directly via the Win32 API (WriteConsoleW/WriteFile) and mention how you can the input via ReadConsoleW/ReadFile. I had tested all that and all of that works just fine, and has for some time.</p>
<p>This begs the question: why would I do that extra work after starting it all years ago by pointing out that the comparatively easy code (just a few lines) using the CRT works well?</p>
<p>Well, it was a side effect of how I was doing the samples!</p>
<p>You see, in my samples, I was usually writing C code in C# as a way to be more universally accessible to developers who weren't as comfortable with strauight C, and I could not figure out how to do the setmode&nbsp;work via the CRT in C#, so I just decided to do it the long way and go from there.</p>
<p>Unfortunately, there was a consequence of all of the previous history and this explicit choice of mine.</p>
<p>As it turns out, the work to support stuff like&nbsp;<strong>_O_U16TEXT </strong>et. al., while properly handling <strong>stdout</strong> and <strong>stderr</strong>, has no proper support for <strong>stdin</strong>.</p>
<p>It was architect Dave Thaler who first found this out when he was doing some essentially unrelated work. Like all good developers, he went the extra mile to try all of the reasonable things he could think of, like these three variations:</p>
<p style="PADDING-LEFT: 30px; FONT-FAMILY: "><span style="font-family: courier new,courier;"><strong>&nbsp;&nbsp;&nbsp; wprintf(L"&gt; ");<br />&nbsp;&nbsp;&nbsp; wscanf(L"%ls", Buffer);<br />&nbsp;&nbsp;&nbsp; wprintf(L"stdin: %ls\n", Buffer);<br /><br /><br /><br />&nbsp;&nbsp;&nbsp; wprintf(L"&gt; ");<br />&nbsp;&nbsp;&nbsp; _setmode(_fileno(stdin), _O_U16TEXT);<br />&nbsp;&nbsp;&nbsp; wscanf(L"%ls", Buffer);<br />&nbsp;&nbsp;&nbsp; wprintf(L"stdin _O_U16TEXT: %ls\n", Buffer);<br /><br /><br /><br />&nbsp;&nbsp;&nbsp; wprintf(L"&gt; ");<br />&nbsp;&nbsp;&nbsp; _setmode(_fileno(stdin), _O_BINARY);<br />&nbsp;&nbsp;&nbsp; wscanf(L"%ls", Buffer);<br />&nbsp;&nbsp;&nbsp; wprintf(L"stdin _O_BINARY: %ls\n", Buffer);</strong></span></p>
<p>but each of these, and more, were failing -- the first one was converting it in and out of Unicode (ick) and the second two were requiring the user to type ^Z (CTRL+Z) to end the input and then also corrupting the text.</p>
<p>The investigation showed that the <strong>stdin</strong> side of this fix for Unicode input/output&nbsp;was never done.</p>
<p>I was so used to thinking of STL as the guy who did the Unicode work that it was only after he remind me that I realized that this was work someone else had done, at least four years prior to him even having a chance to look at the code!</p>
<p>Suddenly I felt a little bit relieved that I had been doing it the hard Win32 way all this time, because my code simply worked. </p>
<p>Though I felt bad that I hadn't figured out the "setmode from C#" problem and stayed with the "easier" CRT code, since then I would have seen the same bug that Dave ran into later as he was writing something that was using the CRT.</p>
<p>Anyway, the bug is in now so they can look at fixing it in the future, and in the meantime doing it all in Windows via functions such as ReadConsoleW/ReadFile will do the trick. And maybe someone from CSS could write a KB article about the CRT bug.</p>
<p>Or failing that, there is this blog you are reading.... :-)</p>
<hr/><p><strong>John L Veazey</strong> on 15 Jul 2011 1:38 PM:</p><div style="margin-left: 1em"><p>Is it possible to find out the current mode on a Pipe (from CreatePipe)? &nbsp;I&#39;m using the example code in the MS KB article &quot;How to spawn console processes with redirected standard handles&quot; (<a rel="nofollow" target="_new" href="http://support.microsoft.com/kb/190351">support.microsoft.com/.../190351</a>). &nbsp;So far I have figured out how to determine if a child process is writing out Unicode/Ansi. &nbsp;But I haven&#39;t been able to figure out whether the child process _reads_ Unicode. &nbsp;For example &quot;cmd.exe /U /K&quot; prints out Unicode but doesn&#39;t seem to accept it as input.</p>
</div>
<hr/><p><em>referenced by</em></p><div style="margin-left: 1em"><p>2010/10/07 <a href="http://archives.miloush.net/michkap/archive/2010/10/07/10072032.html">Myth busting in the console</a></p></div><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/09/24/10066527.html" title="Intentional, or maybe not. Hard to say from the outside....">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/09/22/10066037.html" title="Looking at life a bit more vertically, for a moment...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09-23">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/23/10066660.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>