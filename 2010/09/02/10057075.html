<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/02/10057075.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>On Bengali sorting (where an old part of my personal life mirrors an even older bug in Windows)</title></head><body>
<h1>On Bengali sorting (where an old part of my personal life mirrors an even older bug in Windows)</h1>
<p><em>by Michael S. Kaplan, published on 2010/09/02 07:01 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/09/02/10057075.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p><em><span style="color: #ff0000;"><strong>Although it doesn't start off very technical, this blog will become technical quickly enough. Standard disclaimers about all of the people I am not speaking for apply, obviously....</strong></span></em></p>
<p><strong>Preparatory information for this blog you are reading which may be useful to provide context:</strong></p>
<p style="padding-left: 60px;"><em>My interest in Indic languages in general and Bengali in particular pre-dates my personally knowing any Bengalis (not entirely true since there are friends of mine like Trina Saha who I have known for many years but I did not know she was Bengali when I first knew her all those years ago, so it may as well be true).<br /><br />Also, I have a bunch of friends from India and Bangladesh that I have met over the last few years since that time, and several of those friends are on Facebook.<br /><br />A few years back I dated a "Bengali" woman, and from my limited sample size&nbsp;of one I'll confirm that whatever you have heard about beauty, intelligence, and passion about them is entirely true. <br /><br />The relationship ended up not working out when all was said and done, and I'm pretty sure that was in part (though not completely) my fault. And I did not fully understand some aspects of the relationship itself, as is often expected of men in such situations, though it was probably entirely understandable from the proper vantage point.<br /><br />All of this information is something you should keep in mind as it provides both source material for the problem I'll be discussing (the bug, not the relationship!),&nbsp;and the framework for an extended analogy describing a product bug in terms of my personal life. If that sort of thing annoys you, then please feel free to find another </em><a href="http://blogs.msdn.com/"><em>MSDN Blog</em></a><em> to read; I find it to be relaxing to identify metaphorical patterns such as this.</em></p>
<p><strong>The blog itself follows. :-)</strong></p>
<p>It all started the other day, on Facebook.</p>
<p>My friend there, <a target="_blank" href="http://www.facebook.com/tanbin.islam">Tanbin Islam Siyam</a>, posted the following screenshot and text:</p>
<p style="padding-left: 30px;"><img src="http://trigeminal.fmsinc.com/images/BengaliSortBug01.jpg" border="0" /><br /><br /><span style="font-size: medium;">এক্সেল আর ওয়ার্ড দুটোতেই চেষ্টা করলাম, অজ্ঞাত কারণে উ-কার, ঊ-কার ও ঋ-কার উপরে উঠে যাচ্ছে। কি করে সম্ভব??</span></p>
<p>&nbsp;After which, friend <a href="http://www.facebook.com/rifat">Rifat Nabi</a> included the following <a href="http://screencast.com/t/MTU4N2M1M">screenshot</a> and text in the comments:</p>
<p style="padding-left: 30px;"><img src="http://trigeminal.fmsinc.com/images/BengaliSortBug02.png" border="0" /><br /><br /><em>&nbsp;I'm using Office 2010. Check this out - [N.B- This one is also wrong :( but different]</em></p>
<p>As you can probably guess even if you know no Bengali whatsoever, both complaints were about the sort order of the text.</p>
<p>Now the mistakes people often make when they look to see text sorted properly for Indic languages on Windows fall into a few broad categories:</p>
<ol>
<li>Some people expect the text to be sorted on a version of Windows prior to that language being added;</li>
<li>Other people expect the text to be sorted correctly in a Word table even if they did not mark the text language properly;</li>
<li>Still other people expect the text to be sorted correctly in Excel even if they did not set their default user locale to the correct language;</li>
<li>And still other people expect the text to be sorted correctly in Access or SQL Server even if the collation was not set correctly.</li>
</ol>
<p>Now with both examples clearly in Excel, I assumed that problem #2 was involved, or maybe problem #1.</p>
<p>But it was actually none of those things.</p>
<p>You see, while it is true that you need to be using the right locale in order to get the full support, the truth is that this is primarily for the sake of proper sorting when certain specific characters are included, in the case of Bengali characters like the following:</p>
<ul>
<li>U+0981 (BENGALI SIGN CANDRABINDU)</li>
<li>U+0982 (BENGALI SIGN ANUSVARA)</li>
<li>U+0983 (BENGALI SIGN VISARGA)</li>
<li>U+09cd (BENGALI SIGN VIRAMA, aka BENGALI HASANT)</li>
</ul>
<p>The truth is that for everything other than the way these four characters combine with the other letters, the sort is handled just fine by the default table any time the underlying platform supported the sort, and you don't have to set the locale or use the collation to get the right behavior for Bengali.</p>
<p>In this case, the first Excel spreadsheet had the following in it:</p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;"><strong>ক&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; KA&nbsp;&nbsp; BENGALI LETTER KA<br />কা&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09be&nbsp; KAA&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN AA<br />কি&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09bf&nbsp; KI&nbsp;&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN I<br />কী&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c0&nbsp; KII&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN II<br />কু&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;U+0995 U+09c1&nbsp; KU&nbsp;&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN U<br />কূ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c2&nbsp; KUU&nbsp;&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN UU<br />কৃ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c3&nbsp; KAR&nbsp;&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN VOCALIC R<br />কে&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c7&nbsp; KE&nbsp;&nbsp;&nbsp;BENGALI LETTER KA + BENGALI VOWEL SIGN E<br />কৈ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c8&nbsp; KAI&nbsp;&nbsp;BENGALI LETTER KA + BENGALI VOWEL SIGN AI<br />কো&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09cb&nbsp; KO&nbsp;&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN O<br />কৌ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09cc&nbsp; KAU&nbsp; BENGALI LETTER KA + BENGALI VOWEL SIGN AU</strong></span></p>
<p>And the problem? That the order was not what they expected.</p>
<p><em>Kind of like the way that relationship had things not as I expected them. I mean, some of it was, but other parts confused me and stuff just seemed out of sorts at time. I'm sure she felt the same way....</em></p>
<p>Now in looking into this, I started by grabbing the sort keys of the characters in question:</p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;"><strong>ক&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 33 20 01 01 01 01 00<br />কা&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09be 33 20 33 30 01 01 01 01 00<br />কি&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09bf 33 20 33 31 01 01 01 01 00<br />কী&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c0 33 20 33 32 01 01 01 01 00<br />কু&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c1 33 20 01 <span style="color: #ff0000;">07</span> 01 01 01 00<br />কূ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c2 33 20 01 <span style="color: #ff0000;">08</span> 01 01 01 00<br />কৃ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c3 33 20 01 <span style="color: #ff0000;">09</span> 01 01 01 00<br />কে&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c7 33 20 33 33 01 01 01 01 00<br />কৈ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09c8 33 20 33 34 01 01 01 01 00<br />কো&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09cb 33 20 33 35 01 01 01 01 00<br />কৌ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U+0995 U+09cc 33 20 33 36 01 01 01 01 00</strong></span></p>
<p>And suddenly I had my first clue, with the items marked in red.</p>
<p>Why did some of these entries have a diacritic weight?</p>
<p>This sent me to the Windows protocol Docs, in particular <a href="http://msdn.microsoft.com/library/cc248997.aspx">3.1.5.2.3 Accessing the Windows Sorting Weight Table</a>, which got me to <a href="http://msdn.microsoft.com/library/cc249012.aspx">7 Appendix B: Windows Sorting Weight Table</a>which got me eventually to the 16.5mb <strong>Windows 7 and Windows Server 2008 R2 Sorting Weight Table</strong>, from which I extracted the following relevant entries:</p>
<p style="padding-left: 30px;"><span style="font-family: courier new,courier;"><strong>0x09c1&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 5&nbsp; 0&nbsp; ;Bengali Vowel Sign U<br />0x09c2&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 6&nbsp; 0&nbsp; ;Bengali Vowel Sign Uu<br />0x09c3&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 7&nbsp; 0&nbsp; ;Bengali Vowel Sign Vocalic R<br />0x09c4&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 8&nbsp; 0&nbsp; ;Bengali Vowel Sign Vocalic Rr<br />0x09e2&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 10 0&nbsp; ;Bengali Vowel Sign Vocalic L<br />0x09e3&nbsp; 1&nbsp;&nbsp; 0&nbsp;&nbsp; 11 0&nbsp; ;Bengali Vowel Sign Vocalic Ll<br /><br />0x0995&nbsp; 51&nbsp; 32&nbsp; 2&nbsp; 2&nbsp; ;Bengali Ka<br /><br />0x09be&nbsp; 51&nbsp; 48&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign Aa<br />0x09bf&nbsp; 51&nbsp; 49&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign I<br />0x09c0&nbsp; 51&nbsp; 50&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign Ii<br />0x09c7&nbsp; 51&nbsp; 51&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign E<br />0x09c8&nbsp; 51&nbsp; 52&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign Ai<br />0x09cb&nbsp; 51&nbsp; 53&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign O<br />0x09cc&nbsp; 51&nbsp; 54&nbsp; 2&nbsp; 2&nbsp; ;Bengali Vowel Sign Au</strong></span></p>
<p>Now there is really no good reason for the first six vowels to sort with just "secondary" distinction while the last seven vowels do not; although there is currently some dispute about how Bengali should in fact be sorted, it is fairly obvious that all of the dependant vowels should be sorted the same way.</p>
<p>As luck would have it, in the typical way one might try to sort Bengali one could finesse the weight tables in a way to make either of these options work, but there is no option that will let you work by combining the two and putting half of the vowels in each category. And to be honest it would be easier and more consistent with other Indic languages and a better experience all the way around for several other reasons not relevant at the moment to not use the diacritic weights here,</p>
<p>No other Indic language appears to have this specific problem; it only exists in Bengali.</p>
<p><em>I am sure my Ex, if I were to ask her, would admit that "Michael, some of the problems in the relationship were because of you" (or "<strong>u</strong>" to use texting lingo).</em></p>
<p>Thus it should not surprise me that about 33% of the problem relates to the way BENGALI VOWEL SIGN <strong>U</strong> and BENGALI VOWEL SIGN <strong>UU</strong> are sorting. Pardon the pun.</p>
<p><em>My Ex would probably not be surprised if I said that I didn't fully understand what happened and what didn't work out</em>.</p>
<p>This may well correspond to the fact that the other 67% of the main problem relates to the VOWEL SIGN VOCALIC R, RR, L and LL sort, since even now that I am able to pronounce them, I still don't fully understand how the vocalic vowels work from a linguistic standpoint.</p>
<p><em>I&nbsp;am reasonably certain&nbsp;my Ex would admit that I was right all along when I initially pointed out that she and I were really not compatible, with all of the differences in cultural background and age and general cynicism about life. And that despite the intellect the interest we did connect on that it never really was going to be the right thing for either of us.</em></p>
<p>One&nbsp;interesting&nbsp;facet of the bug&nbsp;is that if you go back to <a href="http://msdn.microsoft.com/library/cc249012.aspx">7 Appendix B: Windows Sorting Weight Table</a>&nbsp;and the 3.3mb <strong>Windows NT 4.0 through Windows Server 2003 Sorting Weight Table</strong>, you will see that this dependant vowel category split has existed since these code points were first added to the Windows default weight table during the Windows 2000 beta, which was several versions before true linguistic support, or fonts, was even claimed to be added to Windows.</p>
<p>So given the historical weights that have been wrong all this time it is fair to say that Bengali collation has not only <strong>always been broken on Windows</strong>, but also it has <strong>also been broken for as long as Bengali collation support has been claimed to be present</strong>. It was never really ever the right thing happening.</p>
<p><em>She (the Ex) and I did get along and had some great&nbsp; moments, and it was only when you looked really closely that you saw the problems. If we were less self aware we may have lasted much longer.</em></p>
<p>On Windows the Bengali results are never truly awful except when you really look closely at the details and compare the way one set of vowels sort with consonants to the way the other vowels sort with the same consonants.</p>
<p><em>And at first both she and I discounted the issues in the relationship&nbsp;since it was new and interesting and who overthinks a relationship before it exists?</em></p>
<p>Now technically the collation weights have been wrong in this way since Windows 2000 Beta 1, but since no one claimed the support was right until Vista we would have discounted such reports by saying the collation was not expected to be accurate yet. Who would have taken the early bug report seriously?</p>
<p><em>Unless you looked up close at the aforementioned details, she (the Ex) and I were just fine together.</em></p>
<p>And since the primary weights of all the consonants and half the vowels were correct, you have to craft specific examples to see the problem in the sort -- otherwise everything seemed just fine. And no one complained for years, which helps prove my point.</p>
<p>And now we finally get to where my analogy breaks down.</p>
<p><em>Because although it is unlikely in the extreme that she (the Ex) and I would try a romantic relationship again (it is the Tamil -- and Kerala -- girls who have been catching my eye more recently anyway!)</em>, there is a much more reasonable chance that some future version of Windows could support a Bengali that did not have the bug with these six letters (and a few other less systemic minor problems I noticed cleared up, too).</p>
<p>Oh, and by the way? Assamese is broken, too. On the same letters.</p>
<p><strong><span style="color: #ff0000;">If you are a tester&nbsp;from the team formerly known as NLS, you should feel free to enter a bug (just one single bug) on this issue. I suppose you can assign it to me for the time being.... :-)</span></strong></p>
<hr/><p><strong>Michael S. Kaplan</strong> on 2 Sep 2010 6:48 PM:</p><div style="margin-left: 1em"><p>I must admit that the number and varied nature of responses I have gotten has been interesting -- of the responses, about 30% found the back story to be distracting (1 of them classified the distraction as &quot;disappointing&quot;), about 40% liked that I wrote about something that non-technical people could enjoy as well, and the remaining ones thanked me for the way the bulk of the actual bug description was kept separate from the back story....</p>
</div>
<p><strong>Alex Cohn</strong> on 5 Sep 2010 9:16 AM:</p><div style="margin-left: 1em"><p>Thanks, it&#39;s probably the best post in this blog. IMVHO, the balance of personal and technical is what makes blogs different from &quot;MSDN newsletter&quot;, etc.</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/09/03/10057586.html" title="I knew where Nepal was before Raiders of the Lost Ark. Did you?">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/09/01/10056685.html" title="Those chars aren&#39;t the UTF-8 you&#39;re looking for. Move along...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-09-02">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/09/02/10057075.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:35 GMT -->
</html>