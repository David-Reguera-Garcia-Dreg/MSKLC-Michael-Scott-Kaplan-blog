<html>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/11/08/10087179.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width" /><title>Header files are the wrong place to be less than helpful</title></head><body>
<h1>Header files are the wrong place to be less than helpful</h1>
<p><em>by Michael S. Kaplan, published on 2010/11/08 07:01 -05:00, original URI: http://blogs.msdn.com/b/michkap/archive/2010/11/08/10087179.aspx</em></p>
<hr/> <!-- Archival Source: ProcessPostNew -->
<p>A lot the people who work on the absolute latest version of Windows should have a lot more respect and consideration for the other, previous versions -- including the latest shipping version.</p>
<p>Not all of them, mind you. There are those who care about those other versions a lot no matter what they are working on.</p>
<p>A lot of them&nbsp;ought to, though.</p>
<p>It was late last month when someone was asking:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;"><em>I have a requirement to enumerate the list of all country/regions in localized form depending on the current OS locale, just like the way they are shown when the OS is installed. Can someone point me to the API?</em></span></p>
<p>Now when a question like this is asked by someone inside of Microsoft, there are levels upon levels of things to consider that aren't an issue with a question asked by someone outside of Microsoft.</p>
<p>Like do they literally want to do it the way setup does it (e.g. maybe code running at the same time? Think Easy Transfer Wizard type stuff!) or is equivalent functionality acceptable?</p>
<p><em>The lists setup builds have every item that will be in the new OS after it is installed, so it can't call the currently installed OS.</em></p>
<p>Is the person&nbsp;asking for possibly internal, undocumented functions? If so then are they on the Windows team? </p>
<p><em>We can't give out internal Windows stuff to folks not on Windows.</em></p>
<p>Or is it someone in Product Support or Consulting Services or some other customer facing org, asking on behalf of a customer -- or code being written for a customer?</p>
<p><em>I won't explain why this changes things, but it should be obvious.</em></p>
<p>No worries this time, they just wanted equivalent functionality, publicly documented. So it can be the same answer I would give everyone out in the world too. If I were answering the question.</p>
<p>I didn't answer the question then, someone else did:</p>
<p style="padding-left: 60px;"><span style="font-family: times new roman,times;">EnumSystemLocalesEx and GetLocaleInfoEx with LOCALE_SLOCALIZEDCOUNTRYNAME.&nbsp; LOCALE_SLOCALIZEDCOUNTRYNAME is only available on Windows 7 and later I&rsquo;m afraid.&nbsp; I&rsquo;m hoping by &ldquo;current OS locale&rdquo; you mean the users UI language (and not User Locale or System Locale).</span></p>
<p>I am not going to answer it now, I'll let the answer given stand.</p>
<p>However, in true passive/aggressive form, I am going to criticize&nbsp;the answer&nbsp;a bit. :-)</p>
<p>i won't criticize the&nbsp;third&nbsp;sentence ("<span style="font-family: times new roman,times;">I&rsquo;m hoping by &ldquo;current OS locale&rdquo; you mean the users UI language (and not User Locale or System Locale).</span>"), that is good level-setting about using&nbsp;the right&nbsp;locale among the many choices -- in this case the UI language. I do that all the time!</p>
<p>But those first two sentences. Let's chat a bit.....</p>
<p>First of course the first sentence ("<span style="font-family: times new roman,times;">EnumSystemLocalesEx and GetLocaleInfoEx with LOCALE_SLOCALIZEDCOUNTRYNAME.</span>"):</p>
<p>I am a huge fan of <a href="http://msdn.microsoft.com/library/dd317829.aspx">EnumSystemLocalesEx</a> over <a href="http://msdn.microsoft.com/library/dd317828.aspx">EnumSystemLocales</a>, and <a href="http://msdn.microsoft.com/library/dd318103.aspx">GetLocaleInfoEx</a> over <a href="http://msdn.microsoft.com/library/dd318101.aspx">GetLocaleInfo</a>. After all, I have been the person fearlessly saying <a href="http://archives.miloush.net/michkap/archive/2007/07/23/4021529.html" title="Your LCID Sucks"><strong>LCIDs</strong></a> <a href="http://archives.miloush.net/michkap/archive/2007/08/20/4472890.html" title="It is true that your LCID sucks, but your LANGID sucks more"><strong>Suck</strong></a>&nbsp;both internally and externally before we even had all of the functions that could be used instead of them. I was saying it back when people were arguing about whether new functions were needed, as part of the reason to do some of the work!</p>
<p>But I am aware of the fact that sometimes, in fact most times, developers everywhere in the world other than the Windows team have to consider the need to support versions of the operating system older than Vista.</p>
<p>So while I have no problem pushing one solutioon over the other, I like to provide a bit more context.</p>
<p>It isn't like the docs help. If you go to <a href="http://msdn.microsoft.com/library/dd319081.aspx">the list of Windows National Language Support functions</a>, the table lays them out as:</p>
<table border="1" style="width: 95%;">
<tbody>
<tr>
<td><a href="http://msdn.microsoft.com/en-us/library/dd317828.aspx">EnumSystemLocales</a></td>
<td>Enumerates the locales that are either installed on or supported by an operating system.</td>
</tr>
<tr>
<td><a href="http://msdn.microsoft.com/en-us/library/dd317829.aspx">EnumSystemLocalesEx</a></td>
<td>Enumerates the locales that are either installed on or supported by an operating system.</td>
</tr>
</tbody>
</table>
<p>Boy, way to help point people in the right direction there! Like maybe the&nbsp;Ex function could mention "using standards conformant locale names" or whatever.&nbsp;Or maybe put all the old functions in a separate table after the first big list of the most up-to-date functions? Something....</p>
<p>As I pointed out in <a href="http://archives.miloush.net/michkap/archive/2005/10/31/486870.html" title="To Ex or not to Ex? THAT is the question."><strong>To Ex or not to Ex? THAT is the question.</strong></a>, unless you are intimately familiar with the two functions then in most cases you won't know which one to use.</p>
<p>Okay, you get my point.</p>
<p>Now let's talk about that second sentence, "<span style="font-family: times new roman,times;">LOCALE_SLOCALIZEDCOUNTRYNAME is only available on Windows 7 and later I&rsquo;m afraid.</span>".</p>
<p>Hmmmm.</p>
<p>Let's take a look at WinNls.h, they've done some shuffling here:</p>
<p><span style="font-family: courier new,courier;"><strong>//<br />// These are the various forms of the name of the locale:<br />//<br />#define LOCALE_SLOCALIZEDDISPLAYNAME&nbsp; 0x00000002&nbsp;&nbsp; // localized name of locale, eg "German (Germany)" in UI language<br />#if (WINVER &gt;= _WIN32_WINNT_WIN7)<br />#define LOCALE_SENGLISHDISPLAYNAME&nbsp;&nbsp;&nbsp; 0x00000072&nbsp;&nbsp; // Display name (language + country/region usually) in English, eg "German (Germany)"<br />#define LOCALE_SNATIVEDISPLAYNAME&nbsp;&nbsp;&nbsp;&nbsp; 0x00000073&nbsp;&nbsp; // Display name in native locale language, eg "Deutsch (Deutschland)<br />#endif //(WINVER &gt;= _WIN32_WINNT_WIN7)<br /><br />#if (WINVER &gt;= _WIN32_WINNT_VISTA)<br />#define LOCALE_SLOCALIZEDLANGUAGENAME 0x0000006f&nbsp;&nbsp; // Language Display Name for a language, eg "German" in UI language<br />#endif //(WINVER &gt;= _WIN32_WINNT_VISTA)<br />#define LOCALE_SENGLISHLANGUAGENAME&nbsp;&nbsp; 0x00001001&nbsp;&nbsp; // English name of language, eg "German"<br />#define LOCALE_SNATIVELANGUAGENAME&nbsp;&nbsp;&nbsp; 0x00000004&nbsp;&nbsp; // native name of language, eg "Deutsch"<br /><br />#define LOCALE_SLOCALIZEDCOUNTRYNAME&nbsp; 0x00000006&nbsp;&nbsp; // localized name of country/region, eg "Germany" in UI language<br />#define LOCALE_SENGLISHCOUNTRYNAME&nbsp;&nbsp;&nbsp; 0x00001002&nbsp;&nbsp; // English name of country/region, eg "Germany"<br />#define LOCALE_SNATIVECOUNTRYNAME&nbsp;&nbsp;&nbsp;&nbsp; 0x00000008&nbsp;&nbsp; // native name of country/region, eg "Deutschland"<br /><br />//<br />// Legacy labels for the locale name values<br />//<br />#define LOCALE_SLANGUAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000002&nbsp;&nbsp; // localized name of locale, eg "German (Germany)" in UI language<br />#if (WINVER &gt;= _WIN32_WINNT_VISTA)<br />#define LOCALE_SLANGDISPLAYNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x0000006f&nbsp;&nbsp; // Language Display Name for a language, eg "German" in UI language<br />#endif //(WINVER &gt;= _WIN32_WINNT_VISTA)<br />#define LOCALE_SENGLANGUAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00001001&nbsp;&nbsp; // English name of language, eg "German"<br />#define LOCALE_SNATIVELANGNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000004&nbsp;&nbsp; // native name of language, eg "Deutsch"<br />#define LOCALE_SCOUNTRY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000006&nbsp;&nbsp; // localized name of country/region, eg "Germany" in UI language<br />#define LOCALE_SENGCOUNTRY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00001002&nbsp;&nbsp; // English name of country/region, eg "Germany"<br />#define LOCALE_SNATIVECTRYNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000008&nbsp;&nbsp; // native name of country/region, eg "Deutschland"<br /><br />// Additional LCTypes<br />#define LOCALE_ILANGUAGE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000001&nbsp;&nbsp; // language id, LOCALE_SNAME preferred<br /><br />#define LOCALE_SABBREVLANGNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000003&nbsp;&nbsp; // arbitrary abbreviated language name, LOCALE_SISO639LANGNAME preferred<br /><br />#define LOCALE_ICOUNTRY&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000005&nbsp;&nbsp; // country/region code, eg 1, LOCALE_SISO3166CTRYNAME may be more useful.<br />#define LOCALE_SABBREVCTRYNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x00000007&nbsp;&nbsp; // arbitrary abbreviated country/region name, LOCALE_SISO3166CTRYNAME preferred</strong></span></p>
<p>Okay, speaking literally the answer is incorrect; <strong>LOCALE_SLOCALIZEDCOUNTRYNAME</strong> is under <strong>#if (WINVER &gt;= _WIN32_WINNT_VISTA)</strong> defines, not <strong>#if (WINVER &gt;= _WIN32_WINNT_WIN7)</strong> defines.</p>
<p>But my problem is a bit more subtle than that.</p>
<p>Like the fact that <strong>LOCALE_SLOCALIZEDCOUNTRYNAME</strong> has the same value as <strong>LOCALE_SCOUNTRY</strong> and therefore has been around for a very very long time.</p>
<p>There isn't much good reason for version guarding here on the constants&nbsp;since this isn't about version-specific functionality; providing consistent naming for these constants was done to make them easier to use on <em>all</em> versions because knowing that LOCALE_SLANGUAGE and LOCALE_SCOUNTRY are the localized names is kind of obscure, and having the full names makes it easier to understand.</p>
<p>Personally, because pf the pointless version guarding my usual recommendation would be to use <strong>LOCALE_SCOUNTRY</strong>, and not the "easier" <strong>LOCALE_SLOCALIZEDCOUNTRYNAME</strong>&nbsp;constant that is actually harder due to this arbitrary baggage added in.</p>
<p>I wonder if removing the cruft is an appcompat risk now. It probably is, unfortunately.</p>
<p>Now there are other pieces there in the latest file I find troubling, like the way <strong>LOCALE_SABBREVLANGNAME</strong> is an "arbitrary abbreviated language name, LOCALE_SISO639LANGNAME preferred".</p>
<p>After all the time I have spent dealing with the myriad of issues around <strong>LOCALE_SABBREVLANGNAME</strong> and the blogs I have written about it like <a href="http://archives.miloush.net/michkap/archive/2005/02/17/375235.html" title="LOCALE_SABBREVLANGNAME is so not an ISO-639 code"><strong>LOCALE_SABBREVLANGNAME is so not an ISO-639 code</strong></a> and&nbsp;<a href="http://archives.miloush.net/michkap/archive/2006/09/27/773341.html" title="LOCALE_SABBREVLANGNAME is more than just an ISO-639 code"><strong>LOCALE_SABBREVLANGNAME is more than just an ISO-639 code</strong></a>, I can say that these codes that <em>uniquely identify locales</em> and are the <em>central method of recognizably identifying keyboards</em> that have taken hundreds of hours of my professional life are <strong>not</strong> arbitrary. And I find myself almost personally offended that this push to use standards is willing to do at the expense of functionality and of history. </p>
<p>Some if it my own history! </p>
<p><em>I'm hardly Jesus, but I'd rather not be denied, all things being equal.</em></p>
<p>Regular long-time readers may remember <a href="http://archives.miloush.net/michkap/archive/2004/12/26/332392.html" title="Is it Hangul? or Hangeul? or Han'gŭl? or what?"><strong>Is it Hangul? or Hangeul? or Han'gŭl? or what?</strong></a>, where no effort is made to try and force a political issue, even when something is added for some interesting political reasons.</p>
<p><em>This is still true, by the way, of the Korean charset constant.</em></p>
<p>I guess if you aren't on the NLS team you don't over-think the issues so much. :-)</p>
<p>Look, I was once a developer who considered the header files to be the only documentation worth looking at, and I do not mind editing with an eye to an agenda as long as the fundamental goal of usefulness isn't compromised. Comments are always a welcome addition, they truly are. As are version defines that avoid adding unintended version dependencies.</p>
<p>Thinking of prior blogs like <a href="http://archives.miloush.net/michkap/archive/2007/03/19/1912171.html" title="A way better model for features, part 2"><strong>A way better model for features, part 2</strong></a> that covers the flaws in the downlevel library for NLS functions, the fact that they are mesing up the down-level functionality in the header file at least has the benefit of consistency.</p>
<p>All in all,&nbsp;I can't say I'm a fan of the new header file; it is better to not include information or version defines than to make the file either&nbsp;harder to use or harder to learn from....</p>
<hr/><p><strong>beepee</strong> on 10 Nov 2010 5:41 AM:</p><div style="margin-left: 1em"><p>I hate locales. If you once make some result file using locale A, and switch to locale B, your results are near to impossible to compare.</p>
<p>But this is only a small thing compared to Java. Why must every computer have a file for every self-esteemed city in the world?</p>
<p>And in many cases mutiple times, as software X can not rely on software Y&#39;s international set. Why the hell is this city info - if ever used- not in one database file? Something for your next Blog? Ooh, it is not MS</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 10 Nov 2010 8:08 AM:</p><div style="margin-left: 1em"><p>When you say you hate locales, you are saying you hate that people expect different things in different places. There are only three &quot;solutions&quot; here:</p>
<p>1) never develop software outside a small area</p>
<p>2) accept people as they are</p>
<p>3) take over the world and use your authority to force everyone to do things the same way</p>
<p>I choose #2, mostly. :-)</p>
</div>
<p><strong>John Cowan</strong> on 11 Nov 2010 3:44 PM:</p><div style="margin-left: 1em"><p>Beepee (who beeps you, by the way?):</p>
<p>Not every city, just every time zone that either (a) has been different since January 1, 1970; or (b) might be different in the future because under a different political authority. &nbsp;That makes for about 400 time zones worldwide (and history matters because dates in the past and future matter, not just the present).</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 11 Nov 2010 5:40 PM:</p><div style="margin-left: 1em"><p>On Windows we try not to conflate time zones with locales, as this causes each group to become more complicated than if they are handled as two separate things....</p>
</div>
<hr/><p><em>go to <a id="newer" href="http://archives.miloush.net/michkap/archive/2010/11/09/10087473.html" title="I [will have] told you so! Well, perhaps too late (all things considered)...">newer</a> or <a id="older" href="http://archives.miloush.net/michkap/archive/2010/11/07/10087230.html" title="Fruit is your alarm clock? You may be getting up late today or tomorrow...">older</a> post, or back to <a href="http://archives.miloush.net/michkap/archive/index.html">index</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-11">month</a> or <a href="http://archives.miloush.net/michkap/archive/index.html#2010-11-08">day</a></em></p></body>
<!-- Mirrored from archives.miloush.net/michkap/archive/2010/11/08/10087179.html by HTTrack Website Copier/3.x [XR&CO'2014], Thu, 25 May 2017 00:42:34 GMT -->
</html>